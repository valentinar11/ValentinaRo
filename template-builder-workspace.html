<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNOPS PDJ ¬∑ Template Builder Workspace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Primary Colors - UNOPS Blue (Enhanced) */
        --primary-50: #e6f4fb;
        --primary-100: #cce9f7;
        --primary-200: #99d3ef;
        --primary-300: #66bce7;
        --primary-400: #33a6df;
        --primary-500: #0091d7;
        --primary-600: #0074ac;
        --primary-700: #005781;
        --primary-800: #003a56;
        --primary-900: #001d2b;

        /* Neutral - Sophisticated Gray */
        --neutral-50: #fafafa;
        --neutral-100: #f5f5f5;
        --neutral-200: #e5e5e5;
        --neutral-300: #d4d4d4;
        --neutral-400: #a3a3a3;
        --neutral-500: #737373;
        --neutral-600: #525252;
        --neutral-700: #404040;
        --neutral-800: #262626;
        --neutral-900: #171717;

        /* Surface Colors (Alias for compatibility) */
        --surface-0: #ffffff;
        --surface-50: var(--neutral-50);
        --surface-100: var(--neutral-100);
        --surface-200: var(--neutral-200);
        --surface-300: var(--neutral-300);
        --surface-600: var(--neutral-600);
        --surface-800: var(--neutral-800);
        --surface-900: var(--neutral-900);

        /* Semantic Colors - Modern Palette */
        --success-50: #f0fdf4;
        --success-100: #dcfce7;
        --success-500: #22c55e;
        --success-600: #16a34a;
        --success-700: #15803d;
        
        --info-50: #eff6ff;
        --info-100: #dbeafe;
        --info-400: #60a5fa;
        --info-500: #3b82f6;
        --info-600: #2563eb;
        
        --warning-50: #fffbeb;
        --warning-100: #fef3c7;
        --warning-500: #f59e0b;
        --warning-600: #d97706;
        
        --danger-50: #fef2f2;
        --danger-100: #fee2e2;
        --danger-500: #ef4444;
        --danger-600: #dc2626;

        /* Text Colors */
        --text-primary: var(--neutral-900);
        --text-secondary: var(--neutral-700);
        --text-muted: var(--neutral-500);

        /* Spacing Scale */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-2xl: 48px;
        --spacing-3xl: 64px;

        /* Border Radius */
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;

        /* Enhanced Shadow System */
        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        
        /* Legacy aliases for backwards compatibility */
        --shadow-card: var(--shadow-md);
        --shadow-modal: var(--shadow-2xl);

        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: var(--neutral-50);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Top Bar - Modern Header */
      .top-bar {
        background: var(--surface-0);
        border-bottom: 1px solid var(--neutral-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md) var(--spacing-xl);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-xs);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
      }

      .top-bar__brand {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
      }

      .logo {
        font-weight: 700;
        font-size: 18px;
        letter-spacing: 0.12em;
        color: var(--primary-400);
      }

      .top-bar__breadcrumbs {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 400;
      }

      .top-bar__title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .top-bar__actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      /* Buttons */
      .btn {
        border-radius: var(--radius-sm);
        border: 1px solid transparent;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-ghost {
        background: transparent;
        border-color: var(--surface-200);
        color: var(--text-secondary);
      }

      .btn-ghost:hover {
        background: var(--primary-50);
        border-color: var(--primary-500);
        color: var(--primary-400);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all var(--transition-base);
        box-shadow: 0 2px 4px rgba(0, 145, 215, 0.2);
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        box-shadow: 0 4px 8px rgba(0, 145, 215, 0.3);
        transform: translateY(-1px);
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 145, 215, 0.2);
      }

      .btn-secondary {
        background: var(--surface-0);
        color: var(--primary-600);
        padding: 10px 20px;
        border-radius: var(--radius-md);
        border: 1.5px solid var(--neutral-200);
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .btn-secondary:hover {
        background: var(--primary-50);
        border-color: var(--primary-300);
        transform: translateY(-1px);
      }

      /* Workspace Layout */
      .workspace {
        display: flex;
        min-height: calc(100vh - 73px);
      }

      /* Left Rail Navigation - Modern Sidebar */
      .rail {
        width: 64px;
        background: linear-gradient(180deg, var(--primary-700) 0%, var(--primary-800) 100%);
        color: rgba(255, 255, 255, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-lg);
        padding: var(--spacing-lg) 0;
        transition: all var(--transition-base);
        box-shadow: var(--shadow-lg);
      }

      .rail:hover {
        width: 250px;
        box-shadow: var(--shadow-xl);
      }

      .rail button {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-sm);
        border: none;
        background: transparent;
        color: inherit;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rail:hover button {
        width: 100%;
        padding: 0 var(--spacing-md);
        justify-content: flex-start;
        gap: var(--spacing-md);
      }

      .rail button .rail-label {
        display: none;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
      }

      .rail:hover button .rail-label {
        display: block;
      }

      .rail button.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .rail button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* Main Content Area */
      .columns {
        flex: 1;
        display: grid;
        grid-template-columns: 320px minmax(0, 1fr) 340px;
        gap: var(--spacing-lg);
        padding: var(--spacing-xl);
        overflow: hidden;
      }

      /* Panel Styles - Modern Cards */
      .panel {
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-lg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-base);
      }

      .panel:hover {
        box-shadow: var(--shadow-md);
      }

      .panel__header {
        padding: var(--spacing-lg) var(--spacing-lg);
        border-bottom: 1px solid var(--neutral-100);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        background: linear-gradient(to bottom, var(--neutral-50) 0%, var(--surface-0) 100%);
      }

      .panel__body {
        padding: var(--spacing-lg);
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      /* Search Bar */
      .search-bar {
        margin-bottom: var(--spacing-md);
        position: relative;
      }

      .search-bar input {
        width: 100%;
        border-radius: var(--radius-md);
        border: 1.5px solid var(--neutral-200);
        padding: 10px 12px 10px 38px;
        font-family: inherit;
        font-size: 14px;
        background: var(--surface-0);
        color: var(--text-primary);
        transition: all var(--transition-base);
      }

      .search-bar input:hover {
        border-color: var(--neutral-300);
      }

      .search-bar input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px rgba(0, 145, 215, 0.1);
        background: var(--surface-0);
      }

      .search-bar::before {
        content: 'üîç';
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        pointer-events: none;
      }

      /* Scrollable Component Groups */
      .component-group {
        display: flex;
        flex-direction: column;
      }

      .component-group + .component-group {
        margin-top: var(--spacing-xl);
      }

      .component-group.scrollable {
        max-height: 300px;
        overflow-y: auto;
        padding-right: var(--spacing-sm);
      }

      .group-label {
        font-size: 12px;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: var(--spacing-md);
        font-weight: 600;
        position: sticky;
        top: 0;
        background: var(--surface-0);
        z-index: 1;
        padding-bottom: var(--spacing-xs);
      }

      .component-block {
        border: 1.5px dashed var(--neutral-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        cursor: grab;
        transition: all var(--transition-base);
        background: var(--surface-0);
      }

      .component-block:hover {
        border-color: var(--primary-400);
        border-style: solid;
        background: var(--primary-50);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .component-block:active {
        cursor: grabbing;
      }

      .component-block.hidden {
        display: none;
      }

      .component-block-icon {
        font-size: 24px;
        margin-right: var(--spacing-sm);
        display: inline-block;
      }

      .component-block-content {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .component-block strong {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .component-block span {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.4;
      }

      /* Block Sequence Tabs */
      .block-tabs {
        display: flex;
        gap: var(--spacing-xs);
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        background: var(--surface-50);
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .block-tab {
        padding: 8px 16px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        background: var(--surface-0);
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
        border-bottom: none;
      }

      .block-tab:hover {
        background: var(--surface-50);
        color: var(--text-primary);
      }

      .block-tab.active {
        background: var(--surface-0);
        color: var(--primary-400);
        border-color: var(--primary-400);
        border-bottom-color: var(--surface-0);
        z-index: 1;
        margin-bottom: -1px;
      }

      .block-tab-number {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--surface-200);
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 600;
        line-height: 20px;
        text-align: center;
        margin-right: var(--spacing-xs);
      }

      .block-tab.active .block-tab-number {
        background: var(--primary-400);
        color: #fff;
      }

      /* Canvas Area */
      .canvas-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      .canvas {
        flex: 1;
        min-height: 400px;
        background: var(--surface-0);
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-sm);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        padding: var(--spacing-xl);
        position: relative;
        overflow-y: auto;
      }

      .canvas-view {
        display: none;
      }

      .canvas-view.active {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .canvas-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
        text-align: center;
        color: var(--text-muted);
      }

      .canvas-empty-icon {
        font-size: 64px;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .canvas-empty h2 {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .canvas-empty p {
        font-size: 14px;
        color: var(--text-muted);
      }

      /* Dropped Sections - Modern Block Cards */
      .dropped-section {
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
        overflow: hidden;
        transition: all var(--transition-base);
        box-shadow: var(--shadow-xs);
      }

      .dropped-section:hover {
        border-color: var(--primary-300);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .dropped-section.selected {
        border-color: var(--primary-500);
        border-width: 2px;
        box-shadow: 0 0 0 3px rgba(0, 145, 215, 0.1);
      }

      .dropped-section.dragover {
        border-color: var(--success-500);
        background: var(--success-50);
        box-shadow: var(--shadow-lg);
      }

      .section-header {
        padding: var(--spacing-lg) var(--spacing-lg);
        background: linear-gradient(to bottom, var(--neutral-50) 0%, var(--surface-0) 100%);
        border-bottom: 1px solid var(--neutral-100);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: move;
      }

      .section-title-area {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .section-icon {
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
      }

      .section-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .section-controls {
        display: flex;
        gap: var(--spacing-sm);
      }

      .icon-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--neutral-200);
        background: var(--surface-0);
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--text-secondary);
        transition: all var(--transition-base);
      }

      .icon-btn:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-500);
        transform: translateY(-1px);
        box-shadow: var(--shadow-xs);
      }

      .icon-btn:active {
        transform: translateY(0);
      }

      .section-body {
        padding: var(--spacing-lg);
      }

      .section-body.collapsed {
        display: none;
      }

      /* Collapsible Subsection - Modern Nested Cards */
      .subsection {
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        overflow: hidden;
        background: var(--surface-0);
        transition: all var(--transition-base);
      }

      .subsection-header {
        padding: var(--spacing-md) var(--spacing-md);
        background: var(--neutral-50);
        border-bottom: 1px solid var(--neutral-100);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .subsection-header:hover {
        background: var(--neutral-100);
      }

      .subsection-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .subsection-toggle {
        font-size: 12px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
      }

      .subsection.collapsed .subsection-toggle {
        transform: rotate(-90deg);
      }

      .subsection-body {
        padding: var(--spacing-md);
        display: block;
      }

      .subsection.collapsed .subsection-body {
        display: none;
      }

      /* Field Items */
      .field-item {
        padding: var(--spacing-md);
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .field-item:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .field-item.selected {
        border-color: var(--primary-400);
        border-width: 2px;
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .field-info {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        flex: 1;
      }

      .field-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .field-badges {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      .field-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all var(--transition-fast);
      }

      .badge-required {
        background: var(--danger-50);
        color: var(--danger-600);
        border: 1px solid var(--danger-100);
      }

      .badge-conditional {
        background: var(--warning-50);
        color: var(--warning-600);
        border: 1px solid var(--warning-100);
      }

      .badge-readonly {
        background: var(--neutral-100);
        color: var(--neutral-600);
        border: 1px solid var(--neutral-200);
      }

      .badge-mapped {
        background: var(--info-50);
        color: var(--info-600);
        border: 1px solid var(--info-100);
      }

      /* Drop Zone */
      .drop-zone {
        min-height: 100px;
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        margin: var(--spacing-md) 0;
        transition: all 0.2s ease;
        background: var(--surface-50);
      }

      .drop-zone.active {
        border-color: var(--success-500);
        background: var(--success-50);
        color: var(--success-500);
      }

      .section-body.active,
      .subsection-body.active {
        background: var(--success-50);
        border: 2px dashed var(--success-500);
        border-radius: var(--radius-sm);
      }

      /* Properties Panel */
      .properties-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      .properties-form.hidden {
        display: none;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .form-group label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .form-group label.required::after {
        content: ' *';
        color: var(--danger-500);
      }

      .form-group-subheading {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-top: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
      }

      .input,
      .select,
      .textarea {
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
        padding: 10px 12px;
        font-family: inherit;
        font-size: 14px;
        background: var(--surface-0);
        color: var(--text-primary);
        transition: all 0.2s ease;
        width: 100%;
      }

      .input:focus,
      .select:focus,
      .textarea:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .input:hover,
      .select:hover,
      .textarea:hover {
        border-color: var(--surface-800);
      }

      .textarea {
        resize: vertical;
        min-height: 80px;
      }

      .checkbox-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .checkbox-item input[type='checkbox'] {
        width: 18px;
        height: 18px;
        border: 2px solid var(--surface-600);
        border-radius: 2px;
        cursor: pointer;
        appearance: none;
        position: relative;
        transition: all 0.2s ease;
      }

      .checkbox-item input[type='checkbox']:checked {
        background: var(--primary-400);
        border-color: var(--primary-400);
      }

      .checkbox-item input[type='checkbox']:checked::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: 600;
      }

      .checkbox-item input[type='checkbox']:hover {
        border-color: var(--primary-400);
      }

      .checkbox-item label {
        font-weight: 400;
        cursor: pointer;
      }

      /* Threshold Inputs */
      .threshold-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }

      /* Help Text */
      .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
        line-height: 1.4;
      }

      /* Scrollbar Styling */
      .panel__body::-webkit-scrollbar,
      .canvas::-webkit-scrollbar,
      .component-group.scrollable::-webkit-scrollbar,
      .block-tabs::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .panel__body::-webkit-scrollbar-track,
      .canvas::-webkit-scrollbar-track,
      .component-group.scrollable::-webkit-scrollbar-track,
      .block-tabs::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .panel__body::-webkit-scrollbar-thumb,
      .canvas::-webkit-scrollbar-thumb,
      .component-group.scrollable::-webkit-scrollbar-thumb,
      .block-tabs::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .panel__body::-webkit-scrollbar-thumb:hover,
      .canvas::-webkit-scrollbar-thumb:hover,
      .component-group.scrollable::-webkit-scrollbar-thumb:hover,
      .block-tabs::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      /* Requisition Lines & Lots Preview Styles */
      .preview-container {
        font-size: 14px;
      }
      
      .preview-container .btn {
        border-radius: var(--radius-sm);
        border: 1px solid transparent;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .preview-container .btn-primary {
        background: var(--primary-400);
        color: #fff;
        border-color: var(--primary-400);
      }
      
      .preview-container .btn-primary:hover {
        background: var(--primary-500);
        border-color: var(--primary-500);
      }
      
      .preview-container .btn-ghost {
        background: transparent;
        border-color: var(--surface-200);
        color: var(--text-secondary);
      }
      
      .preview-container .btn-ghost:hover {
        background: var(--primary-50);
        border-color: var(--primary-500);
        color: var(--primary-400);
      }
      
      .preview-container .icon-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }
      
      .preview-container .icon-btn:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-400);
      }

      /* Responsive */
      @media (max-width: 1280px) {
        .columns {
          grid-template-columns: 1fr;
        }

        .rail {
          width: 64px;
        }

        .rail:hover {
          width: 64px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="top-bar__brand">
          <div class="logo">UNOPS</div>
          <div>
            <div class="top-bar__title">Procurement Portal | Templates</div>
            <div class="top-bar__breadcrumbs">ITB ¬∑ Goods (Standard Procurement)</div>
          </div>
        </div>
        <div class="top-bar__actions">
          <button class="btn btn-ghost">Preview</button>
          <button class="btn btn-ghost">üíæ Save</button>
          <button class="btn btn-primary">Publish</button>
        </div>
      </div>

      <!-- Workspace -->
      <div class="workspace">
        <!-- Left Rail Navigation -->
        <nav class="rail" aria-label="Primary navigation">
          <button class="active" title="Template Builder">
            <span>üß±</span>
            <span class="rail-label">Template Builder</span>
          </button>
          <button title="Library" onclick="window.location.href='template-library.html'">
            <span>üìö</span>
            <span class="rail-label">Library</span>
          </button>
          <button title="Settings">
            <span>‚öôÔ∏è</span>
            <span class="rail-label">Settings</span>
          </button>
        </nav>

        <!-- Main Content Columns -->
        <div class="columns">
          <!-- Components Panel -->
          <section class="panel">
            <div class="panel__header">Components</div>
            <div class="panel__body">
              <!-- Blocks Section -->
              <div class="component-group scrollable">
                <p class="group-label">Blocks</p>
                <div class="component-block" draggable="true" data-type="section" data-section-type="general" data-block-id="block-general">
                  <div class="component-block-content">
                    <span class="component-block-icon">üìã</span>
                    <div>
                      <strong>General Information</strong>
                      <span>Title, reference, type of requirement</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="project" data-block-id="block-project">
                  <div class="component-block-content">
                    <span class="component-block-icon">üèóÔ∏è</span>
                    <div>
                      <strong>Project &amp; Tender Details</strong>
                      <span>Work package, funding source, project name</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="requisition-lots" data-block-id="block-requisition-lots">
                  <div class="component-block-content">
                    <span class="component-block-icon">üìã</span>
                    <div>
                      <strong>Requisition &amp; Lots</strong>
                      <span>Manage requisition lines and create lots</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="scope" data-block-id="block-scope">
                  <div class="component-block-content">
                    <span class="component-block-icon">üéØ</span>
                    <div>
                      <strong>Scope &amp; Requirements</strong>
                      <span>Product requirements and specifications</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="timeline" data-block-id="block-timeline">
                  <div class="component-block-content">
                    <span class="component-block-icon">üìÖ</span>
                    <div>
                      <strong>Timeline &amp; Deadlines</strong>
                      <span>Key dates and milestones</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="submission" data-block-id="block-submission">
                  <div class="component-block-content">
                    <span class="component-block-icon">üìù</span>
                    <div>
                      <strong>Submission Requirements</strong>
                      <span>Supplier response structure</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="evaluation" data-block-id="block-evaluation">
                  <div class="component-block-content">
                    <span class="component-block-icon">üìä</span>
                    <div>
                      <strong>Evaluation</strong>
                      <span>Evaluation method and criteria</span>
                    </div>
                  </div>
                </div>
                <div class="component-block" draggable="true" data-type="section" data-section-type="team" data-block-id="block-team">
                  <div class="component-block-content">
                    <span class="component-block-icon">üë•</span>
                    <div>
                      <strong>Team</strong>
                      <span>Team members and roles</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Custom Block Button -->
              <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--neutral-200);">
                <button class="btn btn-ghost" onclick="createCustomBlock()" style="width: 100%; padding: var(--spacing-md); display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm);">
                  <span style="font-size: 18px;">‚ûï</span>
                  <span>Add New Custom Block</span>
                </button>
              </div>

              <!-- Forms & Documents Section -->
              <div class="component-group">
                <p class="group-label">Forms &amp; Documents</p>
                <div class="search-bar">
                  <input type="search" placeholder="Search forms..." id="search-forms" />
                </div>
                <div class="component-group scrollable" id="forms-list">
                  <div class="component-block" draggable="true" data-type="form" data-form-type="instructions" data-block-id="form-instructions">
                    <div>
                      <strong>Instructions to Bidders</strong>
                      <span>Standard format</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="form" data-form-type="contracts" data-block-id="form-contracts">
                    <div>
                      <strong>Contracts forms</strong>
                      <span>Offer &amp; award</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="form" data-form-type="bank-guarantee" data-block-id="form-bank-guarantee">
                    <div>
                      <strong>Bank Guarantee Form</strong>
                      <span>Security requirements</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="form" data-form-type="bid-security" data-block-id="form-bid-security">
                    <div>
                      <strong>Bid Security Form</strong>
                      <span>Security requirements</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="form" data-form-type="drive-questionnaire" data-block-id="form-drive-questionnaire">
                    <div>
                      <strong>DRiVE Questionnaire</strong>
                      <span>Risk assessment questionnaire</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Custom Fields Section -->
              <div class="component-group">
                <p class="group-label">Custom Fields</p>
                <div class="search-bar">
                  <input type="search" placeholder="Search fields..." id="search-fields" />
                </div>
                <div class="component-group scrollable" id="fields-list">
                  <div class="component-block" draggable="true" data-type="field" data-field-type="un-collab" data-block-id="field-un-collab">
                    <div>
                      <strong>UN Collaboration?</strong>
                      <span>Yes / No</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="field" data-field-type="epp" data-block-id="field-epp">
                    <div>
                      <strong>EPP?</strong>
                      <span>Yes / No</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="field" data-field-type="medicine" data-block-id="field-medicine">
                    <div>
                      <strong>Medicine/Medical equipment?</strong>
                      <span>Yes / No</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="field" data-field-type="lease" data-block-id="field-lease">
                    <div>
                      <strong>Is this a lease?</strong>
                      <span>Yes / No</span>
                    </div>
                  </div>
                  <div class="component-block" draggable="true" data-type="field" data-field-type="custom" data-block-id="field-custom">
                    <div>
                      <strong>New Custom Field</strong>
                      <span>Add from library</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Canvas Panel -->
          <section class="panel">
            <div class="panel__header">Template Canvas</div>
            <div class="panel__body">
              <div class="canvas-container">
                <div class="block-tabs" id="block-tabs"></div>
                <div class="canvas" id="canvas">
                  <div class="canvas-empty">
                    <div class="canvas-empty-icon">üé®</div>
                    <h2>Start Building Your Template</h2>
                    <p>Drag and drop sections from the left sidebar to begin</p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Properties Panel -->
          <section class="panel">
            <div class="panel__header" id="properties-header">Properties ¬∑ Template</div>
            <div class="panel__body">
              <!-- Template Properties -->
              <form class="properties-form" id="template-properties">
                <div class="form-group">
                  <label for="template-name" class="required">Template Name</label>
                  <input type="text" id="template-name" class="input" placeholder="Enter template name" />
                </div>
                <div class="form-group">
                  <label for="event-type" class="required">Type of Event</label>
                  <select id="event-type" class="select">
                    <option>Select</option>
                    <option>Sourcing</option>
                    <option>Solicitation</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="method">Method</label>
                  <select id="method" class="select">
                    <option>Select‚Ä¶</option>
                    <option>ITB</option>
                    <option>RFP</option>
                    <option>RFQ</option>
                    <option>EOI</option>
                    <option>PQ</option>
                    <option>Ad-hoc shortlist</option>
                    <option>Solicit offers against LTA/BPA</option>
                    <option>Secondary bidding against LTA/BPA</option>
                    <option>Direct contracting/sole sourcing</option>
                    <option>e-reserve auctions</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="requirement">Type of Requirement</label>
                  <div class="checkbox-list">
                    <div class="checkbox-item">
                      <input type="checkbox" id="req-goods" />
                      <label for="req-goods">Goods</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="req-services" />
                      <label for="req-services">Services</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="req-works" />
                      <label for="req-works">Works</label>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label>Threshold USD</label>
                  <div class="threshold-inputs">
                    <input type="number" placeholder="From" class="input" />
                    <input type="number" placeholder="To" class="input" />
                  </div>
                </div>
              </form>

              <!-- Block Properties -->
              <form class="properties-form hidden" id="block-properties">
                <div class="form-group">
                  <label for="block-name" class="required">Section Name</label>
                  <input type="text" id="block-name" class="input" placeholder="Enter section name" />
                </div>
                <div class="form-group">
                  <label for="block-description">Description for Authors</label>
                  <textarea id="block-description" class="textarea" placeholder="Section description for authors"></textarea>
                  <span class="help-text">This description will be visible to template authors</span>
                </div>
                <div class="form-group">
                  <div class="checkbox-item">
                    <input type="checkbox" id="block-mandatory" />
                    <label for="block-mandatory">This block is mandatory</label>
                  </div>
                </div>
                
                <!-- Requisition Lines & Lots specific configuration -->
                <div id="requisition-lots-config" class="hidden">
                  <div class="form-group-subheading" style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--surface-200);">
                    Requisition Lines & Lots Configuration
                  </div>
                  <div class="form-group">
                    <div class="checkbox-item">
                      <input type="checkbox" id="config-display-requisition-lines" checked />
                      <label for="config-display-requisition-lines">Display Requisition Lines</label>
                    </div>
                    <span class="help-text">Show requisition lines from ERP as reference</span>
                  </div>
                  <div class="form-group">
                    <div class="checkbox-item">
                      <input type="checkbox" id="config-enable-lot-creation" checked />
                      <label for="config-enable-lot-creation">Enable Lot Creation</label>
                    </div>
                    <span class="help-text">Allow tender authors to create and manage lots</span>
                  </div>
                  <div class="form-group">
                    <label for="config-lot-assignment-rules">Lot Assignment Rules</label>
                    <select id="config-lot-assignment-rules" class="select">
                      <option value="flexible">Flexible (can add any UNSPSC code)</option>
                      <option value="strict">Strict (only from requisition lines)</option>
                    </select>
                    <span class="help-text">Control how products can be assigned to lots</span>
                  </div>
                  <div class="form-group">
                    <label for="config-data-source">Requisition Line Data Source</label>
                    <select id="config-data-source" class="select">
                      <option value="erp" selected>ERP ¬∑ oU</option>
                      <option value="pdj">PDJ ¬∑ Requisition</option>
                      <option value="manual">Manual Entry</option>
                    </select>
                    <span class="help-text">Source of requisition line data</span>
                  </div>
                  <div class="form-group">
                    <button type="button" class="btn btn-ghost" onclick="applyRequisitionLotsConfig()" style="width: 100%; padding: 10px;">Apply Configuration to Preview</button>
                  </div>
                </div>
                
                <div class="form-group" id="general-block-config">
                  <div class="form-group-subheading">This block applies to</div>
                  <div class="checkbox-list">
                    <div class="checkbox-item">
                      <input type="checkbox" id="block-per-lot" />
                      <label for="block-per-lot">Per Lot</label>
                    </div>
                    <div class="checkbox-item">
                      <input type="checkbox" id="block-entire-tender" />
                      <label for="block-entire-tender">Entire Tender</label>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label for="block-order">Section Order</label>
                  <input type="number" id="block-order" class="input" value="1" min="1" />
                  <span class="help-text">Position in the template structure</span>
                </div>
                <div class="form-group">
                  <label for="block-source">Data Source</label>
                  <select id="block-source" class="select">
                    <option value="">Manual entry</option>
                    <option value="requisition">PDJ ¬∑ Requisition</option>
                    <option value="erp">ERP ¬∑ oU</option>
                    <option value="ungm">UNGM</option>
                    <option value="drive">DRiVE Module</option>
                    <option value="agora">UN Web Buy Plus (Agora)</option>
                  </select>
                  <span class="help-text">Link to external system data</span>
                </div>
                <div class="form-group">
                  <label for="block-field-path">Field Mapping</label>
                  <input type="text" id="block-field-path" class="input" placeholder="e.g., requisition.header.referenceCode" />
                  <span class="help-text">Specify the exact data field path</span>
                </div>
              </form>

              <!-- Component/Field Properties -->
              <form class="properties-form hidden" id="component-properties">
                <div class="form-group">
                  <label for="component-label" class="required">Field Label</label>
                  <input type="text" id="component-label" class="input" placeholder="Enter field label" />
                </div>
                <div class="form-group">
                  <label for="component-type">Field Type</label>
                  <select id="component-type" class="select">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                    <option value="dropdown">Dropdown</option>
                    <option value="checkbox">Checkbox</option>
                    <option value="radio">Radio Button</option>
                    <option value="textarea">Textarea</option>
                    <option value="file">File Upload</option>
                  </select>
                </div>
                <div class="form-group">
                  <div class="checkbox-item">
                    <input type="checkbox" id="component-required" />
                    <label for="component-required">Required Field</label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox-item">
                    <input type="checkbox" id="component-readonly" />
                    <label for="component-readonly">Read-only</label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="checkbox-item">
                    <input type="checkbox" id="component-mapped" />
                    <label for="component-mapped">Auto-mapped from data source</label>
                  </div>
                </div>
                <div class="form-group">
                  <label for="component-placeholder">Placeholder Text</label>
                  <input type="text" id="component-placeholder" class="input" placeholder="Enter placeholder text" />
                </div>
                <div class="form-group">
                  <label for="component-help">Help Text</label>
                  <textarea id="component-help" class="textarea" placeholder="Help text for users"></textarea>
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script>
      let draggedElement = null;
      let selectedElement = null;
      let selectedBlockType = null;
      let selectedFieldElement = null;
      let blocks = [];
      let activeBlockIndex = 0;

      // Requisition Lines & Lots state (for template preview)
      let previewRequisitionLines = {};
      let previewLots = {};
      let blockConfigurations = {}; // Store configuration per block
      
      // ===== TEMPLATE CONFIGURATION DATA STRUCTURE =====
      
      let templateConfig = {
        templateId: generateId(),
        templateName: 'Untitled Template',
        version: '1.0',
        createdDate: new Date().toISOString(),
        modifiedDate: new Date().toISOString(),
        blocks: []
      };
      
      // Helper function to generate unique IDs
      function generateId() {
        return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }
      
      // Field type definitions
      const fieldTypes = {
        text: { icon: 'üìù', label: 'Text Input' },
        textarea: { icon: 'üìÑ', label: 'Textarea' },
        dropdown: { icon: '‚ñº', label: 'Dropdown' },
        checkbox: { icon: '‚òëÔ∏è', label: 'Checkbox' },
        checkboxGroup: { icon: '‚òëÔ∏è', label: 'Checkbox Group' },
        radio: { icon: 'üîò', label: 'Radio Buttons' },
        date: { icon: 'üìÖ', label: 'Date' },
        datetime: { icon: 'üïê', label: 'Date & Time' },
        number: { icon: 'üî¢', label: 'Number' },
        search: { icon: 'üîç', label: 'Search Field' },
        file: { icon: 'üìé', label: 'File Upload' },
        richText: { icon: '‚úíÔ∏è', label: 'Rich Text Editor' }
      };
      
      // Helper function to create field configuration
      function createFieldConfig(fieldId, label, type, required = false, options = {}) {
        return {
          fieldId: fieldId,
          fieldLabel: label,
          fieldType: type,
          required: required,
          enabled: true,
          defaultValue: options.defaultValue || '',
          placeholder: options.placeholder || '',
          helpText: options.helpText || '',
          options: options.options || [],
          allowMultiple: options.allowMultiple || false,
          dataSource: options.dataSource || null,
          acceptedTypes: options.acceptedTypes || [],
          maxSize: options.maxSize || null,
          rows: options.rows || 3,
          readonly: options.readonly || false,
          validation: options.validation || {},
          conditionalVisibility: options.conditionalVisibility || null,
          triggersConditionalFields: options.triggersConditionalFields || [],
          position: 0
        };
      }
      
      // Initialize General Information Block
      function initializeGeneralInfoBlock() {
        const blockConfig = {
          blockId: 'general-info-' + generateId(),
          blockType: 'general-info',
          blockName: 'General Information',
          blockIcon: 'üìã',
          enabled: true,
          position: templateConfig.blocks.length,
          sections: [
            {
              sectionId: 'basic-info',
              sectionName: 'Basic Information',
              enabled: true,
              fields: [
                createFieldConfig('title', 'Title', 'text', true, {
                  placeholder: 'Enter tender title',
                  helpText: 'Provide a clear, descriptive title for the tender',
                  validation: { minLength: 10, maxLength: 200 }
                }),
                createFieldConfig('reference', 'Reference', 'text', false, {
                  placeholder: 'Auto-generated',
                  helpText: 'Unique tender reference number',
                  readonly: true
                }),
                createFieldConfig('sourcingOrSolicitation', 'Sourcing or Solicitation', 'dropdown', true, {
                  options: ['Sourcing', 'Solicitation'],
                  triggersConditionalFields: ['sourcingMethod', 'processType', 'solicitationMethod']
                }),
                createFieldConfig('sourcingMethod', 'Sourcing Method', 'dropdown', false, {
                  options: ['RFI', 'EOI', 'PQ', 'Ad-hoc shortlist'],
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'sourcingOrSolicitation', operator: 'equals', value: 'Sourcing' }]
                  }
                }),
                createFieldConfig('typeOfRequirement', 'Type of Requirement', 'dropdown', true, {
                  options: ['Goods', 'Services', 'Works', 'Goods & Services']
                }),
                createFieldConfig('description', 'Description', 'textarea', true, {
                  placeholder: 'Provide a detailed description',
                  rows: 4
                }),
                createFieldConfig('modalityOfBidReceipt', 'Modality of Bid Receipt', 'dropdown', true, {
                  options: ['Online Only', 'Email Submission', 'Physical Submission'],
                  triggersConditionalFields: ['waiverForBidReceipt']
                }),
                createFieldConfig('waiverForBidReceipt', 'Waiver for Bid Receipt Modality', 'text', false, {
                  placeholder: 'Provide waiver justification link',
                  conditionalVisibility: {
                    logic: 'OR',
                    rules: [
                      { field: 'modalityOfBidReceipt', operator: 'equals', value: 'Email Submission' },
                      { field: 'modalityOfBidReceipt', operator: 'equals', value: 'Physical Submission' }
                    ]
                  }
                }),
                createFieldConfig('epp', 'EPP', 'dropdown', false, {
                  options: ['Yes', 'No'],
                  triggersConditionalFields: ['eppAuthorizationLink', 'eppEndDate', 'eppScope']
                }),
                createFieldConfig('eppAuthorizationLink', 'EPP Authorization (Jira Link)', 'text', false, {
                  placeholder: 'Enter Jira link',
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'epp', operator: 'equals', value: 'Yes' }]
                  }
                }),
                createFieldConfig('eppEndDate', 'EPP Authorization End Date', 'date', false, {
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'epp', operator: 'equals', value: 'Yes' }]
                  }
                }),
                createFieldConfig('eppScope', 'Scope of EPP Approval', 'dropdown', false, {
                  options: ['Project', 'Org Unit', 'Specific procurement process', 'Other'],
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'epp', operator: 'equals', value: 'Yes' }]
                  }
                }),
                createFieldConfig('medicineMedicalEquipment', 'Medicine / Medical Equipment', 'dropdown', false, {
                  options: ['Yes', 'No'],
                  triggersConditionalFields: ['policyExceptionLink']
                }),
                createFieldConfig('policyExceptionLink', 'Policy Exception Link (Annex 2 Jira)', 'text', false, {
                  placeholder: 'Enter Jira link',
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'medicineMedicalEquipment', operator: 'equals', value: 'Yes' }]
                  }
                }),
                createFieldConfig('processType', 'Process Type', 'checkboxGroup', false, {
                  options: [
                    'Standard solicitation',
                    'Solicit offers against LTA/BPA',
                    'Secondary bidding against LTA/BPA',
                    'Direct contracting / Sole sourcing',
                    'Contract Amendment'
                  ],
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'sourcingOrSolicitation', operator: 'equals', value: 'Solicitation' }]
                  }
                }),
                createFieldConfig('solicitationMethod', 'Solicitation Method', 'dropdown', false, {
                  options: ['RFQ', 'ITB', 'RFP', 'e-reserve auctions'],
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'sourcingOrSolicitation', operator: 'equals', value: 'Solicitation' }]
                  }
                }),
                createFieldConfig('linkedProcess', 'Linked Process', 'search', false, {
                  dataSource: 'Event ID',
                  placeholder: 'Search for event...',
                  conditionalVisibility: {
                    logic: 'OR',
                    rules: [
                      { field: 'processType', operator: 'contains', value: 'Direct contracting / Sole sourcing' },
                      { field: 'sourcingOrSolicitation', operator: 'isNotEmpty', value: null }
                    ]
                  }
                }),
                createFieldConfig('unCollaboration', 'UN Collaboration', 'dropdown', false, {
                  options: ['Yes', 'No'],
                  triggersConditionalFields: ['unCollaborationType', 'unAgencies']
                }),
                createFieldConfig('unCollaborationType', 'UN Collaboration Type', 'dropdown', false, {
                  options: [
                    'Joint tendering process with other UN organizations',
                    'Secondary bidding using other UN agency\'s LTA',
                    'Re-use of solicitation results of another UN agency'
                  ],
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'unCollaboration', operator: 'equals', value: 'Yes' }]
                  }
                }),
                createFieldConfig('unAgencies', 'UN Agencies', 'dropdown', false, {
                  allowMultiple: true,
                  options: ['UNDP', 'UNHCR', 'UNICEF', 'WFP', 'WHO', 'UNESCO'],
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'unCollaboration', operator: 'equals', value: 'Yes' }]
                  }
                }),
                createFieldConfig('organizationalUnit', 'Organizational Unit', 'search', true, {
                  dataSource: 'oneUNOPS',
                  placeholder: 'Search for organizational unit...'
                }),
                createFieldConfig('isLease', 'Is this a Lease', 'dropdown', false, {
                  options: ['Yes', 'No'],
                  triggersConditionalFields: ['srmComplianceDoc']
                }),
                createFieldConfig('srmComplianceDoc', 'SRM Compliance Document', 'file', false, {
                  acceptedTypes: ['.pdf', '.doc', '.docx'],
                  maxSize: 10,
                  conditionalVisibility: {
                    logic: 'AND',
                    rules: [{ field: 'isLease', operator: 'equals', value: 'Yes' }]
                  }
                })
              ]
            }
          ]
        };
        
        return blockConfig;
      }

      // Render block configuration view for admin
      function renderBlockConfigView(blockConfig) {
        return `
          <div class="block-config-container" id="config-${blockConfig.blockId}">
            <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                  <span style="font-size: 32px;">${blockConfig.blockIcon}</span>
                  <input type="text" value="${blockConfig.blockName}" 
                         onchange="updateBlockName('${blockConfig.blockId}', this.value)" 
                         style="padding: 8px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 18px; font-weight: 600;" />
                </div>
                <div style="display: flex; gap: var(--spacing-sm); align-items: center);">
                  <label style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 14px;">
                    <input type="checkbox" ${blockConfig.enabled ? 'checked' : ''} 
                           onchange="toggleBlockEnabled('${blockConfig.blockId}', this.checked)" />
                    <span>Block Enabled</span>
                  </label>
                  <button class="icon-btn" onclick="deleteConfigBlock('${blockConfig.blockId}')" title="Delete Block">üóëÔ∏è</button>
                </div>
              </div>
              
              ${blockConfig.sections.map(section => renderSectionConfigView(blockConfig.blockId, section)).join('')}
              
              <button class="btn btn-ghost" onclick="addSection('${blockConfig.blockId}')" style="width: 100%; margin-top: var(--spacing-md);">
                ‚ûï Add Section
              </button>
            </div>
          </div>
        `;
      }
      
      // Render section configuration
      function renderSectionConfigView(blockId, section) {
        return `
          <div style="border-top: 1px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
              <input type="text" value="${section.sectionName}" 
                     onchange="updateSectionName('${blockId}', '${section.sectionId}', this.value)" 
                     style="padding: 6px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 16px; font-weight: 600;" />
              <div style="display: flex; gap: var(--spacing-xs); align-items: center;">
                <label style="display: flex; align-items: center; gap: var(--spacing-xs); font-size: 13px;">
                  <input type="checkbox" ${section.enabled ? 'checked' : ''} 
                         onchange="toggleSectionEnabled('${blockId}', '${section.sectionId}', this.checked)" />
                  <span>Enabled</span>
                </label>
                <button class="icon-btn" onclick="deleteConfigSection('${blockId}', '${section.sectionId}')" style="font-size: 12px;">‚úñ</button>
              </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
              ${section.fields.map(field => renderFieldConfigCard(blockId, section.sectionId, field)).join('')}
            </div>
            
            <button class="btn btn-ghost btn-sm" onclick="addFieldToSection('${blockId}', '${section.sectionId}')" 
                    style="width: 100%; margin-top: var(--spacing-sm); padding: 8px;">
              ‚ûï Add Field
            </button>
          </div>
        `;
      }
      
      // Render individual field configuration card
      function renderFieldConfigCard(blockId, sectionId, field) {
        return `
          <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); transition: all 0.2s;"
               onmouseover="this.style.borderColor='var(--primary-400)'" 
               onmouseout="this.style.borderColor='var(--surface-200)'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
              <div style="display: flex; align-items: center; gap: var(--spacing-sm); flex: 1;">
                <span style="font-size: 18px;">${fieldTypes[field.fieldType]?.icon || 'üìù'}</span>
                <span style="font-weight: 600; font-size: 14px;">${field.fieldLabel}</span>
                ${field.required ? '<span style="padding: 2px 6px; background: var(--danger-50); color: var(--danger-500); border-radius: 4px; font-size: 10px; font-weight: 600;">REQUIRED</span>' : ''}
                ${field.conditionalVisibility ? '<span style="padding: 2px 6px; background: var(--warning-50); color: var(--warning-500); border-radius: 4px; font-size: 10px; font-weight: 600;">CONDITIONAL</span>' : ''}
              </div>
              <div style="display: flex; gap: var(--spacing-xs);">
                <button class="icon-btn" onclick="editField('${blockId}', '${sectionId}', '${field.fieldId}')" title="Edit" style="font-size: 12px;">‚úèÔ∏è</button>
                <button class="icon-btn" onclick="duplicateField('${blockId}', '${sectionId}', '${field.fieldId}')" title="Duplicate" style="font-size: 12px;">üìã</button>
                <button class="icon-btn" onclick="deleteConfigField('${blockId}', '${sectionId}', '${field.fieldId}')" title="Delete" style="font-size: 12px;">üóëÔ∏è</button>
              </div>
            </div>
            
            <div style="padding: var(--spacing-sm); background: var(--surface-0); border-radius: var(--radius-sm); opacity: 0.8; pointer-events: none;">
              ${renderFieldPreview(field)}
            </div>
          </div>
        `;
      }
      
      // Render field preview (how it will look for tender author)
      function renderFieldPreview(field) {
        const requiredMark = field.required ? '<span style="color: var(--danger-500);">*</span>' : '';
        
        switch (field.fieldType) {
          case 'text':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 4px;">${field.fieldLabel} ${requiredMark}</label>
              <input type="text" placeholder="${field.placeholder}" disabled 
                     style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px;" />
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'textarea':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 4px;">${field.fieldLabel} ${requiredMark}</label>
              <textarea placeholder="${field.placeholder}" disabled rows="${field.rows}"
                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px; resize: vertical;"></textarea>
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'dropdown':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 4px;">${field.fieldLabel} ${requiredMark}</label>
              <select disabled ${field.allowMultiple ? 'multiple' : ''} 
                      style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px;">
                <option value="">Select...</option>
                ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
              </select>
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'checkbox':
            return `
              <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                <input type="checkbox" disabled style="width: 18px; height: 18px;" />
                ${field.fieldLabel} ${requiredMark}
              </label>
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'checkboxGroup':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 8px;">${field.fieldLabel} ${requiredMark}</label>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                ${field.options.map(opt => `
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                    <input type="checkbox" disabled style="width: 18px; height: 18px;" />
                    ${opt}
                  </label>
                `).join('')}
              </div>
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'date':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 4px;">${field.fieldLabel} ${requiredMark}</label>
              <input type="date" disabled 
                     style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px;" />
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'search':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 4px;">${field.fieldLabel} ${requiredMark}</label>
              <div style="position: relative;">
                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 14px;">üîç</span>
                <input type="text" placeholder="${field.placeholder}" disabled 
                       style="width: 100%; padding: 8px 12px 8px 36px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px;" />
              </div>
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          case 'file':
            return `
              <label style="font-size: 14px; font-weight: 600; display: block; margin-bottom: 4px;">${field.fieldLabel} ${requiredMark}</label>
              <button disabled style="padding: 8px 16px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px; background: var(--surface-0); cursor: not-allowed;">
                üìé Choose File
              </button>
              <span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">
                Accepted: ${field.acceptedTypes.join(', ')} | Max: ${field.maxSize}MB
              </span>
              ${field.helpText ? `<span style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px;">${field.helpText}</span>` : ''}
            `;
          
          default:
            return `<span style="color: var(--text-muted); font-size: 13px;">Field type: ${field.fieldType}</span>`;
        }
      }
      
      // Search functionality
      function setupSearch(searchInputId, containerSelector) {
        const searchInput = document.getElementById(searchInputId);
        if (!searchInput) return;

        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const container = document.querySelector(containerSelector);
          if (!container) return;

          const blocks = container.querySelectorAll('.component-block');
          blocks.forEach((block) => {
            const text = block.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              block.classList.remove('hidden');
            } else {
              block.classList.add('hidden');
            }
          });
        });
      }

      // Initialize search bars
      setupSearch('search-forms', '#forms-list');
      setupSearch('search-fields', '#fields-list');

      // Block tabs management
      function updateBlockTabs() {
        const tabsContainer = document.getElementById('block-tabs');
        tabsContainer.innerHTML = '';

        if (blocks.length === 0) {
          tabsContainer.style.display = 'none';
          return;
        }

        tabsContainer.style.display = 'flex';

        blocks.forEach((block, index) => {
          const tab = document.createElement('button');
          tab.className = 'block-tab';
          if (index === activeBlockIndex) {
            tab.classList.add('active');
          }
          tab.innerHTML = `
            <span class="block-tab-number">${index + 1}</span>
            ${block.name}
          `;
          tab.addEventListener('click', () => {
            switchToBlock(index);
          });
          tabsContainer.appendChild(tab);
        });
      }

      function switchToBlock(index) {
        activeBlockIndex = index;
        updateBlockTabs();
        updateCanvasView();
      }

      function updateCanvasView() {
        const canvas = document.getElementById('canvas');
        const emptyState = canvas.querySelector('.canvas-empty');

        if (blocks.length === 0) {
          if (!emptyState) {
            canvas.innerHTML = `
              <div class="canvas-empty">
                <div class="canvas-empty-icon">üé®</div>
                <h2>Start Building Your Template</h2>
                <p>Drag and drop sections from the left sidebar to begin</p>
              </div>
            `;
          }
          return;
        }

        if (emptyState) {
          emptyState.remove();
        }

        // Remove all canvas views
        canvas.querySelectorAll('.canvas-view').forEach((view) => view.remove());

        // Create views for each block
        blocks.forEach((block, index) => {
          const view = document.createElement('div');
          view.className = 'canvas-view';
          if (index === activeBlockIndex) {
            view.classList.add('active');
          }
          view.dataset.blockIndex = index;
          view.appendChild(block.element);
          canvas.appendChild(view);
        });
      }

      // Drag and drop handlers
      function setupDragAndDrop() {
        document.querySelectorAll('.component-block').forEach((item) => {
          item.addEventListener('dragstart', (e) => {
            draggedElement = e.target.closest('.component-block');
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/html', draggedElement.innerHTML);
            e.dataTransfer.setData('component-type', draggedElement.dataset.type);
            e.dataTransfer.setData('section-type', draggedElement.dataset.sectionType || '');
            e.dataTransfer.setData('form-type', draggedElement.dataset.formType || '');
            e.dataTransfer.setData('field-type', draggedElement.dataset.fieldType || '');
            e.dataTransfer.setData('block-id', draggedElement.dataset.blockId || '');
            draggedElement.style.opacity = '0.5';
          });

          item.addEventListener('dragend', (e) => {
            if (draggedElement) {
              draggedElement.style.opacity = '1';
            }
          });
        });
      }

      setupDragAndDrop();

      const canvas = document.getElementById('canvas');

      // Setup drop zones for blocks
      function setupBlockDropZones() {
        document.querySelectorAll('.section-body, .subsection-body').forEach((dropZone) => {
          dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            dropZone.classList.add('active');
          });

          dropZone.addEventListener('dragleave', (e) => {
            if (!dropZone.contains(e.relatedTarget)) {
              dropZone.classList.remove('active');
            }
          });

          dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('active');

            const componentType = e.dataTransfer.getData('component-type');
            const formType = e.dataTransfer.getData('form-type');
            const fieldType = e.dataTransfer.getData('field-type');
            const blockId = e.dataTransfer.getData('block-id');

            // Remove from component list
            if (blockId && draggedElement) {
              draggedElement.remove();
              setupDragAndDrop();
            }

            if (componentType === 'form') {
              addFormToBlock(dropZone, formType);
            } else if (componentType === 'field') {
              addFieldToBlock(dropZone, fieldType);
            }

            draggedElement = null;
          });
        });
      }

      canvas.addEventListener('dragover', (e) => {
        // Only allow dropping sections on canvas, not forms/fields
        if (draggedElement && draggedElement.dataset.type === 'section') {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        }
      });

      canvas.addEventListener('drop', (e) => {
        e.preventDefault();

        const componentType = e.dataTransfer.getData('component-type');
        const sectionType = e.dataTransfer.getData('section-type');
        const blockId = e.dataTransfer.getData('block-id');

        // Only handle sections on canvas
        if (componentType === 'section') {
          // Remove block from component list
          if (blockId && draggedElement) {
            draggedElement.remove();
            setupDragAndDrop();
          }

          addSectionToCanvas(sectionType);
        }

        draggedElement = null;
      });

      function addSectionToCanvas(type) {
        // Check if this is a configurable block type
        if (type === 'general') {
          const blockConfig = initializeGeneralInfoBlock();
          templateConfig.blocks.push(blockConfig);
          
          // Create visual representation
          const section = document.createElement('div');
          section.className = 'dropped-section';
          section.dataset.sectionType = type;
          section.dataset.blockId = blockConfig.blockId;
          
          // Render admin configuration view
          section.innerHTML = renderBlockConfigView(blockConfig);
          
          // Add block to blocks array
          const blockIndex = blocks.length;
          blocks.push({
            name: blockConfig.blockName,
            element: section,
            type: type,
            config: blockConfig
          });
          
          // Add click handler for block selection
          section.addEventListener('click', (e) => {
            if (!e.target.closest('.icon-btn') && !e.target.closest('button') && !e.target.closest('input') && !e.target.closest('select')) {
              selectBlock(section, type, blockIndex);
            }
          });
          
          activeBlockIndex = blockIndex;
          updateBlockTabs();
          updateCanvasView();
          return;
        }
        
        // Fallback to old system for other block types
        const sectionData = {
          scope: {
            icon: 'üéØ',
            name: 'Scope & Requirements',
            subsections: [
              {
                title: 'Scope and objectives',
                fields: ['Scope and objectives of sourcing or solicitation process'],
              },
              {
                title: 'Product Requirements & Specifications',
                fields: ['UNSPSC Requirements', 'Export/Upload Spreadsheet'],
              },
              {
                title: 'Other requirements',
                fields: ['Service Descriptions', 'Delivery Requirements', 'Specific Requirements'],
              },
            ],
          },
          timeline: {
            icon: 'üìÖ',
            name: 'Timeline & Deadlines',
            subsections: [
              {
                title: 'Key Dates',
                fields: ['Deadline', 'Deadline for clarifications', 'Expected Contract award date'],
              },
            ],
          },
          evaluation: {
            icon: 'üìä',
            name: 'Evaluation',
            subsections: [
              {
                title: 'Evaluation Method',
                fields: ['Evaluation method', 'Weightage of technical and financial proposals', 'Minimum Points for Technical compliance'],
              },
            ],
          },
          submission: {
            icon: 'üìù',
            name: 'Submission Requirements',
            subsections: [
              {
                title: 'Submission Details',
                fields: [
                  'Quotation/Bid/Proposal validity period in days',
                  'Quotation/Bid/Proposal currency(ies)',
                  'Languages of quotations/bids/proposals',
                ],
              },
              {
                title: 'Bid Response Requirements',
                subsections: [
                  {
                    label: 'A. Per Bid (answered one time for entire bid)',
                    fields: [
                      { name: "Bidder's Total Prices [Incoterm]", type: "Currency input", id: 'pb1' },
                      { name: "Customs clearance costs", type: "Currency input", id: 'pb2' },
                      { name: "Freight cost", type: "Currency input", id: 'pb3' },
                      { name: "Total Price of Goods [Incoterm]", type: "Currency input (calculated)", id: 'pb4' },
                      { name: "Total Price of Related Services", type: "Currency input", id: 'pb5' }
                    ]
                  },
                  {
                    label: 'B. Per UNSPSC (supplier answers for each UNSPSC item)',
                    fields: [
                      { name: "Unit price Incoterm", type: "Currency input", id: 'pu1' },
                      { name: "Total price Incoterm", type: "Currency input (calculated)", id: 'pu2' },
                      { name: "Country of Origin", type: "Country dropdown", id: 'pu3' },
                      { name: "Delivery point(s)", type: "Text input", id: 'pu4' },
                      { name: "Model", type: "Text input", id: 'pu5' },
                      { name: "Manufacturer", type: "Text input", id: 'pu6' }
                    ]
                  },
                  {
                    label: 'C. Per Attribute (under each UNSPSC attribute)',
                    fields: [
                      { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pa1' },
                      { name: "Details of goods offered", type: "Text area", id: 'pa2' }
                    ]
                  },
                  {
                    label: 'D. Per Service Line',
                    fields: [
                      { name: "Is quotation compliant?", type: "Yes/No radio", id: 'ps1' },
                      { name: "Details", type: "Text area", id: 'ps2' }
                    ]
                  },
                  {
                    label: 'E. Per Delivery Requirements',
                    fields: [
                      { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pd1' },
                      { name: "Details", type: "Text area", id: 'pd2' }
                    ]
                  }
                ]
              },
              {
                title: 'Supplier Form Preview',
                fields: ['Preview of supplier submission form', 'Pre-filled with configured data'],
              },
            ],
          },
          general: {
            icon: 'üìã',
            name: 'General Information',
            subsections: [
              {
                title: 'Basic Information',
                fields: ['Title', 'Sourcing or solicitation?', 'Type of requirement', 'Description', 'Beneficiary country(ies)'],
              },
            ],
          },
          project: {
            icon: 'üèóÔ∏è',
            name: 'Project & Tender Details',
            subsections: [
              {
                title: 'Project Information',
                fields: ['Work package (GLA)', 'Donor/funding source (GLA)', 'Project name', 'Implementation end date'],
              },
            ],
          },
          requisition: {
            icon: 'üì¶',
            name: 'Requisition Details',
            subsections: [
              {
                title: 'Requisition Information',
                fields: [
                  'Requisition ID',
                  'Requisition line ID',
                  'Product & UNSPSC codes',
                  'Quantity',
                  'Currency',
                  'Amount/expected value of contract (USD)',
                ],
              },
            ],
          },
          'requisition-lots': {
            icon: 'üìã',
            name: 'Requisition & Lots',
            subsections: [
              {
                title: 'Block Configuration',
                fields: [
                  'Display Requisition Lines',
                  'Enable Lot Creation',
                  'Lot Assignment Rules',
                  'Default Lot Behavior',
                  'Requisition Line Data Source',
                ],
              },
              {
                title: 'Preview: Tender Author View',
                isPreviewSection: true,
                fields: [],
              },
            ],
          },
          team: {
            icon: 'üë•',
            name: 'Team',
            subsections: [
              {
                title: 'Team Members',
                fields: [
                  'Alternate authors (names)',
                  'Additional roles ‚Äì Procurement Reviewer',
                  'Additional roles ‚Äì Procurement Authority',
                  'Additional roles ‚Äì Technical Matter Expert',
                  'Additional roles ‚Äì Bid opening panel',
                  'Additional roles ‚Äì Evaluation team',
                  'Additional roles ‚Äì Collaborators',
                ],
              },
            ],
          },
          custom: {
            icon: 'üìã',
            name: 'Custom Section',
            subsections: [
              {
                title: 'Custom Subsection',
                fields: [],
              },
            ],
          },
        };

        const data = sectionData[type] || sectionData.custom;

        const section = document.createElement('div');
        section.className = 'dropped-section';
        section.dataset.sectionType = type;
        section.dataset.blockId = `block-${Date.now()}`;

        const sectionBody = document.createElement('div');
        sectionBody.className = 'section-body';

        data.subsections.forEach((subsection) => {
          const subsectionEl = document.createElement('div');
          subsectionEl.className = 'subsection';
          
          // Special handling for preview section in Requisition Lines & Lots
          if (subsection.isPreviewSection && type === 'requisition-lots') {
            subsectionEl.innerHTML = `
              <div class="subsection-header">
                <div class="subsection-title">
                  <span class="subsection-toggle">‚ñº</span>
                  ${subsection.title}
                </div>
              </div>
              <div class="subsection-body" id="requisition-lots-preview-${section.dataset.blockId}">
                <div style="padding: var(--spacing-md); background: var(--info-50); border: 1px solid var(--info-400); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">
                  <div style="font-size: 13px; color: var(--info-400); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span>‚ÑπÔ∏è</span>
                    <span>This is a preview of what tender authors will see when using this template. Configure block settings above to customize the behavior.</span>
                  </div>
                </div>
                ${renderRequisitionLotsPreview(section.dataset.blockId)}
              </div>
            `;
          } else {
            // Check if this subsection has nested subsections (like Bid Response Requirements)
            if (subsection.subsections && Array.isArray(subsection.subsections)) {
              subsectionEl.innerHTML = `
                <div class="subsection-header">
                  <div class="subsection-title">
                    <span class="subsection-toggle">‚ñº</span>
                    ${subsection.title}
                  </div>
                </div>
                <div class="subsection-body">
                  ${subsection.subsections.map(nestedSection => `
                    <div class="nested-subsection" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                      <h4 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-md);">
                        ${nestedSection.label}
                      </h4>
                      ${nestedSection.fields.map(field => `
                        <div class="field-item" data-field-id="${field.id}" data-field-name="${field.name}" data-field-type="${field.type}" data-field-required="true" style="margin-bottom: var(--spacing-sm);">
                          <div class="field-info">
                            <span class="field-label">${field.name}</span>
                            <div class="field-badges">
                              <span class="field-badge" style="background: var(--info-100); color: var(--info-600); padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">${field.type}</span>
                              <span class="field-badge badge-required">Required</span>
                            </div>
                          </div>
                          <div class="field-actions" style="display: flex; gap: var(--spacing-xs);">
                            <button class="icon-btn" onclick="editBidResponseField('${field.id}', '${nestedSection.label}')" title="Configure field">
                              <span>‚öôÔ∏è</span>
                            </button>
                          </div>
                        </div>
                      `).join('')}
                      <button class="btn-secondary" onclick="addCustomBidResponseField('${nestedSection.label}')" style="width: 100%; padding: var(--spacing-sm); margin-top: var(--spacing-sm); font-size: 13px;">
                        + Add Custom Field
                      </button>
                    </div>
                  `).join('')}
                  <div style="padding: var(--spacing-md); background: var(--info-50); border: 1px solid var(--info-400); border-radius: var(--radius-sm); margin-top: var(--spacing-md);">
                    <div style="font-size: 13px; color: var(--info-400); display: flex; align-items: center; gap: var(--spacing-sm);">
                      <span>‚ÑπÔ∏è</span>
                      <span>Configure which fields are required, optional, or hidden. Tender authors will use these to define what suppliers must provide in their bids.</span>
                    </div>
                  </div>
                </div>
              `;
            } else {
              // Standard subsection with simple fields array
              subsectionEl.innerHTML = `
                <div class="subsection-header">
                  <div class="subsection-title">
                    <span class="subsection-toggle">‚ñº</span>
                    ${subsection.title}
                  </div>
                </div>
                <div class="subsection-body">
                  ${subsection.fields
                    .map(
                      (field) => `
                    <div class="field-item" data-field-name="${field}" data-field-required="true">
                      <div class="field-info">
                        <span class="field-label">${field}</span>
                        <div class="field-badges">
                          <span class="field-badge badge-required">Required</span>
                          <span class="field-badge badge-mapped">Mapped</span>
                        </div>
                      </div>
                    </div>
                  `
                    )
                    .join('')}
                  <div class="drop-zone">Drop fields here</div>
                </div>
              `;
            }
          }

          const header = subsectionEl.querySelector('.subsection-header');
          header.addEventListener('click', () => {
            subsectionEl.classList.toggle('collapsed');
          });

          // Add field click handlers (only for non-preview sections)
          if (!subsection.isPreviewSection) {
            subsectionEl.querySelectorAll('.field-item').forEach((fieldItem) => {
              // Remove delete button if field is required
              if (fieldItem.dataset.fieldRequired === 'true') {
                const controls = fieldItem.querySelector('.section-controls');
                if (controls) {
                  controls.remove();
                }
              }

              fieldItem.addEventListener('click', (e) => {
                if (!e.target.closest('.icon-btn')) {
                  selectField(fieldItem, fieldItem.dataset.fieldName);
                }
              });
            });
          }

          sectionBody.appendChild(subsectionEl);
        });

        // Add a drop zone at the end of section body for adding new items
        const sectionDropZone = document.createElement('div');
        sectionDropZone.className = 'drop-zone';
        sectionDropZone.textContent = 'Drop forms, documents, or fields here';
        sectionBody.appendChild(sectionDropZone);

        // Create section header
        const sectionHeader = document.createElement('div');
        sectionHeader.className = 'section-header';
        sectionHeader.innerHTML = `
          <div class="section-title-area">
            <span class="section-icon">${data.icon}</span>
            <span class="section-name">${data.name}</span>
          </div>
          <div class="section-controls">
            <button class="icon-btn" onclick="moveUp(this)" title="Move Up">‚Üë</button>
            <button class="icon-btn" onclick="moveDown(this)" title="Move Down">‚Üì</button>
            <button class="icon-btn" onclick="toggleSection(this)" title="Collapse">‚àí</button>
            <button class="icon-btn" onclick="deleteSection(this)" title="Delete">‚úñ</button>
          </div>
        `;

        section.appendChild(sectionHeader);
        section.appendChild(sectionBody);

        // Add block to blocks array
        const blockIndex = blocks.length;
        blocks.push({
          name: data.name,
          element: section,
          type: type,
        });

        // Add click handler for block selection
        section.addEventListener('click', (e) => {
          if (!e.target.closest('.icon-btn') && !e.target.closest('.field-item') && !e.target.closest('.subsection-header')) {
            selectBlock(section, type, blockIndex);
          }
        });

        activeBlockIndex = blockIndex;
        updateBlockTabs();
        updateCanvasView();
        setupBlockDropZones();
      }

      function addFormToBlock(dropZone, type) {
        const formNames = {
          instructions: 'Instructions to Bidders',
          contracts: 'Contract Forms',
          'bank-guarantee': 'Bank Guarantee Form',
          'bid-security': 'Bid Security Form',
          'drive-questionnaire': 'DRiVE Questionnaire',
        };

        const formItem = document.createElement('div');
        formItem.className = 'field-item';
        formItem.dataset.formType = type;
        formItem.innerHTML = `
          <div class="field-info">
            <span class="field-label">${formNames[type] || 'Document Form'}</span>
            <div class="field-badges">
              <span class="field-badge badge-mapped">Document</span>
            </div>
          </div>
          <div class="section-controls">
            <button class="icon-btn" onclick="previewForm(this)" title="Preview">üëÅ</button>
            <button class="icon-btn" onclick="deleteField(this)" title="Delete">‚úñ</button>
          </div>
        `;

        formItem.addEventListener('click', (e) => {
          if (!e.target.closest('.icon-btn')) {
            selectField(formItem, formNames[type] || 'Document Form');
          }
        });

        // Insert before drop zone if it exists, otherwise append
        const existingDropZone = dropZone.querySelector('.drop-zone');
        if (existingDropZone) {
          dropZone.insertBefore(formItem, existingDropZone);
        } else {
          dropZone.appendChild(formItem);
        }
      }

      function addFormToCanvas(type) {
        // Forms should only be added to blocks, not canvas
        // If no blocks exist, create a default block first
        if (blocks.length === 0) {
          addSectionToCanvas('custom');
        }

        // Add to the active block
        if (blocks.length > 0 && activeBlockIndex < blocks.length) {
          const activeBlock = blocks[activeBlockIndex].element;
          const sectionBody = activeBlock.querySelector('.section-body');
          if (sectionBody) {
            addFormToBlock(sectionBody, type);
            return;
          }
        }
      }

      function addFieldToBlock(dropZone, type) {
        const fieldNames = {
          'un-collab': 'UN Collaboration?',
          epp: 'EPP?',
          medicine: 'Medicine/Medical equipment?',
          lease: 'Is this a lease?',
          custom: 'Custom Field',
        };

        const field = document.createElement('div');
        field.className = 'field-item';
        field.dataset.fieldType = type;
        field.dataset.fieldName = fieldNames[type] || 'Custom Field';
        field.dataset.fieldRequired = 'false'; // Custom fields are not required by default
        field.innerHTML = `
          <div class="field-info">
            <span class="field-label">${fieldNames[type] || 'Custom Field'}</span>
            <div class="field-badges">
              <span class="field-badge badge-conditional">Conditional</span>
            </div>
          </div>
          <div class="section-controls">
            <button class="icon-btn" onclick="deleteField(this)" title="Delete">‚úñ</button>
          </div>
        `;

        field.addEventListener('click', (e) => {
          if (!e.target.closest('.icon-btn')) {
            selectField(field, fieldNames[type] || 'Custom Field');
          }
        });

        // Insert before drop zone if it exists, otherwise append
        const existingDropZone = dropZone.querySelector('.drop-zone');
        if (existingDropZone) {
          dropZone.insertBefore(field, existingDropZone);
        } else {
          dropZone.appendChild(field);
        }
      }

      function addFieldToCanvas(type) {
        // Fields should only be added to blocks, not canvas
        // If no blocks exist, create a default block first
        if (blocks.length === 0) {
          addSectionToCanvas('custom');
        }

        // Add to the active block
        if (blocks.length > 0 && activeBlockIndex < blocks.length) {
          const activeBlock = blocks[activeBlockIndex].element;
          const sectionBody = activeBlock.querySelector('.section-body');
          if (sectionBody) {
            addFieldToBlock(sectionBody, type);
            return;
          }
        }
      }

      function selectBlock(element, type, blockIndex) {
        // Remove previous selections
        document.querySelectorAll('.dropped-section').forEach((el) => {
          el.classList.remove('selected');
        });
        document.querySelectorAll('.field-item').forEach((el) => {
          el.classList.remove('selected');
        });

        // Highlight selected block
        element.classList.add('selected');
        selectedElement = element;
        selectedBlockType = type;
        selectedFieldElement = null;

        // Switch to this block's tab
        activeBlockIndex = blockIndex;
        updateBlockTabs();
        updateCanvasView();

        // Switch properties panel
        const header = document.getElementById('properties-header');
        const templateProps = document.getElementById('template-properties');
        const blockProps = document.getElementById('block-properties');
        const componentProps = document.getElementById('component-properties');

        header.textContent = 'Properties ¬∑ Block';
        templateProps.classList.add('hidden');
        componentProps.classList.add('hidden');
        blockProps.classList.remove('hidden');

        // Populate block properties
        const sectionName = element.querySelector('.section-name')?.textContent || '';
        document.getElementById('block-name').value = sectionName;
        
        // Show/hide Requisition Lines & Lots specific configuration
        const requisitionLotsConfig = document.getElementById('requisition-lots-config');
        const generalBlockConfig = document.getElementById('general-block-config');
        
        if (type === 'requisition-lots') {
          requisitionLotsConfig.classList.remove('hidden');
          generalBlockConfig.classList.add('hidden');
          
          // Populate configuration values
          const blockId = element.dataset.blockId;
          const config = blockConfigurations[blockId] || {};
          document.getElementById('config-display-requisition-lines').checked = config.displayRequisitionLines !== false;
          document.getElementById('config-enable-lot-creation').checked = config.enableLotCreation !== false;
          document.getElementById('config-lot-assignment-rules').value = config.lotAssignmentRules || 'flexible';
          document.getElementById('config-data-source').value = config.dataSource || 'erp';
        } else {
          requisitionLotsConfig.classList.add('hidden');
          generalBlockConfig.classList.remove('hidden');
        }
      }

      function selectField(fieldElement, fieldName) {
        // Remove previous selections
        document.querySelectorAll('.dropped-section').forEach((el) => {
          el.classList.remove('selected');
        });
        document.querySelectorAll('.field-item').forEach((el) => {
          el.classList.remove('selected');
        });

        // Highlight selected field
        fieldElement.classList.add('selected');
        selectedFieldElement = fieldElement;
        selectedElement = null;

        // Switch properties panel
        const header = document.getElementById('properties-header');
        const templateProps = document.getElementById('template-properties');
        const blockProps = document.getElementById('block-properties');
        const componentProps = document.getElementById('component-properties');

        header.textContent = 'Properties ¬∑ Component';
        templateProps.classList.add('hidden');
        blockProps.classList.add('hidden');
        componentProps.classList.remove('hidden');

        // Populate component properties
        document.getElementById('component-label').value = fieldName;
      }

      function toggleSection(btn) {
        const section = btn.closest('.dropped-section');
        const body = section.querySelector('.section-body');
        body.classList.toggle('collapsed');
        btn.textContent = body.classList.contains('collapsed') ? '+' : '‚àí';
      }

      function moveUp(btn) {
        const section = btn.closest('.dropped-section');
        const blockIndex = Array.from(blocks).findIndex((b) => b.element === section);
        if (blockIndex > 0) {
          const temp = blocks[blockIndex];
          blocks[blockIndex] = blocks[blockIndex - 1];
          blocks[blockIndex - 1] = temp;
          updateBlockTabs();
          updateCanvasView();
        }
      }

      function moveDown(btn) {
        const section = btn.closest('.dropped-section');
        const blockIndex = Array.from(blocks).findIndex((b) => b.element === section);
        if (blockIndex < blocks.length - 1) {
          const temp = blocks[blockIndex];
          blocks[blockIndex] = blocks[blockIndex + 1];
          blocks[blockIndex + 1] = temp;
          updateBlockTabs();
          updateCanvasView();
        }
      }

      // Edit field modal
      window.editField = function(blockId, sectionId, fieldId) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        const field = section?.fields.find(f => f.fieldId === fieldId);
        
        if (!field) {
          alert('Field not found');
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'field-edit-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        `;
        
        modal.innerHTML = `
          <div style="background: var(--surface-0); border-radius: var(--radius-lg); box-shadow: var(--shadow-modal); max-width: 800px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Configure Field</h3>
              <button class="icon-btn" onclick="closeModal()" style="font-size: 16px;">‚úñ</button>
            </div>
            
            <div style="padding: var(--spacing-lg); overflow-y: auto; flex: 1;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                <!-- Basic Configuration -->
                <div style="background: var(--surface-50); border-radius: var(--radius-md); padding: var(--spacing-md);">
                  <h4 style="margin: 0 0 var(--spacing-md) 0; font-size: 16px;">Basic Configuration</h4>
                  
                  <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Field Label</label>
                    <input type="text" id="edit-label" value="${field.fieldLabel}" class="input" style="width: 100%;" />
                  </div>
                  
                  <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Field Type</label>
                    <select id="edit-type" class="select" style="width: 100%;" onchange="updateFieldTypeOptions(this.value)">
                      ${Object.entries(fieldTypes).map(([key, val]) => 
                        `<option value="${key}" ${field.fieldType === key ? 'selected' : ''}>${val.icon} ${val.label}</option>`
                      ).join('')}
                    </select>
                  </div>
                  
                  <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                      <input type="checkbox" id="edit-required" ${field.required ? 'checked' : ''} />
                      Required Field
                    </label>
                  </div>
                  
                  <div style="margin-bottom: var(--spacing-md);">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                      <input type="checkbox" id="edit-enabled" ${field.enabled ? 'checked' : ''} />
                      Field Enabled
                    </label>
                  </div>
                </div>
                
                <!-- Field-Specific Configuration -->
                <div style="background: var(--surface-50); border-radius: var(--radius-md); padding: var(--spacing-md);">
                  <h4 style="margin: 0 0 var(--spacing-md) 0; font-size: 16px;">Field-Specific Settings</h4>
                  
                  <div id="field-specific-config">
                    ${renderFieldSpecificConfig(field)}
                  </div>
                </div>
                
                <!-- Conditional Visibility -->
                <div style="grid-column: 1 / -1; background: var(--surface-50); border-radius: var(--radius-md); padding: var(--spacing-md);">
                  <h4 style="margin: 0 0 var(--spacing-md) 0; font-size: 16px;">Conditional Visibility</h4>
                  <div id="conditional-config" style="margin-bottom: var(--spacing-md);">
                    ${field.conditionalVisibility ? renderConditionalRulesSummary(field.conditionalVisibility) : '<p style="color: var(--text-muted); font-size: 14px;">No conditional rules set</p>'}
                  </div>
                  <button class="btn btn-ghost btn-sm" onclick="alert('Conditional rules builder will be implemented')">
                    ${field.conditionalVisibility ? '‚úèÔ∏è Edit Rules' : '‚ûï Add Rules'}
                  </button>
                </div>
              </div>
            </div>
            
            <div style="padding: var(--spacing-lg); border-top: 1px solid var(--surface-200); display: flex; justify-content: flex-end; gap: var(--spacing-sm);">
              <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveFieldConfig('${blockId}', '${sectionId}', '${fieldId}')">Save Changes</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      };
      
      // Render field-specific configuration options
      function renderFieldSpecificConfig(field) {
        let html = '';
        
        // Placeholder
        if (['text', 'textarea', 'search'].includes(field.fieldType)) {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Placeholder Text</label>
              <input type="text" class="input" id="edit-placeholder" value="${field.placeholder}" style="width: 100%;" />
            </div>
          `;
        }
        
        // Help Text
        html += `
          <div style="margin-bottom: var(--spacing-md);">
            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Help Text</label>
            <textarea class="textarea" id="edit-helptext" rows="2" style="width: 100%;">${field.helpText}</textarea>
          </div>
        `;
        
        // Default Value
        if (!field.readonly) {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Default Value</label>
              <input type="text" class="input" id="edit-default" value="${field.defaultValue}" style="width: 100%;" />
            </div>
          `;
        }
        
        // Options for dropdown/checkbox group
        if (['dropdown', 'checkboxGroup', 'radio'].includes(field.fieldType)) {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Options (one per line)</label>
              <textarea class="textarea" id="edit-options" rows="5" style="width: 100%;">${field.options.join('\n')}</textarea>
            </div>
          `;
          
          if (field.fieldType === 'dropdown') {
            html += `
              <div style="margin-bottom: var(--spacing-md);">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                  <input type="checkbox" id="edit-multiple" ${field.allowMultiple ? 'checked' : ''} />
                  Allow Multiple Selection
                </label>
              </div>
            `;
          }
        }
        
        // Data Source for search fields
        if (field.fieldType === 'search') {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Data Source</label>
              <select class="select" id="edit-datasource" style="width: 100%;">
                <option value="oneUNOPS" ${field.dataSource === 'oneUNOPS' ? 'selected' : ''}>oneUNOPS</option>
                <option value="Event ID" ${field.dataSource === 'Event ID' ? 'selected' : ''}>Event ID</option>
                <option value="RDAT" ${field.dataSource === 'RDAT' ? 'selected' : ''}>oneUNOPS RDAT</option>
              </select>
            </div>
          `;
        }
        
        // File upload specific
        if (field.fieldType === 'file') {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Accepted File Types</label>
              <input type="text" class="input" id="edit-acceptedtypes" value="${field.acceptedTypes.join(', ')}" 
                     placeholder=".pdf, .doc, .docx" style="width: 100%;" />
            </div>
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Max File Size (MB)</label>
              <input type="number" class="input" id="edit-maxsize" value="${field.maxSize || 10}" style="width: 100%;" />
            </div>
          `;
        }
        
        // Textarea rows
        if (field.fieldType === 'textarea') {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 4px;">Number of Rows</label>
              <input type="number" class="input" id="edit-rows" value="${field.rows || 3}" min="2" max="20" style="width: 100%;" />
            </div>
          `;
        }
        
        // Validation
        if (['text', 'textarea'].includes(field.fieldType)) {
          html += `
            <div style="margin-bottom: var(--spacing-md);">
              <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Validation</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <input type="number" class="input" id="edit-minlength" placeholder="Min length" 
                       value="${field.validation?.minLength || ''}" />
                <input type="number" class="input" id="edit-maxlength" placeholder="Max length" 
                       value="${field.validation?.maxLength || ''}" />
              </div>
            </div>
          `;
        }
        
        return html;
      }
      
      // Save field configuration
      window.saveFieldConfig = function(blockId, sectionId, fieldId) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        const field = section?.fields.find(f => f.fieldId === fieldId);
        
        if (!field) return;
        
        // Update field properties from form
        field.fieldLabel = document.getElementById('edit-label')?.value || field.fieldLabel;
        field.fieldType = document.getElementById('edit-type')?.value || field.fieldType;
        field.required = document.getElementById('edit-required')?.checked || false;
        field.enabled = document.getElementById('edit-enabled')?.checked || false;
        field.placeholder = document.getElementById('edit-placeholder')?.value || '';
        field.helpText = document.getElementById('edit-helptext')?.value || '';
        field.defaultValue = document.getElementById('edit-default')?.value || '';
        
        // Type-specific properties
        if (['dropdown', 'checkboxGroup', 'radio'].includes(field.fieldType)) {
          const optionsText = document.getElementById('edit-options')?.value || '';
          field.options = optionsText.split('\n').filter(o => o.trim() !== '');
          field.allowMultiple = document.getElementById('edit-multiple')?.checked || false;
        }
        
        if (field.fieldType === 'search') {
          field.dataSource = document.getElementById('edit-datasource')?.value || 'oneUNOPS';
        }
        
        if (field.fieldType === 'file') {
          const acceptedTypesText = document.getElementById('edit-acceptedtypes')?.value || '';
          field.acceptedTypes = acceptedTypesText.split(',').map(t => t.trim()).filter(t => t !== '');
          field.maxSize = parseInt(document.getElementById('edit-maxsize')?.value) || 10;
        }
        
        if (field.fieldType === 'textarea') {
          field.rows = parseInt(document.getElementById('edit-rows')?.value) || 3;
        }
        
        // Validation
        if (['text', 'textarea'].includes(field.fieldType)) {
          field.validation = field.validation || {};
          const minLength = document.getElementById('edit-minlength')?.value;
          const maxLength = document.getElementById('edit-maxlength')?.value;
          if (minLength) field.validation.minLength = parseInt(minLength);
          if (maxLength) field.validation.maxLength = parseInt(maxLength);
        }
        
        // Update template config modification date
        templateConfig.modifiedDate = new Date().toISOString();
        
        // Re-render the block config view
        updateCanvasView();
        
        // Close modal
        closeModal();
        
        // Show success message
        showNotification('Field configuration saved successfully', 'success');
      };
      
      // Helper functions
      window.closeModal = function() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
      };
      
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 24px;
          background: ${type === 'success' ? 'var(--success-500)' : 'var(--info-400)'};
          color: white;
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-card);
          z-index: 10000;
          font-size: 14px;
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }
      
      function renderConditionalRulesSummary(rules) {
        if (!rules || !rules.rules || rules.rules.length === 0) {
          return '<p style="color: var(--text-muted); font-size: 14px;">No rules defined</p>';
        }
        
        return `
          <div style="padding: var(--spacing-sm); background: var(--surface-0); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
            <div style="display: inline-block; padding: 2px 8px; background: var(--primary-50); color: var(--primary-400); border-radius: 4px; font-size: 11px; font-weight: 600; margin-bottom: 8px;">${rules.logic}</div>
            <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
              ${rules.rules.map(rule => `
                <li style="margin-bottom: 4px;">
                  <strong>${rule.field}</strong> ${rule.operator} ${rule.value !== null ? `"${rule.value}"` : ''}
                </li>
              `).join('')}
            </ul>
          </div>
        `;
      }
      
      // Config block management functions
      window.updateBlockName = function(blockId, newName) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        if (blockConfig) {
          blockConfig.blockName = newName;
          const block = blocks.find(b => b.config?.blockId === blockId);
          if (block) block.name = newName;
          templateConfig.modifiedDate = new Date().toISOString();
          updateBlockTabs();
        }
      };
      
      window.toggleBlockEnabled = function(blockId, enabled) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        if (blockConfig) {
          blockConfig.enabled = enabled;
          templateConfig.modifiedDate = new Date().toISOString();
        }
      };
      
      window.deleteConfigBlock = function(blockId) {
        if (!confirm('Are you sure you want to delete this block and all its configuration?')) return;
        
        const index = templateConfig.blocks.findIndex(b => b.blockId === blockId);
        if (index > -1) {
          templateConfig.blocks.splice(index, 1);
          
          const blockIndex = blocks.findIndex(b => b.config?.blockId === blockId);
          if (blockIndex > -1) {
            blocks.splice(blockIndex, 1);
            if (activeBlockIndex >= blocks.length) {
              activeBlockIndex = Math.max(0, blocks.length - 1);
            }
          }
          
          templateConfig.modifiedDate = new Date().toISOString();
          updateBlockTabs();
          updateCanvasView();
        }
      };
      
      window.updateSectionName = function(blockId, sectionId, newName) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        if (section) {
          section.sectionName = newName;
          templateConfig.modifiedDate = new Date().toISOString();
        }
      };
      
      window.toggleSectionEnabled = function(blockId, sectionId, enabled) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        if (section) {
          section.enabled = enabled;
          templateConfig.modifiedDate = new Date().toISOString();
        }
      };
      
      window.deleteConfigSection = function(blockId, sectionId) {
        if (!confirm('Are you sure you want to delete this section and all its fields?')) return;
        
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        if (blockConfig) {
          const index = blockConfig.sections.findIndex(s => s.sectionId === sectionId);
          if (index > -1) {
            blockConfig.sections.splice(index, 1);
            templateConfig.modifiedDate = new Date().toISOString();
            updateCanvasView();
          }
        }
      };
      
      window.deleteConfigField = function(blockId, sectionId, fieldId) {
        if (!confirm('Are you sure you want to delete this field?')) return;
        
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        
        if (section) {
          const index = section.fields.findIndex(f => f.fieldId === fieldId);
          if (index > -1) {
            section.fields.splice(index, 1);
            templateConfig.modifiedDate = new Date().toISOString();
            updateCanvasView();
          }
        }
      };
      
      window.duplicateField = function(blockId, sectionId, fieldId) {
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        const field = section?.fields.find(f => f.fieldId === fieldId);
        
        if (field && section) {
          const duplicate = JSON.parse(JSON.stringify(field));
          duplicate.fieldId = 'field-' + Date.now();
          duplicate.fieldLabel += ' (Copy)';
          section.fields.push(duplicate);
          templateConfig.modifiedDate = new Date().toISOString();
          updateCanvasView();
          showNotification('Field duplicated successfully', 'success');
        }
      };
      
      window.addFieldToSection = function(blockId, sectionId) {
        const fieldName = prompt('Enter field name:');
        if (!fieldName) return;
        
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        const section = blockConfig?.sections.find(s => s.sectionId === sectionId);
        
        if (section) {
          const newField = createFieldConfig('field-' + Date.now(), fieldName, 'text', false, {});
          section.fields.push(newField);
          templateConfig.modifiedDate = new Date().toISOString();
          updateCanvasView();
          showNotification('Field added successfully', 'success');
        }
      };
      
      function deleteSection(btn) {
        if (confirm('Delete this section?')) {
          const section = btn.closest('.dropped-section');
          const blockIndex = blocks.findIndex((b) => b.element === section);

          if (blockIndex !== -1) {
            blocks.splice(blockIndex, 1);
            if (activeBlockIndex >= blocks.length) {
              activeBlockIndex = Math.max(0, blocks.length - 1);
            }
            updateBlockTabs();
            updateCanvasView();
          }

          // Reset properties panel if deleted section was selected
          if (selectedElement === section || selectedFieldElement) {
            const header = document.getElementById('properties-header');
            const templateProps = document.getElementById('template-properties');
            const blockProps = document.getElementById('block-properties');
            const componentProps = document.getElementById('component-properties');
            header.textContent = 'Properties ¬∑ Template';
            templateProps.classList.remove('hidden');
            blockProps.classList.add('hidden');
            componentProps.classList.add('hidden');
            selectedElement = null;
            selectedFieldElement = null;
          }
        }
      }

      function previewForm(btn) {
        const formItem = btn.closest('.field-item');
        const formType = formItem.dataset.formType;
        const formNames = {
          instructions: 'Instructions to Bidders',
          contracts: 'Contract Forms',
          'bank-guarantee': 'Bank Guarantee Form',
          'bid-security': 'Bid Security Form',
          'drive-questionnaire': 'DRiVE Questionnaire',
        };
        const formName = formNames[formType] || 'Document Form';
        alert(`Preview: ${formName}\n\nThis would open a preview modal or new window showing the form/document template.`);
      }

      function deleteField(btn) {
        if (confirm('Delete this field?')) {
          const fieldItem = btn.closest('.field-item');
          fieldItem.remove();

          // Reset properties if deleted field was selected
          if (selectedFieldElement === fieldItem) {
            const header = document.getElementById('properties-header');
            const templateProps = document.getElementById('template-properties');
            const blockProps = document.getElementById('block-properties');
            const componentProps = document.getElementById('component-properties');
            header.textContent = 'Properties ¬∑ Template';
            templateProps.classList.remove('hidden');
            blockProps.classList.add('hidden');
            componentProps.classList.add('hidden');
            selectedFieldElement = null;
          }
        }
      }

      // ===== REQUISITION LINES & LOTS FUNCTIONS (Template Builder Context) =====
      
      // Initialize sample requisition lines for preview
      function initializePreviewRequisitionLines(blockId) {
        if (!previewRequisitionLines[blockId]) {
          previewRequisitionLines[blockId] = [
            {
              id: 'REQ-LINE-001',
              unspscCode: '43211503',
              unspscDescription: 'Laptop computers',
              description: 'Laptop computers for office use',
              quantity: 50,
              unitOfMeasure: 'Unit',
              amount: 25000,
              currency: 'USD',
            },
            {
              id: 'REQ-LINE-002',
              unspscCode: '43211602',
              unspscDescription: 'Docking stations',
              description: 'Docking stations for laptops',
              quantity: 50,
              unitOfMeasure: 'Unit',
              amount: 10000,
              currency: 'USD',
            },
            {
              id: 'REQ-LINE-003',
              unspscCode: '44101503',
              unspscDescription: 'Laser printers',
              description: 'Laser printers for office',
              quantity: 5,
              unitOfMeasure: 'Unit',
              amount: 2500,
              currency: 'USD',
            },
          ];
        }
        
        if (!previewLots[blockId]) {
          previewLots[blockId] = [];
        }
        
        if (!blockConfigurations[blockId]) {
          blockConfigurations[blockId] = {
            displayRequisitionLines: true,
            enableLotCreation: true,
            lotAssignmentRules: 'flexible', // 'flexible' | 'strict'
            dataSource: 'erp',
          };
        }
      }
      
      function renderRequisitionLotsPreview(blockId) {
        initializePreviewRequisitionLines(blockId);
        
        const requisitionLines = previewRequisitionLines[blockId] || [];
        const lots = previewLots[blockId] || [];
        const config = blockConfigurations[blockId] || {};
        
        return `
          <div class="preview-container" style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: var(--spacing-lg); background: var(--surface-50);">
            ${config.displayRequisitionLines ? `
              <div class="requisition-section" style="margin-bottom: var(--spacing-2xl);">
                <div class="section-subheader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                  <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">Requisition Lines (from ERP - Reference Only)</h3>
                  <span style="padding: 4px 12px; background: var(--primary-50); color: var(--primary-400); border-radius: 12px; font-size: 12px; font-weight: 600;">${requisitionLines.length} lines</span>
                </div>
                <div style="overflow-x: auto; border: 1px solid var(--surface-200); border-radius: var(--radius-sm);">
                  <table style="width: 100%; border-collapse: collapse; background: var(--surface-0);">
                    <thead style="background: var(--surface-50); border-bottom: 2px solid var(--surface-200);">
                      <tr>
                        <th style="padding: var(--spacing-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">ID</th>
                        <th style="padding: var(--spacing-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">UNSPSC Code</th>
                        <th style="padding: var(--spacing-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Description</th>
                        <th style="padding: var(--spacing-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Quantity</th>
                        <th style="padding: var(--spacing-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Unit</th>
                        <th style="padding: var(--spacing-md); text-align: left; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${requisitionLines.map(line => `
                        <tr style="border-bottom: 1px solid var(--surface-200);">
                          <td style="padding: var(--spacing-md); font-size: 14px;"><strong>${line.id}</strong></td>
                          <td style="padding: var(--spacing-md); font-size: 14px;">
                            <div style="font-weight: 600; color: var(--primary-400); font-family: 'Courier New', monospace;">${line.unspscCode}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${line.unspscDescription}</div>
                          </td>
                          <td style="padding: var(--spacing-md); font-size: 14px;">${line.description}</td>
                          <td style="padding: var(--spacing-md); font-size: 14px;">${line.quantity}</td>
                          <td style="padding: var(--spacing-md); font-size: 14px;">${line.unitOfMeasure}</td>
                          <td style="padding: var(--spacing-md); font-size: 14px;">${line.currency} ${line.amount.toLocaleString()}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}
            
            ${config.enableLotCreation ? `
              <div class="lots-section" style="margin-bottom: var(--spacing-2xl);">
                <div class="section-subheader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                  <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">Lots</h3>
                  <button class="btn btn-primary btn-sm" onclick="createPreviewLot('${blockId}')" style="padding: 6px 12px; font-size: 12px; height: auto;">+ Create Lot</button>
                </div>
                
                ${lots.length === 0 ? `
                  <div style="padding: var(--spacing-2xl); text-align: center; background: var(--surface-50); border-radius: var(--radius-sm); border: 1px dashed var(--surface-300);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üì¶</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">No lots created yet</div>
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-lg);">Create lots to organize products (UNSPSC codes), or proceed without lots.</div>
                    <button class="btn btn-ghost" onclick="createPreviewLot('${blockId}')" style="padding: 8px 16px; font-size: 13px;">Create First Lot</button>
                  </div>
                ` : `
                  <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                    ${lots.map((lot, lotIndex) => `
                      <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); background: var(--surface-0); overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md) var(--spacing-lg); background: var(--surface-50); border-bottom: 1px solid var(--surface-200);">
                          <div style="display: flex; align-items: center; gap: var(--spacing-md); flex: 1;">
                            <span style="padding: 4px 10px; background: var(--primary-400); color: white; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600;">Lot ${lotIndex + 1}</span>
                            <input type="text" value="${lot.name}" onchange="updatePreviewLotName('${blockId}', '${lot.id}', this.value)" placeholder="Enter lot name" style="flex: 1; padding: 6px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; background: var(--surface-0); min-width: 200px;" />
                          </div>
                          <div style="display: flex; gap: var(--spacing-xs);">
                            <button class="icon-btn" onclick="deletePreviewLot('${blockId}', '${lot.id}')" title="Delete" style="color: var(--danger-500);">üóëÔ∏è</button>
                          </div>
                        </div>
                        <div style="padding: var(--spacing-lg);">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); font-size: 14px; font-weight: 600;">
                            <span>Products (UNSPSC Codes) in this Lot (${lot.unspscCodes.length})</span>
                            <button class="btn btn-ghost btn-sm" onclick="addProductsToPreviewLot('${blockId}', '${lot.id}')" style="padding: 4px 8px; font-size: 12px;">+ Add Products</button>
                          </div>
                          ${lot.unspscCodes.length === 0 ? `
                            <div style="padding: var(--spacing-lg); text-align: center; color: var(--text-muted); font-size: 14px; background: var(--surface-50); border-radius: var(--radius-sm); border: 1px dashed var(--surface-300);">
                              No products added. Click "Add Products" to add UNSPSC codes.
                            </div>
                          ` : `
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                              ${lot.unspscCodes.map((unspsc, idx) => `
                                <div style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-sm) var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                                  <span style="font-family: 'Courier New', monospace; font-weight: 600; color: var(--primary-400); min-width: 100px;">${unspsc.code}</span>
                                  <span style="flex: 1; font-size: 14px;">${unspsc.description || 'No description'}</span>
                                  <button onclick="removeProductFromPreviewLot('${blockId}', '${lot.id}', ${idx})" title="Remove" style="width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; color: var(--text-muted); font-size: 12px;">‚úñ</button>
                                </div>
                              `).join('')}
                            </div>
                          `}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            ` : ''}
            
            <div class="structure-summary" style="margin-bottom: var(--spacing-lg);">
              <div class="section-subheader" style="margin-bottom: var(--spacing-lg);">
                <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin: 0;">Tender Structure Summary</h3>
              </div>
              <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg);">
                ${lots.length === 0 ? `
                  <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--surface-200);">
                    <span style="font-size: 14px; color: var(--text-secondary);">Structure:</span>
                    <span style="font-size: 14px; font-weight: 600;">No Lots (${requisitionLines.length} requisition lines from ERP)</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0;">
                    <span style="font-size: 14px; color: var(--text-secondary);">Total Value:</span>
                    <span style="font-size: 14px; font-weight: 600;">${requisitionLines.reduce((sum, line) => sum + line.amount, 0).toLocaleString()} USD</span>
                  </div>
                ` : `
                  <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--surface-200);">
                    <span style="font-size: 14px; color: var(--text-secondary);">Structure:</span>
                    <span style="font-size: 14px; font-weight: 600;">${lots.length} Lot(s)</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--surface-200);">
                    <span style="font-size: 14px; color: var(--text-secondary);">Requisition Lines (from ERP):</span>
                    <span style="font-size: 14px; font-weight: 600;">${requisitionLines.length}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--surface-200);">
                    <span style="font-size: 14px; color: var(--text-secondary);">Total Products in Lots:</span>
                    <span style="font-size: 14px; font-weight: 600;">${lots.reduce((sum, lot) => sum + lot.unspscCodes.length, 0)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: var(--spacing-sm) 0;">
                    <span style="font-size: 14px; color: var(--text-secondary);">Total Value (Requisition Lines):</span>
                    <span style="font-size: 14px; font-weight: 600;">${requisitionLines.reduce((sum, line) => sum + line.amount, 0).toLocaleString()} USD</span>
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }
      
      // Global functions for preview interaction
      window.createPreviewLot = function(blockId) {
        const lotName = prompt('Enter lot name:');
        if (!lotName) return;
        
        if (!previewLots[blockId]) {
          previewLots[blockId] = [];
        }
        
        const newLot = {
          id: 'lot-' + Date.now(),
          name: lotName,
          unspscCodes: [],
        };
        
        previewLots[blockId].push(newLot);
        refreshRequisitionLotsPreview(blockId);
      }
      
      window.updatePreviewLotName = function(blockId, lotId, newName) {
        const lots = previewLots[blockId] || [];
        const lot = lots.find(l => l.id === lotId);
        if (lot) {
          lot.name = newName;
        }
      }
      
      window.deletePreviewLot = function(blockId, lotId) {
        if (!confirm('Are you sure you want to delete this lot?')) {
          return;
        }
        
        if (previewLots[blockId]) {
          previewLots[blockId] = previewLots[blockId].filter(l => l.id !== lotId);
          refreshRequisitionLotsPreview(blockId);
        }
      }
      
      window.addProductsToPreviewLot = function(blockId, lotId) {
        const lots = previewLots[blockId] || [];
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        const requisitionLines = previewRequisitionLines[blockId] || [];
        
        let message = `Add products (UNSPSC codes) to "${lot.name}":\n\n`;
        message += `Available from Requisition Lines:\n`;
        requisitionLines.forEach((line, idx) => {
          message += `${idx + 1}. ${line.unspscCode} - ${line.unspscDescription}\n`;
        });
        message += `\nOr enter new codes (format: CODE|DESCRIPTION)\n`;
        message += `Enter selection (e.g., "1,2" or "43211503|Laptop computers"):`;
        
        const input = prompt(message);
        if (!input) return;
        
        const parts = input.split(',').map(s => s.trim());
        parts.forEach(part => {
          const index = parseInt(part) - 1;
          if (index >= 0 && index < requisitionLines.length) {
            const item = requisitionLines[index];
            if (!lot.unspscCodes.some(u => u.code === item.unspscCode)) {
              lot.unspscCodes.push({ code: item.unspscCode, description: item.unspscDescription });
            }
          } else if (part.includes('|')) {
            const [code, description] = part.split('|').map(s => s.trim());
            if (code && !lot.unspscCodes.some(u => u.code === code)) {
              lot.unspscCodes.push({ code, description: description || '' });
            }
          } else if (part.length >= 8) {
            if (!lot.unspscCodes.some(u => u.code === part)) {
              lot.unspscCodes.push({ code: part, description: '' });
            }
          }
        });
        
        refreshRequisitionLotsPreview(blockId);
      }
      
      window.removeProductFromPreviewLot = function(blockId, lotId, index) {
        const lots = previewLots[blockId] || [];
        const lot = lots.find(l => l.id === lotId);
        if (lot && index >= 0 && index < lot.unspscCodes.length) {
          lot.unspscCodes.splice(index, 1);
          refreshRequisitionLotsPreview(blockId);
        }
      }
      
      function refreshRequisitionLotsPreview(blockId) {
        const previewContainer = document.getElementById(`requisition-lots-preview-${blockId}`);
        if (previewContainer) {
          const infoAlert = previewContainer.querySelector('div[style*="background: var(--info-50)"]');
          const newHTML = renderRequisitionLotsPreview(blockId);
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = newHTML;
          const newPreviewContainer = tempDiv.querySelector('.preview-container');
          
          previewContainer.innerHTML = '';
          if (infoAlert) {
            previewContainer.appendChild(infoAlert);
          }
          if (newPreviewContainer) {
            previewContainer.appendChild(newPreviewContainer);
          }
        }
      }
      
      // Apply configuration changes to preview
      window.applyRequisitionLotsConfig = function() {
        if (!selectedElement || selectedBlockType !== 'requisition-lots') {
          return;
        }
        
        const blockId = selectedElement.dataset.blockId;
        if (!blockId) return;
        
        // Update configuration
        blockConfigurations[blockId] = {
          displayRequisitionLines: document.getElementById('config-display-requisition-lines').checked,
          enableLotCreation: document.getElementById('config-enable-lot-creation').checked,
          lotAssignmentRules: document.getElementById('config-lot-assignment-rules').value,
          dataSource: document.getElementById('config-data-source').value,
        };
        
        // Refresh preview
        refreshRequisitionLotsPreview(blockId);
        
        // Show success message
        alert('Configuration applied successfully! Check the preview to see the changes.');
      }
      
      // Bid Response Fields Configuration Functions
      window.editBidResponseField = function(fieldId, sectionLabel) {
        alert(`Edit Configuration for Field: ${fieldId}\n\nSection: ${sectionLabel}\n\nIn a full implementation, this would open a modal to configure:\n- Field label\n- Required/Optional status\n- Default value\n- Validation rules\n- Help text\n- Conditional visibility`);
      }
      
      window.addCustomBidResponseField = function(sectionLabel) {
        const fieldName = prompt(`Add a custom field to: ${sectionLabel}\n\nEnter field name:`);
        if (!fieldName) return;
        
        const fieldType = prompt(`Select field type for "${fieldName}":\n\n1. Text input\n2. Text area\n3. Number input\n4. Dropdown\n5. Currency input\n6. Date\n7. Yes/No radio\n\nEnter number (1-7):`);
        
        const typeMap = {
          '1': 'Text input',
          '2': 'Text area',
          '3': 'Number input',
          '4': 'Dropdown',
          '5': 'Currency input',
          '6': 'Date',
          '7': 'Yes/No radio'
        };
        
        if (typeMap[fieldType]) {
          alert(`Custom field added successfully!\n\nField: ${fieldName}\nType: ${typeMap[fieldType]}\nSection: ${sectionLabel}\n\nIn a full implementation, this field would be added to the template configuration and appear in the list above.`);
        } else {
          alert('Invalid field type selected. Please try again.');
        }
      }
      
      // ===== CUSTOM BLOCK CREATION =====
      
      window.createCustomBlock = function() {
        // Modal HTML for custom block creation
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'custom-block-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        `;
        
        modal.innerHTML = `
          <div style="background: var(--surface-0); border-radius: var(--radius-lg); box-shadow: var(--shadow-modal); max-width: 600px; width: 90%; display: flex; flex-direction: column;">
            <div style="padding: var(--spacing-lg); border-bottom: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: center;">
              <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Create New Custom Block</h3>
              <button class="icon-btn" onclick="closeCustomBlockModal()" style="font-size: 16px;">‚úñ</button>
            </div>
            
            <div style="padding: var(--spacing-xl);">
              <div style="margin-bottom: var(--spacing-lg);">
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">
                  Block Name <span style="color: var(--danger-500);">*</span>
                </label>
                <input type="text" id="custom-block-name" class="input" placeholder="e.g., Quality Assurance, Delivery Terms, etc." style="width: 100%;" />
              </div>
              
              <div style="margin-bottom: var(--spacing-lg);">
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Block Icon</label>
                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: var(--spacing-sm);">
                  ${['üìã', 'üìÑ', 'üìù', 'üìä', 'üìà', '‚úÖ', 'üîç', '‚öôÔ∏è', 'üéØ', 'üíº', 'üè¢', 'üì¶', 'üöö', 'üí∞', 'üìÖ', 'üîí'].map(icon => `
                    <button type="button" class="icon-selector" data-icon="${icon}" onclick="selectCustomBlockIcon('${icon}')" 
                            style="width: 48px; height: 48px; border: 2px solid var(--surface-200); border-radius: var(--radius-sm); 
                                   background: var(--surface-0); font-size: 24px; cursor: pointer; transition: all 0.2s ease;"
                            onmouseover="this.style.borderColor='var(--primary-400)'; this.style.background='var(--primary-50)';"
                            onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='var(--surface-200)'; this.style.background='var(--surface-0)'; }">
                      ${icon}
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="custom-block-icon" value="üìã" />
              </div>
              
              <div style="margin-bottom: var(--spacing-lg);">
                <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Description (for authors)</label>
                <textarea id="custom-block-description" class="textarea" rows="3" placeholder="Brief description of what this block contains..." style="width: 100%;"></textarea>
              </div>
              
              <div style="background: var(--info-50); border: 1px solid var(--info-400); border-radius: var(--radius-sm); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <div style="display: flex; align-items: start; gap: var(--spacing-sm);">
                  <span style="font-size: 18px;">‚ÑπÔ∏è</span>
                  <span style="font-size: 13px; color: var(--text-primary);">
                    After creating the block, you can add sections and fields to it by dragging forms and fields from the component panel.
                  </span>
                </div>
              </div>
            </div>
            
            <div style="padding: var(--spacing-lg); border-top: 1px solid var(--surface-200); display: flex; justify-content: flex-end; gap: var(--spacing-sm);">
              <button class="btn btn-secondary" onclick="closeCustomBlockModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveCustomBlock()">Create Block</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Auto-select first icon
        const firstIcon = modal.querySelector('.icon-selector');
        if (firstIcon) {
          firstIcon.classList.add('selected');
          firstIcon.style.borderColor = 'var(--primary-400)';
          firstIcon.style.background = 'var(--primary-50)';
        }
        
        // Focus on name input
        setTimeout(() => {
          document.getElementById('custom-block-name').focus();
        }, 100);
      }
      
      window.selectCustomBlockIcon = function(icon) {
        // Update hidden input
        document.getElementById('custom-block-icon').value = icon;
        
        // Update visual selection
        document.querySelectorAll('.icon-selector').forEach(btn => {
          btn.classList.remove('selected');
          btn.style.borderColor = 'var(--surface-200)';
          btn.style.background = 'var(--surface-0)';
        });
        
        const selectedBtn = document.querySelector(`.icon-selector[data-icon="${icon}"]`);
        if (selectedBtn) {
          selectedBtn.classList.add('selected');
          selectedBtn.style.borderColor = 'var(--primary-400)';
          selectedBtn.style.background = 'var(--primary-50)';
        }
      }
      
      window.closeCustomBlockModal = function() {
        const modal = document.getElementById('custom-block-modal');
        if (modal) modal.remove();
      }
      
      window.saveCustomBlock = function() {
        const name = document.getElementById('custom-block-name').value.trim();
        const icon = document.getElementById('custom-block-icon').value;
        const description = document.getElementById('custom-block-description').value.trim();
        
        if (!name) {
          alert('Please enter a block name.');
          document.getElementById('custom-block-name').focus();
          return;
        }
        
        // Create block configuration
        const blockConfig = {
          blockId: 'custom-block-' + generateId(),
          blockType: 'custom',
          blockName: name,
          blockIcon: icon,
          blockDescription: description,
          enabled: true,
          position: templateConfig.blocks.length,
          sections: [
            {
              sectionId: 'section-' + generateId(),
              sectionName: 'Main Section',
              enabled: true,
              fields: []
            }
          ]
        };
        
        // Add to template config
        templateConfig.blocks.push(blockConfig);
        
        // Create visual representation
        const section = document.createElement('div');
        section.className = 'dropped-section';
        section.dataset.sectionType = 'custom';
        section.dataset.blockId = blockConfig.blockId;
        
        // Render admin configuration view
        section.innerHTML = renderBlockConfigView(blockConfig);
        
        // Add block to blocks array
        const blockIndex = blocks.length;
        blocks.push({
          name: blockConfig.blockName,
          element: section,
          type: 'custom',
          config: blockConfig
        });
        
        // Add click handler for block selection
        section.addEventListener('click', (e) => {
          if (!e.target.closest('.icon-btn') && !e.target.closest('button') && !e.target.closest('input') && !e.target.closest('select')) {
            selectBlock(section, 'custom', blockIndex);
          }
        });
        
        // Update UI
        activeBlockIndex = blockIndex;
        updateBlockTabs();
        updateCanvasView();
        
        // Close modal
        closeCustomBlockModal();
        
        // Show success message
        showNotification(`Custom block "${name}" created successfully!`, 'success');
      }
      
      window.addSection = function(blockId) {
        const sectionName = prompt('Enter section name:');
        if (!sectionName) return;
        
        const blockConfig = templateConfig.blocks.find(b => b.blockId === blockId);
        
        if (blockConfig) {
          const newSection = {
            sectionId: 'section-' + generateId(),
            sectionName: sectionName,
            enabled: true,
            fields: []
          };
          
          blockConfig.sections.push(newSection);
          templateConfig.modifiedDate = new Date().toISOString();
          updateCanvasView();
          showNotification('Section added successfully', 'success');
        }
      }
    </script>
  </body>
</html>
