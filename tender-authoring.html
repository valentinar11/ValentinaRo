<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNOPS PDJ ¬∑ Create Tender</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/primeicons@6.0.1/primeicons.css" />
    <style>
      :root {
        /* UNOPS Preset Primary Colors - Matching award-review-dashboard */
        --primary-50: #e6f7ff;
        --primary-100: #bae7ff;
        --primary-200: #7dd3fc;
        --primary-300: #38bdf8;
        --primary-400: #0ea5e9;
        --primary-500: #0092D1;
        --primary-600: #0284c7;
        --primary-700: #0369a1;
        --primary-800: #003a56;
        --primary-900: #001d2b;

        /* Surface Colors */
        --surface-0: #ffffff;
        --surface-50: #f5f8fb;
        --surface-100: #ebf1f8;
        --surface-200: #dde8f2;
        --surface-300: #cfdfec;
        --surface-400: #a3a3a3;
        --surface-600: #95a7ba;
        --surface-800: #596170;
        --surface-900: #3b3e4a;

        /* Neutral - for compatibility */
        --neutral-50: #f5f8fb;
        --neutral-100: #ebf1f8;
        --neutral-200: #dde8f2;
        --neutral-300: #cfdfec;
        --neutral-400: #a3a3a3;
        --neutral-500: #95a7ba;
        --neutral-600: #596170;
        --neutral-700: #404040;
        --neutral-800: #3b3e4a;
        --neutral-900: #3b3e4a;

        /* Semantic Colors */
        --success-50: #d2e7cd;
        --success-100: #e8f5e9;
        --success-500: #4c9f38;
        --success-600: #4c9f38;
        --success-700: #388e3c;
        
        --info-50: #bfe4f4;
        --info-100: #e3f2fd;
        --info-400: #0092d1;
        --info-500: #2196f3;
        --info-600: #2563eb;
        --info-700: #1976d2;
        
        --warning-50: #f9d6c3;
        --warning-100: #fff3e0;
        --warning-500: #e85c0e;
        --warning-600: #d97706;
        --warning-700: #f57c00;
        
        --danger-50: #f6cac6;
        --danger-100: #fee2e2;
        --danger-500: #da291c;
        --danger-600: #dc2626;

        --purple-50: #f3e8ff;
        --purple-100: #e9d5ff;
        --purple-500: #9333ea;
        --purple-700: #7c3aed;

        /* Text Colors */
        --text-primary: var(--surface-900);
        --text-secondary: var(--surface-800);
        --text-muted: var(--surface-600);

        /* Spacing Scale */
        --spacing-xs: 6px;
        --spacing-sm: 12px;
        --spacing-md: 20px;
        --spacing-lg: 28px;
        --spacing-xl: 36px;
        --spacing-2xl: 48px;
        --spacing-3xl: 64px;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --radius-xl: 16px;

        /* Shadow System */
        --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);

        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Lato', 'Noto Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--surface-50);
        color: var(--text-primary);
        line-height: 1.5;
        min-height: 100vh;
      }

      /* Header - Matching award-review-dashboard */
      .header {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md) var(--spacing-xl);
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .logo {
        font-weight: 700;
        font-size: 20px;
        letter-spacing: 0.12em;
        color: var(--primary-400);
      }

      .portal-badge {
        background: var(--primary-400);
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .user-info {
        text-align: right;
      }

      .user-company {
        font-size: 12px;
        color: var(--text-muted);
      }

      .user-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-100);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--primary-600);
        cursor: pointer;
      }

      /* Header Actions - Matching tender-dashboard */
      .header-actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-left: auto;
        margin-right: var(--spacing-lg);
      }

      .header-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        font-size: 13px;
      }

      .header-action-btn:hover {
        background: var(--surface-100);
        transform: scale(1.1);
      }

      .header-action-btn i {
        font-size: 20px;
        color: var(--text-muted);
        transition: color 0.2s ease;
      }

      .header-action-btn:hover i {
        color: var(--primary-500);
      }

      .header-action-label {
        display: none;
      }

      .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--danger-500);
        color: white;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .ai-badge {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        font-size: 9px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .ai-icon-wrapper {
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .ai-icon-wrapper i {
        font-size: 14px;
        color: white !important;
      }

      .language-selector {
        gap: 4px;
      }

      .lang-flag {
        font-size: 18px;
      }

      /* Page Action Bar - for buttons moved from header */
      .page-action-bar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) 0;
        margin-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md) var(--spacing-lg);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
      }

      /* Button styles matching award-review-dashboard */
      .page-action-bar .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        text-decoration: none;
      }

      .page-action-bar .btn-secondary {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .page-action-bar .btn-secondary:hover {
        background: var(--surface-200);
        border-color: var(--surface-300);
      }

      .page-action-bar .btn-primary {
        background: var(--primary-500);
        color: white;
      }

      .page-action-bar .btn-primary:hover {
        background: var(--primary-600);
      }

      .page-action-bar .btn i {
        font-size: 14px;
      }

      /* Legacy top-bar classes for backward compatibility */
      .top-bar {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md) var(--spacing-xl);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .top-bar__brand {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .top-bar__breadcrumbs {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 400;
      }

      .top-bar__title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .top-bar__actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      /* Buttons - Matching award-review-dashboard exactly */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        text-decoration: none;
      }

      .btn-ghost {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .btn-ghost:hover {
        background: var(--surface-200);
      }

      .btn-secondary {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .btn-secondary:hover {
        background: var(--surface-200);
      }

      .btn-primary {
        background: var(--primary-500);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-600);
      }

      .btn-primary:disabled {
        background: var(--surface-300);
        border: none;
        color: var(--surface-600);
        cursor: not-allowed;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
      }

      .btn i {
        font-size: 14px;
      }

      /* Layout - App Container */
      .app-container {
        display: flex;
        flex-direction: row;
        min-height: calc(100vh - 65px);
        width: 100%;
      }

      /* Workspace Layout - Legacy support */
      .workspace {
        display: flex;
        min-height: calc(100vh - 65px);
      }

      /* Sidebar - Matching award-review-dashboard */
      .sidebar {
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        background-color: #0192D1;
        color: white;
        display: flex;
        flex-direction: column;
        border-right: none;
        flex-shrink: 0;
      }

      .sidebar-menu {
        flex: 1;
        padding: 20px 0;
      }

      .menu-section {
        margin-bottom: var(--spacing-lg);
      }

      .menu-section-title {
        padding: 0 20px 15px 20px;
        font-size: 20px;
        font-weight: bold;
        text-transform: none;
        letter-spacing: 0;
        color: white;
        font-family: 'Lato', sans-serif;
        margin-bottom: var(--spacing-sm);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: white;
        text-decoration: none;
        font-size: 16px;
        font-weight: normal;
        font-family: 'Lato', sans-serif;
        transition: background-color 0.2s ease;
        border-left: none;
        cursor: pointer;
        margin: 0 10px;
        border-radius: 5px;
      }

      .menu-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .menu-item.active {
        background-color: #006599;
        color: white;
      }

      .menu-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .menu-item.disabled:hover {
        background-color: transparent;
      }

      .menu-icon {
        font-size: 18px;
        width: 20px;
        text-align: center;
        flex-shrink: 0;
      }

      .menu-badge {
        margin-left: auto;
        padding: 2px 8px;
        background: var(--danger-500);
        color: white;
        font-size: 11px;
        font-weight: 600;
        border-radius: 999px;
      }

      /* Left Rail Navigation - Legacy support */
      .rail {
        width: 280px;
        min-width: 280px;
        background-color: #0192D1;
        color: white;
        display: flex;
        flex-direction: column;
        padding: 20px 0;
      }

      .rail button {
        width: 100%;
        padding: 12px 20px;
        border-radius: 0;
        border: none;
        background: transparent;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
        margin: 0 10px;
        border-radius: 5px;
        text-align: left;
      }

      .rail button .rail-label {
        display: block;
        font-size: 16px;
        font-weight: normal;
        white-space: nowrap;
        font-family: 'Lato', sans-serif;
      }

      .rail button.active {
        background: #006599;
        color: #fff;
      }

      .rail button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: var(--spacing-xl);
        overflow-y: auto;
        min-width: 0;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Page Header - Matching award-review-dashboard */
      .page-header {
        margin-bottom: var(--spacing-xl);
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .page-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
      }

      /* Section Title */
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .section-title i {
        color: var(--primary-500);
      }

      /* Card Component - Matching award-review-dashboard */
      .card {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--surface-200);
        box-shadow: var(--shadow-card);
      }

      .card-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .card-body {
        padding: var(--spacing-lg);
      }

      /* Status Badges */
      .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.pending {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .status-badge.review {
        background: var(--info-50);
        color: var(--info-400);
      }

      .status-badge.approved {
        background: var(--success-50);
        color: var(--success-500);
      }

      .status-badge.deliberation {
        background: var(--purple-50);
        color: var(--purple-500);
      }

      .status-badge.returned {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      /* Filter Bar - Matching award-review-dashboard */
      .filter-bar {
        background: white;
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--surface-200);
        margin-bottom: 24px;
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: var(--shadow-card);
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 13px;
        background: white;
        cursor: pointer;
        min-width: 150px;
      }

      .filter-select:focus {
        outline: none;
        border-color: var(--primary-500);
      }

      /* View States */
      .view-section {
        display: none;
        flex: 1;
        flex-direction: column;
        overflow: hidden;
      }

      .view-section.active {
        display: flex;
      }

      /* ===== TENDER INITIATION METHOD SELECTION ===== */
      .initiation-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        padding: var(--spacing-2xl) var(--spacing-xl);
      }

      .initiation-header {
        text-align: center;
        margin-bottom: var(--spacing-2xl);
      }

      .initiation-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .initiation-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
      }

      .initiation-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
      }

      .initiation-card {
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-card);
      }

      .initiation-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .initiation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-500);
        opacity: 0;
        transition: opacity 0.2s;
      }

      .initiation-card:hover::before {
        opacity: 1;
      }

      .initiation-card-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
      }

      .initiation-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .initiation-card-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: var(--spacing-md);
      }

      .initiation-card-features {
        list-style: none;
        padding: 0;
        margin: 0 0 var(--spacing-md) 0;
        text-align: left;
        width: 100%;
      }

      .initiation-card-features li {
        font-size: 13px;
        color: var(--text-secondary);
        padding: var(--spacing-xs) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .initiation-card-features li::before {
        content: '‚úì';
        color: var(--success-500);
        font-weight: 700;
      }

      .initiation-card-badge {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        background: var(--primary-50);
        color: var(--primary-600);
        font-size: 11px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .initiation-card-action {
        margin-top: auto;
        width: 100%;
      }

      .initiation-card-action .btn {
        width: 100%;
      }

      /* ===== TENDER SELECTION MODAL ===== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        max-width: 900px;
        width: 90%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: var(--spacing-xs);
      }

      .modal-close-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: var(--surface-100);
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: var(--text-secondary);
        transition: all 0.2s;
      }

      .modal-close-btn:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .modal-search {
        margin-bottom: var(--spacing-lg);
      }

      .modal-search input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .modal-search input:focus {
        outline: none;
        border-color: var(--primary-400);
      }

      .modal-search::before {
        content: 'üîç';
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
      }

      .modal-search {
        position: relative;
      }

      .existing-tenders-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .existing-tender-card {
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: var(--shadow-card);
      }

      .existing-tender-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateX(4px);
      }

      .existing-tender-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-sm);
      }

      .existing-tender-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .existing-tender-reference {
        font-size: 13px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .existing-tender-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .existing-tender-meta {
        display: flex;
        gap: var(--spacing-md);
        font-size: 13px;
        color: var(--text-secondary);
      }

      .existing-tender-template {
        font-size: 12px;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 4px 12px;
        border-radius: 12px;
        display: inline-block;
        width: fit-content;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .badge-success {
        background: var(--success-50);
        color: var(--success-500);
      }

      .badge-warning {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .badge-info {
        background: var(--info-50);
        color: var(--info-400);
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .loading-content {
        background: var(--surface-0);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        text-align: center;
        box-shadow: var(--shadow-2xl);
      }

      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--neutral-200);
        border-top-color: var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--spacing-lg);
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* ===== EVALUATION CRITERIA ENHANCED STYLES ===== */
      .evaluation-criterion-card {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-base);
      }

      .evaluation-criterion-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-200);
      }

      .criterion-applies-to-section {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .lot-selection-group,
      .product-selection-group {
        margin-bottom: var(--spacing-md);
      }

      .lot-selection-group:last-child,
      .product-selection-group:last-child {
        margin-bottom: 0;
      }

      .selection-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: var(--spacing-sm);
        display: block;
      }

      .criterion-selection-summary {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-radius: var(--radius-sm);
        color: var(--info-700);
      }

      .criterion-selection-summary strong {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
      }

      .criterion-selection-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-xs);
        font-size: 13px;
      }

      .criterion-selection-item::before {
        content: '‚úì';
        color: var(--info-600);
        font-weight: bold;
      }

      /* ===== PROCUREMENT LIFECYCLE TRACKER ===== */
      .lifecycle-tracker-container {
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-top: var(--spacing-md);
      }

      .lifecycle-tracker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .lifecycle-tracker-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .lifecycle-tracker-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .btn-icon {
        padding: 8px 12px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .lifecycle-chain {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        overflow-x: auto;
        padding: var(--spacing-md) 0;
      }

      .lifecycle-node {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 140px;
        position: relative;
      }

      .lifecycle-node-badge {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: var(--neutral-100);
        border: 3px solid var(--neutral-300);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-base);
        cursor: pointer;
      }

      .lifecycle-node.current .lifecycle-node-badge {
        background: var(--primary-50);
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px var(--primary-100);
      }

      .lifecycle-node.completed .lifecycle-node-badge {
        background: var(--success-50);
        border-color: var(--success-500);
      }

      .lifecycle-node.future .lifecycle-node-badge {
        background: var(--surface-50);
        border-color: var(--neutral-200);
        opacity: 0.6;
      }

      .lifecycle-node-badge:hover {
        transform: scale(1.05);
      }

      .lifecycle-node-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: center;
        margin-bottom: var(--spacing-xs);
      }

      .lifecycle-node-id {
        font-size: 11px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .lifecycle-arrow {
        font-size: 20px;
        color: var(--neutral-300);
        margin: 0 var(--spacing-xs);
      }

      .lifecycle-arrow.active {
        color: var(--primary-400);
      }

      .linked-processes-list {
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
      }

      .linked-process-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-base);
      }

      .linked-process-item:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-sm);
      }

      .linked-process-item:last-child {
        margin-bottom: 0;
      }

      .linked-process-info {
        flex: 1;
      }

      .linked-process-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .linked-process-meta {
        display: flex;
        gap: var(--spacing-lg);
        font-size: 12px;
        color: var(--text-muted);
      }

      .linked-process-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .btn-link-action {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--neutral-200);
        background: var(--surface-0);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .btn-link-action:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-600);
      }

      .btn-link-action.remove:hover {
        background: var(--danger-50);
        border-color: var(--danger-400);
        color: var(--danger-600);
      }

      .lifecycle-relationship-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .relationship-predecessor {
        background: var(--info-100);
        color: var(--info-600);
      }

      .relationship-successor {
        background: var(--success-100);
        color: var(--success-600);
      }

      .relationship-related {
        background: var(--warning-100);
        color: var(--warning-600);
      }

      .lifecycle-empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-muted);
      }

      .lifecycle-empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .lifecycle-search-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      }

      .lifecycle-search-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 700px;
        width: 90%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .lifecycle-search-header {
        padding: var(--spacing-xl);
        border-bottom: 1px solid var(--neutral-200);
      }

      .lifecycle-search-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-xl);
      }

      .lifecycle-search-input-wrapper {
        position: relative;
        margin-bottom: var(--spacing-lg);
      }

      .lifecycle-search-input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
      }

      .lifecycle-search-input:focus {
        outline: none;
        border-color: var(--primary-500);
      }

      .lifecycle-search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
      }

      .lifecycle-search-results {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .lifecycle-search-result {
        padding: var(--spacing-md);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .lifecycle-search-result:hover {
        border-color: var(--primary-500);
        background: var(--primary-50);
      }

      .lifecycle-search-result-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .lifecycle-search-result-meta {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        gap: var(--spacing-md);
      }

      .lifecycle-audit-trail {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--neutral-200);
      }

      .lifecycle-audit-trail-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .lifecycle-audit-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .lifecycle-audit-item::before {
        content: '‚Ä¢';
        color: var(--primary-500);
        font-weight: bold;
      }

      .lifecycle-audit-timestamp {
        color: var(--text-muted);
        margin-left: auto;
      }

      /* ===== EVENT SETUP WIZARD STYLES ===== */
      .wizard-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
        padding: var(--spacing-xl);
      }

      .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-2xl);
        position: relative;
      }

      .wizard-steps::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--surface-200);
        z-index: 0;
      }

      .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
      }

      .wizard-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        right: -50%;
        height: 2px;
        background: var(--surface-200);
        z-index: -1;
      }

      .wizard-step:first-child::before {
        left: 50%;
      }

      .wizard-step:last-child::before {
        display: none;
      }

      .wizard-step.completed::before {
        background: var(--success-500);
      }

      .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--surface-0);
        border: 2px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
        transition: all 0.2s ease;
      }

      .wizard-step.active .step-circle {
        background: var(--primary-500);
        border-color: var(--primary-500);
        color: white;
      }

      .wizard-step.completed .step-circle {
        background: var(--success-500);
        border-color: var(--success-500);
        color: white;
      }

      .wizard-step.completed .step-circle::after {
        content: '‚úì';
      }

      .step-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-align: center;
        font-weight: 500;
      }

      .wizard-step.active .step-label {
        color: var(--primary-500);
        font-weight: 600;
      }

      .wizard-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
        min-height: 500px;
      }

      .wizard-step-content {
        display: none;
      }

      .wizard-step-content.active {
        display: block;
      }

      .step-title {
        font-size: 22px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .step-description {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-lg);
      }

      /* ===== TENDER AUTHORING STYLES ===== */
      .progress-container {
        background: white;
        border-bottom: 1px solid var(--surface-200);
        padding: var(--spacing-md) var(--spacing-lg);
      }

      .progress-steps {
        display: flex;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
        gap: var(--spacing-sm);
      }

      .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        cursor: pointer;
      }

      .progress-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: -50%;
        right: 50%;
        height: 2px;
        background: var(--surface-200);
        z-index: 0;
      }

      .progress-step:first-child::before {
        display: none;
      }

      .progress-step.completed::before {
        background: var(--success-500);
      }

      .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--surface-0);
        border: 2px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        z-index: 1;
        margin-bottom: var(--spacing-xs);
      }

      .progress-step.completed .step-icon {
        background: var(--success-500);
        color: white;
        border-color: var(--success-500);
      }

      .progress-step.active .step-icon {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
      }

      .step-label {
        font-size: 11px;
        text-align: center;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .progress-step.active .step-label {
        color: var(--primary-400);
        font-weight: 600;
      }

      .block-nav {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        padding: 0 var(--spacing-xl);
        display: flex;
        gap: 0;
        overflow-x: auto;
        flex-wrap: nowrap;
        position: relative;
      }

      /* Connector line between tabs - hidden for cleaner look */
      .block-nav::before {
        display: none;
      }

      .block-tab {
        padding: 16px 20px;
        border: none;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        background: transparent;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1;
        box-shadow: none;
        min-width: fit-content;
      }

      .block-tab:hover {
        color: var(--primary-600);
        background: var(--surface-50);
        border-color: transparent;
        transform: none;
        box-shadow: none;
        border-bottom-color: var(--primary-200);
      }

      .block-tab.active {
        color: var(--primary-600);
        background: var(--primary-50);
        border-color: transparent;
        border-bottom: 3px solid var(--primary-500);
        font-weight: 600;
        box-shadow: none;
        transform: none;
      }

      .block-tab.active:hover {
        background: var(--primary-100);
        transform: none;
      }

      /* Completed state for tabs */
      .block-tab.completed {
        border-bottom-color: var(--success-400);
        background: transparent;
      }

      .block-tab.completed:hover {
        background: var(--success-50);
      }

      .block-tab.completed::after {
        display: none;
      }

      .block-tab-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--surface-100);
        border: 2px solid var(--surface-200);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .block-tab:hover .block-tab-number {
        background: var(--primary-50);
        border-color: var(--primary-200);
        color: var(--primary-600);
      }

      .block-tab.active .block-tab-number {
        background: var(--primary-500);
        border-color: var(--primary-500);
        color: white;
      }

      .block-tab.completed .block-tab-number {
        background: var(--success-500);
        border-color: var(--success-500);
        color: white;
      }

      .block-tab-pi-icon {
        font-size: 15px;
        color: var(--text-muted);
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .block-tab:hover .block-tab-pi-icon {
        color: var(--primary-500);
      }

      .block-tab.active .block-tab-pi-icon {
        color: var(--primary-600);
      }

      .block-tab.completed .block-tab-pi-icon {
        color: var(--success-500);
      }

      .block-tab-icon {
        font-size: 16px;
        font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
        display: none;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: var(--surface-100);
        border-radius: var(--radius-md);
        transition: all 0.25s ease;
      }

      .block-tab:hover .block-tab-icon {
        background: var(--primary-100);
      }

      .block-tab.active .block-tab-icon {
        background: rgba(255, 255, 255, 0.2);
      }

      .block-tab-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }

      .block-tab-name {
        font-size: 13px;
        font-weight: 500;
        line-height: 1.3;
        color: inherit;
      }

      .block-tab.active .block-tab-name {
        font-weight: 600;
      }

      .block-tab-status {
        font-size: 11px;
        font-weight: 500;
        text-transform: none;
        letter-spacing: 0;
        padding: 0;
        border-radius: 0;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: transparent;
      }

      .block-tab-status.status-pending {
        background: transparent;
        color: var(--text-muted);
      }

      .block-tab-status.status-in-progress {
        background: transparent;
        color: var(--info-500);
      }

      .block-tab-status.status-complete {
        background: transparent;
        color: var(--success-600);
      }

      .block-tab:hover .block-tab-status.status-pending {
        background: transparent;
        color: var(--primary-500);
      }

      .block-tab.active .block-tab-status {
        background: transparent;
        color: var(--primary-500);
      }

      .block-tab.completed .block-tab-status.status-complete {
        background: transparent;
        color: var(--success-600);
      }

      .block-tab-badge {
        display: none;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        padding: 0 6px;
        border-radius: 11px;
        background: var(--surface-100);
        color: var(--text-muted);
        font-size: 11px;
        font-weight: 700;
        transition: all 0.25s ease;
        border: 1px solid var(--surface-200);
      }

      .block-tab:hover .block-tab-badge {
        background: var(--primary-100);
        color: var(--primary-600);
        border-color: var(--primary-200);
      }

      .block-tab.active .block-tab-badge {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
      }

      /* Progress indicator - hidden for cleaner look */
      .block-tab-progress {
        display: none;
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--surface-200);
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        overflow: hidden;
      }

      .block-tab-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--success-500), var(--success-400));
        transition: width 0.4s ease;
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      }

      .block-tab.active .block-tab-progress {
        background: rgba(255, 255, 255, 0.2);
      }

      .block-tab.active .block-tab-progress-bar {
        background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
      }

      .content-area {
        flex: 1;
        display: flex;
        gap: var(--spacing-md);
        overflow: hidden;
        padding: var(--spacing-lg);
      }

      .content-wrapper {
        flex: 1;
        width: 100%;
        max-width: none;
        overflow-y: auto;
        padding-right: 80px; /* Space for floating button */
      }

      /* ===== SUBMISSION FORMS CARDS ===== */
      .submission-forms-drop-zone {
        position: relative;
        min-height: 200px;
        padding: var(--spacing-md);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        background: var(--surface-0);
        transition: all 0.3s ease;
      }

      .submission-forms-drop-zone.drag-over {
        border-color: var(--primary-300);
        border-style: dashed;
        background: var(--surface-50);
      }

      .submission-forms-drop-hint {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--surface-0);
        color: var(--primary-600);
        border: 1px solid var(--primary-200);
        border-radius: var(--radius-lg);
        font-size: 13px;
        font-weight: 500;
        gap: var(--spacing-sm);
        align-items: center;
        box-shadow: var(--shadow-md);
        z-index: 10;
      }

      .submission-forms-drop-zone.drag-over .submission-forms-drop-hint {
        display: flex;
      }

      .submission-forms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: var(--spacing-sm);
      }

      .submission-form-card {
        position: relative;
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        cursor: grab;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        min-height: 160px;
      }

      .submission-form-card:hover {
        border-color: var(--primary-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .submission-form-card.added {
        border-color: var(--surface-200);
        background: var(--surface-0);
      }

      .submission-form-card.added:hover {
        border-color: var(--primary-300);
        background: var(--surface-50);
      }

      .submission-form-card.not-added {
        opacity: 0.7;
        background: var(--surface-50);
        border-style: dashed;
        border-color: var(--surface-300);
      }

      .submission-form-card.not-added:hover {
        opacity: 1;
        border-color: var(--primary-300);
        background: var(--surface-0);
        border-style: solid;
      }

      .submission-form-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-bottom: var(--spacing-sm);
      }

      .submission-form-code {
        min-width: 28px;
        height: 28px;
        padding: 0 8px;
        background: var(--surface-100);
        color: var(--text-secondary);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        border: 1px solid var(--surface-200);
      }

      .submission-form-card.added .submission-form-code {
        background: var(--primary-50);
        color: var(--primary-600);
        border-color: var(--primary-200);
      }

      .submission-form-card.not-added .submission-form-code {
        background: var(--surface-100);
        color: var(--text-muted);
        border-color: var(--surface-200);
      }

      .submission-form-actions {
        display: flex;
        gap: 4px;
      }

      .btn-icon-xs {
        min-width: 26px;
        height: 26px;
        padding: 0 8px;
        border: 1px solid var(--surface-200);
        background: var(--surface-100);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 500;
        transition: all 0.2s ease;
        color: var(--text-primary);
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
      }

      .btn-icon-xs:hover {
        background: var(--surface-200);
        border-color: var(--surface-300);
      }

      .btn-icon-xs.danger {
        background: var(--surface-100);
        border-color: var(--surface-200);
        color: var(--text-secondary);
      }

      .btn-icon-xs.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-200);
        color: var(--danger-600);
      }

      .btn-icon-xs.success {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
      }

      .btn-icon-xs.success:hover {
        background: var(--primary-600);
        border-color: var(--primary-600);
      }
      
      .btn-icon-xs.preview {
        background: var(--surface-100);
        border-color: var(--surface-200);
        color: var(--text-secondary);
      }

      .btn-icon-xs.preview:hover {
        background: var(--info-50);
        border-color: var(--info-200);
        color: var(--info-600);
      }

      .submission-form-icon {
        font-size: 32px;
        margin-bottom: var(--spacing-sm);
      }

      .submission-form-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
        line-height: 1.3;
      }

      .submission-form-description {
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.4;
      }

      .submission-form-required-badge {
        position: absolute;
        top: -1px;
        right: -1px;
        font-size: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 3px 8px;
        background: var(--surface-100);
        color: var(--text-muted);
        border-radius: 0 var(--radius-lg) 0 var(--radius-md);
        border-left: 1px solid var(--surface-200);
        border-bottom: 1px solid var(--surface-200);
        display: none;
      }

      .submission-form-card.required .submission-form-required-badge {
        display: block;
      }

      .submission-form-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .submission-form-overlay span {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted);
        background: var(--surface-0);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .submission-form-card.not-added:hover .submission-form-overlay {
        opacity: 0;
      }

      /* ===== BID RESPONSE CATEGORIES ===== */
      .bid-response-category {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-left: 4px solid var(--primary-400);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-sm);
      }

      .bid-response-category:last-child {
        margin-bottom: 0;
      }

      .bid-response-category-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
      }

      .bid-response-category-header h4 {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        min-width: 120px;
      }

      .bid-response-category-hint {
        font-size: 12px;
        color: var(--text-muted);
        flex: 1;
      }

      .bid-response-fields {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .bid-response-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
      }

      .bid-response-field:hover {
        background: var(--surface-100);
        border-color: var(--surface-300);
      }

      .bid-response-field-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .bid-response-field-info strong {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .bid-response-field-info span {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* General Information - Improved Layout */
      .general-info-container {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        border: 1px solid var(--surface-200);
        box-shadow: var(--shadow-card);
        overflow: hidden;
      }

      .general-info-header {
        padding: var(--spacing-lg) var(--spacing-xl);
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-50) 100%);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .general-info-header-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .general-info-header-title h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
      }

      .general-info-header-title .subtitle {
        font-size: 13px;
        color: var(--text-muted);
      }

      .general-info-body {
        padding: var(--spacing-xl);
      }

      /* Field Groups for General Information */
      .field-group {
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-xl);
        border-bottom: 1px solid var(--surface-200);
      }

      .field-group:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .field-group-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--primary-400);
        display: inline-block;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
      }

      /* 3-column grid for General Information */
      .form-grid-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
      }

      .form-grid-3col .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-grid-3col .form-group.two-col {
        grid-column: span 2;
      }

      @media (max-width: 1200px) {
        .form-grid-3col {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .form-grid-3col {
          grid-template-columns: 1fr;
        }
        .form-grid-3col .form-group.two-col {
          grid-column: 1;
        }
      }

      /* Inline form group for related fields */
      .inline-form-group {
        display: flex;
        gap: var(--spacing-md);
        align-items: flex-start;
      }

      .inline-form-group .form-group {
        flex: 1;
      }

      /* Info Card within forms */
      .form-info-card {
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-left: 4px solid var(--info-500);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
      }

      .form-info-card p {
        margin: 0;
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .form-info-card strong {
        color: var(--text-primary);
      }

      /* Form Library Panel - EXACT match with Team Board from tender-dashboard */
      .form-library-floating-btn {
        position: fixed;
        right: 0;
        top: 35%;
        transform: translateY(-50%);
        width: 60px;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        padding: 12px 8px;
        cursor: pointer;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        border: 2px solid #4db8e8;
        border-right: none;
      }

      .form-library-floating-btn:hover {
        width: 70px;
        box-shadow: 0 8px 30px rgba(0, 146, 209, 0.4);
      }

      .form-library-floating-btn:focus {
        outline: 3px solid var(--warning-400);
        outline-offset: 2px;
      }

      .form-library-btn-icon {
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .form-library-btn-icon i {
        font-size: 18px;
        color: var(--primary-500);
      }

      .form-library-btn-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--danger-500);
        color: white;
        font-size: 9px;
        font-weight: 700;
        min-width: 16px;
        height: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
      }

      .form-library-btn-label {
        font-size: 9px;
        color: white;
        text-align: center;
        font-weight: 600;
        line-height: 1.2;
      }

      .form-library-panel {
        position: fixed;
        top: 0;
        right: -420px;
        bottom: 0;
        width: 400px;
        background: var(--surface-0);
        box-shadow: var(--shadow-lg);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
      }

      .form-library-panel.open {
        right: 0;
      }

      .form-library-panel.collapsed {
        right: -420px;
      }

      .form-library-header {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: white;
        padding: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .form-library-header-content {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .form-library-header-icon {
        width: 36px;
        height: 36px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .form-library-header-icon i {
        color: white;
        font-size: 16px;
      }

      .form-library-header-text {
        display: flex;
        flex-direction: column;
      }

      .form-library-title {
        font-size: 14px;
        font-weight: 600;
        color: white;
      }

      .form-library-subtitle {
        font-size: 11px;
        color: rgba(255,255,255,0.8);
      }

      .toggle-library-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
      }

      .toggle-library-btn i {
        color: rgba(255,255,255,0.8);
        font-size: 16px;
      }

      .toggle-library-btn:hover i {
        color: white;
      }

      /* Form Library Panel Top Accent */
      .form-library-panel::before {
        content: '';
        display: block;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
      }

      .form-library-body {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .form-library-search-area {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .form-library-search {
        position: relative;
      }

      .form-library-search input {
        width: 100%;
        border-radius: var(--radius-md);
        border: 1px solid var(--surface-300);
        padding: 10px 12px 10px 40px;
        font-family: 'Lato', 'Noto Sans', sans-serif;
        font-size: 13px;
        background: white;
        color: var(--text-primary);
        transition: all 0.2s ease;
      }

      .form-library-search input::placeholder {
        color: var(--text-muted);
      }

      .form-library-search input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .form-library-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 14px;
        pointer-events: none;
      }

      .form-library-content {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
      }

      .form-library-group {
        margin-bottom: var(--spacing-lg);
      }

      .form-library-group-label {
        font-size: 11px;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
        display: block;
      }

      .form-library-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .form-library-item {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        cursor: grab;
        transition: all 0.2s ease;
        background: var(--surface-0);
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .form-library-item:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .form-library-item:active {
        cursor: grabbing;
      }

      .form-library-item-icon {
        width: 32px;
        height: 32px;
        background: var(--surface-100);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
      }

      .form-library-item-content {
        flex: 1;
        min-width: 0;
      }

      .form-library-item strong {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .form-library-item span {
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.3;
      }

      .form-library-item-action {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .form-library-item:hover .form-library-item-action {
        opacity: 1;
      }

      /* Form Library Footer */
      .form-library-footer {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-top: 1px solid var(--surface-200);
      }

      .form-library-footer-hint {
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      /* Added Forms Display */
      .added-forms-section {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
      }

      .added-form-item {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .added-form-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .added-form-icon {
        font-size: 20px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
      }

      .added-form-details {
        flex: 1;
      }

      .added-form-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .added-form-type {
        font-size: 12px;
        color: var(--text-muted);
      }

      .added-form-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .form-action-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .form-action-btn:hover {
        background: var(--primary-50);
        border-color: var(--primary-500);
        color: var(--primary-500);
      }

      .form-action-btn.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-500);
        color: var(--danger-500);
      }

      /* Drop Zone in Sections */
      .form-drop-zone {
        min-height: 80px;
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        margin: var(--spacing-md) 0;
        transition: all 0.2s ease;
        background: var(--surface-50);
        font-size: 13px;
      }

      .form-drop-zone.active {
        border-color: var(--success-500);
        background: var(--success-50);
        color: var(--success-500);
      }

      /* Floating Toggle Button - Hidden by default, shown when panel is collapsed */
      .floating-library-toggle {
        display: none;
      }

      /* Scrollbar for form library */
      .form-library-body::-webkit-scrollbar,
      .form-library-list::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .form-library-body::-webkit-scrollbar-track,
      .form-library-list::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .form-library-body::-webkit-scrollbar-thumb,
      .form-library-list::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .form-library-body::-webkit-scrollbar-thumb:hover,
      .form-library-list::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      /* Common Form Styles - Matching tender-dashboard-complete */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .required {
        color: var(--danger-500);
      }

      .form-input,
      .form-select,
      .form-textarea {
        padding: 10px 14px;
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        background: white;
        color: var(--text-primary);
        transition: all 0.2s ease;
        width: 100%;
      }

      .form-input::placeholder,
      .form-select::placeholder,
      .form-textarea::placeholder {
        color: var(--text-muted);
        font-weight: 400;
      }

      .form-input:hover,
      .form-select:hover,
      .form-textarea:hover {
        border-color: var(--surface-400);
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .form-input:disabled,
      .form-select:disabled,
      .form-textarea:disabled {
        background: var(--surface-100);
        color: var(--text-muted);
        cursor: not-allowed;
      }

      .form-input[readonly] {
        background: var(--surface-50);
        color: var(--text-secondary);
      }

      .form-textarea {
        resize: vertical;
        min-height: 120px;
        line-height: 1.5;
      }

      .form-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
      }

      /* Form Helper Text */
      .form-helper {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
        line-height: 1.4;
      }

      .form-helper.error {
        color: var(--danger-500);
      }

      .form-helper.success {
        color: var(--success-500);
      }

      /* Input with Icon */
      .input-with-icon {
        position: relative;
      }

      .input-with-icon .form-input {
        padding-left: 40px;
      }

      .input-with-icon .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 16px;
      }

      /* Checkbox and Radio Styles */
      .form-checkbox,
      .form-radio {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
      }

      .form-checkbox input,
      .form-radio input {
        accent-color: var(--primary-500);
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      /* Checkbox Group */
      .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .checkbox-group.horizontal {
        flex-direction: row;
        flex-wrap: wrap;
        gap: var(--spacing-md);
      }

      /* Rich Text Editor */
      .rich-text-editor-container {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        overflow: hidden;
        background: var(--surface-0);
      }

      .rich-text-toolbar {
        display: flex;
        gap: 4px;
        padding: 8px;
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
        flex-wrap: wrap;
      }

      .toolbar-btn {
        padding: 6px 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      .toolbar-btn:hover {
        background: var(--surface-100);
        border-color: var(--primary-400);
      }

      .toolbar-btn:active {
        background: var(--primary-100);
      }

      .toolbar-divider {
        width: 1px;
        background: var(--surface-200);
        margin: 0 4px;
      }

      .rich-text-editor {
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
        padding: 16px;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-primary);
        outline: none;
      }

      .rich-text-editor:focus {
        box-shadow: inset 0 0 0 2px var(--primary-50);
      }

      .rich-text-editor[contenteditable]:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
        pointer-events: none;
        display: block;
      }

      .rich-text-editor h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 16px 0 8px 0;
        color: var(--text-primary);
      }

      .rich-text-editor h4 {
        font-size: 16px;
        font-weight: 600;
        margin: 12px 0 6px 0;
        color: var(--text-primary);
      }

      .rich-text-editor p {
        margin: 8px 0;
      }

      .rich-text-editor ul,
      .rich-text-editor ol {
        margin: 8px 0;
        padding-left: 24px;
      }

      .rich-text-editor li {
        margin: 4px 0;
      }

      .rich-text-editor strong {
        font-weight: 600;
      }

      .rich-text-editor em {
        font-style: italic;
      }

      .rich-text-editor u {
        text-decoration: underline;
      }

      .rich-text-editor s,
      .rich-text-editor strike {
        text-decoration: line-through;
      }

      .rich-text-editor blockquote {
        border-left: 4px solid var(--primary-500);
        padding-left: 16px;
        margin: 12px 0;
        color: var(--text-secondary);
        font-style: italic;
      }

      .rich-text-editor a {
        color: var(--primary-500);
        text-decoration: underline;
      }

      .rich-text-editor a:hover {
        color: var(--primary-700);
      }

      .rich-text-editor hr {
        border: none;
        border-top: 2px solid var(--surface-200);
        margin: 16px 0;
      }

      .toolbar-btn.active {
        background: var(--primary-100);
        border-color: var(--primary-500);
        color: var(--primary-600);
      }

      .toolbar-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .editor-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--surface-50);
        border-top: 1px solid var(--surface-200);
        font-size: 12px;
        color: var(--text-muted);
      }

      .editor-word-count {
        display: flex;
        gap: 16px;
      }

      .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
      }

      /* Form Sections - Matching award-review-dashboard */
      .form-section {
        background: white;
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
        transition: all 0.2s;
      }

      .form-section:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-400);
      }

      /* Collapsible functionality removed - all sections are always visible */
      /* .form-section.collapsed .section-body {
        display: none;
      } */

      .section-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-50);
      }

      .form-section .section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .section-icon {
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--primary-50);
        border-radius: var(--radius-md);
      }

      /* .collapse-icon {
        font-size: 12px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
        margin-left: var(--spacing-sm);
      } */

      /* .form-section.collapsed .collapse-icon {
        transform: rotate(-90deg);
      } */

      .status-indicator {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid transparent;
        transition: all var(--transition-fast);
      }

      .status-complete {
        background: var(--success-50);
        color: var(--success-600);
        border-color: var(--success-100);
      }

      .status-incomplete {
        background: var(--warning-50);
        color: var(--warning-600);
        border-color: var(--warning-100);
      }

      .section-body {
        padding: var(--spacing-lg);
      }

      /* Template Cards */
      .template-suggestions {
        margin-top: var(--spacing-xl);
      }

      .suggestions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-lg);
      }

      .suggestions-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .suggestions-badge {
        padding: 4px 10px;
        background: var(--info-50);
        color: var(--info-400);
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }

      .template-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
      }

      .template-card {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        box-shadow: var(--shadow-card);
      }

      .template-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .template-card.selected {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .template-card.recommended {
        border-color: var(--success-500);
        position: relative;
      }

      .template-card.recommended::before {
        content: '‚≠ê Recommended';
        position: absolute;
        top: -12px;
        left: var(--spacing-sm);
        background: var(--success-500);
        color: white;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }

      .template-card-header {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }

      .template-icon {
        font-size: 32px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
        flex-shrink: 0;
      }

      .template-info {
        flex: 1;
      }

      .template-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .template-type {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .template-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-top: var(--spacing-sm);
      }

      .template-meta {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        font-size: 12px;
        color: var(--text-muted);
      }

      .template-meta-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .view-all-link {
        text-align: center;
        margin-top: var(--spacing-md);
      }

      .view-all-link a {
        color: var(--primary-500);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .view-all-link a:hover {
        text-decoration: underline;
      }

      /* Lifecycle Tracker - Compact Version */
      .lifecycle-tracker-compact {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .lifecycle-tracker-compact-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lifecycle-tracker-compact-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lifecycle-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background: var(--primary-100);
        color: var(--primary-600);
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }

      .lifecycle-empty-compact {
        padding: var(--spacing-md);
        text-align: center;
      }

      .lifecycle-linked-list-compact {
        display: flex;
        flex-direction: column;
      }

      .lifecycle-linked-item-compact {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border-bottom: 1px solid var(--surface-100);
        transition: background 0.2s;
      }

      .lifecycle-linked-item-compact:last-child {
        border-bottom: none;
      }

      .lifecycle-linked-item-compact:hover {
        background: var(--surface-50);
      }

      .lifecycle-type-indicator {
        width: 4px;
        height: 32px;
        border-radius: 2px;
        flex-shrink: 0;
      }

      .lifecycle-linked-info {
        flex: 1;
        min-width: 0;
      }

      .lifecycle-linked-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lifecycle-linked-subtitle {
        font-size: 11px;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lifecycle-relation-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        background: var(--surface-100);
        color: var(--text-secondary);
        border-radius: 10px;
        white-space: nowrap;
      }

      .lifecycle-remove-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
      }

      .lifecycle-linked-item-compact:hover .lifecycle-remove-btn {
        opacity: 1;
      }

      .lifecycle-remove-btn:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lifecycle-remove-btn i {
        font-size: 12px;
      }

      /* Alerts - Matching award-review-dashboard */
      .info-alert {
        padding: var(--spacing-md);
        background: var(--info-50);
        border-left: 4px solid var(--info-400);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
      }

      .info-alert-text {
        font-size: 14px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .info-alert-text strong {
        color: var(--text-primary);
      }

      /* Action Footer */
      .action-footer {
        background: white;
        border-top: 1px solid var(--surface-200);
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .footer-info {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .footer-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      /* Tabs - Matching award-review-dashboard */
      .tabs {
        display: flex;
        gap: var(--spacing-xs);
        border-bottom: 2px solid var(--surface-200);
        margin-bottom: var(--spacing-lg);
      }

      .tab {
        padding: var(--spacing-sm) var(--spacing-lg);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }

      .tab:hover {
        color: var(--primary-500);
      }

      .tab.active {
        color: var(--primary-500);
        border-bottom-color: var(--primary-500);
      }

      /* Data Table - Matching award-review-dashboard */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
        padding: var(--spacing-sm) var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--surface-200);
      }

      .data-table th {
        background: var(--surface-50);
        font-weight: 600;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .data-table tr:hover td {
        background: var(--surface-50);
      }

      /* Scrollbar Styling */
      .content-area::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .content-area::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .content-area::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .content-area::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      /* Block Nav Scrollbar - More subtle */
      .block-nav::-webkit-scrollbar {
        height: 4px;
      }

      .block-nav::-webkit-scrollbar-track {
        background: transparent;
      }

      .block-nav::-webkit-scrollbar-thumb {
        background: var(--primary-200);
        border-radius: 2px;
      }

      .block-nav::-webkit-scrollbar-thumb:hover {
        background: var(--primary-400);
      }

      .hidden {
        display: none;
      }

      /* Requisition & Lots Styles */
      .requisition-section,
      .lots-section,
      .structure-summary {
        margin-bottom: var(--spacing-2xl);
      }

      .section-subheader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .section-subheader h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .badge {
        padding: 4px 12px;
        background: var(--primary-50);
        color: var(--primary-500);
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      /* Requisition Table */
      .requisition-table-container {
        overflow-x: auto;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
      }

      .requisition-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface-0);
      }

      .requisition-table thead {
        background: var(--surface-50);
        border-bottom: 2px solid var(--surface-200);
      }

      .requisition-table th {
        padding: var(--spacing-md);
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .requisition-table td {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        font-size: 14px;
      }

      .requisition-table tbody tr:hover {
        background: var(--surface-50);
      }

      .unspsc-code {
        font-weight: 600;
        color: var(--primary-500);
        font-family: 'Courier New', monospace;
      }

      .unspsc-desc {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .status-badge.assigned {
        background: var(--success-50);
        color: var(--success-500);
      }

      .status-badge.unassigned {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .match-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: var(--success-50);
        color: var(--success-500);
      }

      .match-badge.new {
        background: var(--info-50);
        color: var(--info-400);
      }

      .quantity-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: var(--primary-50);
        color: var(--primary-600);
      }

      /* Lots */
      .lots-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      .lot-card {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        overflow: hidden;
      }

      .lot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lot-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .lot-number {
        padding: 4px 10px;
        background: var(--primary-400);
        color: white;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 600;
      }

      .lot-name-input {
        flex: 1;
        padding: 6px 12px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 600;
        font-family: inherit;
        background: var(--surface-0);
        color: var(--text-primary);
        min-width: 200px;
      }

      .lot-name-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .lot-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .btn-icon {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .btn-icon:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
      }

      .btn-icon.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-500);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        height: auto;
      }

      .lot-body {
        padding: var(--spacing-lg);
      }

      .lot-lines-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lot-lines-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .lot-line-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .lot-line-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-400);
        min-width: 100px;
      }

      .lot-line-desc {
        flex: 1;
        font-size: 14px;
        color: var(--text-primary);
      }

      .lot-line-qty {
        font-size: 13px;
        color: var(--text-secondary);
        min-width: 80px;
      }

      .btn-icon-sm {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-muted);
        transition: all 0.2s ease;
        border-radius: var(--radius-sm);
      }

      .btn-icon-sm:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-empty {
        padding: var(--spacing-lg);
        text-align: center;
        color: var(--text-muted);
        font-size: 14px;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      /* Empty State */
      .empty-state {
        padding: var(--spacing-2xl);
        text-align: center;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
      }

      .empty-state-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .empty-state-hint {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-lg);
      }

      /* Product Requirements & Specifications Styles */
      .product-requirements-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-2xl);
      }

      .product-requirement-card {
        background: var(--surface-white);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .product-requirement-header {
        background: var(--surface-50);
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--surface-300);
      }

      .product-requirement-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex-wrap: wrap;
      }

      .unspsc-code-large {
        font-family: 'Courier New', monospace;
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 4px 12px;
        border-radius: var(--radius-sm);
      }

      .unspsc-description-large {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }

      .product-requirement-body {
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-2xl);
      }

      .requirement-section,
      .supplier-section {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .requirement-section {
        border: 2px solid var(--primary-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        background: var(--primary-25);
      }

      .supplier-section {
        border: 2px solid var(--teal-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        background: var(--teal-25);
      }

      .requirement-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .requirement-section-header h4 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .requirement-empty {
        text-align: center;
        padding: var(--spacing-xl);
        background: var(--surface-white);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      .requirement-empty p {
        margin: 0 0 var(--spacing-md) 0;
        color: var(--text-muted);
        font-size: 14px;
      }

      .requirement-empty .or-text {
        display: block;
        margin: var(--spacing-sm) 0;
        color: var(--text-muted);
        font-size: 12px;
      }

      .requirement-attributes-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .requirement-attribute-item {
        background: var(--surface-white);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
      }

      .supplier-field {
        background: var(--teal-50);
        border-color: var(--teal-200);
      }

      .attribute-row {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
      }

      .attribute-name {
        flex: 1;
        min-width: 0;
      }

      .attribute-value {
        flex: 1.5;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .attribute-name-input,
      .attribute-value-input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-sm);
        font-size: 14px;
        color: var(--text-primary);
        background: var(--surface-white);
      }

      .attribute-name-input {
        font-weight: 600;
      }

      .attribute-name-input:focus,
      .attribute-value-input:focus {
        outline: none;
        border-color: var(--primary-500);
      }

      .field-hint {
        font-size: 11px;
        color: var(--text-muted);
        font-style: italic;
      }

      .btn-icon-sm {
        width: 28px;
        height: 28px;
        padding: 0;
        border: 1px solid var(--surface-300);
        background: var(--surface-white);
        color: var(--text-muted);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .btn-icon-sm:hover {
        background: var(--danger-50);
        border-color: var(--danger-300);
        color: var(--danger-600);
      }

      .requirement-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
      }

      /* Structure Summary */
      .summary-card {
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: var(--spacing-lg);
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--surface-200);
      }

      .summary-item:last-child {
        border-bottom: none;
      }

      .summary-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .summary-value {
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 600;
      }

      /* ===== REQUISITION & LOTS IMPROVED UI ===== */
      
      /* General Info Container for Requisition & Lots */
      .general-info-container {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
      }

      .general-info-body {
        padding: var(--spacing-lg);
      }

      .form-info-card {
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        font-size: 13px;
        color: var(--text-secondary);
      }

      .form-info-card p {
        margin: 0;
      }

      /* 3-Column Form Grid */
      .form-grid-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
      }

      .form-grid-3col .form-group.full-width {
        grid-column: 1 / -1;
      }

      @media (max-width: 1200px) {
        .form-grid-3col {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .form-grid-3col {
          grid-template-columns: 1fr;
        }
      }

      /* Summary Stats Row */
      .summary-stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
      }

      .stat-item {
        text-align: center;
        padding: var(--spacing-sm);
      }

      .stat-value {
        font-size: 22px;
        font-weight: 700;
        color: var(--primary-600);
        line-height: 1.2;
      }

      .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-top: 2px;
      }

      /* Collapsible Sections */
      .collapsible-section {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        overflow: hidden;
      }

      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        cursor: pointer;
        transition: background 0.2s ease;
        user-select: none;
      }

      .collapsible-header:hover {
        background: var(--surface-100);
      }

      .collapsible-header-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .collapsible-header-icon {
        width: 26px;
        height: 26px;
        background: var(--primary-100);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
      }

      .collapsible-header-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .collapsible-toggle {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 10px;
        transition: transform 0.2s ease;
      }

      .collapsible-section.collapsed .collapsible-toggle {
        transform: rotate(-90deg);
      }

      .collapsible-body {
        padding: var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        display: block;
      }

      .collapsible-section.collapsed .collapsible-body {
        display: none;
      }

      /* Compact Requisition Table */
      .req-table-compact {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .req-table-compact th {
        background: var(--surface-100);
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 1px solid var(--surface-200);
      }

      .req-table-compact td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--surface-100);
        color: var(--text-primary);
        vertical-align: middle;
      }

      .req-table-compact tbody tr:hover {
        background: var(--surface-50);
      }

      .req-table-compact tbody tr:last-child td {
        border-bottom: none;
      }

      /* Standard Requisition Table (larger) */
      .req-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .req-table th {
        background: var(--surface-100);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 2px solid var(--surface-200);
      }

      .req-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--surface-100);
        color: var(--text-primary);
        vertical-align: middle;
        font-size: 13px;
      }

      .req-table tbody tr:hover {
        background: var(--surface-50);
      }

      .req-table tbody tr:last-child td {
        border-bottom: none;
      }

      .req-table .req-id {
        font-weight: 600;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .req-table .req-unspsc {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        color: var(--primary-600);
        font-weight: 600;
      }

      .req-table .req-unspsc-desc {
        font-size: 12px;
        color: var(--text-muted);
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .req-table .req-amount {
        font-weight: 600;
        color: var(--success-600);
        font-size: 13px;
      }

      /* Remove button for requisition lines */
      .req-remove-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
        opacity: 0.6;
      }

      .req-remove-btn:hover {
        background: var(--danger-50);
        opacity: 1;
      }

      .req-id {
        font-weight: 600;
        font-size: 10px;
        color: var(--text-secondary);
      }

      .req-unspsc {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        color: var(--primary-600);
        font-weight: 600;
      }

      .req-unspsc-desc {
        font-size: 10px;
        color: var(--text-muted);
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .req-amount {
        font-weight: 600;
        color: var(--success-600);
        font-size: 11px;
        white-space: nowrap;
      }

      /* Compact Lots Grid */
      .lots-grid-compact {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
      }

      .lot-card-compact {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: all 0.2s ease;
      }

      .lot-card-compact:hover {
        border-color: var(--primary-300);
        box-shadow: var(--shadow-sm);
      }

      .lot-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px var(--spacing-sm);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lot-badge {
        background: var(--primary-500);
        color: white;
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-size: 9px;
        font-weight: 600;
      }

      .lot-name-input-compact {
        flex: 1;
        margin-left: var(--spacing-xs);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        border: none;
        background: transparent;
        padding: 3px;
        border-radius: var(--radius-sm);
        min-width: 80px;
      }

      .lot-name-input-compact:focus {
        outline: none;
        background: var(--surface-0);
        box-shadow: 0 0 0 2px var(--primary-200);
      }

      .lot-actions-compact {
        display: flex;
        gap: 2px;
      }

      .lot-action-btn {
        width: 22px;
        height: 22px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: var(--text-muted);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
      }

      .lot-action-btn:hover {
        background: var(--surface-200);
        color: var(--text-primary);
      }

      .lot-action-btn.danger:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-body-compact {
        padding: var(--spacing-xs) var(--spacing-sm);
        max-height: 140px;
        overflow-y: auto;
      }

      .lot-products-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-xs);
        padding-bottom: var(--spacing-xs);
        border-bottom: 1px dashed var(--surface-200);
      }

      .add-product-btn {
        font-size: 9px;
        color: var(--primary-500);
        cursor: pointer;
        font-weight: 600;
        padding: 1px 5px;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
        border: none;
      }

      .add-product-btn:hover {
        background: var(--primary-100);
      }

      .lot-product-compact {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 3px 0;
        font-size: 10px;
      }

      .lot-product-code {
        font-family: 'Courier New', monospace;
        color: var(--primary-600);
        font-weight: 600;
        font-size: 9px;
        min-width: 60px;
      }

      .lot-product-name {
        flex: 1;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lot-product-qty {
        font-size: 9px;
        color: var(--text-muted);
        background: var(--surface-100);
        padding: 0px 4px;
        border-radius: 6px;
      }

      .lot-product-remove {
        width: 16px;
        height: 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        opacity: 0;
        transition: all 0.2s ease;
      }

      .lot-product-compact:hover .lot-product-remove {
        opacity: 1;
      }

      .lot-product-remove:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-empty-state {
        text-align: center;
        padding: var(--spacing-sm);
        color: var(--text-muted);
        font-size: 10px;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      /* Create Lot Card */
      .create-lot-card {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-lg);
        border: 2px dashed var(--surface-300);
        background: var(--surface-50);
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 80px;
      }

      .create-lot-card:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        color: var(--primary-600);
      }

      /* Lots Table Styles */
      .lots-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: var(--surface-0);
      }

      .lots-table thead th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 2px solid var(--surface-200);
        background: var(--surface-50);
      }

      .lots-table tbody td {
        padding: 16px;
        border-bottom: 1px solid var(--surface-100);
        vertical-align: top;
        font-size: 13px;
      }

      .lots-table tbody tr:hover {
        background: var(--surface-50);
      }

      .lot-number-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: var(--primary-100);
        color: var(--primary-700);
        border-radius: 50%;
        font-weight: 700;
        font-size: 14px;
      }

      .lot-name-cell {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
      }

      .lot-desc-cell {
        color: var(--text-secondary);
        font-size: 13px;
        display: block;
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lot-products-cell {
        min-width: 250px;
      }

      .no-products-text {
        color: var(--text-muted);
        font-style: italic;
        font-size: 12px;
      }

      .product-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .product-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--surface-100);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 12px;
        transition: all 0.15s ease;
      }

      .product-tag:hover {
        background: var(--surface-50);
        border-color: var(--surface-300);
      }

      .product-tag-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
      }

      .product-tag-name {
        color: var(--text-secondary);
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
      }

      .product-tag-qty {
        color: var(--text-muted);
        font-weight: 500;
        font-size: 12px;
      }

      .product-tag-value {
        color: var(--success-600);
        font-weight: 600;
        font-size: 12px;
      }

      .product-tag-remove {
        width: 18px;
        height: 18px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        opacity: 0.6;
        transition: all 0.15s ease;
        margin-left: 2px;
      }

      .product-tag:hover .product-tag-remove {
        opacity: 1;
      }

      .product-tag-remove:hover {
        background: var(--danger-100);
        color: var(--danger-600);
      }

      /* Lot Actions Menu */
      .lot-actions-menu-wrapper {
        position: relative;
        display: inline-block;
      }

      .lot-actions-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 18px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
      }

      .lot-actions-btn:hover {
        background: var(--surface-100);
        color: var(--text-primary);
      }

      .lot-actions-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        min-width: 150px;
        z-index: 100;
        overflow: hidden;
      }

      .lot-actions-dropdown.show {
        display: block;
      }

      .lot-action-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 10px 14px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 12px;
        color: var(--text-primary);
        text-align: left;
        transition: background 0.15s ease;
      }

      .lot-action-item:hover {
        background: var(--surface-50);
      }

      .lot-action-item.danger {
        color: var(--danger-600);
      }

      .lot-action-item.danger:hover {
        background: var(--danger-50);
      }

      .lot-action-icon {
        font-size: 12px;
        width: 16px;
        text-align: center;
      }

      /* Add Product Modal Styles */
      .product-modal-tabs {
        display: flex;
        border-bottom: 1px solid var(--surface-200);
        margin-bottom: var(--spacing-md);
      }

      .product-modal-tab {
        padding: 10px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 12px;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        transition: all 0.15s ease;
      }

      .product-modal-tab:hover {
        color: var(--text-primary);
      }

      .product-modal-tab.active {
        color: var(--primary-600);
        border-bottom-color: var(--primary-500);
        font-weight: 600;
      }

      .product-modal-tab-content {
        display: none;
      }

      .product-modal-tab-content.active {
        display: block;
      }

      .req-line-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .req-line-option:hover {
        background: var(--surface-50);
        border-color: var(--primary-300);
      }

      .req-line-option.selected {
        background: var(--primary-50);
        border-color: var(--primary-400);
      }

      .req-line-option input[type="checkbox"] {
        margin-top: 2px;
      }

      .req-line-details {
        flex: 1;
      }

      .req-line-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
      }

      /* Compact Product Requirements Styles */
      .product-requirements-compact {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .product-req-item {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        overflow: hidden;
        transition: all 0.15s ease;
      }

      .product-req-item:hover {
        border-color: var(--surface-300);
      }

      .product-req-item.has-requirements {
        border-left: 3px solid var(--success-500);
      }

      .product-req-item.expanded {
        box-shadow: var(--shadow-sm);
      }

      .product-req-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        cursor: pointer;
        background: var(--surface-50);
        transition: background 0.15s ease;
      }

      .product-req-header:hover {
        background: var(--surface-100);
      }

      .product-req-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 0;
      }

      .product-req-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
        background: var(--primary-50);
        padding: 2px 8px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .product-req-desc {
        font-size: 13px;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .product-req-lot {
        font-size: 10px;
        color: var(--text-muted);
        background: var(--surface-100);
        padding: 2px 6px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .product-req-status {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      .status-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
      }

      .status-badge.status-complete {
        background: var(--success-100);
        color: var(--success-700);
      }

      .status-badge.status-pending {
        background: var(--surface-100);
        color: var(--text-muted);
      }

      .product-req-toggle {
        font-size: 10px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
      }

      .product-req-item.expanded .product-req-toggle {
        transform: rotate(180deg);
      }

      .product-req-body {
        padding: 14px;
        border-top: 1px solid var(--surface-200);
        background: var(--surface-0);
      }

      /* Requirement Type Selector */
      .req-type-selector {
        text-align: center;
        padding: var(--spacing-sm);
      }

      .req-type-btn {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 12px 20px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s ease;
        min-width: 100px;
      }

      .req-type-btn:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .req-type-icon {
        font-size: 20px;
      }

      .req-type-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .req-type-hint {
        font-size: 10px;
        color: var(--text-muted);
      }

      /* Full Rich Text Toolbar */
      .rich-text-toolbar-full {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 8px;
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        flex-wrap: wrap;
      }

      .toolbar-group {
        display: flex;
        gap: 2px;
      }

      .toolbar-sep {
        width: 1px;
        height: 20px;
        background: var(--surface-300);
        margin: 0 4px;
      }

      .tb-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .tb-btn:hover {
        background: var(--surface-200);
        color: var(--text-primary);
      }

      .tb-btn:active {
        background: var(--primary-100);
        color: var(--primary-600);
      }

      .rich-text-editor-full {
        min-height: 120px;
        padding: 12px;
        border: 1px solid var(--surface-200);
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        font-size: 13px;
        line-height: 1.6;
        outline: none;
        background: var(--surface-0);
      }

      .rich-text-editor-full:focus {
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .rich-text-editor-full:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
      }

      /* Rich Text Content Box */
      .rich-text-content {
        outline: none;
        background: var(--surface-0);
      }

      .rich-text-content:focus {
        background: var(--surface-0);
      }

      .rich-text-content:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
        font-style: italic;
      }

      .rich-text-box:focus-within {
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      /* Team UI Styles */
      .team-section-content {
        padding: var(--spacing-sm) 0;
      }

      .team-member-card {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-xs);
      }

      .team-member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
      }

      .team-member-info {
        flex: 1;
        min-width: 0;
      }

      .team-member-name {
        font-weight: 600;
        font-size: 13px;
        color: var(--text-primary);
      }

      .team-member-email {
        font-size: 11px;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .team-member-role {
        font-size: 11px;
        color: var(--text-secondary);
        background: var(--surface-100);
        padding: 2px 8px;
        border-radius: 12px;
        white-space: nowrap;
      }

      .team-member-remove {
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .team-member-remove:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .team-subsection {
        margin-bottom: var(--spacing-md);
      }

      .team-subsection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm);
      }

      .team-subsection-title {
        font-weight: 600;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .team-members-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .team-empty-slot {
        padding: var(--spacing-md);
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
        background: var(--surface-50);
        border: 1px dashed var(--surface-300);
        border-radius: var(--radius-md);
      }

      .team-roles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--spacing-md);
      }

      .team-role-card {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
      }

      .team-role-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--surface-100);
      }

      .team-role-icon {
        font-size: 20px;
      }

      .team-role-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
      }

      .team-role-content {
        min-height: 60px;
      }

      .team-add-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .team-add-placeholder:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        color: var(--primary-600);
      }

      .team-add-placeholder i {
        font-size: 16px;
      }

      /* Compact Rich Text Editor */
      .rich-text-toolbar-compact {
        display: flex;
        gap: 2px;
        padding: 4px;
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      }

      .rich-text-editor-compact {
        min-height: 80px;
        padding: 10px;
        border: 1px solid var(--surface-200);
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        font-size: 13px;
        line-height: 1.5;
        outline: none;
      }

      .rich-text-editor-compact:focus {
        border-color: var(--primary-400);
      }

      .rich-text-editor-compact:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
      }

      /* Compact Attributes */
      .req-attributes-compact {
        padding: var(--spacing-xs);
      }

      .attributes-grid {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .attr-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .attr-input {
        padding: 6px 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 12px;
        outline: none;
        transition: border-color 0.15s ease;
      }

      .attr-input:focus {
        border-color: var(--primary-400);
      }

      .attr-name {
        flex: 1;
      }

      .attr-value {
        flex: 1.5;
      }

      .attr-remove {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 14px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .attr-remove:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .req-actions-row {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--surface-100);
      }

      /* Other Requirements Subsections */
      .other-req-subsection {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        overflow: hidden;
      }

      .subsection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .subsection-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .subsection-body {
        padding: 14px;
      }

      .service-line-compact {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .req-line-desc {
        color: var(--text-secondary);
        font-size: 11px;
        margin-top: 2px;
      }

      .new-product-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .new-product-form .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }

      /* Requisition Line Modal */
      .req-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1002;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(2px);
      }

      .req-modal-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 550px;
        width: 95%;
        max-height: 75vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .req-modal-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-50);
      }

      .req-modal-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .req-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-sm);
      }

      .req-option {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-xs);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
      }

      .req-option:hover {
        background: var(--primary-50);
        border-color: var(--primary-300);
      }

      .req-option.selected {
        background: var(--primary-50);
        border-color: var(--primary-500);
      }

      .req-option-checkbox {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .req-option-details {
        flex: 1;
        min-width: 0;
      }

      .req-option-main {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 12px;
      }

      .req-option-sub {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 1px;
      }

      .req-modal-footer {
        padding: var(--spacing-sm) var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        background: var(--surface-50);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Header - Matching tender-dashboard-complete -->
      <header class="header" role="banner">
        <div class="header-top">
          <div class="logo-container">
            <div class="logo">UNOPS</div>
            <span class="portal-badge">Procurement</span>
            <span style="color: var(--surface-400); margin: 0 8px; font-size: 18px;">|</span>
            <span style="color: var(--primary-500); font-weight: 600; font-size: 14px;">eTendering</span>
            </div>

          <!-- Header Actions: Accessibility, Language, AI, Help, Notifications -->
          <div class="header-actions">
            <!-- Accessibility Button -->
            <div class="header-action-btn" title="Accessibility Options" aria-label="Accessibility Options">
              <i class="pi pi-eye" aria-hidden="true"></i>
          </div>

            <!-- Language Selector -->
            <div class="header-action-btn language-selector" title="Change Language" aria-label="Change Language">
              <span class="lang-flag">üåê</span>
            </div>

            <!-- AI Assistant -->
            <div class="header-action-btn ai-assistant-btn" title="AI Assistant" aria-label="AI Procurement Assistant">
              <div class="ai-icon-wrapper">
                <i class="pi pi-bolt" aria-hidden="true"></i>
              </div>
              <span class="ai-badge">NEW</span>
            </div>

            <!-- Help/Questions -->
            <div class="header-action-btn" title="Help Center" aria-label="Help Center">
              <i class="pi pi-question-circle" aria-hidden="true"></i>
            </div>

            <!-- Notifications -->
            <div class="header-action-btn notification-btn" title="Notifications" aria-label="View Notifications">
              <i class="pi pi-bell" aria-hidden="true"></i>
              <span class="notification-badge" id="notificationCount">7</span>
            </div>
          </div>

          <div class="user-menu">
            <div class="user-info">
              <div class="user-company">UNOPS Internal</div>
              <div class="user-name">Jane Doe</div>
            </div>
            <div class="user-avatar" aria-label="User menu">JD</div>
          </div>
        </div>
      </header>

      <!-- App Container -->
      <div class="app-container">
        <!-- Sidebar - Matching award-review-dashboard -->
        <aside class="sidebar">
          <nav class="sidebar-menu">
            <!-- Tendering Section -->
            <div class="menu-section">
              <div class="menu-section-title">Tendering</div>
              <a class="menu-item disabled">
                <span class="menu-icon">üìä</span>
                <span>Overview</span>
              </a>
              <a class="menu-item disabled">
                <span class="menu-icon">üìã</span>
                <span>My Tenders</span>
              </a>
              <a class="menu-item" onclick="window.location.href='tender-create.html'">
                <span class="menu-icon">‚úèÔ∏è</span>
                <span>Create Tender</span>
              </a>
              <a class="menu-item active" id="menu-drafts">
                <span class="menu-icon">üìù</span>
                <span>Drafts</span>
              </a>
              <a class="menu-item disabled" onclick="window.location.href='template-library.html'">
                <span class="menu-icon">üìÅ</span>
                <span>Templates</span>
              </a>
            </div>
          </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Page Action Bar - Buttons moved from header -->
          <div class="page-action-bar" id="top-actions">
            <button class="btn btn-secondary"><i class="pi pi-download"></i> Download Package</button>
            <button class="btn btn-secondary"><i class="pi pi-eye"></i> Preview</button>
            <button class="btn btn-secondary"><i class="pi pi-save"></i> Save Draft</button>
            <button class="btn btn-primary"><i class="pi pi-send"></i> Submit for Review</button>
          </div>

          <!-- Tender Authoring View -->
          <div class="view-section active" id="authoring-view">
            <!-- Progress Steps -->
            <div class="progress-container">
              <div class="progress-steps">
                <div class="progress-step completed" data-step="1">
                  <div class="step-icon">‚úì</div>
                  <div class="step-label">Event Setup</div>
                </div>
                <div class="progress-step active" data-step="2">
                  <div class="step-icon">2</div>
                  <div class="step-label">Authoring</div>
                </div>
                <div class="progress-step" data-step="3">
                  <div class="step-icon">3</div>
                  <div class="step-label">Review</div>
                </div>
                <div class="progress-step" data-step="4">
                  <div class="step-icon">4</div>
                  <div class="step-label">Publish</div>
                </div>
              </div>
            </div>

            <!-- Block Navigation Tabs -->
            <div class="block-nav" id="block-nav">
              <!-- Block tabs will be dynamically generated -->
            </div>

            <!-- Content Area -->
            <div class="content-area">
              <div class="content-wrapper" id="content-wrapper">
                <!-- Content will be dynamically generated based on selected block -->
              </div>

              <!-- Form Library Floating Button -->
              <div id="formLibraryFloatingBtn" class="form-library-floating-btn" onclick="toggleFormLibrary()" title="Form Library" aria-label="Open Form Library">
                <div class="form-library-btn-icon">
                  <i class="pi pi-folder-open"></i>
                </div>
                <div class="form-library-btn-badge" id="formLibraryBadge">8</div>
                <div class="form-library-btn-label">Form<br>Library</div>
              </div>

              <!-- Form Library Panel - Matching Team Collaboration style (Forms only) -->
              <div class="form-library-panel" id="form-library-panel">
                <div class="form-library-header">
                  <div class="form-library-header-content">
                    <div class="form-library-header-icon">
                      <i class="pi pi-folder-open"></i>
                    </div>
                    <div class="form-library-header-text">
                  <div class="form-library-title">Form Library</div>
                      <div class="form-library-subtitle">Drag & drop to add forms</div>
                </div>
                  </div>
                  <button class="toggle-library-btn" onclick="toggleFormLibrary()" aria-label="Close panel">
                    <i class="pi pi-times"></i>
                  </button>
                </div>

                <div class="form-library-body">
                  <!-- Search Area -->
                  <div class="form-library-search-area">
                  <div class="form-library-search">
                      <i class="pi pi-search form-library-search-icon"></i>
                    <input type="search" placeholder="Search forms..." id="form-library-search" />
                  </div>
                  </div>

                  <!-- Content Area -->
                  <div class="form-library-content">
                  <div class="form-library-group">
                      <div class="form-library-group-label">Submission Forms</div>
                    <div class="form-library-list" id="form-library-list">
                      <div class="form-library-item" draggable="true" data-form-type="instructions" data-form-name="Instructions to Bidders">
                          <div class="form-library-item-icon">üìÑ</div>
                          <div class="form-library-item-content">
                        <strong>Instructions to Bidders</strong>
                            <span>Standard format for tender instructions</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="contracts" data-form-name="Contract Forms">
                          <div class="form-library-item-icon">üìù</div>
                          <div class="form-library-item-content">
                        <strong>Contract Forms</strong>
                            <span>Offer & award documentation</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="bank-guarantee" data-form-name="Bank Guarantee Form">
                          <div class="form-library-item-icon">üè¶</div>
                          <div class="form-library-item-content">
                        <strong>Bank Guarantee Form</strong>
                            <span>Security requirements documentation</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="bid-security" data-form-name="Bid Security Form">
                          <div class="form-library-item-icon">üîí</div>
                          <div class="form-library-item-content">
                        <strong>Bid Security Form</strong>
                            <span>Security requirements for bids</span>
                      </div>
                        </div>
                      </div>
                    </div>

                    <div class="form-library-group">
                      <div class="form-library-group-label">Technical Documents</div>
                      <div class="form-library-list">
                      <div class="form-library-item" draggable="true" data-form-type="drive-questionnaire" data-form-name="DRiVE Questionnaire">
                          <div class="form-library-item-icon">üìä</div>
                          <div class="form-library-item-content">
                        <strong>DRiVE Questionnaire</strong>
                        <span>Risk assessment questionnaire</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="technical-specs" data-form-name="Technical Specifications">
                          <div class="form-library-item-icon">‚öôÔ∏è</div>
                          <div class="form-library-item-content">
                        <strong>Technical Specifications</strong>
                        <span>Detailed technical requirements</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="evaluation" data-form-name="Evaluation Form">
                          <div class="form-library-item-icon">‚úÖ</div>
                          <div class="form-library-item-content">
                        <strong>Evaluation Form</strong>
                        <span>Scoring and evaluation matrix</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="price-schedule" data-form-name="Price Schedule">
                          <div class="form-library-item-icon">üí∞</div>
                          <div class="form-library-item-content">
                        <strong>Price Schedule</strong>
                        <span>Pricing breakdown template</span>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

                <!-- Footer -->
                <div class="form-library-footer">
                  <div class="form-library-footer-hint">
                    <i class="pi pi-info-circle"></i>
                    Drag forms to sections or click to add
                  </div>
                </div>
              </div>
            </div>

          </div>

          <!-- NOTE: Initiation and Wizard views are in tender-create.html -->
        </main>
      </div>
    </div>

    <script>
      // ===== GLOBAL STATE =====
      let currentView = 'authoring'; // This page is authoring-only
      let wizardStep = 1;
      const totalWizardSteps = 3;
      let selectedTemplate = null;
      let wizardData = {};
      
      // Load data from localStorage (from tender-create.html wizard)
      function loadTenderInitData() {
        const savedData = localStorage.getItem('tenderInitData');
        if (savedData) {
          try {
            const initData = JSON.parse(savedData);
            wizardData = initData.wizardData || {};
            selectedTemplate = initData.selectedTemplate || null;
            currentProcessInfo = initData.currentProcessInfo || currentProcessInfo;
            currentLifecycleLinks = initData.currentLifecycleLinks || [];
            
            // Update page title and breadcrumbs
            if (wizardData.title) {
              document.getElementById('page-title').textContent = wizardData.title;
            }
            const methodMap = { itb: 'ITB', rfp: 'RFP', rfq: 'RFQ', eoi: 'EOI', direct: 'Direct' };
            const requirementMap = { goods: 'Goods', services: 'Services', works: 'Works', 'goods-services': 'Goods & Services' };
            document.getElementById('page-breadcrumbs').textContent = 
              `${methodMap[wizardData.method] || 'Tender'} ¬∑ ${requirementMap[wizardData.requirementType] || 'Goods'} ¬∑ Draft`;
            
            // Update top actions for authoring mode
            const topActions = document.getElementById('top-actions');
            topActions.innerHTML = `
              <button class="btn btn-ghost">Preview</button>
              <button class="btn btn-ghost">üíæ Save Draft</button>
              <button class="btn btn-ghost" onclick="downloadTenderPackage()" title="Download all documents as ZIP">üì¶ Download Package</button>
              <button class="btn btn-primary">Submit for Review</button>
            `;
            
            // Pre-populate template blocks with wizard data
            populateTemplateBlocks();
            
            console.log('Loaded tender init data:', initData);
            return true;
          } catch (e) {
            console.error('Error loading tender init data:', e);
          }
        }
        return false;
      }

      // Template blocks structure (based on template builder)
      const templateBlocks = [
        {
          id: 'general',
          icon: 'üìã',
          piIcon: 'pi-file',
          name: 'General Information',
          sections: [
            {
              title: 'Basic Information',
              fields: [
                { id: 'title', label: 'Title', type: 'text', required: true, value: '' },
                { id: 'reference', label: 'Reference', type: 'text', required: true, value: 'Auto-generated', readonly: true },
                { id: 'sourcingOrSolicitation', label: 'Sourcing or Solicitation', type: 'select', required: true, options: ['Select...', 'Sourcing', 'Solicitation'], onchange: 'updateSourcingOrSolicitation' },
                { id: 'sourcingMethod', label: 'Sourcing Method', type: 'select', required: false, options: ['Select...', 'RFI', 'EOI', 'PQ', 'Ad-hoc shortlist'], conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Sourcing' } },
                { id: 'typeOfRequirement', label: 'Type of Requirement', type: 'select', required: true, options: ['Select...', 'Goods', 'Services', 'Works'] },
                { id: 'description', label: 'Description', type: 'textarea', required: true, value: '' },
                { id: 'beneficiaryCountries', label: 'Beneficiary country(ies)', type: 'select', required: false, multiple: true, options: ['Afghanistan', 'Bangladesh', 'Cambodia', 'India', 'Pakistan', 'Somalia', 'South Sudan', 'Sudan', 'Syria', 'Yemen'] },
                { id: 'modalityOfBidReceipt', label: 'Modality of Bid Receipt', type: 'select', required: true, options: ['Select...', 'Online Only', 'Email Submission', 'Physical Submission'], onchange: 'updateModalityOfBidReceipt' },
                { id: 'waiverForBidReceipt', label: 'Waiver for Bid Receipt Modality', type: 'text', required: false, value: '', placeholder: 'Provide waiver link', conditionalVisibility: { field: 'modalityOfBidReceipt', values: ['Email Submission', 'Physical Submission'] } },
                { id: 'epp', label: 'EPP', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateEPP' },
                { id: 'eppAuthorizationLink', label: 'EPP Authorization (Jira Link)', type: 'text', required: false, value: '', placeholder: 'Enter Jira link', conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'eppAuthorizationEndDate', label: 'EPP Authorization End Date', type: 'date', required: false, value: '', conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'scopeOfEPPApproval', label: 'Scope of EPP Approval', type: 'select', required: false, options: ['Select...', 'Project', 'Org Unit', 'Specific procurement process', 'Other'], conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'medicineOrMedical', label: 'Medicine / Medical Equipment', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateMedicineOrMedical' },
                { id: 'policyExceptionLink', label: 'Policy Exception for Medicine/Medical Equipment Procurement (Annex 2 Jira Link)', type: 'text', required: false, value: '', placeholder: 'Enter Jira link', conditionalVisibility: { field: 'medicineOrMedical', value: 'Yes' } },
                { id: 'processType', label: 'Process Type', type: 'checkbox-group', required: false, options: ['Standard solicitation', 'Solicit offers against LTA/BPA', 'Secondary bidding against LTA/BPA', 'Direct contracting / Sole sourcing'], onchange: 'updateProcessType', conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Solicitation' } },
                { id: 'contractAmendment', label: 'Contract Amendment', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], conditionalVisibility: { field: 'processType', contains: 'Direct contracting / Sole sourcing' } },
                { id: 'solicitationMethod', label: 'Solicitation Method', type: 'select', required: false, options: ['Select...', 'RFQ', 'ITB', 'RFP', 'e-reserve auctions'], conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Solicitation' } },
                { id: 'procurementLifecycleTracker', label: 'Procurement Lifecycle & Related Processes', type: 'lifecycle-tracker', required: false, description: 'Link this process to related procurement events to maintain a complete audit trail' },
                { id: 'unCollaboration', label: 'UN Collaboration', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateUNCollaboration' },
                { id: 'unCollaborationType', label: 'UN Collaboration Type', type: 'select', required: false, options: ['Select...', 'Joint tendering process with other UN organizations', 'Secondary bidding using other UN agency\'s LTA', 'Re-use of solicitation results of another UN agency'], conditionalVisibility: { field: 'unCollaboration', value: 'Yes' } },
                { id: 'unAgencies', label: 'UN Agencies', type: 'select', required: false, multiple: true, options: ['UNDP', 'UNICEF', 'UNHCR', 'WFP', 'WHO', 'FAO', 'ILO', 'UNESCO', 'UNIDO'], conditionalVisibility: { field: 'unCollaboration', value: 'Yes' } },
                { id: 'organizationalUnit', label: 'Organizational Unit', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS' },
                { id: 'isLease', label: 'Is this a Lease', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateIsLease' },
                { id: 'srmComplianceDocument', label: 'SRM Compliance Document', type: 'file', required: false, value: '', conditionalVisibility: { field: 'isLease', value: 'Yes' } },
              ],
            },
          ],
        },
        {
          id: 'project',
          icon: 'üèóÔ∏è',
          piIcon: 'pi-briefcase',
          name: 'Project & Tender Details',
          sections: [
            {
              title: 'Project Information',
              fields: [
                { id: 'workPackage', label: 'Work Package (GLA)', type: 'search', required: true, value: '', placeholder: 'Search from oneUNOPS (requisition)', source: 'oneUNOPS' },
                { id: 'donorFundingSource', label: 'Donor / Funding Source (GLA)', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS', source: 'oneUNOPS' },
                { id: 'projectName', label: 'Project Name', type: 'text', required: true, value: '', source: 'oneUNOPS project' },
                { id: 'implementationEndDate', label: 'Implementation End Date', type: 'date', required: false, value: '', source: 'oneUNOPS project' },
              ],
            },
            {
              title: 'Particulars',
              isParticulars: true, // Special flag for custom rendering
            },
          ],
        },
        {
          id: 'requisition-lots',
          icon: 'üìã',
          piIcon: 'pi-list',
          name: 'Requisition & Lots',
          sections: [
            {
              title: 'Requisition & Lots Management',
              fields: [],
              isRequisitionLots: true, // Special flag for this section
            },
          ],
        },
        {
          id: 'scope',
          icon: 'üéØ',
          piIcon: 'pi-check-square',
          name: 'Scope & Requirements',
          sections: [
            {
              title: 'Scope and objectives',
              fields: [
                { label: 'Scope and objectives of sourcing or solicitation process', type: 'textarea', required: true, value: '' },
              ],
            },
            {
              title: 'Product Requirements & Specifications',
              fields: [],
              isProductRequirements: true,
            },
            {
              title: 'Other requirements',
              fields: [],
              isTenderAuthorConfig: true,
            },
          ],
        },
        {
          id: 'submission',
          icon: 'üìù',
          piIcon: 'pi-upload',
          name: 'Submission Requirements',
          sections: [
            {
              title: 'Bid Response Requirements',
              fields: [],
              isSupplierResponseStructure: true,
            },
            {
              title: 'Supplier Form Preview',
              fields: [],
              isSupplierFormPreview: true,
            },
          ],
        },
        {
          id: 'evaluation',
          icon: 'üìä',
          piIcon: 'pi-chart-bar',
          name: 'Evaluation',
          sections: [
            {
              title: 'Evaluation Method',
              fields: [
                { id: 'evaluationMethod', label: 'Evaluation method', type: 'select', required: true, options: ['Select...', 'Lowest price', 'Cumulative analysis', 'Two-stage'], onchange: 'updateEvaluationMethodInEvaluation' },
                { id: 'weightage', label: 'Weightage of technical and financial proposals', type: 'select', required: false, options: ['Select...', '70% technical / 30% financial', '60% technical / 40% financial', '80% technical / 20% financial'], conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'minPoints', label: 'Minimum Points for Technical compliance', type: 'number', required: false, value: '', placeholder: 'e.g., 70', conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'evaluationMethodDetails', label: 'Evaluation method details', type: 'select', required: false, options: ['Select...', 'Standard evaluation', 'Detailed evaluation criteria', 'Other'], onchange: 'updateEvaluationMethodDetailsInEvaluation' },
                { id: 'evaluationMethodDetailsFreeText', label: 'Evaluation method details ‚Äì free text', type: 'textarea', required: false, value: '', placeholder: 'Provide detailed evaluation method description...', conditionalVisibility: { field: 'evaluationMethodDetails', value: 'Other' } },
              ],
            },
            {
              title: 'Evaluation Criteria',
              isEvaluationCriteria: true, // Special flag to render custom section
            },
          ],
        },
        {
          id: 'competition',
          icon: 'üèÜ',
          piIcon: 'pi-flag',
          name: 'Competition',
          sections: [
            {
              title: 'Competition Type',
              isCompetition: true,
            },
          ],
        },
        {
          id: 'team',
          icon: 'üë•',
          piIcon: 'pi-users',
          name: 'Team',
          sections: [
            {
              title: 'Team Members',
              isTeamMembers: true,
            },
          ],
        },
      ];

      let currentBlockIndex = 0;
      let currentAuthoringStep = 2;
      let addedForms = {}; // Store added forms by block and section: { blockId: { sectionIndex: [forms] } }
      
      // Requisition & Lots Management
      let requisitionLines = []; // From ERP integration (independent, just for reference)
      let lots = []; // Created lots: [{ id, name, unspscCodes: [{ code, description }] }]
      let allowPartialQuotations = ''; // 'Yes' or 'No' - determines if lots section is visible
      
      // Product Requirements (per UNSPSC code)
      let productRequirements = {}; // { unspscCode: { requirementType: 'attributes'|'description', attributes: [{name, value}], description: '' } }
      
      // Competition settings
      let competitionValues = {
        competitionType: '',
        ungmVendors: [],
        unregisteredEmail: '',
        unregisteredCompanyName: '',
        marketResearchDetails: '',
        effectiveCompetitionDetails: '',
        limitedCompetitionJustification: '',
        directContractingReason: '',
        linkedProcess: '',
        directContractingJustification: ''
      };
      
      // Contract Provisions settings
      let contractProvisionsValues = {
        generalConditions: '',
        specialConditions: '',
        sampleContract: '',
        contractClausesKPIs: '',
        contractClausesDrive: '',
        performanceSecurityRequired: '',
        performanceSecurityDetails: '',
        advancePaymentRequired: '',
        advancePaymentDetails: ''
      };
      
      // Team Members
      let teamMembers = {
        author: { name: 'Valentina Rossi', email: 'valentina.rossi@unops.org', role: 'Author', avatar: 'VR' },
        alternateAuthors: [],
        procurementReviewer: null,
        procurementAuthority: null,
        technicalExpert: null,
        bidOpeningPanel: [],
        evaluationTeam: [],
        collaborators: []
      };
      
      // Submission Forms - Standard forms for tender
      let submissionForms = [
        { id: 'form-a', code: 'A', name: 'JV Partner Info', description: 'Joint Venture partner information and details', icon: 'ü§ù', required: false, added: true },
        { id: 'form-b', code: 'B', name: 'Bid Submission', description: 'Main bid submission form and declaration', icon: 'üìù', required: true, added: true },
        { id: 'form-c', code: 'C', name: 'Price Schedule', description: 'Pricing template and cost breakdown', icon: 'üí∞', required: true, added: true },
        { id: 'form-d', code: 'D', name: 'Technical Bid', description: 'Technical proposal and specifications', icon: '‚öôÔ∏è', required: true, added: true },
        { id: 'form-e', code: 'E', name: 'Bid Security Form', description: 'Bank Guarantee for bid security', icon: 'üè¶', required: false, added: true },
        { id: 'form-f', code: 'F', name: "Manufacturer's Authorization", description: 'Authorization letter from manufacturer', icon: '‚úÖ', required: false, added: true },
        { id: 'form-g', code: 'G', name: 'Performance Statement', description: 'Past performance and experience record', icon: 'üìä', required: true, added: true },
        { id: 'form-h', code: 'H', name: 'Self Disclosure Form', description: 'Supplier self-disclosure declaration', icon: 'üìã', required: true, added: true },
        { id: 'form-drive', code: 'DRiVE', name: 'DRiVE Self Assessment', description: 'Due diligence risk self-assessment questionnaire', icon: 'üõ°Ô∏è', required: false, added: false }
      ];

      // Bid Response Requirements - Custom Fields
      let bidResponseFields = {
        perBid: [
          { name: "Bidder's Total Prices [Incoterm]", type: "Currency input", id: 'pb1' },
          { name: "Customs clearance costs", type: "Currency input", id: 'pb2' },
          { name: "Freight cost", type: "Currency input", id: 'pb3' },
          { name: "Total Price of Goods [Incoterm]", type: "Currency input (calculated)", id: 'pb4' },
          { name: "Total Price of Related Services", type: "Currency input", id: 'pb5' }
        ],
        perUNSPSC: [
          { name: "Unit price Incoterm", type: "Currency input", id: 'pu1' },
          { name: "Total price Incoterm", type: "Currency input (calculated)", id: 'pu2' },
          { name: "Country of Origin", type: "Country dropdown", id: 'pu3' },
          { name: "Delivery point(s)", type: "Text input", id: 'pu4' },
          { name: "Model", type: "Text input", id: 'pu5' },
          { name: "Manufacturer", type: "Text input", id: 'pu6' }
        ],
        perAttribute: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pa1' },
          { name: "Details of goods offered", type: "Text area", id: 'pa2' }
        ],
        perServiceLine: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'ps1' },
          { name: "Details", type: "Text area", id: 'ps2' }
        ],
        perDelivery: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pd1' },
          { name: "Details", type: "Text area", id: 'pd2' }
        ]
      };
      
      let fieldIdCounter = 100;
      
      // Supplier Form Preview Toggle
      let isSupplierFormPreviewVisible = false;
      
      // Delivery Requirements - Configurable Fields
      let deliveryRequirementFields = [
        { id: 'dr1', label: 'Delivery Time', type: 'text', placeholder: 'e.g., Within 30 days', value: '' },
        { id: 'dr2', label: 'Delivery Place', type: 'text', placeholder: 'e.g., Warehouse, Copenhagen', value: '' },
        { id: 'dr3', label: 'Allowed Incoterms', type: 'multi-select', placeholder: '', value: [] },
        { id: 'dr4', label: 'Consignee Details', type: 'textarea', placeholder: 'Enter consignee details', value: '' }
      ];
      
      // Evaluation Criteria
      let evaluationCriteria = [
        // Each criterion: { id, type, description, evaluationMethod, appliesTo: 'entire' | 'specific', lots: [], unspscCodes: [] }
      ];
      let evaluationCriteriaIdCounter = 1;
      
      // General Information - Field Values for Conditional Visibility
      let generalInfoValues = {
        sourcingOrSolicitation: '',
        modalityOfBidReceipt: '',
        epp: '',
        medicineOrMedical: '',
        processType: [],
        directContracting: false,
        unCollaboration: '',
        isLease: ''
      };
      
      // Particulars - Field Values for Conditional Visibility
      let particularsValues = {
        clarificationsOrPreBid: '',
        numberOfMeetings: 0,
        siteVisit: '',
        dateOption: '',
        exclusivity: '',
        alternativeOffers: '',
        advancePaymentAllowed: '',
        advancePaymentSecurity: '',
        liquidatedDamages: '',
        performanceSecurity: '',
        bidSecurity: ''
      };
      
      // Evaluation Block - Field Values for Conditional Visibility
      let evaluationBlockValues = {
        evaluationMethod: '',
        evaluationMethodDetails: ''
      };
      
      // Initialize sample requisition lines (simulating ERP data)
      function initializeRequisitionLines() {
        requisitionLines = [
          {
            id: 'REQ-LINE-001',
            unspscCode: '43000000',
            unspscDescription: 'Information Technology Broadcasting and Telecommunications',
            description: 'IT Equipment and Services',
            quantity: 1,
            unitOfMeasure: 'Lot',
            amount: 50000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-002',
            unspscCode: '43211503',
            unspscDescription: 'Laptop computers',
            description: 'Laptop computers for office use',
            quantity: 50,
            unitOfMeasure: 'Unit',
            amount: 25000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-003',
            unspscCode: '43211602',
            unspscDescription: 'Docking stations',
            description: 'Docking stations for laptops',
            quantity: 50,
            unitOfMeasure: 'Unit',
            amount: 10000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-004',
            unspscCode: '43211708',
            unspscDescription: 'Laptop bags',
            description: 'Laptop carrying bags',
            quantity: 50,
            unitOfMeasure: 'Unit',
            amount: 2500,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-005',
            unspscCode: '43222609',
            unspscDescription: 'Network switches',
            description: 'Network switches for office setup',
            quantity: 10,
            unitOfMeasure: 'Unit',
            amount: 5000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-006',
            unspscCode: '43222619',
            unspscDescription: 'Wireless access points',
            description: 'WiFi access points',
            quantity: 20,
            unitOfMeasure: 'Unit',
            amount: 3000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-007',
            unspscCode: '81111812',
            unspscDescription: 'Network installation & configuration service',
            description: 'Network installation services',
            quantity: 1,
            unitOfMeasure: 'Service',
            amount: 5000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-008',
            unspscCode: '44101503',
            unspscDescription: 'Laser printers',
            description: 'Laser printers for office',
            quantity: 5,
            unitOfMeasure: 'Unit',
            amount: 2500,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-009',
            unspscCode: '44103103',
            unspscDescription: 'Toner cartridges',
            description: 'Toner cartridges for printers',
            quantity: 20,
            unitOfMeasure: 'Unit',
            amount: 2000,
            currency: 'USD',
          },
        ];
      }

      // Available templates
      const availableTemplates = [
        {
          id: 'itb-goods-standard',
          name: 'ITB - Goods (Standard)',
          type: 'ITB',
          icon: 'üì¶',
          description: 'Standard Invitation to Bid template for goods procurement. Includes all standard forms and requirements.',
          category: 'Goods',
          method: 'ITB',
          matchScore: 95,
        },
        {
          id: 'itb-services-standard',
          name: 'ITB - Services (Standard)',
          type: 'ITB',
          icon: 'üîß',
          description: 'Standard Invitation to Bid template for services procurement with service-specific requirements.',
          category: 'Services',
          method: 'ITB',
          matchScore: 90,
        },
        {
          id: 'rfp-goods-services',
          name: 'RFP - Goods & Services',
          type: 'RFP',
          icon: 'üìã',
          description: 'Request for Proposal template suitable for complex procurements involving both goods and services.',
          category: 'Goods & Services',
          method: 'RFP',
          matchScore: 85,
        },
        {
          id: 'rfq-goods-standard',
          name: 'RFQ - Goods (Standard)',
          type: 'RFQ',
          icon: 'üí∞',
          description: 'Request for Quotation template for simple goods procurement with streamlined requirements.',
          category: 'Goods',
          method: 'RFQ',
          matchScore: 80,
        },
        {
          id: 'itb-works-standard',
          name: 'ITB - Works (Standard)',
          type: 'ITB',
          icon: 'üèóÔ∏è',
          description: 'Standard Invitation to Bid template for works/construction projects with works-specific clauses.',
          category: 'Works',
          method: 'ITB',
          matchScore: 75,
        },
      ];

      // Mock data for procurement processes (for lifecycle linking)
      const procurementProcesses = [
        {
          id: 'REQ-2024-001',
          type: 'Requisition',
          title: 'Medical Equipment Requisition',
          status: 'Completed',
          value: '$250,000',
          created: '2024-11-15',
          createdBy: 'Sarah Johnson',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'RFI-2024-045',
          type: 'RFI',
          title: 'Request for Information - Medical Equipment Suppliers',
          status: 'Completed',
          value: 'N/A',
          created: '2024-12-01',
          createdBy: 'Michael Chen',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'RFP-2025-001',
          type: 'RFP',
          title: 'Supply of Medical Equipment for Health Facilities',
          status: 'Published',
          value: '$250,000',
          created: '2025-01-15',
          createdBy: 'Sarah Johnson',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'REQ-2024-082',
          type: 'Requisition',
          title: 'Construction Materials Requisition',
          status: 'Completed',
          value: '$1,200,000',
          created: '2024-12-10',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'EOI-2024-028',
          type: 'EOI',
          title: 'Expression of Interest - Construction Companies',
          status: 'Completed',
          value: 'N/A',
          created: '2024-12-20',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'ITB-2025-015',
          type: 'ITB',
          title: 'Construction of School Infrastructure in Rural Areas',
          status: 'Published',
          value: '$1,200,000',
          created: '2025-01-22',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'RFQ-2024-156',
          type: 'RFQ',
          title: 'Office Supplies Quotation Request',
          status: 'Closed',
          value: '$45,000',
          created: '2025-01-10',
          createdBy: 'Lisa Anderson',
          category: 'Goods',
          projectName: 'Office Operations 2025'
        },
        {
          id: 'LTA-2023-012',
          type: 'LTA',
          title: 'Long Term Agreement - IT Equipment Supply',
          status: 'Active',
          value: '$500,000',
          created: '2023-06-15',
          createdBy: 'David Kim',
          category: 'Goods',
          projectName: 'IT Infrastructure Modernization'
        },
        {
          id: 'RFP-2024-089',
          type: 'RFP',
          title: 'Consultancy Services - Project Management',
          status: 'Completed',
          value: '$180,000',
          created: '2024-09-05',
          createdBy: 'Maria Garcia',
          category: 'Services',
          projectName: 'Multi-Country Development Initiative'
        },
      ];

      // Global state for lifecycle tracker
      let currentLifecycleLinks = [];
      let currentProcessInfo = {
        id: 'AUTO-GENERATED',
        type: 'RFP',
        title: 'New Tender Process',
        status: 'Draft',
        created: new Date().toISOString().split('T')[0],
        createdBy: 'Current User'
      };

      // Mock data for existing tenders (for cloning feature)
      const existingTenders = [
        {
          id: 'tender-001',
          reference: 'UNOPS-2025-RFP-001',
          title: 'Supply of Medical Equipment for Health Facilities',
          type: 'RFP - Request for Proposal',
          category: 'Goods',
          value: '$250,000',
          status: 'Published',
          created: '15 Jan 2025',
          template: 'RFP - Goods (Standard)',
        },
        {
          id: 'tender-002',
          reference: 'UNOPS-2025-ITB-015',
          title: 'Construction of School Infrastructure in Rural Areas',
          type: 'ITB - Invitation to Bid',
          category: 'Works',
          value: '$1,200,000',
          status: 'Published',
          created: '22 Jan 2025',
          template: 'ITB - Works (Standard)',
        },
        {
          id: 'tender-003',
          reference: 'UNOPS-2025-RFQ-028',
          title: 'Office Supplies and Equipment Procurement',
          type: 'RFQ - Request for Quotation',
          category: 'Goods',
          value: '$45,000',
          status: 'Closed',
          created: '10 Jan 2025',
          template: 'RFQ - Goods & Services',
        },
        {
          id: 'tender-004',
          reference: 'UNOPS-2025-RFP-007',
          title: 'Consultancy Services for Project Management',
          type: 'RFP - Request for Proposal',
          category: 'Services',
          value: '$180,000',
          status: 'Draft',
          created: '5 Feb 2025',
          template: 'RFP - Services (Standard)',
        },
        {
          id: 'tender-005',
          reference: 'UNOPS-2025-ITB-022',
          title: 'Road Rehabilitation Project - Phase 2',
          type: 'ITB - Invitation to Bid',
          category: 'Works',
          value: '$3,500,000',
          status: 'Published',
          created: '28 Jan 2025',
          template: 'ITB - Works (Standard)',
        },
        {
          id: 'tender-006',
          reference: 'UNOPS-2025-RFP-012',
          title: 'IT Equipment and Software Licensing',
          type: 'RFP - Request for Proposal',
          category: 'Goods & Services',
          value: '$320,000',
          status: 'Published',
          created: '18 Jan 2025',
          template: 'RFP - Goods & Services',
        },
      ];

      // ===== TENDER INITIATION FUNCTIONS =====
      function startWithWizard() {
        currentView = 'wizard';
        document.getElementById('initiation-view').classList.remove('active');
        document.getElementById('wizard-view').classList.add('active');
        document.getElementById('page-breadcrumbs').textContent = 'Event Setup ¬∑ Guided Wizard';
        initWizard();
      }

      function startWithTemplate() {
        // Navigate to template library page
        window.location.href = 'template-library.html?action=create-tender';
      }

      function startWithClone() {
        // Show tender selection modal
        showTenderSelectionModal();
      }

      function showTenderSelectionModal() {
        const modal = document.getElementById('tender-selection-modal');
        modal.style.display = 'flex';
        loadExistingTenders();
      }

      function closeTenderSelectionModal() {
        const modal = document.getElementById('tender-selection-modal');
        modal.style.display = 'none';
      }

      function loadExistingTenders() {
        const tenderList = document.getElementById('existing-tenders-list');
        tenderList.innerHTML = '';

        existingTenders.forEach(tender => {
          const tenderCard = document.createElement('div');
          tenderCard.className = 'existing-tender-card';
          tenderCard.onclick = () => selectTenderToClone(tender);
          
          const statusClass = tender.status === 'Published' ? 'success' : 
                              tender.status === 'Draft' ? 'warning' : 'info';
          
          tenderCard.innerHTML = `
            <div class="existing-tender-header">
              <div>
                <div class="existing-tender-title">${tender.title}</div>
                <div class="existing-tender-reference">${tender.reference}</div>
              </div>
              <span class="badge badge-${statusClass}">${tender.status}</span>
            </div>
            <div class="existing-tender-details">
              <div class="existing-tender-meta">
                <span>üìã ${tender.type}</span>
                <span>üí∞ ${tender.value}</span>
                <span>üìÖ ${tender.created}</span>
              </div>
              <div class="existing-tender-template">${tender.template}</div>
            </div>
          `;
          
          tenderList.appendChild(tenderCard);
        });
      }

      function selectTenderToClone(tender) {
        if (confirm(`Clone tender "${tender.title}"?\n\nAll blocks, fields, and configurations will be copied. You can then modify as needed.`)) {
          closeTenderSelectionModal();
          cloneTender(tender);
        }
      }

      function cloneTender(tender) {
        // In real implementation, this would call an API to clone the tender
        console.log('Cloning tender:', tender);
        
        // Show loading
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'loading-overlay';
        loadingMsg.innerHTML = `
          <div class="loading-content">
            <div class="spinner"></div>
            <div>Cloning tender...</div>
          </div>
        `;
        document.body.appendChild(loadingMsg);
        
        // Simulate API call
        setTimeout(() => {
          // Remove loading
          document.body.removeChild(loadingMsg);
          
          // Set wizard data from cloned tender
          wizardData = {
            title: `Copy of ${tender.title}`,
            requirementType: 'goods', // Would come from tender data
            method: tender.type.toLowerCase().split(' ')[0],
            estimatedValue: tender.value.replace(/[^0-9]/g, ''),
            template: tender.template,
          };
          
          selectedTemplate = availableTemplates.find(t => t.name === tender.template) || availableTemplates[0];
          
          // Proactive linking: Automatically link the cloned tender as predecessor
          const sourceProcess = procurementProcesses.find(p => p.id === tender.reference);
          const cloneLinks = [];
          if (sourceProcess) {
            cloneLinks.push({
              process: sourceProcess,
              relationshipType: 'predecessor',
              linkedAt: new Date().toISOString(),
              linkedBy: 'System',
              linkType: 'automatic',
              linkReason: 'Cloned from this process'
            });
          }
          
          // Save clone data to localStorage and redirect
          const tenderInitData = {
            wizardData: wizardData,
            selectedTemplate: selectedTemplate,
            currentProcessInfo: {
              id: `CLONE-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`,
              type: tender.type.split(' ')[0],
              title: wizardData.title,
              status: 'Draft',
              value: wizardData.estimatedValue ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}` : 'TBD',
              created: new Date().toISOString().split('T')[0],
              createdBy: 'Current User',
              category: wizardData.requirementType || 'Goods',
            },
            currentLifecycleLinks: cloneLinks,
            isClone: true,
            sourceReference: tender.reference,
            initiatedAt: new Date().toISOString()
          };
          localStorage.setItem('tenderInitData', JSON.stringify(tenderInitData));
          
          // Redirect to authoring page
          window.location.href = 'tender-authoring.html';
        }, 1500);
      }

      function filterExistingTenders(searchTerm) {
        const filteredTenders = existingTenders.filter(tender => {
          const lowerSearch = searchTerm.toLowerCase();
          return tender.title.toLowerCase().includes(lowerSearch) ||
                 tender.reference.toLowerCase().includes(lowerSearch) ||
                 tender.type.toLowerCase().includes(lowerSearch);
        });
        
        const tenderList = document.getElementById('existing-tenders-list');
        tenderList.innerHTML = '';
        
        if (filteredTenders.length === 0) {
          tenderList.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-2xl); color: var(--text-muted);">
              <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üîç</div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-xs);">No tenders found</div>
              <div style="font-size: 14px;">Try adjusting your search terms</div>
            </div>
          `;
          return;
        }
        
        filteredTenders.forEach(tender => {
          const tenderCard = document.createElement('div');
          tenderCard.className = 'existing-tender-card';
          tenderCard.onclick = () => selectTenderToClone(tender);
          
          const statusClass = tender.status === 'Published' ? 'success' : 
                              tender.status === 'Draft' ? 'warning' : 'info';
          
          tenderCard.innerHTML = `
            <div class="existing-tender-header">
              <div>
                <div class="existing-tender-title">${tender.title}</div>
                <div class="existing-tender-reference">${tender.reference}</div>
              </div>
              <span class="badge badge-${statusClass}">${tender.status}</span>
            </div>
            <div class="existing-tender-details">
              <div class="existing-tender-meta">
                <span>üìã ${tender.type}</span>
                <span>üí∞ ${tender.value}</span>
                <span>üìÖ ${tender.created}</span>
              </div>
              <div class="existing-tender-template">${tender.template}</div>
            </div>
          `;
          
          tenderList.appendChild(tenderCard);
        });
      }

      // ===== PROCUREMENT LIFECYCLE TRACKER FUNCTIONS =====
      function renderLifecycleTracker(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = `
          <div class="lifecycle-tracker-compact">
            <div class="lifecycle-tracker-compact-header">
              <div class="lifecycle-tracker-compact-title">
                <i class="pi pi-link" style="color: var(--primary-500);"></i>
                <span>Related Procurement Processes</span>
                <span class="lifecycle-count-badge" id="lifecycle-count">${currentLifecycleLinks.length}</span>
              </div>
              <button class="btn btn-sm btn-primary" onclick="openLifecycleSearch()">
                <i class="pi pi-plus"></i> Link Process
                </button>
            </div>
            
            <div id="lifecycle-chain-container">
              ${renderLifecycleChainCompact()}
            </div>
          </div>
        `;
      }

      function renderLifecycleChainCompact() {
        if (currentLifecycleLinks.length === 0) {
          return `
            <div class="lifecycle-empty-compact">
              <span style="color: var(--text-muted); font-size: 13px;">No linked processes. Click "Link Process" to connect related procurement events.</span>
            </div>
          `;
        }

        const linkedHtml = currentLifecycleLinks.map(link => {
          const typeColors = {
            'Requisition': 'var(--info-500)',
            'RFI': 'var(--warning-500)',
            'EOI': 'var(--purple-500)',
            'RFQ': 'var(--success-500)',
            'RFP': 'var(--primary-500)',
            'ITB': 'var(--danger-500)',
            'LTA': 'var(--teal-500)',
            'Contract': 'var(--info-600)'
          };
          const color = typeColors[link.process.type] || 'var(--text-muted)';
          const relationLabel = { predecessor: '‚Üê Before', successor: 'After ‚Üí', related: '‚Üî Related' }[link.relationshipType] || 'Related';

          return `
            <div class="lifecycle-linked-item-compact">
              <div class="lifecycle-type-indicator" style="background: ${color};"></div>
              <div class="lifecycle-linked-info">
                <div class="lifecycle-linked-title">${link.process.type}: ${link.process.id}</div>
                <div class="lifecycle-linked-subtitle">${link.process.title}</div>
              </div>
              <span class="lifecycle-relation-badge">${relationLabel}</span>
              <button class="lifecycle-remove-btn" onclick="removeLifecycleLink('${link.process.id}')" title="Remove">
                <i class="pi pi-times"></i>
              </button>
          </div>
        `;
        }).join('');

        return `<div class="lifecycle-linked-list-compact">${linkedHtml}</div>`;
      }

      function renderLifecycleChain() {
        if (currentLifecycleLinks.length === 0) {
          return `
            <div class="lifecycle-empty-state">
              <div class="lifecycle-empty-state-icon">üîó</div>
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">No linked processes yet</div>
              <div style="font-size: 13px;">Click "Link Process" to connect related procurement events</div>
            </div>
          `;
        }

        // Build lifecycle chain
        const allProcesses = [
          ...currentLifecycleLinks.filter(l => l.relationshipType === 'predecessor').map(l => l.process),
          currentProcessInfo,
          ...currentLifecycleLinks.filter(l => l.relationshipType === 'successor').map(l => l.process)
        ];

        const chainHtml = allProcesses.map((process, index) => {
          const isCurrent = process.id === currentProcessInfo.id;
          const isCompleted = process.status === 'Completed' || process.status === 'Closed';
          const nodeClass = isCurrent ? 'current' : (isCompleted ? 'completed' : 'future');
          
          const icon = {
            'Requisition': 'üìã',
            'RFI': '‚ùì',
            'EOI': '‚úâÔ∏è',
            'RFQ': 'üí∞',
            'RFP': 'üìÑ',
            'ITB': 'üèóÔ∏è',
            'LTA': 'üìú',
            'Contract': 'üìù'
          }[process.type] || 'üìå';

          const arrow = index < allProcesses.length - 1 ? 
            `<div class="lifecycle-arrow ${index < allProcesses.indexOf(currentProcessInfo) ? 'active' : ''}">‚Üí</div>` : '';

          return `
            <div class="lifecycle-node ${nodeClass}" onclick="showProcessDetails('${process.id}')">
              <div class="lifecycle-node-badge">${icon}</div>
              <div class="lifecycle-node-label">${process.type}</div>
              <div class="lifecycle-node-id">${process.id}</div>
            </div>
            ${arrow}
          `;
        }).join('');

        return `<div class="lifecycle-chain">${chainHtml}</div>`;
      }

      function renderLinkedProcesses() {
        if (currentLifecycleLinks.length === 0) {
          return '';
        }

        const processesHtml = currentLifecycleLinks.map(link => {
          const relationshipClass = `relationship-${link.relationshipType}`;
          const relationshipLabel = {
            'predecessor': 'Predecessor',
            'successor': 'Successor',
            'related': 'Related'
          }[link.relationshipType] || 'Related';

          return `
            <div class="linked-process-item">
              <div class="linked-process-info">
                <div class="linked-process-title">
                  ${link.process.title}
                  <span class="lifecycle-relationship-type ${relationshipClass}">${relationshipLabel}</span>
                </div>
                <div class="linked-process-meta">
                  <span>üÜî ${link.process.id}</span>
                  <span>üìã ${link.process.type}</span>
                  <span>üìÖ ${link.process.created}</span>
                  <span>üë§ ${link.process.createdBy}</span>
                </div>
              </div>
              <div class="linked-process-actions">
                <button class="btn-link-action" onclick="viewLinkedProcess('${link.process.id}')">View</button>
                <button class="btn-link-action remove" onclick="removeLifecycleLink('${link.process.id}')">Remove</button>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="linked-processes-list">
            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-md); text-transform: uppercase; letter-spacing: 0.08em;">
              Linked Processes (${currentLifecycleLinks.length})
            </div>
            ${processesHtml}
          </div>
        `;
      }

      function renderAuditTrail() {
        const auditEvents = [
          { action: 'Process created', user: 'Current User', timestamp: new Date().toISOString() },
          ...currentLifecycleLinks.map(link => ({
            action: `Linked to ${link.process.type} (${link.process.id}) as ${link.relationshipType}`,
            user: 'Current User',
            timestamp: link.linkedAt || new Date().toISOString()
          }))
        ];

        if (auditEvents.length === 0) {
          return '<div style="font-size: 13px; color: var(--text-muted);">No audit events yet</div>';
        }

        return auditEvents.map(event => {
          const date = new Date(event.timestamp);
          const timeStr = date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          return `
            <div class="lifecycle-audit-item">
              <span>${event.action}</span>
              <span style="color: var(--text-muted); margin-left: auto;">by ${event.user}</span>
              <span class="lifecycle-audit-timestamp">${timeStr}</span>
            </div>
          `;
        }).join('');
      }

      function openLifecycleSearch() {
        const modal = document.getElementById('lifecycle-search-modal');
        modal.style.display = 'flex';
        loadProcurementProcesses();
      }

      function closeLifecycleSearch() {
        const modal = document.getElementById('lifecycle-search-modal');
        modal.style.display = 'none';
      }

      function loadProcurementProcesses(searchTerm = '') {
        const resultsContainer = document.getElementById('lifecycle-search-results');
        
        let filteredProcesses = procurementProcesses;
        if (searchTerm) {
          filteredProcesses = procurementProcesses.filter(process => {
            const search = searchTerm.toLowerCase();
            return process.id.toLowerCase().includes(search) ||
                   process.title.toLowerCase().includes(search) ||
                   process.type.toLowerCase().includes(search);
          });
        }

        // Exclude already linked processes
        const linkedIds = currentLifecycleLinks.map(l => l.process.id);
        filteredProcesses = filteredProcesses.filter(p => !linkedIds.includes(p.id));

        if (filteredProcesses.length === 0) {
          resultsContainer.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <div style="font-size: 40px; margin-bottom: var(--spacing-md);">üîç</div>
              <div>No processes found</div>
            </div>
          `;
          return;
        }

        resultsContainer.innerHTML = filteredProcesses.map(process => {
          const statusClass = process.status === 'Completed' ? 'success' : 
                             process.status === 'Active' ? 'success' :
                             process.status === 'Published' ? 'info' : 'warning';
          
          return `
            <div class="lifecycle-search-result" onclick="selectProcessToLink('${process.id}')">
              <div class="lifecycle-search-result-title">
                ${process.title}
                <span class="badge badge-${statusClass}" style="margin-left: 8px;">${process.status}</span>
              </div>
              <div class="lifecycle-search-result-meta">
                <span>üÜî ${process.id}</span>
                <span>üìã ${process.type}</span>
                <span>üí∞ ${process.value}</span>
                <span>üìÖ ${process.created}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      function searchLifecycleProcesses(searchTerm) {
        loadProcurementProcesses(searchTerm);
      }

      function selectProcessToLink(processId) {
        const process = procurementProcesses.find(p => p.id === processId);
        if (!process) return;

        // Show relationship type selection
        const relationshipType = prompt(
          `Link "${process.title}" as:\n\n1. Predecessor (this process comes after)\n2. Successor (this process comes before)\n3. Related (parallel or associated process)\n\nEnter 1, 2, or 3:`,
          '1'
        );

        let type = 'related';
        if (relationshipType === '1') type = 'predecessor';
        else if (relationshipType === '2') type = 'successor';
        else if (relationshipType === '3') type = 'related';

        // Add to lifecycle links
        currentLifecycleLinks.push({
          process: process,
          relationshipType: type,
          linkedAt: new Date().toISOString(),
          linkedBy: 'Current User',
          linkType: 'manual' // or 'automatic' for proactive linking
        });

        closeLifecycleSearch();
        refreshLifecycleView();

        // Show success message
        showNotification(`Successfully linked ${process.type} (${process.id})`, 'success');
      }

      function removeLifecycleLink(processId) {
        if (!confirm('Remove this linked process?')) return;

        currentLifecycleLinks = currentLifecycleLinks.filter(link => link.process.id !== processId);
        refreshLifecycleView();
        showNotification('Link removed', 'info');
      }

      function refreshLifecycleView() {
        const chainContainer = document.getElementById('lifecycle-chain-container');
        const countBadge = document.getElementById('lifecycle-count');

        if (chainContainer) chainContainer.innerHTML = renderLifecycleChainCompact();
        if (countBadge) countBadge.textContent = currentLifecycleLinks.length;
      }

      function showProcessDetails(processId) {
        const process = procurementProcesses.find(p => p.id === processId) || 
                       (processId === currentProcessInfo.id ? currentProcessInfo : null);
        
        if (!process) return;

        alert(`Process Details:\n\nID: ${process.id}\nType: ${process.type}\nTitle: ${process.title}\nStatus: ${process.status}\nValue: ${process.value || 'N/A'}\nCreated: ${process.created}\nCreated By: ${process.createdBy}`);
      }

      function viewLinkedProcess(processId) {
        showProcessDetails(processId);
      }

      function showNotification(message, type = 'info') {
        // Simple notification - in real app, use proper toast/notification system
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          padding: 16px 24px;
          background: var(--surface-0);
          border: 1px solid var(--${type === 'success' ? 'success' : 'info'}-400);
          border-left: 4px solid var(--${type === 'success' ? 'success' : 'info'}-500);
          border-radius: 8px;
          box-shadow: var(--shadow-lg);
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      }

      // Proactive linking when creating from existing process
      function linkFromClonedTender(sourceTender) {
        // When a tender is cloned, automatically link it as a successor
        const sourceProcess = procurementProcesses.find(p => p.reference === sourceTender.reference);
        if (sourceProcess) {
          currentLifecycleLinks.push({
            process: sourceProcess,
            relationshipType: 'predecessor',
            linkedAt: new Date().toISOString(),
            linkedBy: 'System (Auto-linked on clone)',
            linkType: 'automatic'
          });
          refreshLifecycleView();
        }
      }

      // ===== WIZARD FUNCTIONS =====
      function initWizard() {
        updateWizardStepDisplay();
        setupWizardEventListeners();
      }

      function setupWizardEventListeners() {
        document.getElementById('wizard-next-btn').addEventListener('click', () => {
          if (validateWizardStep()) {
            if (wizardStep < totalWizardSteps) {
              goToWizardStep(wizardStep + 1);
            } else {
              initiateTender();
            }
          }
        });

        document.getElementById('wizard-prev-btn').addEventListener('click', () => {
          if (wizardStep > 1) {
            goToWizardStep(wizardStep - 1);
          }
        });

        document.getElementById('requirement-type')?.addEventListener('change', collectWizardData);
        document.getElementById('sourcing-type')?.addEventListener('change', collectWizardData);
        document.getElementById('method')?.addEventListener('change', collectWizardData);
        document.getElementById('estimated-value')?.addEventListener('input', collectWizardData);
      }

      function collectWizardData() {
        wizardData = {
          requirementType: document.getElementById('requirement-type')?.value || '',
          sourcingType: document.getElementById('sourcing-type')?.value || '',
          method: document.getElementById('method')?.value || '',
          estimatedValue: document.getElementById('estimated-value')?.value || '',
          projectType: document.getElementById('project-type')?.value || '',
          country: Array.from(document.getElementById('country')?.selectedOptions || []).map(opt => opt.value),
          description: document.getElementById('description')?.value || '',
        };
      }

      function validateWizardStep() {
        if (wizardStep === 1) {
          const requirementType = document.getElementById('requirement-type')?.value;
          const sourcingType = document.getElementById('sourcing-type')?.value;
          const method = document.getElementById('method')?.value;
          const estimatedValue = document.getElementById('estimated-value')?.value;

          if (!requirementType || !sourcingType || !method || !estimatedValue) {
            alert('Please fill in all required fields');
            return false;
          }
          collectWizardData();
          return true;
        } else if (wizardStep === 2) {
          if (!selectedTemplate) {
            alert('Please select a template to continue');
            return false;
          }
          return true;
        } else if (wizardStep === 3) {
          const title = document.getElementById('tender-title')?.value;
          if (!title) {
            alert('Please enter a tender title');
            return false;
          }
          return true;
        }
        return true;
      }

      function goToWizardStep(step) {
        wizardStep = step;

        if (step === 2) {
          collectWizardData();
          suggestTemplates();
        } else if (step === 3) {
          populateReviewStep();
        }

        updateWizardStepDisplay();
      }

      function suggestTemplates() {
        const cardsContainer = document.getElementById('template-cards');
        cardsContainer.innerHTML = '';

        const suggestedTemplates = availableTemplates
          .map((template) => {
            let score = 0;

            if (wizardData.requirementType === 'goods' && template.category === 'Goods') score += 30;
            if (wizardData.requirementType === 'services' && template.category === 'Services') score += 30;
            if (wizardData.requirementType === 'works' && template.category === 'Works') score += 30;
            if (wizardData.requirementType === 'goods-services' && template.category === 'Goods & Services') score += 30;

            const methodMap = {
              itb: 'ITB',
              rfp: 'RFP',
              rfq: 'RFQ',
            };
            if (methodMap[wizardData.method] === template.method) score += 40;

            const value = parseFloat(wizardData.estimatedValue) || 0;
            if (value > 100000 && template.method === 'RFP') score += 20;
            if (value < 50000 && template.method === 'RFQ') score += 20;

            return { ...template, calculatedScore: score };
          })
          .filter((t) => t.calculatedScore > 0)
          .sort((a, b) => b.calculatedScore - a.calculatedScore)
          .slice(0, 3);

        document.getElementById('suggestion-count').textContent = `${suggestedTemplates.length} matches`;

        suggestedTemplates.forEach((template, index) => {
          const card = document.createElement('div');
          card.className = `template-card ${index === 0 ? 'recommended' : ''}`;
          if (index === 0) {
            selectedTemplate = template;
            card.classList.add('selected');
          }
          card.innerHTML = `
            <div class="template-card-header">
              <div class="template-icon">${template.icon}</div>
              <div class="template-info">
                <div class="template-name">${template.name}</div>
                <div class="template-type">${template.type} ¬∑ ${template.category}</div>
              </div>
            </div>
            <div class="template-description">${template.description}</div>
            <div class="template-meta">
              <div class="template-meta-item">
                <span>üìä</span>
                <span>Match: ${template.calculatedScore}%</span>
              </div>
            </div>
          `;

          card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach((c) => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTemplate = template;
          });

          cardsContainer.appendChild(card);
        });
      }

      function populateReviewStep() {
        const methodMap = {
          itb: 'ITB - Invitation to Bid',
          rfp: 'RFP - Request for Proposal',
          rfq: 'RFQ - Request for Quotation',
          eoi: 'EOI - Expression of Interest',
          direct: 'Direct Contracting',
        };

        const requirementMap = {
          goods: 'Goods',
          services: 'Services',
          works: 'Works',
          'goods-services': 'Goods & Services',
        };

        document.getElementById('selected-template-display').value = selectedTemplate?.name || '';
        document.getElementById('review-requirement-type').value = requirementMap[wizardData.requirementType] || '';
        document.getElementById('review-method').value = methodMap[wizardData.method] || '';
        document.getElementById('review-value').value = wizardData.estimatedValue
          ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}`
          : '';
      }

      function updateWizardStepDisplay() {
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.remove('active', 'completed');
          if (stepNum < wizardStep) {
            step.classList.add('completed');
          } else if (stepNum === wizardStep) {
            step.classList.add('active');
          }
        });

        document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
          const stepNum = index + 1;
          content.classList.remove('active');
          if (stepNum === wizardStep) {
            content.classList.add('active');
          }
        });

        const prevBtn = document.getElementById('wizard-prev-btn');
        const nextBtn = document.getElementById('wizard-next-btn');

        prevBtn.style.display = wizardStep > 1 ? 'inline-flex' : 'none';
        nextBtn.textContent = wizardStep === totalWizardSteps ? 'Initiate Tender' : 'Next';
        nextBtn.disabled = false;
      }

      function initiateTender() {
        const title = document.getElementById('tender-title')?.value;
        if (!title) {
          alert('Please enter a tender title');
          return;
        }

        const nextBtn = document.getElementById('wizard-next-btn');
        nextBtn.disabled = true;
        nextBtn.textContent = 'Initiating...';

        // Add title to wizard data
        wizardData.title = title;
        wizardData.template = selectedTemplate;

        // Update current process info for lifecycle tracker
        const methodMap = {
          itb: 'ITB',
          rfp: 'RFP',
          rfq: 'RFQ',
          eoi: 'EOI',
          direct: 'Direct Contracting',
        };
        const currentProcessInfo = {
          id: `${methodMap[wizardData.method] || 'PROC'}-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`,
          type: methodMap[wizardData.method] || 'RFP',
          title: title,
          status: 'Draft',
          value: wizardData.estimatedValue ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}` : 'TBD',
          created: new Date().toISOString().split('T')[0],
          createdBy: 'Current User',
          category: wizardData.requirementType || 'Goods',
        };

        // Save wizard data and process info to localStorage for the authoring page
        const tenderInitData = {
          wizardData: wizardData,
          selectedTemplate: selectedTemplate,
          currentProcessInfo: currentProcessInfo,
          currentLifecycleLinks: currentLifecycleLinks || [],
          initiatedAt: new Date().toISOString()
        };
        localStorage.setItem('tenderInitData', JSON.stringify(tenderInitData));

        // Redirect to authoring page
        setTimeout(() => {
          window.location.href = 'tender-authoring.html';
        }, 500);
      }

      function populateTemplateBlocks() {
        // Pre-populate General Information
        if (templateBlocks[0] && templateBlocks[0].id === 'general') {
          const generalSection = templateBlocks[0].sections[0];
          if (generalSection) {
            const titleField = generalSection.fields.find(f => f.label === 'Title');
            if (titleField && wizardData.title) {
              titleField.value = wizardData.title;
            }

            const sourcingField = generalSection.fields.find(f => f.label === 'Sourcing or Solicitation?');
            if (sourcingField && wizardData.sourcingType) {
              const sourcingValue = wizardData.sourcingType.charAt(0).toUpperCase() + wizardData.sourcingType.slice(1);
              if (sourcingField.options.includes(sourcingValue)) {
                sourcingField.options = [sourcingValue, ...sourcingField.options.filter(o => o !== sourcingValue && o !== 'Select...')];
              }
            }

            const requirementField = generalSection.fields.find(f => f.label === 'Type of Requirement');
            if (requirementField && wizardData.requirementType) {
              const requirementMap = {
                goods: 'Goods',
                services: 'Services',
                works: 'Works',
                'goods-services': 'Goods & Services',
              };
              const requirementValue = requirementMap[wizardData.requirementType] || 'Goods';
              if (requirementField.options.includes(requirementValue)) {
                requirementField.options = [requirementValue, ...requirementField.options.filter(o => o !== requirementValue && o !== 'Select...')];
              }
            }

            const descriptionField = generalSection.fields.find(f => f.label === 'Description');
            if (descriptionField && wizardData.description) {
              descriptionField.value = wizardData.description;
            }
          }
        }

        // Pre-populate Requisition Details
        if (templateBlocks[2] && templateBlocks[2].id === 'requisition' && wizardData.estimatedValue) {
          const requisitionSection = templateBlocks[2].sections[0];
          if (requisitionSection) {
            const valueField = requisitionSection.fields.find(f => f.label === 'Amount/expected value of contract (USD)');
            if (valueField) {
              valueField.value = wizardData.estimatedValue;
            }
          }
        }
      }

      function switchToAuthoringView() {
        currentView = 'authoring';

        // Update UI
        document.getElementById('wizard-view').classList.remove('active');
        document.getElementById('authoring-view').classList.add('active');

        // Update top bar
        document.getElementById('page-title').textContent = 'Procurement Portal | Tender Authoring';
        const methodMap = {
          itb: 'ITB',
          rfp: 'RFP',
          rfq: 'RFQ',
          eoi: 'EOI',
          direct: 'Direct Contracting',
        };
        const requirementMap = {
          goods: 'Goods',
          services: 'Services',
          works: 'Works',
          'goods-services': 'Goods & Services',
        };
        document.getElementById('page-breadcrumbs').textContent = `${methodMap[wizardData.method] || 'Tender'} ¬∑ ${requirementMap[wizardData.requirementType] || 'Goods'} ¬∑ Draft`;

        // Update top actions
        const topActions = document.getElementById('top-actions');
        topActions.innerHTML = `
          <button class="btn btn-ghost">Preview</button>
          <button class="btn btn-ghost">üíæ Save Draft</button>
          <button class="btn btn-ghost" onclick="downloadTenderPackage()" title="Download all documents as ZIP">üì¶ Download Package</button>
          <button class="btn btn-primary">Submit for Review</button>
        `;
        
        // Ensure form library is visible by default
        const formLibraryPanel = document.getElementById('form-library-panel');
        if (formLibraryPanel) {
          formLibraryPanel.classList.remove('collapsed');
        }

        // Initialize authoring
        initAuthoring();
        showSuccessMessage();
      }

      function showSuccessMessage() {
        const contentWrapper = document.getElementById('content-wrapper');
        const successAlert = document.createElement('div');
        successAlert.className = 'info-alert';
        successAlert.style.marginBottom = 'var(--spacing-lg)';
        successAlert.innerHTML = `
          <div class="info-alert-text">
            ‚úÖ Tender "${wizardData.title}" successfully initiated! You can now complete all the details below.
          </div>
        `;
        contentWrapper.insertBefore(successAlert, contentWrapper.firstChild);

        setTimeout(() => {
          successAlert.style.transition = 'opacity 0.3s ease';
          successAlert.style.opacity = '0';
          setTimeout(() => successAlert.remove(), 300);
        }, 5000);
      }

      // ===== FORM LIBRARY FUNCTIONS =====
      function toggleFormLibrary() {
        const panel = document.getElementById('form-library-panel');
        const toggleBtn = panel.querySelector('.toggle-library-btn');
        panel.classList.toggle('collapsed');
        
        if (panel.classList.contains('collapsed')) {
          toggleBtn.textContent = 'üìö';
          toggleBtn.title = 'Expand';
        } else {
          toggleBtn.textContent = '‚úï';
          toggleBtn.title = 'Collapse';
        }
      }

      // ===== DOWNLOAD TENDER PACKAGE =====
      function downloadTenderPackage() {
        // Show loading state
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><span style="animation: spin 1s linear infinite; display: inline-block;">‚è≥</span> Preparing Package...</span>';
        
        // Simulate package preparation (in real implementation, this would:
        // 1. Collect all tender documents
        // 2. Generate PDFs from form data
        // 3. Include uploaded files
        // 4. Create a manifest/index
        // 5. Zip everything together
        // 6. Trigger download)
        setTimeout(() => {
          // Show success notification
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-500);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
          `;
          notification.innerHTML = `
            <span style="font-size: 20px;">‚úÖ</span>
            <div>
              <div style="font-weight: 600; margin-bottom: 2px;">Tender Package Ready</div>
              <div style="font-size: 13px; opacity: 0.9;">tender-package-${Date.now()}.zip</div>
            </div>
          `;
          document.body.appendChild(notification);
          
          // In a real implementation, trigger the actual download here:
          // const link = document.createElement('a');
          // link.href = packageBlobUrl;
          // link.download = `tender-package-${wizardData.tenderId || Date.now()}.zip`;
          // link.click();
          
          // Remove notification after 4 seconds
          setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 4000);
          
          // Reset button
          btn.disabled = false;
          btn.innerHTML = originalText;
        }, 2000);
      }

      function setupFormLibrary() {
        // Setup drag and drop for form library items
        const formItems = document.querySelectorAll('.form-library-item');
        formItems.forEach((item) => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('form-type', item.dataset.formType);
            e.dataTransfer.setData('form-name', item.dataset.formName);
            item.style.opacity = '0.5';
          });

          item.addEventListener('dragend', (e) => {
            item.style.opacity = '1';
          });
        });

        // Setup search
        const searchInput = document.getElementById('form-library-search');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            formItems.forEach((item) => {
              const text = item.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                item.style.display = 'block';
              } else {
                item.style.display = 'none';
              }
            });
          });
        }
      }

      function setupDropZones() {
        // Setup drop zones in section bodies and explicit drop zones
        document.querySelectorAll('.section-body, .form-drop-zone').forEach((dropZone) => {
          // Remove existing listeners to avoid duplicates
          const newDropZone = dropZone.cloneNode(true);
          dropZone.parentNode.replaceChild(newDropZone, dropZone);
          
          newDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            newDropZone.classList.add('active');
          });

          newDropZone.addEventListener('dragleave', (e) => {
            if (!newDropZone.contains(e.relatedTarget)) {
              newDropZone.classList.remove('active');
            }
          });

          newDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            newDropZone.classList.remove('active');

            const formType = e.dataTransfer.getData('form-type');
            const formName = e.dataTransfer.getData('form-name');

            if (formType && formName) {
              // If dropped on explicit drop zone, use its parent section body
              const sectionBody = newDropZone.classList.contains('form-drop-zone') 
                ? newDropZone.closest('.section-body') || newDropZone.parentElement
                : newDropZone;
              addFormToSection(sectionBody, formType, formName);
            }
          });
        });
      }

      function addFormToSection(sectionBody, formType, formName) {
        const block = templateBlocks[currentBlockIndex];
        // Find the section index more reliably
        const formSection = sectionBody.closest('.form-section');
        if (!formSection) {
          console.error('Could not find form section');
          return;
        }
        // Get all sections for the current block only
        const contentWrapper = document.getElementById('content-wrapper');
        const allSections = Array.from(contentWrapper.querySelectorAll('.form-section'));
        const sectionIndex = allSections.indexOf(formSection);
        
        if (sectionIndex === -1) {
          console.error('Could not determine section index');
          return;
        }

        // Initialize forms array for this block/section if needed
        if (!addedForms[block.id]) {
          addedForms[block.id] = {};
        }
        if (!addedForms[block.id][sectionIndex]) {
          addedForms[block.id][sectionIndex] = [];
        }

        // Check if form already exists
        const existingForm = addedForms[block.id][sectionIndex].find(f => f.type === formType);
        if (existingForm) {
          alert('This form has already been added to this section');
          return;
        }

        // Add form to storage
        const formData = {
          type: formType,
          name: formName,
          id: `form-${Date.now()}`,
        };
        addedForms[block.id][sectionIndex].push(formData);

        // Create form display element
        const formElement = document.createElement('div');
        formElement.className = 'added-form-item';
        formElement.dataset.formId = formData.id;
        formElement.innerHTML = `
          <div class="added-form-info">
            <div class="added-form-icon">üìÑ</div>
            <div class="added-form-details">
              <div class="added-form-name">${formName}</div>
              <div class="added-form-type">Form Document</div>
            </div>
          </div>
          <div class="added-form-actions">
            <button class="form-action-btn" onclick="previewForm('${formData.id}')" title="Preview">üëÅ</button>
            <button class="form-action-btn danger" onclick="removeForm('${formData.id}')" title="Remove">‚úñ</button>
          </div>
        `;

        // Find or create drop zone
        let dropZone = sectionBody.querySelector('.form-drop-zone');
        if (!dropZone) {
          dropZone = document.createElement('div');
          dropZone.className = 'form-drop-zone';
          dropZone.textContent = 'Drop forms here';
          sectionBody.appendChild(dropZone);
        }

        // Insert form before drop zone
        sectionBody.insertBefore(formElement, dropZone);

        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'info-alert';
        successMsg.style.marginTop = 'var(--spacing-md)';
        successMsg.innerHTML = `
          <div class="info-alert-text">
            ‚úÖ ${formName} added successfully
          </div>
        `;
        sectionBody.insertBefore(successMsg, formElement.nextSibling);

        setTimeout(() => {
          successMsg.style.transition = 'opacity 0.3s ease';
          successMsg.style.opacity = '0';
          setTimeout(() => successMsg.remove(), 300);
        }, 2000);
      }

      function previewForm(formId) {
        // Find form data
        let formData = null;
        for (const blockId in addedForms) {
          for (const sectionIndex in addedForms[blockId]) {
            const form = addedForms[blockId][sectionIndex].find(f => f.id === formId);
            if (form) {
              formData = form;
              break;
            }
          }
          if (formData) break;
        }

        if (formData) {
          alert(`Preview: ${formData.name}\n\nThis would open a preview modal or new window showing the form/document template.`);
        }
      }

      function removeForm(formId) {
        if (!confirm('Remove this form from the tender?')) {
          return;
        }

        // Find and remove form from storage
        for (const blockId in addedForms) {
          for (const sectionIndex in addedForms[blockId]) {
            const index = addedForms[blockId][sectionIndex].findIndex(f => f.id === formId);
            if (index !== -1) {
              addedForms[blockId][sectionIndex].splice(index, 1);
              // Remove from DOM
              const formElement = document.querySelector(`[data-form-id="${formId}"]`);
              if (formElement) {
                formElement.remove();
              }
              return;
            }
          }
        }
      }

      // ===== REQUISITION LINES & LOTS FUNCTIONS =====
      function renderRequisitionLotsSection(block, section, sectionIndex, isFirst) {
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get unique UNSPSC codes from requisition lines for reference
        const requisitionUnspscCodes = [...new Set(requisitionLines.map(line => line.unspscCode))];
        const totalValue = requisitionLines.reduce((sum, line) => sum + line.amount, 0);
        const totalProducts = lots.reduce((sum, lot) => sum + lot.unspscCodes.length, 0);
        
        // Determine if lots section should be visible
        const showLotsSection = allowPartialQuotations === 'Yes';
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              <!-- Summary Stats -->
              <div class="summary-stats-row">
                <div class="stat-item">
                  <div class="stat-value">${requisitionLines.length}</div>
                  <div class="stat-label">Req. Lines</div>
              </div>
                <div class="stat-item" style="${showLotsSection ? '' : 'opacity: 0.4;'}">
                  <div class="stat-value">${lots.length}</div>
                  <div class="stat-label">Lots</div>
            </div>
                <div class="stat-item" style="${showLotsSection ? '' : 'opacity: 0.4;'}">
                  <div class="stat-value">${totalProducts}</div>
                  <div class="stat-label">Products</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">$${(totalValue/1000).toFixed(0)}K</div>
                  <div class="stat-label">Total Value</div>
                </div>
              </div>
              
              <!-- Requisition Lines - Collapsible (collapsed by default) -->
              <div class="collapsible-section collapsed" id="req-lines-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('req-lines-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Requisition Lines</span>
                    <span class="badge badge-info" style="margin-left: 6px; font-size: 10px;">${requisitionLines.length}</span>
                    ${renderSectionProgress('req-lines', requisitionLines)}
                  </div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); openAddReqLineModal()"><i class="pi pi-plus"></i> Add Line</button>
                    <div class="collapsible-toggle">‚ñº</div>
                  </div>
                </div>
                <div class="collapsible-body">
                  <div style="overflow-x: auto;">
                    <table class="req-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                          <th>UNSPSC</th>
                        <th>Description</th>
                          <th>Qty</th>
                        <th>Amount</th>
                          <th style="width: 60px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${requisitionLines.map(line => `
                        <tr data-line-id="${line.id}">
                            <td><span class="req-id">${line.id}</span></td>
                          <td>
                              <div class="req-unspsc">${line.unspscCode}</div>
                              <div class="req-unspsc-desc">${line.unspscDescription}</div>
                          </td>
                            <td style="max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${line.description}">${line.description}</td>
                            <td>${line.quantity} ${line.unitOfMeasure}</td>
                            <td><span class="req-amount">${line.currency} ${line.amount.toLocaleString()}</span></td>
                            <td>
                              <button class="req-remove-btn" onclick="removeRequisitionLine('${line.id}')" title="Remove line">üóëÔ∏è</button>
                            </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
                </div>
              
              <!-- Partial Quotations/Bids/Proposals - Collapsible -->
              <div class="collapsible-section" id="partial-quotations-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('partial-quotations-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Partial Quotations/Bids/Proposals</span>
                    ${allowPartialQuotations ? `<span class="badge ${allowPartialQuotations === 'Yes' ? 'badge-success' : 'badge-secondary'}" style="margin-left: 8px; font-size: 10px;">${allowPartialQuotations}</span>` : ''}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">
                        Are partial quotations/bids/proposals allowed? <span class="required">*</span>
                      </label>
                      <select class="form-select" onchange="updateAllowPartialQuotations(this.value)" style="max-width: 300px;">
                        <option value="" ${allowPartialQuotations === '' ? 'selected' : ''}>Select...</option>
                        <option value="Yes" ${allowPartialQuotations === 'Yes' ? 'selected' : ''}>Yes - Allow partial quotations (Lots enabled)</option>
                        <option value="No" ${allowPartialQuotations === 'No' ? 'selected' : ''}>No - Full quotation required (No lots)</option>
                      </select>
                      <span class="help-text">If Yes, suppliers can submit bids for individual lots. If No, suppliers must bid on all items.</span>
                    </div>
                  </div>
                </div>
              </div>
                
              <!-- Lots Management - Collapsible (only shown when partial quotations allowed) -->
              ${showLotsSection ? `
              <div class="collapsible-section collapsed" id="lots-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('lots-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Lots</span>
                    <span class="badge badge-info" style="margin-left: 6px; font-size: 10px;">${lots.length}</span>
                    ${renderSectionProgress('lots', lots)}
                  </div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); downloadLotsTemplate()" title="Download Excel template for bulk import"><i class="pi pi-download"></i> Template</button>
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); document.getElementById('lots-upload-input').click()" title="Upload Excel file to bulk import lots"><i class="pi pi-upload"></i> Upload</button>
                    <input type="file" id="lots-upload-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleLotsUpload(event)" />
                    <button class="btn btn-primary" onclick="event.stopPropagation(); openCreateLotModal()"><i class="pi pi-plus"></i> Create Lot</button>
                    <div class="collapsible-toggle">‚ñº</div>
                  </div>
                </div>
                <div class="collapsible-body">
                  ${lots.length === 0 ? `
                    <div class="lot-empty-state" style="padding: var(--spacing-lg);">
                      <div style="font-size: 28px; margin-bottom: var(--spacing-xs);">üì¶</div>
                      <div style="font-weight: 600; font-size: 13px; margin-bottom: var(--spacing-xs);">No lots created yet</div>
                      <div style="color: var(--text-muted); font-size: 11px; margin-bottom: var(--spacing-md);">Create lots to organize products or proceed without lots</div>
                      <button class="btn btn-primary" onclick="openCreateLotModal()"><i class="pi pi-plus"></i> Create First Lot</button>
                        </div>
                  ` : `
                    <div style="overflow-x: auto;">
                      <table class="lots-table">
                        <thead>
                          <tr>
                            <th style="width: 60px;">Lot</th>
                            <th style="width: 150px;">Name</th>
                            <th style="width: 180px;">Description</th>
                            <th>Products</th>
                            <th style="width: 50px;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${lots.map((lot, lotIndex) => `
                            <tr data-lot-id="${lot.id}">
                              <td><span class="lot-number-badge">${lotIndex + 1}</span></td>
                              <td><span class="lot-name-cell">${lot.name || 'Unnamed Lot'}</span></td>
                              <td><span class="lot-desc-cell" title="${lot.description || ''}">${lot.description || '-'}</span></td>
                              <td>
                                <div class="lot-products-cell">
                            ${lot.unspscCodes.length === 0 ? `
                                    <span class="no-products-text">No products</span>
                            ` : `
                                    <div class="product-tags-container">
                                ${lot.unspscCodes.map((unspsc, idx) => `
                                        <div class="product-tag">
                                          <span class="product-tag-code">${unspsc.code}</span>
                                          <span class="product-tag-name" title="${unspsc.description || ''}">${unspsc.description ? unspsc.description.substring(0, 20) + (unspsc.description.length > 20 ? '...' : '') : ''}</span>
                                          ${unspsc.quantity ? `<span class="product-tag-qty">√ó${unspsc.quantity}</span>` : ''}
                                          ${unspsc.estimatedValue ? `<span class="product-tag-value">$${unspsc.estimatedValue.toLocaleString()}</span>` : ''}
                                          <button class="product-tag-remove" onclick="removeProductFromLot('${lot.id}', ${idx})" title="Remove">√ó</button>
                                  </div>
                                `).join('')}
                              </div>
                            `}
                          </div>
                              </td>
                              <td>
                                <div class="lot-actions-menu-wrapper">
                                  <button class="lot-actions-btn" onclick="toggleLotActionsMenu('${lot.id}')" title="Actions">‚ãÆ</button>
                                  <div class="lot-actions-dropdown" id="lot-menu-${lot.id}">
                                    <button class="lot-action-item" onclick="openAddProductModal('${lot.id}')">
                                      <span class="lot-action-icon">‚ûï</span> Add Products
                                    </button>
                                    <button class="lot-action-item" onclick="openEditLotModal('${lot.id}')">
                                      <span class="lot-action-icon">‚úèÔ∏è</span> Edit Lot
                                    </button>
                                    <button class="lot-action-item danger" onclick="deleteLot('${lot.id}')">
                                      <span class="lot-action-icon">üóëÔ∏è</span> Remove Lot
                                    </button>
                        </div>
                      </div>
                              </td>
                            </tr>
                    `).join('')}
                        </tbody>
                      </table>
                  </div>
                `}
              </div>
                </div>
              ` : `
              <!-- Lots Section Hidden - show info message -->
              <div class="info-alert" style="margin-top: var(--spacing-md); background: var(--surface-50); border-color: var(--surface-200);">
                <div class="info-alert-text" style="color: var(--text-muted);">
                  <i class="pi pi-info-circle" style="margin-right: 6px;"></i>
                  Lots management is disabled. To enable lots, select <strong>"Yes"</strong> in the "Partial Quotations/Bids/Proposals" section above.
                </div>
              </div>
              `}
            </div>
          </div>
        `;
      }
      
      // Update function for Partial Quotations field
      window.updateAllowPartialQuotations = function(value) {
        allowPartialQuotations = value;
        // Re-render the section to show/hide lots
        renderCurrentBlock();
      }
      
      window.createNewLot = function() {
        const lotName = prompt('Enter lot name:');
        if (!lotName) return;
        
        const newLot = {
          id: 'lot-' + Date.now(),
          name: lotName,
          unspscCodes: [], // Array of { code, description }
        };
        
        lots.push(newLot);
        renderCurrentBlock();
      }
      
      window.updateLotName = function(lotId, newName) {
        const lot = lots.find(l => l.id === lotId);
        if (lot) {
          lot.name = newName;
        }
      }
      
      window.deleteLot = function(lotId) {
        if (!confirm('Are you sure you want to delete this lot?')) {
          return;
        }
        
        lots = lots.filter(l => l.id !== lotId);
        renderCurrentBlock();
      }
      
      // Remove Requisition Line
      window.removeRequisitionLine = function(lineId) {
        if (!confirm('Are you sure you want to remove this requisition line?')) {
          return;
        }
        
        requisitionLines = requisitionLines.filter(l => l.id !== lineId);
        renderCurrentBlock();
        showNotification('Requisition line removed', 'success');
      }
      
      // Download Lots Template
      window.downloadLotsTemplate = function() {
        // Create CSV template content
        const templateHeaders = ['Lot Name', 'Lot Description', 'UNSPSC Code', 'Product Description', 'Quantity', 'Estimated Value (USD)'];
        const exampleRows = [
          ['IT Equipment Lot', 'All IT hardware items', '43211503', 'Laptop computers', '50', '75000'],
          ['IT Equipment Lot', 'All IT hardware items', '43212105', 'Computer monitors', '50', '15000'],
          ['Office Supplies Lot', 'General office supplies', '44121700', 'Office supplies', '100', '5000'],
          ['Furniture Lot', 'Office furniture items', '56101500', 'Office desks', '25', '12500'],
        ];
        
        // Build CSV content
        let csvContent = templateHeaders.join(',') + '\n';
        csvContent += '# Instructions: Fill in the rows below. Each row represents one product in a lot.\n';
        csvContent += '# Products with the same Lot Name will be grouped into the same lot.\n';
        csvContent += '# Delete these instruction lines before uploading.\n';
        exampleRows.forEach(row => {
          csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });
        
        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'lots_template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Template downloaded! Fill it out and upload to bulk import lots.', 'success');
      }
      
      // Handle Lots Upload
      window.handleLotsUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            
            if (lines.length < 2) {
              alert('The file appears to be empty or invalid. Please use the template format.');
              return;
            }
            
            // Skip header row
            const dataLines = lines.slice(1);
            const lotsMap = new Map(); // Group by lot name
            
            dataLines.forEach(line => {
              // Parse CSV line (handle quoted values)
              const values = line.match(/("([^"]*)"|[^,]+)/g);
              if (!values || values.length < 4) return;
              
              // Clean values (remove quotes)
              const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
              
              const [lotName, lotDesc, unspscCode, productDesc, quantity, estimatedValue] = cleanValues;
              
              if (!lotName || !unspscCode) return;
              
              if (!lotsMap.has(lotName)) {
                lotsMap.set(lotName, {
                  id: 'lot-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                  name: lotName,
                  description: lotDesc || '',
                  unspscCodes: []
                });
              }
              
              const lot = lotsMap.get(lotName);
              lot.unspscCodes.push({
                code: unspscCode,
                description: productDesc || '',
                quantity: parseInt(quantity) || 1,
                estimatedValue: parseFloat(estimatedValue) || 0
              });
            });
            
            if (lotsMap.size === 0) {
              alert('No valid lots found in the file. Please check the format.');
              return;
            }
            
            // Show preview modal
            openLotsUploadPreviewModal(Array.from(lotsMap.values()));
            
          } catch (error) {
            console.error('Error parsing file:', error);
            alert('Error reading the file. Please make sure it is a valid CSV file.');
          }
        };
        
        reader.readAsText(file);
        
        // Reset the input so the same file can be uploaded again
        event.target.value = '';
      }
      
      // Lots Upload Preview Modal
      let pendingLotsUpload = [];
      
      window.openLotsUploadPreviewModal = function(lotsData) {
        pendingLotsUpload = lotsData;
        
        const modal = document.getElementById('lots-upload-preview-modal');
        const body = document.getElementById('lots-upload-preview-body');
        
        let totalProducts = lotsData.reduce((sum, lot) => sum + lot.unspscCodes.length, 0);
        let totalValue = lotsData.reduce((sum, lot) => 
          sum + lot.unspscCodes.reduce((s, p) => s + (p.estimatedValue || 0), 0), 0);
        
        body.innerHTML = `
          <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--info-50); border-radius: var(--radius-sm); font-size: 12px;">
            <strong>Summary:</strong> ${lotsData.length} lot(s), ${totalProducts} product(s), $${totalValue.toLocaleString()} total value
          </div>
          <div style="max-height: 300px; overflow-y: auto;">
            ${lotsData.map((lot, idx) => `
              <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm); overflow: hidden;">
                <div style="background: var(--surface-50); padding: var(--spacing-sm) var(--spacing-md); border-bottom: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600; font-size: 13px;">${lot.name}</span>
                    ${lot.description ? `<span style="color: var(--text-muted); font-size: 11px; margin-left: 8px;">${lot.description}</span>` : ''}
                  </div>
                  <span style="font-size: 11px; color: var(--text-muted);">${lot.unspscCodes.length} product(s)</span>
                </div>
                <div style="padding: var(--spacing-sm);">
                  <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${lot.unspscCodes.map(p => `
                      <span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--surface-100); border-radius: 12px; font-size: 10px;">
                        <span style="font-family: monospace; color: var(--primary-600); font-weight: 600;">${p.code}</span>
                        <span style="color: var(--text-secondary);">${p.description ? p.description.substring(0, 15) + (p.description.length > 15 ? '...' : '') : ''}</span>
                        <span style="color: var(--text-muted);">√ó${p.quantity}</span>
                      </span>
                    `).join('')}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        modal.style.display = 'flex';
      }
      
      window.closeLotsUploadPreviewModal = function() {
        document.getElementById('lots-upload-preview-modal').style.display = 'none';
        pendingLotsUpload = [];
      }
      
      window.confirmLotsUpload = function() {
        if (pendingLotsUpload.length === 0) return;
        
        // Add all uploaded lots
        lots = [...lots, ...pendingLotsUpload];
        
        closeLotsUploadPreviewModal();
        renderCurrentBlock();
        showNotification(`Successfully imported ${pendingLotsUpload.length} lot(s)!`, 'success');
      }
      
      // Lot actions menu toggle
      window.toggleLotActionsMenu = function(lotId) {
        // Close all other menus first
        document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
          if (menu.id !== 'lot-menu-' + lotId) {
            menu.classList.remove('show');
          }
        });
        
        const menu = document.getElementById('lot-menu-' + lotId);
        if (menu) {
          menu.classList.toggle('show');
        }
      }
      
      // Close menus when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.lot-actions-menu-wrapper')) {
          document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });
      
      // Open Add Product Modal
      let currentLotIdForProduct = null;
      let selectedReqLinesForProduct = [];
      
      window.openAddProductModal = function(lotId) {
        currentLotIdForProduct = lotId;
        selectedReqLinesForProduct = [];
        
        // Close any open menus
        document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
          menu.classList.remove('show');
        });
        
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        // Populate requisition lines options
        const reqLinesBody = document.getElementById('add-product-req-lines');
        if (reqLinesBody) {
          const existingCodes = lot.unspscCodes.map(u => u.code);
          const availableLines = requisitionLines.filter(line => !existingCodes.includes(line.unspscCode));
          
          if (availableLines.length === 0) {
            reqLinesBody.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); font-size: 12px;">All requisition lines have already been added to this lot.</div>';
          } else {
            reqLinesBody.innerHTML = availableLines.map(line => `
              <div class="req-line-option" onclick="toggleReqLineForProduct('${line.unspscCode}', this)">
                <input type="checkbox" id="req-${line.unspscCode}" />
                <div class="req-line-details">
                  <div class="req-line-code">${line.unspscCode}</div>
                  <div class="req-line-desc">${line.unspscDescription}</div>
                  <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">${line.quantity} ${line.unitOfMeasure} ‚Ä¢ ${line.currency} ${line.amount.toLocaleString()}</div>
                </div>
              </div>
            `).join('');
          }
        }
        
        // Clear new product form
        const unspscInput = document.getElementById('new-product-unspsc');
        const descInput = document.getElementById('new-product-desc');
        const qtyInput = document.getElementById('new-product-qty');
        const valueInput = document.getElementById('new-product-value');
        if (unspscInput) unspscInput.value = '';
        if (descInput) descInput.value = '';
        if (qtyInput) qtyInput.value = '1';
        if (valueInput) valueInput.value = '';
        
        // Reset to first tab
        switchProductModalTab('from-requisition');
        
        // Show modal
        document.getElementById('add-product-modal').style.display = 'flex';
      }
      
      window.closeAddProductModal = function() {
        document.getElementById('add-product-modal').style.display = 'none';
        currentLotIdForProduct = null;
        selectedReqLinesForProduct = [];
      }
      
      window.switchProductModalTab = function(tabId) {
        document.querySelectorAll('.product-modal-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === tabId);
        });
        document.querySelectorAll('.product-modal-tab-content').forEach(content => {
          content.classList.toggle('active', content.id === 'tab-' + tabId);
          });
        
        // Update button based on tab
        const confirmBtn = document.getElementById('add-product-confirm-btn');
        if (confirmBtn) {
          if (tabId === 'from-requisition') {
            confirmBtn.textContent = 'Add Selected';
            confirmBtn.onclick = addProductsFromRequisition;
          } else {
            confirmBtn.textContent = 'Create Product';
            confirmBtn.onclick = addNewProduct;
          }
        }
      }
      
      window.toggleReqLineForProduct = function(unspscCode, element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const isSelected = selectedReqLinesForProduct.includes(unspscCode);
        
        if (isSelected) {
          selectedReqLinesForProduct = selectedReqLinesForProduct.filter(c => c !== unspscCode);
          element.classList.remove('selected');
          checkbox.checked = false;
        } else {
          selectedReqLinesForProduct.push(unspscCode);
          element.classList.add('selected');
          checkbox.checked = true;
        }
      }
      
      window.addProductsFromRequisition = function() {
        if (!currentLotIdForProduct || selectedReqLinesForProduct.length === 0) {
          alert('Please select at least one requisition line.');
          return;
        }
        
        const lot = lots.find(l => l.id === currentLotIdForProduct);
        if (!lot) return;
        
        selectedReqLinesForProduct.forEach(unspscCode => {
          const line = requisitionLines.find(l => l.unspscCode === unspscCode);
          if (line && !lot.unspscCodes.some(u => u.code === unspscCode)) {
              lot.unspscCodes.push({ 
              code: line.unspscCode,
              description: line.unspscDescription,
              quantity: line.quantity,
              estimatedValue: line.amount
              });
            }
        });
        
        closeAddProductModal();
        renderCurrentBlock();
      }
      
      window.addNewProduct = function() {
        if (!currentLotIdForProduct) return;
        
        const lot = lots.find(l => l.id === currentLotIdForProduct);
        if (!lot) return;
        
        const unspsc = document.getElementById('new-product-unspsc').value.trim();
        const desc = document.getElementById('new-product-desc').value.trim();
        const qty = parseInt(document.getElementById('new-product-qty').value) || 1;
        const value = parseFloat(document.getElementById('new-product-value').value) || 0;
        
        if (!unspsc) {
          alert('Please enter a UNSPSC code.');
          return;
        }
        
        if (lot.unspscCodes.some(u => u.code === unspsc)) {
          alert('This UNSPSC code is already in the lot.');
          return;
        }
        
              lot.unspscCodes.push({ 
          code: unspsc,
          description: desc,
          quantity: qty,
          estimatedValue: value
        });
        
        closeAddProductModal();
        renderCurrentBlock();
      }
      
      // Edit Lot Modal
      window.openEditLotModal = function(lotId) {
        // Close any open menus
        document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
          menu.classList.remove('show');
        });
        
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        document.getElementById('edit-lot-id').value = lotId;
        document.getElementById('edit-lot-name-input').value = lot.name || '';
        document.getElementById('edit-lot-desc-input').value = lot.description || '';
        
        document.getElementById('edit-lot-modal').style.display = 'flex';
      }
      
      window.closeEditLotModal = function() {
        document.getElementById('edit-lot-modal').style.display = 'none';
            }
      
      window.saveEditLot = function() {
        const lotId = document.getElementById('edit-lot-id').value;
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        lot.name = document.getElementById('edit-lot-name-input').value.trim();
        lot.description = document.getElementById('edit-lot-desc-input').value.trim();
        
        closeEditLotModal();
        renderCurrentBlock();
      }
      
      window.addProductsToLot = function(lotId) {
        openAddProductModal(lotId);
      }
      
      window.removeProductFromLot = function(lotId, index) {
        const lot = lots.find(l => l.id === lotId);
        if (lot && index >= 0 && index < lot.unspscCodes.length) {
          lot.unspscCodes.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      window.editLot = function(lotId) {
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        // In real app, would open a modal for editing
        const newName = prompt('Enter new lot name:', lot.name);
        if (newName && newName !== lot.name) {
          lot.name = newName;
          renderCurrentBlock();
        }
      }

      // ===== SECTION PROGRESS INDICATOR =====
      function renderSectionProgress(sectionType, items) {
        let completed = 0;
        let total = items ? items.length : 0;
        
        if (sectionType === 'product-req' && items) {
          items.forEach(item => {
            const req = productRequirements[item.code];
            if (req && req.requirementType && (req.attributes.length > 0 || req.description)) {
              completed++;
            }
          });
        } else if (sectionType === 'req-lines') {
          completed = requisitionLines.length;
          total = requisitionLines.length > 0 ? requisitionLines.length : 1;
        } else if (sectionType === 'lots') {
          completed = lots.filter(l => l.unspscCodes.length > 0).length;
          total = lots.length > 0 ? lots.length : 1;
        } else if (sectionType === 'project-info') {
          total = 4;
          completed = 0;
        } else if (sectionType === 'particulars') {
          total = 10;
          completed = 0;
        } else if (sectionType === 'scope-objectives') {
          total = 1;
          completed = 0;
        } else if (sectionType === 'other-req') {
          total = 3;
          completed = tenderAuthorConfig.serviceDescriptions.length > 0 ? 1 : 0;
          completed += deliveryRequirementFields.filter(f => f.value).length > 0 ? 1 : 0;
          completed += tenderAuthorConfig.specificRequirements ? 1 : 0;
        } else if (sectionType === 'key-dates') {
          total = 3;
          completed = 0;
        } else if (sectionType === 'contract-provisions') {
          total = 7;
          completed = 0;
          if (contractProvisionsValues.generalConditions) completed++;
          if (contractProvisionsValues.specialConditions) completed++;
          if (contractProvisionsValues.sampleContract) completed++;
          if (contractProvisionsValues.contractClausesKPIs) completed++;
          if (contractProvisionsValues.contractClausesDrive) completed++;
          if (contractProvisionsValues.performanceSecurityRequired) completed++;
          if (contractProvisionsValues.advancePaymentRequired) completed++;
        } else if (sectionType === 'competition-type') {
          total = 1;
          completed = competitionValues.competitionType ? 1 : 0;
        } else if (sectionType === 'vendor-notification') {
          total = 3;
          completed = 0;
          if (competitionValues.ungmVendors.length > 0) completed++;
          if (competitionValues.unregisteredEmail) completed++;
          if (competitionValues.unregisteredCompanyName) completed++;
        } else if (sectionType === 'market-research') {
          total = 2;
          completed = 0;
          if (competitionValues.marketResearchDetails) completed++;
          if (competitionValues.effectiveCompetitionDetails) completed++;
        } else if (sectionType === 'limited-justification') {
          total = 1;
          completed = competitionValues.limitedCompetitionJustification ? 1 : 0;
        } else if (sectionType === 'direct-contracting') {
          total = 3;
          completed = 0;
          if (competitionValues.directContractingReason) completed++;
          if (competitionValues.linkedProcess) completed++;
          if (competitionValues.directContractingJustification) completed++;
        } else if (sectionType === 'team-procurement') {
          total = 3;
          completed = 0;
          if (teamMembers.procurementReviewer) completed++;
          if (teamMembers.procurementAuthority) completed++;
          if (teamMembers.technicalExpert) completed++;
        } else if (sectionType === 'team-evaluation') {
          total = 2;
          completed = 0;
          if (teamMembers.bidOpeningPanel.length > 0) completed++;
          if (teamMembers.evaluationTeam.length > 0) completed++;
        }
        
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        const color = percentage === 100 ? 'var(--success-500)' : percentage > 50 ? 'var(--warning-500)' : 'var(--surface-300)';
        
        return `
          <div class="section-progress" style="margin-left: 12px; display: flex; align-items: center; gap: 6px;">
            <div class="progress-bar-mini" style="width: 50px; height: 5px; background: var(--surface-200); border-radius: 3px; overflow: hidden;">
              <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 3px;"></div>
            </div>
            <span style="font-size: 10px; color: var(--text-muted);">${completed}/${total}</span>
          </div>
        `;
      }
      
      // ===== COMPETITION BLOCK =====
      function renderCompetitionBlock(block) {
        const isOpenOrLimited = ['Open competition', 'Limited competition'].includes(competitionValues.competitionType);
        const isLimited = competitionValues.competitionType === 'Limited competition';
        const isDirect = competitionValues.competitionType === 'Direct contracting';
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              
              <!-- Competition Type Section - Collapsible -->
              <div class="collapsible-section collapsed" id="competition-type-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('competition-type-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Competition Type</span>
                    ${renderSectionProgress('competition-type', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group">
                      <label class="form-label">Vendor competition type <span class="required">*</span></label>
                      <select class="form-select" onchange="updateCompetitionType(this.value)" onclick="event.stopPropagation()" required>
                        <option value="">Select...</option>
                        <option value="Open competition" ${competitionValues.competitionType === 'Open competition' ? 'selected' : ''}>Open competition</option>
                        <option value="Limited competition" ${competitionValues.competitionType === 'Limited competition' ? 'selected' : ''}>Limited competition</option>
                        <option value="Direct contracting" ${competitionValues.competitionType === 'Direct contracting' ? 'selected' : ''}>Direct contracting</option>
                      </select>
                      <span class="help-text">Select the type of vendor competition for this tender</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Vendor Notification Section - Collapsible -->
              <div class="collapsible-section collapsed" id="vendor-notification-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('vendor-notification-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Vendor Notification</span>
                    ${renderSectionProgress('vendor-notification', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group full-width">
                      <label class="form-label">Add UNGM vendor to be notified</label>
                      <div style="position: relative;">
                        <input type="text" class="form-input" placeholder="Search UNGM vendors or shortlist..." style="padding-left: 36px;" id="ungm-vendor-search" onclick="event.stopPropagation()" />
                        <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;">üîç</span>
                      </div>
                      <span class="help-text">Search from UNGM database or existing shortlists</span>
                      
                      <!-- Selected vendors display -->
                      <div id="selected-ungm-vendors" style="margin-top: var(--spacing-sm); display: flex; flex-wrap: wrap; gap: var(--spacing-xs);">
                        ${competitionValues.ungmVendors.map((vendor, idx) => `
                          <span class="badge badge-info" style="display: inline-flex; align-items: center; gap: 4px;">
                            ${vendor}
                            <button type="button" onclick="event.stopPropagation(); removeUngmVendor(${idx})" style="background: none; border: none; cursor: pointer; padding: 0; font-size: 14px;">√ó</button>
                          </span>
                        `).join('')}
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Add email address (unregistered supplier)</label>
                      <input type="email" class="form-input" placeholder="supplier@company.com" value="${competitionValues.unregisteredEmail}" onchange="updateCompetitionValue('unregisteredEmail', this.value)" onclick="event.stopPropagation()" />
                      <span class="help-text">For suppliers not registered in UNGM</span>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Add Company Name (unregistered supplier)</label>
                      <input type="text" class="form-input" placeholder="Company name" value="${competitionValues.unregisteredCompanyName}" onchange="updateCompetitionValue('unregisteredCompanyName', this.value)" onclick="event.stopPropagation()" />
                      <span class="help-text">For suppliers not registered in UNGM</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Market Research & Outreach Section - Collapsible (visible for Open/Limited) -->
              ${isOpenOrLimited ? `
              <div class="collapsible-section collapsed" id="market-research-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('market-research-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Market Research & Outreach</span>
                    ${renderSectionProgress('market-research', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group full-width">
                      <label class="form-label">Details on market research and outreach <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Describe the market research conducted and outreach efforts..." style="min-height: 100px;" onchange="updateCompetitionValue('marketResearchDetails', this.value)" onclick="event.stopPropagation()" required>${competitionValues.marketResearchDetails}</textarea>
                      <span class="help-text">Required for Open and Limited competition types</span>
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Details on how you intend to achieve effective competition <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Explain how effective competition will be achieved..." style="min-height: 100px;" onchange="updateCompetitionValue('effectiveCompetitionDetails', this.value)" onclick="event.stopPropagation()" required>${competitionValues.effectiveCompetitionDetails}</textarea>
                      <span class="help-text">Describe strategies to ensure competitive process</span>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Limited Competition Justification Section - Collapsible (visible for Limited) -->
              ${isLimited ? `
              <div class="collapsible-section collapsed" id="limited-justification-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('limited-justification-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Limited Competition Justification</span>
                    ${renderSectionProgress('limited-justification', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group full-width">
                      <label class="form-label">Justification for reason for limited competition <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Provide detailed justification for selecting limited competition..." style="min-height: 120px;" onchange="updateCompetitionValue('limitedCompetitionJustification', this.value)" onclick="event.stopPropagation()" required>${competitionValues.limitedCompetitionJustification}</textarea>
                      <span class="help-text">Explain why limited competition is appropriate for this procurement</span>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Direct Contracting Section - Collapsible (visible for Direct) -->
              ${isDirect ? `
              <div class="collapsible-section collapsed" id="direct-contracting-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('direct-contracting-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Direct Contracting Details</span>
                    ${renderSectionProgress('direct-contracting', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group full-width">
                      <label class="form-label">Reason for direct contracting under UNOPS Financial Rule 118.05(a) <span class="required">*</span></label>
                      <select class="form-select" onchange="updateCompetitionValue('directContractingReason', this.value)" onclick="event.stopPropagation()" required>
                        <option value="">Select reason...</option>
                        <option value="sole-source" ${competitionValues.directContractingReason === 'sole-source' ? 'selected' : ''}>Sole source - only one supplier capable</option>
                        <option value="emergency" ${competitionValues.directContractingReason === 'emergency' ? 'selected' : ''}>Emergency procurement</option>
                        <option value="standardization" ${competitionValues.directContractingReason === 'standardization' ? 'selected' : ''}>Standardization of equipment</option>
                        <option value="proprietary" ${competitionValues.directContractingReason === 'proprietary' ? 'selected' : ''}>Proprietary rights</option>
                        <option value="previous-contract" ${competitionValues.directContractingReason === 'previous-contract' ? 'selected' : ''}>Extension of existing contract</option>
                        <option value="other" ${competitionValues.directContractingReason === 'other' ? 'selected' : ''}>Other (specify in justification)</option>
                      </select>
                      <span class="help-text">Select the applicable reason per UNOPS Financial Rules</span>
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Linked process</label>
                      <div style="position: relative;">
                        <input type="text" class="form-input" placeholder="Search for linked procurement process..." style="padding-left: 36px;" value="${competitionValues.linkedProcess}" onchange="updateCompetitionValue('linkedProcess', this.value)" onclick="event.stopPropagation()" />
                        <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;">üîç</span>
                      </div>
                      <span class="help-text">Link to related procurement process if applicable</span>
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Justification for reason for direct contracting selected above <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Provide detailed justification for direct contracting..." style="min-height: 120px;" onchange="updateCompetitionValue('directContractingJustification', this.value)" onclick="event.stopPropagation()" required>${competitionValues.directContractingJustification}</textarea>
                      <span class="help-text">Provide comprehensive justification supporting the selected reason</span>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
            </div>
          </div>
        `;
      }
      
      // Competition update functions
      // Track expanded sections for Competition tab
      let competitionExpandedSections = {
        'competition-type-section': false,
        'vendor-notification-section': false,
        'market-research-section': false,
        'limited-justification-section': false,
        'direct-contracting-section': false
      };
      
      window.updateCompetitionType = function(value) {
        // Save current expanded states before re-render
        saveCompetitionSectionStates();
        
        competitionValues.competitionType = value;
        renderCurrentBlock();
        
        // Restore expanded states after re-render
        restoreCompetitionSectionStates();
      }
      
      function saveCompetitionSectionStates() {
        const sectionIds = ['competition-type-section', 'vendor-notification-section', 'market-research-section', 'limited-justification-section', 'direct-contracting-section'];
        sectionIds.forEach(id => {
          const section = document.getElementById(id);
          if (section) {
            competitionExpandedSections[id] = !section.classList.contains('collapsed');
          }
        });
      }
      
      function restoreCompetitionSectionStates() {
        Object.keys(competitionExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section && competitionExpandedSections[id]) {
            section.classList.remove('collapsed');
          }
        });
      }
      
      window.updateCompetitionValue = function(field, value) {
        competitionValues[field] = value;
      }
      
      window.removeUngmVendor = function(index) {
        saveCompetitionSectionStates();
        competitionValues.ungmVendors.splice(index, 1);
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Contract Provisions update functions
      // Track expanded sections for Project & Tender Details
      let projectDetailsExpandedSections = {
        'project-info-section': false,
        'particulars-section': false,
        'key-dates-section': false,
        'contract-provisions-section': false
      };
      
      function saveProjectDetailsSectionStates() {
        Object.keys(projectDetailsExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section) {
            projectDetailsExpandedSections[id] = !section.classList.contains('collapsed');
          }
        });
      }
      
      function restoreProjectDetailsSectionStates() {
        Object.keys(projectDetailsExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section && projectDetailsExpandedSections[id]) {
            section.classList.remove('collapsed');
          }
        });
      }
      
      window.updateContractProvision = function(field, value) {
        const needsRerender = ['performanceSecurityRequired', 'advancePaymentRequired'].includes(field);
        
        if (needsRerender) {
          saveProjectDetailsSectionStates();
        }
        
        contractProvisionsValues[field] = value;
        
        if (needsRerender) {
          renderCurrentBlock();
          restoreProjectDetailsSectionStates();
        }
      }
      
      window.formatContractText = function(editorId, command) {
        const editorMap = {
          'specialConditions': 'contract-special-conditions-editor',
          'clausesKPIs': 'contract-clauses-kpis-editor',
          'clausesDrive': 'contract-clauses-drive-editor',
          'perfSecurityDetails': 'contract-perf-security-editor',
          'advancePaymentDetails': 'contract-advance-payment-editor'
        };
        
        const editor = document.getElementById(editorMap[editorId]);
        if (editor) {
          editor.focus();
          document.execCommand(command, false, null);
        }
      }
      
      // ===== TEAM BLOCK =====
      function renderTeamBlock(block) {
        const renderTeamMemberCard = (member, role, canRemove = false, removeFunc = null) => {
          if (!member) return '';
          return `
            <div class="team-member-card">
              <div class="team-member-avatar" style="background: ${role === 'Author' ? 'var(--primary-500)' : 'var(--info-500)'};">${member.avatar || member.name.split(' ').map(n => n[0]).join('')}</div>
              <div class="team-member-info">
                <div class="team-member-name">${member.name}</div>
                <div class="team-member-email">${member.email || ''}</div>
              </div>
              <div class="team-member-role">${role}</div>
              ${canRemove ? `<button class="team-member-remove" onclick="event.stopPropagation(); ${removeFunc}" title="Remove">√ó</button>` : ''}
            </div>
          `;
        };
        
        const renderTeamMemberList = (members, role, removeFunc) => {
          if (!members || members.length === 0) return '<div class="team-empty-slot">No members assigned</div>';
          return members.map((m, idx) => renderTeamMemberCard(m, role, true, `${removeFunc}(${idx})`)).join('');
        };
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              
              <!-- Current Author Section -->
              <div class="collapsible-section" id="team-author-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-author-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Process Author</span>
                    <span class="badge badge-success" style="margin-left: 8px;">Active</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-section-content">
                    ${renderTeamMemberCard(teamMembers.author, 'Author')}
                    
                    <div class="team-subsection" style="margin-top: var(--spacing-md);">
                      <div class="team-subsection-header">
                        <span class="team-subsection-title">Alternate Authors</span>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('alternateAuthors')"><i class="pi pi-plus"></i> Add</button>
                      </div>
                      <div class="team-members-list">
                        ${renderTeamMemberList(teamMembers.alternateAuthors, 'Alternate Author', 'removeAlternateAuthor')}
                      </div>
                      <span class="help-text">Alternate authors can edit the tender document</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Procurement Roles Section -->
              <div class="collapsible-section collapsed" id="team-procurement-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-procurement-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Procurement Roles</span>
                    ${renderSectionProgress('team-procurement', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-roles-grid">
                    
                    <!-- Procurement Reviewer -->
                    <div class="team-role-card">
                      <div class="team-role-header">
                        <div class="team-role-icon">üìã</div>
                        <div class="team-role-title">Procurement Reviewer</div>
                      </div>
                      <div class="team-role-content">
                        ${teamMembers.procurementReviewer ? 
                          renderTeamMemberCard(teamMembers.procurementReviewer, 'Reviewer', true, 'removeProcurementReviewer()') :
                          `<div class="team-add-placeholder" onclick="event.stopPropagation(); openAddTeamMemberModal('procurementReviewer')">
                            <i class="pi pi-plus"></i>
                            <span>Assign Reviewer</span>
                          </div>`
                        }
                      </div>
                      <span class="help-text">Reviews and approves tender documents</span>
                    </div>
                    
                    <!-- Procurement Authority -->
                    <div class="team-role-card">
                      <div class="team-role-header">
                        <div class="team-role-icon">‚úÖ</div>
                        <div class="team-role-title">Procurement Authority</div>
                      </div>
                      <div class="team-role-content">
                        ${teamMembers.procurementAuthority ? 
                          renderTeamMemberCard(teamMembers.procurementAuthority, 'Authority', true, 'removeProcurementAuthority()') :
                          `<div class="team-add-placeholder" onclick="event.stopPropagation(); openAddTeamMemberModal('procurementAuthority')">
                            <i class="pi pi-plus"></i>
                            <span>Assign Authority</span>
                          </div>`
                        }
                      </div>
                      <span class="help-text">Final approval authority for procurement</span>
                    </div>
                    
                    <!-- Technical Expert -->
                    <div class="team-role-card">
                      <div class="team-role-header">
                        <div class="team-role-icon">üîß</div>
                        <div class="team-role-title">Technical Expert</div>
                      </div>
                      <div class="team-role-content">
                        ${teamMembers.technicalExpert ? 
                          renderTeamMemberCard(teamMembers.technicalExpert, 'Expert', true, 'removeTechnicalExpert()') :
                          `<div class="team-add-placeholder" onclick="event.stopPropagation(); openAddTeamMemberModal('technicalExpert')">
                            <i class="pi pi-plus"></i>
                            <span>Assign Expert</span>
                          </div>`
                        }
                      </div>
                      <span class="help-text">Provides technical guidance and specifications</span>
                    </div>
                    
                  </div>
                </div>
              </div>
              
              <!-- Evaluation Team Section -->
              <div class="collapsible-section collapsed" id="team-evaluation-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-evaluation-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Evaluation Team</span>
                    ${renderSectionProgress('team-evaluation', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-section-content">
                    
                    <!-- Bid Opening Panel -->
                    <div class="team-subsection">
                      <div class="team-subsection-header">
                        <span class="team-subsection-title">üìÇ Bid Opening Panel</span>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('bidOpeningPanel')"><i class="pi pi-plus"></i> Add Member</button>
                      </div>
                      <div class="team-members-list">
                        ${renderTeamMemberList(teamMembers.bidOpeningPanel, 'Panel Member', 'removeBidOpeningPanelMember')}
                      </div>
                      <span class="help-text">Required for public bid openings or offline tenders</span>
                    </div>
                    
                    <!-- Evaluation Team Members -->
                    <div class="team-subsection" style="margin-top: var(--spacing-lg);">
                      <div class="team-subsection-header">
                        <span class="team-subsection-title">üìä Evaluation Committee</span>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('evaluationTeam')"><i class="pi pi-plus"></i> Add Member</button>
                      </div>
                      <div class="team-members-list">
                        ${renderTeamMemberList(teamMembers.evaluationTeam, 'Evaluator', 'removeEvaluationTeamMember')}
                      </div>
                      <span class="help-text">Procurement Official, Chair, Members, and Observers</span>
                    </div>
                    
                  </div>
                </div>
              </div>
              
              <!-- Collaborators Section -->
              <div class="collapsible-section collapsed" id="team-collaborators-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-collaborators-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Collaborators</span>
                    <span class="badge badge-info" style="margin-left: 8px;">${teamMembers.collaborators.length}</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-section-content">
                    <div class="team-subsection-header" style="margin-bottom: var(--spacing-sm);">
                      <span class="team-subsection-title">Additional Collaborators</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('collaborators')"><i class="pi pi-plus"></i> Add Collaborator</button>
                    </div>
                    <div class="team-members-list">
                      ${renderTeamMemberList(teamMembers.collaborators, 'Collaborator', 'removeCollaborator')}
                    </div>
                    <span class="help-text">Collaborators can view and comment on the tender</span>
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        `;
      }
      
      // Team member management functions
      window.openAddTeamMemberModal = function(role) {
        // In real app, this would open a modal to search and select team members
        const mockMembers = [
          { name: 'John Smith', email: 'john.smith@unops.org', avatar: 'JS' },
          { name: 'Sarah Johnson', email: 'sarah.johnson@unops.org', avatar: 'SJ' },
          { name: 'Michael Chen', email: 'michael.chen@unops.org', avatar: 'MC' },
          { name: 'Emma Wilson', email: 'emma.wilson@unops.org', avatar: 'EW' },
        ];
        
        const randomMember = mockMembers[Math.floor(Math.random() * mockMembers.length)];
        
        if (['alternateAuthors', 'bidOpeningPanel', 'evaluationTeam', 'collaborators'].includes(role)) {
          teamMembers[role].push(randomMember);
        } else {
          teamMembers[role] = randomMember;
        }
        
        renderCurrentBlock();
        showNotification(`${randomMember.name} added as ${role.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'success');
      }
      
      window.removeAlternateAuthor = function(index) {
        teamMembers.alternateAuthors.splice(index, 1);
        renderCurrentBlock();
      }
      
      window.removeProcurementReviewer = function() {
        teamMembers.procurementReviewer = null;
        renderCurrentBlock();
      }
      
      window.removeProcurementAuthority = function() {
        teamMembers.procurementAuthority = null;
        renderCurrentBlock();
      }
      
      window.removeTechnicalExpert = function() {
        teamMembers.technicalExpert = null;
        renderCurrentBlock();
      }
      
      window.removeBidOpeningPanelMember = function(index) {
        teamMembers.bidOpeningPanel.splice(index, 1);
        renderCurrentBlock();
      }
      
      window.removeEvaluationTeamMember = function(index) {
        teamMembers.evaluationTeam.splice(index, 1);
        renderCurrentBlock();
      }
      
      window.removeCollaborator = function(index) {
        teamMembers.collaborators.splice(index, 1);
        renderCurrentBlock();
      }
      
      // ===== SCOPE & REQUIREMENTS BLOCK =====
      function renderScopeRequirementsBlock(block) {
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get all UNSPSC codes for Product Requirements
        let unspscCodesToShow = [];
        if (lots.length === 0) {
          unspscCodesToShow = requisitionLines.map(line => ({
            code: line.unspscCode,
            description: line.unspscDescription,
            source: 'requisition',
            sourceId: line.id,
          }));
        } else {
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                source: 'lot',
                sourceId: lot.id,
                lotName: lot.name,
              });
            });
          });
        }
        
        // Remove duplicates
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });

        return `
          <div class="general-info-container">
            <div class="general-info-body">
              
              <!-- Scope and Objectives Section - Collapsible -->
              <div class="collapsible-section collapsed" id="scope-objectives-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('scope-objectives-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Scope and Objectives</span>
                    ${renderSectionProgress('scope-objectives', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body">
                  <div class="form-group">
                    <label class="form-label">Scope and objectives of sourcing or solicitation process <span class="required">*</span></label>
                    <textarea class="form-textarea" placeholder="Describe the scope and objectives of this procurement process..." style="min-height: 120px;"></textarea>
                  </div>
                </div>
              </div>
              
              <!-- Product Requirements Section - Collapsible -->
              <div class="collapsible-section collapsed" id="product-requirements-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('product-requirements-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Product Requirements & Specifications</span>
                    <span class="badge badge-info" style="margin-left: 8px; font-size: 10px;">${uniqueUnspscCodes.length} products</span>
                    ${renderSectionProgress('product-req', uniqueUnspscCodes)}
                  </div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); downloadProductReqTemplate()"><i class="pi pi-download"></i> Template</button>
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); document.getElementById('product-req-upload-input').click()"><i class="pi pi-upload"></i> Upload</button>
                    <input type="file" id="product-req-upload-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleProductReqUpload(event)" />
                    <div class="collapsible-toggle">‚ñº</div>
                  </div>
                </div>
                <div class="collapsible-body">
                  ${renderProductRequirementsContent(uniqueUnspscCodes)}
                </div>
              </div>
              
              <!-- Other Requirements Section - Collapsible -->
              <div class="collapsible-section collapsed" id="other-requirements-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('other-requirements-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Other Requirements</span>
                    ${renderSectionProgress('other-req', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body">
                  ${renderOtherRequirementsContent()}
                </div>
              </div>
              
            </div>
          </div>
        `;
      }
      
      // Render Product Requirements Content (compact version)
      function renderProductRequirementsContent(uniqueUnspscCodes) {
        if (uniqueUnspscCodes.length === 0) {
          return `
            <div class="empty-state" style="padding: var(--spacing-lg); text-align: center;">
              <div style="font-size: 24px; margin-bottom: var(--spacing-xs);">üìã</div>
              <div style="font-weight: 600; margin-bottom: var(--spacing-xs);">No products available</div>
              <div style="color: var(--text-muted); font-size: 12px;">${lots.length === 0 ? 'Add requisition lines or create lots with products.' : 'Add products to lots to define requirements.'}</div>
            </div>
          `;
        }
        
        return `
          <!-- Products List - Compact Accordion Style -->
          <div class="product-requirements-compact">
            ${uniqueUnspscCodes.map((unspsc, idx) => {
              const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
              const hasRequirements = req.requirementType && (req.attributes.length > 0 || req.description);
              const statusClass = hasRequirements ? 'status-complete' : 'status-pending';
              const statusText = hasRequirements ? '‚úì Defined' : '‚óã Pending';
              
              return `
                <div class="product-req-item ${hasRequirements ? 'has-requirements' : ''}" data-unspsc="${unspsc.code}">
                  <div class="product-req-header" onclick="toggleProductRequirement('${unspsc.code}')">
                    <div class="product-req-info">
                      <span class="product-req-code">${unspsc.code}</span>
                      <span class="product-req-desc">${unspsc.description}</span>
                      ${unspsc.lotName ? `<span class="product-req-lot">Lot: ${unspsc.lotName}</span>` : ''}
                    </div>
                    <div class="product-req-status">
                      <span class="status-badge ${statusClass}">${statusText}</span>
                      <span class="product-req-toggle">‚ñº</span>
                    </div>
                  </div>
                  <div class="product-req-body" id="product-req-body-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                    ${renderProductRequirementBody(unspsc, req)}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      // Render individual product requirement body
      function renderProductRequirementBody(unspsc, req) {
        // Show attachment if exists
        const attachmentHtml = req.uploadedFile ? `
          <div style="margin-bottom: var(--spacing-sm); padding: var(--spacing-sm); background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">üìé</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 12px; color: var(--info-700);">${req.uploadedFile.name}</div>
              <div style="font-size: 11px; color: var(--info-600);">${req.uploadedFile.size}</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); removeAttachment('${unspsc.code}')" style="color: var(--danger-600);" title="Remove attachment"><i class="pi pi-times"></i></button>
          </div>
        ` : '';
        
        if (!req.requirementType || (req.attributes.length === 0 && !req.description)) {
          return `
            <div class="req-type-selector">
              ${attachmentHtml}
              <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">Choose requirement type:</p>
              <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                <button class="btn btn-secondary" onclick="event.stopPropagation(); addRequirementAttributeInline('${unspsc.code}')">
                  <span style="font-size: 14px; margin-right: 4px;">üìã</span> Attributes
                </button>
                <button class="btn btn-secondary" onclick="event.stopPropagation(); addDescriptionFieldInline('${unspsc.code}')">
                  <span style="font-size: 14px; margin-right: 4px;">üìù</span> Description
                </button>
                <button class="btn btn-secondary" onclick="event.stopPropagation(); document.getElementById('attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}').click()">
                  <span style="font-size: 14px; margin-right: 4px;">üìé</span> Attach
                </button>
                <input type="file" id="attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;" onchange="handleAttachFile('${unspsc.code}', event)" />
              </div>
            </div>
          `;
        } else if (req.requirementType === 'description') {
          return `
            <div class="req-description-compact">
              ${attachmentHtml}
              <div class="form-group" style="margin: 0;">
                <div class="rich-text-toolbar-full">
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'bold')" title="Bold"><strong>B</strong></button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'italic')" title="Italic"><em>I</em></button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'underline')" title="Underline"><u>U</u></button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'strikeThrough')" title="Strikethrough"><s>S</s></button>
                  </div>
                  <span class="toolbar-sep"></span>
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'formatBlock', 'h3')" title="Heading">H1</button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'formatBlock', 'h4')" title="Subheading">H2</button>
                  </div>
                  <span class="toolbar-sep"></span>
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'insertOrderedList')" title="Numbered List">1.</button>
                  </div>
                  <span class="toolbar-sep"></span>
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); insertLinkByCode('${unspsc.code}')" title="Insert Link">üîó</button>
                  </div>
                </div>
                <div 
                  id="rich-text-editor-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}"
                  class="rich-text-editor-full" 
                  contenteditable="true"
                  data-unspsc="${unspsc.code}"
                  placeholder="Enter detailed product/service description. Use formatting tools above to structure your content..."
                  oninput="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                  onclick="event.stopPropagation()"
                >${req.description || ''}</div>
              </div>
              <div class="req-actions-row">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); switchToAttributesInline('${unspsc.code}')"><i class="pi pi-list"></i> Switch to Attributes</button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}').click()"><i class="pi pi-paperclip"></i> Attach</button>
                <input type="file" id="attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;" onchange="handleAttachFile('${unspsc.code}', event)" />
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); clearRequirementsInline('${unspsc.code}')" style="color: var(--danger-600);"><i class="pi pi-trash"></i> Clear</button>
              </div>
            </div>
          `;
        } else {
          // Attributes type (default)
          return `
            <div class="req-attributes-compact">
              ${attachmentHtml}
              <div class="attributes-grid">
                ${req.attributes.map((attr, idx) => `
                  <div class="attr-row">
                    <input type="text" class="attr-input attr-name" value="${attr.name}" placeholder="Attribute name" onchange="updateAttributeName('${unspsc.code}', ${idx}, this.value)" onclick="event.stopPropagation()" />
                    <input type="text" class="attr-input attr-value" value="${attr.value}" placeholder="Value" onchange="updateAttributeValue('${unspsc.code}', ${idx}, this.value)" onclick="event.stopPropagation()" />
                    <button class="attr-remove" onclick="event.stopPropagation(); removeAttributeInline('${unspsc.code}', ${idx})">√ó</button>
                  </div>
                `).join('')}
              </div>
              <div class="req-actions-row">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addRequirementAttributeInline('${unspsc.code}')"><i class="pi pi-plus"></i> Add Attribute</button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}').click()"><i class="pi pi-paperclip"></i> Attach</button>
                <input type="file" id="attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;" onchange="handleAttachFile('${unspsc.code}', event)" />
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); clearRequirementsInline('${unspsc.code}')" style="color: var(--danger-600);"><i class="pi pi-trash"></i> Clear</button>
              </div>
            </div>
          `;
        }
      }
      
      // Toggle product requirement expansion
      window.toggleProductRequirement = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const body = document.getElementById('product-req-body-' + sanitizedCode);
        const item = body.closest('.product-req-item');
        
        if (body.style.display === 'none') {
          body.style.display = 'block';
          item.classList.add('expanded');
        } else {
          body.style.display = 'none';
          item.classList.remove('expanded');
        }
      }
      
      // Inline functions that update DOM without re-rendering the whole block
      window.addRequirementAttributeInline = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'attributes', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'attributes';
        productRequirements[unspscCode].attributes.push({ name: '', value: '' });
        
        // Update just the body content
        updateProductReqBodyContent(unspscCode);
      }
      
      window.addDescriptionFieldInline = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'description', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'description';
        productRequirements[unspscCode].description = '';
        productRequirements[unspscCode].attributes = [];
        
        // Update just the body content
        updateProductReqBodyContent(unspscCode);
      }
      
      window.switchToAttributesInline = function(unspscCode) {
        if (confirm('Switching to attributes will clear your description. Continue?')) {
          productRequirements[unspscCode].requirementType = 'attributes';
          productRequirements[unspscCode].description = '';
          productRequirements[unspscCode].attributes = [];
          updateProductReqBodyContent(unspscCode);
        }
      }
      
      window.clearRequirementsInline = function(unspscCode) {
        if (confirm('This will clear all requirements for this product. Continue?')) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '', uploadedFile: null };
          updateProductReqBodyContent(unspscCode);
          updateProductReqStatus(unspscCode);
        }
      }
      
      window.handleAttachFile = function(unspscCode, event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
          alert('File size must be less than 10MB');
          return;
        }
        
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '', uploadedFile: null };
        }
        
        productRequirements[unspscCode].uploadedFile = {
          name: file.name,
          size: (file.size / 1024).toFixed(1) + ' KB',
          type: file.type
        };
        
        updateProductReqBodyContent(unspscCode);
        updateProductReqStatus(unspscCode);
        showNotification(`File "${file.name}" attached`, 'success');
      }
      
      window.removeAttachment = function(unspscCode) {
        if (productRequirements[unspscCode]) {
          productRequirements[unspscCode].uploadedFile = null;
          updateProductReqBodyContent(unspscCode);
          updateProductReqStatus(unspscCode);
        }
      }
      
      window.removeAttributeInline = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes.splice(index, 1);
          updateProductReqBodyContent(unspscCode);
          updateProductReqStatus(unspscCode);
        }
      }
      
      // Update just the product requirement body content
      function updateProductReqBodyContent(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const body = document.getElementById('product-req-body-' + sanitizedCode);
        if (!body) return;
        
        const req = productRequirements[unspscCode] || { requirementType: null, attributes: [], description: '' };
        const unspsc = { code: unspscCode, description: '' }; // We don't need full description for the body
        
        body.innerHTML = renderProductRequirementBody(unspsc, req);
        body.style.display = 'block';
        body.closest('.product-req-item').classList.add('expanded');
      }
      
      // Update product requirement status badge
      function updateProductReqStatus(unspscCode) {
        const item = document.querySelector(`.product-req-item[data-unspsc="${unspscCode}"]`);
        if (!item) return;
        
        const req = productRequirements[unspscCode] || { requirementType: null, attributes: [], description: '', uploadedFile: null };
        const hasRequirements = req.requirementType && (req.attributes.length > 0 || req.description);
        
        const statusBadge = item.querySelector('.status-badge');
        if (statusBadge) {
          statusBadge.className = 'status-badge ' + (hasRequirements ? 'status-complete' : 'status-pending');
          statusBadge.textContent = hasRequirements ? '‚úì Defined' : '‚óã Pending';
        }
        
        if (hasRequirements) {
          item.classList.add('has-requirements');
        } else {
          item.classList.remove('has-requirements');
        }
      }
      
      // Download product requirements template
      window.downloadProductReqTemplate = function() {
        const csvContent = `UNSPSC Code,Description,Requirement Type,Attribute Name,Attribute Value,Free Text Description
# Instructions: Fill in requirements for each UNSPSC code
# Requirement Type: Use "attributes" for structured data or "description" for free text
# For attributes: Fill Attribute Name and Attribute Value columns (one row per attribute)
# For description: Fill the Free Text Description column
# Example rows below:
43211500,Computers,attributes,Processor,Intel Core i7,
43211500,Computers,attributes,RAM,16GB DDR4,
43211500,Computers,attributes,Storage,512GB SSD,
72151500,Building cleaning services,description,,,Professional cleaning services including daily office cleaning and monthly deep cleaning. Must use eco-friendly products.`;
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'product_requirements_template.csv';
        link.click();
        
        showNotification('Template downloaded! Fill in requirements and upload.', 'success');
      }
      
      // Handle product requirements upload
      window.handleProductReqUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result;
          const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
          
          // Skip header
          const dataLines = lines.slice(1);
          
          dataLines.forEach(line => {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length >= 3) {
              const [unspscCode, description, reqType, attrName, attrValue, freeText] = parts;
              
              if (!productRequirements[unspscCode]) {
                productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '' };
              }
              
              if (reqType === 'attributes' && attrName) {
                productRequirements[unspscCode].requirementType = 'attributes';
                productRequirements[unspscCode].attributes.push({
                  name: attrName,
                  value: attrValue || ''
                });
              } else if (reqType === 'description' && freeText) {
                productRequirements[unspscCode].requirementType = 'description';
                productRequirements[unspscCode].description = freeText;
              }
            }
          });
          
          // Refresh the product requirements section only
          const section = document.getElementById('product-requirements-section');
          if (section) {
            const body = section.querySelector('.collapsible-body');
            if (body) {
              // Re-render product requirements content
              let unspscCodesToShow = [];
              if (lots.length === 0) {
                unspscCodesToShow = requisitionLines.map(line => ({
                  code: line.unspscCode,
                  description: line.unspscDescription,
                  source: 'requisition',
                  sourceId: line.id,
                }));
              } else {
                lots.forEach(lot => {
                  lot.unspscCodes.forEach(unspsc => {
                    unspscCodesToShow.push({
                      code: unspsc.code,
                      description: unspsc.description,
                      source: 'lot',
                      sourceId: lot.id,
                      lotName: lot.name,
                    });
                  });
                });
              }
              
              const uniqueUnspscCodes = [];
              const seenCodes = new Set();
              unspscCodesToShow.forEach(item => {
                if (!seenCodes.has(item.code)) {
                  seenCodes.add(item.code);
                  uniqueUnspscCodes.push(item);
                }
              });
              
              body.innerHTML = renderProductRequirementsContent(uniqueUnspscCodes);
            }
          }
          
          showNotification('Requirements imported successfully!', 'success');
        };
        
        reader.readAsText(file);
        event.target.value = '';
      }
      
      // Render Other Requirements Content (3-column layout)
      function renderOtherRequirementsContent() {
        return `
          <!-- Service Descriptions - Compact -->
          <div class="other-req-subsection">
            <div class="subsection-header">
              <span class="subsection-title">Service Descriptions</span>
              <button class="btn btn-secondary btn-sm" onclick="addServiceLine()"><i class="pi pi-plus"></i> Add</button>
            </div>
            <div class="subsection-body">
              ${tenderAuthorConfig.serviceDescriptions.length === 0 ? `
                <div style="text-align: center; padding: var(--spacing-md); color: var(--text-muted); font-size: 12px; border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                  No service lines. Click "+ Add" to create one.
                </div>
              ` : `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  ${tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div class="service-line-compact">
                      <input type="text" class="form-input" value="${service.name}" placeholder="Service name" onchange="updateServiceLine(${idx}, 'name', this.value)" style="flex: 1; font-size: 12px; padding: 6px 10px;" />
                      <input type="text" class="form-input" value="${service.description || ''}" placeholder="Description (optional)" onchange="updateServiceLine(${idx}, 'description', this.value)" style="flex: 2; font-size: 12px; padding: 6px 10px;" />
                      <button class="btn-icon-sm" onclick="removeServiceLine(${idx})" style="font-size: 12px;">√ó</button>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
          
          <!-- Delivery Requirements - 3 Column Layout -->
          <div class="other-req-subsection" style="margin-top: var(--spacing-md);">
            <div class="subsection-header">
              <span class="subsection-title">Delivery Requirements</span>
              <button class="btn btn-secondary btn-sm" onclick="addDeliveryRequirementField()"><i class="pi pi-plus"></i> Add Field</button>
            </div>
            <div class="subsection-body">
              <div class="form-grid-3col">
                ${deliveryRequirementFields.map((field, idx) => {
                  if (field.type === 'text') {
                    return `
                      <div class="form-group">
                        <label class="form-label" style="font-size: 12px;">${field.label}</label>
                        <div style="display: flex; gap: 4px;">
                          <input type="text" class="form-input" value="${field.value}" placeholder="${field.placeholder}" onchange="updateDeliveryFieldValue('${field.id}', this.value)" style="flex: 1; font-size: 12px; padding: 6px 10px;" />
                          <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" style="font-size: 10px;">√ó</button>
                        </div>
                      </div>
                    `;
                  } else if (field.type === 'multi-select' && field.id === 'dr3') {
                    return `
                      <div class="form-group">
                        <label class="form-label" style="font-size: 12px;">${field.label}</label>
                        <select class="form-select" multiple size="3" onchange="updateAllowedIncoterms(this)" style="font-size: 12px;">
                          <option value="EXW" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms?.includes('EXW') ? 'selected' : ''}>EXW</option>
                          <option value="FCA" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms?.includes('FCA') ? 'selected' : ''}>FCA</option>
                          <option value="DAP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms?.includes('DAP') ? 'selected' : ''}>DAP</option>
                          <option value="DDP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms?.includes('DDP') ? 'selected' : ''}>DDP</option>
                        </select>
                      </div>
                    `;
                  } else if (field.type === 'textarea') {
                    return `
                      <div class="form-group full-width">
                        <label class="form-label" style="font-size: 12px;">${field.label}</label>
                        <div style="display: flex; gap: 4px;">
                          <textarea class="form-textarea" placeholder="${field.placeholder}" onchange="updateDeliveryFieldValue('${field.id}', this.value)" style="flex: 1; font-size: 12px; padding: 6px 10px; min-height: 60px;">${field.value}</textarea>
                          <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" style="font-size: 10px;">√ó</button>
                        </div>
                      </div>
                    `;
                  }
                  return '';
                }).join('')}
              </div>
            </div>
          </div>
          
          <!-- Specific Requirements - Full Width -->
          <div class="other-req-subsection" style="margin-top: var(--spacing-md);">
            <div class="subsection-header">
              <span class="subsection-title">Specific Requirements</span>
            </div>
            <div class="subsection-body">
              <div class="form-group" style="margin: 0;">
                <textarea class="form-textarea" placeholder="Enter specific requirements, conditions and additional information..." style="min-height: 80px; font-size: 13px;" onchange="tenderAuthorConfig.specificRequirements = this.value">${tenderAuthorConfig.specificRequirements || ''}</textarea>
              </div>
            </div>
          </div>
        `;
      }
      
      // ===== PRODUCT REQUIREMENTS FUNCTIONS =====
      function renderProductRequirementsSection(block, section, sectionIndex, isFirst) {
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get all UNSPSC codes that need requirements
        let unspscCodesToShow = [];
        
        if (lots.length === 0) {
          // No lots: show requirements per requisition line UNSPSC
          unspscCodesToShow = requisitionLines.map(line => ({
            code: line.unspscCode,
            description: line.unspscDescription,
            source: 'requisition',
            sourceId: line.id,
          }));
        } else {
          // Has lots: show requirements per lot line UNSPSC (UNSPSC inside lots)
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                source: 'lot',
                sourceId: lot.id,
                lotName: lot.name,
              });
            });
          });
        }
        
        // Remove duplicates (same UNSPSC code)
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Define requirements for each UNSPSC code. Choose either a description field for free-text or structured attributes with specific values.
                </div>
              </div>
              
              <!-- Spreadsheet Import/Export -->
              <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                <button class="btn btn-secondary btn-sm" onclick="exportProductRequirementsToSpreadsheet()">
                  <span>üì•</span> Export to Spreadsheet
                </button>
                <button class="btn btn-secondary btn-sm" onclick="uploadProductRequirementsSpreadsheet()">
                  <span>üì§</span> Upload from Spreadsheet
                </button>
                <span style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; margin-left: auto;">
                  Use spreadsheet templates to bulk manage requirements
                </span>
              </div>
              
              ${uniqueUnspscCodes.length === 0 ? `
                <div class="empty-state">
                  <div class="empty-state-icon">üìã</div>
                  <div class="empty-state-text">No UNSPSC codes available</div>
                  <div class="empty-state-hint">${lots.length === 0 ? 'Add requisition lines or create lots with products to define requirements.' : 'Add products to lots to define requirements.'}</div>
                </div>
              ` : `
                <div class="product-requirements-list">
                  ${uniqueUnspscCodes.map(unspsc => {
                    const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                    return `
                      <div class="product-requirement-card" data-unspsc="${unspsc.code}">
                        <div class="product-requirement-header">
                          <div class="product-requirement-title">
                            <span class="unspsc-code-large">${unspsc.code}</span>
                            <span class="unspsc-description-large">${unspsc.description}</span>
                            ${unspsc.lotName ? `<span class="lot-badge">Lot: ${unspsc.lotName}</span>` : ''}
                          </div>
                        </div>
                        
                        <div class="product-requirement-body">
                          <!-- Requirements -->
                          <div class="requirement-section">
                            <div class="requirement-section-header">
                              <h4>Requirements</h4>
                              ${req.requirementType === 'description' ? `
                                <button class="btn btn-ghost btn-sm" onclick="switchToAttributes('${unspsc.code}')">Switch to Attributes</button>
                              ` : req.attributes && req.attributes.length > 0 ? `
                                <button class="btn btn-ghost btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">+ Add Attribute</button>
                              ` : ''}
                            </div>
                            
                            ${!req.requirementType || (req.attributes.length === 0 && !req.description) ? `
                              <div class="requirement-empty">
                                <p>Choose how you want to define requirements for this product:</p>
                                <div style="display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-md);">
                                  <button class="btn btn-primary btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">
                                    <span style="font-size: 18px;">üìã</span> Add Attributes
                                  </button>
                                  <span style="display: flex; align-items: center; color: var(--text-muted); font-weight: 600;">OR</span>
                                  <button class="btn btn-primary btn-sm" onclick="addDescriptionField('${unspsc.code}')">
                                    <span style="font-size: 18px;">üìù</span> Add Description Field
                                  </button>
                                </div>
                                <p style="margin-top: var(--spacing-md); font-size: 13px; color: var(--text-muted); text-align: center;">
                                  Use <strong>Attributes</strong> for structured data (e.g., "Printing technology: Laser") or <strong>Description</strong> for free-text service descriptions
                                </p>
                              </div>
                            ` : req.requirementType === 'description' ? `
                              <div class="requirement-description">
                                <div class="form-group">
                                  <label class="form-label">Product/Service Description</label>
                                  <div class="rich-text-editor-container">
                                    <div class="rich-text-toolbar">
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'italic')" title="Italic (Ctrl+I)"><em>I</em></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'strikeThrough')" title="Strikethrough"><s>S</s></button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'h3')" title="Heading">H1</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'h4')" title="Subheading">H2</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'p')" title="Normal Text">¬∂</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertOrderedList')" title="Numbered List">1. List</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'indent')" title="Increase Indent">‚Üí</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'outdent')" title="Decrease Indent">‚Üê</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyLeft')" title="Align Left">‚¨Ö</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyCenter')" title="Align Center">‚¨å</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyRight')" title="Align Right">‚û°</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="insertLinkByCode('${unspsc.code}')" title="Insert Link">üîó Link</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertHorizontalRule')" title="Insert Line">‚Äî</button>
                                        <button type="button" class="toolbar-btn" onclick="clearFormattingByCode('${unspsc.code}')" title="Clear Formatting">‚úñ Clear</button>
                                      </div>
                                    </div>
                                    <div 
                                      id="rich-text-editor-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}"
                                      class="rich-text-editor" 
                                      contenteditable="true"
                                      data-unspsc="${unspsc.code}"
                                      placeholder="Enter a detailed description of what you want to buy for this product/service. You can include specifications, requirements, quality standards, etc."
                                      oninput="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                                      onblur="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                                      onkeydown="handleEditorKeydown(event, '${unspsc.code}')"
                                    >${req.description || ''}</div>
                                    <div class="editor-footer">
                                      <div class="editor-word-count">
                                        <span id="word-count-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}">Words: 0</span>
                                        <span id="char-count-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}">Characters: 0</span>
                                      </div>
                                      <span>üí° Use formatting tools above to structure your content</span>
                                    </div>
                                  </div>
                                  <span class="help-text">Use this field for detailed, formatted descriptions (ideal for services). Supports rich text formatting, lists, links, and more.</span>
                                </div>
                                <div class="requirement-actions">
                                  <button class="btn btn-ghost btn-sm btn-danger" onclick="clearRequirements('${unspsc.code}')">Clear & Start Over</button>
                                </div>
                              </div>
                            ` : `
                              <div class="requirement-attributes-list">
                                ${req.attributes.map((attr, idx) => `
                                  <div class="requirement-attribute-item">
                                    <div class="attribute-row">
                                      <div class="attribute-name">
                                        <input type="text" class="attribute-name-input" value="${attr.name}" placeholder="Attribute name (e.g., Printing technology)" onchange="updateAttributeName('${unspsc.code}', ${idx}, this.value)" />
                                      </div>
                                      <div class="attribute-value">
                                        <input type="text" class="attribute-value-input" value="${attr.value}" placeholder="Value (e.g., Laser (Monochrome))" onchange="updateAttributeValue('${unspsc.code}', ${idx}, this.value)" />
                                      </div>
                                      <button class="btn-icon-sm" onclick="removeAttribute('${unspsc.code}', ${idx})" title="Remove">‚úñ</button>
                                    </div>
                                  </div>
                                `).join('')}
                              </div>
                              <div class="requirement-actions">
                                <button class="btn btn-ghost btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">+ Add Another Attribute</button>
                                <button class="btn btn-ghost btn-sm btn-danger" onclick="clearRequirements('${unspsc.code}')">Clear & Start Over</button>
                              </div>
                            `}
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      window.addRequirementAttribute = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'attributes', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'attributes';
        productRequirements[unspscCode].attributes.push({
          name: '',
          value: '',
        });
        
        renderCurrentBlock();
      }
      
      window.addDescriptionField = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'description', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'description';
        productRequirements[unspscCode].description = '';
        productRequirements[unspscCode].attributes = []; // Clear attributes
        
        renderCurrentBlock();
        
        // Initialize word count after DOM is updated
        setTimeout(() => {
          initializeEditorWordCount(unspscCode);
        }, 100);
      }
      
      window.updateRequirementDescription = function(unspscCode, newDescription) {
        if (productRequirements[unspscCode]) {
          productRequirements[unspscCode].description = newDescription;
        }
      }
      
      window.updateRequirementDescriptionFromEditor = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        if (editor && productRequirements[unspscCode]) {
          productRequirements[unspscCode].description = editor.innerHTML;
          
          // Update word and character count
          const text = editor.innerText || editor.textContent || '';
          const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
          const chars = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${sanitizedCode}`);
          const charCountEl = document.getElementById(`char-count-${sanitizedCode}`);
          
          if (wordCountEl) wordCountEl.textContent = `Words: ${words}`;
          if (charCountEl) charCountEl.textContent = `Characters: ${chars}`;
        }
      }

      window.initializeEditorWordCount = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        
        if (editor) {
          const text = editor.innerText || editor.textContent || '';
          const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
          const chars = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${sanitizedCode}`);
          const charCountEl = document.getElementById(`char-count-${sanitizedCode}`);
          
          if (wordCountEl) wordCountEl.textContent = `Words: ${words}`;
          if (charCountEl) charCountEl.textContent = `Characters: ${chars}`;
          
          // Focus the editor to make it obvious it's ready
          editor.focus();
        }
      }
      
      window.formatText = function(unspscCode, command, value = null) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        if (!editor) return;
        
        editor.focus();
        document.execCommand(command, false, value);
        updateRequirementDescriptionFromEditor(unspscCode);
      }
      
      window.formatTextByCode = function(unspscCode, command, value = null) {
        formatText(unspscCode, command, value);
      }

      window.insertLinkByCode = function(unspscCode) {
        try {
          const url = prompt('Enter the URL:', 'https://');
          if (url && url.trim() !== '' && url !== 'https://') {
            formatText(unspscCode, 'createLink', url);
          }
        } catch (error) {
          console.error('Error inserting link:', error);
        }
      }

      window.clearFormattingByCode = function(unspscCode) {
        try {
          if (confirm('Remove all formatting from selected text?')) {
            formatText(unspscCode, 'removeFormat');
          }
        } catch (error) {
          console.error('Error clearing formatting:', error);
        }
      }

      window.handleEditorKeydown = function(event, unspscCode) {
        try {
          // Handle keyboard shortcuts
          if (event.ctrlKey || event.metaKey) {
            switch(event.key.toLowerCase()) {
              case 'b':
                event.preventDefault();
                formatText(unspscCode, 'bold');
                break;
              case 'i':
                event.preventDefault();
                formatText(unspscCode, 'italic');
                break;
              case 'u':
                event.preventDefault();
                formatText(unspscCode, 'underline');
                break;
              case 'k':
                event.preventDefault();
                insertLinkByCode(unspscCode);
                break;
            }
          }
          
          // Tab for indent (prevent leaving editor)
          if (event.key === 'Tab') {
            event.preventDefault();
            if (event.shiftKey) {
              formatText(unspscCode, 'outdent');
            } else {
              formatText(unspscCode, 'indent');
            }
          }
        } catch (error) {
          console.error('Error handling keyboard shortcut:', error);
        }
      }
      
      window.switchToAttributes = function(unspscCode) {
        if (confirm('Switching to attributes will clear your description. Continue?')) {
          productRequirements[unspscCode].requirementType = 'attributes';
          productRequirements[unspscCode].description = '';
          productRequirements[unspscCode].attributes = [];
          renderCurrentBlock();
        }
      }
      
      window.clearRequirements = function(unspscCode) {
        if (confirm('This will clear all requirements for this UNSPSC code. Continue?')) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '' };
          renderCurrentBlock();
        }
      }
      
      window.updateAttributeName = function(unspscCode, index, newName) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes[index].name = newName;
        }
      }
      
      window.updateAttributeValue = function(unspscCode, index, newValue) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes[index].value = newValue;
        }
      }
      
      window.removeAttribute = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      window.exportProductRequirementsToSpreadsheet = function() {
        alert('Export to spreadsheet functionality: This would generate an Excel template with all UNSPSC codes and their requirements.');
      }
      
      window.uploadProductRequirementsSpreadsheet = function() {
        alert('Upload spreadsheet functionality: This would open a file picker to upload an Excel file with requirements data.');
      }
      
      // ===== BID RESPONSE FIELDS MANAGEMENT =====
      window.addBidResponseField = function(section) {
        const fieldName = prompt('Enter field name:');
        if (!fieldName) return;
        
        const fieldType = prompt('Enter field type (e.g., Text input, Currency input, Yes/No radio, Text area, etc.):');
        if (!fieldType) return;
        
        const newField = {
          id: `custom_${fieldIdCounter++}`,
          name: fieldName,
          type: fieldType || 'Text input'
        };
        
        bidResponseFields[section].push(newField);
        renderCurrentBlock();
      }
      
      window.removeBidResponseField = function(section, fieldId) {
        if (confirm('Are you sure you want to remove this field?')) {
          const index = bidResponseFields[section].findIndex(f => f.id === fieldId);
          if (index !== -1) {
            bidResponseFields[section].splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      // ===== SUBMISSION FORMS MANAGEMENT =====
      window.toggleSubmissionForm = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (form) {
          form.added = !form.added;
          renderCurrentBlock();
        }
      }
      
      window.toggleFormPreview = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (form) {
          alert(`Preview of "${form.name}":\n\n${form.description}\n\nThis would open a modal showing the full form template.`);
        }
      }
      
      window.handleFormsDragOver = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('submission-forms-drop-zone');
        if (dropZone) {
          dropZone.classList.add('drag-over');
        }
      }
      
      window.handleFormsDragLeave = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('submission-forms-drop-zone');
        if (dropZone) {
          dropZone.classList.remove('drag-over');
        }
      }
      
      window.handleFormsDrop = function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropZone = document.getElementById('submission-forms-drop-zone');
        if (dropZone) {
          dropZone.classList.remove('drag-over');
        }
        
        // Get the form data from the dragged item (from form library)
        const formType = event.dataTransfer.getData('form-type');
        const formName = event.dataTransfer.getData('form-name');
        
        if (formType && formName) {
          // Check if this form already exists by name match
          const existingForm = submissionForms.find(f => 
            f.name.toLowerCase() === formName.toLowerCase() ||
            f.name.toLowerCase().includes(formName.toLowerCase().split(' ')[0])
          );
          
          if (existingForm) {
            // If form exists but not added, add it
            if (!existingForm.added) {
              existingForm.added = true;
              renderCurrentBlock();
            }
          } else {
            // Add new form to the list
            const icons = {
              'instructions': 'üìã',
              'contracts': 'üìù',
              'bank-guarantee': 'üè¶',
              'bid-security': 'üîí',
              'drive-questionnaire': 'üõ°Ô∏è',
              'technical-specs': '‚öôÔ∏è',
              'evaluation': '‚úÖ',
              'price-schedule': 'üí∞'
            };
            
            const newForm = {
              id: `form-custom-${Date.now()}`,
              code: String.fromCharCode(65 + submissionForms.length), // Next letter (I, J, K...)
              name: formName,
              description: `Custom form added from library`,
              icon: icons[formType] || 'üìÑ',
              required: false,
              added: true
            };
            submissionForms.push(newForm);
            renderCurrentBlock();
          }
        }
      }
      
      window.handleFormCardDragStart = function(event, formId) {
        event.dataTransfer.setData('text/plain', formId);
        event.dataTransfer.setData('source', 'submission-forms');
        event.dataTransfer.effectAllowed = 'move';
      }
      
      // ===== DELIVERY REQUIREMENTS FIELDS MANAGEMENT =====
      window.addDeliveryRequirementField = function() {
        const fieldLabel = prompt('Enter field label:');
        if (!fieldLabel) return;
        
        const fieldType = prompt('Enter field type (text, textarea, select):');
        if (!fieldType) return;
        
        const newField = {
          id: `dr_custom_${fieldIdCounter++}`,
          label: fieldLabel,
          type: fieldType || 'text',
          placeholder: '',
          value: ''
        };
        
        deliveryRequirementFields.push(newField);
        renderCurrentBlock();
      }
      
      window.removeDeliveryRequirementField = function(fieldId) {
        if (confirm('Are you sure you want to remove this field?')) {
          const index = deliveryRequirementFields.findIndex(f => f.id === fieldId);
          if (index !== -1) {
            deliveryRequirementFields.splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      window.updateDeliveryFieldValue = function(fieldId, value) {
        const field = deliveryRequirementFields.find(f => f.id === fieldId);
        if (field) {
          field.value = value;
          // Also update tenderAuthorConfig for backwards compatibility
          if (fieldId === 'dr1') tenderAuthorConfig.deliveryConfig.deliveryTime = value;
          if (fieldId === 'dr2') tenderAuthorConfig.deliveryConfig.deliveryPlace = value;
          if (fieldId === 'dr4') tenderAuthorConfig.deliveryConfig.consigneeDetails = value;
        }
      }
      
      // ===== SUPPLIER FORM PREVIEW TOGGLE =====
      window.toggleSupplierFormPreview = function() {
        isSupplierFormPreviewVisible = !isSupplierFormPreviewVisible;
        renderCurrentBlock();
      }
      
      // ===== EVALUATION CRITERIA MANAGEMENT =====
      window.addEvaluationCriterion = function() {
        const newCriterion = {
          id: `ec_${evaluationCriteriaIdCounter++}`,
          type: 'Eligibility and formal criteria',
          description: '',
          evaluationMethod: 'Pass/Fail',
          appliesTo: 'entire',
          lots: [],
          unspscCodes: []
        };
        evaluationCriteria.push(newCriterion);
        renderCurrentBlock();
      }
      
      window.removeEvaluationCriterion = function(criterionId) {
        if (confirm('Are you sure you want to remove this evaluation criterion?')) {
          const index = evaluationCriteria.findIndex(c => c.id === criterionId);
          if (index !== -1) {
            evaluationCriteria.splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      window.updateEvaluationCriterionType = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.type = value;
        }
      }
      
      window.updateEvaluationCriterionDescription = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.description = value;
        }
      }
      
      window.updateEvaluationCriterionMethod = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.evaluationMethod = value;
        }
      }
      
      window.updateEvaluationCriterionAppliesTo = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.appliesTo = value;
          if (value === 'entire') {
            criterion.unspscCodes = [];
          }
          renderCurrentBlock();
        }
      }
      
      window.updateEvaluationCriterionLots = function(criterionId, selectElement) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          const selectedOptions = Array.from(selectElement.selectedOptions);
          criterion.lots = selectedOptions.map(opt => opt.value);
          
          // Auto-populate UNSPSC codes from selected lots
          criterion.unspscCodes = [];
          criterion.lots.forEach(lotId => {
            const lot = lots.find(l => l.id === lotId);
            if (lot) {
              lot.unspscCodes.forEach(unspsc => {
                if (!criterion.unspscCodes.includes(unspsc.code)) {
                  criterion.unspscCodes.push(unspsc.code);
                }
              });
            }
          });
        }
      }

      window.updateEvaluationCriterionUnspscCodes = function(criterionId, selectElement) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          const selectedOptions = Array.from(selectElement.selectedOptions);
          criterion.unspscCodes = selectedOptions.map(opt => opt.value);
        }
      }
      
      window.getAvailableUnspscCodes = function() {
        // Get unique UNSPSC codes from requisition lines and lots
        let unspscCodes = [];
        
        // From requisition lines
        requisitionLines.forEach(line => {
          if (!unspscCodes.some(u => u.code === line.unspscCode)) {
            unspscCodes.push({
              code: line.unspscCode,
              description: line.unspscDescription
            });
          }
        });
        
        // From lots
        lots.forEach(lot => {
          lot.unspscCodes.forEach(unspsc => {
            if (!unspscCodes.some(u => u.code === unspsc.code)) {
              unspscCodes.push({
                code: unspsc.code,
                description: unspsc.description || 'No description'
              });
            }
          });
        });
        
        return unspscCodes;
      }
      
      // ===== GENERAL INFORMATION - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateSourcingOrSolicitation = function(value) {
        generalInfoValues.sourcingOrSolicitation = value;
        renderCurrentBlock();
      }
      
      window.updateModalityOfBidReceipt = function(value) {
        generalInfoValues.modalityOfBidReceipt = value;
        renderCurrentBlock();
      }
      
      window.updateEPP = function(value) {
        generalInfoValues.epp = value;
        renderCurrentBlock();
      }
      
      window.updateMedicineOrMedical = function(value) {
        generalInfoValues.medicineOrMedical = value;
        renderCurrentBlock();
      }
      
      window.updateProcessType = function(checkbox) {
        const value = checkbox.value;
        const isChecked = checkbox.checked;
        
        if (isChecked) {
          if (!generalInfoValues.processType.includes(value)) {
            generalInfoValues.processType.push(value);
          }
        } else {
          generalInfoValues.processType = generalInfoValues.processType.filter(v => v !== value);
        }
        
        generalInfoValues.directContracting = generalInfoValues.processType.includes('Direct contracting / Sole sourcing');
        renderCurrentBlock();
      }
      
      window.updateUNCollaboration = function(value) {
        generalInfoValues.unCollaboration = value;
        renderCurrentBlock();
      }
      
      window.updateIsLease = function(value) {
        generalInfoValues.isLease = value;
        renderCurrentBlock();
      }
      
      window.shouldShowField = function(field) {
        if (!field.conditionalVisibility) return true;
        
        const condition = field.conditionalVisibility;
        
        // Complex condition for Linked Process
        if (condition.complex && field.id === 'linkedProcess') {
          const hasDirectContracting = generalInfoValues.processType.includes('Direct contracting / Sole sourcing');
          const hasSolicitation = generalInfoValues.sourcingOrSolicitation !== '';
          const hasLTABPA = generalInfoValues.processType.includes('Solicit offers against LTA/BPA');
          const hasContractAmendment = generalInfoValues.processType.includes('Contract Amendment');
          return hasDirectContracting || hasSolicitation || hasLTABPA || hasContractAmendment;
        }
        
        // Single value condition - Check both generalInfoValues and evaluationBlockValues
        if (condition.field && condition.value) {
          if (generalInfoValues[condition.field] !== undefined) {
            return generalInfoValues[condition.field] === condition.value;
          }
          if (evaluationBlockValues[condition.field] !== undefined) {
            return evaluationBlockValues[condition.field] === condition.value;
          }
        }
        
        // Multiple values condition
        if (condition.field && condition.values) {
          if (generalInfoValues[condition.field] !== undefined) {
            return condition.values.includes(generalInfoValues[condition.field]);
          }
          if (evaluationBlockValues[condition.field] !== undefined) {
            return condition.values.includes(evaluationBlockValues[condition.field]);
          }
        }
        
        // Contains condition (for checkboxes)
        if (condition.field && condition.contains) {
          return generalInfoValues.processType.includes(condition.contains);
        }
        
        return true;
      }
      
      // ===== EVALUATION BLOCK - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateEvaluationMethodInEvaluation = function(value) {
        evaluationBlockValues.evaluationMethod = value;
        renderCurrentBlock();
      }
      
      window.updateEvaluationMethodDetailsInEvaluation = function(value) {
        evaluationBlockValues.evaluationMethodDetails = value;
        renderCurrentBlock();
      }
      
      // ===== PARTICULARS - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateClarificationsOrPreBid = function(value) {
        particularsValues.clarificationsOrPreBid = value;
        // Parse number of meetings from value
        if (value === 'One pre-bid meeting') {
          particularsValues.numberOfMeetings = 1;
        } else if (value === 'Two pre-bid meetings') {
          particularsValues.numberOfMeetings = 2;
        } else {
          particularsValues.numberOfMeetings = 0;
        }
        renderCurrentBlock();
      }
      
      window.updateSiteVisit = function(value) {
        particularsValues.siteVisit = value;
        renderCurrentBlock();
      }
      
      window.updateSiteVisitDateOption = function(value) {
        particularsValues.dateOption = value;
        renderCurrentBlock();
      }
      
      window.updateExclusivity = function(value) {
        particularsValues.exclusivity = value;
        renderCurrentBlock();
      }
      
      window.updateAlternativeOffers = function(value) {
        particularsValues.alternativeOffers = value;
        renderCurrentBlock();
      }
      
      window.updateAdvancePaymentAllowed = function(value) {
        particularsValues.advancePaymentAllowed = value;
        renderCurrentBlock();
      }
      
      window.updateAdvancePaymentSecurity = function(value) {
        particularsValues.advancePaymentSecurity = value;
        renderCurrentBlock();
      }
      
      window.updateLiquidatedDamages = function(value) {
        particularsValues.liquidatedDamages = value;
        renderCurrentBlock();
      }
      
      window.updatePerformanceSecurity = function(value) {
        particularsValues.performanceSecurity = value;
        renderCurrentBlock();
      }
      
      window.updateBidSecurity = function(value) {
        particularsValues.bidSecurity = value;
        renderCurrentBlock();
      }

      // ===== TENDER AUTHOR CONFIGURATION SECTION =====
      let tenderAuthorConfig = {
        serviceDescriptions: [], // [{ name, description }]
        deliveryConfig: {
          deliveryTime: '',
          deliveryPlace: '',
          allowedIncoterms: [],
          consigneeDetails: '',
        },
        specificRequirements: '', // Specific requirements, conditions and additional information
      };
      
      function renderTenderAuthorConfigSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Configure tender-specific requirements that will be used to structure supplier responses
                </div>
              </div>
              
              <!-- 1. Service Descriptions -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0;">1. Service Descriptions</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addServiceLine()">+ Add Service Line</button>
                </div>
                <div id="service-lines-list" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${tenderAuthorConfig.serviceDescriptions.length === 0 ? `
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted); border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                      No service lines defined. Click "+ Add Service Line" to start.
                    </div>
                  ` : tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); background: var(--surface-50);">
                      <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: var(--spacing-md); align-items: start;">
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Service Name</label>
                          <input type="text" class="form-input" value="${service.name}" placeholder="e.g., Installation Services" style="font-size: 13px; padding: 8px;" onchange="updateServiceLine(${idx}, 'name', this.value)" />
                        </div>
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Description (Optional)</label>
                          <textarea class="form-textarea" placeholder="Service description" style="font-size: 13px; padding: 8px; min-height: 60px;" onchange="updateServiceLine(${idx}, 'description', this.value)">${service.description || ''}</textarea>
                        </div>
                        <button class="btn-icon-sm" onclick="removeServiceLine(${idx})" style="margin-top: 24px;">‚úñ</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- 2. Delivery Requirements -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0;">2. Delivery Requirements</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addDeliveryRequirementField()" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div class="form-grid">
                  ${deliveryRequirementFields.map((field, idx) => {
                    if (field.type === 'text') {
                      return `
                        <div class="form-group" style="position: relative;">
                          <label class="form-label">${field.label}</label>
                          <div style="display: flex; gap: 8px; align-items: start;">
                            <input type="text" class="form-input" value="${field.value}" placeholder="${field.placeholder}" onchange="updateDeliveryFieldValue('${field.id}', this.value)" style="flex: 1;" />
                            <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" title="Remove field">‚úñ</button>
                          </div>
                        </div>
                      `;
                    } else if (field.type === 'multi-select' && field.id === 'dr3') {
                      return `
                        <div class="form-group full-width" style="position: relative;">
                          <label class="form-label">${field.label}</label>
                          <div style="display: flex; gap: 8px; align-items: start;">
                            <div style="flex: 1;">
                              <select class="form-select" multiple size="4" onchange="updateAllowedIncoterms(this)">
                                <option value="EXW" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('EXW') ? 'selected' : ''}>EXW - Ex Works</option>
                                <option value="FCA" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('FCA') ? 'selected' : ''}>FCA - Free Carrier</option>
                                <option value="CPT" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('CPT') ? 'selected' : ''}>CPT - Carriage Paid To</option>
                                <option value="CIP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('CIP') ? 'selected' : ''}>CIP - Carriage and Insurance Paid To</option>
                                <option value="DAP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('DAP') ? 'selected' : ''}>DAP - Delivered at Place</option>
                                <option value="DPU" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('DPU') ? 'selected' : ''}>DPU - Delivered at Place Unloaded</option>
                                <option value="DDP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('DDP') ? 'selected' : ''}>DDP - Delivered Duty Paid</option>
                              </select>
                              <span class="help-text">Hold Ctrl/Cmd to select multiple Incoterms</span>
                            </div>
                            <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" title="Remove field">‚úñ</button>
                          </div>
                        </div>
                      `;
                    } else if (field.type === 'textarea') {
                      return `
                        <div class="form-group full-width" style="position: relative;">
                          <label class="form-label">${field.label}</label>
                          <div style="display: flex; gap: 8px; align-items: start;">
                            <textarea class="form-textarea" placeholder="${field.placeholder}" onchange="updateDeliveryFieldValue('${field.id}', this.value)" style="flex: 1;">${field.value}</textarea>
                            <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" title="Remove field">‚úñ</button>
                          </div>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              </div>
              
              <!-- 3. Specific Requirements -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0;">3. Specific Requirements</h4>
                <div class="form-group">
                  <label class="form-label">Specific requirements, conditions and additional information</label>
                  <textarea class="form-textarea" placeholder="Enter specific requirements, conditions and additional information..." style="min-height: 120px;" onchange="tenderAuthorConfig.specificRequirements = this.value">${tenderAuthorConfig.specificRequirements || ''}</textarea>
                  <span class="help-text">Add any specific requirements, conditions, or additional information that suppliers need to know</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Helper functions for Tender Author Config
      window.addServiceLine = function() {
        tenderAuthorConfig.serviceDescriptions.push({
          name: '',
          description: '',
        });
        renderCurrentBlock();
      }
      
      window.updateServiceLine = function(idx, field, value) {
        if (tenderAuthorConfig.serviceDescriptions[idx]) {
          tenderAuthorConfig.serviceDescriptions[idx][field] = value;
        }
      }
      
      window.removeServiceLine = function(idx) {
        tenderAuthorConfig.serviceDescriptions.splice(idx, 1);
        renderCurrentBlock();
      }
      
      window.updateAllowedIncoterms = function(selectElement) {
        const selectedOptions = Array.from(selectElement.selectedOptions).map(option => option.value);
        tenderAuthorConfig.deliveryConfig.allowedIncoterms = selectedOptions;
      }
      
      // ===== SUPPLIER FORM PREVIEW SECTION =====
      function renderSupplierFormPreviewSection(block, section, sectionIndex, isFirst) {
        // Check if preview should be visible
        if (!isSupplierFormPreviewVisible) {
          return '';
        }
        
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get all UNSPSC codes
        let unspscCodesToShow = [];
        if (lots.length === 0) {
          unspscCodesToShow = requisitionLines.map(line => ({
            code: line.unspscCode,
            description: line.unspscDescription,
          }));
        } else {
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                lotName: lot.name,
              });
            });
          });
        }
        
        // Remove duplicates
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg); background: var(--info-100); border-color: var(--info-400);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è <strong>Preview:</strong> This shows how the supplier form will appear with the configured requirements. Fields below are pre-populated from your tender configuration.
                </div>
              </div>
              
              <!-- A. Per Bid Responses -->
              <div style="background: var(--surface-0); border: 1px solid var(--primary-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--primary-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                  <span style="background: var(--primary-100); color: var(--primary-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">A</span>
                  Per Bid (answered once)
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Bidder's Total Prices [Incoterm]</label>
                    <input type="number" class="form-input" placeholder="Enter total price" disabled />
                    <span class="help-text">Supplier will enter their total price here</span>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Customs clearance costs</label>
                    <input type="number" class="form-input" placeholder="Enter customs costs" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Freight cost</label>
                    <input type="number" class="form-input" placeholder="Enter freight cost" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Price of Goods [Incoterm]</label>
                    <input type="number" class="form-input" placeholder="Calculated automatically" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Price of Related Services</label>
                    <input type="number" class="form-input" placeholder="Enter services price" disabled />
                  </div>
                </div>
              </div>
              
              <!-- B. Per UNSPSC Responses -->
              ${uniqueUnspscCodes.length > 0 ? uniqueUnspscCodes.map((unspsc, idx) => {
                const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                return `
                  <div style="background: var(--surface-0); border: 1px solid var(--info-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--info-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                      <span style="background: var(--info-100); color: var(--info-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">B${idx + 1}</span>
                      Per UNSPSC: ${unspsc.code}
                    </h3>
                    <div style="background: var(--surface-50); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-lg);">
                      <strong style="font-size: 14px;">${unspsc.description}</strong>
                      ${unspsc.lotName ? `<span style="font-size: 13px; color: var(--text-muted); display: block; margin-top: 4px;">Lot: ${unspsc.lotName}</span>` : ''}
                    </div>
                    
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Unit price Incoterm</label>
                        <input type="number" class="form-input" placeholder="Enter unit price" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Total price Incoterm</label>
                        <input type="number" class="form-input" placeholder="Calculated" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Country of Origin</label>
                        <select class="form-select" disabled>
                          <option>Select country...</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label">Delivery point(s)</label>
                        <input type="text" class="form-input" placeholder="Enter delivery points" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-input" placeholder="Enter model" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-input" placeholder="Enter manufacturer" disabled />
                      </div>
                    </div>
                    
                    <!-- C. Per Attribute (for this UNSPSC) -->
                    ${req.requirementType === 'attributes' && req.attributes.length > 0 ? `
                      <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--success-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                          <span style="background: var(--success-100); color: var(--success-600); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700;">C</span>
                          Product Attributes
                        </h4>
                        ${req.attributes.map(attr => `
                          <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <strong style="font-size: 14px; display: block; margin-bottom: 8px; color: var(--success-700);">${attr.name}: ${attr.value}</strong>
                            <div class="form-grid">
                              <div class="form-group" style="margin: 0;">
                                <label class="form-label">Is quotation compliant?</label>
                                <div style="display: flex; gap: var(--spacing-md);">
                                  <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="compliant-${unspsc.code}-${attr.name}" disabled />
                                    <span style="font-size: 14px;">Yes</span>
                                  </label>
                                  <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="compliant-${unspsc.code}-${attr.name}" disabled />
                                    <span style="font-size: 14px;">No</span>
                                  </label>
                                </div>
                              </div>
                              <div class="form-group" style="margin: 0;">
                                <label class="form-label">Details of goods offered</label>
                                <textarea class="form-textarea" placeholder="Supplier will describe their offering" style="min-height: 60px;" disabled></textarea>
                              </div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    ` : req.requirementType === 'description' && req.description ? `
                      <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--success-600);">Product Requirements (Description)</h4>
                        <div style="background: var(--surface-0); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); white-space: pre-wrap; font-size: 14px; line-height: 1.5;">
                          ${req.description}
                        </div>
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-desc-${unspsc.code}" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-desc-${unspsc.code}" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="form-label">Details of goods offered</label>
                          <textarea class="form-textarea" placeholder="Supplier will describe their offering" style="min-height: 80px;" disabled></textarea>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') : '<div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">No UNSPSC codes defined. Add requisition lines or lots to see UNSPSC-level fields.</div>'}
              
              <!-- D. Per Service Line -->
              ${tenderAuthorConfig.serviceDescriptions.length > 0 ? `
                <div style="background: var(--surface-0); border: 1px solid var(--warning-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                  <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--warning-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="background: var(--warning-100); color: var(--warning-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">D</span>
                    Per Service Line
                  </h3>
                  ${tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0;">${service.name || `Service ${idx + 1}`}</h4>
                      ${service.description ? `<p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">${service.description}</p>` : ''}
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-service-${idx}" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-service-${idx}" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide service details" style="min-height: 80px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <!-- E. Delivery Requirements -->
              ${tenderAuthorConfig.deliveryConfig.deliveryTime || tenderAuthorConfig.deliveryConfig.deliveryPlace || (tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.length > 0) || tenderAuthorConfig.deliveryConfig.consigneeDetails ? `
                <div style="background: var(--surface-0); border: 1px solid var(--danger-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                  <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--danger-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="background: var(--danger-100); color: var(--danger-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">E</span>
                    Delivery Requirements
                  </h3>
                  ${tenderAuthorConfig.deliveryConfig.deliveryTime ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">Delivery Time</h4>
                      <p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Required: ${tenderAuthorConfig.deliveryConfig.deliveryTime}</p>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-time" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-time" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide delivery time details" style="min-height: 60px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                  ${tenderAuthorConfig.deliveryConfig.deliveryPlace ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">Delivery Place</h4>
                      <p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Required: ${tenderAuthorConfig.deliveryConfig.deliveryPlace}</p>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-place" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-place" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide delivery place details" style="min-height: 60px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      // ===== BID RESPONSE REQUIREMENTS SECTION =====
      function renderSupplierResponseStructureSection(block, section, sectionIndex, isFirst) {
        const addedFormsCount = submissionForms.filter(f => f.added).length;
        const requiredFormsCount = submissionForms.filter(f => f.required).length;
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              <!-- Required Forms Section - Collapsible -->
              <div class="collapsible-section" id="submission-forms-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('submission-forms-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Required Forms</span>
                    <span class="section-progress-badge" style="margin-left: 8px; font-size: 11px; background: var(--primary-50); color: var(--primary-600); padding: 2px 8px; border-radius: 10px;">${addedFormsCount} forms included</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                    <div class="info-alert-text">
                      üìÑ Configure the standard forms to include in your tender package. Drag forms from the Form Library panel to add more.
                    </div>
                  </div>
                  
                  <!-- Forms Drop Zone -->
                  <div class="submission-forms-drop-zone" id="submission-forms-drop-zone" 
                       ondragover="handleFormsDragOver(event)" 
                       ondragleave="handleFormsDragLeave(event)" 
                       ondrop="handleFormsDrop(event)">
                    <div class="submission-forms-grid">
                      ${submissionForms.map(form => `
                        <div class="submission-form-card ${form.added ? 'added' : 'not-added'} ${form.required ? 'required' : ''}" 
                             data-form-id="${form.id}"
                             draggable="true"
                             ondragstart="handleFormCardDragStart(event, '${form.id}')">
                          <div class="submission-form-card-header">
                            <div class="submission-form-code">${form.code}</div>
                            <div class="submission-form-actions">
                              ${form.added ? `
                                <button class="btn-icon-xs preview" onclick="event.stopPropagation(); toggleFormPreview('${form.id}')" title="Preview form"><i class="pi pi-eye"></i></button>
                                ${!form.required ? `<button class="btn-icon-xs danger" onclick="event.stopPropagation(); toggleSubmissionForm('${form.id}')" title="Remove form"><i class="pi pi-times"></i></button>` : ''}
                              ` : `
                                <button class="btn-icon-xs success" onclick="event.stopPropagation(); toggleSubmissionForm('${form.id}')" title="Add form"><i class="pi pi-plus"></i></button>
                              `}
                            </div>
                          </div>
                          <div class="submission-form-icon">${form.icon}</div>
                          <div class="submission-form-name">${form.name}</div>
                          <div class="submission-form-description">${form.description}</div>
                          ${form.required ? '<div class="submission-form-required-badge">Required</div>' : ''}
                          ${!form.added ? '<div class="submission-form-overlay"><span>Click + to add</span></div>' : ''}
                        </div>
                      `).join('')}
                    </div>
                    <div class="submission-forms-drop-hint" id="forms-drop-hint">
                      <i class="pi pi-download"></i> Drop forms here from the Form Library
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Bid Response Structure Section - Collapsible -->
              <div class="collapsible-section collapsed" id="bid-response-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('bid-response-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Bid Response Structure</span>
                    <span class="section-progress-badge" style="margin-left: 8px; font-size: 11px; background: var(--info-50); color: var(--info-600); padding: 2px 8px; border-radius: 10px;">5 categories</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                    <div class="info-alert-text">
                      ‚ÑπÔ∏è Define how supplier responses will be structured and grouped by answer level
                    </div>
                  </div>
                  
                  <div style="display: flex; justify-content: flex-end; margin-bottom: var(--spacing-md);">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); toggleSupplierFormPreview()">
                      <i class="pi pi-eye"></i> Preview Supplier Form
                    </button>
                  </div>
                  
                  <!-- A. Per Bid -->
                  <div class="bid-response-category" style="border-left-color: var(--primary-400);">
                    <div class="bid-response-category-header">
                      <h4 style="color: var(--primary-600);">A. Per Bid</h4>
                      <span class="bid-response-category-hint">Answered once for entire bid</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addBidResponseField('perBid')"><i class="pi pi-plus"></i> Add Field</button>
                    </div>
                    <div class="bid-response-fields">
                      ${bidResponseFields.perBid.map((field, idx) => `
                        <div class="bid-response-field">
                          <div class="bid-response-field-info">
                            <strong>${field.name}</strong>
                            <span>${field.type}</span>
                          </div>
                          <button class="btn-icon-xs danger" onclick="event.stopPropagation(); removeBidResponseField('perBid', '${field.id}')" title="Remove"><i class="pi pi-times"></i></button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <!-- B. Per UNSPSC -->
                  <div class="bid-response-category" style="border-left-color: var(--info-400);">
                    <div class="bid-response-category-header">
                      <h4 style="color: var(--info-600);">B. Per UNSPSC</h4>
                      <span class="bid-response-category-hint">For each UNSPSC item</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addBidResponseField('perUNSPSC')"><i class="pi pi-plus"></i> Add Field</button>
                    </div>
                    <div class="bid-response-fields">
                      ${bidResponseFields.perUNSPSC.map((field, idx) => `
                        <div class="bid-response-field">
                          <div class="bid-response-field-info">
                            <strong>${field.name}</strong>
                            <span>${field.type}</span>
                          </div>
                          <button class="btn-icon-xs danger" onclick="event.stopPropagation(); removeBidResponseField('perUNSPSC', '${field.id}')" title="Remove"><i class="pi pi-times"></i></button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <!-- C. Per Attribute -->
                  <div class="bid-response-category" style="border-left-color: var(--success-500);">
                    <div class="bid-response-category-header">
                      <h4 style="color: var(--success-600);">C. Per Attribute</h4>
                      <span class="bid-response-category-hint">Under each UNSPSC attribute</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addBidResponseField('perAttribute')"><i class="pi pi-plus"></i> Add Field</button>
                    </div>
                    <div class="bid-response-fields">
                      ${bidResponseFields.perAttribute.map((field, idx) => `
                        <div class="bid-response-field">
                          <div class="bid-response-field-info">
                            <strong>${field.name}</strong>
                            <span>${field.type}</span>
                          </div>
                          <button class="btn-icon-xs danger" onclick="event.stopPropagation(); removeBidResponseField('perAttribute', '${field.id}')" title="Remove"><i class="pi pi-times"></i></button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <!-- D. Per Service Line -->
                  <div class="bid-response-category" style="border-left-color: var(--warning-500);">
                    <div class="bid-response-category-header">
                      <h4 style="color: var(--warning-600);">D. Per Service Line</h4>
                      <span class="bid-response-category-hint">For service-based items</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addBidResponseField('perServiceLine')"><i class="pi pi-plus"></i> Add Field</button>
                    </div>
                    <div class="bid-response-fields">
                      ${bidResponseFields.perServiceLine.map((field, idx) => `
                        <div class="bid-response-field">
                          <div class="bid-response-field-info">
                            <strong>${field.name}</strong>
                            <span>${field.type}</span>
                          </div>
                          <button class="btn-icon-xs danger" onclick="event.stopPropagation(); removeBidResponseField('perServiceLine', '${field.id}')" title="Remove"><i class="pi pi-times"></i></button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  
                  <!-- E. Delivery Requirements -->
                  <div class="bid-response-category" style="border-left-color: var(--danger-500);">
                    <div class="bid-response-category-header">
                      <h4 style="color: var(--danger-600);">E. Per Delivery</h4>
                      <span class="bid-response-category-hint">Delivery requirements</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addBidResponseField('perDelivery')"><i class="pi pi-plus"></i> Add Field</button>
                    </div>
                    <div class="bid-response-fields">
                      ${bidResponseFields.perDelivery.map((field, idx) => `
                        <div class="bid-response-field">
                          <div class="bid-response-field-info">
                            <strong>${field.name}</strong>
                            <span>${field.type}</span>
                          </div>
                          <button class="btn-icon-xs danger" onclick="event.stopPropagation(); removeBidResponseField('perDelivery', '${field.id}')" title="Remove"><i class="pi pi-times"></i></button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        `;
      }

      // ===== AUTHORING FUNCTIONS =====
      function initAuthoring() {
        initializeRequisitionLines(); // Initialize sample data
        renderBlockTabs();
        renderCurrentBlock();
        updateProgressSteps();
        updateNavigationButtons();
        setupFormLibrary();
        // Setup drop zones after a short delay to ensure DOM is ready
        setTimeout(() => {
          setupDropZones();
        }, 100);
      }

      function renderBlockTabs() {
        const nav = document.getElementById('block-nav');
        nav.innerHTML = '';

        templateBlocks.forEach((block, index) => {
          const tab = document.createElement('button');
          tab.className = 'block-tab';
          if (index === currentBlockIndex) {
            tab.classList.add('active');
          }
          
          // Calculate a mock progress for visual demo (in real app, this would be based on actual completion)
          const progress = index < currentBlockIndex ? 100 : (index === currentBlockIndex ? 30 : 0);
          const isCompleted = index < currentBlockIndex;
          
          if (isCompleted) {
            tab.classList.add('completed');
          }
          
          // Generate progress status text
          let progressStatus = '';
          let progressClass = '';
          let statusIcon = '';
          if (progress === 100) {
            progressStatus = 'Complete';
            progressClass = 'status-complete';
            statusIcon = '‚úì';
          } else if (progress > 0) {
            progressStatus = 'In progress';
            progressClass = 'status-in-progress';
            statusIcon = '‚óè';
          } else {
            progressStatus = 'Not started';
            progressClass = 'status-pending';
            statusIcon = '‚óã';
          }
          
          // Show checkmark in number circle if completed
          const numberContent = isCompleted ? '‚úì' : (index + 1);
          
          // Get the PrimeIcon class or fallback to emoji
          const iconClass = block.piIcon || '';
          
          tab.innerHTML = `
            <span class="block-tab-number">${numberContent}</span>
            ${iconClass ? `<i class="block-tab-pi-icon pi ${iconClass}"></i>` : ''}
            <span class="block-tab-icon">${block.icon}</span>
            <span class="block-tab-content">
              <span class="block-tab-name">${block.name}</span>
              <span class="block-tab-status ${progressClass}">${statusIcon} ${progressStatus}</span>
            </span>
            <span class="block-tab-badge">${index + 1}</span>
            <div class="block-tab-progress">
              <div class="block-tab-progress-bar" style="width: ${progress}%"></div>
            </div>
          `;
          tab.addEventListener('click', () => {
            switchToBlock(index);
          });
          nav.appendChild(tab);
        });
      }

      function switchToBlock(index) {
        currentBlockIndex = index;
        renderBlockTabs();
        renderCurrentBlock();
        updateNavigationButtons();
      }

      function renderEvaluationCriteriaSection(block, section, sectionIndex, isFirst) {
        // Get available UNSPSC codes
        const availableUnspscCodes = getAvailableUnspscCodes();
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Define evaluation criteria that will be used to assess supplier submissions
                </div>
              </div>
              
              <div style="display: flex; justify-content: flex-end; margin-bottom: var(--spacing-lg);">
                <button class="btn btn-primary btn-sm" onclick="addEvaluationCriterion()">+ Add Evaluation Criterion</button>
              </div>
              
              ${evaluationCriteria.length === 0 ? `
                <div class="empty-state">
                  <div class="empty-state-icon">üìä</div>
                  <div class="empty-state-text">No evaluation criteria defined</div>
                  <div class="empty-state-hint">Click "+ Add Evaluation Criterion" to define how submissions will be evaluated</div>
                </div>
              ` : `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                  ${evaluationCriteria.map((criterion, idx) => `
                    <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); box-shadow: var(--shadow-card);">
                      <div style="display: flex; justify-content: between; align-items: start; margin-bottom: var(--spacing-md);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0; flex: 1;">Criterion ${idx + 1}</h4>
                        <button class="btn-icon-sm" onclick="removeEvaluationCriterion('${criterion.id}')" title="Remove criterion">‚úñ</button>
                      </div>
                      
                      <div class="form-grid">
                        <!-- Type -->
                        <div class="form-group">
                          <label class="form-label">Type <span class="required-indicator">*</span></label>
                          <select class="form-select" value="${criterion.type}" onchange="updateEvaluationCriterionType('${criterion.id}', this.value)">
                            <option value="Eligibility and formal criteria" ${criterion.type === 'Eligibility and formal criteria' ? 'selected' : ''}>Eligibility and formal criteria</option>
                            <option value="Qualification criteria" ${criterion.type === 'Qualification criteria' ? 'selected' : ''}>Qualification criteria</option>
                            <option value="Technical criteria" ${criterion.type === 'Technical criteria' ? 'selected' : ''}>Technical criteria</option>
                            <option value="Shortlisting criteria" ${criterion.type === 'Shortlisting criteria' ? 'selected' : ''}>Shortlisting criteria</option>
                          </select>
                        </div>
                        
                        <!-- Evaluation Method -->
                        <div class="form-group">
                          <label class="form-label">Evaluation Method <span class="required-indicator">*</span></label>
                          <select class="form-select" value="${criterion.evaluationMethod}" onchange="updateEvaluationCriterionMethod('${criterion.id}', this.value)">
                            <option value="Pass/Fail" ${criterion.evaluationMethod === 'Pass/Fail' ? 'selected' : ''}>Pass/Fail</option>
                            <option value="Scoring (0-100)" ${criterion.evaluationMethod === 'Scoring (0-100)' ? 'selected' : ''}>Scoring (0-100)</option>
                            <option value="Weighted Scoring" ${criterion.evaluationMethod === 'Weighted Scoring' ? 'selected' : ''}>Weighted Scoring</option>
                            <option value="Ranking" ${criterion.evaluationMethod === 'Ranking' ? 'selected' : ''}>Ranking</option>
                          </select>
                        </div>
                        
                        <!-- Description -->
                        <div class="form-group full-width">
                          <label class="form-label">Description <span class="required-indicator">*</span></label>
                          <textarea 
                            class="form-textarea" 
                            placeholder="Describe the evaluation criterion in detail..." 
                            style="min-height: 100px;"
                            onchange="updateEvaluationCriterionDescription('${criterion.id}', this.value)"
                          >${criterion.description}</textarea>
                          <span class="help-text">Provide a clear description of what will be evaluated and how</span>
                        </div>
                        
                        <!-- Applies To -->
                        <div class="form-group full-width">
                          <label class="form-label">Applies To <span class="required-indicator">*</span></label>
                          <div style="display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-sm);">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input 
                                type="radio" 
                                name="appliesTo_${criterion.id}" 
                                value="entire" 
                                ${criterion.appliesTo === 'entire' ? 'checked' : ''}
                                onchange="updateEvaluationCriterionAppliesTo('${criterion.id}', this.value)"
                                style="cursor: pointer;"
                              />
                              <span>Entire Tender</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input 
                                type="radio" 
                                name="appliesTo_${criterion.id}" 
                                value="specific" 
                                ${criterion.appliesTo === 'specific' ? 'checked' : ''}
                                onchange="updateEvaluationCriterionAppliesTo('${criterion.id}', this.value)"
                                style="cursor: pointer;"
                              />
                              <span>Specific Lot(s) or Product(s)</span>
                            </label>
                          </div>
                          
                          ${criterion.appliesTo === 'specific' ? `
                            <div style="margin-top: var(--spacing-md);">
                              ${availableUnspscCodes.length === 0 && lots.length === 0 ? `
                                <div style="padding: var(--spacing-md); background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: var(--radius-sm); color: var(--warning-700);">
                                  ‚ö†Ô∏è No lots or products available. Please add requisition lines or create lots with products first.
                                </div>
                              ` : `
                                ${lots.length > 0 ? `
                                  <div style="margin-bottom: var(--spacing-lg);">
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">
                                      Select by Lot
                                    </label>
                                    <select 
                                      class="form-select" 
                                      multiple 
                                      size="4"
                                      onchange="updateEvaluationCriterionLots('${criterion.id}', this)"
                                      style="width: 100%;"
                                    >
                                      ${lots.map(lot => `
                                        <option 
                                          value="${lot.id}" 
                                          ${criterion.lots.includes(lot.id) ? 'selected' : ''}
                                        >
                                          ${lot.name} (${lot.unspscCodes.length} products)
                                        </option>
                                      `).join('')}
                                    </select>
                                    <span class="help-text">Selecting a lot automatically includes all products in that lot. Hold Ctrl/Cmd to select multiple lots.</span>
                                  </div>
                                ` : ''}
                                
                                ${availableUnspscCodes.length > 0 ? `
                                  <div>
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">
                                      ${lots.length > 0 ? 'Or Select Individual Products (UNSPSC Codes)' : 'Select Products (UNSPSC Codes)'}
                                    </label>
                                    <select 
                                      class="form-select" 
                                      multiple 
                                      size="6"
                                      onchange="updateEvaluationCriterionUnspscCodes('${criterion.id}', this)"
                                      style="width: 100%;"
                                    >
                                      ${availableUnspscCodes.map(unspsc => {
                                        // Find which lot(s) contain this UNSPSC code
                                        const containingLots = lots.filter(lot => 
                                          lot.unspscCodes.some(u => u.code === unspsc.code)
                                        ).map(lot => lot.name);
                                        
                                        const lotInfo = containingLots.length > 0 
                                          ? ` [In: ${containingLots.join(', ')}]` 
                                          : ' [From requisition]';
                                        
                                        return `
                                          <option 
                                            value="${unspsc.code}" 
                                            ${criterion.unspscCodes.includes(unspsc.code) ? 'selected' : ''}
                                          >
                                            ${unspsc.code} - ${unspsc.description}${lotInfo}
                                          </option>
                                        `;
                                      }).join('')}
                                    </select>
                                    <span class="help-text">Hold Ctrl/Cmd to select multiple products. Products selected via lots above are automatically included.</span>
                                  </div>
                                ` : ''}
                                
                                ${criterion.lots.length > 0 || criterion.unspscCodes.length > 0 ? `
                                  <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm);">
                                    <strong style="color: var(--info-700);">üìä Current Selection:</strong>
                                    <div style="margin-top: var(--spacing-xs); color: var(--info-700);">
                                      ${criterion.lots.length > 0 ? `
                                        <div>‚úì ${criterion.lots.length} lot(s) selected</div>
                                      ` : ''}
                                      <div>‚úì ${criterion.unspscCodes.length} product(s) will be evaluated with this criterion</div>
                                    </div>
                                  </div>
                                ` : ''}
                              `}
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }

      function renderEvaluationBlock(block) {
        // Get available UNSPSC codes for criteria section
        const availableUnspscCodes = getAvailableUnspscCodes();
        
        // Find the Evaluation Method section fields
        const methodSection = block.sections.find(s => s.title === 'Evaluation Method');
        const methodFields = methodSection ? methodSection.fields : [];
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              <!-- Evaluation Method Section - Collapsible -->
              <div class="collapsible-section collapsed" id="evaluation-method-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('evaluation-method-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Evaluation Method</span>
                    ${renderSectionProgress('evaluation-method', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid">
                    ${methodFields.map((field) => {
                      // Check conditional visibility
                      if (!shouldShowField(field)) {
                        return '';
                      }
                      
                      let fieldHtml = '';
                      const onchangeAttr = field.onchange ? `onchange="${field.onchange}(this.value)"` : '';
                      
                      if (field.type === 'textarea') {
                        fieldHtml = `
                          <div class="form-group full-width">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <textarea class="form-textarea" ${field.readonly ? 'readonly' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}">${field.value || ''}</textarea>
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      } else if (field.type === 'select') {
                        const options = field.options.map(opt => '<option>' + opt + '</option>').join('');
                        fieldHtml = `
                          <div class="form-group ${field.multiple ? 'full-width' : ''}">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <select class="form-select" ${field.multiple ? 'multiple size="5"' : ''} ${field.required ? 'required' : ''} ${field.readonly ? 'disabled' : ''} ${onchangeAttr}>
                              ${options}
                            </select>
                            ${field.multiple ? '<span class="help-text">Hold Ctrl/Cmd to select multiple</span>' : ''}
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      } else if (field.type === 'number') {
                        fieldHtml = `
                          <div class="form-group">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <input type="number" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      } else {
                        fieldHtml = `
                          <div class="form-group">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      }
                      return fieldHtml;
                    }).join('')}
                  </div>
                </div>
              </div>
              
              <!-- Evaluation Criteria Section - Collapsible -->
              <div class="collapsible-section collapsed" id="evaluation-criteria-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('evaluation-criteria-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Evaluation Criteria</span>
                    ${renderSectionProgress('evaluation-criteria', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                    <div class="info-alert-text">
                      ‚ÑπÔ∏è Define evaluation criteria that will be used to assess supplier submissions
                    </div>
                  </div>
                  
                  <div style="display: flex; justify-content: flex-end; margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); addEvaluationCriterion()"><i class="pi pi-plus"></i> Add Evaluation Criterion</button>
                  </div>
                  
                  ${evaluationCriteria.length === 0 ? `
                    <div class="empty-state">
                      <div class="empty-state-icon">üìä</div>
                      <div class="empty-state-text">No evaluation criteria defined</div>
                      <div class="empty-state-hint">Click "Add Evaluation Criterion" to define how submissions will be evaluated</div>
                    </div>
                  ` : `
                    <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                      ${evaluationCriteria.map((criterion, idx) => `
                        <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: var(--spacing-lg); box-shadow: var(--shadow-card);">
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                            <h4 style="font-size: 16px; font-weight: 600; margin: 0; flex: 1;">Criterion ${idx + 1}</h4>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); removeEvaluationCriterion('${criterion.id}')" title="Remove criterion"><i class="pi pi-trash"></i> Remove</button>
                          </div>
                          
                          <div class="form-grid">
                            <!-- Type -->
                            <div class="form-group">
                              <label class="form-label">Type <span class="required-indicator">*</span></label>
                              <select class="form-select" value="${criterion.type}" onchange="updateEvaluationCriterionType('${criterion.id}', this.value)">
                                <option value="Eligibility and formal criteria" ${criterion.type === 'Eligibility and formal criteria' ? 'selected' : ''}>Eligibility and formal criteria</option>
                                <option value="Qualification criteria" ${criterion.type === 'Qualification criteria' ? 'selected' : ''}>Qualification criteria</option>
                                <option value="Technical criteria" ${criterion.type === 'Technical criteria' ? 'selected' : ''}>Technical criteria</option>
                                <option value="Shortlisting criteria" ${criterion.type === 'Shortlisting criteria' ? 'selected' : ''}>Shortlisting criteria</option>
                              </select>
                            </div>
                            
                            <!-- Evaluation Method -->
                            <div class="form-group">
                              <label class="form-label">Evaluation Method <span class="required-indicator">*</span></label>
                              <select class="form-select" value="${criterion.evaluationMethod}" onchange="updateEvaluationCriterionMethod('${criterion.id}', this.value)">
                                <option value="Pass/Fail" ${criterion.evaluationMethod === 'Pass/Fail' ? 'selected' : ''}>Pass/Fail</option>
                                <option value="Scoring (0-100)" ${criterion.evaluationMethod === 'Scoring (0-100)' ? 'selected' : ''}>Scoring (0-100)</option>
                                <option value="Weighted Scoring" ${criterion.evaluationMethod === 'Weighted Scoring' ? 'selected' : ''}>Weighted Scoring</option>
                                <option value="Ranking" ${criterion.evaluationMethod === 'Ranking' ? 'selected' : ''}>Ranking</option>
                              </select>
                            </div>
                            
                            <!-- Description -->
                            <div class="form-group full-width">
                              <label class="form-label">Description <span class="required-indicator">*</span></label>
                              <textarea 
                                class="form-textarea" 
                                placeholder="Describe the evaluation criterion in detail..." 
                                style="min-height: 100px;"
                                onchange="updateEvaluationCriterionDescription('${criterion.id}', this.value)"
                              >${criterion.description}</textarea>
                              <span class="help-text">Provide a clear description of what will be evaluated and how</span>
                            </div>
                            
                            <!-- Applies To -->
                            <div class="form-group full-width">
                              <label class="form-label">Applies To <span class="required-indicator">*</span></label>
                              <div style="display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-sm);">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                  <input 
                                    type="radio" 
                                    name="appliesTo_${criterion.id}" 
                                    value="entire" 
                                    ${criterion.appliesTo === 'entire' ? 'checked' : ''}
                                    onchange="updateEvaluationCriterionAppliesTo('${criterion.id}', this.value)"
                                    style="cursor: pointer;"
                                  />
                                  <span>Entire Tender</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                  <input 
                                    type="radio" 
                                    name="appliesTo_${criterion.id}" 
                                    value="specific" 
                                    ${criterion.appliesTo === 'specific' ? 'checked' : ''}
                                    onchange="updateEvaluationCriterionAppliesTo('${criterion.id}', this.value)"
                                    style="cursor: pointer;"
                                  />
                                  <span>Specific Lot(s) or Product(s)</span>
                                </label>
                              </div>
                              
                              ${criterion.appliesTo === 'specific' ? `
                                <div style="margin-top: var(--spacing-md);">
                                  ${availableUnspscCodes.length === 0 && lots.length === 0 ? `
                                    <div style="padding: var(--spacing-md); background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: var(--radius-sm); color: var(--warning-700);">
                                      ‚ö†Ô∏è No lots or products available. Please add requisition lines or create lots with products first.
                                    </div>
                                  ` : `
                                    ${lots.length > 0 ? `
                                      <div style="margin-bottom: var(--spacing-lg);">
                                        <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">
                                          Select by Lot
                                        </label>
                                        <select 
                                          class="form-select" 
                                          multiple 
                                          size="4"
                                          onchange="updateEvaluationCriterionLots('${criterion.id}', this)"
                                          style="width: 100%;"
                                        >
                                          ${lots.map(lot => `
                                            <option 
                                              value="${lot.id}" 
                                              ${criterion.lots.includes(lot.id) ? 'selected' : ''}
                                            >
                                              ${lot.name} (${lot.unspscCodes.length} products)
                                            </option>
                                          `).join('')}
                                        </select>
                                        <span class="help-text">Selecting a lot automatically includes all products in that lot. Hold Ctrl/Cmd to select multiple lots.</span>
                                      </div>
                                    ` : ''}
                                    
                                    ${availableUnspscCodes.length > 0 ? `
                                      <div>
                                        <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">
                                          ${lots.length > 0 ? 'Or Select Individual Products (UNSPSC Codes)' : 'Select Products (UNSPSC Codes)'}
                                        </label>
                                        <select 
                                          class="form-select" 
                                          multiple 
                                          size="6"
                                          onchange="updateEvaluationCriterionUnspscCodes('${criterion.id}', this)"
                                          style="width: 100%;"
                                        >
                                          ${availableUnspscCodes.map(unspsc => {
                                            // Find which lot(s) contain this UNSPSC code
                                            const containingLots = lots.filter(lot => 
                                              lot.unspscCodes.some(u => u.code === unspsc.code)
                                            ).map(lot => lot.name);
                                            
                                            const lotInfo = containingLots.length > 0 
                                              ? ' [In: ' + containingLots.join(', ') + ']' 
                                              : ' [From requisition]';
                                            
                                            return `
                                              <option 
                                                value="${unspsc.code}" 
                                                ${criterion.unspscCodes.includes(unspsc.code) ? 'selected' : ''}
                                              >
                                                ${unspsc.code} - ${unspsc.description}${lotInfo}
                                              </option>
                                            `;
                                          }).join('')}
                                        </select>
                                        <span class="help-text">Hold Ctrl/Cmd to select multiple products. Products selected via lots above are automatically included.</span>
                                      </div>
                                    ` : ''}
                                    
                                    ${criterion.lots.length > 0 || criterion.unspscCodes.length > 0 ? `
                                      <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm);">
                                        <strong style="color: var(--info-700);">üìä Current Selection:</strong>
                                        <div style="margin-top: var(--spacing-xs); color: var(--info-700);">
                                          ${criterion.lots.length > 0 ? `
                                            <div>‚úì ${criterion.lots.length} lot(s) selected</div>
                                          ` : ''}
                                          <div>‚úì ${criterion.unspscCodes.length} product(s) will be evaluated with this criterion</div>
                                        </div>
                                      </div>
                                    ` : ''}
                                  `}
                                </div>
                              ` : ''}
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  `}
                </div>
              </div>
              
            </div>
          </div>
        `;
      }

      function renderParticularsSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="collapsible-section collapsed" id="particulars-section" style="margin-top: var(--spacing-md);">
            <div class="collapsible-header" onclick="toggleCollapsibleSection('particulars-section')">
              <div class="collapsible-header-left">
                <span class="collapsible-header-title">Particulars</span>
                ${renderSectionProgress('particulars', null)}
              </div>
              <div class="collapsible-toggle">‚ñº</div>
            </div>
            <div class="collapsible-body">
              <div class="form-grid-3col">
                <!-- Scope and objectives -->
                <div class="form-group full-width">
                  <label class="form-label">Scope and objectives of the sourcing or solicitation process</label>
                  <textarea class="form-textarea" placeholder="Describe the scope and objectives..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Specific requirements -->
                <div class="form-group full-width">
                  <label class="form-label">Specific requirements, conditions and additional information</label>
                  <textarea class="form-textarea" placeholder="Enter specific requirements and conditions..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Evaluation of submissions -->
                <div class="form-group full-width">
                  <label class="form-label">Evaluation of submissions</label>
                  <textarea class="form-textarea" placeholder="Describe how submissions will be evaluated..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Instructions -->
                <div class="form-group full-width">
                  <label class="form-label">Instructions</label>
                  <textarea class="form-textarea" placeholder="Provide instructions to suppliers..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Disclaimer (Auto-generated) -->
                <div class="form-group full-width">
                  <label class="form-label">Disclaimer</label>
                  <input type="text" class="form-input" value="This process is a Sourcing process TBD." readonly style="background: var(--surface-100);" />
                  <span class="help-text">Auto-generated disclaimer text</span>
                </div>
                
                <!-- Interpretation (Auto-generated) -->
                <div class="form-group full-width">
                  <label class="form-label">Interpretation of the RFP/ITB</label>
                  <textarea class="form-textarea" readonly style="background: var(--surface-100); min-height: 80px;">Standard interpretation clauses for RFP/ITB documentation will be applied as per UNOPS procurement policy.</textarea>
                  <span class="help-text">Auto-generated interpretation text</span>
                </div>
                
                <!-- Bidder eligibility -->
                <div class="form-group">
                  <label class="form-label">Bidder eligibility</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>All eligible bidders</option>
                    <option>Pre-qualified bidders only</option>
                    <option>Specific criteria</option>
                  </select>
                </div>
                
                <!-- Clarifications or pre-bid meeting -->
                <div class="form-group">
                  <label class="form-label">Clarifications or pre-bid meeting</label>
                  <select class="form-select" onchange="updateClarificationsOrPreBid(this.value)">
                    <option value="">Select...</option>
                    <option value="No pre-bid meeting">No pre-bid meeting</option>
                    <option value="One pre-bid meeting">One pre-bid meeting</option>
                    <option value="Two pre-bid meetings">Two pre-bid meetings</option>
                  </select>
                </div>
                
                <!-- Supplier capacity-building initiatives -->
                <div class="form-group full-width">
                  <label class="form-label">Supplier capacity-building initiatives</label>
                  <textarea class="form-textarea" placeholder="Describe capacity-building initiatives if applicable..." style="min-height: 80px;"></textarea>
                </div>
                
                ${particularsValues.numberOfMeetings > 0 ? `
                  <!-- Pre-bid Meeting Fields -->
                  <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Pre-Bid Meeting Details</h4>
                  </div>
                  
                  ${Array.from({length: particularsValues.numberOfMeetings}, (_, i) => `
                    <div class="form-group full-width" style="background: var(--surface-50); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">
                      <h5 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Meeting ${i + 1}</h5>
                      
                      <div class="form-group">
                        <label class="form-label">Date and time for pre-bid meeting ${i + 1}</label>
                        <input type="datetime-local" class="form-input" />
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">Type of pre-bid meeting</label>
                        <select class="form-select">
                          <option>Select...</option>
                          <option>In-person</option>
                          <option>Virtual (video conference)</option>
                          <option>Hybrid</option>
                        </select>
                      </div>
                      
                      <div class="form-group full-width">
                        <label class="form-label">Pre-bid meeting details</label>
                        <textarea class="form-textarea" placeholder="Provide meeting details (location, dial-in info, etc.)..." style="min-height: 80px;"></textarea>
                      </div>
                    </div>
                  `).join('')}
                ` : ''}
                
                <!-- Site Visit Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Site Visit</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Site visit or inspection</label>
                  <select class="form-select" onchange="updateSiteVisit(this.value)">
                    <option value="">Select...</option>
                    <option value="Not applicable">Not applicable</option>
                    <option value="Applicable">Applicable</option>
                  </select>
                </div>
                
                ${particularsValues.siteVisit === 'Applicable' ? `
                  <div class="form-group">
                    <label class="form-label">Date option for site visit or inspection</label>
                    <select class="form-select" onchange="updateSiteVisitDateOption(this.value)">
                      <option value="">Select...</option>
                      <option value="Specific date">Specific date</option>
                      <option value="Date range">Date range</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Date/time for site visit or inspection</label>
                    <input type="datetime-local" class="form-input" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Details for site visit or inspection</label>
                    <textarea class="form-textarea" placeholder="Provide site visit details (location, contact, requirements, etc.)..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Exclusivity Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Exclusivity</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Exclusivity and/or availability statement</label>
                  <select class="form-select" onchange="updateExclusivity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.exclusivity === 'Required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Exclusivity / availability details</label>
                    <textarea class="form-textarea" placeholder="Provide exclusivity or availability requirements..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Commercial Conditions Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Commercial Conditions</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Validity period (days)</label>
                  <input type="number" class="form-input" placeholder="e.g., 90" min="1" />
                </div>
                
                <div class="form-group">
                  <label class="form-label">Quotation/Bid/Proposal currency(ies)</label>
                  <select class="form-select" multiple size="4">
                    <option>USD</option>
                    <option>EUR</option>
                    <option>GBP</option>
                    <option>CHF</option>
                    <option>Other</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Duties and taxes</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Excluded</option>
                    <option>Included</option>
                    <option>As specified</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Languages of submissions</label>
                  <select class="form-select">
                    <option>English</option>
                    <option>French</option>
                    <option>Spanish</option>
                    <option>Multiple languages</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Other languages</label>
                  <select class="form-select" multiple size="3">
                    <option>Arabic</option>
                    <option>Chinese</option>
                    <option>Portuguese</option>
                    <option>Russian</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple</span>
                </div>
                
                <!-- Alternative Offers Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Alternative Offers</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Alternative quotations/offers/proposals</label>
                  <select class="form-select" onchange="updateAlternativeOffers(this.value)">
                    <option value="">Select...</option>
                    <option value="Not accepted">Not accepted</option>
                    <option value="Accepted">Accepted</option>
                  </select>
                </div>
                
                ${particularsValues.alternativeOffers === 'Accepted' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Alternative offers details</label>
                    <textarea class="form-textarea" placeholder="Describe requirements for alternative offers..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Contracting Details Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Contracting Details</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Type of contract to be awarded</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Purchase Order</option>
                    <option>Long-term Agreement (LTA)</option>
                    <option>Blanket Purchase Agreement (BPA)</option>
                    <option>Service Contract</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">General Conditions of Contract</label>
                  <select class="form-select">
                    <option>UNOPS General Conditions</option>
                    <option>Custom General Conditions</option>
                  </select>
                  <span class="help-text">Pre-filled with UNOPS standard terms</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Public bid/proposal opening</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Yes - Public opening</option>
                    <option>No - Private opening</option>
                  </select>
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Opening of bid details (location, date, time)</label>
                  <textarea class="form-textarea" placeholder="Provide details of bid opening ceremony..." style="min-height: 60px;"></textarea>
                </div>
                
                <!-- Payment Terms Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Payment Terms & Advance Payments</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Terms</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Net 30</option>
                    <option>Net 60</option>
                    <option>Upon delivery</option>
                    <option>Milestone-based</option>
                    <option>Other</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment terms details</label>
                  <input type="text" class="form-input" placeholder="e.g., net 30 days from invoice" />
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Payment terms ‚Äì Other</label>
                  <textarea class="form-textarea" placeholder="Provide additional payment terms if applicable..." style="min-height: 60px;"></textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Advance payment allowed?</label>
                  <select class="form-select" onchange="updateAdvancePaymentAllowed(this.value)">
                    <option value="">Select...</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                  <div style="margin-top: 8px; padding: 12px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-secondary);">
                    ‚ÑπÔ∏è <strong>Advance Payment Policy:</strong> As per UNOPS policy, advance payments may be considered under specific circumstances and require appropriate justification and security.
                  </div>
                </div>
                
                ${particularsValues.advancePaymentAllowed === 'Yes' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification/background for advance payment</label>
                    <textarea class="form-textarea" placeholder="Provide justification for advance payment..." style="min-height: 80px;"></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Additional rationale / specific information</label>
                    <textarea class="form-textarea" placeholder="Provide additional rationale..." style="min-height: 60px;"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Advance payment percentage requested</label>
                    <select class="form-select">
                      <option>Select...</option>
                      <option>Up to 20%</option>
                      <option>Up to 30%</option>
                      <option>Up to 40%</option>
                      <option>Other (requires exception)</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Exception justification (upload CFO approval + Jira link)</label>
                    <div style="display: flex; gap: var(--spacing-md); align-items: center; margin-bottom: var(--spacing-sm);">
                      <input type="file" class="form-input" accept=".pdf,.doc,.docx" style="flex: 1;" />
                      <button class="btn btn-secondary btn-sm" type="button">üìé Upload CFO Approval</button>
                    </div>
                    <input type="text" class="form-input" placeholder="Enter Jira link" style="margin-top: 8px;" />
                    <div style="margin-top: 8px; padding: 10px; background: var(--warning-50); border-left: 3px solid var(--warning-500); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                      ‚ö†Ô∏è <strong>Advisory:</strong> Advance payments exceeding standard thresholds require CFO approval and documented exception.
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Advance payment security required?</label>
                    <select class="form-select" onchange="updateAdvancePaymentSecurity(this.value)">
                      <option value="">Select...</option>
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                    <div style="margin-top: 8px; padding: 10px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                      ‚ÑπÔ∏è Advance payment security (bank guarantee or similar) is typically required to protect UNOPS interests.
                    </div>
                  </div>
                  
                  ${particularsValues.advancePaymentSecurity === 'Yes' ? `
                    <div class="form-group">
                      <label class="form-label">Deadline for provision of security ‚Äì Date</label>
                      <input type="date" class="form-input" />
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Applicable format of security/guarantee</label>
                      <textarea class="form-textarea" placeholder="Specify format of security/guarantee required..." style="min-height: 60px;"></textarea>
                    </div>
                  ` : particularsValues.advancePaymentSecurity === 'No' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Rationale for not requiring AP security</label>
                      <textarea class="form-textarea" placeholder="Provide justification for not requiring advance payment security..." style="min-height: 80px;"></textarea>
                    </div>
                  ` : ''}
                ` : ''}
                
                <!-- Additional Payment-Related Requirements Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Additional Payment-Related Requirements</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Audited Financial Documents</label>
                  <select class="form-select">
                    <option>Required</option>
                    <option>Not required</option>
                    <option>Conditional</option>
                  </select>
                  <span class="help-text">Pre-filled based on procurement value</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Security / Bank Guarantee</label>
                  <select class="form-select">
                    <option>Required</option>
                    <option>Not required</option>
                  </select>
                  <span class="help-text">Pre-filled based on contract type</span>
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Advance Payment details for suppliers</label>
                  <select class="form-select">
                    <option>Standard terms apply</option>
                    <option>Custom terms</option>
                  </select>
                  <div style="margin-top: 8px; padding: 12px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                    <strong>Supplier Requirements:</strong> If advance payment is approved, suppliers must submit required security/guarantee within specified timeframe. Payment will be processed upon receipt and verification of security documentation.
                  </div>
                </div>
                
                <!-- Damages & Securities Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Damages & Securities</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Liquidated or Delay Damages</label>
                  <select class="form-select" onchange="updateLiquidatedDamages(this.value)">
                    <option value="">Select...</option>
                    <option value="Not applicable">Not applicable</option>
                    <option value="Applicable">Applicable</option>
                  </select>
                </div>
                
                ${particularsValues.liquidatedDamages === 'Applicable' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification</label>
                    <textarea class="form-textarea" placeholder="Provide justification for applying liquidated damages..." style="min-height: 60px;"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Details</label>
                    <select class="form-select">
                      <option>Select...</option>
                      <option>0.5% per day (max 10%)</option>
                      <option>1% per day (max 10%)</option>
                      <option>Custom rate</option>
                      <option>Other</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Other details</label>
                    <textarea class="form-textarea" placeholder="Provide other liquidated damages details..." style="min-height: 60px;"></textarea>
                  </div>
                ` : particularsValues.liquidatedDamages === 'Not applicable' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification for not applying LD</label>
                    <textarea class="form-textarea" placeholder="Provide justification for not applying liquidated damages..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
                <div class="form-group">
                  <label class="form-label">Performance security</label>
                  <select class="form-select" onchange="updatePerformanceSecurity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.performanceSecurity === 'Required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Performance security details</label>
                    <textarea class="form-textarea" placeholder="Specify performance security requirements (percentage, format, validity, etc.)..." style="min-height: 80px;"></textarea>
                  </div>
                ` : particularsValues.performanceSecurity === 'Not required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification</label>
                    <textarea class="form-textarea" placeholder="Provide justification for not requiring performance security..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
                <div class="form-group">
                  <label class="form-label">Bid / proposal security</label>
                  <select class="form-select" onchange="updateBidSecurity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.bidSecurity === 'Required' ? `
                  <div class="form-group">
                    <label class="form-label">Bid/proposal security value (non-lot)</label>
                    <input type="number" class="form-input" placeholder="Enter amount" min="0" />
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Bid/proposal security value (lot-based)</label>
                    <input type="number" class="form-input" placeholder="Enter amount per lot" min="0" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Security details</label>
                    <textarea class="form-textarea" placeholder="Provide security details (format, validity period, etc.)..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
              </div>
            </div>
              </div>
              
              <!-- Key Dates Section - Collapsible -->
              <div class="collapsible-section collapsed" id="key-dates-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('key-dates-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Key Dates</span>
                    ${renderSectionProgress('key-dates', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body">
                  <div class="form-grid-3col">
                    <div class="form-group">
                      <label class="form-label">Deadline <span class="required">*</span></label>
                      <input type="datetime-local" class="form-input" required />
                      <span class="help-text">Submission deadline for bids/proposals</span>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Deadline for clarifications</label>
                      <input type="datetime-local" class="form-input" />
                      <span class="help-text">Last date for suppliers to submit questions</span>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Expected Contract award date</label>
                      <input type="date" class="form-input" />
                      <span class="help-text">Estimated date for contract award</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Contract Provisions Section - Collapsible -->
              <div class="collapsible-section collapsed" id="contract-provisions-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('contract-provisions-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Contract Provisions</span>
                    ${renderSectionProgress('contract-provisions', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    
                    <!-- UNOPS General Conditions of Contract -->
                    <div class="form-group full-width">
                      <label class="form-label">UNOPS General Conditions of Contract</label>
                      <select class="form-select" onchange="updateContractProvision('generalConditions', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select...</option>
                        <option value="goods" ${contractProvisionsValues.generalConditions === 'goods' ? 'selected' : ''}>General Conditions for Goods</option>
                        <option value="services" ${contractProvisionsValues.generalConditions === 'services' ? 'selected' : ''}>General Conditions for Services</option>
                        <option value="works" ${contractProvisionsValues.generalConditions === 'works' ? 'selected' : ''}>General Conditions for Works</option>
                        <option value="consultancy" ${contractProvisionsValues.generalConditions === 'consultancy' ? 'selected' : ''}>General Conditions for Consultancy</option>
                      </select>
                      <span class="help-text">Select applicable UNOPS General Conditions</span>
                    </div>
                    
                    <!-- UNOPS Special Conditions of Contract -->
                    <div class="form-group full-width">
                      <label class="form-label">UNOPS Special Conditions of Contract</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div 
                          id="contract-special-conditions-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('specialConditions', this.innerHTML)"
                          placeholder="Enter special conditions that modify or supplement the General Conditions..."
                        >${contractProvisionsValues.specialConditions}</div>
                      </div>
                      <span class="help-text">Add any special conditions specific to this contract</span>
                    </div>
                    
                    <!-- UNOPS Sample Contract -->
                    <div class="form-group full-width">
                      <label class="form-label">UNOPS Sample Contract</label>
                      <select class="form-select" onchange="updateContractProvision('sampleContract', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select template...</option>
                        <option value="purchase-order" ${contractProvisionsValues.sampleContract === 'purchase-order' ? 'selected' : ''}>Purchase Order (PO)</option>
                        <option value="contract-goods" ${contractProvisionsValues.sampleContract === 'contract-goods' ? 'selected' : ''}>Contract for Goods</option>
                        <option value="contract-services" ${contractProvisionsValues.sampleContract === 'contract-services' ? 'selected' : ''}>Contract for Services</option>
                        <option value="contract-works" ${contractProvisionsValues.sampleContract === 'contract-works' ? 'selected' : ''}>Contract for Works</option>
                        <option value="lta" ${contractProvisionsValues.sampleContract === 'lta' ? 'selected' : ''}>Long-Term Agreement (LTA)</option>
                        <option value="bpa" ${contractProvisionsValues.sampleContract === 'bpa' ? 'selected' : ''}>Blanket Purchase Agreement (BPA)</option>
                      </select>
                      <span class="help-text">Select the applicable contract template</span>
                    </div>
                    
                    <!-- Contract clauses and KPIs (SP criteria) -->
                    <div class="form-group full-width">
                      <label class="form-label">Contract Clauses and KPIs (SP Criteria)</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div 
                          id="contract-clauses-kpis-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('contractClausesKPIs', this.innerHTML)"
                          placeholder="Define contract clauses and Key Performance Indicators based on Sustainable Procurement criteria..."
                        >${contractProvisionsValues.contractClausesKPIs}</div>
                      </div>
                      <span class="help-text">Define KPIs and clauses aligned with Sustainable Procurement criteria</span>
                    </div>
                    
                    <!-- Contract clauses (DRiVE/Risk app) -->
                    <div class="form-group full-width">
                      <label class="form-label">Contract Clauses (DRiVE/Risk App)</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div 
                          id="contract-clauses-drive-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('contractClausesDrive', this.innerHTML)"
                          placeholder="Enter contract clauses from DRiVE/Risk application..."
                        >${contractProvisionsValues.contractClausesDrive}</div>
                      </div>
                      <span class="help-text">Import or define clauses from DRiVE/Risk application</span>
                    </div>
                    
                    <!-- Performance Security / Bank Guarantee -->
                    <div class="form-group">
                      <label class="form-label">Performance Security / Bank Guarantee</label>
                      <select class="form-select" onchange="updateContractProvision('performanceSecurityRequired', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select...</option>
                        <option value="not-required" ${contractProvisionsValues.performanceSecurityRequired === 'not-required' ? 'selected' : ''}>Not Required</option>
                        <option value="required" ${contractProvisionsValues.performanceSecurityRequired === 'required' ? 'selected' : ''}>Required</option>
                      </select>
                    </div>
                    
                    ${contractProvisionsValues.performanceSecurityRequired === 'required' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Performance Security Details</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                        </div>
                        <div 
                          id="contract-perf-security-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 100px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('performanceSecurityDetails', this.innerHTML)"
                          placeholder="Specify performance security requirements (amount, percentage, format, validity period, etc.)..."
                        >${contractProvisionsValues.performanceSecurityDetails}</div>
                      </div>
                      <span class="help-text">Define the performance security/bank guarantee requirements</span>
                    </div>
                    ` : ''}
                    
                    <!-- Advance Payment -->
                    <div class="form-group">
                      <label class="form-label">Advance Payment</label>
                      <select class="form-select" onchange="updateContractProvision('advancePaymentRequired', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select...</option>
                        <option value="not-allowed" ${contractProvisionsValues.advancePaymentRequired === 'not-allowed' ? 'selected' : ''}>Not Allowed</option>
                        <option value="allowed" ${contractProvisionsValues.advancePaymentRequired === 'allowed' ? 'selected' : ''}>Allowed</option>
                      </select>
                    </div>
                    
                    ${contractProvisionsValues.advancePaymentRequired === 'allowed' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Advance Payment Details</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                        </div>
                        <div 
                          id="contract-advance-payment-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 100px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('advancePaymentDetails', this.innerHTML)"
                          placeholder="Specify advance payment terms (percentage, conditions, guarantee requirements, etc.)..."
                        >${contractProvisionsValues.advancePaymentDetails}</div>
                      </div>
                      <span class="help-text">Define the advance payment terms and conditions</span>
                    </div>
                    ` : ''}
                    
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        `;
      }

      function renderCurrentBlock() {
        const wrapper = document.getElementById('content-wrapper');
        const block = templateBlocks[currentBlockIndex];

        let html = '';

        // Special handling for Scope & Requirements block - render all sections in one container
        if (block.id === 'scope') {
          html = renderScopeRequirementsBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }
        
        // Special handling for Competition block
        if (block.id === 'competition') {
          html = renderCompetitionBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }
        
        // Special handling for Team block
        if (block.id === 'team') {
          html = renderTeamBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }
        
        // Special handling for Evaluation block
        if (block.id === 'evaluation') {
          html = renderEvaluationBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }

        block.sections.forEach((section, sectionIndex) => {
          const isFirst = sectionIndex === 0;
          
          // Special handling for Requisition & Lots section
          if (section.isRequisitionLots) {
            html += renderRequisitionLotsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Product Requirements section
          if (section.isProductRequirements) {
            html += renderProductRequirementsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Other requirements section
          if (section.isTenderAuthorConfig) {
            html += renderTenderAuthorConfigSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Supplier Response Structure section
          if (section.isSupplierResponseStructure) {
            html += renderSupplierResponseStructureSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Supplier Form Preview section
          if (section.isSupplierFormPreview) {
            html += renderSupplierFormPreviewSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Evaluation Criteria section
          if (section.isEvaluationCriteria) {
            html += renderEvaluationCriteriaSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Particulars section
          if (section.isParticulars) {
            html += renderParticularsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special layout for General Information block - no section header, full width
          const isGeneralInfo = block.id === 'general' && sectionIndex === 0;
          
          // Special layout for Project Information section - collapsible, 3-column, no icon
          const isProjectInfo = block.id === 'project' && sectionIndex === 0;
          
          if (isProjectInfo) {
          html += `
              <div class="general-info-container">
                <div class="general-info-body">
                  <div class="collapsible-section collapsed" id="project-info-section">
                    <div class="collapsible-header" onclick="toggleCollapsibleSection('project-info-section')">
                      <div class="collapsible-header-left">
                        <span class="collapsible-header-title">Project Information</span>
                        ${renderSectionProgress('project-info', null)}
                      </div>
                      <div class="collapsible-toggle">‚ñº</div>
                    </div>
                    <div class="collapsible-body">
                      <div class="form-grid-3col">
                        ${section.fields.map((field) => {
                          if (!shouldShowField(field)) return '';
                          const onchangeAttr = field.onchange ? `onchange="${field.onchange}(this.value)"` : '';
                          if (field.type === 'search') {
                            return `
                              <div class="form-group">
                                <label class="form-label">
                                  ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                                </label>
                                <div style="position: relative;">
                                  <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || 'Search...'}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} style="padding-left: 36px;" />
                                  <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;">üîç</span>
                                </div>
                                ${field.source ? '<span class="help-text">Source: ' + field.source + '</span>' : ''}
                              </div>
                            `;
                          } else if (field.type === 'date') {
                            return `
                              <div class="form-group">
                                <label class="form-label">
                                  ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                                </label>
                                <input type="date" class="form-input" value="${field.value || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                                ${field.source ? '<span class="help-text">Source: ' + field.source + '</span>' : ''}
                              </div>
                            `;
                          } else {
                            return `
                              <div class="form-group">
                                <label class="form-label">
                                  ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                                </label>
                                <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                                ${field.source ? '<span class="help-text">Source: ' + field.source + '</span>' : ''}
                              </div>
                            `;
                          }
                        }).join('')}
                      </div>
                    </div>
                  </div>
            `;
            return; // Project Info section rendering continues in next iteration for Particulars
          }
          
          html += `
            <div class="${isGeneralInfo ? 'general-info-container' : 'form-section'}">
              ${isGeneralInfo ? `
                <div class="general-info-body">
              ` : `
              <div class="section-header">
                <div class="section-title">
                  <span class="section-icon">${block.icon}</span>
                  <span>${section.title}</span>
                </div>
                ${sectionIndex === 0 ? '<span class="status-indicator status-incomplete">Incomplete</span>' : ''}
              </div>
              <div class="section-body">
              `}
                
                ${(() => {
                  // Display added forms for this section
                  const blockForms = addedForms[block.id] || {};
                  const sectionForms = blockForms[sectionIndex] || [];
                  if (sectionForms.length > 0) {
                    return `
                      <div class="added-forms-section">
                        <div class="form-library-group-label" style="margin-bottom: var(--spacing-md);">Added Forms</div>
                        ${sectionForms.map(form => `
                          <div class="added-form-item" data-form-id="${form.id}">
                            <div class="added-form-info">
                              <div class="added-form-icon">üìÑ</div>
                              <div class="added-form-details">
                                <div class="added-form-name">${form.name}</div>
                                <div class="added-form-type">Form Document</div>
                              </div>
                            </div>
                            <div class="added-form-actions">
                              <button class="form-action-btn" onclick="previewForm('${form.id}')" title="Preview">üëÅ</button>
                              <button class="form-action-btn danger" onclick="removeForm('${form.id}')" title="Remove">‚úñ</button>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    `;
                  }
                  return '';
                })()}
                
                <div class="${isGeneralInfo ? 'form-grid-3col' : 'form-grid'}">
                  ${section.fields.map((field) => {
                    // Check conditional visibility
                    if (!shouldShowField(field)) {
                      return '';
                    }
                    
                    let fieldHtml = '';
                    const onchangeAttr = field.onchange ? `onchange="${field.onchange}(this.value)"` : '';
                    
                    if (field.type === 'textarea') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <textarea class="form-textarea" ${field.readonly ? 'readonly' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}">${field.value || ''}</textarea>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'select') {
                      // Check for pre-populated values
                      let selectedValue = '';
                      if (wizardData) {
                        if (field.label === 'Sourcing or Solicitation' && wizardData.sourcingType) {
                          selectedValue = wizardData.sourcingType.charAt(0).toUpperCase() + wizardData.sourcingType.slice(1);
                        } else if (field.label === 'Type of Requirement' && wizardData.requirementType) {
                          const requirementMap = {
                            goods: 'Goods',
                            services: 'Services',
                            works: 'Works',
                            'goods-services': 'Goods & Services',
                          };
                          selectedValue = requirementMap[wizardData.requirementType] || '';
                        }
                      }

                      const options = field.options.map(opt => {
                        const isSelected = selectedValue && opt === selectedValue ? 'selected' : '';
                        return `<option ${isSelected}>${opt}</option>`;
                      }).join('');
                      fieldHtml = `
                        <div class="form-group ${field.multiple ? 'full-width' : ''}">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <select class="form-select" ${field.multiple ? 'multiple size="5"' : ''} ${field.required ? 'required' : ''} ${field.readonly ? 'disabled' : ''} ${onchangeAttr}>
                            ${options}
                          </select>
                          ${field.multiple ? '<span class="help-text">Hold Ctrl/Cmd to select multiple</span>' : ''}
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'checkbox-group') {
                      const checkboxes = field.options.map((opt, idx) => `
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                          <input 
                            type="checkbox" 
                            value="${opt}" 
                            ${generalInfoValues.processType.includes(opt) ? 'checked' : ''}
                            onchange="${field.onchange}(this)"
                            style="cursor: pointer;"
                          />
                          <span>${opt}</span>
                        </label>
                      `).join('');
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            ${checkboxes}
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'search') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="position: relative;">
                            <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || 'Search...'}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} style="padding-left: 40px;" />
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">üîç</span>
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'file') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                            <input type="file" class="form-input" ${field.required ? 'required' : ''} accept=".pdf,.doc,.docx,.xls,.xlsx" style="flex: 1;" />
                            <button class="btn btn-secondary btn-sm" type="button">üìé Choose File</button>
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'lifecycle-tracker') {
                      const trackerId = `lifecycle-tracker-${field.id}`;
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          ${field.description ? `<div class="help-text" style="margin-bottom: var(--spacing-md);">${field.description}</div>` : ''}
                          <div id="${trackerId}"></div>
                        </div>
                      `;
                      // Render lifecycle tracker after a short delay to ensure DOM is ready
                      setTimeout(() => renderLifecycleTracker(trackerId), 100);
                    } else {
                      const inputType = field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : field.type === 'datetime-local' ? 'datetime-local' : 'text';
                      fieldHtml = `
                        <div class="form-group ${field.type === 'textarea' ? 'full-width' : ''}">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <input type="${inputType}" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    }
                    return fieldHtml;
                  }).join('')}
                </div>
                
                <!-- Drop Zone for Forms -->
                <div class="form-drop-zone">Drop forms from library here</div>
              ${isGeneralInfo ? '</div>' : '</div>'}
            </div>
          `;
        });

        wrapper.innerHTML = html;
        attachAuthoringEventListeners();
        // Re-setup drop zones after rendering
        setTimeout(() => {
          setupDropZones();
        }, 50);
      }

      window.toggleSection = function(header) {
        console.log('toggleSection called', header);
        const section = header.closest('.form-section');
        if (section) {
          section.classList.toggle('collapsed');
          console.log('Section toggled, collapsed:', section.classList.contains('collapsed'));
        } else {
          console.error('Section not found for header:', header);
        }
      }
      
      // Toggle collapsible section by ID
      window.toggleCollapsibleSection = function(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.toggle('collapsed');
        }
      }
      
      // ===== REQUISITION LINE & LOT MODAL FUNCTIONS =====
      let selectedReqLines = [];
      
      window.openAddReqLineModal = function() {
        const modal = document.getElementById('add-req-line-modal');
        const body = document.getElementById('add-req-line-body');
        selectedReqLines = [];
        
        // Available sample requisition lines to add
        const availableLines = [
          { id: 'REQ-LINE-008', unspscCode: '43211515', unspscDescription: 'Desktop computers', description: 'Desktop workstations', quantity: 25, unitOfMeasure: 'Unit', amount: 30000, currency: 'USD' },
          { id: 'REQ-LINE-009', unspscCode: '43212105', unspscDescription: 'Computer monitors', description: '27-inch monitors', quantity: 50, unitOfMeasure: 'Unit', amount: 15000, currency: 'USD' },
          { id: 'REQ-LINE-010', unspscCode: '43211706', unspscDescription: 'Computer keyboards', description: 'Wireless keyboards', quantity: 75, unitOfMeasure: 'Unit', amount: 3750, currency: 'USD' },
          { id: 'REQ-LINE-011', unspscCode: '43211707', unspscDescription: 'Computer mice', description: 'Wireless mice', quantity: 75, unitOfMeasure: 'Unit', amount: 2250, currency: 'USD' },
        ];
        
        // Filter out lines already added
        const existingIds = requisitionLines.map(l => l.id);
        const newLines = availableLines.filter(l => !existingIds.includes(l.id));
        
        if (newLines.length === 0) {
          body.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <div style="font-size: 28px; margin-bottom: var(--spacing-sm);">‚úÖ</div>
              <div style="font-size: 13px;">All available requisition lines have been added.</div>
            </div>
          `;
        } else {
          body.innerHTML = newLines.map(line => `
            <div class="req-option" data-line-id="${line.id}" onclick="toggleReqLineSelection('${line.id}')">
              <input type="checkbox" class="req-option-checkbox" id="req-cb-${line.id}" />
              <div class="req-option-details">
                <div class="req-option-main">
                  <span style="font-weight: 600;">${line.id}</span>
                  <span style="font-family: monospace; color: var(--primary-600); font-size: 11px;">${line.unspscCode}</span>
                  <span style="color: var(--success-600); font-weight: 600; font-size: 11px;">$${line.amount.toLocaleString()}</span>
                </div>
                <div class="req-option-sub">${line.unspscDescription} - ${line.description}</div>
              </div>
            </div>
          `).join('');
        }
        
        modal.style.display = 'flex';
      }
      
      window.closeAddReqLineModal = function() {
        document.getElementById('add-req-line-modal').style.display = 'none';
        selectedReqLines = [];
      }
      
      window.toggleReqLineSelection = function(lineId) {
        const option = document.querySelector(`.req-option[data-line-id="${lineId}"]`);
        const checkbox = document.getElementById(`req-cb-${lineId}`);
        
        if (selectedReqLines.includes(lineId)) {
          selectedReqLines = selectedReqLines.filter(id => id !== lineId);
          option.classList.remove('selected');
          checkbox.checked = false;
        } else {
          selectedReqLines.push(lineId);
          option.classList.add('selected');
          checkbox.checked = true;
        }
      }
      
      window.addSelectedReqLines = function() {
        if (selectedReqLines.length === 0) {
          alert('Please select at least one requisition line to add.');
          return;
        }
        
        // Sample data - in real app, this would come from the selection
        const availableLines = [
          { id: 'REQ-LINE-008', unspscCode: '43211515', unspscDescription: 'Desktop computers', description: 'Desktop workstations', quantity: 25, unitOfMeasure: 'Unit', amount: 30000, currency: 'USD' },
          { id: 'REQ-LINE-009', unspscCode: '43212105', unspscDescription: 'Computer monitors', description: '27-inch monitors', quantity: 50, unitOfMeasure: 'Unit', amount: 15000, currency: 'USD' },
          { id: 'REQ-LINE-010', unspscCode: '43211706', unspscDescription: 'Computer keyboards', description: 'Wireless keyboards', quantity: 75, unitOfMeasure: 'Unit', amount: 3750, currency: 'USD' },
          { id: 'REQ-LINE-011', unspscCode: '43211707', unspscDescription: 'Computer mice', description: 'Wireless mice', quantity: 75, unitOfMeasure: 'Unit', amount: 2250, currency: 'USD' },
        ];
        
        const linesToAdd = availableLines.filter(l => selectedReqLines.includes(l.id));
        requisitionLines = [...requisitionLines, ...linesToAdd];
        
        closeAddReqLineModal();
        renderCurrentBlock();
        showNotification(`Added ${linesToAdd.length} requisition line(s)`, 'success');
      }
      
      window.openCreateLotModal = function() {
        document.getElementById('create-lot-modal').style.display = 'flex';
        document.getElementById('new-lot-name-input').value = '';
        document.getElementById('new-lot-desc-input').value = '';
        setTimeout(() => document.getElementById('new-lot-name-input').focus(), 100);
      }
      
      window.closeCreateLotModal = function() {
        document.getElementById('create-lot-modal').style.display = 'none';
      }
      
      window.createLotFromModal = function() {
        const lotName = document.getElementById('new-lot-name-input').value.trim();
        if (!lotName) {
          alert('Please enter a lot name.');
          return;
        }
        
        const newLot = {
          id: 'lot-' + Date.now(),
          name: lotName,
          description: document.getElementById('new-lot-desc-input').value.trim(),
          unspscCodes: [],
        };
        
        lots.push(newLot);
        closeCreateLotModal();
        renderCurrentBlock();
        showNotification(`Lot "${lotName}" created successfully`, 'success');
      }

      function updateNavigationButtons() {
        // Footer removed - navigation via block tabs only
      }

      function attachAuthoringEventListeners() {
        document.querySelectorAll('.section-header').forEach((header) => {
          header.addEventListener('click', function() {
            toggleSection(this);
          });
        });

        document.querySelectorAll('.progress-step').forEach((step) => {
          step.addEventListener('click', function() {
            const stepNum = parseInt(this.dataset.step);
            if (stepNum <= currentAuthoringStep) {
              currentAuthoringStep = stepNum;
              updateProgressSteps();
            }
          });
        });
      }

      function updateProgressSteps() {
        document.querySelectorAll('.progress-step').forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.remove('active', 'completed');
          if (stepNum < currentAuthoringStep) {
            step.classList.add('completed');
          } else if (stepNum === currentAuthoringStep) {
            step.classList.add('active');
          }
        });
      }

      // ===== FORM LIBRARY FUNCTIONS =====
      let formLibraryOpen = false;

      function toggleFormLibrary() {
        const panel = document.getElementById('form-library-panel');
        const floatingBtn = document.getElementById('formLibraryFloatingBtn');
        
        formLibraryOpen = !formLibraryOpen;
        
        if (formLibraryOpen) {
          panel.classList.add('open');
          panel.classList.remove('collapsed');
          if (floatingBtn) floatingBtn.style.opacity = '0.3';
        } else {
          panel.classList.remove('open');
          panel.classList.add('collapsed');
          if (floatingBtn) floatingBtn.style.opacity = '1';
        }
      }

      // Initialize - Authoring page auto-starts
      document.addEventListener('DOMContentLoaded', function() {
        // Load data from localStorage (from tender-create.html wizard)
        const hasData = loadTenderInitData();
        
        // Initialize authoring view
        initAuthoring();
        
        // Show success message if data was loaded
        if (hasData && wizardData.title) {
          showSuccessMessage();
        }
        
        console.log('Tender authoring page initialized');
      });
    </script>

    <!-- Tender Selection Modal for Cloning -->
    <div class="modal-overlay" id="tender-selection-modal" onclick="if(event.target === this) closeTenderSelectionModal()">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title">Select Tender to Clone</div>
            <div class="modal-subtitle">Choose an existing tender to use as a starting point</div>
          </div>
          <button class="modal-close-btn" onclick="closeTenderSelectionModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="modal-search">
            <input type="search" placeholder="Search by tender title or reference number..." 
                   oninput="filterExistingTenders(this.value)" />
          </div>
          <div class="existing-tenders-list" id="existing-tenders-list">
            <!-- Tender cards will be dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Lifecycle Process Search Modal -->
    <div class="lifecycle-search-modal" id="lifecycle-search-modal" onclick="if(event.target === this) closeLifecycleSearch()">
      <div class="lifecycle-search-content">
        <div class="lifecycle-search-header">
          <div>
            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
              Link Procurement Process
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              Search and select a process to link to this tender
            </div>
          </div>
          <button class="modal-close-btn" onclick="closeLifecycleSearch()">‚úï</button>
        </div>
        <div class="lifecycle-search-body">
          <div class="lifecycle-search-input-wrapper">
            <span class="lifecycle-search-icon">üîç</span>
            <input 
              type="search" 
              class="lifecycle-search-input" 
              placeholder="Search by Process ID, title, or type..." 
              oninput="searchLifecycleProcesses(this.value)"
            />
          </div>
          <div class="lifecycle-search-results" id="lifecycle-search-results">
            <!-- Results will be dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add Requisition Line Modal -->
    <div class="req-modal" id="add-req-line-modal" onclick="if(event.target === this) closeAddReqLineModal()">
      <div class="req-modal-content">
        <div class="req-modal-header">
          <span class="req-modal-title">üìã Add Requisition Line</span>
          <button class="modal-close-btn" onclick="closeAddReqLineModal()">‚úï</button>
        </div>
        <div class="req-modal-body" id="add-req-line-body">
          <!-- Options will be populated here -->
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeAddReqLineModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="addSelectedReqLines()">Add Selected</button>
        </div>
      </div>
    </div>

    <!-- Create Lot Modal -->
    <div class="req-modal" id="create-lot-modal" onclick="if(event.target === this) closeCreateLotModal()">
      <div class="req-modal-content" style="max-width: 400px;">
        <div class="req-modal-header">
          <span class="req-modal-title">üì¶ Create New Lot</span>
          <button class="modal-close-btn" onclick="closeCreateLotModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-md);">
          <div class="form-group">
            <label class="form-label">Lot Name <span class="required">*</span></label>
            <input type="text" id="new-lot-name-input" class="form-input" placeholder="e.g., IT Equipment Lot" style="font-size: 13px;" />
          </div>
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label class="form-label">Description (Optional)</label>
            <textarea id="new-lot-desc-input" class="form-textarea" placeholder="Brief description of this lot..." style="min-height: 50px; font-size: 13px;"></textarea>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeCreateLotModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="createLotFromModal()">Create Lot</button>
        </div>
      </div>
    </div>

    <!-- Add Product to Lot Modal -->
    <div class="req-modal" id="add-product-modal" onclick="if(event.target === this) closeAddProductModal()">
      <div class="req-modal-content" style="max-width: 500px;">
        <div class="req-modal-header">
          <span class="req-modal-title">‚ûï Add Products to Lot</span>
          <button class="modal-close-btn" onclick="closeAddProductModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: 0;">
          <div class="product-modal-tabs">
            <button class="product-modal-tab active" data-tab="from-requisition" onclick="switchProductModalTab('from-requisition')">From Requisition Lines</button>
            <button class="product-modal-tab" data-tab="new-product" onclick="switchProductModalTab('new-product')">Create New</button>
          </div>
          
          <!-- From Requisition Lines Tab -->
          <div class="product-modal-tab-content active" id="tab-from-requisition" style="padding: var(--spacing-md); max-height: 350px; overflow-y: auto;">
            <div id="add-product-req-lines">
              <!-- Requisition lines will be populated here -->
            </div>
          </div>
          
          <!-- Create New Product Tab -->
          <div class="product-modal-tab-content" id="tab-new-product" style="padding: var(--spacing-md);">
            <div class="new-product-form">
              <div class="form-group">
                <label class="form-label">UNSPSC Code <span class="required">*</span></label>
                <input type="text" id="new-product-unspsc" class="form-input" placeholder="e.g., 43211503" maxlength="8" style="font-size: 13px; font-family: 'Courier New', monospace;" />
                <span class="help-text">8-digit UNSPSC code</span>
              </div>
              <div class="form-group">
                <label class="form-label">Description <span class="required">*</span></label>
                <input type="text" id="new-product-desc" class="form-input" placeholder="e.g., Laptop computers" style="font-size: 13px;" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Quantity</label>
                  <input type="number" id="new-product-qty" class="form-input" value="1" min="1" style="font-size: 13px;" />
                </div>
                <div class="form-group">
                  <label class="form-label">Estimated Value (USD)</label>
                  <input type="number" id="new-product-value" class="form-input" placeholder="0.00" min="0" step="0.01" style="font-size: 13px;" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeAddProductModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" id="add-product-confirm-btn" onclick="addProductsFromRequisition()">Add Selected</button>
        </div>
      </div>
    </div>

    <!-- Edit Lot Modal -->
    <div class="req-modal" id="edit-lot-modal" onclick="if(event.target === this) closeEditLotModal()">
      <div class="req-modal-content" style="max-width: 400px;">
        <div class="req-modal-header">
          <span class="req-modal-title">‚úèÔ∏è Edit Lot</span>
          <button class="modal-close-btn" onclick="closeEditLotModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-md);">
          <input type="hidden" id="edit-lot-id" />
          <div class="form-group">
            <label class="form-label">Lot Name <span class="required">*</span></label>
            <input type="text" id="edit-lot-name-input" class="form-input" placeholder="e.g., IT Equipment Lot" style="font-size: 13px;" />
          </div>
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label class="form-label">Description (Optional)</label>
            <textarea id="edit-lot-desc-input" class="form-textarea" placeholder="Brief description of this lot..." style="min-height: 50px; font-size: 13px;"></textarea>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeEditLotModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="saveEditLot()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Lots Upload Preview Modal -->
    <div class="req-modal" id="lots-upload-preview-modal" onclick="if(event.target === this) closeLotsUploadPreviewModal()">
      <div class="req-modal-content" style="max-width: 600px;">
        <div class="req-modal-header">
          <span class="req-modal-title">üì¶ Import Lots Preview</span>
          <button class="modal-close-btn" onclick="closeLotsUploadPreviewModal()">‚úï</button>
        </div>
        <div class="req-modal-body" id="lots-upload-preview-body" style="padding: var(--spacing-md);">
          <!-- Preview content will be populated here -->
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeLotsUploadPreviewModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="confirmLotsUpload()">Import All Lots</button>
        </div>
      </div>
    </div>
  </body>
</html>


