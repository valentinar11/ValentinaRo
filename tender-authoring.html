<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNOPS PDJ ¬∑ Create Tender</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/primeicons@6.0.1/primeicons.css" />
    <style>
      :root {
        /* UNOPS Preset Primary Colors - Matching award-review-dashboard */
        --primary-50: #e6f7ff;
        --primary-100: #bae7ff;
        --primary-200: #7dd3fc;
        --primary-300: #38bdf8;
        --primary-400: #0ea5e9;
        --primary-500: #0092D1;
        --primary-600: #0284c7;
        --primary-700: #0369a1;
        --primary-800: #003a56;
        --primary-900: #001d2b;

        /* Surface Colors */
        --surface-0: #ffffff;
        --surface-50: #f5f8fb;
        --surface-100: #ebf1f8;
        --surface-200: #dde8f2;
        --surface-300: #cfdfec;
        --surface-400: #a3a3a3;
        --surface-600: #95a7ba;
        --surface-800: #596170;
        --surface-900: #3b3e4a;

        /* Neutral - for compatibility */
        --neutral-50: #f5f8fb;
        --neutral-100: #ebf1f8;
        --neutral-200: #dde8f2;
        --neutral-300: #cfdfec;
        --neutral-400: #a3a3a3;
        --neutral-500: #95a7ba;
        --neutral-600: #596170;
        --neutral-700: #404040;
        --neutral-800: #3b3e4a;
        --neutral-900: #3b3e4a;

        /* Semantic Colors */
        --success-50: #d2e7cd;
        --success-100: #e8f5e9;
        --success-500: #4c9f38;
        --success-600: #4c9f38;
        --success-700: #388e3c;
        
        --info-50: #bfe4f4;
        --info-100: #e3f2fd;
        --info-400: #0092d1;
        --info-500: #2196f3;
        --info-600: #2563eb;
        --info-700: #1976d2;
        
        --warning-50: #f9d6c3;
        --warning-100: #fff3e0;
        --warning-500: #e85c0e;
        --warning-600: #d97706;
        --warning-700: #f57c00;
        
        --danger-50: #f6cac6;
        --danger-100: #fee2e2;
        --danger-500: #da291c;
        --danger-600: #dc2626;

        --purple-50: #f3e8ff;
        --purple-100: #e9d5ff;
        --purple-500: #9333ea;
        --purple-700: #7c3aed;

        /* Text Colors */
        --text-primary: var(--surface-900);
        --text-secondary: var(--surface-800);
        --text-muted: var(--surface-600);

        /* Spacing Scale */
        --spacing-xs: 6px;
        --spacing-sm: 12px;
        --spacing-md: 20px;
        --spacing-lg: 28px;
        --spacing-xl: 36px;
        --spacing-2xl: 48px;
        --spacing-3xl: 64px;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
        --radius-xl: 16px;

        /* Shadow System */
        --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);

        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Lato', 'Noto Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--surface-50);
        color: var(--text-primary);
        line-height: 1.5;
        min-height: 100vh;
      }

      /* Header - Matching award-review-dashboard */
      .header {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md) var(--spacing-xl);
      }

      .logo-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .logo {
        font-weight: 700;
        font-size: 20px;
        letter-spacing: 0.12em;
        color: var(--primary-400);
      }

      .portal-badge {
        background: var(--primary-400);
        color: white;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .user-info {
        text-align: right;
      }

      .user-company {
        font-size: 12px;
        color: var(--text-muted);
      }

      .user-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-100);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--primary-600);
        cursor: pointer;
      }

      /* Header Actions - Matching tender-dashboard */
      .header-actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-left: auto;
        margin-right: var(--spacing-lg);
      }

      .header-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        font-size: 13px;
      }

      .header-action-btn:hover {
        background: var(--surface-100);
        transform: scale(1.1);
      }

      .header-action-btn i {
        font-size: 20px;
        color: var(--text-muted);
        transition: color 0.2s ease;
      }

      .header-action-btn:hover i {
        color: var(--primary-500);
      }

      .header-action-label {
        display: none;
      }

      .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--danger-500);
        color: white;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .ai-badge {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        color: white;
        font-size: 9px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 4px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .ai-icon-wrapper {
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .ai-icon-wrapper i {
        font-size: 14px;
        color: white !important;
      }

      .language-selector {
        gap: 4px;
      }

      .lang-flag {
        font-size: 18px;
      }

      /* Page Action Bar - for buttons moved from header */
      .page-action-bar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) 0;
        margin-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md) var(--spacing-lg);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
      }

      /* Button styles matching award-review-dashboard */
      .page-action-bar .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        text-decoration: none;
      }

      .page-action-bar .btn-secondary {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .page-action-bar .btn-secondary:hover {
        background: var(--surface-200);
        border-color: var(--surface-300);
      }

      .page-action-bar .btn-primary {
        background: var(--primary-500);
        color: white;
      }

      .page-action-bar .btn-primary:hover {
        background: var(--primary-600);
      }

      .page-action-bar .btn i {
        font-size: 14px;
      }

      /* Legacy top-bar classes for backward compatibility */
      .top-bar {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md) var(--spacing-xl);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .top-bar__brand {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .top-bar__breadcrumbs {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 400;
      }

      .top-bar__title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .top-bar__actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      /* Buttons - Matching award-review-dashboard exactly */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        text-decoration: none;
      }

      .btn-ghost {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .btn-ghost:hover {
        background: var(--surface-200);
      }

      .btn-secondary {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .btn-secondary:hover {
        background: var(--surface-200);
      }

      .btn-primary {
        background: var(--primary-500);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-600);
      }

      .btn-primary:disabled {
        background: var(--surface-300);
        border: none;
        color: var(--surface-600);
        cursor: not-allowed;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
      }

      .btn i {
        font-size: 14px;
      }

      /* Layout - App Container */
      .app-container {
        display: flex;
        flex-direction: row;
        min-height: calc(100vh - 65px);
        width: 100%;
      }

      /* Workspace Layout - Legacy support */
      .workspace {
        display: flex;
        min-height: calc(100vh - 65px);
      }

      /* Sidebar - Matching award-review-dashboard */
      .sidebar {
        width: 300px;
        min-width: 300px;
        max-width: 300px;
        background-color: #0192D1;
        color: white;
        display: flex;
        flex-direction: column;
        border-right: none;
        flex-shrink: 0;
        overflow-y: auto;
      }

      .sidebar-menu {
        flex: 1;
        padding: 16px 0;
      }

      .menu-section {
        margin-bottom: var(--spacing-sm);
      }

      .menu-section-title {
        padding: 8px 20px 12px 20px;
        font-size: 11px;
        font-weight: 700;
        color: rgba(255,255,255,0.5);
        font-family: 'Lato', sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        font-size: 14px;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        border-left: 3px solid transparent;
      }

      .menu-item:hover {
        background: rgba(255,255,255,0.1);
      }

      .menu-item.active {
        background: rgba(255,255,255,0.15);
        border-left-color: white;
        font-weight: 600;
      }

      .menu-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .menu-item.disabled:hover {
        background-color: transparent;
      }

      .menu-icon {
        font-size: 16px;
        opacity: 0.9;
        width: 20px;
        text-align: center;
      }

      .menu-badge {
        margin-left: auto;
        padding: 2px 8px;
        background: var(--danger-500);
        color: white;
        font-size: 11px;
        font-weight: 600;
        border-radius: 999px;
      }

      /* Left Rail Navigation - Legacy support */
      .rail {
        width: 280px;
        min-width: 280px;
        background-color: #0192D1;
        color: white;
        display: flex;
        flex-direction: column;
        padding: 20px 0;
      }

      .rail button {
        width: 100%;
        padding: 12px 20px;
        border-radius: 0;
        border: none;
        background: transparent;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 12px;
        margin: 0 10px;
        border-radius: 5px;
        text-align: left;
      }

      .rail button .rail-label {
        display: block;
        font-size: 16px;
        font-weight: normal;
        white-space: nowrap;
        font-family: 'Lato', sans-serif;
      }

      .rail button.active {
        background: #006599;
        color: #fff;
      }

      .rail button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        padding: var(--spacing-xl);
        overflow-y: auto;
        min-width: 0;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Page Header - Matching award-review-dashboard */
      .page-header {
        margin-bottom: var(--spacing-xl);
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .page-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
      }

      /* Section Title */
      .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .section-title i {
        color: var(--primary-500);
      }

      /* Card Component - Matching award-review-dashboard */
      .card {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--surface-200);
        box-shadow: var(--shadow-card);
      }

      .card-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .card-body {
        padding: var(--spacing-lg);
      }

      /* Status Badges */
      .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.pending {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .status-badge.review {
        background: var(--info-50);
        color: var(--info-400);
      }

      .status-badge.approved {
        background: var(--success-50);
        color: var(--success-500);
      }

      .status-badge.deliberation {
        background: var(--purple-50);
        color: var(--purple-500);
      }

      .status-badge.returned {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      /* Filter Bar - Matching award-review-dashboard */
      .filter-bar {
        background: white;
        padding: 20px;
        border-radius: var(--radius-lg);
        border: 1px solid var(--surface-200);
        margin-bottom: 24px;
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
        box-shadow: var(--shadow-card);
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 13px;
        background: white;
        cursor: pointer;
        min-width: 150px;
      }

      .filter-select:focus {
        outline: none;
        border-color: var(--primary-500);
      }

      /* View States */
      .view-section {
        display: none;
        flex: 1;
        flex-direction: column;
        overflow: hidden;
      }

      .view-section.active {
        display: flex;
      }

      /* ===== TENDER INITIATION METHOD SELECTION ===== */
      .initiation-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        padding: var(--spacing-2xl) var(--spacing-xl);
      }

      .initiation-header {
        text-align: center;
        margin-bottom: var(--spacing-2xl);
      }

      .initiation-title {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .initiation-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
      }

      .initiation-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
      }

      .initiation-card {
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-card);
      }

      .initiation-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .initiation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-500);
        opacity: 0;
        transition: opacity 0.2s;
      }

      .initiation-card:hover::before {
        opacity: 1;
      }

      .initiation-card-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
      }

      .initiation-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .initiation-card-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: var(--spacing-md);
      }

      .initiation-card-features {
        list-style: none;
        padding: 0;
        margin: 0 0 var(--spacing-md) 0;
        text-align: left;
        width: 100%;
      }

      .initiation-card-features li {
        font-size: 13px;
        color: var(--text-secondary);
        padding: var(--spacing-xs) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .initiation-card-features li::before {
        content: '‚úì';
        color: var(--success-500);
        font-weight: 700;
      }

      .initiation-card-badge {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        background: var(--primary-50);
        color: var(--primary-600);
        font-size: 11px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .initiation-card-action {
        margin-top: auto;
        width: 100%;
      }

      .initiation-card-action .btn {
        width: 100%;
      }

      /* ===== TENDER SELECTION MODAL ===== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        max-width: 900px;
        width: 90%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: var(--spacing-xs);
      }

      .modal-close-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: var(--surface-100);
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: var(--text-secondary);
        transition: all 0.2s;
      }

      .modal-close-btn:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .modal-search {
        margin-bottom: var(--spacing-lg);
      }

      .modal-search input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .modal-search input:focus {
        outline: none;
        border-color: var(--primary-400);
      }

      .modal-search::before {
        content: 'üîç';
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
      }

      .modal-search {
        position: relative;
      }

      .existing-tenders-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .existing-tender-card {
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: var(--shadow-card);
      }

      .existing-tender-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateX(4px);
      }

      .existing-tender-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-sm);
      }

      .existing-tender-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .existing-tender-reference {
        font-size: 13px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .existing-tender-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .existing-tender-meta {
        display: flex;
        gap: var(--spacing-md);
        font-size: 13px;
        color: var(--text-secondary);
      }

      .existing-tender-template {
        font-size: 12px;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 4px 12px;
        border-radius: 12px;
        display: inline-block;
        width: fit-content;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .badge-success {
        background: var(--success-50);
        color: var(--success-500);
      }

      .badge-warning {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .badge-info {
        background: var(--info-50);
        color: var(--info-400);
      }

      .badge-danger {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      /* UNGM Eligibility Status Badges */
      .ungm-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        white-space: nowrap;
      }

      .ungm-status-badge i {
        font-size: 10px;
      }

      /* Sanction - Red (Ineligibility or Debarment, Ineligible for Registration) */
      .ungm-status-sanction {
        background: #FEE2E2;
        color: #DC2626;
        border: 1px solid #FECACA;
      }

      /* Censure - Orange */
      .ungm-status-censure {
        background: #FFEDD5;
        color: #EA580C;
        border: 1px solid #FED7AA;
      }

      /* Potential - Ochre (Potentially Ineligible) */
      .ungm-status-potential {
        background: #FEF3C7;
        color: #B45309;
        border: 1px solid #FDE68A;
      }

      /* Performance Issues - Purple */
      .ungm-status-performance {
        background: #F3E8FF;
        color: #7C3AED;
        border: 1px solid #DDD6FE;
      }

      /* Other - Gray */
      .ungm-status-other {
        background: var(--surface-100);
        color: var(--text-secondary);
        border: 1px solid var(--surface-200);
      }

      /* Clear - Green (no issues) */
      .ungm-status-clear {
        background: var(--success-50);
        color: var(--success-600);
        border: 1px solid var(--success-100);
      }

      /* UNGM Status Header Tooltip */
      .ungm-status-header {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .ungm-status-header .ungm-info-trigger {
        cursor: help;
        color: var(--text-muted);
        font-size: 12px;
        transition: color 0.2s;
      }

      .ungm-status-header .ungm-info-trigger:hover {
        color: var(--primary-500);
      }

      .ungm-status-header .ungm-tooltip {
        position: absolute;
        top: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        padding: 12px;
        min-width: 280px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
      }

      .ungm-status-header .ungm-info-trigger:hover + .ungm-tooltip,
      .ungm-status-header .ungm-tooltip:hover {
        opacity: 1;
        visibility: visible;
      }

      .ungm-tooltip::before {
        content: '';
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid var(--surface-200);
      }

      .ungm-tooltip::after {
        content: '';
        position: absolute;
        top: -5px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-bottom: 5px solid white;
      }

      .ungm-tooltip-title {
        font-weight: 600;
        font-size: 12px;
        color: var(--text-primary);
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--surface-100);
      }

      .ungm-tooltip-legend {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .ungm-tooltip-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        color: var(--text-secondary);
      }

      .ungm-tooltip-item .ungm-status-badge {
        min-width: 80px;
        justify-content: center;
        font-size: 9px;
        padding: 2px 6px;
      }

      .ungm-tooltip-footer {
        margin-top: 8px;
        padding-top: 6px;
        border-top: 1px solid var(--surface-100);
        font-size: 10px;
        color: var(--text-muted);
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .loading-content {
        background: var(--surface-0);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        text-align: center;
        box-shadow: var(--shadow-2xl);
      }

      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--neutral-200);
        border-top-color: var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--spacing-lg);
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* ===== EVALUATION CRITERIA ENHANCED STYLES ===== */
      .evaluation-criterion-card {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-base);
      }

      .evaluation-criterion-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-200);
      }

      .criterion-applies-to-section {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .lot-selection-group,
      .product-selection-group {
        margin-bottom: var(--spacing-md);
      }

      .lot-selection-group:last-child,
      .product-selection-group:last-child {
        margin-bottom: 0;
      }

      .selection-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: var(--spacing-sm);
        display: block;
      }

      .criterion-selection-summary {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-radius: var(--radius-sm);
        color: var(--info-700);
      }

      .criterion-selection-summary strong {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
      }

      .criterion-selection-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-xs);
        font-size: 13px;
      }

      .criterion-selection-item::before {
        content: '‚úì';
        color: var(--info-600);
        font-weight: bold;
      }

      /* ===== PROCUREMENT LIFECYCLE TRACKER ===== */
      .lifecycle-tracker-container {
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-top: var(--spacing-md);
      }

      .lifecycle-tracker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .lifecycle-tracker-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .lifecycle-tracker-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .btn-icon {
        padding: 8px 12px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .lifecycle-chain {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        overflow-x: auto;
        padding: var(--spacing-md) 0;
      }

      .lifecycle-node {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 140px;
        position: relative;
      }

      .lifecycle-node-badge {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: var(--neutral-100);
        border: 3px solid var(--neutral-300);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-base);
        cursor: pointer;
      }

      .lifecycle-node.current .lifecycle-node-badge {
        background: var(--primary-50);
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px var(--primary-100);
      }

      .lifecycle-node.completed .lifecycle-node-badge {
        background: var(--success-50);
        border-color: var(--success-500);
      }

      .lifecycle-node.future .lifecycle-node-badge {
        background: var(--surface-50);
        border-color: var(--neutral-200);
        opacity: 0.6;
      }

      .lifecycle-node-badge:hover {
        transform: scale(1.05);
      }

      .lifecycle-node-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: center;
        margin-bottom: var(--spacing-xs);
      }

      .lifecycle-node-id {
        font-size: 11px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .lifecycle-arrow {
        font-size: 20px;
        color: var(--neutral-300);
        margin: 0 var(--spacing-xs);
      }

      .lifecycle-arrow.active {
        color: var(--primary-400);
      }

      .linked-processes-list {
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
      }

      .linked-process-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-base);
      }

      .linked-process-item:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-sm);
      }

      .linked-process-item:last-child {
        margin-bottom: 0;
      }

      .linked-process-info {
        flex: 1;
      }

      .linked-process-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .linked-process-meta {
        display: flex;
        gap: var(--spacing-lg);
        font-size: 12px;
        color: var(--text-muted);
      }

      .linked-process-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .btn-link-action {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--neutral-200);
        background: var(--surface-0);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .btn-link-action:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-600);
      }

      .btn-link-action.remove:hover {
        background: var(--danger-50);
        border-color: var(--danger-400);
        color: var(--danger-600);
      }

      .lifecycle-relationship-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .relationship-predecessor {
        background: var(--info-100);
        color: var(--info-600);
      }

      .relationship-successor {
        background: var(--success-100);
        color: var(--success-600);
      }

      .relationship-related {
        background: var(--warning-100);
        color: var(--warning-600);
      }

      .lifecycle-empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-muted);
      }

      .lifecycle-empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .lifecycle-search-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      }

      .lifecycle-search-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 700px;
        width: 90%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .lifecycle-search-header {
        padding: var(--spacing-xl);
        border-bottom: 1px solid var(--neutral-200);
      }

      .lifecycle-search-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-xl);
      }

      .lifecycle-search-input-wrapper {
        position: relative;
        margin-bottom: var(--spacing-lg);
      }

      .lifecycle-search-input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
      }

      .lifecycle-search-input:focus {
        outline: none;
        border-color: var(--primary-500);
      }

      .lifecycle-search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
      }

      .lifecycle-search-results {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .lifecycle-search-result {
        padding: var(--spacing-md);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .lifecycle-search-result:hover {
        border-color: var(--primary-500);
        background: var(--primary-50);
      }

      .lifecycle-search-result-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .lifecycle-search-result-meta {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        gap: var(--spacing-md);
      }

      .lifecycle-audit-trail {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--neutral-200);
      }

      .lifecycle-audit-trail-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .lifecycle-audit-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .lifecycle-audit-item::before {
        content: '‚Ä¢';
        color: var(--primary-500);
        font-weight: bold;
      }

      .lifecycle-audit-timestamp {
        color: var(--text-muted);
        margin-left: auto;
      }

      /* ===== EVENT SETUP WIZARD STYLES ===== */
      .wizard-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
        padding: var(--spacing-xl);
      }

      .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-2xl);
        position: relative;
      }

      .wizard-steps::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--surface-200);
        z-index: 0;
      }

      .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
      }

      .wizard-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        right: -50%;
        height: 2px;
        background: var(--surface-200);
        z-index: -1;
      }

      .wizard-step:first-child::before {
        left: 50%;
      }

      .wizard-step:last-child::before {
        display: none;
      }

      .wizard-step.completed::before {
        background: var(--success-500);
      }

      .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--surface-0);
        border: 2px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
        transition: all 0.2s ease;
      }

      .wizard-step.active .step-circle {
        background: var(--primary-500);
        border-color: var(--primary-500);
        color: white;
      }

      .wizard-step.completed .step-circle {
        background: var(--success-500);
        border-color: var(--success-500);
        color: white;
      }

      .wizard-step.completed .step-circle::after {
        content: '‚úì';
      }

      .step-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-align: center;
        font-weight: 500;
      }

      .wizard-step.active .step-label {
        color: var(--primary-500);
        font-weight: 600;
      }

      .wizard-content {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
        min-height: 500px;
      }

      .wizard-step-content {
        display: none;
      }

      .wizard-step-content.active {
        display: block;
      }

      .step-title {
        font-size: 22px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .step-description {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-lg);
      }

      /* ===== TENDER AUTHORING STYLES ===== */
      .progress-container {
        background: white;
        border-bottom: 1px solid var(--surface-200);
        padding: var(--spacing-md) var(--spacing-lg);
      }

      .progress-steps {
        display: flex;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
        gap: var(--spacing-sm);
      }

      .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        cursor: pointer;
      }

      .progress-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: -50%;
        right: 50%;
        height: 2px;
        background: var(--surface-200);
        z-index: 0;
      }

      .progress-step:first-child::before {
        display: none;
      }

      .progress-step.completed::before {
        background: var(--success-500);
      }

      .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--surface-0);
        border: 2px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        z-index: 1;
        margin-bottom: var(--spacing-xs);
      }

      .progress-step.completed .step-icon {
        background: var(--success-500);
        color: white;
        border-color: var(--success-500);
      }

      .progress-step.active .step-icon {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
      }

      .step-label {
        font-size: 11px;
        text-align: center;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .progress-step.active .step-label {
        color: var(--primary-400);
        font-weight: 600;
      }

      .block-nav {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        padding: 0 var(--spacing-xl);
        display: flex;
        gap: 0;
        overflow-x: auto;
        flex-wrap: nowrap;
        position: relative;
      }

      /* Connector line between tabs - hidden for cleaner look */
      .block-nav::before {
        display: none;
      }

      .block-tab {
        padding: 16px 20px;
        border: none;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        background: transparent;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 1;
        box-shadow: none;
        min-width: fit-content;
      }

      .block-tab:hover {
        color: var(--primary-600);
        background: var(--surface-50);
        border-color: transparent;
        transform: none;
        box-shadow: none;
        border-bottom-color: var(--primary-200);
      }

      .block-tab.active {
        color: var(--primary-600);
        background: var(--primary-50);
        border-color: transparent;
        border-bottom: 3px solid var(--primary-500);
        font-weight: 600;
        box-shadow: none;
        transform: none;
      }

      .block-tab.active:hover {
        background: var(--primary-100);
        transform: none;
      }

      /* Completed state for tabs */
      .block-tab.completed {
        border-bottom-color: var(--success-400);
        background: transparent;
      }

      .block-tab.completed:hover {
        background: var(--success-50);
      }

      .block-tab.completed::after {
        display: none;
      }

      .block-tab-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--surface-100);
        border: 2px solid var(--surface-200);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .block-tab:hover .block-tab-number {
        background: var(--primary-50);
        border-color: var(--primary-200);
        color: var(--primary-600);
      }

      .block-tab.active .block-tab-number {
        background: var(--primary-500);
        border-color: var(--primary-500);
        color: white;
      }

      .block-tab.completed .block-tab-number {
        background: var(--success-500);
        border-color: var(--success-500);
        color: white;
      }

      .block-tab-pi-icon {
        font-size: 15px;
        color: var(--text-muted);
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .block-tab:hover .block-tab-pi-icon {
        color: var(--primary-500);
      }

      .block-tab.active .block-tab-pi-icon {
        color: var(--primary-600);
      }

      .block-tab.completed .block-tab-pi-icon {
        color: var(--success-500);
      }

      .block-tab-icon {
        font-size: 16px;
        font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
        display: none;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: var(--surface-100);
        border-radius: var(--radius-md);
        transition: all 0.25s ease;
      }

      .block-tab:hover .block-tab-icon {
        background: var(--primary-100);
      }

      .block-tab.active .block-tab-icon {
        background: rgba(255, 255, 255, 0.2);
      }

      .block-tab-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }

      .block-tab-name {
        font-size: 13px;
        font-weight: 500;
        line-height: 1.3;
        color: inherit;
      }

      .block-tab.active .block-tab-name {
        font-weight: 600;
      }

      .block-tab-status {
        font-size: 11px;
        font-weight: 500;
        text-transform: none;
        letter-spacing: 0;
        padding: 0;
        border-radius: 0;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: transparent;
      }

      .block-tab-status.status-pending {
        background: transparent;
        color: var(--text-muted);
      }

      .block-tab-status.status-in-progress {
        background: transparent;
        color: var(--info-500);
      }

      .block-tab-status.status-complete {
        background: transparent;
        color: var(--success-600);
      }

      .block-tab:hover .block-tab-status.status-pending {
        background: transparent;
        color: var(--primary-500);
      }

      .block-tab.active .block-tab-status {
        background: transparent;
        color: var(--primary-500);
      }

      .block-tab.completed .block-tab-status.status-complete {
        background: transparent;
        color: var(--success-600);
      }

      .block-tab-badge {
        display: none;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        padding: 0 6px;
        border-radius: 11px;
        background: var(--surface-100);
        color: var(--text-muted);
        font-size: 11px;
        font-weight: 700;
        transition: all 0.25s ease;
        border: 1px solid var(--surface-200);
      }

      .block-tab:hover .block-tab-badge {
        background: var(--primary-100);
        color: var(--primary-600);
        border-color: var(--primary-200);
      }

      .block-tab.active .block-tab-badge {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
      }

      /* Progress indicator - hidden for cleaner look */
      .block-tab-progress {
        display: none;
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--surface-200);
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        overflow: hidden;
      }

      .block-tab-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--success-500), var(--success-400));
        transition: width 0.4s ease;
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      }

      .block-tab.active .block-tab-progress {
        background: rgba(255, 255, 255, 0.2);
      }

      .block-tab.active .block-tab-progress-bar {
        background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
      }

      .content-area {
        flex: 1;
        display: flex;
        gap: var(--spacing-md);
        overflow: hidden;
        padding: var(--spacing-lg);
      }

      .content-wrapper {
        flex: 1;
        width: 100%;
        max-width: none;
        overflow-y: auto;
        padding-right: 80px; /* Space for floating button */
      }

      /* ===== SUBMISSION FORMS CARDS ===== */
      .submission-forms-drop-zone {
        position: relative;
        min-height: 200px;
        padding: var(--spacing-md);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        background: var(--surface-0);
        transition: all 0.3s ease;
      }

      .submission-forms-drop-zone.drag-over {
        border-color: var(--primary-300);
        border-style: dashed;
        background: var(--surface-50);
      }

      .submission-forms-drop-hint {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--surface-0);
        color: var(--primary-600);
        border: 1px solid var(--primary-200);
        border-radius: var(--radius-lg);
        font-size: 13px;
        font-weight: 500;
        gap: var(--spacing-sm);
        align-items: center;
        box-shadow: var(--shadow-md);
        z-index: 10;
      }

      .submission-forms-drop-zone.drag-over .submission-forms-drop-hint {
        display: flex;
      }

      .submission-forms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: var(--spacing-sm);
      }

      .submission-form-card {
        position: relative;
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        cursor: grab;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        min-height: 160px;
      }

      .submission-form-card:hover {
        border-color: var(--primary-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .submission-form-card.added {
        border-color: var(--surface-200);
        background: var(--surface-0);
      }

      .submission-form-card.added:hover {
        border-color: var(--primary-300);
        background: var(--surface-50);
      }

      .submission-form-card.not-added {
        opacity: 0.7;
        background: var(--surface-50);
        border-style: dashed;
        border-color: var(--surface-300);
      }

      .submission-form-card.not-added:hover {
        opacity: 1;
        border-color: var(--primary-300);
        background: var(--surface-0);
        border-style: solid;
      }

      .submission-form-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-bottom: var(--spacing-sm);
      }

      .submission-form-code {
        min-width: 28px;
        height: 28px;
        padding: 0 8px;
        background: var(--surface-100);
        color: var(--text-secondary);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        border: 1px solid var(--surface-200);
      }

      .submission-form-card.added .submission-form-code {
        background: var(--primary-50);
        color: var(--primary-600);
        border-color: var(--primary-200);
      }

      .submission-form-card.not-added .submission-form-code {
        background: var(--surface-100);
        color: var(--text-muted);
        border-color: var(--surface-200);
      }

      .submission-form-actions {
        display: flex;
        gap: 4px;
      }

      .btn-icon-xs {
        min-width: 26px;
        height: 26px;
        padding: 0 8px;
        border: 1px solid var(--surface-200);
        background: var(--surface-100);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 500;
        transition: all 0.2s ease;
        color: var(--text-primary);
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
      }

      .btn-icon-xs:hover {
        background: var(--surface-200);
        border-color: var(--surface-300);
      }

      .btn-icon-xs.danger {
        background: var(--surface-100);
        border-color: var(--surface-200);
        color: var(--text-secondary);
      }

      .btn-icon-xs.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-200);
        color: var(--danger-600);
      }

      .btn-icon-xs.success {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
      }

      .btn-icon-xs.success:hover {
        background: var(--primary-600);
        border-color: var(--primary-600);
      }
      
      .btn-icon-xs.preview {
        background: var(--surface-100);
        border-color: var(--surface-200);
        color: var(--text-secondary);
      }

      .btn-icon-xs.preview:hover {
        background: var(--info-50);
        border-color: var(--info-200);
        color: var(--info-600);
      }

      .submission-form-icon {
        font-size: 32px;
        margin-bottom: var(--spacing-sm);
      }

      .submission-form-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
        line-height: 1.3;
      }

      .submission-form-description {
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.4;
      }

      .submission-form-required-badge {
        position: absolute;
        top: -1px;
        right: -1px;
        font-size: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 3px 8px;
        background: var(--surface-100);
        color: var(--text-muted);
        border-radius: 0 var(--radius-lg) 0 var(--radius-md);
        border-left: 1px solid var(--surface-200);
        border-bottom: 1px solid var(--surface-200);
        display: none;
      }

      .submission-form-card.required .submission-form-required-badge {
        display: block;
      }

      .submission-form-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-lg);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .submission-form-overlay span {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted);
        background: var(--surface-0);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .submission-form-card.not-added:hover .submission-form-overlay {
        opacity: 0;
      }

      /* ===== BID RESPONSE CATEGORIES ===== */
      .bid-response-category {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-left: 4px solid var(--primary-400);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        box-shadow: var(--shadow-sm);
      }

      .bid-response-category:last-child {
        margin-bottom: 0;
      }

      .bid-response-category-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
      }

      .bid-response-category-header h4 {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        min-width: 120px;
      }

      .bid-response-category-hint {
        font-size: 12px;
        color: var(--text-muted);
        flex: 1;
      }

      .bid-response-fields {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .bid-response-field {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
      }

      .bid-response-field:hover {
        background: var(--surface-100);
        border-color: var(--surface-300);
      }

      .bid-response-field-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .bid-response-field-info strong {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .bid-response-field-info span {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* ===== FORM CATEGORY CONTAINER - Modern Design ===== */
      .form-category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
      }

      .form-category-container {
        background: var(--surface-0);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        transition: all 0.2s ease;
        border: 1px solid var(--surface-200);
      }

      .form-category-container:hover {
        border-color: var(--surface-300);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
        transform: translateY(-1px);
      }

      .form-category-container.drag-over {
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-100), 0 4px 12px rgba(0,0,0,0.1);
      }

      .form-category-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-100);
      }

      .form-category-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .form-category-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: var(--primary-600);
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
        border-radius: 10px;
      }

      .form-category-title-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .form-category-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        letter-spacing: -0.01em;
      }

      .form-category-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .form-category-body {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: var(--surface-50);
      }

      /* Form Item - Modern unified style */
      .form-category-item {
        background: var(--surface-0);
        border-radius: 8px;
        padding: 10px 12px;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        border: 1px solid var(--surface-200);
      }

      .form-category-item:hover {
        background: var(--surface-0);
        border-color: var(--surface-300);
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      }

      .form-category-item.predefined.enabled {
        background: var(--surface-0);
      }

      .form-category-item.predefined.disabled {
        opacity: 0.5;
        background: var(--surface-100);
      }

      .form-category-item.library {
        background: var(--surface-0);
      }

      .form-category-item-left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 0;
      }

      .form-category-item-toggle {
        position: relative;
        width: 36px;
        height: 20px;
        background: var(--surface-300);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .form-category-item-toggle.on {
        background: var(--success-500);
      }

      .form-category-item-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      }

      .form-category-item-toggle.on::after {
        left: 18px;
      }

      .form-category-item-icon {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 12px;
        flex-shrink: 0;
      }

      .form-category-item.predefined .form-category-item-icon {
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
        color: var(--primary-600);
      }

      .form-category-item.library .form-category-item-icon {
        background: linear-gradient(135deg, var(--info-50) 0%, var(--info-100) 100%);
        color: var(--info-600);
      }

      .form-category-item-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
        min-width: 0;
      }

      .form-category-item-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .form-category-item-meta {
        font-size: 11px;
        color: var(--text-muted);
      }

      .form-category-item-actions {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
        opacity: 0.6;
        transition: opacity 0.15s ease;
      }

      .form-category-item:hover .form-category-item-actions {
        opacity: 1;
      }

      /* Legacy template styles for compatibility */
      .form-category-template {
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: 4px;
        padding: 5px 6px;
        margin-bottom: 4px;
        transition: all 0.2s ease;
      }

      .form-category-template.enabled {
        border-color: var(--success-300);
        background: var(--success-50);
      }

      .form-category-template.disabled {
        opacity: 0.5;
        background: var(--surface-100);
      }

      .form-category-template-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .form-category-template-left {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .form-category-template-toggle {
        position: relative;
        width: 28px;
        height: 16px;
        background: var(--surface-300);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .form-category-template-toggle.on {
        background: var(--success-500);
      }

      .form-category-template-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      }

      .form-category-template-toggle.on::after {
        left: 14px;
      }

      .form-category-template-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-100);
        color: var(--primary-600);
        border-radius: 3px;
        font-size: 9px;
      }

      .form-category-template-info {
        display: flex;
        flex-direction: column;
        gap: 0;
        flex: 1;
        min-width: 0;
      }

      .form-category-template-name {
        font-size: 10px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .form-category-template-name .template-badge {
        font-size: 7px;
        font-weight: 600;
        text-transform: uppercase;
        padding: 1px 3px;
        background: var(--primary-100);
        color: var(--primary-600);
        border-radius: 2px;
        flex-shrink: 0;
      }

      .form-category-template-desc {
        font-size: 9px;
        color: var(--text-muted);
      }

      .form-category-template-actions {
        display: flex;
        align-items: center;
        gap: 1px;
        flex-shrink: 0;
      }

      /* Drop Zone - Modern style */
      .form-category-dropzone {
        border: 2px dashed var(--surface-200);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .form-category-dropzone:hover {
        border-color: var(--primary-300);
        background: var(--primary-50);
        color: var(--primary-600);
      }

      .form-category-dropzone.drag-over {
        border-color: var(--primary-500);
        background: var(--primary-100);
        color: var(--primary-700);
        border-style: solid;
      }

      .form-category-dropzone-icon {
        font-size: 14px;
      }

      .form-category-dropzone-text {
        font-weight: 500;
        font-size: 12px;
      }

      /* Empty/Warning State - Modern */
      .form-category-empty-warning {
        background: var(--warning-50);
        border-radius: 8px;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--warning-700);
      }

      .form-category-empty-warning i {
        font-size: 14px;
      }

      /* Buttons inside form category containers */
      .form-category-container .btn-icon-xs {
        min-width: 26px;
        height: 26px;
        padding: 0 6px;
        font-size: 11px;
        border-radius: 6px;
        border: none;
        background: var(--surface-100);
      }

      .form-category-container .btn-icon-xs:hover {
        background: var(--surface-200);
      }

      .form-category-container .btn-icon-xs i {
        font-size: 11px;
      }

      /* ===== DOCUMENTS SECTION ===== */
      .documents-drop-zone {
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        background: var(--surface-50);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .documents-drop-zone:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .documents-drop-zone.drag-over {
        border-color: var(--primary-500);
        background: var(--primary-50);
        box-shadow: 0 0 0 4px rgba(var(--primary-500-rgb), 0.1);
      }

      .document-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md);
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        transition: all 0.2s ease;
      }

      .document-item:hover {
        border-color: var(--primary-300);
        box-shadow: var(--shadow-sm);
      }

      /* General Information - Improved Layout */
      .general-info-container {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        border: 1px solid var(--surface-200);
        box-shadow: var(--shadow-card);
        overflow: hidden;
      }

      .general-info-header {
        padding: var(--spacing-lg) var(--spacing-xl);
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-50) 100%);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .general-info-header-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .general-info-header-title h2 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
      }

      .general-info-header-title .subtitle {
        font-size: 13px;
        color: var(--text-muted);
      }

      .general-info-body {
        padding: var(--spacing-xl);
      }

      /* Field Groups for General Information */
      .field-group {
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-xl);
        border-bottom: 1px solid var(--surface-200);
      }

      .field-group:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .field-group-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--primary-400);
        display: inline-block;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
      }

      /* 3-column grid for General Information */
      .form-grid-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
      }

      .form-grid-3col .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-grid-3col .form-group.two-col {
        grid-column: span 2;
      }

      @media (max-width: 1200px) {
        .form-grid-3col {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .form-grid-3col {
          grid-template-columns: 1fr;
        }
        .form-grid-3col .form-group.two-col {
          grid-column: 1;
        }
      }

      /* Inline form group for related fields */
      .inline-form-group {
        display: flex;
        gap: var(--spacing-md);
        align-items: flex-start;
      }

      .inline-form-group .form-group {
        flex: 1;
      }

      /* Info Card within forms */
      .form-info-card {
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-left: 4px solid var(--info-500);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
      }

      .form-info-card p {
        margin: 0;
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .form-info-card strong {
        color: var(--text-primary);
      }

      /* Form Library Panel - EXACT match with Team Board from tender-dashboard */
      .form-library-floating-btn {
        position: fixed;
        right: 0;
        top: 35%;
        transform: translateY(-50%);
        width: 60px;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        padding: 12px 8px;
        cursor: pointer;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        border: 2px solid #4db8e8;
        border-right: none;
      }

      .form-library-floating-btn:hover {
        width: 70px;
        box-shadow: 0 8px 30px rgba(0, 146, 209, 0.4);
      }

      .form-library-floating-btn:focus {
        outline: 3px solid var(--warning-400);
        outline-offset: 2px;
      }

      .form-library-btn-icon {
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .form-library-btn-icon i {
        font-size: 18px;
        color: var(--primary-500);
      }

      .form-library-btn-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--danger-500);
        color: white;
        font-size: 9px;
        font-weight: 700;
        min-width: 16px;
        height: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
      }

      .form-library-btn-label {
        font-size: 9px;
        color: white;
        text-align: center;
        font-weight: 600;
        line-height: 1.2;
      }

      .form-library-panel {
        position: fixed;
        top: 0;
        right: -420px;
        bottom: 0;
        width: 400px;
        background: var(--surface-0);
        box-shadow: var(--shadow-lg);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
      }

      .form-library-panel.open {
        right: 0;
      }

      .form-library-panel.collapsed {
        right: -420px;
      }

      .form-library-header {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: white;
        padding: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .form-library-header-content {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .form-library-header-icon {
        width: 36px;
        height: 36px;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .form-library-header-icon i {
        color: white;
        font-size: 16px;
      }

      .form-library-header-text {
        display: flex;
        flex-direction: column;
      }

      .form-library-title {
        font-size: 14px;
        font-weight: 600;
        color: white;
      }

      .form-library-subtitle {
        font-size: 11px;
        color: rgba(255,255,255,0.8);
      }

      .toggle-library-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
      }

      .toggle-library-btn i {
        color: rgba(255,255,255,0.8);
        font-size: 16px;
      }

      .toggle-library-btn:hover i {
        color: white;
      }

      /* Form Library Panel Top Accent */
      .form-library-panel::before {
        content: '';
        display: block;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
      }

      .form-library-body {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .form-library-search-area {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .form-library-search {
        position: relative;
      }

      .form-library-search input {
        width: 100%;
        border-radius: var(--radius-md);
        border: 1px solid var(--surface-300);
        padding: 10px 12px 10px 40px;
        font-family: 'Lato', 'Noto Sans', sans-serif;
        font-size: 13px;
        background: white;
        color: var(--text-primary);
        transition: all 0.2s ease;
      }

      .form-library-search input::placeholder {
        color: var(--text-muted);
      }

      .form-library-search input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .form-library-search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 14px;
        pointer-events: none;
      }

      .form-library-content {
        flex: 1;
        padding: var(--spacing-md);
        overflow-y: auto;
      }

      .form-library-group {
        margin-bottom: var(--spacing-lg);
      }

      .form-library-group-label {
        font-size: 11px;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
        display: block;
      }

      .form-library-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .form-library-item {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        cursor: grab;
        transition: all 0.2s ease;
        background: var(--surface-0);
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .form-library-item:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .form-library-item:active {
        cursor: grabbing;
      }

      .form-library-item.dragging {
        opacity: 0.5;
        border-color: var(--primary-500);
        background: var(--primary-100);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .form-library-item-icon {
        width: 32px;
        height: 32px;
        background: var(--surface-100);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
      }

      .form-library-item-content {
        flex: 1;
        min-width: 0;
      }

      .form-library-item strong {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .form-library-item span {
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.3;
      }

      .form-library-item-action {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .form-library-item:hover .form-library-item-action {
        opacity: 1;
      }

      /* Form Library Footer */
      .form-library-footer {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-top: 1px solid var(--surface-200);
      }

      .form-library-footer-hint {
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      /* Added Forms Display */
      .added-forms-section {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
      }

      .added-form-item {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .added-form-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .added-form-icon {
        font-size: 20px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
      }

      .added-form-details {
        flex: 1;
      }

      .added-form-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .added-form-type {
        font-size: 12px;
        color: var(--text-muted);
      }

      .added-form-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .form-action-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .form-action-btn:hover {
        background: var(--primary-50);
        border-color: var(--primary-500);
        color: var(--primary-500);
      }

      .form-action-btn.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-500);
        color: var(--danger-500);
      }

      /* Drop Zone in Sections */
      .form-drop-zone {
        min-height: 80px;
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        margin: var(--spacing-md) 0;
        transition: all 0.2s ease;
        background: var(--surface-50);
        font-size: 13px;
      }

      .form-drop-zone.active {
        border-color: var(--success-500);
        background: var(--success-50);
        color: var(--success-500);
      }

      /* Floating Toggle Button - Hidden by default, shown when panel is collapsed */
      .floating-library-toggle {
        display: none;
      }

      /* Scrollbar for form library */
      .form-library-body::-webkit-scrollbar,
      .form-library-list::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .form-library-body::-webkit-scrollbar-track,
      .form-library-list::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .form-library-body::-webkit-scrollbar-thumb,
      .form-library-list::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .form-library-body::-webkit-scrollbar-thumb:hover,
      .form-library-list::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      /* Common Form Styles - Matching tender-dashboard-complete */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .required {
        color: var(--danger-500);
      }

      .form-input,
      .form-select,
      .form-textarea {
        padding: 10px 14px;
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        background: white;
        color: var(--text-primary);
        transition: all 0.2s ease;
        width: 100%;
      }

      .form-input::placeholder,
      .form-select::placeholder,
      .form-textarea::placeholder {
        color: var(--text-muted);
        font-weight: 400;
      }

      .form-input:hover,
      .form-select:hover,
      .form-textarea:hover {
        border-color: var(--surface-400);
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .form-input:disabled,
      .form-select:disabled,
      .form-textarea:disabled {
        background: var(--surface-100);
        color: var(--text-muted);
        cursor: not-allowed;
      }

      .form-input[readonly] {
        background: var(--surface-50);
        color: var(--text-secondary);
      }

      .form-textarea {
        resize: vertical;
        min-height: 120px;
        line-height: 1.5;
      }

      .form-select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
      }

      /* Form Helper Text */
      .form-helper {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
        line-height: 1.4;
      }

      .form-helper.error {
        color: var(--danger-500);
      }

      .form-helper.success {
        color: var(--success-500);
      }

      /* Input with Icon */
      .input-with-icon {
        position: relative;
      }

      .input-with-icon .form-input {
        padding-left: 40px;
      }

      .input-with-icon .input-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 16px;
      }

      /* Checkbox and Radio Styles */
      .form-checkbox,
      .form-radio {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
      }

      .form-checkbox input,
      .form-radio input {
        accent-color: var(--primary-500);
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      /* Checkbox Group */
      .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .checkbox-group.horizontal {
        flex-direction: row;
        flex-wrap: wrap;
        gap: var(--spacing-md);
      }

      /* Rich Text Editor */
      .rich-text-editor-container {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        overflow: hidden;
        background: var(--surface-0);
      }

      .rich-text-toolbar {
        display: flex;
        gap: 4px;
        padding: 8px;
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
        flex-wrap: wrap;
      }

      .toolbar-btn {
        padding: 6px 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      .toolbar-btn:hover {
        background: var(--surface-100);
        border-color: var(--primary-400);
      }

      .toolbar-btn:active {
        background: var(--primary-100);
      }

      .toolbar-divider {
        width: 1px;
        background: var(--surface-200);
        margin: 0 4px;
      }

      .rich-text-editor {
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
        padding: 16px;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-primary);
        outline: none;
      }

      .rich-text-editor:focus {
        box-shadow: inset 0 0 0 2px var(--primary-50);
      }

      .rich-text-editor[contenteditable]:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
        pointer-events: none;
        display: block;
      }

      .rich-text-editor h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 16px 0 8px 0;
        color: var(--text-primary);
      }

      .rich-text-editor h4 {
        font-size: 16px;
        font-weight: 600;
        margin: 12px 0 6px 0;
        color: var(--text-primary);
      }

      .rich-text-editor p {
        margin: 8px 0;
      }

      .rich-text-editor ul,
      .rich-text-editor ol {
        margin: 8px 0;
        padding-left: 24px;
      }

      .rich-text-editor li {
        margin: 4px 0;
      }

      .rich-text-editor strong {
        font-weight: 600;
      }

      .rich-text-editor em {
        font-style: italic;
      }

      .rich-text-editor u {
        text-decoration: underline;
      }

      .rich-text-editor s,
      .rich-text-editor strike {
        text-decoration: line-through;
      }

      .rich-text-editor blockquote {
        border-left: 4px solid var(--primary-500);
        padding-left: 16px;
        margin: 12px 0;
        color: var(--text-secondary);
        font-style: italic;
      }

      .rich-text-editor a {
        color: var(--primary-500);
        text-decoration: underline;
      }

      .rich-text-editor a:hover {
        color: var(--primary-700);
      }

      .rich-text-editor hr {
        border: none;
        border-top: 2px solid var(--surface-200);
        margin: 16px 0;
      }

      .toolbar-btn.active {
        background: var(--primary-100);
        border-color: var(--primary-500);
        color: var(--primary-600);
      }

      .toolbar-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .editor-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--surface-50);
        border-top: 1px solid var(--surface-200);
        font-size: 12px;
        color: var(--text-muted);
      }

      .editor-word-count {
        display: flex;
        gap: 16px;
      }

      .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
      }

      /* Form Sections - Matching award-review-dashboard */
      .form-section {
        background: white;
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
        transition: all 0.2s;
      }

      .form-section:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-400);
      }

      /* Collapsible functionality removed - all sections are always visible */
      /* .form-section.collapsed .section-body {
        display: none;
      } */

      .section-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-50);
      }

      .form-section .section-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .section-icon {
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--primary-50);
        border-radius: var(--radius-md);
      }

      /* .collapse-icon {
        font-size: 12px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
        margin-left: var(--spacing-sm);
      } */

      /* .form-section.collapsed .collapse-icon {
        transform: rotate(-90deg);
      } */

      .status-indicator {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid transparent;
        transition: all var(--transition-fast);
      }

      .status-complete {
        background: var(--success-50);
        color: var(--success-600);
        border-color: var(--success-100);
      }

      .status-incomplete {
        background: var(--warning-50);
        color: var(--warning-600);
        border-color: var(--warning-100);
      }

      .section-body {
        padding: var(--spacing-lg);
      }

      /* Template Cards */
      .template-suggestions {
        margin-top: var(--spacing-xl);
      }

      .suggestions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-lg);
      }

      .suggestions-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .suggestions-badge {
        padding: 4px 10px;
        background: var(--info-50);
        color: var(--info-400);
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }

      .template-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
      }

      .template-card {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        box-shadow: var(--shadow-card);
      }

      .template-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .template-card.selected {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .template-card.recommended {
        border-color: var(--success-500);
        position: relative;
      }

      .template-card.recommended::before {
        content: '‚≠ê Recommended';
        position: absolute;
        top: -12px;
        left: var(--spacing-sm);
        background: var(--success-500);
        color: white;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }

      .template-card-header {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }

      .template-icon {
        font-size: 32px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
        flex-shrink: 0;
      }

      .template-info {
        flex: 1;
      }

      .template-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .template-type {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .template-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-top: var(--spacing-sm);
      }

      .template-meta {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        font-size: 12px;
        color: var(--text-muted);
      }

      .template-meta-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .view-all-link {
        text-align: center;
        margin-top: var(--spacing-md);
      }

      .view-all-link a {
        color: var(--primary-500);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .view-all-link a:hover {
        text-decoration: underline;
      }

      /* Lifecycle Tracker - Compact Version */
      .lifecycle-tracker-compact {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .lifecycle-tracker-compact-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lifecycle-tracker-compact-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lifecycle-count-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background: var(--primary-100);
        color: var(--primary-600);
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }

      .lifecycle-empty-compact {
        padding: var(--spacing-md);
        text-align: center;
      }

      .lifecycle-linked-list-compact {
        display: flex;
        flex-direction: column;
      }

      .lifecycle-linked-item-compact {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border-bottom: 1px solid var(--surface-100);
        transition: background 0.2s;
      }

      .lifecycle-linked-item-compact:last-child {
        border-bottom: none;
      }

      .lifecycle-linked-item-compact:hover {
        background: var(--surface-50);
      }

      .lifecycle-type-indicator {
        width: 4px;
        height: 32px;
        border-radius: 2px;
        flex-shrink: 0;
      }

      .lifecycle-linked-info {
        flex: 1;
        min-width: 0;
      }

      .lifecycle-linked-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lifecycle-linked-subtitle {
        font-size: 11px;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lifecycle-relation-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 8px;
        background: var(--surface-100);
        color: var(--text-secondary);
        border-radius: 10px;
        white-space: nowrap;
      }

      .lifecycle-remove-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
      }

      .lifecycle-linked-item-compact:hover .lifecycle-remove-btn {
        opacity: 1;
      }

      .lifecycle-remove-btn:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lifecycle-remove-btn i {
        font-size: 12px;
      }

      /* Alerts - Matching award-review-dashboard */
      .info-alert {
        padding: var(--spacing-md);
        background: var(--info-50);
        border-left: 4px solid var(--info-400);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
      }

      .info-alert-text {
        font-size: 14px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .info-alert-text strong {
        color: var(--text-primary);
      }

      /* Action Footer */
      .action-footer {
        background: white;
        border-top: 1px solid var(--surface-200);
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .footer-info {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .footer-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      /* Tabs - Matching award-review-dashboard */
      .tabs {
        display: flex;
        gap: var(--spacing-xs);
        border-bottom: 2px solid var(--surface-200);
        margin-bottom: var(--spacing-lg);
      }

      .tab {
        padding: var(--spacing-sm) var(--spacing-lg);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }

      .tab:hover {
        color: var(--primary-500);
      }

      .tab.active {
        color: var(--primary-500);
        border-bottom-color: var(--primary-500);
      }

      /* Data Table - Matching award-review-dashboard */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
        padding: var(--spacing-sm) var(--spacing-md);
        text-align: left;
        border-bottom: 1px solid var(--surface-200);
      }

      .data-table th {
        background: var(--surface-50);
        font-weight: 600;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .data-table tr:hover td {
        background: var(--surface-50);
      }

      /* Scrollbar Styling */
      .content-area::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .content-area::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .content-area::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .content-area::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      /* Block Nav Scrollbar - More subtle */
      .block-nav::-webkit-scrollbar {
        height: 4px;
      }

      .block-nav::-webkit-scrollbar-track {
        background: transparent;
      }

      .block-nav::-webkit-scrollbar-thumb {
        background: var(--primary-200);
        border-radius: 2px;
      }

      .block-nav::-webkit-scrollbar-thumb:hover {
        background: var(--primary-400);
      }

      .hidden {
        display: none;
      }

      /* Requisition & Lots Styles */
      .requisition-section,
      .lots-section,
      .structure-summary {
        margin-bottom: var(--spacing-2xl);
      }

      .section-subheader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .section-subheader h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .badge {
        padding: 4px 12px;
        background: var(--primary-50);
        color: var(--primary-500);
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      /* Requisition Table */
      .requisition-table-container {
        overflow-x: auto;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
      }

      .requisition-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface-0);
      }

      .requisition-table thead {
        background: var(--surface-50);
        border-bottom: 2px solid var(--surface-200);
      }

      .requisition-table th {
        padding: var(--spacing-md);
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .requisition-table td {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        font-size: 14px;
      }

      .requisition-table tbody tr:hover {
        background: var(--surface-50);
      }

      .unspsc-code {
        font-weight: 600;
        color: var(--primary-500);
        font-family: 'Courier New', monospace;
      }

      .unspsc-desc {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .status-badge.assigned {
        background: var(--success-50);
        color: var(--success-500);
      }

      .status-badge.unassigned {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .match-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: var(--success-50);
        color: var(--success-500);
      }

      .match-badge.new {
        background: var(--info-50);
        color: var(--info-400);
      }

      .quantity-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: var(--primary-50);
        color: var(--primary-600);
      }

      /* Lots */
      .lots-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      .lot-card {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        overflow: hidden;
      }

      .lot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lot-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .lot-number {
        padding: 4px 10px;
        background: var(--primary-400);
        color: white;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 600;
      }

      .lot-name-input {
        flex: 1;
        padding: 6px 12px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 600;
        font-family: inherit;
        background: var(--surface-0);
        color: var(--text-primary);
        min-width: 200px;
      }

      .lot-name-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .lot-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .btn-icon {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .btn-icon:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
      }

      .btn-icon.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-500);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        height: auto;
      }

      .lot-body {
        padding: var(--spacing-lg);
      }

      .lot-lines-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lot-lines-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .lot-line-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .lot-line-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-400);
        min-width: 100px;
      }

      .lot-line-desc {
        flex: 1;
        font-size: 14px;
        color: var(--text-primary);
      }

      .lot-line-qty {
        font-size: 13px;
        color: var(--text-secondary);
        min-width: 80px;
      }

      .btn-icon-sm {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-muted);
        transition: all 0.2s ease;
        border-radius: var(--radius-sm);
      }

      .btn-icon-sm:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-empty {
        padding: var(--spacing-lg);
        text-align: center;
        color: var(--text-muted);
        font-size: 14px;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      /* Empty State */
      .empty-state {
        padding: var(--spacing-2xl);
        text-align: center;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
      }

      .empty-state-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .empty-state-hint {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-lg);
      }

      /* Product Requirements & Specifications Styles */
      .product-requirements-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-2xl);
      }

      .product-requirement-card {
        background: var(--surface-white);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .product-requirement-header {
        background: var(--surface-50);
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--surface-300);
      }

      .product-requirement-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex-wrap: wrap;
      }

      .unspsc-code-large {
        font-family: 'Courier New', monospace;
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 4px 12px;
        border-radius: var(--radius-sm);
      }

      .unspsc-description-large {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }

      .product-requirement-body {
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-2xl);
      }

      .requirement-section,
      .supplier-section {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .requirement-section {
        border: 2px solid var(--primary-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        background: var(--primary-25);
      }

      .supplier-section {
        border: 2px solid var(--teal-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        background: var(--teal-25);
      }

      .requirement-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .requirement-section-header h4 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .requirement-empty {
        text-align: center;
        padding: var(--spacing-xl);
        background: var(--surface-white);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      .requirement-empty p {
        margin: 0 0 var(--spacing-md) 0;
        color: var(--text-muted);
        font-size: 14px;
      }

      .requirement-empty .or-text {
        display: block;
        margin: var(--spacing-sm) 0;
        color: var(--text-muted);
        font-size: 12px;
      }

      .requirement-attributes-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .requirement-attribute-item {
        background: var(--surface-white);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
      }

      .supplier-field {
        background: var(--teal-50);
        border-color: var(--teal-200);
      }

      .attribute-row {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
      }

      .attribute-name {
        flex: 1;
        min-width: 0;
      }

      .attribute-value {
        flex: 1.5;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .attribute-name-input,
      .attribute-value-input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-sm);
        font-size: 14px;
        color: var(--text-primary);
        background: var(--surface-white);
      }

      .attribute-name-input {
        font-weight: 600;
      }

      .attribute-name-input:focus,
      .attribute-value-input:focus {
        outline: none;
        border-color: var(--primary-500);
      }

      .field-hint {
        font-size: 11px;
        color: var(--text-muted);
        font-style: italic;
      }

      .btn-icon-sm {
        width: 28px;
        height: 28px;
        padding: 0;
        border: 1px solid var(--surface-300);
        background: var(--surface-white);
        color: var(--text-muted);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .btn-icon-sm:hover {
        background: var(--danger-50);
        border-color: var(--danger-300);
        color: var(--danger-600);
      }

      /* Mandatory Toggle Switch */
      .mandatory-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
      }

      .mandatory-toggle-switch {
        position: relative;
        width: 36px;
        height: 20px;
        background: var(--surface-300);
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .mandatory-toggle-switch.active {
        background: var(--primary-500);
      }

      .mandatory-toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      }

      .mandatory-toggle-switch.active::after {
        transform: translateX(16px);
      }

      .mandatory-toggle-label {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-secondary);
        min-width: 60px;
      }

      .mandatory-toggle-label.mandatory {
        color: var(--primary-600);
      }

      .mandatory-toggle-label.optional {
        color: var(--text-muted);
      }

      .requirement-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
      }

      /* Structure Summary */
      .summary-card {
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: var(--spacing-lg);
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--surface-200);
      }

      .summary-item:last-child {
        border-bottom: none;
      }

      .summary-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .summary-value {
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 600;
      }

      /* ===== REQUISITION & LOTS IMPROVED UI ===== */
      
      /* General Info Container for Requisition & Lots */
      .general-info-container {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
      }

      .general-info-body {
        padding: var(--spacing-lg);
      }

      .form-info-card {
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        font-size: 13px;
        color: var(--text-secondary);
      }

      .form-info-card p {
        margin: 0;
      }

      /* 3-Column Form Grid */
      .form-grid-3col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
      }

      .form-grid-3col .form-group.full-width {
        grid-column: 1 / -1;
      }

      @media (max-width: 1200px) {
        .form-grid-3col {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .form-grid-3col {
          grid-template-columns: 1fr;
        }
      }

      /* Summary Stats Row */
      .summary-stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
      }

      .stat-item {
        text-align: center;
        padding: var(--spacing-sm);
      }

      .stat-value {
        font-size: 22px;
        font-weight: 700;
        color: var(--primary-600);
        line-height: 1.2;
      }

      .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-top: 2px;
      }

      /* Collapsible Sections */
      .collapsible-section {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
        overflow: hidden;
      }

      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        cursor: pointer;
        transition: background 0.2s ease;
        user-select: none;
      }

      .collapsible-header:hover {
        background: var(--surface-100);
      }

      .collapsible-header-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .collapsible-header-icon {
        width: 26px;
        height: 26px;
        background: var(--primary-100);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
      }

      .collapsible-header-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .collapsible-toggle {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 10px;
        transition: transform 0.2s ease;
      }

      .collapsible-section.collapsed .collapsible-toggle {
        transform: rotate(-90deg);
      }

      .collapsible-body {
        padding: var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        display: block;
      }

      .collapsible-section.collapsed .collapsible-body {
        display: none;
      }

      /* Compact Requisition Table */
      .req-table-compact {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }

      .req-table-compact th {
        background: var(--surface-100);
        padding: 6px 8px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 1px solid var(--surface-200);
      }

      .req-table-compact td {
        padding: 6px 8px;
        border-bottom: 1px solid var(--surface-100);
        color: var(--text-primary);
        vertical-align: middle;
      }

      .req-table-compact tbody tr:hover {
        background: var(--surface-50);
      }

      .req-table-compact tbody tr:last-child td {
        border-bottom: none;
      }

      /* Standard Requisition Table (larger) */
      .req-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .req-table th {
        background: var(--surface-100);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 2px solid var(--surface-200);
      }

      .req-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--surface-100);
        color: var(--text-primary);
        vertical-align: middle;
        font-size: 13px;
      }

      .req-table tbody tr:hover {
        background: var(--surface-50);
      }

      .req-table tbody tr:last-child td {
        border-bottom: none;
      }

      .req-table .req-id {
        font-weight: 600;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .req-table .req-unspsc {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        color: var(--primary-600);
        font-weight: 600;
      }

      .req-table .req-unspsc-desc {
        font-size: 12px;
        color: var(--text-muted);
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .req-table .req-amount {
        font-weight: 600;
        color: var(--success-600);
        font-size: 13px;
      }

      /* Remove button for requisition lines */
      .req-remove-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
        opacity: 0.6;
      }

      .req-remove-btn:hover {
        background: var(--danger-50);
        opacity: 1;
      }

      .req-id {
        font-weight: 600;
        font-size: 10px;
        color: var(--text-secondary);
      }

      .req-unspsc {
        font-family: 'Courier New', monospace;
        font-size: 11px;
        color: var(--primary-600);
        font-weight: 600;
      }

      .req-unspsc-desc {
        font-size: 10px;
        color: var(--text-muted);
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .req-amount {
        font-weight: 600;
        color: var(--success-600);
        font-size: 11px;
        white-space: nowrap;
      }

      /* Compact Lots Grid */
      .lots-grid-compact {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
      }

      .lot-card-compact {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: all 0.2s ease;
      }

      .lot-card-compact:hover {
        border-color: var(--primary-300);
        box-shadow: var(--shadow-sm);
      }

      .lot-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px var(--spacing-sm);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lot-badge {
        background: var(--primary-500);
        color: white;
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        font-size: 9px;
        font-weight: 600;
      }

      .lot-name-input-compact {
        flex: 1;
        margin-left: var(--spacing-xs);
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        border: none;
        background: transparent;
        padding: 3px;
        border-radius: var(--radius-sm);
        min-width: 80px;
      }

      .lot-name-input-compact:focus {
        outline: none;
        background: var(--surface-0);
        box-shadow: 0 0 0 2px var(--primary-200);
      }

      .lot-actions-compact {
        display: flex;
        gap: 2px;
      }

      .lot-action-btn {
        width: 22px;
        height: 22px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: var(--text-muted);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
      }

      .lot-action-btn:hover {
        background: var(--surface-200);
        color: var(--text-primary);
      }

      .lot-action-btn.danger:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-body-compact {
        padding: var(--spacing-xs) var(--spacing-sm);
        max-height: 140px;
        overflow-y: auto;
      }

      .lot-products-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-xs);
        padding-bottom: var(--spacing-xs);
        border-bottom: 1px dashed var(--surface-200);
      }

      .add-product-btn {
        font-size: 9px;
        color: var(--primary-500);
        cursor: pointer;
        font-weight: 600;
        padding: 1px 5px;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
        border: none;
      }

      .add-product-btn:hover {
        background: var(--primary-100);
      }

      .lot-product-compact {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: 3px 0;
        font-size: 10px;
      }

      .lot-product-code {
        font-family: 'Courier New', monospace;
        color: var(--primary-600);
        font-weight: 600;
        font-size: 9px;
        min-width: 60px;
      }

      .lot-product-name {
        flex: 1;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lot-product-qty {
        font-size: 9px;
        color: var(--text-muted);
        background: var(--surface-100);
        padding: 0px 4px;
        border-radius: 6px;
      }

      .lot-product-remove {
        width: 16px;
        height: 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        opacity: 0;
        transition: all 0.2s ease;
      }

      .lot-product-compact:hover .lot-product-remove {
        opacity: 1;
      }

      .lot-product-remove:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-empty-state {
        text-align: center;
        padding: var(--spacing-sm);
        color: var(--text-muted);
        font-size: 10px;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      /* Create Lot Card */
      .create-lot-card {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-lg);
        border: 2px dashed var(--surface-300);
        background: var(--surface-50);
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 80px;
      }

      .create-lot-card:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        color: var(--primary-600);
      }

      /* Lots Table Styles */
      .lots-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        background: var(--surface-0);
      }

      .lots-table thead th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 2px solid var(--surface-200);
        background: var(--surface-50);
      }

      .lots-table tbody td {
        padding: 16px;
        border-bottom: 1px solid var(--surface-100);
        vertical-align: top;
        font-size: 13px;
      }

      .lots-table tbody tr:hover {
        background: var(--surface-50);
      }

      .lot-number-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: var(--primary-100);
        color: var(--primary-700);
        border-radius: 50%;
        font-weight: 700;
        font-size: 14px;
      }

      .lot-name-cell {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
      }

      .lot-desc-cell {
        color: var(--text-secondary);
        font-size: 13px;
        display: block;
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lot-products-cell {
        min-width: 250px;
      }

      .no-products-text {
        color: var(--text-muted);
        font-style: italic;
        font-size: 12px;
      }

      .product-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .product-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--surface-100);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 12px;
        transition: all 0.15s ease;
      }

      .product-tag:hover {
        background: var(--surface-50);
        border-color: var(--surface-300);
      }

      .product-tag-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
      }

      .product-tag-name {
        color: var(--text-secondary);
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 12px;
      }

      .product-tag-qty {
        color: var(--text-muted);
        font-weight: 500;
        font-size: 12px;
      }

      .product-tag-value {
        color: var(--success-600);
        font-weight: 600;
        font-size: 12px;
      }

      .product-tag-remove {
        width: 18px;
        height: 18px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        opacity: 0.6;
        transition: all 0.15s ease;
        margin-left: 2px;
      }

      .product-tag:hover .product-tag-remove {
        opacity: 1;
      }

      .product-tag-remove:hover {
        background: var(--danger-100);
        color: var(--danger-600);
      }

      /* Lot Actions Menu */
      .lot-actions-menu-wrapper {
        position: relative;
        display: inline-block;
      }

      .lot-actions-btn {
        width: 28px;
        height: 28px;
        border: 1px solid var(--surface-200);
        background: var(--surface-100);
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
      }

      .lot-actions-btn:hover {
        background: var(--surface-200);
        border-color: var(--surface-300);
        color: var(--text-primary);
      }

      .lot-actions-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        min-width: 150px;
        z-index: 100;
        overflow: hidden;
      }

      .lot-actions-dropdown.show {
        display: block;
      }

      .lot-action-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 8px 12px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        font-family: 'Lato', 'Noto Sans', system-ui, sans-serif;
        color: var(--text-primary);
        text-align: left;
        transition: all 0.15s ease;
      }

      .lot-action-item:hover {
        background: var(--surface-100);
        color: var(--primary-600);
      }

      .lot-action-item.danger {
        color: var(--text-secondary);
      }

      .lot-action-item.danger:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .lot-action-item i {
        font-size: 14px;
        width: 18px;
        text-align: center;
      }

      .lot-action-icon {
        display: none;
      }

      /* Add Product Modal Styles */
      .product-modal-tabs {
        display: flex;
        border-bottom: 1px solid var(--surface-200);
        margin-bottom: var(--spacing-md);
      }

      .product-modal-tab {
        padding: 10px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 12px;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        transition: all 0.15s ease;
      }

      .product-modal-tab:hover {
        color: var(--text-primary);
      }

      .product-modal-tab.active {
        color: var(--primary-600);
        border-bottom-color: var(--primary-500);
        font-weight: 600;
      }

      .product-modal-tab-content {
        display: none;
      }

      .product-modal-tab-content.active {
        display: block;
      }

      .req-line-option {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .req-line-option:hover {
        background: var(--surface-50);
        border-color: var(--primary-300);
      }

      .req-line-option.selected {
        background: var(--primary-50);
        border-color: var(--primary-400);
      }

      .req-line-option input[type="checkbox"] {
        margin-top: 2px;
      }

      .req-line-details {
        flex: 1;
      }

      .req-line-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
      }

      /* Compact Product Requirements Styles */
      .product-requirements-compact {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .product-req-item {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        overflow: hidden;
        transition: all 0.15s ease;
      }

      .product-req-item:hover {
        border-color: var(--surface-300);
      }

      .product-req-item.has-requirements {
        border-left: 3px solid var(--success-500);
      }

      .product-req-item.expanded {
        box-shadow: var(--shadow-sm);
      }

      .product-req-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        cursor: pointer;
        background: var(--surface-50);
        transition: background 0.15s ease;
      }

      .product-req-header:hover {
        background: var(--surface-100);
      }

      .product-req-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 0;
      }

      .product-req-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
        background: var(--primary-50);
        padding: 2px 8px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .product-req-desc {
        font-size: 13px;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .product-req-lot {
        font-size: 10px;
        color: var(--text-muted);
        background: var(--surface-100);
        padding: 2px 6px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .product-req-status {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      .status-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
      }

      .status-badge.status-complete {
        background: var(--success-100);
        color: var(--success-700);
      }

      .status-badge.status-pending {
        background: var(--surface-100);
        color: var(--text-muted);
      }

      .product-req-toggle {
        font-size: 10px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
      }

      .product-req-item.expanded .product-req-toggle {
        transform: rotate(180deg);
      }

      .product-req-body {
        padding: 14px;
        border-top: 1px solid var(--surface-200);
        background: var(--surface-0);
      }

      /* Requirement Type Selector */
      .req-type-selector {
        text-align: center;
        padding: var(--spacing-sm);
      }

      .req-type-btn {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 12px 20px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.15s ease;
        min-width: 100px;
      }

      .req-type-btn:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .req-type-icon {
        font-size: 20px;
      }

      .req-type-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .req-type-hint {
        font-size: 10px;
        color: var(--text-muted);
      }

      /* Full Rich Text Toolbar */
      .rich-text-toolbar-full {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 8px;
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        flex-wrap: wrap;
      }

      .toolbar-group {
        display: flex;
        gap: 2px;
      }

      .toolbar-sep {
        width: 1px;
        height: 20px;
        background: var(--surface-300);
        margin: 0 4px;
      }

      .tb-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .tb-btn:hover {
        background: var(--surface-200);
        color: var(--text-primary);
      }

      .tb-btn:active {
        background: var(--primary-100);
        color: var(--primary-600);
      }

      .rich-text-editor-full {
        min-height: 120px;
        padding: 12px;
        border: 1px solid var(--surface-200);
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        font-size: 13px;
        line-height: 1.6;
        outline: none;
        background: var(--surface-0);
      }

      .rich-text-editor-full:focus {
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .rich-text-editor-full:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
      }

      /* Rich Text Content Box */
      .rich-text-content {
        outline: none;
        background: var(--surface-0);
      }

      .rich-text-content:focus {
        background: var(--surface-0);
      }

      .rich-text-content:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
        font-style: italic;
      }

      .rich-text-box:focus-within {
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      /* Team UI Styles */
      .team-section-content {
        padding: var(--spacing-sm) 0;
      }

      .team-member-card {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-xs);
      }

      .team-member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
      }

      .team-member-info {
        flex: 1;
        min-width: 0;
      }

      .team-member-name {
        font-weight: 600;
        font-size: 13px;
        color: var(--text-primary);
      }

      .team-member-email {
        font-size: 11px;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .team-member-role {
        font-size: 11px;
        color: var(--text-secondary);
        background: var(--surface-100);
        padding: 2px 8px;
        border-radius: 12px;
        white-space: nowrap;
      }

      .team-member-remove {
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 18px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .team-member-remove:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      /* Affidavit Status Styles */
      .affidavit-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }
      .affidavit-status-badge.complete {
        background: var(--success-100);
        color: var(--success-700);
      }
      .affidavit-status-badge.partial {
        background: var(--warning-100);
        color: var(--warning-700);
      }
      
      /* Evaluation Panel Status Badges */
      .eval-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        white-space: nowrap;
      }
      .eval-status-badge i {
        font-size: 10px;
      }
      .eval-status-badge.established {
        background: var(--info-100);
        color: var(--info-700);
      }
      .eval-status-badge.approved {
        background: var(--success-100);
        color: var(--success-700);
      }
      .eval-status-badge.signed {
        background: var(--success-100);
        color: var(--success-700);
      }
      .eval-status-badge.pending {
        background: var(--warning-100);
        color: var(--warning-700);
      }
      .affidavit-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        margin-left: 8px;
      }
      .affidavit-badge.signed {
        background: var(--success-100);
        color: var(--success-700);
      }
      .affidavit-badge.signed:hover {
        background: var(--success-200);
      }
      .affidavit-badge.pending {
        background: var(--warning-100);
        color: var(--warning-700);
      }
      .affidavit-badge.pending:hover {
        background: var(--warning-200);
      }

      /* Searchable UNSPSC Dropdown */
      .unspsc-search-container {
        position: relative;
      }
      .unspsc-search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-sm);
        font-size: 13px;
        box-sizing: border-box;
      }
      .unspsc-search-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }
      .unspsc-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid var(--surface-300);
        border-top: none;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        display: none;
      }
      .unspsc-dropdown.show {
        display: block;
      }
      .unspsc-option {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid var(--surface-100);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .unspsc-option:last-child {
        border-bottom: none;
      }
      .unspsc-option:hover {
        background: var(--primary-50);
      }
      .unspsc-option.selected {
        background: var(--primary-100);
      }
      .unspsc-option-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-600);
        font-size: 12px;
        min-width: 75px;
      }
      .unspsc-option-desc {
        color: var(--text-secondary);
        font-size: 12px;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .unspsc-no-results {
        padding: 12px;
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
      }
      .unspsc-info-message {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 10px 12px;
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-radius: var(--radius-sm);
        margin-top: 8px;
        font-size: 11px;
        color: var(--info-700);
        line-height: 1.4;
      }
      .unspsc-info-message i {
        color: var(--info-500);
        font-size: 14px;
        margin-top: 1px;
      }
      
      /* UNSPSC Category Badges */
      .unspsc-category-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 3px;
        text-transform: uppercase;
        white-space: nowrap;
        margin-left: auto;
      }
      .unspsc-category-badge.category-2 {
        background: var(--warning-100);
        color: var(--warning-700);
        border: 1px solid var(--warning-300);
      }
      .unspsc-category-badge.category-3 {
        background: var(--danger-100);
        color: var(--danger-700);
        border: 1px solid var(--danger-300);
      }
      
      /* Category Warning Indicators */
      .category-warning {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        margin-top: 8px;
        margin-bottom: 4px;
      }
      .category-warning.category-2 {
        background: var(--warning-50);
        border: 1px solid var(--warning-300);
        border-left: 4px solid var(--warning-500);
      }
      .category-warning.category-3 {
        background: var(--danger-50);
        border: 1px solid var(--danger-300);
        border-left: 4px solid var(--danger-500);
      }
      .category-warning .category-icon {
        font-size: 18px;
        flex-shrink: 0;
      }
      .category-warning .category-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .category-warning .category-text strong {
        font-size: 13px;
      }
      .category-warning.category-2 .category-text strong {
        color: var(--warning-700);
      }
      .category-warning.category-3 .category-text strong {
        color: var(--danger-700);
      }
      .category-warning .category-text span {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .team-subsection {
        margin-bottom: var(--spacing-md);
      }

      .team-subsection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm);
      }

      .team-subsection-title {
        font-weight: 600;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .team-members-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .team-empty-slot {
        padding: var(--spacing-md);
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
        background: var(--surface-50);
        border: 1px dashed var(--surface-300);
        border-radius: var(--radius-md);
      }

      /* Evaluation Panel Table Styles */
      .eval-panel-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
      }

      .eval-panel-table thead {
        background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%);
      }

      .eval-panel-table th {
        padding: 12px 16px;
        text-align: left;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--surface-200);
      }

      .eval-panel-table th:first-child {
        padding-left: 20px;
      }

      .eval-panel-table td {
        padding: 14px 16px;
        font-size: 13px;
        color: var(--text-primary);
        border-bottom: 1px solid var(--surface-100);
        vertical-align: middle;
      }

      .eval-panel-table td:first-child {
        padding-left: 20px;
      }

      .eval-panel-table tbody tr {
        transition: background-color 0.15s ease;
      }

      .eval-panel-table tbody tr:hover {
        background: var(--surface-50);
      }

      .eval-panel-table tbody tr:last-child td {
        border-bottom: none;
      }

      .eval-panel-role-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
      }

      .eval-panel-role-badge i {
        font-size: 12px;
      }

      .eval-panel-role-badge.procurement-official {
        background: var(--primary-50);
        color: var(--primary-700);
        border: 1px solid var(--primary-200);
      }

      .eval-panel-role-badge.chair {
        background: var(--primary-100);
        color: var(--primary-800);
        border: 1px solid var(--primary-300);
      }

      .eval-panel-role-badge.team-member {
        background: var(--surface-100);
        color: var(--text-primary);
        border: 1px solid var(--surface-200);
      }

      .eval-panel-role-badge.observer {
        background: var(--surface-50);
        color: var(--text-secondary);
        border: 1px solid var(--surface-200);
      }

      .eval-panel-member-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .eval-panel-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .eval-panel-member-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .eval-panel-member-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 13px;
      }

      .eval-panel-member-email {
        font-size: 11px;
        color: var(--text-muted);
      }

      .eval-panel-approved-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
      }

      .eval-panel-approved-badge i {
        font-size: 10px;
      }

      .eval-panel-approved-badge.approved {
        background: var(--success-50);
        color: var(--success-700);
        border: 1px solid var(--success-200);
      }

      .eval-panel-approved-badge.pending {
        background: var(--surface-100);
        color: var(--text-secondary);
        border: 1px solid var(--surface-200);
      }

      .eval-panel-affidavit-cell {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .eval-panel-affidavit-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .eval-panel-affidavit-badge i {
        font-size: 11px;
      }

      .eval-panel-affidavit-badge.signed {
        background: var(--success-50);
        color: var(--success-700);
        border: 1px solid var(--success-200);
      }

      .eval-panel-affidavit-badge.signed:hover {
        background: var(--success-100);
      }

      .eval-panel-affidavit-badge.pending-sign {
        background: var(--primary-50);
        color: var(--primary-700);
        border: 1px solid var(--primary-200);
      }

      .eval-panel-affidavit-badge.pending-sign:hover {
        background: var(--primary-100);
      }

      .eval-panel-actions {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .eval-panel-action-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .eval-panel-action-btn:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .eval-panel-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
      }

      .eval-panel-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
        color: var(--text-muted);
      }

      .eval-panel-empty-icon i {
        font-size: inherit;
      }

      .eval-panel-empty-text {
        font-size: 14px;
        margin-bottom: 16px;
      }

      .team-roles-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
      }

      .team-role-card {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
      }

      .team-role-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--surface-100);
      }

      .team-role-icon {
        font-size: 20px;
        color: var(--primary-600);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .team-role-icon i {
        font-size: inherit;
      }

      .team-role-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
      }

      .team-role-content {
        min-height: 60px;
      }

      .team-add-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .team-add-placeholder:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        color: var(--primary-600);
      }

      .team-add-placeholder i {
        font-size: 16px;
      }

      /* Compact Rich Text Editor */
      .rich-text-toolbar-compact {
        display: flex;
        gap: 2px;
        padding: 4px;
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-bottom: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      }

      .rich-text-editor-compact {
        min-height: 80px;
        padding: 10px;
        border: 1px solid var(--surface-200);
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        font-size: 13px;
        line-height: 1.5;
        outline: none;
      }

      .rich-text-editor-compact:focus {
        border-color: var(--primary-400);
      }

      .rich-text-editor-compact:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
      }

      /* Compact Attributes */
      .req-attributes-compact {
        padding: var(--spacing-xs);
      }

      .attributes-grid {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .attr-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .attr-input {
        padding: 6px 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 12px;
        outline: none;
        transition: border-color 0.15s ease;
      }

      .attr-input:focus {
        border-color: var(--primary-400);
      }

      .attr-name {
        flex: 1;
      }

      .attr-value {
        flex: 1.5;
      }

      .attr-remove {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 14px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .attr-remove:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .req-actions-row {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--surface-100);
      }

      /* Other Requirements Subsections */
      .other-req-subsection {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        overflow: hidden;
      }

      .subsection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .subsection-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .subsection-body {
        padding: 14px;
      }

      .service-line-compact {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .req-line-desc {
        color: var(--text-secondary);
        font-size: 11px;
        margin-top: 2px;
      }

      .new-product-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .new-product-form .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
      }

      /* Requisition Line Modal */
      .req-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1002;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(2px);
      }

      .req-modal-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 550px;
        width: 95%;
        max-height: 75vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .req-modal-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-50);
      }

      .req-modal-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .req-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-sm);
      }

      .req-option {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-xs);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
      }

      .req-option:hover {
        background: var(--primary-50);
        border-color: var(--primary-300);
      }

      .req-option.selected {
        background: var(--primary-50);
        border-color: var(--primary-500);
      }

      .req-option-checkbox {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .req-option-details {
        flex: 1;
        min-width: 0;
      }

      .req-option-main {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 12px;
      }

      .req-option-sub {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 1px;
      }

      .req-modal-footer {
        padding: var(--spacing-sm) var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        background: var(--surface-50);
      }

      /* Submission Form Card Enhanced Styles */
      .submission-form-card-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
        flex-wrap: wrap;
      }

      .submission-form-code {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 2px 8px;
        border-radius: var(--radius-sm);
      }

      .submission-form-badge {
        font-size: 9px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .submission-form-actions {
        margin-left: auto;
        display: flex;
        gap: 4px;
      }

      .btn-icon-xs.preview {
        color: var(--primary-600);
        border-color: var(--primary-300);
      }

      .btn-icon-xs.preview:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
      }

      .btn-icon-xs.configure {
        color: var(--warning-600);
        border-color: var(--warning-300);
      }

      .btn-icon-xs.configure:hover {
        background: var(--warning-50);
        border-color: var(--warning-400);
      }

      /* Tender Attachments Section */
      .submission-attachments-section {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--surface-200);
      }

      .submission-attachments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .submission-attachments-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .submission-attachments-title i {
        color: var(--primary-500);
      }

      .submission-attachments-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
      }

      .tender-attachment-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 12px;
      }

      .tender-attachment-item-icon {
        font-size: 16px;
      }

      .tender-attachment-item-name {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-primary);
      }

      .tender-attachment-item-size {
        font-size: 10px;
        color: var(--text-muted);
      }

      .tender-attachment-item-remove {
        background: none;
        border: none;
        padding: 2px;
        cursor: pointer;
        color: var(--text-muted);
        border-radius: var(--radius-xs);
      }

      .tender-attachment-item-remove:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .submission-attachments-drop-zone {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-md);
        color: var(--text-muted);
        font-size: 13px;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .submission-attachments-drop-zone:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        color: var(--primary-600);
      }

      .submission-attachments-drop-zone.drag-over {
        border-color: var(--primary-500);
        background: var(--primary-100);
        border-style: solid;
      }

      .submission-attachments-drop-zone i {
        font-size: 18px;
      }

      .badge-mandatory {
        background: var(--danger-500);
        color: white;
      }

      .badge-optional {
        background: var(--info-400);
        color: white;
      }

      .badge-conditional {
        background: var(--warning-500);
        color: white;
      }

      /* Form Preview Modal */
      .form-preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        backdrop-filter: blur(4px);
      }

      .form-preview-modal.show {
        display: flex;
      }

      .form-preview-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        width: 95%;
        max-width: 1000px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .form-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        color: white;
      }

      .form-preview-header-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .form-preview-header-title h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
      }

      .form-preview-header-title .preview-badge {
        background: rgba(255,255,255,0.2);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .form-preview-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
        background: var(--surface-50);
      }

      .form-preview-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
        background: var(--surface-0);
      }

      /* Form Config Modal */
      .form-config-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        backdrop-filter: blur(4px);
      }

      .form-config-modal.show {
        display: flex;
      }

      .form-config-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        width: 95%;
        max-width: 700px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .form-config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
        color: white;
      }

      .form-config-header h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .form-config-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .form-config-section {
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-md);
        border: 1px solid var(--surface-200);
      }

      .form-config-section h4 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 var(--spacing-md) 0;
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--surface-200);
      }

      .form-config-option {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-xs) 0;
      }

      .form-config-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary-500);
        cursor: pointer;
      }

      .form-config-option label {
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
      }

      .form-config-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
        background: var(--surface-50);
      }

      /* Form Attachment Modal */
      .form-attachment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        backdrop-filter: blur(4px);
      }

      .form-attachment-modal.show {
        display: flex;
      }

      .form-attachment-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        width: 95%;
        max-width: 550px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .form-attachment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
        color: white;
      }

      .form-attachment-header h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .form-attachment-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .attachment-drop-zone {
        border: 2px dashed var(--primary-400);
        border-radius: var(--radius-md);
        padding: var(--spacing-xl);
        text-align: center;
        background: var(--primary-50);
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: var(--spacing-lg);
      }

      .attachment-drop-zone:hover {
        background: var(--primary-100);
        border-color: var(--primary-500);
      }

      .attachment-drop-zone.drag-over {
        background: var(--primary-100);
        border-color: var(--primary-600);
        border-style: solid;
      }

      .attachment-drop-zone-icon {
        font-size: 40px;
        margin-bottom: var(--spacing-sm);
      }

      .attachment-drop-zone-text {
        font-size: 14px;
        font-weight: 500;
        color: var(--primary-600);
        margin-bottom: var(--spacing-xs);
      }

      .attachment-drop-zone-hint {
        font-size: 12px;
        color: var(--text-muted);
      }

      .attachment-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .attachment-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
      }

      .attachment-item-icon {
        font-size: 20px;
      }

      .attachment-item-info {
        flex: 1;
        min-width: 0;
      }

      .attachment-item-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .attachment-item-size {
        font-size: 11px;
        color: var(--text-muted);
      }

      .attachment-item-remove {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .attachment-item-remove:hover {
        background: var(--danger-50);
        color: var(--danger-600);
      }

      .form-attachment-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-sm);
        padding: var(--spacing-md) var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
        background: var(--surface-50);
      }

      /* Supplier Form Preview Styles */
      .supplier-form-preview {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        border: 1px solid var(--surface-200);
      }

      .supplier-form-section {
        margin-bottom: var(--spacing-lg);
      }

      .supplier-form-section-header {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        color: white;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        font-weight: 600;
        font-size: 15px;
      }

      .supplier-form-section-body {
        padding: var(--spacing-lg);
        border: 1px solid var(--surface-200);
        border-top: none;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        background: var(--surface-0);
      }

      .supplier-form-note {
        background: var(--warning-50);
        border-left: 4px solid var(--warning-500);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        font-size: 13px;
        border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      }

      .supplier-form-note.info {
        background: var(--info-50);
        border-left-color: var(--info-500);
      }

      .supplier-form-field {
        margin-bottom: var(--spacing-md);
      }

      .supplier-form-field label {
        display: block;
        font-weight: 600;
        font-size: 13px;
        margin-bottom: var(--spacing-xs);
        color: var(--text-primary);
      }

      .supplier-form-field input,
      .supplier-form-field textarea,
      .supplier-form-field select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-family: inherit;
      }

      .supplier-form-field input:disabled,
      .supplier-form-field textarea:disabled {
        background: var(--surface-100);
        color: var(--text-muted);
      }

      .supplier-form-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        margin: var(--spacing-md) 0;
      }

      .supplier-form-table th {
        background: var(--primary-600);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border: 1px solid var(--primary-700);
      }

      .supplier-form-table td {
        padding: 12px;
        border: 1px solid var(--surface-200);
        vertical-align: middle;
      }

      .supplier-form-table tr:nth-child(even) td {
        background: var(--surface-50);
      }

      .prefilled-field {
        background: var(--info-50) !important;
        border: 2px solid var(--info-300) !important;
        font-weight: 600;
      }

      /* Country Multiselect Dropdown Styles */
      .country-multiselect-container {
        position: relative;
        width: 100%;
      }

      .country-multiselect-input {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 42px;
        padding: 8px 12px;
        background: var(--surface-0);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      .country-multiselect-input:hover {
        border-color: var(--primary-400);
      }

      .country-multiselect-input:focus-within {
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .country-multiselect-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        flex: 1;
      }

      .country-placeholder {
        color: var(--text-muted);
        font-size: 13px;
      }

      .country-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: var(--primary-100);
        color: var(--primary-700);
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .country-tag-remove {
        background: none;
        border: none;
        color: var(--primary-600);
        cursor: pointer;
        padding: 0;
        font-size: 14px;
        line-height: 1;
        margin-left: 2px;
      }

      .country-tag-remove:hover {
        color: var(--danger-500);
      }

      .country-multiselect-arrow {
        color: var(--text-muted);
        font-size: 10px;
        margin-left: 8px;
        transition: transform 0.2s ease;
      }

      .country-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 4px;
        background: var(--surface-0);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        max-height: 350px;
        display: flex;
        flex-direction: column;
      }

      .country-dropdown-search {
        padding: 10px;
        border-bottom: 1px solid var(--surface-200);
      }

      .country-dropdown-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-sm);
        font-size: 13px;
      }

      .country-dropdown-search input:focus {
        outline: none;
        border-color: var(--primary-400);
      }

      .country-dropdown-list {
        flex: 1;
        overflow-y: auto;
        max-height: 220px;
        padding: 6px 0;
      }

      .country-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 14px;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.1s ease;
      }

      .country-option:hover {
        background: var(--surface-100);
      }

      .country-option.selected {
        background: var(--primary-50);
      }

      .country-option input[type="checkbox"] {
        cursor: pointer;
        width: 16px;
        height: 16px;
        accent-color: var(--primary-500);
      }

      .country-dropdown-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-top: 1px solid var(--surface-200);
        background: var(--surface-50);
      }

      /* ===== CRITERIA LIBRARY MODAL STYLES ===== */
      .criteria-library-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1100;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .criteria-library-content {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 900px;
        width: 95%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .criteria-library-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: white;
      }

      .criteria-library-header-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .criteria-library-title {
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .criteria-library-subtitle {
        font-size: 13px;
        opacity: 0.9;
      }

      .criteria-library-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .criteria-library-search-section {
        margin-bottom: var(--spacing-lg);
      }

      .criteria-library-search-row {
        display: flex;
        gap: var(--spacing-sm);
        align-items: flex-end;
      }

      .criteria-library-search-field {
        flex: 1;
      }

      .criteria-library-search-field label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .criteria-library-search-input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .criteria-library-search-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .criteria-library-search-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        background: var(--primary-500);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .criteria-library-search-btn:hover {
        background: var(--primary-600);
      }

      .criteria-library-results {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .criteria-library-result-card {
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        cursor: pointer;
        transition: all 0.2s;
      }

      .criteria-library-result-card:hover {
        border-color: var(--primary-400);
        box-shadow: 0 2px 8px rgba(0, 146, 209, 0.15);
        transform: translateX(4px);
      }

      .criteria-library-result-card.selected {
        border-color: var(--primary-500);
        background: var(--primary-50);
      }

      .criteria-result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-sm);
      }

      .criteria-result-tender-info {
        flex: 1;
      }

      .criteria-result-tender-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .criteria-result-tender-ref {
        font-size: 12px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .criteria-result-type-badge {
        font-size: 10px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: var(--radius-sm);
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .criteria-result-type-badge.type-attributes {
        background: var(--info-50);
        color: var(--info-600);
      }

      .criteria-result-type-badge.type-description {
        background: var(--success-50);
        color: var(--success-600);
      }

      .criteria-result-type-badge.type-upload {
        background: var(--warning-50);
        color: var(--warning-600);
      }

      .criteria-result-content {
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
        border-top: 1px solid var(--surface-200);
      }

      .criteria-result-attributes {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .criteria-result-attr {
        font-size: 11px;
        background: white;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: 3px 8px;
        display: flex;
        gap: 4px;
      }

      .criteria-result-attr-name {
        font-weight: 600;
        color: var(--text-secondary);
      }

      .criteria-result-attr-value {
        color: var(--text-primary);
      }

      .criteria-result-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .criteria-result-upload {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .criteria-result-upload-icon {
        font-size: 18px;
      }

      .criteria-library-empty {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-muted);
      }

      .criteria-library-empty-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .criteria-library-empty-text {
        font-size: 14px;
        margin-bottom: 4px;
      }

      .criteria-library-empty-hint {
        font-size: 12px;
        color: var(--text-muted);
      }

      .criteria-library-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
        background: var(--surface-50);
      }

      .criteria-library-footer-info {
        font-size: 12px;
        color: var(--text-muted);
      }

      .criteria-library-footer-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      /* Menu Group Styles for Collapsible Sidebar */
      .menu-group {
        margin-bottom: var(--spacing-xs);
      }
      .menu-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 20px;
        font-size: 13px;
        font-weight: 600;
        color: rgba(255,255,255,0.7);
        cursor: pointer;
        transition: all 0.2s;
      }
      .menu-group-header:hover {
        color: white;
        background: rgba(255,255,255,0.05);
      }
      .menu-group-header i {
        font-size: 12px;
        transition: transform 0.2s;
      }
      .menu-group.collapsed .menu-group-header i.pi-chevron-down {
        transform: rotate(-90deg);
      }
      .menu-group.collapsed .menu-group-items {
        display: none;
      }
      .menu-group-items {
        padding-left: 12px;
      }
      .menu-group-items .menu-item {
        padding: 10px 20px 10px 28px;
        font-size: 13px;
        border-left: none;
      }
      .menu-group-items .menu-item.active {
        background: rgba(255,255,255,0.15);
        border-left: none;
        border-radius: 0 4px 4px 0;
        margin-right: 8px;
      }
      .menu-divider {
        height: 1px;
        background: rgba(255,255,255,0.15);
        margin: var(--spacing-md) 0;
      }

      /* Criterion Add Dropdown Styles */
      .criterion-add-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .criterion-add-dropdown .dropdown-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .criterion-add-dropdown .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 180px;
        z-index: 1000;
        display: none;
        overflow: hidden;
      }
      
      .criterion-add-dropdown.open .dropdown-menu {
        display: block;
      }
      
      .criterion-add-dropdown .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
        transition: background 0.15s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
      }
      
      .criterion-add-dropdown .dropdown-item:hover {
        background: var(--surface-50);
      }
      
      .criterion-add-dropdown .dropdown-item i {
        font-size: 14px;
        color: var(--text-muted);
      }
      
      .criterion-add-dropdown .dropdown-item:hover i {
        color: var(--primary-500);
      }
      
      .criterion-add-dropdown .dropdown-divider {
        height: 1px;
        background: var(--surface-200);
        margin: 0;
      }

      /* Criteria Library Modal Styles */
      .criteria-library-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 12px;
        max-height: 450px;
        overflow-y: auto;
        padding-right: 4px;
      }
      
      .criteria-library-item:hover {
        border-color: var(--primary-300) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }
      
      .criteria-library-item.selected:hover {
        border-color: var(--primary-600) !important;
      }
      
      .criteria-filter-btn {
        border: 1px solid var(--surface-300);
        background: var(--surface-0);
        color: var(--text-secondary);
        padding: 6px 12px;
        border-radius: var(--radius-sm);
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .criteria-filter-btn:hover {
        background: var(--surface-50);
        border-color: var(--surface-400);
      }
      
      .criteria-filter-btn.active {
        background: var(--primary-500);
        color: white;
        border-color: var(--primary-500);
      }
      
      .criteria-library-item {
        padding: var(--spacing-md);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        background: var(--surface-0);
        cursor: pointer;
        transition: all 0.15s ease;
      }
      
      .criteria-library-item:hover {
        border-color: var(--primary-300);
        background: var(--primary-50);
      }
      
      .criteria-library-item.selected {
        border-color: var(--primary-500);
        background: var(--primary-50);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      }
      
      .criteria-library-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }
      
      .criteria-library-item-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-primary);
      }
      
      .criteria-library-item-type {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        background: var(--surface-100);
        color: var(--text-secondary);
      }
      
      .criteria-library-item-description {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.4;
      }
      
      .criteria-library-item-meta {
        display: flex;
        gap: var(--spacing-md);
        margin-top: 8px;
        font-size: 11px;
        color: var(--text-muted);
      }
      
      .criteria-library-search {
        margin-bottom: var(--spacing-md);
      }
      
      .criteria-library-filters {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        flex-wrap: wrap;
      }
      
      .criteria-filter-btn {
        padding: 4px 12px;
        font-size: 12px;
        border: 1px solid var(--surface-200);
        border-radius: 16px;
        background: var(--surface-0);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
      }
      
      .criteria-filter-btn:hover {
        border-color: var(--primary-300);
        color: var(--primary-500);
      }
      
      .criteria-filter-btn.active {
        background: var(--primary-500);
        border-color: var(--primary-500);
        color: white;
      }

      /* ==================== TEAM COLLABORATION BOARD ==================== */
      .collab-board-btn {
        position: fixed;
        right: 0;
        top: 55%;
        transform: translateY(-50%);
        width: 60px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        padding: 12px 8px;
        cursor: pointer;
        z-index: 999;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        border: 2px solid #34d399;
        border-right: none;
      }

      .collab-board-btn:hover {
        width: 70px;
        box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
      }

      .collab-board-btn:focus {
        outline: 3px solid var(--warning-400);
        outline-offset: 2px;
      }

      .collab-board-btn-icon {
        width: 36px;
        height: 36px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }

      .collab-board-btn-icon i {
        font-size: 18px;
        color: #10b981;
      }

      .collab-board-btn-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--danger-500);
        color: white;
        font-size: 9px;
        font-weight: 700;
        min-width: 16px;
        height: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
      }

      .collab-board-btn-label {
        font-size: 9px;
        color: white;
        text-align: center;
        font-weight: 600;
        line-height: 1.2;
      }

      .collab-board-panel {
        position: fixed;
        right: -420px;
        top: 0;
        bottom: 0;
        width: 400px;
        background: var(--surface-0);
        box-shadow: var(--shadow-lg);
        z-index: 1002;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
      }

      .collab-board-panel.open {
        right: 0;
      }

      .collab-board-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .collab-board-tab {
        flex: 1;
        padding: 10px 8px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-size: 11px;
        color: var(--text-muted);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }

      .collab-board-tab:hover {
        background: var(--surface-50);
        color: var(--text-primary);
      }

      .collab-board-tab.active {
        color: #10b981;
        border-bottom-color: #10b981;
        font-weight: 600;
      }

      .collab-board-tab-badge {
        background: var(--danger-500);
        color: white;
        font-size: 9px;
        padding: 1px 5px;
        border-radius: 8px;
      }

      .collab-board-content {
        flex: 1;
        overflow-y: auto;
      }

      .collab-board-tab-content {
        display: none;
        padding: var(--spacing-md);
      }

      .collab-board-tab-content.active {
        display: block;
      }

      .collab-board-message-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .collab-board-message {
        display: flex;
        gap: var(--spacing-sm);
      }

      .collab-board-message.system-message {
        background: var(--surface-50);
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        font-size: 11px;
        color: var(--text-muted);
        align-items: center;
        gap: var(--spacing-sm);
      }

      .collab-board-message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        flex-shrink: 0;
      }

      .collab-board-message-content {
        flex: 1;
        background: var(--surface-50);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
      }

      .collab-board-message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .collab-board-message-author {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .collab-board-message-time {
        font-size: 10px;
        color: var(--text-muted);
      }

      .collab-board-message-text {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .collab-board-comment-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .collab-board-comment-item {
        background: var(--surface-50);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        border-left: 3px solid var(--surface-300);
      }

      .collab-board-comment-item.open {
        border-left-color: var(--warning-400);
        background: var(--warning-50);
      }

      .collab-board-comment-item.closed {
        border-left-color: var(--success-400);
        opacity: 0.7;
      }

      .collab-board-comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .collab-board-comment-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: var(--radius-xs);
        font-weight: 600;
      }

      .collab-board-comment-badge.open {
        background: var(--warning-100);
        color: var(--warning-600);
      }

      .collab-board-comment-badge.closed {
        background: var(--success-100);
        color: var(--success-600);
      }

      .collab-board-comment-from {
        font-size: 11px;
        color: var(--text-muted);
      }

      .collab-board-comment-text {
        font-size: 13px;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .collab-board-comment-reply {
        background: var(--success-50);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: var(--success-700);
        margin-bottom: 8px;
      }

      .collab-board-comment-meta {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .collab-board-comment-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .collab-board-notes-area {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .collab-board-note-item {
        background: var(--surface-50);
        border-radius: var(--radius-md);
        padding: var(--spacing-md);
        border: 1px solid var(--surface-200);
      }

      .collab-board-note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 13px;
      }

      .collab-board-note-author {
        font-size: 10px;
        color: var(--text-muted);
        background: var(--surface-200);
        padding: 2px 6px;
        border-radius: var(--radius-xs);
      }

      .collab-board-note-text {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .collab-board-note-time {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 8px;
      }

      .collab-board-footer {
        padding: var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        background: var(--surface-50);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Header - Matching tender-dashboard-complete -->
      <header class="header" role="banner">
        <div class="header-top">
          <div class="logo-container">
            <div class="logo">UNOPS</div>
            <span class="portal-badge">Procurement</span>
            <span style="color: var(--surface-400); margin: 0 8px; font-size: 18px;">|</span>
            <span style="color: var(--primary-500); font-weight: 600; font-size: 14px;">eTendering</span>
            </div>

          <!-- Header Actions: Accessibility, Language, AI, Help, Notifications -->
          <div class="header-actions">
            <!-- Accessibility Button -->
            <div class="header-action-btn" title="Accessibility Options" aria-label="Accessibility Options">
              <i class="pi pi-eye" aria-hidden="true"></i>
          </div>

            <!-- Language Selector -->
            <div class="header-action-btn language-selector" title="Change Language" aria-label="Change Language">
              <span class="lang-flag">üåê</span>
            </div>

            <!-- AI Assistant -->
            <div class="header-action-btn ai-assistant-btn" title="AI Assistant" aria-label="AI Procurement Assistant">
              <div class="ai-icon-wrapper">
                <i class="pi pi-bolt" aria-hidden="true"></i>
              </div>
              <span class="ai-badge">NEW</span>
            </div>

            <!-- Help/Questions -->
            <div class="header-action-btn" title="Help Center" aria-label="Help Center">
              <i class="pi pi-question-circle" aria-hidden="true"></i>
            </div>

            <!-- Notifications -->
            <div class="header-action-btn notification-btn" title="Notifications" aria-label="View Notifications">
              <i class="pi pi-bell" aria-hidden="true"></i>
              <span class="notification-badge" id="notificationCount">7</span>
            </div>
          </div>

          <div class="user-menu">
            <div class="user-info">
              <div class="user-company">UNOPS Internal</div>
              <div class="user-name">Jane Doe</div>
            </div>
            <div class="user-avatar" aria-label="User menu">JD</div>
          </div>
        </div>
      </header>

      <!-- App Container -->
      <div class="app-container">
        <!-- Sidebar - Matching award-review-dashboard -->
        <aside class="sidebar">
          <nav class="sidebar-menu">
            <!-- Administrative Applications -->
            <div class="menu-section">
              <div class="menu-section-title">Administrative Applications</div>
              
              <!-- System Settings -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-cog"></i> System Settings</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-users"></i></span><span>User Role Management</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-id-card"></i></span><span>Role Management</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-sliders-h"></i></span><span>Attribute Management</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-database"></i></span><span>Data Management</span></a>
                  <a class="menu-item" href="translation-management.html"><span class="menu-icon"><i class="pi pi-language"></i></span><span>Translations</span></a>
                </div>
              </div>
              
              <!-- Components -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-box"></i> Components</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item" id="menu-criteria" href="https://valentinar11.github.io/ValentinaRo/components-library.html"><span class="menu-icon"><i class="pi pi-list"></i></span><span>Evaluation Criteria Library</span></a>
                  <a class="menu-item" id="menu-specifications"><span class="menu-icon"><i class="pi pi-cog"></i></span><span>Specifications Library</span></a>
                </div>
              </div>
              
              <!-- Forms -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-file-edit"></i> Forms</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-folder"></i></span><span>Forms Library</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-pencil"></i></span><span>Form Builder</span></a>
                </div>
              </div>
              
              <!-- Processes -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-sitemap"></i> Processes</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-list"></i></span><span>Process Library</span></a>
                </div>
              </div>
              
              <!-- Templates -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-copy"></i> Templates</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item" href="template-library.html"><span class="menu-icon"><i class="pi pi-folder"></i></span><span>Templates Library</span></a>
                  <a class="menu-item" href="template-builder-workspace.html"><span class="menu-icon"><i class="pi pi-pencil"></i></span><span>Template Builder</span></a>
                </div>
              </div>
            </div>
            
            <div class="menu-divider"></div>
            
            <!-- Business Applications -->
            <div class="menu-section">
              <div class="menu-section-title">Business Applications</div>
              
              <!-- eTendering -->
              <div class="menu-group">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-briefcase"></i> eTendering</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item" href="tender-dashboard-complete.html"><span class="menu-icon"><i class="pi pi-chart-bar"></i></span><span>Overview</span></a>
                  <a class="menu-item" href="tender-dashboard-complete.html"><span class="menu-icon"><i class="pi pi-folder-open"></i></span><span>Tenders</span></a>
                  <a class="menu-item active" href="tender-authoring.html"><span class="menu-icon"><i class="pi pi-plus"></i></span><span>Create Tender</span></a>
                </div>
              </div>
              
              <!-- Award & Review -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-check-square"></i> Award & Review</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item" href="CPC.html"><span class="menu-icon"><i class="pi pi-chart-bar"></i></span><span>Overview</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-folder"></i></span><span>Cases</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-calendar"></i></span><span>Meetings</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-users"></i></span><span>Pool Management</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-comments"></i></span><span>Q&A</span></a>
                </div>
              </div>
              
              <!-- DRiVE -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-shield"></i> DRiVE</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-chart-bar"></i></span><span>Overview</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-inbox"></i></span><span>Response Library</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-check-circle"></i></span><span>Verification</span></a>
                  <a class="menu-item" href="capa-interactive-mockup.html"><span class="menu-icon"><i class="pi pi-exclamation-triangle"></i></span><span>CAPA</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-question-circle"></i></span><span>Questionnaire Management</span></a>
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-chart-line"></i></span><span>Risk Management</span></a>
                </div>
              </div>
              
              <!-- Contracts -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-file"></i> Contracts</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item disabled"><span class="menu-icon"><i class="pi pi-list"></i></span><span>Contract Management</span></a>
                </div>
              </div>
              
              <!-- Supplier Management -->
              <div class="menu-group collapsed">
                <div class="menu-group-header" onclick="toggleMenuGroup(this)">
                  <span><i class="pi pi-truck"></i> Supplier Management</span>
                  <i class="pi pi-chevron-down"></i>
                </div>
                <div class="menu-group-items">
                  <a class="menu-item" href="supplier-management-procurement.html"><span class="menu-icon"><i class="pi pi-building"></i></span><span>Suppliers</span></a>
                </div>
              </div>
            </div>
          </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Page Action Bar - Buttons moved from header -->
          <div class="page-action-bar" id="top-actions">
            <button class="btn btn-secondary"><i class="pi pi-download"></i> Download Package</button>
            <button class="btn btn-secondary"><i class="pi pi-eye"></i> Preview</button>
            <button class="btn btn-secondary"><i class="pi pi-save"></i> Save Draft</button>
            <button class="btn btn-primary"><i class="pi pi-send"></i> Submit for Review</button>
          </div>

          <!-- Tender Authoring View -->
          <div class="view-section active" id="authoring-view">
            <!-- Progress Steps -->
            <div class="progress-container">
              <div class="progress-steps">
                <div class="progress-step completed" data-step="1">
                  <div class="step-icon">‚úì</div>
                  <div class="step-label">Event Setup</div>
                </div>
                <div class="progress-step active" data-step="2">
                  <div class="step-icon">2</div>
                  <div class="step-label">Authoring</div>
                </div>
                <div class="progress-step" data-step="3">
                  <div class="step-icon">3</div>
                  <div class="step-label">Review</div>
                </div>
                <div class="progress-step" data-step="4">
                  <div class="step-icon">4</div>
                  <div class="step-label">Publish</div>
                </div>
              </div>
            </div>

            <!-- Block Navigation Tabs -->
            <div class="block-nav" id="block-nav">
              <!-- Block tabs will be dynamically generated -->
            </div>

            <!-- Content Area -->
            <div class="content-area">
              <div class="content-wrapper" id="content-wrapper">
                <!-- Content will be dynamically generated based on selected block -->
              </div>

              <!-- Form Library Floating Button -->
              <div id="formLibraryFloatingBtn" class="form-library-floating-btn" onclick="toggleFormLibrary()" title="Form Library" aria-label="Open Form Library">
                <div class="form-library-btn-icon">
                  <i class="pi pi-folder-open"></i>
                </div>
                <div class="form-library-btn-badge" id="formLibraryBadge">8</div>
                <div class="form-library-btn-label">Form<br>Library</div>
              </div>

              <!-- Form Library Panel - Matching Team Collaboration style (Forms only) -->
              <div class="form-library-panel" id="form-library-panel">
                <div class="form-library-header">
                  <div class="form-library-header-content">
                    <div class="form-library-header-icon">
                      <i class="pi pi-folder-open"></i>
                    </div>
                    <div class="form-library-header-text">
                  <div class="form-library-title">Form Library</div>
                      <div class="form-library-subtitle">Drag & drop to add forms</div>
                </div>
                  </div>
                  <button class="toggle-library-btn" onclick="toggleFormLibrary()" aria-label="Close panel">
                    <i class="pi pi-times"></i>
                  </button>
                </div>

                <div class="form-library-body">
                  <!-- Search Area -->
                  <div class="form-library-search-area">
                  <div class="form-library-search">
                      <i class="pi pi-search form-library-search-icon"></i>
                    <input type="search" placeholder="Search forms..." id="form-library-search" />
                  </div>
                  </div>

                  <!-- Content Area -->
                  <div class="form-library-content">
                  <div class="form-library-group">
                      <div class="form-library-group-label">Corporate Forms</div>
                    <div class="form-library-list" id="form-library-list">
                      <div class="form-library-item" draggable="true" data-form-type="instructions" data-form-name="Instructions to Bidders">
                          <div class="form-library-item-icon">üìÑ</div>
                          <div class="form-library-item-content">
                        <strong>Instructions to Bidders</strong>
                            <span>Standard format for tender instructions</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="contracts" data-form-name="Contract Forms">
                          <div class="form-library-item-icon">üìù</div>
                          <div class="form-library-item-content">
                        <strong>Contract Forms</strong>
                            <span>Offer & award documentation</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="bank-guarantee" data-form-name="Bank Guarantee Form">
                          <div class="form-library-item-icon">üè¶</div>
                          <div class="form-library-item-content">
                        <strong>Bank Guarantee Form</strong>
                            <span>Security requirements documentation</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="bid-security" data-form-name="Bid Security Form">
                          <div class="form-library-item-icon">üîí</div>
                          <div class="form-library-item-content">
                        <strong>Bid Security Form</strong>
                            <span>Security requirements for bids</span>
                      </div>
                        </div>
                      </div>
                    </div>

                    <div class="form-library-group">
                      <div class="form-library-group-label">Custom Forms</div>
                      <div class="form-library-list">
                      <div class="form-library-item" draggable="true" data-form-type="drive-questionnaire" data-form-name="DRiVE Questionnaire">
                          <div class="form-library-item-icon">üìä</div>
                          <div class="form-library-item-content">
                        <strong>DRiVE Questionnaire</strong>
                        <span>Risk assessment questionnaire</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="technical-specs" data-form-name="Technical Specifications">
                          <div class="form-library-item-icon">‚öôÔ∏è</div>
                          <div class="form-library-item-content">
                        <strong>Technical Specifications</strong>
                        <span>Detailed technical requirements</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="evaluation" data-form-name="Evaluation Form">
                          <div class="form-library-item-icon">‚úÖ</div>
                          <div class="form-library-item-content">
                        <strong>Evaluation Form</strong>
                        <span>Scoring and evaluation matrix</span>
                          </div>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="price-schedule" data-form-name="Price Schedule">
                          <div class="form-library-item-icon">üí∞</div>
                          <div class="form-library-item-content">
                        <strong>Price Schedule</strong>
                        <span>Pricing breakdown template</span>
                          </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

                <!-- Footer -->
                <div class="form-library-footer">
                  <div class="form-library-footer-hint">
                    <i class="pi pi-info-circle"></i>
                    Drag forms to sections or click to add
                  </div>
                </div>
              </div>
            </div>

          </div>

          <!-- NOTE: Initiation and Wizard views are in tender-create.html -->
        </main>
      </div>
    </div>

    <script>
      // ===== SIDEBAR MENU GROUP TOGGLE =====
      function toggleMenuGroup(header) {
        const group = header.parentElement;
        group.classList.toggle('collapsed');
      }

      // ===== GLOBAL STATE =====
      let currentView = 'authoring'; // This page is authoring-only
      let wizardStep = 1;
      const totalWizardSteps = 3;
      let selectedTemplate = null;
      let wizardData = {};
      
      // Load data from localStorage (from tender-create.html wizard)
      function loadTenderInitData() {
        const savedData = localStorage.getItem('tenderInitData');
        if (savedData) {
          try {
            const initData = JSON.parse(savedData);
            wizardData = initData.wizardData || {};
            selectedTemplate = initData.selectedTemplate || null;
            currentProcessInfo = initData.currentProcessInfo || currentProcessInfo;
            currentLifecycleLinks = initData.currentLifecycleLinks || [];
            
            // Update page title and breadcrumbs
            if (wizardData.title) {
              document.getElementById('page-title').textContent = wizardData.title;
            }
            const methodMap = { itb: 'ITB', rfp: 'RFP', rfq: 'RFQ', eoi: 'EOI', direct: 'Direct' };
            const requirementMap = { goods: 'Goods', services: 'Services', works: 'Works', 'goods-services': 'Goods & Services' };
            document.getElementById('page-breadcrumbs').textContent = 
              `${methodMap[wizardData.method] || 'Tender'} ¬∑ ${requirementMap[wizardData.requirementType] || 'Goods'} ¬∑ Draft`;
            
            // Update top actions for authoring mode
            const topActions = document.getElementById('top-actions');
            topActions.innerHTML = `
              <button class="btn btn-ghost">Preview</button>
              <button class="btn btn-ghost">üíæ Save Draft</button>
              <button class="btn btn-ghost" onclick="downloadTenderPackage()" title="Download all documents as ZIP">üì¶ Download Package</button>
              <button class="btn btn-primary">Submit for Review</button>
            `;
            
            // Pre-populate template blocks with wizard data
            populateTemplateBlocks();
            
            console.log('Loaded tender init data:', initData);
            return true;
          } catch (e) {
            console.error('Error loading tender init data:', e);
          }
        }
        return false;
      }

      // Template blocks structure (based on template builder)
      const templateBlocks = [
        {
          id: 'general',
          icon: 'üìã',
          piIcon: 'pi-file',
          name: 'General Information',
          sections: [
            {
              title: 'Basic Information',
              fields: [
                { id: 'title', label: 'Title', type: 'text', required: true, value: '' },
                { id: 'reference', label: 'Reference', type: 'text', required: true, value: 'Auto-generated', readonly: true },
                { id: 'sourcingOrSolicitation', label: 'Sourcing or Solicitation', type: 'select', required: true, options: ['Select...', 'Sourcing', 'Solicitation'], onchange: 'updateSourcingOrSolicitation', readonly: true },
                { id: 'eventType', label: 'Event Type', type: 'select', required: false, options: ['Select...', 'RFQ', 'RFP', 'ITB', 'EOI', 'RFI', 'PQ'], onchange: 'updateEventType', readonly: true },
                { id: 'processType', label: 'Process Type', type: 'select', required: false, options: ['Select...', 'Standard solicitation', 'Solicit offers against LTA/BPA', 'Secondary bidding against LTA/BPA', 'Direct contracting / Sole sourcing'], onchange: 'updateProcessTypeSelect', conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Solicitation' } },
                { id: 'typeOfRequirement', label: 'Type of Requirement', type: 'select', required: true, options: ['Select...', 'Goods', 'Services', 'Works'], onchange: 'updateTypeOfRequirement', readonly: true },
                { id: 'description', label: 'Description', type: 'textarea', required: true, value: '' },
                { id: 'organizationalUnit', label: 'Organizational Unit', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS' },
                { id: 'beneficiaryCountries', label: 'Beneficiary country(ies)', type: 'country-multiselect', required: false, multiple: true, options: ['Afghanistan', 'Albania', 'Algeria', 'Angola', 'Argentina', 'Armenia', 'Australia', 'Austria', 'Azerbaijan', 'Bahrain', 'Bangladesh', 'Belarus', 'Belgium', 'Benin', 'Bhutan', 'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi', 'Cambodia', 'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica', 'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 'Denmark', 'Djibouti', 'Dominican Republic', 'DR Congo', 'Ecuador', 'Egypt', 'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon', 'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana', 'Haiti', 'Honduras', 'Hungary', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel', 'Italy', 'Ivory Coast', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kosovo', 'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Lithuania', 'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Mauritania', 'Mauritius', 'Mexico', 'Moldova', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Korea', 'North Macedonia', 'Norway', 'Oman', 'Pakistan', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal', 'Qatar', 'Romania', 'Russia', 'Rwanda', 'Saudi Arabia', 'Senegal', 'Serbia', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Somalia', 'South Africa', 'South Korea', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan', 'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'] },
                { id: 'modalityOfBidReceipt', label: 'Modality of Bid Receipt', type: 'select', required: true, options: ['Select...', 'Online Only', 'Email Submission', 'Physical Submission'], onchange: 'updateModalityOfBidReceipt' },
                { id: 'waiverForBidReceipt', label: 'Waiver for Bid Receipt Modality', type: 'text', required: false, value: '', placeholder: 'Provide waiver link', conditionalVisibility: { field: 'modalityOfBidReceipt', values: ['Email Submission', 'Physical Submission'] } },
                { id: 'epp', label: 'EPP', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateEPP', readonly: true },
                { id: 'eppAuthorizationLink', label: 'EPP Authorization (Jira Link)', type: 'text', required: false, value: '', placeholder: 'Enter Jira link', conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'eppAuthorizationEndDate', label: 'EPP Authorization End Date', type: 'date', required: false, value: '', conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'scopeOfEPPApproval', label: 'Scope of EPP Approval', type: 'select', required: false, options: ['Select...', 'Project', 'Org Unit', 'Specific procurement process', 'Other'], conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'medicineOrMedical', label: 'Medicine / Medical Equipment', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateMedicineOrMedical', conditionalVisibility: { field: 'typeOfRequirement', values: ['Goods', 'Services', 'Select...', ''] } },
                { id: 'policyExceptionLink', label: 'Policy Exception for Medicine/Medical Equipment Procurement (Annex 2 Jira Link)', type: 'text', required: false, value: '', placeholder: 'Enter Jira link', conditionalVisibility: { field: 'medicineOrMedical', value: 'Yes' } },
                { id: 'contractAmendment', label: 'Contract Amendment', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], conditionalVisibility: { field: 'processType', contains: 'Direct contracting / Sole sourcing' } },

                { id: 'procurementLifecycleTracker', label: 'Procurement Lifecycle & Related Processes', type: 'lifecycle-tracker', required: false, conditionalRequired: { field: 'isRetendering', value: true }, description: 'Link this process to related procurement events to maintain a complete audit trail' },
                { id: 'isRetendering', label: 'Is this a Retender?', type: 'checkbox', required: false, onchange: 'updateIsRetendering' },
                { id: 'lessonsLearned', label: 'Lessons Learned from Previous Process', type: 'textarea', required: true, value: '', placeholder: 'Document lessons learned from the previous process that will be applied...', conditionalVisibility: { field: 'isRetendering', value: true } },
                { id: 'designReviewDocumentation', label: 'Design Review Documentation', type: 'file', required: false, value: '', help: 'Required for Works procurement', conditionalVisibility: { field: 'typeOfRequirement', value: 'Works' } },
                { id: 'unCollaboration', label: 'UN Collaboration', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateUNCollaboration' },
                { id: 'unCollaborationType', label: 'UN Collaboration Type', type: 'select', required: false, options: ['Select...', 'Joint tendering process with other UN organizations', 'Secondary bidding using other UN agency\'s LTA', 'Re-use of solicitation results of another UN agency'], conditionalVisibility: { field: 'unCollaboration', value: 'Yes' } },
                { id: 'unAgencies', label: 'UN Agencies', type: 'select', required: false, multiple: true, options: ['UNDP', 'UNICEF', 'UNHCR', 'WFP', 'WHO', 'FAO', 'ILO', 'UNESCO', 'UNIDO'], conditionalVisibility: { field: 'unCollaboration', value: 'Yes' } },
                { id: 'isProcurementOfInnovation', label: 'Is this Procurement of Innovation?', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateIsProcurementOfInnovation' },
                { id: 'isLease', label: 'Is this a Lease', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateIsLease' },
                { id: 'srmComplianceDocument', label: 'SRM Compliance Document', type: 'file', required: false, value: '', conditionalVisibility: { field: 'isLease', value: 'Yes' } },
                { id: 'earlyMarketEngagement', label: 'Has there been early market engagement/pre-tender consultation?', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateEarlyMarketEngagement' },
                { id: 'vendorTrainingConducted', label: 'Was vendor training conducted prior to initiating this tender?', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateVendorTrainingConducted' },
                { id: 'vendorTrainingType', label: 'Type of Training', type: 'select', required: false, options: ['Select...', 'Physical Training', 'Online Training'], conditionalVisibility: { field: 'vendorTrainingConducted', value: 'Yes' } },
                { id: 'vendorTrainingAttendees', label: 'Number of vendors that attended the training', type: 'number', required: false, value: '', placeholder: 'Enter number of vendors', conditionalVisibility: { field: 'vendorTrainingConducted', value: 'Yes' } },
                { id: 'vendorTrainingComments', label: 'Comments on content of the training', type: 'textarea', required: false, value: '', placeholder: 'Describe the content and key topics covered in the training...', conditionalVisibility: { field: 'vendorTrainingConducted', value: 'Yes' } },
                { id: 'vendorTrainingAttachment', label: 'Training Documentation (optional)', type: 'file', required: false, value: '', help: 'Attach any relevant training materials or documentation', conditionalVisibility: { field: 'vendorTrainingConducted', value: 'Yes' } },
              ],
            },
          ],
        },
        {
          id: 'project',
          icon: 'üèóÔ∏è',
          piIcon: 'pi-briefcase',
          name: 'Project & Tender Details',
          sections: [
            {
              title: 'Project Information',
              fields: [
                { id: 'projectId', label: 'Project ID', type: 'project-search', required: true, value: '', placeholder: 'Search from oneUNOPS Project', source: 'oneUNOPS Project', onchange: 'updateProjectFromId' },
                { id: 'projectName', label: 'Project Name', type: 'text', required: true, value: '', readonly: true, source: 'oneUNOPS Project (auto-populated)' },
                { id: 'implementationEndDate', label: 'Implementation End Date', type: 'date', required: false, value: '', readonly: true, source: 'oneUNOPS Project (auto-populated)' },
                { id: 'donorFundingSourceComment', label: 'Donor / Funding Source Comment', type: 'textarea', required: false, value: '', placeholder: 'Enter comments about the donor/funding source...' },
              ],
            },
            {
              title: 'Particulars',
              isParticulars: true, // Special flag for custom rendering
            },
          ],
        },
        {
          id: 'requisition-lots',
          icon: 'üìã',
          piIcon: 'pi-list',
          name: 'Requisition & Lots',
          sections: [
            {
              title: 'Requisition & Lots Management',
              fields: [],
              isRequisitionLots: true, // Special flag for this section
            },
          ],
        },
        {
          id: 'scope',
          icon: 'üéØ',
          piIcon: 'pi-check-square',
          name: 'Requirements',
          sections: [
            {
              title: 'Scope and objectives',
              fields: [
                { label: 'Scope and objectives of sourcing or solicitation process', type: 'textarea', required: true, value: '' },
              ],
            },
            {
              title: 'Product Requirements & Specifications',
              fields: [],
              isProductRequirements: true,
            },
            {
              title: 'Other requirements',
              fields: [],
              isTenderAuthorConfig: true,
            },
          ],
        },
        {
          id: 'submission',
          icon: 'üìù',
          piIcon: 'pi-upload',
          name: 'Tender Documents & Forms',
          sections: [
            {
              title: 'Bid Response Requirements',
              fields: [],
              isSupplierResponseStructure: true,
            },
            {
              title: 'Supplier Form Preview',
              fields: [],
              isSupplierFormPreview: true,
            },
          ],
        },
        {
          id: 'evaluation',
          icon: 'üìä',
          piIcon: 'pi-chart-bar',
          name: 'Evaluation',
          sections: [
            {
              title: 'Evaluation Method',
              fields: [
                { id: 'evaluationMethod', label: 'Evaluation method', type: 'select', required: true, options: ['Select...', 'Lowest priced substantially compliant offer', 'Lowest priced most technically acceptable offer', 'Cumulative analysis'], onchange: 'updateEvaluationMethodInEvaluation' },
                { id: 'weightage', label: 'Weightage of technical and financial proposals', type: 'select', required: false, options: ['Select...', '50% technical / 50% financial', '60% technical / 40% financial', '70% technical / 30% financial', '80% technical / 20% financial'], conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'minPoints', label: 'Minimum passing technical threshold', type: 'number', required: false, value: '', placeholder: 'Range from 40% to 100%', conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'maxPointsTechnical', label: 'Maximum points for technical evaluation', type: 'number', required: false, value: '', placeholder: 'e.g., 1000', conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'evaluationMethodDetails', label: 'Evaluation method details', type: 'textarea', required: false, value: '', placeholder: 'Evaluation method details will be pre-filled based on solicitation method...', isEvaluationMethodDetails: true },
              ],
            },
            {
              title: 'Evaluation Criteria',
              isEvaluationCriteria: true, // Special flag to render custom section
            },
          ],
        },
        {
          id: 'competition',
          icon: 'üèÜ',
          piIcon: 'pi-flag',
          name: 'Competition',
          sections: [
            {
              title: 'Competition Type',
              isCompetition: true,
            },
          ],
        },
        {
          id: 'team',
          icon: 'üë•',
          piIcon: 'pi-users',
          name: 'Team',
          sections: [
            {
              title: 'Team Members',
              isTeamMembers: true,
            },
          ],
        },
      ];

      let currentBlockIndex = 0;
      let currentAuthoringStep = 2;
      let addedForms = {}; // Store added forms by block and section: { blockId: { sectionIndex: [forms] } }
      
      // Requisition & Lots Management
      let requisitionLines = []; // Requisition lines from ERP (left container)
      let productsAndServices = []; // Refined products/services for suppliers (right container)
      let lots = []; // Created lots: [{ id, description, unspscCodes: [{ code, description }] }]
      let allowPartialQuotations = ''; // 'Yes' or 'No' - determines if lots section is visible
      
      // Available requisition lines from ERP (centralized source for both Products and Services AND Lots)
      const availableRequisitionLines = [
        { id: 'REQ-LINE-001', unspscCode: '43000000', unspscDescription: 'Information Technology Broadcasting and Telecommunications', description: 'IT Equipment and Services', quantity: 1, unitOfMeasure: 'Lot', amount: 50000, currency: 'USD', unitPrice: 50000, workPackageGLA: 'WP-2024-IT-001', donorFundingSourceGLA: 'UNDP Core Funds', procurementOfficial: 'John Smith' },
        { id: 'REQ-LINE-002', unspscCode: '43211503', unspscDescription: 'Laptop computers', description: 'Laptop computers for office use', quantity: 50, unitOfMeasure: 'Unit', amount: 25000, currency: 'USD', unitPrice: 500, workPackageGLA: 'WP-2024-IT-002', donorFundingSourceGLA: 'USAID Grant', procurementOfficial: 'Sarah Johnson' },
        { id: 'REQ-LINE-003', unspscCode: '43211602', unspscDescription: 'Docking stations', description: 'Docking stations for laptops', quantity: 50, unitOfMeasure: 'Unit', amount: 10000, currency: 'USD', unitPrice: 200, workPackageGLA: 'WP-2024-IT-002', donorFundingSourceGLA: 'USAID Grant', procurementOfficial: 'Sarah Johnson' },
        { id: 'REQ-LINE-004', unspscCode: '43211708', unspscDescription: 'Laptop bags', description: 'Laptop carrying bags', quantity: 50, unitOfMeasure: 'Unit', amount: 2500, currency: 'USD', unitPrice: 50, workPackageGLA: 'WP-2024-IT-002', donorFundingSourceGLA: 'EU Contribution', procurementOfficial: 'Sarah Johnson' },
        { id: 'REQ-LINE-005', unspscCode: '43222609', unspscDescription: 'Network switches', description: 'Network switches for office setup', quantity: 10, unitOfMeasure: 'Unit', amount: 5000, currency: 'USD', unitPrice: 500, workPackageGLA: 'WP-2024-NET-001', donorFundingSourceGLA: 'UNDP Core Funds', procurementOfficial: 'Michael Chen' },
        { id: 'REQ-LINE-006', unspscCode: '43222619', unspscDescription: 'Wireless access points', description: 'WiFi access points', quantity: 20, unitOfMeasure: 'Unit', amount: 3000, currency: 'USD', unitPrice: 150, workPackageGLA: 'WP-2024-NET-001', donorFundingSourceGLA: 'Japan Trust Fund', procurementOfficial: 'Michael Chen' },
        { id: 'REQ-LINE-007', unspscCode: '81111812', unspscDescription: 'Network installation & configuration service', description: 'Network installation services', quantity: 1, unitOfMeasure: 'Service', amount: 5000, currency: 'USD', unitPrice: 5000, workPackageGLA: 'WP-2024-SVC-001', donorFundingSourceGLA: 'Multi-Donor Fund', procurementOfficial: 'Emma Wilson' },
        { id: 'REQ-LINE-008', unspscCode: '43211515', unspscDescription: 'Desktop computers', description: 'Desktop workstations', quantity: 25, unitOfMeasure: 'Unit', amount: 30000, currency: 'USD', unitPrice: 1200, workPackageGLA: 'WP-2024-IT-003', donorFundingSourceGLA: 'World Bank', procurementOfficial: 'John Smith' },
        { id: 'REQ-LINE-009', unspscCode: '43212105', unspscDescription: 'Computer monitors', description: '27-inch monitors', quantity: 50, unitOfMeasure: 'Unit', amount: 15000, currency: 'USD', unitPrice: 300, workPackageGLA: 'WP-2024-IT-002', donorFundingSourceGLA: 'USAID Grant', procurementOfficial: 'Sarah Johnson' },
        { id: 'REQ-LINE-010', unspscCode: '43211706', unspscDescription: 'Computer keyboards', description: 'Wireless keyboards', quantity: 75, unitOfMeasure: 'Unit', amount: 3750, currency: 'USD', unitPrice: 50, workPackageGLA: 'WP-2024-IT-004', donorFundingSourceGLA: 'EU Contribution', procurementOfficial: 'Michael Chen' },
        { id: 'REQ-LINE-011', unspscCode: '43211707', unspscDescription: 'Computer mice', description: 'Wireless mice', quantity: 75, unitOfMeasure: 'Unit', amount: 2250, currency: 'USD', unitPrice: 30, workPackageGLA: 'WP-2024-IT-004', donorFundingSourceGLA: 'EU Contribution', procurementOfficial: 'Michael Chen' },
        { id: 'REQ-LINE-012', unspscCode: '72151500', unspscDescription: 'Building cleaning services', description: 'Office cleaning services', quantity: 12, unitOfMeasure: 'Month', amount: 24000, currency: 'USD', unitPrice: 2000, workPackageGLA: 'WP-2024-FAC-001', donorFundingSourceGLA: 'UNDP Core Funds', procurementOfficial: 'Emma Wilson' },
        { id: 'REQ-LINE-013', unspscCode: '78111800', unspscDescription: 'Passenger transport', description: 'Staff transportation services', quantity: 1, unitOfMeasure: 'Service', amount: 18000, currency: 'USD', unitPrice: 18000, workPackageGLA: 'WP-2024-TRN-001', donorFundingSourceGLA: 'Japan Trust Fund', procurementOfficial: 'Emma Wilson' },
      ];
      
      // Available oneUNOPS Projects (mock data for Project ID search and auto-population)
      const availableOneUNOPSProjects = [
        { id: 'PROJ-2024-001', name: 'Health Facilities Upgrade Project', implementationEndDate: '2025-12-31', country: 'Kenya', region: 'Africa' },
        { id: 'PROJ-2024-002', name: 'School Infrastructure Development', implementationEndDate: '2026-06-30', country: 'Uganda', region: 'Africa' },
        { id: 'PROJ-2024-003', name: 'Office Operations 2025', implementationEndDate: '2025-12-31', country: 'Denmark', region: 'Europe' },
        { id: 'PROJ-2024-004', name: 'IT Infrastructure Modernization', implementationEndDate: '2025-09-30', country: 'Global', region: 'Global' },
        { id: 'PROJ-2024-005', name: 'Multi-Country Development Initiative', implementationEndDate: '2027-03-31', country: 'Multiple', region: 'Global' },
        { id: 'PROJ-2024-006', name: 'Water and Sanitation Program', implementationEndDate: '2026-12-31', country: 'Ethiopia', region: 'Africa' },
        { id: 'PROJ-2024-007', name: 'Emergency Response Capacity Building', implementationEndDate: '2025-06-30', country: 'Haiti', region: 'Americas' },
        { id: 'PROJ-2024-008', name: 'Renewable Energy Access Initiative', implementationEndDate: '2027-12-31', country: 'India', region: 'Asia' },
        { id: 'PROJ-2024-009', name: 'Urban Infrastructure Rehabilitation', implementationEndDate: '2026-09-30', country: 'Iraq', region: 'Middle East' },
        { id: 'PROJ-2024-010', name: 'Sustainable Agriculture Support', implementationEndDate: '2025-12-31', country: 'Myanmar', region: 'Asia' },
      ];
      
      // Master UNSPSC Codes List (from oneUNOPS master data)
      // Category 2: Requires additional review/approval
      // Category 3: High-risk items requiring special handling
      const masterUnspscCodes = [
        { code: '43000000', description: 'Information Technology Broadcasting and Telecommunications' },
        { code: '43211503', description: 'Laptop computers' },
        { code: '43211515', description: 'Desktop computers' },
        { code: '43211602', description: 'Docking stations' },
        { code: '43211706', description: 'Computer keyboards' },
        { code: '43211707', description: 'Computer mice' },
        { code: '43211708', description: 'Laptop bags' },
        { code: '43212105', description: 'Computer monitors' },
        { code: '43222609', description: 'Network switches' },
        { code: '43222619', description: 'Wireless access points' },
        { code: '43232100', description: 'Network security equipment', category: 2 },
        { code: '43233000', description: 'Data storage equipment' },
        { code: '44121700', description: 'Office supplies' },
        { code: '44111500', description: 'Office furniture' },
        { code: '56101500', description: 'Office desks' },
        { code: '56101600', description: 'Office chairs' },
        { code: '72151500', description: 'Building cleaning services' },
        { code: '78111800', description: 'Passenger transport' },
        { code: '80111600', description: 'Temporary personnel services', category: 2 },
        { code: '81111500', description: 'Software development services' },
        { code: '81111812', description: 'Network installation & configuration service' },
        { code: '81112000', description: 'Data processing services' },
        { code: '82101500', description: 'Advertising services' },
        { code: '82111700', description: 'Public relations services' },
        { code: '84111500', description: 'Accounting services', category: 2 },
        { code: '86101700', description: 'Training and educational facilities' },
        { code: '90101600', description: 'Hotels and lodging' },
        { code: '90111500', description: 'Restaurant services' },
        { code: '25101500', description: 'Motor vehicles', category: 3 },
        { code: '25101600', description: 'Trucks and vans', category: 3 },
        { code: '26111700', description: 'Batteries' },
        { code: '31162800', description: 'Fasteners' },
        { code: '39121000', description: 'Lamps and light bulbs' },
        { code: '40141700', description: 'Air handling equipment' },
        { code: '41111500', description: 'Laboratory equipment', category: 2 },
        { code: '42131500', description: 'Medical instruments', category: 3 },
        { code: '46171500', description: 'Safety equipment', category: 2 },
        { code: '47131500', description: 'Cleaning equipment' },
        { code: '48101500', description: 'Food service equipment' },
        { code: '55101500', description: 'Printed publications' },
      ];
      
      // Helper function to get UNSPSC category info
      window.getUnspscCategory = function(code) {
        const item = masterUnspscCodes.find(u => u.code === code);
        return item ? item.category : null;
      };
      
      // Product Requirements (per UNSPSC code)
      let productRequirements = {}; // { unspscCode: { requirementType: 'attributes'|'description', attributes: [{name, value}], description: '' } }
      
      // Competition settings
      let competitionValues = {
        competitionType: '',
        ungmVendors: [],
        unregisteredEmail: '',
        unregisteredCompanyName: '',
        uploadedVendors: [],
        marketResearchDetails: '',
        effectiveCompetitionDetails: '',
        limitedCompetitionJustification: '',
        directContractingReason: '',
        linkedProcess: '',
        directContractingJustification: '',
        // Vendor Notification
        notificationVendors: [
          { companyName: 'ABC Global Solutions Ltd', email: 'contact@abcglobal.com', ungmId: 'UNGM-123456', source: 'UNGM', notified: true, eligibilityStatus: null },
          { companyName: 'Debarred Supplies Inc', email: 'info@debarred.com', ungmId: 'UNGM-789012', source: 'UNGM', notified: false, eligibilityStatus: 'Ineligibility_or_Debarment' },
          { companyName: 'Global Trade Partners', email: 'sales@globaltp.com', ungmId: 'UNGM-345678', source: 'UNGM', notified: true, eligibilityStatus: null },
          { companyName: 'Censured Corp International', email: 'hello@censuredcorp.com', ungmId: 'UNGM-901234', source: 'UNGM', notified: false, eligibilityStatus: 'Censure' },
          { companyName: 'Performance Issues LLC', email: 'support@perfissues.com', ungmId: 'UNGM-567890', source: 'UNGM', notified: true, eligibilityStatus: 'Vendor_Performance_Issues' },
          { companyName: 'Potential Match Vendor Co', email: 'info@potentialmatch.com', ungmId: 'UNGM-234567', source: 'UNGM', notified: false, eligibilityStatus: 'Potentially_Ineligible_Vendors' },
          { companyName: 'Ineligible Registration Ltd', email: 'contact@ineligreg.com', ungmId: 'UNGM-890123', source: 'UNGM', notified: false, eligibilityStatus: 'Ineligible_for_registration' },
          { companyName: 'Clean Record Supplies', email: 'orders@cleanrecord.com', ungmId: 'UNGM-456789', source: 'UNGM', notified: true, eligibilityStatus: null },
          { companyName: 'Manual Entry Company', email: 'manual@company.com', ungmId: '', source: 'Manual', notified: false, eligibilityStatus: null },
          { companyName: 'Other Status Vendor', email: 'other@vendor.com', ungmId: 'UNGM-111222', source: 'UNGM', notified: false, eligibilityStatus: 'Other' }
        ],
        vendorListPage: 1,
        vendorListFilter: ''
      };
      
      // Contract Provisions settings
      let contractProvisionsValues = {
        generalConditions: '',
        specialConditions: '',
        sampleContract: '',
        contractClausesKPIs: '',
        contractClausesDrive: '',
        performanceSecurityRequired: '',
        performanceSecurityDetails: '',
        advancePaymentRequired: '',
        advancePaymentDetails: ''
      };
      
      // Team Members
      let teamMembers = {
        author: { name: 'Valentina Rossi', email: 'valentina.rossi@unops.org', role: 'Author', avatar: 'VR' },
        alternateAuthors: [],
        procurementReviewer: null,
        procurementAuthority: null,
        technicalExperts: [],
        tmeBypass: 'applicable', // 'applicable' | 'bypass_procurement' | 'bypass_waiver'
        bidOpeningPanel: [],
        evaluationTeam: [
          { name: 'John Smith', email: 'john.smith@unops.org', avatar: 'JS', panelRole: 'Procurement Official', approved: true },
          { name: 'Sarah Johnson', email: 'sarah.johnson@unops.org', avatar: 'SJ', panelRole: 'Chair', approved: true },
          { name: 'Michael Chen', email: 'michael.chen@unops.org', avatar: 'MC', panelRole: 'Evaluation Team member', approved: false },
          { name: 'Emma Wilson', email: 'emma.wilson@unops.org', avatar: 'EW', panelRole: 'Observer', approved: true }
        ],
        collaborators: []
      };
      
      // Affidavit signatures for evaluation team members
      let evaluationAffidavits = {
        'john.smith@unops.org': { signed: true, signedDate: '2026-01-05T14:30:00Z', comments: 'No conflicts to disclose.' },
        'sarah.johnson@unops.org': { signed: true, signedDate: '2026-01-06T09:15:00Z', comments: '' }
      };
      
      // Tender Documents - Forms and attachments for the tender
      let tenderDocuments = [];
      
      // Submission Forms - Standard forms for tender with configuration options
      let submissionForms = [
        { 
          id: 'form-a', 
          code: 'A', 
          name: "Bidder's Information", 
          description: 'Company details & JV Partner info', 
          icon: 'üë§', 
          required: true, 
          added: true,
          hasConfig: false,
          attachments: [],
          badge: 'mandatory',
          templateName: "Bidder's Information Form"
        },
        { 
          id: 'form-d', 
          code: 'D', 
          name: 'Technical Bid', 
          description: 'Technical bid/proposal', 
          icon: '‚öôÔ∏è', 
          required: true, 
          added: true,
          hasConfig: true,
          attachments: [],
          badge: 'mandatory',
          templateName: 'Technical Bid Template',
          config: {
            allowOnlineSubmission: true,
            allowSpreadsheetUpload: false,
            customFields: [],
            productLevelFields: {
              model: true,
              manufacturer: true,
              manufacturerAddress: true,
              countryOfOrigin: true,
              deviations: true
            },
            requirementLevelFields: {
              isCompliant: true,
              detailsOffered: true
            }
          }
        },
        { 
          id: 'form-c', 
          code: 'C', 
          name: 'Financial Bid', 
          description: 'Pricing & cost breakdown', 
          icon: 'üí∞', 
          required: true, 
          added: true,
          hasConfig: true,
          attachments: [],
          badge: 'mandatory',
          templateName: 'Financial Bid Template',
          config: {
            allowOnlineSubmission: true,
            allowSpreadsheetUpload: false,
            incoterms: { fca: true, cpt: true, dpu: true },
            includeRelatedServices: true,
            includeShipmentDelivery: true,
            shipmentColumns: {
              item: true,
              fcaDelivery: true,
              dimensions: true,
              weight: true,
              volume: true,
              containerNum: true,
              containerSize: true
            },
            customShipmentColumns: [],
            optionalCostFields: {
              freightCost: true,
              customsClearance: true
            }
          }
        },
        { 
          id: 'form-qual', 
          code: 'Q', 
          name: 'Qualifications & Eligibility', 
          description: 'Performance & financial capability', 
          icon: 'üéØ', 
          required: true, 
          added: true,
          hasConfig: true,
          attachments: [],
          badge: 'mandatory',
          templateName: 'Performance Statement',
          config: {
            requirePerformanceStatement: true,
            requireBidSecurity: true,
            bidSecurityAmount: '',
            bidSecurityCurrency: 'USD',
            financialStatementsRequired: false,
            financialStatementsRequirements: ''
          }
        },
        { 
          id: 'form-compliance', 
          code: 'C&D', 
          name: 'Compliance & Declarations', 
          description: 'Self-disclosure & bid submission', 
          icon: '‚úÖ', 
          required: true, 
          added: true,
          hasConfig: false,
          attachments: [],
          badge: 'mandatory',
          templateName: 'Self Disclosure Form',
          additionalTemplates: ['Bid Submission Declaration']
        },
        { 
          id: 'form-other', 
          code: 'O', 
          name: 'Other Forms', 
          description: 'Additional forms & assessments', 
          icon: 'üìã', 
          required: false, 
          added: true,
          hasConfig: false,
          attachments: [],
          badge: 'optional',
          templateName: null
        }
      ];

      // Library forms added to each form category (keyed by form id)
      // Each category can have: template enabled/disabled + additional library forms
      let formCategoryLibraryForms = {
        'form-c': [], // Financial Bid
        'form-d': [], // Technical Bid
        'form-a': [], // Bidder's Information
        'form-qual': [
          { name: 'Bid Security Form', type: 'bid-security', addedDate: 'Jan 20' },
          { name: 'Financial Statements', type: 'financial-statements', addedDate: 'Jan 20' }
        ],
        'form-compliance': [],
        'form-other': [
          { name: 'DRiVE Self Assessment', type: 'drive-questionnaire', addedDate: 'Jan 15' }
        ]
      };

      // Track if template is enabled for each category (separate from 'added' which was for old UI)
      let formCategoryTemplateEnabled = {
        'form-c': true, // Financial Bid template enabled by default
        'form-d': true,
        'form-a': true,
        'form-qual': true,
        'form-compliance': true,
        'form-other': false // No predefined template for Other Forms
      };

      // Tender Package Attachments (separate from forms)
      let tenderAttachments = [];

      // Helper function to render tender attachments list
      function renderTenderAttachmentsList() {
        if (tenderAttachments.length === 0) {
          return '<div style="font-size: 12px; color: var(--text-muted); font-style: italic;">No attachments added yet</div>';
        }
        
        return tenderAttachments.map((att, idx) => {
          const fileIcon = getFileIcon(att.name);
          return `
            <div class="tender-attachment-item">
              <span class="tender-attachment-item-icon">${fileIcon}</span>
              <span class="tender-attachment-item-name" title="${att.name}">${att.name}</span>
              <span class="tender-attachment-item-size">${formatFileSize(att.size)}</span>
              <button class="tender-attachment-item-remove" onclick="event.stopPropagation(); removeTenderAttachment(${idx})" title="Remove">
                <i class="pi pi-times"></i>
              </button>
            </div>
          `;
        }).join('');
      }

      // Bid Response Requirements - Custom Fields
      let bidResponseFields = {
        perBid: [
          { name: "Bidder's Total Prices [Incoterm]", type: "Currency input", id: 'pb1' },
          { name: "Customs clearance costs", type: "Currency input", id: 'pb2' },
          { name: "Freight cost", type: "Currency input", id: 'pb3' },
          { name: "Total Price of Goods [Incoterm]", type: "Currency input (calculated)", id: 'pb4' },
          { name: "Total Price of Related Services", type: "Currency input", id: 'pb5' }
        ],
        perUNSPSC: [
          { name: "Unit price Incoterm", type: "Currency input", id: 'pu1' },
          { name: "Total price Incoterm", type: "Currency input (calculated)", id: 'pu2' },
          { name: "Country of Origin", type: "Country dropdown", id: 'pu3' },
          { name: "Delivery point(s)", type: "Text input", id: 'pu4' },
          { name: "Model", type: "Text input", id: 'pu5' },
          { name: "Manufacturer", type: "Text input", id: 'pu6' }
        ],
        perAttribute: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pa1' },
          { name: "Details of goods offered", type: "Text area", id: 'pa2' }
        ],
        perServiceLine: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'ps1' },
          { name: "Details", type: "Text area", id: 'ps2' }
        ],
        perDelivery: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pd1' },
          { name: "Details", type: "Text area", id: 'pd2' }
        ]
      };
      
      let fieldIdCounter = 100;
      
      // Supplier Form Preview Toggle
      let isSupplierFormPreviewVisible = false;
      
      // Track collapsed state of collapsible sections (to preserve state on re-render)
      let collapsibleSectionStates = {};
      
      // Delivery Requirements - Grid-based structure with lot/product assignment
      let deliveryRequirements = [
        // Each entry: { id, deliveryTime, deliveryPlace, consigneeDetails, applyTo: 'all'|'lot'|'product', targetIds: [] }
      ];
      
      // Legacy field structure for backwards compatibility
      let deliveryRequirementFields = [];
      
      // Evaluation Criteria Library - Reusable criteria templates with enhanced fields
      const criteriaLibrary = [
        // Eligibility & Formal Criteria
        {
          id: 'LIB-EF-001',
          name: 'Legal Entity Registration',
          criteriaCategory: 'Eligibility & Formal',
          type: 'Eligibility & Formal',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must be a legally registered entity with valid registration documents.',
          category: 'Eligibility',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-compliance']
        },
        {
          id: 'LIB-EF-002',
          name: 'Tax Compliance Certificate',
          criteriaCategory: 'Eligibility & Formal',
          type: 'Eligibility & Formal',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must provide valid tax compliance certificate from relevant tax authority.',
          category: 'Eligibility',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-compliance']
        },
        // Qualification Criteria
        {
          id: 'LIB-QC-001',
          name: 'ISO 9001 Quality Management Certification',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must hold valid ISO 9001:2015 Quality Management System certification from an accredited certification body.',
          category: 'Quality',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-qualification']
        },
        {
          id: 'LIB-QC-002',
          name: 'ISO 14001 Environmental Certification',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must hold valid ISO 14001:2015 Environmental Management System certification.',
          category: 'Quality',
          sustainableProcurement: ['Resource Efficiency - Energy efficiency measures'],
          linkedFormsSuggestion: ['form-qualification', 'form-sustainability']
        },
        {
          id: 'LIB-QC-003',
          name: 'ISO 45001 Occupational Health & Safety',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must demonstrate compliance with ISO 45001:2018 Occupational Health and Safety Management System.',
          category: 'Quality',
          sustainableProcurement: ['Health and Safety - Security and safety of workers'],
          linkedFormsSuggestion: ['form-qualification']
        },
        {
          id: 'LIB-FC-001',
          name: 'Financial Capacity - Annual Turnover',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must demonstrate average annual turnover of at least [X] USD over the past 3 financial years.',
          category: 'Financial',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-financial']
        },
        {
          id: 'LIB-FC-002',
          name: 'Financial Capacity - Liquidity Ratio',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must demonstrate a current ratio (current assets/current liabilities) of at least 1.0.',
          category: 'Financial',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-financial']
        },
        {
          id: 'LIB-FC-003',
          name: 'Financial Statement Audit',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Bidder must provide audited financial statements for the last 3 years from a recognized audit firm.',
          category: 'Financial',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-financial']
        },
        {
          id: 'LIB-EX-001',
          name: 'Relevant Project Experience',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Numeric',
          maxPoints: 30,
          description: 'Bidder must demonstrate experience in at least [X] similar projects completed within the last 5 years.',
          category: 'Experience',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-experience']
        },
        {
          id: 'LIB-EX-002',
          name: 'UN/International Organization Experience',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Numeric',
          maxPoints: 20,
          description: 'Prior experience working with UN agencies or international organizations in similar capacity.',
          category: 'Experience',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-experience']
        },
        {
          id: 'LIB-EX-003',
          name: 'Regional/Country Experience',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Numeric',
          maxPoints: 15,
          description: 'Demonstrated experience operating in the target region/country for at least [X] years.',
          category: 'Experience',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-experience']
        },
        // Technical Criteria
        {
          id: 'LIB-TC-001',
          name: 'Technical Methodology',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 40,
          description: 'Evaluation of proposed technical approach, methodology and work plan for delivering the required goods/services.',
          category: 'Technical',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-technical']
        },
        {
          id: 'LIB-TC-002',
          name: 'Quality Assurance Plan',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 25,
          description: 'Assessment of the proposed quality assurance and quality control measures.',
          category: 'Technical',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-technical']
        },
        {
          id: 'LIB-TC-003',
          name: 'Risk Management Approach',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 20,
          description: 'Evaluation of risk identification, mitigation strategies and contingency planning.',
          category: 'Technical',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-technical']
        },
        {
          id: 'LIB-TC-004',
          name: 'Innovation and Value-Added Services',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 15,
          description: 'Assessment of innovative solutions, added value and continuous improvement proposals.',
          category: 'Technical',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-technical']
        },
        {
          id: 'LIB-HR-001',
          name: 'Key Personnel Qualifications',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 30,
          description: 'Evaluation of qualifications, experience and expertise of proposed key personnel.',
          category: 'Human Resources',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-technical']
        },
        {
          id: 'LIB-HR-002',
          name: 'Team Composition and Structure',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 20,
          description: 'Assessment of proposed team structure, roles and responsibilities.',
          category: 'Human Resources',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-technical']
        },
        {
          id: 'LIB-SL-001',
          name: 'Past Performance References',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Satisfactory references from at least [X] clients for similar contracts completed in the last 5 years.',
          category: 'Experience',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-experience']
        },
        {
          id: 'LIB-SL-002',
          name: 'Capacity Assessment',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Demonstration of adequate capacity (personnel, equipment, facilities) to undertake the assignment.',
          category: 'Capacity',
          sustainableProcurement: [],
          linkedFormsSuggestion: ['form-qualification']
        },
        // Sustainability Criteria
        {
          id: 'LIB-SU-001',
          name: 'Environmental Sustainability Plan',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 25,
          description: 'Assessment of environmental sustainability measures, green practices and carbon footprint reduction plans.',
          category: 'Sustainability',
          sustainableProcurement: ['Resource Efficiency - Energy efficiency measures', 'Resource Efficiency - Water conservation and management'],
          linkedFormsSuggestion: ['form-sustainability']
        },
        {
          id: 'LIB-SU-002',
          name: 'Social Responsibility Commitment',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 25,
          description: 'Evaluation of social responsibility policies, labor practices and community engagement initiatives.',
          category: 'Sustainability',
          sustainableProcurement: ['Gender and Social Inclusion - Equality opportunity, Diversity and inclusion', 'Labor Standards - Hiring of local labour'],
          linkedFormsSuggestion: ['form-sustainability']
        },
        {
          id: 'LIB-SU-003',
          name: 'Gender Equality and Women Empowerment',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 20,
          description: 'Assessment of gender equality policies, women in leadership positions, and support for women-owned businesses.',
          category: 'Sustainability',
          sustainableProcurement: ['Gender and Social Inclusion - Equality opportunity, Diversity and inclusion', 'Gender and Social Inclusion - Gender and social inclusion mainstreaming', 'Gender and Social Inclusion - Labor opportunities for women and/or traditionally disadvantaged groups'],
          linkedFormsSuggestion: ['form-sustainability']
        },
        {
          id: 'LIB-SU-004',
          name: 'Youth Employment and Training',
          criteriaCategory: 'Technical',
          type: 'Technical',
          method: 'Numeric',
          maxPoints: 15,
          description: 'Evaluation of youth employment programs, apprenticeships, and training opportunities.',
          category: 'Sustainability',
          sustainableProcurement: ['Gender and Social Inclusion - Youth inclusion and partnership with youth'],
          linkedFormsSuggestion: ['form-sustainability']
        },
        {
          id: 'LIB-SU-005',
          name: 'Labor Standards Compliance',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Verification of compliance with international labor standards including no child labor, no forced labor, and fair wages.',
          category: 'Sustainability',
          sustainableProcurement: ['Labor Standards - Child Labor', 'Labor Standards - Forced labour and human trafficking', 'Labor Standards - Grievance mechanism'],
          linkedFormsSuggestion: ['form-compliance', 'form-sustainability']
        },
        {
          id: 'LIB-SU-006',
          name: 'Health and Safety Management',
          criteriaCategory: 'Qualification',
          type: 'Qualification',
          method: 'Pass/Fail',
          maxPoints: null,
          description: 'Assessment of occupational health and safety policies, incident tracking, and emergency preparedness.',
          category: 'Sustainability',
          sustainableProcurement: ['Health and Safety - Emergency preparedness', 'Health and Safety - Incidents/accidents tracking system', 'Health and Safety - Security and safety of workers'],
          linkedFormsSuggestion: ['form-qualification']
        }
      ];
      
      // Sustainable Procurement Categories
      const sustainableProcurementCategories = [
        { id: 'sp-gsi-1', category: 'Gender and Social Inclusion', value: 'Equality opportunity, Diversity and inclusion' },
        { id: 'sp-gsi-2', category: 'Gender and Social Inclusion', value: 'Gender and social inclusion mainstreaming' },
        { id: 'sp-gsi-3', category: 'Gender and Social Inclusion', value: 'Labor opportunities for women and/or traditionally disadvantaged groups' },
        { id: 'sp-gsi-4', category: 'Gender and Social Inclusion', value: 'Youth inclusion and partnership with youth' },
        { id: 'sp-hs-1', category: 'Health and Safety', value: 'Emergency preparedness' },
        { id: 'sp-hs-2', category: 'Health and Safety', value: 'Incidents/accidents tracking system' },
        { id: 'sp-hs-3', category: 'Health and Safety', value: 'Security and safety of workers' },
        { id: 'sp-ls-1', category: 'Labor Standards', value: 'Child Labor' },
        { id: 'sp-ls-2', category: 'Labor Standards', value: 'Forced labour and human trafficking' },
        { id: 'sp-ls-3', category: 'Labor Standards', value: 'Grievance mechanism' },
        { id: 'sp-ls-4', category: 'Labor Standards', value: 'Hiring of local labour' },
        { id: 'sp-ls-5', category: 'Labor Standards', value: 'Labor risks along the supply chain' },
        { id: 'sp-ls-6', category: 'Labor Standards', value: 'Suppliers and Contractors selection and management' },
        { id: 'sp-re-1', category: 'Resource Efficiency', value: 'Energy efficiency measures' },
        { id: 'sp-re-2', category: 'Resource Efficiency', value: 'Water conservation and management' }
      ];
      
      // Evaluation Criteria
      // Predefined Eligibility & Formal Criteria from evaluation framework
      let evaluationCriteria = [
        { 
          id: 'EF-001', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: "Bidders' nationality check",
          description: 'Verification of bidder nationality against eligible countries list (if restriction set by tender author)', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        },
        { 
          id: 'EF-002', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: 'Bid/Proposal Submission Form',
          description: 'Response validation with flag for deviations on predetermined fields (bid validity, etc.)', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        },
        { 
          id: 'EF-003', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: 'UNGM eligibility check',
          description: 'Verification of UNGM registration for bidder & all parties in JV/consortium', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        },
        { 
          id: 'EF-004', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: 'Completeness of documents',
          description: 'Check for all required documents including validation of dates (bid validity compliance)', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        },
        { 
          id: 'EF-005', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: 'Document format check',
          description: 'Automatic verification that all attachments are readable, non-empty, and not corrupted', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        },
        { 
          id: 'EF-006', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: 'UNOPS claims log check',
          description: 'Verification against UNOPS claims log for any previous issues', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        },
        { 
          id: 'EF-007', 
          category: 'Eligibility & Formal',
          type: 'Eligibility & Formal', 
          criteria: 'Acceptance of general conditions',
          description: 'Verification that bidder has accepted General Conditions of Contract without material deviations', 
          evaluationMethod: 'Pass/Fail',
          maxPoints: null,
          sustainableProcurement: [],
          appliesTo: 'tender',
          lots: [],
          unspscCodes: [],
          linkedForms: [],
          isPredefined: true
        }
      ];
      let evaluationCriteriaIdCounter = 100; // Start higher to avoid conflicts with predefined IDs
      
      // Evaluation criteria categories for dropdown
      const evaluationCriteriaCategories = [
        'Eligibility & Formal',
        'Qualification',
        'Technical'
      ];
      
      // General Information - Field Values for Conditional Visibility
      let generalInfoValues = {
        sourcingOrSolicitation: '',
        eventType: '',
        solicitationType: '',
        typeOfRequirement: '',
        modalityOfBidReceipt: '',
        epp: '',
        medicineOrMedical: '',
        processType: '',
        directContracting: false,
        unCollaboration: '',
        isLease: '',
        isRetendering: false,
        beneficiaryCountries: [],
        isProcurementOfInnovation: '',
        earlyMarketEngagement: '',
        vendorTrainingConducted: ''
      };
      
      // Particulars - Field Values for Conditional Visibility
      let particularsValues = {
        clarificationsOrPreBid: '',
        numberOfMeetings: 0,
        siteVisit: '',
        dateOption: '',
        exclusivity: '',
        alternativeOffers: '',
        advancePaymentAllowed: '',
        advancePaymentPercentage: '',
        advancePaymentJustification: '',
        advancePaymentSecurity: '',
        liquidatedDamages: '',
        performanceSecurity: '',
        bidSecurity: '',
        bidderEligibility: '',
        paymentTerms: '',
        incoterms: []
      };
      
      // Evaluation Block - Field Values for Conditional Visibility
      let evaluationBlockValues = {
        evaluationMethod: '',
        maxPointsTechnical: '',
        evaluationMethodDetails: '',
        spWaiverCode: ''
      };
      
      // Minimum SP criteria required (if below this, waiver is needed)
      const MIN_SP_CRITERIA_REQUIRED = 1;
      
      // Pre-filled Evaluation Method Details based on Solicitation Type
      const evaluationMethodDetailsTemplates = {
        'RFQ': 'Preliminary Examination. Quotations shall be reviewed for compliance of the eligibility and formal criteria specified in Evaluation Criteria section. Qualifications of the Bidder will be assessed as per qualification criteria specified in the Evaluation Criteria section. Technical compliance of the offered goods/services. The technical criteria specified in the Evaluation Criteria section will be reviewed for compliance compared to UNOPS requirements. Financial evaluation. Quotations that are found to be technically acceptable shall be evaluated based on price and UNOPS will award the contract as per the lowest priced, most technically acceptable offer evaluation methodology.',
        'ITB': 'Preliminary Examination. Bids shall be reviewed for compliance of the eligibility and formal criteria specified in Evaluation Criteria section. Qualifications of the Bidder will be assessed as per qualification criteria specified in the Evaluation Criteria section. Technical compliance of the offered goods/services/works. The technical criteria specified in the Evaluation Criteria section will be reviewed for compliance compared to UNOPS requirements. Financial evaluation. Bids that are found to be technically acceptable shall be evaluated based on price and UNOPS will award the contract to the lowest priced, substantially compliant bidder.',
        'RFP': 'Preliminary Examination. Proposals shall be reviewed for compliance of the eligibility and formal criteria specified in Evaluation Criteria section. Qualifications of the Offeror will be assessed as per qualification criteria specified in the Evaluation Criteria section. Technical Evaluation. Proposals meeting the eligibility and qualification requirements will proceed to technical evaluation. Technical criteria specified in the Evaluation Criteria section will be scored according to the defined weighting. Financial Evaluation. Proposals that achieve the minimum technical score will have their financial proposals opened and evaluated. The contract shall be awarded using cumulative analysis methodology combining technical and financial scores.',
        'EOI': 'Preliminary Examination. Expressions of Interest shall be reviewed for compliance of the eligibility and formal criteria specified in Evaluation Criteria section. Qualifications Assessment. Interested parties will be assessed against the qualification criteria specified in the Evaluation Criteria section. Shortlisting. Based on the evaluation results, a shortlist of qualified candidates will be prepared for the subsequent procurement process.',
        'default': 'Preliminary Examination. Submissions shall be reviewed for compliance of the eligibility and formal criteria specified in Evaluation Criteria section. Qualifications Assessment. Submissions will be assessed against the qualification criteria specified in the Evaluation Criteria section. Technical Evaluation. Technical criteria specified in the Evaluation Criteria section will be evaluated. Financial Evaluation. Financial aspects of compliant submissions shall be evaluated according to the specified methodology.'
      };
      
      // Initialize sample requisition lines (simulating ERP data)
      function initializeRequisitionLines() {
        // Start with empty requisition lines - user will add requisitions or new products
        requisitionLines = [];
      }

      // Available templates
      const availableTemplates = [
        {
          id: 'itb-goods-standard',
          name: 'ITB - Goods (Standard)',
          type: 'ITB',
          icon: 'üì¶',
          description: 'Standard Invitation to Bid template for goods procurement. Includes all standard forms and requirements.',
          category: 'Goods',
          method: 'ITB',
          matchScore: 95,
        },
        {
          id: 'itb-services-standard',
          name: 'ITB - Services (Standard)',
          type: 'ITB',
          icon: 'üîß',
          description: 'Standard Invitation to Bid template for services procurement with service-specific requirements.',
          category: 'Services',
          method: 'ITB',
          matchScore: 90,
        },
        {
          id: 'rfp-goods-services',
          name: 'RFP - Goods & Services',
          type: 'RFP',
          icon: 'üìã',
          description: 'Request for Proposal template suitable for complex procurements involving both goods and services.',
          category: 'Goods & Services',
          method: 'RFP',
          matchScore: 85,
        },
        {
          id: 'rfq-goods-standard',
          name: 'RFQ - Goods (Standard)',
          type: 'RFQ',
          icon: 'üí∞',
          description: 'Request for Quotation template for simple goods procurement with streamlined requirements.',
          category: 'Goods',
          method: 'RFQ',
          matchScore: 80,
        },
        {
          id: 'itb-works-standard',
          name: 'ITB - Works (Standard)',
          type: 'ITB',
          icon: 'üèóÔ∏è',
          description: 'Standard Invitation to Bid template for works/construction projects with works-specific clauses.',
          category: 'Works',
          method: 'ITB',
          matchScore: 75,
        },
      ];

      // Mock data for procurement processes (for lifecycle linking)
      const procurementProcesses = [
        {
          id: 'REQ-2024-001',
          type: 'Requisition',
          title: 'Medical Equipment Requisition',
          status: 'Completed',
          value: '$250,000',
          created: '2024-11-15',
          createdBy: 'Sarah Johnson',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'RFI-2024-045',
          type: 'RFI',
          title: 'Request for Information - Medical Equipment Suppliers',
          status: 'Completed',
          value: 'N/A',
          created: '2024-12-01',
          createdBy: 'Michael Chen',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'RFP-2025-001',
          type: 'RFP',
          title: 'Supply of Medical Equipment for Health Facilities',
          status: 'Published',
          value: '$250,000',
          created: '2025-01-15',
          createdBy: 'Sarah Johnson',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'REQ-2024-082',
          type: 'Requisition',
          title: 'Construction Materials Requisition',
          status: 'Completed',
          value: '$1,200,000',
          created: '2024-12-10',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'EOI-2024-028',
          type: 'EOI',
          title: 'Expression of Interest - Construction Companies',
          status: 'Completed',
          value: 'N/A',
          created: '2024-12-20',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'ITB-2025-015',
          type: 'ITB',
          title: 'Construction of School Infrastructure in Rural Areas',
          status: 'Published',
          value: '$1,200,000',
          created: '2025-01-22',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'RFQ-2024-156',
          type: 'RFQ',
          title: 'Office Supplies Quotation Request',
          status: 'Closed',
          value: '$45,000',
          created: '2025-01-10',
          createdBy: 'Lisa Anderson',
          category: 'Goods',
          projectName: 'Office Operations 2025'
        },
        {
          id: 'LTA-2023-012',
          type: 'LTA',
          title: 'Long Term Agreement - IT Equipment Supply',
          status: 'Active',
          value: '$500,000',
          created: '2023-06-15',
          createdBy: 'David Kim',
          category: 'Goods',
          projectName: 'IT Infrastructure Modernization'
        },
        {
          id: 'RFP-2024-089',
          type: 'RFP',
          title: 'Consultancy Services - Project Management',
          status: 'Completed',
          value: '$180,000',
          created: '2024-09-05',
          createdBy: 'Maria Garcia',
          category: 'Services',
          projectName: 'Multi-Country Development Initiative'
        },
      ];

      // Global state for lifecycle tracker
      let currentLifecycleLinks = [];
      let currentProcessInfo = {
        id: 'AUTO-GENERATED',
        type: 'RFP',
        title: 'New Tender Process',
        status: 'Draft',
        created: new Date().toISOString().split('T')[0],
        createdBy: 'Current User'
      };

      // Mock data for existing tenders (for cloning feature)
      const existingTenders = [
        {
          id: 'tender-001',
          reference: 'UNOPS-2025-RFP-001',
          title: 'Supply of Medical Equipment for Health Facilities',
          type: 'RFP - Request for Proposal',
          category: 'Goods',
          value: '$250,000',
          status: 'Published',
          created: '15 Jan 2025',
          template: 'RFP - Goods (Standard)',
        },
        {
          id: 'tender-002',
          reference: 'UNOPS-2025-ITB-015',
          title: 'Construction of School Infrastructure in Rural Areas',
          type: 'ITB - Invitation to Bid',
          category: 'Works',
          value: '$1,200,000',
          status: 'Published',
          created: '22 Jan 2025',
          template: 'ITB - Works (Standard)',
        },
        {
          id: 'tender-003',
          reference: 'UNOPS-2025-RFQ-028',
          title: 'Office Supplies and Equipment Procurement',
          type: 'RFQ - Request for Quotation',
          category: 'Goods',
          value: '$45,000',
          status: 'Closed',
          created: '10 Jan 2025',
          template: 'RFQ - Goods & Services',
        },
        {
          id: 'tender-004',
          reference: 'UNOPS-2025-RFP-007',
          title: 'Consultancy Services for Project Management',
          type: 'RFP - Request for Proposal',
          category: 'Services',
          value: '$180,000',
          status: 'Draft',
          created: '5 Feb 2025',
          template: 'RFP - Services (Standard)',
        },
        {
          id: 'tender-005',
          reference: 'UNOPS-2025-ITB-022',
          title: 'Road Rehabilitation Project - Phase 2',
          type: 'ITB - Invitation to Bid',
          category: 'Works',
          value: '$3,500,000',
          status: 'Published',
          created: '28 Jan 2025',
          template: 'ITB - Works (Standard)',
        },
        {
          id: 'tender-006',
          reference: 'UNOPS-2025-RFP-012',
          title: 'IT Equipment and Software Licensing',
          type: 'RFP - Request for Proposal',
          category: 'Goods & Services',
          value: '$320,000',
          status: 'Published',
          created: '18 Jan 2025',
          template: 'RFP - Goods & Services',
        },
      ];

      // ===== TENDER INITIATION FUNCTIONS =====
      function startWithWizard() {
        currentView = 'wizard';
        document.getElementById('initiation-view').classList.remove('active');
        document.getElementById('wizard-view').classList.add('active');
        document.getElementById('page-breadcrumbs').textContent = 'Event Setup ¬∑ Guided Wizard';
        initWizard();
      }

      function startWithTemplate() {
        // Navigate to template library page
        window.location.href = 'template-library.html?action=create-tender';
      }

      function startWithClone() {
        // Show tender selection modal
        showTenderSelectionModal();
      }

      function showTenderSelectionModal() {
        const modal = document.getElementById('tender-selection-modal');
        modal.style.display = 'flex';
        loadExistingTenders();
      }

      function closeTenderSelectionModal() {
        const modal = document.getElementById('tender-selection-modal');
        modal.style.display = 'none';
      }

      function loadExistingTenders() {
        const tenderList = document.getElementById('existing-tenders-list');
        tenderList.innerHTML = '';

        existingTenders.forEach(tender => {
          const tenderCard = document.createElement('div');
          tenderCard.className = 'existing-tender-card';
          tenderCard.onclick = () => selectTenderToClone(tender);
          
          const statusClass = tender.status === 'Published' ? 'success' : 
                              tender.status === 'Draft' ? 'warning' : 'info';
          
          tenderCard.innerHTML = `
            <div class="existing-tender-header">
              <div>
                <div class="existing-tender-title">${tender.title}</div>
                <div class="existing-tender-reference">${tender.reference}</div>
              </div>
              <span class="badge badge-${statusClass}">${tender.status}</span>
            </div>
            <div class="existing-tender-details">
              <div class="existing-tender-meta">
                <span>üìã ${tender.type}</span>
                <span>üí∞ ${tender.value}</span>
                <span>üìÖ ${tender.created}</span>
              </div>
              <div class="existing-tender-template">${tender.template}</div>
            </div>
          `;
          
          tenderList.appendChild(tenderCard);
        });
      }

      function selectTenderToClone(tender) {
        if (confirm(`Clone tender "${tender.title}"?\n\nAll blocks, fields, and configurations will be copied. You can then modify as needed.`)) {
          closeTenderSelectionModal();
          cloneTender(tender);
        }
      }

      function cloneTender(tender) {
        // In real implementation, this would call an API to clone the tender
        console.log('Cloning tender:', tender);
        
        // Show loading
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'loading-overlay';
        loadingMsg.innerHTML = `
          <div class="loading-content">
            <div class="spinner"></div>
            <div>Cloning tender...</div>
          </div>
        `;
        document.body.appendChild(loadingMsg);
        
        // Simulate API call
        setTimeout(() => {
          // Remove loading
          document.body.removeChild(loadingMsg);
          
          // Set wizard data from cloned tender
          wizardData = {
            title: `Copy of ${tender.title}`,
            requirementType: 'goods', // Would come from tender data
            method: tender.type.toLowerCase().split(' ')[0],
            estimatedValue: tender.value.replace(/[^0-9]/g, ''),
            template: tender.template,
          };
          
          selectedTemplate = availableTemplates.find(t => t.name === tender.template) || availableTemplates[0];
          
          // Proactive linking: Automatically link the cloned tender as predecessor
          const sourceProcess = procurementProcesses.find(p => p.id === tender.reference);
          const cloneLinks = [];
          if (sourceProcess) {
            cloneLinks.push({
              process: sourceProcess,
              relationshipType: 'predecessor',
              linkedAt: new Date().toISOString(),
              linkedBy: 'System',
              linkType: 'automatic',
              linkReason: 'Cloned from this process'
            });
          }
          
          // Save clone data to localStorage and redirect
          const tenderInitData = {
            wizardData: wizardData,
            selectedTemplate: selectedTemplate,
            currentProcessInfo: {
              id: `CLONE-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`,
              type: tender.type.split(' ')[0],
              title: wizardData.title,
              status: 'Draft',
              value: wizardData.estimatedValue ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}` : 'TBD',
              created: new Date().toISOString().split('T')[0],
              createdBy: 'Current User',
              category: wizardData.requirementType || 'Goods',
            },
            currentLifecycleLinks: cloneLinks,
            isClone: true,
            sourceReference: tender.reference,
            initiatedAt: new Date().toISOString()
          };
          localStorage.setItem('tenderInitData', JSON.stringify(tenderInitData));
          
          // Redirect to authoring page
          window.location.href = 'tender-authoring.html';
        }, 1500);
      }

      function filterExistingTenders(searchTerm) {
        const filteredTenders = existingTenders.filter(tender => {
          const lowerSearch = searchTerm.toLowerCase();
          return tender.title.toLowerCase().includes(lowerSearch) ||
                 tender.reference.toLowerCase().includes(lowerSearch) ||
                 tender.type.toLowerCase().includes(lowerSearch);
        });
        
        const tenderList = document.getElementById('existing-tenders-list');
        tenderList.innerHTML = '';
        
        if (filteredTenders.length === 0) {
          tenderList.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-2xl); color: var(--text-muted);">
              <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üîç</div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-xs);">No tenders found</div>
              <div style="font-size: 14px;">Try adjusting your search terms</div>
            </div>
          `;
          return;
        }
        
        filteredTenders.forEach(tender => {
          const tenderCard = document.createElement('div');
          tenderCard.className = 'existing-tender-card';
          tenderCard.onclick = () => selectTenderToClone(tender);
          
          const statusClass = tender.status === 'Published' ? 'success' : 
                              tender.status === 'Draft' ? 'warning' : 'info';
          
          tenderCard.innerHTML = `
            <div class="existing-tender-header">
              <div>
                <div class="existing-tender-title">${tender.title}</div>
                <div class="existing-tender-reference">${tender.reference}</div>
              </div>
              <span class="badge badge-${statusClass}">${tender.status}</span>
            </div>
            <div class="existing-tender-details">
              <div class="existing-tender-meta">
                <span>üìã ${tender.type}</span>
                <span>üí∞ ${tender.value}</span>
                <span>üìÖ ${tender.created}</span>
              </div>
              <div class="existing-tender-template">${tender.template}</div>
            </div>
          `;
          
          tenderList.appendChild(tenderCard);
        });
      }

      // ===== PROCUREMENT LIFECYCLE TRACKER FUNCTIONS =====
      function renderLifecycleTracker(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = `
          <div class="lifecycle-tracker-compact">
            <div class="lifecycle-tracker-compact-header">
              <div class="lifecycle-tracker-compact-title">
                <i class="pi pi-link" style="color: var(--primary-500);"></i>
                <span>Related Procurement Processes</span>
                <span class="lifecycle-count-badge" id="lifecycle-count">${currentLifecycleLinks.length}</span>
              </div>
              <button class="btn btn-sm btn-primary" onclick="openLifecycleSearch()">
                <i class="pi pi-plus"></i> Link Process
                </button>
            </div>
            
            <div id="lifecycle-chain-container">
              ${renderLifecycleChainCompact()}
            </div>
          </div>
        `;
      }

      function renderLifecycleChainCompact() {
        if (currentLifecycleLinks.length === 0) {
          return `
            <div class="lifecycle-empty-compact">
              <span style="color: var(--text-muted); font-size: 13px;">No linked processes. Click "Link Process" to connect related procurement events.</span>
            </div>
          `;
        }

        const linkedHtml = currentLifecycleLinks.map(link => {
          const typeColors = {
            'Requisition': 'var(--info-500)',
            'RFI': 'var(--warning-500)',
            'EOI': 'var(--purple-500)',
            'RFQ': 'var(--success-500)',
            'RFP': 'var(--primary-500)',
            'ITB': 'var(--danger-500)',
            'LTA': 'var(--teal-500)',
            'Contract': 'var(--info-600)'
          };
          const color = typeColors[link.process.type] || 'var(--text-muted)';
          const relationLabel = { predecessor: '‚Üê Before', successor: 'After ‚Üí', related: '‚Üî Related' }[link.relationshipType] || 'Related';

          return `
            <div class="lifecycle-linked-item-compact">
              <div class="lifecycle-type-indicator" style="background: ${color};"></div>
              <div class="lifecycle-linked-info">
                <div class="lifecycle-linked-title">${link.process.type}: ${link.process.id}</div>
                <div class="lifecycle-linked-subtitle">${link.process.title}</div>
              </div>
              <span class="lifecycle-relation-badge">${relationLabel}</span>
              <button class="lifecycle-remove-btn" onclick="removeLifecycleLink('${link.process.id}')" title="Remove">
                <i class="pi pi-times"></i>
              </button>
          </div>
        `;
        }).join('');

        return `<div class="lifecycle-linked-list-compact">${linkedHtml}</div>`;
      }

      function renderLifecycleChain() {
        if (currentLifecycleLinks.length === 0) {
          return `
            <div class="lifecycle-empty-state">
              <div class="lifecycle-empty-state-icon">üîó</div>
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">No linked processes yet</div>
              <div style="font-size: 13px;">Click "Link Process" to connect related procurement events</div>
            </div>
          `;
        }

        // Build lifecycle chain
        const allProcesses = [
          ...currentLifecycleLinks.filter(l => l.relationshipType === 'predecessor').map(l => l.process),
          currentProcessInfo,
          ...currentLifecycleLinks.filter(l => l.relationshipType === 'successor').map(l => l.process)
        ];

        const chainHtml = allProcesses.map((process, index) => {
          const isCurrent = process.id === currentProcessInfo.id;
          const isCompleted = process.status === 'Completed' || process.status === 'Closed';
          const nodeClass = isCurrent ? 'current' : (isCompleted ? 'completed' : 'future');
          
          const icon = {
            'Requisition': 'üìã',
            'RFI': '‚ùì',
            'EOI': '‚úâÔ∏è',
            'RFQ': 'üí∞',
            'RFP': 'üìÑ',
            'ITB': 'üèóÔ∏è',
            'LTA': 'üìú',
            'Contract': 'üìù'
          }[process.type] || 'üìå';

          const arrow = index < allProcesses.length - 1 ? 
            `<div class="lifecycle-arrow ${index < allProcesses.indexOf(currentProcessInfo) ? 'active' : ''}">‚Üí</div>` : '';

          return `
            <div class="lifecycle-node ${nodeClass}" onclick="showProcessDetails('${process.id}')">
              <div class="lifecycle-node-badge">${icon}</div>
              <div class="lifecycle-node-label">${process.type}</div>
              <div class="lifecycle-node-id">${process.id}</div>
            </div>
            ${arrow}
          `;
        }).join('');

        return `<div class="lifecycle-chain">${chainHtml}</div>`;
      }

      function renderLinkedProcesses() {
        if (currentLifecycleLinks.length === 0) {
          return '';
        }

        const processesHtml = currentLifecycleLinks.map(link => {
          const relationshipClass = `relationship-${link.relationshipType}`;
          const relationshipLabel = {
            'predecessor': 'Predecessor',
            'successor': 'Successor',
            'related': 'Related'
          }[link.relationshipType] || 'Related';

          return `
            <div class="linked-process-item">
              <div class="linked-process-info">
                <div class="linked-process-title">
                  ${link.process.title}
                  <span class="lifecycle-relationship-type ${relationshipClass}">${relationshipLabel}</span>
                </div>
                <div class="linked-process-meta">
                  <span>üÜî ${link.process.id}</span>
                  <span>üìã ${link.process.type}</span>
                  <span>üìÖ ${link.process.created}</span>
                  <span>üë§ ${link.process.createdBy}</span>
                </div>
              </div>
              <div class="linked-process-actions">
                <button class="btn-link-action" onclick="viewLinkedProcess('${link.process.id}')">View</button>
                <button class="btn-link-action remove" onclick="removeLifecycleLink('${link.process.id}')">Remove</button>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="linked-processes-list">
            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-md); text-transform: uppercase; letter-spacing: 0.08em;">
              Linked Processes (${currentLifecycleLinks.length})
            </div>
            ${processesHtml}
          </div>
        `;
      }

      function renderAuditTrail() {
        const auditEvents = [
          { action: 'Process created', user: 'Current User', timestamp: new Date().toISOString() },
          ...currentLifecycleLinks.map(link => ({
            action: `Linked to ${link.process.type} (${link.process.id}) as ${link.relationshipType}`,
            user: 'Current User',
            timestamp: link.linkedAt || new Date().toISOString()
          }))
        ];

        if (auditEvents.length === 0) {
          return '<div style="font-size: 13px; color: var(--text-muted);">No audit events yet</div>';
        }

        return auditEvents.map(event => {
          const date = new Date(event.timestamp);
          const timeStr = date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          return `
            <div class="lifecycle-audit-item">
              <span>${event.action}</span>
              <span style="color: var(--text-muted); margin-left: auto;">by ${event.user}</span>
              <span class="lifecycle-audit-timestamp">${timeStr}</span>
            </div>
          `;
        }).join('');
      }

      function openLifecycleSearch() {
        const modal = document.getElementById('lifecycle-search-modal');
        modal.style.display = 'flex';
        loadProcurementProcesses();
      }

      function closeLifecycleSearch() {
        const modal = document.getElementById('lifecycle-search-modal');
        modal.style.display = 'none';
      }

      function loadProcurementProcesses(searchTerm = '') {
        const resultsContainer = document.getElementById('lifecycle-search-results');
        
        let filteredProcesses = procurementProcesses;
        if (searchTerm) {
          filteredProcesses = procurementProcesses.filter(process => {
            const search = searchTerm.toLowerCase();
            return process.id.toLowerCase().includes(search) ||
                   process.title.toLowerCase().includes(search) ||
                   process.type.toLowerCase().includes(search);
          });
        }

        // Exclude already linked processes
        const linkedIds = currentLifecycleLinks.map(l => l.process.id);
        filteredProcesses = filteredProcesses.filter(p => !linkedIds.includes(p.id));

        if (filteredProcesses.length === 0) {
          resultsContainer.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <div style="font-size: 40px; margin-bottom: var(--spacing-md);">üîç</div>
              <div>No processes found</div>
            </div>
          `;
          return;
        }

        resultsContainer.innerHTML = filteredProcesses.map(process => {
          const statusClass = process.status === 'Completed' ? 'success' : 
                             process.status === 'Active' ? 'success' :
                             process.status === 'Published' ? 'info' : 'warning';
          
          return `
            <div class="lifecycle-search-result" onclick="selectProcessToLink('${process.id}')">
              <div class="lifecycle-search-result-title">
                ${process.title}
                <span class="badge badge-${statusClass}" style="margin-left: 8px;">${process.status}</span>
              </div>
              <div class="lifecycle-search-result-meta">
                <span>üÜî ${process.id}</span>
                <span>üìã ${process.type}</span>
                <span>üí∞ ${process.value}</span>
                <span>üìÖ ${process.created}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      function searchLifecycleProcesses(searchTerm) {
        loadProcurementProcesses(searchTerm);
      }

      function selectProcessToLink(processId) {
        const process = procurementProcesses.find(p => p.id === processId);
        if (!process) return;

        // Show relationship type selection
        const relationshipType = prompt(
          `Link "${process.title}" as:\n\n1. Predecessor (this process comes after)\n2. Successor (this process comes before)\n3. Related (parallel or associated process)\n\nEnter 1, 2, or 3:`,
          '1'
        );

        let type = 'related';
        if (relationshipType === '1') type = 'predecessor';
        else if (relationshipType === '2') type = 'successor';
        else if (relationshipType === '3') type = 'related';

        // Add to lifecycle links
        currentLifecycleLinks.push({
          process: process,
          relationshipType: type,
          linkedAt: new Date().toISOString(),
          linkedBy: 'Current User',
          linkType: 'manual' // or 'automatic' for proactive linking
        });

        closeLifecycleSearch();
        refreshLifecycleView();

        // Show success message
        showNotification(`Successfully linked ${process.type} (${process.id})`, 'success');
      }

      function removeLifecycleLink(processId) {
        if (!confirm('Remove this linked process?')) return;

        currentLifecycleLinks = currentLifecycleLinks.filter(link => link.process.id !== processId);
        refreshLifecycleView();
        showNotification('Link removed', 'info');
      }

      function refreshLifecycleView() {
        const chainContainer = document.getElementById('lifecycle-chain-container');
        const countBadge = document.getElementById('lifecycle-count');

        if (chainContainer) chainContainer.innerHTML = renderLifecycleChainCompact();
        if (countBadge) countBadge.textContent = currentLifecycleLinks.length;
      }

      function showProcessDetails(processId) {
        const process = procurementProcesses.find(p => p.id === processId) || 
                       (processId === currentProcessInfo.id ? currentProcessInfo : null);
        
        if (!process) return;

        alert(`Process Details:\n\nID: ${process.id}\nType: ${process.type}\nTitle: ${process.title}\nStatus: ${process.status}\nValue: ${process.value || 'N/A'}\nCreated: ${process.created}\nCreated By: ${process.createdBy}`);
      }

      function viewLinkedProcess(processId) {
        showProcessDetails(processId);
      }

      function showNotification(message, type = 'info') {
        // Simple notification - in real app, use proper toast/notification system
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          padding: 16px 24px;
          background: var(--surface-0);
          border: 1px solid var(--${type === 'success' ? 'success' : 'info'}-400);
          border-left: 4px solid var(--${type === 'success' ? 'success' : 'info'}-500);
          border-radius: 8px;
          box-shadow: var(--shadow-lg);
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      }

      // Proactive linking when creating from existing process
      function linkFromClonedTender(sourceTender) {
        // When a tender is cloned, automatically link it as a successor
        const sourceProcess = procurementProcesses.find(p => p.reference === sourceTender.reference);
        if (sourceProcess) {
          currentLifecycleLinks.push({
            process: sourceProcess,
            relationshipType: 'predecessor',
            linkedAt: new Date().toISOString(),
            linkedBy: 'System (Auto-linked on clone)',
            linkType: 'automatic'
          });
          refreshLifecycleView();
        }
      }

      // ===== WIZARD FUNCTIONS =====
      function initWizard() {
        updateWizardStepDisplay();
        setupWizardEventListeners();
      }

      function setupWizardEventListeners() {
        document.getElementById('wizard-next-btn').addEventListener('click', () => {
          if (validateWizardStep()) {
            if (wizardStep < totalWizardSteps) {
              goToWizardStep(wizardStep + 1);
            } else {
              initiateTender();
            }
          }
        });

        document.getElementById('wizard-prev-btn').addEventListener('click', () => {
          if (wizardStep > 1) {
            goToWizardStep(wizardStep - 1);
          }
        });

        document.getElementById('requirement-type')?.addEventListener('change', collectWizardData);
        document.getElementById('sourcing-type')?.addEventListener('change', collectWizardData);
        document.getElementById('method')?.addEventListener('change', collectWizardData);
        document.getElementById('estimated-value')?.addEventListener('input', collectWizardData);
      }

      function collectWizardData() {
        wizardData = {
          requirementType: document.getElementById('requirement-type')?.value || '',
          sourcingType: document.getElementById('sourcing-type')?.value || '',
          method: document.getElementById('method')?.value || '',
          estimatedValue: document.getElementById('estimated-value')?.value || '',
          projectType: document.getElementById('project-type')?.value || '',
          country: Array.from(document.getElementById('country')?.selectedOptions || []).map(opt => opt.value),
          description: document.getElementById('description')?.value || '',
        };
      }

      function validateWizardStep() {
        if (wizardStep === 1) {
          const requirementType = document.getElementById('requirement-type')?.value;
          const sourcingType = document.getElementById('sourcing-type')?.value;
          const method = document.getElementById('method')?.value;
          const estimatedValue = document.getElementById('estimated-value')?.value;

          if (!requirementType || !sourcingType || !method || !estimatedValue) {
            alert('Please fill in all required fields');
            return false;
          }
          collectWizardData();
          return true;
        } else if (wizardStep === 2) {
          if (!selectedTemplate) {
            alert('Please select a template to continue');
            return false;
          }
          return true;
        } else if (wizardStep === 3) {
          const title = document.getElementById('tender-title')?.value;
          if (!title) {
            alert('Please enter a tender title');
            return false;
          }
          return true;
        }
        return true;
      }

      function goToWizardStep(step) {
        wizardStep = step;

        if (step === 2) {
          collectWizardData();
          suggestTemplates();
        } else if (step === 3) {
          populateReviewStep();
        }

        updateWizardStepDisplay();
      }

      function suggestTemplates() {
        const cardsContainer = document.getElementById('template-cards');
        cardsContainer.innerHTML = '';

        const suggestedTemplates = availableTemplates
          .map((template) => {
            let score = 0;

            if (wizardData.requirementType === 'goods' && template.category === 'Goods') score += 30;
            if (wizardData.requirementType === 'services' && template.category === 'Services') score += 30;
            if (wizardData.requirementType === 'works' && template.category === 'Works') score += 30;
            if (wizardData.requirementType === 'goods-services' && template.category === 'Goods & Services') score += 30;

            const methodMap = {
              itb: 'ITB',
              rfp: 'RFP',
              rfq: 'RFQ',
            };
            if (methodMap[wizardData.method] === template.method) score += 40;

            const value = parseFloat(wizardData.estimatedValue) || 0;
            if (value > 100000 && template.method === 'RFP') score += 20;
            if (value < 50000 && template.method === 'RFQ') score += 20;

            return { ...template, calculatedScore: score };
          })
          .filter((t) => t.calculatedScore > 0)
          .sort((a, b) => b.calculatedScore - a.calculatedScore)
          .slice(0, 3);

        document.getElementById('suggestion-count').textContent = `${suggestedTemplates.length} matches`;

        suggestedTemplates.forEach((template, index) => {
          const card = document.createElement('div');
          card.className = `template-card ${index === 0 ? 'recommended' : ''}`;
          if (index === 0) {
            selectedTemplate = template;
            card.classList.add('selected');
          }
          card.innerHTML = `
            <div class="template-card-header">
              <div class="template-icon">${template.icon}</div>
              <div class="template-info">
                <div class="template-name">${template.name}</div>
                <div class="template-type">${template.type} ¬∑ ${template.category}</div>
              </div>
            </div>
            <div class="template-description">${template.description}</div>
            <div class="template-meta">
              <div class="template-meta-item">
                <span>üìä</span>
                <span>Match: ${template.calculatedScore}%</span>
              </div>
            </div>
          `;

          card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach((c) => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTemplate = template;
          });

          cardsContainer.appendChild(card);
        });
      }

      function populateReviewStep() {
        const methodMap = {
          itb: 'ITB - Invitation to Bid',
          rfp: 'RFP - Request for Proposal',
          rfq: 'RFQ - Request for Quotation',
          eoi: 'EOI - Expression of Interest',
          direct: 'Direct Contracting',
        };

        const requirementMap = {
          goods: 'Goods',
          services: 'Services',
          works: 'Works',
          'goods-services': 'Goods & Services',
        };

        document.getElementById('selected-template-display').value = selectedTemplate?.name || '';
        document.getElementById('review-requirement-type').value = requirementMap[wizardData.requirementType] || '';
        document.getElementById('review-method').value = methodMap[wizardData.method] || '';
        document.getElementById('review-value').value = wizardData.estimatedValue
          ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}`
          : '';
      }

      function updateWizardStepDisplay() {
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.remove('active', 'completed');
          if (stepNum < wizardStep) {
            step.classList.add('completed');
          } else if (stepNum === wizardStep) {
            step.classList.add('active');
          }
        });

        document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
          const stepNum = index + 1;
          content.classList.remove('active');
          if (stepNum === wizardStep) {
            content.classList.add('active');
          }
        });

        const prevBtn = document.getElementById('wizard-prev-btn');
        const nextBtn = document.getElementById('wizard-next-btn');

        prevBtn.style.display = wizardStep > 1 ? 'inline-flex' : 'none';
        nextBtn.textContent = wizardStep === totalWizardSteps ? 'Initiate Tender' : 'Next';
        nextBtn.disabled = false;
      }

      function initiateTender() {
        const title = document.getElementById('tender-title')?.value;
        if (!title) {
          alert('Please enter a tender title');
          return;
        }

        const nextBtn = document.getElementById('wizard-next-btn');
        nextBtn.disabled = true;
        nextBtn.textContent = 'Initiating...';

        // Add title to wizard data
        wizardData.title = title;
        wizardData.template = selectedTemplate;

        // Update current process info for lifecycle tracker
        const methodMap = {
          itb: 'ITB',
          rfp: 'RFP',
          rfq: 'RFQ',
          eoi: 'EOI',
          direct: 'Direct Contracting',
        };
        const currentProcessInfo = {
          id: `${methodMap[wizardData.method] || 'PROC'}-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`,
          type: methodMap[wizardData.method] || 'RFP',
          title: title,
          status: 'Draft',
          value: wizardData.estimatedValue ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}` : 'TBD',
          created: new Date().toISOString().split('T')[0],
          createdBy: 'Current User',
          category: wizardData.requirementType || 'Goods',
        };

        // Save wizard data and process info to localStorage for the authoring page
        const tenderInitData = {
          wizardData: wizardData,
          selectedTemplate: selectedTemplate,
          currentProcessInfo: currentProcessInfo,
          currentLifecycleLinks: currentLifecycleLinks || [],
          initiatedAt: new Date().toISOString()
        };
        localStorage.setItem('tenderInitData', JSON.stringify(tenderInitData));

        // Redirect to authoring page
        setTimeout(() => {
          window.location.href = 'tender-authoring.html';
        }, 500);
      }

      function populateTemplateBlocks() {
        // Pre-populate General Information
        if (templateBlocks[0] && templateBlocks[0].id === 'general') {
          const generalSection = templateBlocks[0].sections[0];
          if (generalSection) {
            const titleField = generalSection.fields.find(f => f.label === 'Title');
            if (titleField && wizardData.title) {
              titleField.value = wizardData.title;
            }

            const sourcingField = generalSection.fields.find(f => f.label === 'Sourcing or Solicitation?');
            if (sourcingField && wizardData.sourcingType) {
              const sourcingValue = wizardData.sourcingType.charAt(0).toUpperCase() + wizardData.sourcingType.slice(1);
              if (sourcingField.options.includes(sourcingValue)) {
                sourcingField.options = [sourcingValue, ...sourcingField.options.filter(o => o !== sourcingValue && o !== 'Select...')];
              }
            }

            const requirementField = generalSection.fields.find(f => f.label === 'Type of Requirement');
            if (requirementField && wizardData.requirementType) {
              const requirementMap = {
                goods: 'Goods',
                services: 'Services',
                works: 'Works',
                'goods-services': 'Goods & Services',
              };
              const requirementValue = requirementMap[wizardData.requirementType] || 'Goods';
              if (requirementField.options.includes(requirementValue)) {
                requirementField.options = [requirementValue, ...requirementField.options.filter(o => o !== requirementValue && o !== 'Select...')];
              }
            }

            const descriptionField = generalSection.fields.find(f => f.label === 'Description');
            if (descriptionField && wizardData.description) {
              descriptionField.value = wizardData.description;
            }
          }
        }

        // Pre-populate Requisition Details
        if (templateBlocks[2] && templateBlocks[2].id === 'requisition' && wizardData.estimatedValue) {
          const requisitionSection = templateBlocks[2].sections[0];
          if (requisitionSection) {
            const valueField = requisitionSection.fields.find(f => f.label === 'Amount/expected value of contract (USD)');
            if (valueField) {
              valueField.value = wizardData.estimatedValue;
            }
          }
        }
      }

      function switchToAuthoringView() {
        currentView = 'authoring';

        // Update UI
        document.getElementById('wizard-view').classList.remove('active');
        document.getElementById('authoring-view').classList.add('active');

        // Update top bar
        document.getElementById('page-title').textContent = 'Procurement Portal | Tender Authoring';
        const methodMap = {
          itb: 'ITB',
          rfp: 'RFP',
          rfq: 'RFQ',
          eoi: 'EOI',
          direct: 'Direct Contracting',
        };
        const requirementMap = {
          goods: 'Goods',
          services: 'Services',
          works: 'Works',
          'goods-services': 'Goods & Services',
        };
        document.getElementById('page-breadcrumbs').textContent = `${methodMap[wizardData.method] || 'Tender'} ¬∑ ${requirementMap[wizardData.requirementType] || 'Goods'} ¬∑ Draft`;

        // Update top actions
        const topActions = document.getElementById('top-actions');
        topActions.innerHTML = `
          <button class="btn btn-ghost">Preview</button>
          <button class="btn btn-ghost">üíæ Save Draft</button>
          <button class="btn btn-ghost" onclick="downloadTenderPackage()" title="Download all documents as ZIP">üì¶ Download Package</button>
          <button class="btn btn-primary">Submit for Review</button>
        `;
        
        // Ensure form library is visible by default
        const formLibraryPanel = document.getElementById('form-library-panel');
        if (formLibraryPanel) {
          formLibraryPanel.classList.remove('collapsed');
        }

        // Initialize authoring
        initAuthoring();
        showSuccessMessage();
      }

      function showSuccessMessage() {
        const contentWrapper = document.getElementById('content-wrapper');
        const successAlert = document.createElement('div');
        successAlert.className = 'info-alert';
        successAlert.style.marginBottom = 'var(--spacing-lg)';
        successAlert.innerHTML = `
          <div class="info-alert-text">
            ‚úÖ Tender "${wizardData.title}" successfully initiated! You can now complete all the details below.
          </div>
        `;
        contentWrapper.insertBefore(successAlert, contentWrapper.firstChild);

        setTimeout(() => {
          successAlert.style.transition = 'opacity 0.3s ease';
          successAlert.style.opacity = '0';
          setTimeout(() => successAlert.remove(), 300);
        }, 5000);
      }

      // ===== FORM LIBRARY FUNCTIONS =====
      function toggleFormLibrary() {
        const panel = document.getElementById('form-library-panel');
        const toggleBtn = panel.querySelector('.toggle-library-btn');
        panel.classList.toggle('collapsed');
        
        if (panel.classList.contains('collapsed')) {
          toggleBtn.textContent = 'üìö';
          toggleBtn.title = 'Expand';
        } else {
          toggleBtn.textContent = '‚úï';
          toggleBtn.title = 'Collapse';
        }
      }

      // ===== DOWNLOAD TENDER PACKAGE =====
      function downloadTenderPackage() {
        // Show loading state
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><span style="animation: spin 1s linear infinite; display: inline-block;">‚è≥</span> Preparing Package...</span>';
        
        // Simulate package preparation (in real implementation, this would:
        // 1. Collect all tender documents
        // 2. Generate PDFs from form data
        // 3. Include uploaded files
        // 4. Create a manifest/index
        // 5. Zip everything together
        // 6. Trigger download)
        setTimeout(() => {
          // Show success notification
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-500);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
          `;
          notification.innerHTML = `
            <span style="font-size: 20px;">‚úÖ</span>
            <div>
              <div style="font-weight: 600; margin-bottom: 2px;">Tender Package Ready</div>
              <div style="font-size: 13px; opacity: 0.9;">tender-package-${Date.now()}.zip</div>
            </div>
          `;
          document.body.appendChild(notification);
          
          // In a real implementation, trigger the actual download here:
          // const link = document.createElement('a');
          // link.href = packageBlobUrl;
          // link.download = `tender-package-${wizardData.tenderId || Date.now()}.zip`;
          // link.click();
          
          // Remove notification after 4 seconds
          setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 4000);
          
          // Reset button
          btn.disabled = false;
          btn.innerHTML = originalText;
        }, 2000);
      }

      function setupFormLibrary() {
        // Setup drag and drop for form library items
        const formItems = document.querySelectorAll('.form-library-item');
        formItems.forEach((item) => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'copy';
            // Use text/* format for cross-browser compatibility
            e.dataTransfer.setData('text/form-type', item.dataset.formType);
            e.dataTransfer.setData('text/form-name', item.dataset.formName);
            // Also set plain text for fallback
            e.dataTransfer.setData('text/plain', item.dataset.formName);
            item.style.opacity = '0.5';
            item.classList.add('dragging');
          });

          item.addEventListener('dragend', (e) => {
            item.style.opacity = '1';
            item.classList.remove('dragging');
          });
          
          // Also add click handler to add to current target category
          item.addEventListener('click', (e) => {
            if (window.currentTargetFormCategory) {
              addLibraryFormToCategory(window.currentTargetFormCategory, {
                type: item.dataset.formType,
                name: item.dataset.formName,
                icon: getFormIconByType(item.dataset.formType)
              });
              window.currentTargetFormCategory = null; // Reset after adding
            }
          });
        });

        // Setup search
        const searchInput = document.getElementById('form-library-search');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            formItems.forEach((item) => {
              const text = item.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                item.style.display = 'block';
              } else {
                item.style.display = 'none';
              }
            });
          });
        }
      }

      function setupDropZones() {
        // Setup drop zones in section bodies and explicit drop zones
        document.querySelectorAll('.section-body, .form-drop-zone').forEach((dropZone) => {
          // Remove existing listeners to avoid duplicates
          const newDropZone = dropZone.cloneNode(true);
          dropZone.parentNode.replaceChild(newDropZone, dropZone);
          
          newDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            newDropZone.classList.add('active');
          });

          newDropZone.addEventListener('dragleave', (e) => {
            if (!newDropZone.contains(e.relatedTarget)) {
              newDropZone.classList.remove('active');
            }
          });

          newDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            newDropZone.classList.remove('active');

            const formType = e.dataTransfer.getData('form-type');
            const formName = e.dataTransfer.getData('form-name');

            if (formType && formName) {
              // If dropped on explicit drop zone, use its parent section body
              const sectionBody = newDropZone.classList.contains('form-drop-zone') 
                ? newDropZone.closest('.section-body') || newDropZone.parentElement
                : newDropZone;
              addFormToSection(sectionBody, formType, formName);
            }
          });
        });
      }

      function addFormToSection(sectionBody, formType, formName) {
        const block = templateBlocks[currentBlockIndex];
        // Find the section index more reliably
        const formSection = sectionBody.closest('.form-section');
        if (!formSection) {
          console.error('Could not find form section');
          return;
        }
        // Get all sections for the current block only
        const contentWrapper = document.getElementById('content-wrapper');
        const allSections = Array.from(contentWrapper.querySelectorAll('.form-section'));
        const sectionIndex = allSections.indexOf(formSection);
        
        if (sectionIndex === -1) {
          console.error('Could not determine section index');
          return;
        }

        // Initialize forms array for this block/section if needed
        if (!addedForms[block.id]) {
          addedForms[block.id] = {};
        }
        if (!addedForms[block.id][sectionIndex]) {
          addedForms[block.id][sectionIndex] = [];
        }

        // Check if form already exists
        const existingForm = addedForms[block.id][sectionIndex].find(f => f.type === formType);
        if (existingForm) {
          alert('This form has already been added to this section');
          return;
        }

        // Add form to storage
        const formData = {
          type: formType,
          name: formName,
          id: `form-${Date.now()}`,
        };
        addedForms[block.id][sectionIndex].push(formData);

        // Create form display element
        const formElement = document.createElement('div');
        formElement.className = 'added-form-item';
        formElement.dataset.formId = formData.id;
        formElement.innerHTML = `
          <div class="added-form-info">
            <div class="added-form-icon">üìÑ</div>
            <div class="added-form-details">
              <div class="added-form-name">${formName}</div>
              <div class="added-form-type">Form Document</div>
            </div>
          </div>
          <div class="added-form-actions">
            <button class="form-action-btn" onclick="previewForm('${formData.id}')" title="Preview">üëÅ</button>
            <button class="form-action-btn danger" onclick="removeForm('${formData.id}')" title="Remove">‚úñ</button>
          </div>
        `;

        // Find or create drop zone
        let dropZone = sectionBody.querySelector('.form-drop-zone');
        if (!dropZone) {
          dropZone = document.createElement('div');
          dropZone.className = 'form-drop-zone';
          dropZone.textContent = 'Drop forms here';
          sectionBody.appendChild(dropZone);
        }

        // Insert form before drop zone
        sectionBody.insertBefore(formElement, dropZone);

        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'info-alert';
        successMsg.style.marginTop = 'var(--spacing-md)';
        successMsg.innerHTML = `
          <div class="info-alert-text">
            ‚úÖ ${formName} added successfully
          </div>
        `;
        sectionBody.insertBefore(successMsg, formElement.nextSibling);

        setTimeout(() => {
          successMsg.style.transition = 'opacity 0.3s ease';
          successMsg.style.opacity = '0';
          setTimeout(() => successMsg.remove(), 300);
        }, 2000);
      }

      function previewForm(formId) {
        // Find form data
        let formData = null;
        for (const blockId in addedForms) {
          for (const sectionIndex in addedForms[blockId]) {
            const form = addedForms[blockId][sectionIndex].find(f => f.id === formId);
            if (form) {
              formData = form;
              break;
            }
          }
          if (formData) break;
        }

        if (formData) {
          alert(`Preview: ${formData.name}\n\nThis would open a preview modal or new window showing the form/document template.`);
        }
      }

      function removeForm(formId) {
        if (!confirm('Remove this form from the tender?')) {
          return;
        }

        // Find and remove form from storage
        for (const blockId in addedForms) {
          for (const sectionIndex in addedForms[blockId]) {
            const index = addedForms[blockId][sectionIndex].findIndex(f => f.id === formId);
            if (index !== -1) {
              addedForms[blockId][sectionIndex].splice(index, 1);
              // Remove from DOM
              const formElement = document.querySelector(`[data-form-id="${formId}"]`);
              if (formElement) {
                formElement.remove();
              }
              return;
            }
          }
        }
      }

      // ===== REQUISITION LINES & LOTS FUNCTIONS =====
      function renderRequisitionLotsSection(block, section, sectionIndex, isFirst) {
        // Calculate totals
        const reqLinesValue = requisitionLines.reduce((sum, line) => sum + line.amount, 0);
        const psValue = productsAndServices.reduce((sum, item) => sum + item.amount, 0);
        const totalProducts = lots.reduce((sum, lot) => sum + lot.unspscCodes.length, 0);
        
        // Determine section visibility based on partial quotations
        const showLotsSection = allowPartialQuotations === 'Yes';
        
        // Calculate pending assignments for lot-based tenders
        const allAssignedCodes = lots.flatMap(l => l.unspscCodes.map(u => u.code));
        const pendingCount = productsAndServices.filter(p => !allAssignedCodes.includes(p.unspscCode)).length;
        const isLotComplete = productsAndServices.length > 0 && pendingCount === 0;
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              <!-- Summary Stats -->
              <div class="summary-stats-row">
                <div class="stat-item">
                  <div class="stat-value">${requisitionLines.length}</div>
                  <div class="stat-label">Req. Lines</div>
              </div>
                <div class="stat-item">
                  <div class="stat-value">${productsAndServices.length}</div>
                  <div class="stat-label">Products/Svc</div>
                </div>
                <div class="stat-item" style="${showLotsSection ? '' : 'opacity: 0.4;'}">
                  <div class="stat-value">${lots.length}</div>
                  <div class="stat-label">Lots</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">$${((reqLinesValue)/1000).toFixed(0)}K</div>
                  <div class="stat-label">Total Value</div>
                </div>
              </div>
              
              <!-- Partial Quotations/Bids/Proposals - Collapsible (FIRST SECTION) -->
              <div class="collapsible-section" id="partial-quotations-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('partial-quotations-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Partial Quotations/Bids/Proposals</span>
                    ${allowPartialQuotations ? `<span class="badge ${allowPartialQuotations === 'Yes' ? 'badge-success' : 'badge-secondary'}" style="margin-left: 8px; font-size: 10px;">${allowPartialQuotations}</span>` : ''}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-group" style="margin: 0;">
                    <label class="form-label">
                      Are partial quotations/bids/proposals allowed? <span class="required">*</span>
                    </label>
                    <div class="radio-group" style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                      <label class="radio-option" style="display: flex; align-items: flex-start; gap: var(--spacing-sm); cursor: pointer; padding: var(--spacing-sm); border: 1px solid var(--surface-300); border-radius: var(--radius-md); transition: all 0.2s ease; ${allowPartialQuotations === 'Yes' ? 'background: var(--primary-50); border-color: var(--primary-500);' : ''}">
                        <input type="radio" name="allowPartialQuotations" value="Yes" ${allowPartialQuotations === 'Yes' ? 'checked' : ''} onchange="updateAllowPartialQuotations(this.value)" style="margin-top: 3px; accent-color: var(--primary-500);">
                        <div style="flex: 1;">
                          <strong style="color: var(--text-primary);">Yes - Partial Quotations Allowed</strong>
                          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Bidders/Offerors shall be allowed to quote prices for one or more lots identified in this tender. However, bidders/offerors must offer 100% of the items specified for each lot and to 100% of the quantities specified for each item of a lot. Evaluation will be done per lot.</div>
                        </div>
                      </label>
                      <label class="radio-option" style="display: flex; align-items: flex-start; gap: var(--spacing-sm); cursor: pointer; padding: var(--spacing-sm); border: 1px solid var(--surface-300); border-radius: var(--radius-md); transition: all 0.2s ease; ${allowPartialQuotations === 'No' ? 'background: var(--primary-50); border-color: var(--primary-500);' : ''}">
                        <input type="radio" name="allowPartialQuotations" value="No" ${allowPartialQuotations === 'No' ? 'checked' : ''} onchange="updateAllowPartialQuotations(this.value)" style="margin-top: 3px; accent-color: var(--primary-500);">
                        <div style="flex: 1;">
                          <strong style="color: var(--text-primary);">No - Partial Quotations NOT Allowed</strong>
                          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Partial bids/proposals shall NOT be allowed. Bidders/Offerors must quote prices for the total goods, services or works for the total requirement. Evaluation will be done for the total requirement.</div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Two-Column Grid: Requisition Lines & Products and Services -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                
                <!-- LEFT COLUMN: Requisition Lines -->
                <div class="collapsible-section" id="req-lines-section" style="margin-top: 0;">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('req-lines-section')">
                  <div class="collapsible-header-left">
                      <span class="collapsible-header-title"><i class="pi pi-list" style="margin-right: 6px;"></i>Requisition Lines</span>
                    <span class="badge badge-info" style="margin-left: 6px; font-size: 10px;">${requisitionLines.length}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                      <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openAddRequisitionLinesModal()"><i class="pi pi-plus"></i> Add</button>
                    <div class="collapsible-toggle">‚ñº</div>
                  </div>
                </div>
                  <div class="collapsible-body" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                    <div style="padding: 0 var(--spacing-sm) var(--spacing-sm); font-size: 11px; color: var(--text-muted); font-style: italic; border-bottom: 1px dashed var(--surface-200); margin-bottom: var(--spacing-sm);">
                      Add requisition lines from ERP. These are your source items.
                    </div>
                  ${requisitionLines.length === 0 ? `
                    <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">
                      <i class="pi pi-inbox" style="font-size: 32px; color: var(--surface-400); margin-bottom: var(--spacing-sm); display: block;"></i>
                      <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">No Requisition Lines</div>
                      <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">Add requisition lines from ERP system</div>
                      <button class="btn btn-primary btn-sm" onclick="openAddRequisitionLinesModal()">
                        <i class="pi pi-plus"></i> Add Requisition Lines
                    </button>
                  </div>
                  ` : `
                    <div id="req-lines-container" style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                      ${requisitionLines.map(line => `
                        <div class="req-line-card" draggable="true" ondragstart="dragReqLine(event, '${line.id}')" data-line-id="${line.id}" style="padding: var(--spacing-sm); background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); cursor: grab; transition: all 0.2s;">
                          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                                <span style="font-family: monospace; font-size: 11px; color: var(--primary-600); font-weight: 600;">${line.unspscCode}</span>
                                <span style="font-size: 10px; color: var(--text-muted);">${line.id}</span>
                              </div>
                              <div style="font-size: 12px; color: var(--text-primary); font-weight: 500; margin-bottom: 2px;">${line.unspscDescription}</div>
                              ${line.description ? `<div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 280px;" title="${line.description.replace(/"/g, '&quot;')}">${line.description}</div>` : ''}
                              <div style="font-size: 10px; color: var(--text-muted);">${line.quantity} ${line.unitOfMeasure} ‚Ä¢ ${line.currency} ${line.amount.toLocaleString()}</div>
                              <div style="font-size: 9px; color: var(--text-muted); margin-top: 3px; display: flex; flex-wrap: wrap; gap: 8px;">
                                <span><i class="pi pi-briefcase" style="font-size: 9px; margin-right: 2px;"></i><strong>WP:</strong> ${line.workPackageGLA || 'N/A'}</span>
                                <span><i class="pi pi-wallet" style="font-size: 9px; margin-right: 2px;"></i><strong>Donor:</strong> ${line.donorFundingSourceGLA || 'N/A'}</span>
                              </div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                              <button class="btn btn-ghost btn-sm" onclick="addReqLineToProductsServices('${line.id}')" title="Add to Products & Services" style="padding: 2px 6px; font-size: 10px;"><i class="pi pi-arrow-right" style="font-size: 10px;"></i></button>
                              <button class="btn btn-ghost btn-sm" onclick="removeRequisitionLine('${line.id}')" title="Remove" style="padding: 2px 6px; font-size: 10px;"><i class="pi pi-trash" style="font-size: 10px; color: var(--danger-500);"></i></button>
                            </div>
                          </div>
                        </div>
                      `).join('')}
                </div>
                  `}
              </div>
                </div>
                
                <!-- RIGHT COLUMN: Products and Services -->
                <div class="collapsible-section" id="products-services-section" style="margin-top: 0;">
                  <div class="collapsible-header" onclick="toggleCollapsibleSection('products-services-section')">
                    <div class="collapsible-header-left">
                      <span class="collapsible-header-title"><i class="pi pi-shopping-cart" style="margin-right: 6px;"></i>Products and Services</span>
                      <span class="badge badge-success" style="margin-left: 6px; font-size: 10px;">${productsAndServices.length}</span>
                      ${showLotsSection && productsAndServices.length > 0 ? (pendingCount > 0 
                        ? `<span class="badge badge-warning" style="margin-left: 4px; font-size: 9px;" title="${pendingCount} item(s) pending lot assignment">${pendingCount} pending</span>` 
                        : `<span class="badge badge-success" style="margin-left: 4px; font-size: 9px;"><i class="pi pi-check" style="font-size: 8px;"></i> All assigned</span>`) : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-xs);">
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); downloadProductsServicesTemplate()" title="Download template"><i class="pi pi-download"></i></button>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('ps-upload-input').click()" title="Upload from template"><i class="pi pi-upload"></i></button>
                      <input type="file" id="ps-upload-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleProductsServicesUpload(event)" />
                      <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openAddProductsServicesModal()"><i class="pi pi-plus"></i> Add</button>
                      <div class="collapsible-toggle">‚ñº</div>
                    </div>
                  </div>
                  <div class="collapsible-body" style="min-height: 200px; max-height: 400px; overflow-y: auto;" ondragover="allowDropToPS(event)" ondragleave="event.currentTarget.style.backgroundColor=''" ondrop="dropToProductsServices(event)">
                    <div style="padding: 0 var(--spacing-sm) var(--spacing-sm); font-size: 11px; color: var(--text-muted); font-style: italic; border-bottom: 1px dashed var(--surface-200); margin-bottom: var(--spacing-sm);">
                      <strong>Supplier-facing items.</strong> Refine your codes here for going to market. Drag from Requisition Lines or create new.
                    </div>
                    ${productsAndServices.length === 0 ? `
                    <div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); border: 2px dashed var(--surface-300); border-radius: var(--radius-md); margin: var(--spacing-sm);">
                      <i class="pi pi-shopping-cart" style="font-size: 32px; color: var(--surface-400); margin-bottom: var(--spacing-sm); display: block;"></i>
                      <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">No Products or Services</div>
                      <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">Drag from Requisition Lines, pick from list, or create new products</div>
                      <button class="btn btn-primary btn-sm" onclick="openAddProductsServicesModal()">
                        <i class="pi pi-plus"></i> Add Products/Services
                      </button>
                    </div>
                    ` : `
                    <div id="products-services-container" style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                      ${productsAndServices.map(item => {
                        const isAssigned = allAssignedCodes.includes(item.unspscCode);
                        const leftBorderColor = showLotsSection ? (isAssigned ? 'var(--success-500)' : 'var(--warning-500)') : 'var(--success-500)';
                        return `
                        <div class="ps-item-card" data-item-id="${item.id}" style="padding: var(--spacing-sm); background: var(--surface-0); border: 1px solid var(--surface-200); border-left: 4px solid ${leftBorderColor}; border-radius: var(--radius-sm); transition: all 0.2s;">
                          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px; flex-wrap: wrap;">
                                <span style="font-family: monospace; font-size: 11px; color: var(--primary-600); font-weight: 600;">${item.unspscCode}</span>
                                ${item.linkedRequisitionId ? `<span style="font-size: 9px; padding: 1px 4px; background: var(--primary-100); color: var(--primary-700); border-radius: 3px;" title="Linked to requisition ${item.linkedRequisitionId}"><i class="pi pi-link" style="font-size: 8px;"></i> ${item.linkedRequisitionId}</span>` : `<span style="font-size: 9px; padding: 1px 4px; background: var(--info-100); color: var(--info-700); border-radius: 3px;"><i class="pi pi-star" style="font-size: 8px;"></i> New</span>`}
                                ${showLotsSection ? (isAssigned 
                                  ? `<span style="font-size: 9px; padding: 1px 4px; background: var(--success-100); color: var(--success-700); border-radius: 3px;"><i class="pi pi-check" style="font-size: 8px;"></i> In Lot</span>`
                                  : `<span style="font-size: 9px; padding: 1px 4px; background: var(--warning-100); color: var(--warning-700); border-radius: 3px;"><i class="pi pi-exclamation-triangle" style="font-size: 8px;"></i> Pending</span>`) : ''}
                              </div>
                              <div style="font-size: 12px; color: var(--text-primary); font-weight: 500; margin-bottom: 2px;">${item.unspscDescription}</div>
                              ${item.description ? `<div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 280px;" title="${item.description.replace(/"/g, '&quot;')}">${item.description}</div>` : ''}
                              <div style="font-size: 10px; color: var(--text-muted);">${item.quantity} ${item.unitOfMeasure} ‚Ä¢ ${item.currency} ${item.amount.toLocaleString()}</div>
                              <div style="font-size: 9px; color: var(--text-muted); margin-top: 3px; display: flex; flex-wrap: wrap; gap: 8px;">
                                <span><i class="pi pi-briefcase" style="font-size: 9px; margin-right: 2px;"></i><strong>WP:</strong> ${item.workPackageGLA || 'N/A'}</span>
                                <span><i class="pi pi-wallet" style="font-size: 9px; margin-right: 2px;"></i><strong>Donor:</strong> ${item.donorFundingSourceGLA || 'N/A'}</span>
                              </div>
                            </div>
                            <div style="display: flex; gap: 4px;">
                              <button class="btn btn-ghost btn-sm" onclick="openEditProductServiceModal('${item.id}')" title="Edit" style="padding: 2px 6px; font-size: 10px;"><i class="pi pi-pencil" style="font-size: 10px; color: var(--primary-600);"></i></button>
                            <button class="btn btn-ghost btn-sm" onclick="removeProductService('${item.id}')" title="Remove" style="padding: 2px 6px; font-size: 10px;"><i class="pi pi-trash" style="font-size: 10px; color: var(--danger-500);"></i></button>
                            </div>
                          </div>
                        </div>
                      `}).join('')}
                    </div>
                    `}
                  </div>
                </div>
              </div>
                
              <!-- Lots Management - Collapsible (only shown when partial quotations = Yes) -->
              ${showLotsSection ? `
              <div class="collapsible-section" id="lots-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('lots-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title"><i class="pi pi-th-large" style="margin-right: 6px;"></i>Lots</span>
                    <span class="badge badge-info" style="margin-left: 6px; font-size: 10px;">${lots.length}</span>
                    ${productsAndServices.length > 0 ? (isLotComplete 
                      ? `<span class="badge badge-success" style="margin-left: 4px; font-size: 9px;"><i class="pi pi-check" style="font-size: 8px;"></i> Complete</span>`
                      : `<span class="badge badge-warning" style="margin-left: 4px; font-size: 9px;">${pendingCount} pending</span>`) : ''}
                  </div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); createLotPerProductService()" title="Create one lot for each product/service"><i class="pi pi-copy"></i> 1 Product = 1 Lot</button>
                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); createMultipleEmptyLots()" title="Create several empty lots"><i class="pi pi-th-large"></i> Create Several</button>
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openCreateLotModal()"><i class="pi pi-plus"></i> New Lot</button>
                    <div class="collapsible-toggle">‚ñº</div>
                  </div>
                </div>
                <div class="collapsible-body">
                  ${pendingCount > 0 ? `
                  <div style="padding: var(--spacing-sm); margin-bottom: var(--spacing-sm); background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: var(--radius-sm); font-size: 11px; color: var(--warning-700); display: flex; align-items: center; gap: 8px;">
                    <i class="pi pi-exclamation-triangle"></i>
                    <span><strong>${pendingCount} item(s)</strong> from Products and Services not yet assigned to lots. All items must be assigned for lot-based bidding.</span>
                  </div>
                  ` : ''}
                  ${lots.length === 0 ? `
                    <div class="lot-empty-state" style="padding: var(--spacing-lg); text-align: center;">
                      <i class="pi pi-th-large" style="font-size: 32px; color: var(--surface-400); margin-bottom: var(--spacing-sm); display: block;"></i>
                      <div style="font-weight: 600; font-size: 13px; margin-bottom: var(--spacing-xs);">No lots created yet</div>
                      <div style="color: var(--text-muted); font-size: 11px; margin-bottom: var(--spacing-md);">Create lots to organize products and services</div>
                      <div style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                        <button class="btn btn-secondary btn-sm" onclick="createLotPerProductService()"><i class="pi pi-copy"></i> 1 Product = 1 Lot</button>
                        <button class="btn btn-primary btn-sm" onclick="openCreateLotModal()"><i class="pi pi-plus"></i> Create Lot</button>
                      </div>
                        </div>
                  ` : `
                    <div style="overflow-x: auto;">
                      <table class="lots-table">
                        <thead>
                          <tr>
                            <th style="width: 60px;">Lot</th>
                            <th style="width: 250px;">Description</th>
                            <th>Products</th>
                            <th style="width: 50px;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${lots.map((lot, lotIndex) => `
                            <tr data-lot-id="${lot.id}">
                              <td><span class="lot-number-badge">${lotIndex + 1}</span></td>
                              <td><span class="lot-desc-cell" title="${lot.description || ''}">${lot.description || '-'}</span></td>
                              <td>
                                <div class="lot-products-cell">
                            ${lot.unspscCodes.length === 0 ? `
                                    <span class="no-products-text">No products</span>
                            ` : `
                                    <div class="product-tags-container">
                                ${lot.unspscCodes.map((unspsc, idx) => `
                                        <div class="product-tag">
                                          <span class="product-tag-code">${unspsc.code}</span>
                                          <span class="product-tag-name" title="${unspsc.description || ''}">${unspsc.description ? unspsc.description.substring(0, 20) + (unspsc.description.length > 20 ? '...' : '') : ''}</span>
                                          ${unspsc.quantity ? `<span class="product-tag-qty">√ó${unspsc.quantity}</span>` : ''}
                                          ${unspsc.estimatedValue ? `<span class="product-tag-value">$${unspsc.estimatedValue.toLocaleString()}</span>` : ''}
                                          <button class="product-tag-remove" onclick="removeProductFromLot('${lot.id}', ${idx})" title="Remove">√ó</button>
                                  </div>
                                `).join('')}
                              </div>
                            `}
                          </div>
                              </td>
                              <td>
                                <div class="lot-actions-menu-wrapper">
                                  <button class="lot-actions-btn" onclick="toggleLotActionsMenu('${lot.id}')" title="Actions">‚ãÆ</button>
                                  <div class="lot-actions-dropdown" id="lot-menu-${lot.id}">
                                    <button class="lot-action-item" onclick="openAddProductModal('${lot.id}')">
                                      <i class="pi pi-plus"></i> Add Products
                                    </button>
                                    <button class="lot-action-item" onclick="openEditLotModal('${lot.id}')">
                                      <i class="pi pi-pencil"></i> Edit Lot
                                    </button>
                                    <button class="lot-action-item danger" onclick="deleteLot('${lot.id}')">
                                      <i class="pi pi-trash"></i> Remove Lot
                                    </button>
                        </div>
                      </div>
                              </td>
                            </tr>
                    `).join('')}
                        </tbody>
                      </table>
                  </div>
                `}
              </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      // Update function for Partial Quotations field
      window.updateAllowPartialQuotations = function(value) {
        allowPartialQuotations = value;
        // Re-render the section to show/hide lots
        renderCurrentBlock();
      }
      
      window.createNewLot = function() {
        const lotDesc = prompt('Enter lot description:');
        if (!lotDesc) return;
        
        const newLot = {
          id: 'lot-' + Date.now(),
          description: lotDesc,
          unspscCodes: [], // Array of { code, description }
        };
        
        lots.push(newLot);
        renderCurrentBlock();
      }
      
      // Create 1 lot per requisition line
      window.createLotPerRequisitionLine = function() {
        if (requisitionLines.length === 0) {
          alert('No requisition lines available to create lots from.');
          return;
        }
        
        const existingLotCount = lots.length;
        let lotsCreated = 0;
        
        requisitionLines.forEach((line, index) => {
          const lotNumber = existingLotCount + index + 1;
          const newLot = {
            id: 'lot-' + Date.now() + '-' + index,
            name: 'Lot ' + lotNumber,
            description: line.description || line.unspscDescription,
            unspscCodes: [{
              code: line.unspscCode,
              description: line.unspscDescription,
              quantity: line.quantity,
              unitOfMeasure: line.unitOfMeasure,
              estimatedValue: line.amount,
              linkedRequisitionId: line.id
            }]
          };
          lots.push(newLot);
          lotsCreated++;
        });
        
        renderCurrentBlock();
        alert(lotsCreated + ' lot(s) created successfully from requisition lines.');
      }
      
      // Add all requisition lines to a single lot
      window.addAllReqToOneLot = function() {
        if (requisitionLines.length === 0) {
          alert('No requisition lines available to create a lot from.');
          return;
        }
        
        // Prompt for lot description with default value
        const defaultDesc = 'Consolidated lot containing all requisition lines (' + requisitionLines.length + ' items)';
        const lotDesc = prompt('Enter description for the consolidated lot:', defaultDesc);
        
        if (!lotDesc) return; // User cancelled
        
        // Calculate total estimated value from all requisition lines
        const totalValue = requisitionLines.reduce((sum, line) => sum + (line.amount || 0), 0);
        
        // Create a single lot with all requisition lines as products
        const newLot = {
          id: 'lot-' + Date.now(),
          description: lotDesc,
          unspscCodes: requisitionLines.map(line => ({
            code: line.unspscCode,
            description: line.unspscDescription,
            quantity: line.quantity,
            unitOfMeasure: line.unitOfMeasure,
            estimatedValue: line.amount,
            linkedRequisitionId: line.id
          }))
        };
        
        lots.push(newLot);
        renderCurrentBlock();
        
        showNotification('Lot created with ' + requisitionLines.length + ' product(s) - Total value: $' + totalValue.toLocaleString(), 'success');
      }
      
      window.updateLotDescription = function(lotId, newDesc) {
        const lot = lots.find(l => l.id === lotId);
        if (lot) {
          lot.description = newDesc;
        }
      }
      
      window.deleteLot = function(lotId) {
        if (!confirm('Are you sure you want to delete this lot?')) {
          return;
        }
        
        lots = lots.filter(l => l.id !== lotId);
        renderCurrentBlock();
      }
      
      // Remove Requisition Line (with cascade delete)
      window.removeRequisitionLine = function(lineId) {
        // Find all products/services linked to this requisition line
        const linkedProducts = productsAndServices.filter(p => p.linkedRequisitionId === lineId);
        const linkedCount = linkedProducts.length;
        
        // Build confirmation message
        let confirmMsg = 'Are you sure you want to remove this requisition line?';
        if (linkedCount > 0) {
          confirmMsg += `\n\nThis will also remove ${linkedCount} linked product(s) from Products and Services and any lot assignments.`;
        }
        
        if (!confirm(confirmMsg)) {
          return;
        }
        
        // Get UNSPSC codes of linked products to remove from lots
        const unspscCodesToRemove = linkedProducts.map(p => p.unspscCode);
        
        // Remove these products from all lots
        lots.forEach(lot => {
          lot.unspscCodes = lot.unspscCodes.filter(u => !unspscCodesToRemove.includes(u.code));
        });
        
        // Remove empty lots
        lots = lots.filter(l => l.unspscCodes.length > 0);
        
        // Remove linked products from Products and Services
        productsAndServices = productsAndServices.filter(p => p.linkedRequisitionId !== lineId);
        
        // Remove the requisition line itself
        requisitionLines = requisitionLines.filter(l => l.id !== lineId);
        
        renderCurrentBlock();
        
        if (linkedCount > 0) {
          showNotification(`Requisition line and ${linkedCount} linked product(s) removed`, 'success');
        } else {
          showNotification('Requisition line removed', 'success');
        }
      }
      
      // ===== PRODUCTS AND SERVICES FUNCTIONS =====
      
      // Add Requisition Line to Products and Services
      window.addReqLineToProductsServices = function(lineId) {
        const reqLine = requisitionLines.find(l => l.id === lineId);
        if (!reqLine) return;
        
        // Check if already in Products and Services
        if (productsAndServices.some(p => p.id === lineId || (p.linkedRequisitionId === lineId))) {
          showNotification('This item is already in Products and Services', 'info');
          return;
        }
        
        // Create a new product/service entry linked to this requisition line
        const newItem = {
          ...reqLine,
          id: 'ps-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
          linkedRequisitionId: lineId
        };
        
        productsAndServices.push(newItem);
        renderCurrentBlock();
        showNotification('Added to Products and Services', 'success');
      }
      
      // Remove Product/Service
      window.removeProductService = function(itemId) {
        if (!confirm('Are you sure you want to remove this item from Products and Services?')) {
          return;
        }
        
        // Also remove from any lots
        const item = productsAndServices.find(p => p.id === itemId);
        if (item) {
          lots.forEach(lot => {
            lot.unspscCodes = lot.unspscCodes.filter(u => u.code !== item.unspscCode);
          });
          // Remove empty lots
          lots = lots.filter(l => l.unspscCodes.length > 0);
        }
        
        productsAndServices = productsAndServices.filter(p => p.id !== itemId);
        renderCurrentBlock();
        showNotification('Removed from Products and Services', 'success');
      }
      
      // Edit Product/Service Modal
      window.openEditProductServiceModal = function(itemId) {
        const item = productsAndServices.find(p => p.id === itemId);
        if (!item) {
          showNotification('Item not found', 'error');
          return;
        }
        
        var modalHtml = '<div class="modal-overlay" id="edit-product-service-modal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;" onclick="closeEditProductServiceModal(event)">' +
          '<div class="modal-container" style="max-width: 550px; width: 95%; background: white; border-radius: 12px; box-shadow: 0 25px 80px rgba(0,0,0,0.3); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">' +
            '<div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid var(--surface-200); background: var(--surface-50); flex-shrink: 0;">' +
              '<div style="display: flex; align-items: center; gap: 12px;">' +
                '<div style="width: 40px; height: 40px; background: var(--primary-500); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;"><i class="pi pi-pencil" style="font-size: 18px;"></i></div>' +
                '<div>' +
                  '<h3 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--text-primary);">Edit Product/Service</h3>' +
                  '<p style="margin: 4px 0 0; font-size: 12px; color: var(--text-secondary);">Modify the details for this item</p>' +
                '</div>' +
              '</div>' +
              '<button style="position: absolute; right: 16px; top: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;" onclick="closeEditProductServiceModal()">&times;</button>' +
            '</div>' +
            '<div class="modal-body" style="padding: 24px; overflow-y: auto; flex: 1;">' +
              '<!-- Read-only UNSPSC info -->' +
              '<div style="padding: 12px 16px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: 8px; margin-bottom: 20px;">' +
                '<div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">UNSPSC Code</div>' +
                '<div style="font-family: monospace; font-size: 14px; color: var(--primary-600); font-weight: 600;">' + item.unspscCode + '</div>' +
              '</div>' +
              '<div class="form-group">' +
                '<label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 13px;">Description <span style="color: var(--danger-500);">*</span></label>' +
                '<input type="text" id="edit-ps-unspsc-desc" value="' + (item.unspscDescription || '').replace(/"/g, '&quot;') + '" style="width: 100%; padding: 10px 12px; border: 1px solid var(--surface-300); border-radius: 8px; font-size: 14px;" placeholder="Product/Service description">' +
              '</div>' +
              '<div class="form-group" style="margin-top: 16px;">' +
                '<label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 13px;">Product Text</label>' +
                '<textarea id="edit-ps-description" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid var(--surface-300); border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="Detailed description of the product or service...">' + (item.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</textarea>' +
              '</div>' +
              '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">' +
                '<div class="form-group">' +
                  '<label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 13px;">Quantity</label>' +
                  '<input type="number" id="edit-ps-quantity" value="' + (item.quantity || 1) + '" min="1" style="width: 100%; padding: 10px 12px; border: 1px solid var(--surface-300); border-radius: 8px; font-size: 14px;">' +
                '</div>' +
                '<div class="form-group">' +
                  '<label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 13px;">Unit of Measure</label>' +
                  '<select id="edit-ps-uom" style="width: 100%; padding: 10px 12px; border: 1px solid var(--surface-300); border-radius: 8px; font-size: 14px; background: white;">' +
                    '<option value="Unit"' + (item.unitOfMeasure === 'Unit' ? ' selected' : '') + '>Unit</option>' +
                    '<option value="Lot"' + (item.unitOfMeasure === 'Lot' ? ' selected' : '') + '>Lot</option>' +
                    '<option value="Set"' + (item.unitOfMeasure === 'Set' ? ' selected' : '') + '>Set</option>' +
                    '<option value="Pack"' + (item.unitOfMeasure === 'Pack' ? ' selected' : '') + '>Pack</option>' +
                    '<option value="Box"' + (item.unitOfMeasure === 'Box' ? ' selected' : '') + '>Box</option>' +
                    '<option value="Piece"' + (item.unitOfMeasure === 'Piece' ? ' selected' : '') + '>Piece</option>' +
                    '<option value="Each"' + (item.unitOfMeasure === 'Each' ? ' selected' : '') + '>Each</option>' +
                    '<option value="Hour"' + (item.unitOfMeasure === 'Hour' ? ' selected' : '') + '>Hour</option>' +
                    '<option value="Day"' + (item.unitOfMeasure === 'Day' ? ' selected' : '') + '>Day</option>' +
                    '<option value="Month"' + (item.unitOfMeasure === 'Month' ? ' selected' : '') + '>Month</option>' +
                  '</select>' +
                '</div>' +
              '</div>' +
              '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">' +
                '<div class="form-group">' +
                  '<label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 13px;">Unit Price</label>' +
                  '<input type="number" id="edit-ps-unit-price" value="' + (item.unitPrice || 0) + '" min="0" step="0.01" style="width: 100%; padding: 10px 12px; border: 1px solid var(--surface-300); border-radius: 8px; font-size: 14px;">' +
                '</div>' +
                '<div class="form-group">' +
                  '<label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-primary); font-size: 13px;">Currency</label>' +
                  '<div style="padding: 10px 12px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: 8px; font-size: 14px; color: var(--text-secondary);">' + (item.currency || 'USD') + '</div>' +
                '</div>' +
              '</div>' +
              (item.linkedRequisitionId ? '<div style="margin-top: 16px; padding: 12px; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: 8px; font-size: 12px; color: var(--primary-700);"><i class="pi pi-link" style="margin-right: 6px;"></i>Linked to Requisition: <strong>' + item.linkedRequisitionId + '</strong></div>' : '') +
            '</div>' +
            '<div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid var(--surface-200); background: var(--surface-50); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0;">' +
              '<button class="btn btn-ghost" style="padding: 10px 20px; border: 1px solid var(--surface-300); background: white; border-radius: 8px; cursor: pointer; font-size: 14px; color: var(--text-primary);" onclick="closeEditProductServiceModal()">Cancel</button>' +
              '<button class="btn btn-primary" style="padding: 10px 20px; border: none; background: var(--primary-500); color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;" onclick="saveEditProductService(\'' + itemId + '\')"><i class="pi pi-check" style="margin-right: 6px;"></i>Save Changes</button>' +
            '</div>' +
          '</div>' +
        '</div>';
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      window.closeEditProductServiceModal = function(event) {
        if (event && event.target !== event.currentTarget) return;
        var modal = document.getElementById('edit-product-service-modal');
        if (modal) modal.remove();
      }
      
      window.saveEditProductService = function(itemId) {
        var item = productsAndServices.find(function(p) { return p.id === itemId; });
        if (!item) {
          showNotification('Item not found', 'error');
          return;
        }
        
        var unspscDesc = document.getElementById('edit-ps-unspsc-desc').value.trim();
        
        if (!unspscDesc) {
          showNotification('Description is required', 'error');
          return;
        }
        
        var quantity = parseInt(document.getElementById('edit-ps-quantity').value) || 1;
        var unitPrice = parseFloat(document.getElementById('edit-ps-unit-price').value) || 0;
        
        // Update editable fields only
        item.unspscDescription = unspscDesc;
        item.description = document.getElementById('edit-ps-description').value.trim();
        item.quantity = quantity;
        item.unitPrice = unitPrice;
        item.amount = quantity * unitPrice;
        item.unitOfMeasure = document.getElementById('edit-ps-uom').value;
        
        // Update description in lots if assigned
        lots.forEach(function(lot) {
          lot.unspscCodes.forEach(function(code) {
            if (code.code === item.unspscCode) {
              code.description = unspscDesc;
            }
          });
        });
        
        closeEditProductServiceModal();
        renderCurrentBlock();
        showNotification('Product/Service updated successfully', 'success');
      }
      
      // Drag and Drop Functions
      window.dragReqLine = function(event, lineId) {
        event.dataTransfer.setData('text/plain', lineId);
        event.dataTransfer.effectAllowed = 'copy';
      }
      
      window.allowDropToPS = function(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy';
        event.currentTarget.style.backgroundColor = 'var(--primary-50)';
      }
      
      window.dropToProductsServices = function(event) {
        event.preventDefault();
        event.currentTarget.style.backgroundColor = '';
        const lineId = event.dataTransfer.getData('text/plain');
        if (lineId) {
          addReqLineToProductsServices(lineId);
        }
      }
      
      // ===== ADD REQUISITION LINES MODAL =====
      let selectedReqLinesForAdd = [];
      let reqLinesAvailableToShow = []; // Store all available lines for filtering
      
      window.openAddRequisitionLinesModal = function() {
        selectedReqLinesForAdd = [];
        
        // Get IDs of requisition lines already added
        const existingIds = requisitionLines.map(l => l.id);
        
        // Filter available lines and store for filtering
        reqLinesAvailableToShow = availableRequisitionLines.filter(l => !existingIds.includes(l.id));
        
        // Reset filter input
        const filterInput = document.getElementById('req-lines-filter-input');
        if (filterInput) filterInput.value = '';
        
        // Render the list
        renderReqLinesModalList(reqLinesAvailableToShow);
        updateReqLinesSelectAllCheckbox();
        updateReqLinesSelectedCount();
        
        // Update total count
        const totalCountEl = document.getElementById('req-lines-total-count');
        if (totalCountEl) {
          totalCountEl.textContent = `${reqLinesAvailableToShow.length} available line(s)`;
        }
        
        document.getElementById('add-req-line-modal').style.display = 'flex';
      }
      
      // Render the list of requisition lines in the modal
      window.renderReqLinesModalList = function(linesToShow) {
        const modalBody = document.getElementById('add-req-line-body');
        if (!modalBody) return;
        
        if (linesToShow.length === 0) {
          modalBody.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); font-size: 12px;"><i class="pi pi-search" style="font-size: 20px; display: block; margin-bottom: 8px;"></i>No matching requisition lines found.</div>';
        } else {
          modalBody.innerHTML = linesToShow.map(line => {
            const isSelected = selectedReqLinesForAdd.some(l => l.id === line.id);
            return `
            <div class="req-line-option ${isSelected ? 'selected' : ''}" data-line-id="${line.id}" data-line='${JSON.stringify(line).replace(/'/g, "&#39;")}'>
              <input type="checkbox" id="req-add-${line.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleReqLineForAdd('${line.id}')" />
              <div class="req-line-details" onclick="toggleReqLineForAdd('${line.id}')">
                <div class="req-line-code">${line.unspscCode}</div>
                <div class="req-line-desc">${line.unspscDescription}</div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                  <strong>${line.id}</strong> ‚Ä¢ ${line.quantity} ${line.unitOfMeasure} ‚Ä¢ ${line.currency} ${line.amount.toLocaleString()}
                </div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">
                  <strong>Work Package:</strong> ${line.workPackageGLA || 'N/A'} ‚Ä¢ <strong>Donor:</strong> ${line.donorFundingSourceGLA || 'N/A'}
                </div>
                <div style="font-size: 10px; color: var(--primary-600); margin-top: 2px;">
                  <i class="pi pi-user" style="font-size: 10px;"></i> ${line.procurementOfficial || 'Not assigned'}
                </div>
              </div>
            </div>
          `}).join('');
        }
      }
      
      // Toggle selection via row or checkbox click
      window.toggleReqLineForAdd = function(lineId) {
        const element = document.querySelector(`.req-line-option[data-line-id="${lineId}"]`);
        if (!element) return;
        
        const checkbox = document.getElementById(`req-add-${lineId}`);
        const lineData = JSON.parse(element.dataset.line.replace(/&#39;/g, "'"));
        
        const existingIndex = selectedReqLinesForAdd.findIndex(l => l.id === lineId);
        if (existingIndex >= 0) {
          selectedReqLinesForAdd.splice(existingIndex, 1);
          element.classList.remove('selected');
          if (checkbox) checkbox.checked = false;
        } else {
          selectedReqLinesForAdd.push(lineData);
          element.classList.add('selected');
          if (checkbox) checkbox.checked = true;
        }
        updateReqLinesSelectAllCheckbox();
        updateReqLinesSelectedCount();
      }
      
      // Filter requisition lines in modal
      window.filterReqLinesModal = function(searchText) {
        const text = searchText.toLowerCase().trim();
        const existingIds = requisitionLines.map(l => l.id);
        let filtered = availableRequisitionLines.filter(l => !existingIds.includes(l.id));
        
        if (text) {
          filtered = filtered.filter(line => 
            line.id.toLowerCase().includes(text) ||
            line.unspscCode.toLowerCase().includes(text) ||
            line.unspscDescription.toLowerCase().includes(text) ||
            (line.description && line.description.toLowerCase().includes(text)) ||
            (line.procurementOfficial && line.procurementOfficial.toLowerCase().includes(text)) ||
            (line.workPackageGLA && line.workPackageGLA.toLowerCase().includes(text)) ||
            (line.donorFundingSourceGLA && line.donorFundingSourceGLA.toLowerCase().includes(text))
          );
        }
        
        reqLinesAvailableToShow = filtered;
        renderReqLinesModalList(filtered);
        updateReqLinesSelectAllCheckbox();
      }
      
      // Select All / Deselect All for visible items
      window.toggleReqLinesSelectAll = function(selectAll) {
        if (selectAll) {
          // Add all visible items to selection
          reqLinesAvailableToShow.forEach(line => {
            if (!selectedReqLinesForAdd.some(l => l.id === line.id)) {
              selectedReqLinesForAdd.push(line);
            }
          });
        } else {
          // Remove all visible items from selection
          reqLinesAvailableToShow.forEach(line => {
            const idx = selectedReqLinesForAdd.findIndex(l => l.id === line.id);
            if (idx >= 0) selectedReqLinesForAdd.splice(idx, 1);
          });
        }
        renderReqLinesModalList(reqLinesAvailableToShow);
        updateReqLinesSelectAllCheckbox();
        updateReqLinesSelectedCount();
      }
      
      // Update select all checkbox state
      window.updateReqLinesSelectAllCheckbox = function() {
        const selectAllCheckbox = document.getElementById('req-lines-select-all');
        if (selectAllCheckbox && reqLinesAvailableToShow.length > 0) {
          const allSelected = reqLinesAvailableToShow.every(line => selectedReqLinesForAdd.some(l => l.id === line.id));
          const someSelected = reqLinesAvailableToShow.some(line => selectedReqLinesForAdd.some(l => l.id === line.id));
          selectAllCheckbox.checked = allSelected;
          selectAllCheckbox.indeterminate = someSelected && !allSelected;
        } else if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
      }
      
      // Update selected count display
      window.updateReqLinesSelectedCount = function() {
        const countEl = document.getElementById('req-lines-selected-count');
        if (countEl) {
          countEl.textContent = selectedReqLinesForAdd.length > 0 ? `${selectedReqLinesForAdd.length} selected` : '';
        }
      }
      
      window.closeAddRequisitionLinesModal = function() {
        document.getElementById('add-req-line-modal').style.display = 'none';
        selectedReqLinesForAdd = [];
        reqLinesAvailableToShow = [];
      }
      
      window.addSelectedRequisitionLines = function() {
        if (selectedReqLinesForAdd.length === 0) {
          showNotification('Please select at least one requisition line', 'warning');
          return;
        }
        
        requisitionLines = [...requisitionLines, ...selectedReqLinesForAdd];
        closeAddRequisitionLinesModal();
        renderCurrentBlock();
        showNotification(`Added ${selectedReqLinesForAdd.length} requisition line(s)`, 'success');
      }
      
      // ===== LOT CREATION FUNCTIONS =====
      
      // Create 1 Lot per Product/Service
      window.createLotPerProductService = function() {
        if (productsAndServices.length === 0) {
          showNotification('No products/services available. Add items to Products and Services first.', 'warning');
          return;
        }
        
        // Get products not yet assigned to any lot
        const allAssignedCodes = lots.flatMap(l => l.unspscCodes.map(u => u.code));
        const unassignedProducts = productsAndServices.filter(p => !allAssignedCodes.includes(p.unspscCode));
        
        if (unassignedProducts.length === 0) {
          showNotification('All products/services are already assigned to lots.', 'info');
          return;
        }
        
        // Create one lot per unassigned product
        unassignedProducts.forEach((product, index) => {
          const lotNumber = lots.length + index + 1;
          lots.push({
            id: 'lot-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
            name: `Lot ${lotNumber}`,
            description: product.unspscDescription,
            unspscCodes: [{
              code: product.unspscCode,
              description: product.unspscDescription
            }]
          });
        });
        
        renderCurrentBlock();
        showNotification(`Created ${unassignedProducts.length} lot(s)`, 'success');
      }
      
      // Create Multiple Empty Lots
      window.createMultipleEmptyLots = function() {
        const count = prompt('How many empty lots would you like to create?', '3');
        if (!count || isNaN(parseInt(count)) || parseInt(count) <= 0) {
          return;
        }
        
        const numLots = parseInt(count);
        for (let i = 0; i < numLots; i++) {
          const lotNumber = lots.length + i + 1;
          lots.push({
            id: 'lot-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5) + i,
            name: `Lot ${lotNumber}`,
            description: '',
            unspscCodes: []
          });
        }
        
        renderCurrentBlock();
        showNotification(`Created ${numLots} empty lot(s)`, 'success');
      }
      
      // ===== LEGACY FUNCTION UPDATED =====
      window.createLotPerRequisitionLine = function() {
        // Redirect to new function
        createLotPerProductService();
      }
      
      // Download Lots Template
      window.downloadLotsTemplate = function() {
        // Create CSV template content
        const templateHeaders = ['Lot Description', 'UNSPSC Code', 'Product Description', 'Quantity', 'Estimated Value (USD)'];
        const exampleRows = [
          ['All IT hardware items', '43211503', 'Laptop computers', '50', '75000'],
          ['All IT hardware items', '43212105', 'Computer monitors', '50', '15000'],
          ['General office supplies', '44121700', 'Office supplies', '100', '5000'],
          ['Office furniture items', '56101500', 'Office desks', '25', '12500'],
        ];
        
        // Build CSV content
        let csvContent = templateHeaders.join(',') + '\n';
        csvContent += '# Instructions: Fill in the rows below. Each row represents one product in a lot.\n';
        csvContent += '# Products with the same Lot Description will be grouped into the same lot.\n';
        csvContent += '# Delete these instruction lines before uploading.\n';
        exampleRows.forEach(row => {
          csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });
        
        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'lots_template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Template downloaded! Fill it out and upload to bulk import lots.', 'success');
      }
      
      // Handle Lots Upload
      window.handleLotsUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            
            if (lines.length < 2) {
              alert('The file appears to be empty or invalid. Please use the template format.');
              return;
            }
            
            // Skip header row
            const dataLines = lines.slice(1);
            const lotsMap = new Map(); // Group by lot description
            
            dataLines.forEach(line => {
              // Parse CSV line (handle quoted values)
              const values = line.match(/("([^"]*)"|[^,]+)/g);
              if (!values || values.length < 3) return;
              
              // Clean values (remove quotes)
              const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
              
              const [lotDesc, unspscCode, productDesc, quantity, estimatedValue] = cleanValues;
              
              if (!lotDesc || !unspscCode) return;
              
              if (!lotsMap.has(lotDesc)) {
                lotsMap.set(lotDesc, {
                  id: 'lot-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                  description: lotDesc,
                  unspscCodes: []
                });
              }
              
              const lot = lotsMap.get(lotDesc);
              lot.unspscCodes.push({
                code: unspscCode,
                description: productDesc || '',
                quantity: parseInt(quantity) || 1,
                estimatedValue: parseFloat(estimatedValue) || 0
              });
            });
            
            if (lotsMap.size === 0) {
              alert('No valid lots found in the file. Please check the format.');
              return;
            }
            
            // Show preview modal
            openLotsUploadPreviewModal(Array.from(lotsMap.values()));
            
          } catch (error) {
            console.error('Error parsing file:', error);
            alert('Error reading the file. Please make sure it is a valid CSV file.');
          }
        };
        
        reader.readAsText(file);
        
        // Reset the input so the same file can be uploaded again
        event.target.value = '';
      }
      
      // Lots Upload Preview Modal
      let pendingLotsUpload = [];
      
      window.openLotsUploadPreviewModal = function(lotsData) {
        pendingLotsUpload = lotsData;
        
        const modal = document.getElementById('lots-upload-preview-modal');
        const body = document.getElementById('lots-upload-preview-body');
        
        let totalProducts = lotsData.reduce((sum, lot) => sum + lot.unspscCodes.length, 0);
        let totalValue = lotsData.reduce((sum, lot) => 
          sum + lot.unspscCodes.reduce((s, p) => s + (p.estimatedValue || 0), 0), 0);
        
        body.innerHTML = `
          <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--info-50); border-radius: var(--radius-sm); font-size: 12px;">
            <strong>Summary:</strong> ${lotsData.length} lot(s), ${totalProducts} product(s), $${totalValue.toLocaleString()} total value
          </div>
          <div style="max-height: 300px; overflow-y: auto;">
            ${lotsData.map((lot, idx) => `
              <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm); overflow: hidden;">
                <div style="background: var(--surface-50); padding: var(--spacing-sm) var(--spacing-md); border-bottom: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600; font-size: 13px;">${lot.description || 'No description'}</span>
                  </div>
                  <span style="font-size: 11px; color: var(--text-muted);">${lot.unspscCodes.length} product(s)</span>
                </div>
                <div style="padding: var(--spacing-sm);">
                  <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${lot.unspscCodes.map(p => `
                      <span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--surface-100); border-radius: 12px; font-size: 10px;">
                        <span style="font-family: monospace; color: var(--primary-600); font-weight: 600;">${p.code}</span>
                        <span style="color: var(--text-secondary);">${p.description ? p.description.substring(0, 15) + (p.description.length > 15 ? '...' : '') : ''}</span>
                        <span style="color: var(--text-muted);">√ó${p.quantity}</span>
                      </span>
                    `).join('')}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        modal.style.display = 'flex';
      }
      
      window.closeLotsUploadPreviewModal = function() {
        document.getElementById('lots-upload-preview-modal').style.display = 'none';
        pendingLotsUpload = [];
      }
      
      window.confirmLotsUpload = function() {
        if (pendingLotsUpload.length === 0) return;
        
        // Add all uploaded lots
        lots = [...lots, ...pendingLotsUpload];
        
        closeLotsUploadPreviewModal();
        renderCurrentBlock();
        showNotification(`Successfully imported ${pendingLotsUpload.length} lot(s)!`, 'success');
      }
      
      // ===== PRODUCTS AND SERVICES TEMPLATE DOWNLOAD/UPLOAD =====
      
      // Download Products and Services Template
      window.downloadProductsServicesTemplate = function() {
        // Create CSV template content
        const templateHeaders = ['UNSPSC Code', 'UNSPSC Description', 'Description', 'Quantity', 'Unit of Measure', 'Currency', 'Unit Price', 'Amount', 'Work Package (GLA)', 'Donor/Funding Source (GLA)', 'Procurement Official'];
        const exampleRows = [
          ['43211503', 'Laptop computers', 'Laptop computers for office use', '50', 'Unit', 'USD', '500', '25000', 'WP-2024-IT-001', 'UNDP Core Funds', 'John Smith'],
          ['43212105', 'Computer monitors', '27-inch monitors for office', '50', 'Unit', 'USD', '300', '15000', 'WP-2024-IT-002', 'USAID Grant', 'Sarah Johnson'],
          ['81111812', 'Network installation service', 'Network installation and configuration', '1', 'Service', 'USD', '5000', '5000', 'WP-2024-SVC-001', 'Multi-Donor Fund', 'Emma Wilson'],
        ];
        
        // Build CSV content
        let csvContent = templateHeaders.join(',') + '\n';
        csvContent += '# Instructions: Fill in the rows below. Each row represents one product or service.\n';
        csvContent += '# UNSPSC Code and UNSPSC Description are required fields.\n';
        csvContent += '# Amount should equal Quantity x Unit Price.\n';
        csvContent += '# Delete these instruction lines before uploading.\n';
        exampleRows.forEach(row => {
          csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });
        
        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'products_services_template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Template downloaded! Fill it out and upload to bulk import products and services.', 'success');
      }
      
      // Handle Products and Services Upload
      window.handleProductsServicesUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            
            if (lines.length < 2) {
              alert('The file appears to be empty or invalid. Please use the template format.');
              return;
            }
            
            // Skip header row
            const dataLines = lines.slice(1);
            const productsToImport = [];
            
            dataLines.forEach((line, index) => {
              // Parse CSV line (handle quoted values)
              const values = line.match(/("([^"]*)"|[^,]+)/g);
              if (!values || values.length < 2) return;
              
              // Clean values (remove quotes)
              const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
              
              const [unspscCode, unspscDescription, description, quantity, unitOfMeasure, currency, unitPrice, amount, workPackageGLA, donorFundingSourceGLA, procurementOfficial] = cleanValues;
              
              if (!unspscCode || !unspscDescription) return;
              
              productsToImport.push({
                id: 'IMPORT-' + Date.now() + '-' + index,
                unspscCode: unspscCode,
                unspscDescription: unspscDescription,
                description: description || unspscDescription,
                quantity: parseInt(quantity) || 1,
                unitOfMeasure: unitOfMeasure || 'Unit',
                currency: currency || 'USD',
                unitPrice: parseFloat(unitPrice) || 0,
                amount: parseFloat(amount) || (parseInt(quantity) || 1) * (parseFloat(unitPrice) || 0),
                workPackageGLA: workPackageGLA || '',
                donorFundingSourceGLA: donorFundingSourceGLA || '',
                procurementOfficial: procurementOfficial || 'Not assigned'
              });
            });
            
            if (productsToImport.length === 0) {
              alert('No valid products found in the file. Please check the format.');
              return;
            }
            
            // Show preview modal
            openProductsServicesUploadPreviewModal(productsToImport);
            
          } catch (error) {
            console.error('Error parsing file:', error);
            alert('Error reading the file. Please make sure it is a valid CSV file.');
          }
        };
        
        reader.readAsText(file);
        
        // Reset the input so the same file can be uploaded again
        event.target.value = '';
      }
      
      // Products and Services Upload Preview Modal
      let pendingProductsServicesUpload = [];
      
      window.openProductsServicesUploadPreviewModal = function(productsData) {
        pendingProductsServicesUpload = productsData;
        
        const modal = document.getElementById('products-services-upload-preview-modal');
        const body = document.getElementById('products-services-upload-preview-body');
        
        let totalValue = productsData.reduce((sum, p) => sum + (p.amount || 0), 0);
        
        body.innerHTML = `
          <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--info-50); border-radius: var(--radius-sm); font-size: 12px;">
            <strong>Summary:</strong> ${productsData.length} product(s)/service(s), $${totalValue.toLocaleString()} total value
          </div>
          <div style="max-height: 300px; overflow-y: auto;">
            <table class="req-table" style="font-size: 11px;">
              <thead>
                <tr>
                  <th>UNSPSC</th>
                  <th>Description</th>
                  <th>Qty</th>
                  <th>UoM</th>
                  <th>Amount</th>
                  <th>Work Package</th>
                  <th>Donor/Funding</th>
                </tr>
              </thead>
              <tbody>
                ${productsData.map(p => `
                  <tr>
                    <td><span style="font-family: monospace; color: var(--primary-600); font-weight: 600;">${p.unspscCode}</span></td>
                    <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${p.unspscDescription}">${p.unspscDescription}</td>
                    <td>${p.quantity}</td>
                    <td>${p.unitOfMeasure}</td>
                    <td>${p.currency} ${p.amount.toLocaleString()}</td>
                    <td style="font-size: 10px;">${p.workPackageGLA || '-'}</td>
                    <td style="font-size: 10px;">${p.donorFundingSourceGLA || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        modal.style.display = 'flex';
      }
      
      window.closeProductsServicesUploadPreviewModal = function() {
        document.getElementById('products-services-upload-preview-modal').style.display = 'none';
        pendingProductsServicesUpload = [];
      }
      
      window.confirmProductsServicesUpload = function() {
        if (pendingProductsServicesUpload.length === 0) return;
        
        // Add all uploaded products to requisitionLines
        requisitionLines = [...requisitionLines, ...pendingProductsServicesUpload];
        
        closeProductsServicesUploadPreviewModal();
        renderCurrentBlock();
        showNotification(`Successfully imported ${pendingProductsServicesUpload.length} product(s)/service(s)!`, 'success');
      }
      
      // Lot actions menu toggle
      window.toggleLotActionsMenu = function(lotId) {
        // Close all other menus first
        document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
          if (menu.id !== 'lot-menu-' + lotId) {
            menu.classList.remove('show');
          }
        });
        
        const menu = document.getElementById('lot-menu-' + lotId);
        if (menu) {
          menu.classList.toggle('show');
        }
      }
      
      // Close menus when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.lot-actions-menu-wrapper')) {
          document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });
      
      // Open Add Product Modal
      let currentLotIdForProduct = null;
      let selectedReqLinesForProduct = [];
      
      window.openAddProductModal = function(lotId) {
        currentLotIdForProduct = lotId;
        selectedReqLinesForProduct = [];
        
        // Close any open menus
        document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
          menu.classList.remove('show');
        });
        
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        // Populate product options from Products and Services section
        const reqLinesBody = document.getElementById('add-product-req-lines');
        if (reqLinesBody) {
          // Filter out items already assigned to ANY lot (not just this one)
          const allAssignedCodes = lots.flatMap(l => l.unspscCodes.map(u => u.code));
          const linesToShow = productsAndServices.filter(item => !allAssignedCodes.includes(item.unspscCode));
          
          if (productsAndServices.length === 0) {
            reqLinesBody.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); font-size: 12px;"><i class="pi pi-info-circle" style="font-size: 20px; display: block; margin-bottom: 8px;"></i>No products available. Please add products to the Products and Services section first.</div>';
          } else if (linesToShow.length === 0) {
            reqLinesBody.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); font-size: 12px;"><i class="pi pi-check-circle" style="font-size: 20px; display: block; margin-bottom: 8px; color: var(--success-500);"></i>All products from Products and Services have been assigned to lots.</div>';
          } else {
            reqLinesBody.innerHTML = linesToShow.map(item => `
              <div class="req-line-option" onclick="toggleReqLineForProduct('${item.unspscCode}', this)" data-line='${JSON.stringify(item).replace(/'/g, "&#39;")}'>
                <input type="checkbox" id="req-${item.unspscCode}" onclick="event.stopPropagation(); toggleReqLineForProduct('${item.unspscCode}', this.closest('.req-line-option'))" />
                <div class="req-line-details">
                  <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                    <span class="req-line-code">${item.unspscCode}</span>
                    ${item.linkedRequisitionId ? `<span style="font-size: 9px; padding: 1px 4px; background: var(--primary-100); color: var(--primary-700); border-radius: 3px;"><i class="pi pi-link" style="font-size: 8px;"></i> ${item.linkedRequisitionId}</span>` : `<span style="font-size: 9px; padding: 1px 4px; background: var(--info-100); color: var(--info-700); border-radius: 3px;"><i class="pi pi-star" style="font-size: 8px;"></i> New</span>`}
                  </div>
                  <div class="req-line-desc">${item.unspscDescription}</div>
                  <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">${item.quantity} ${item.unitOfMeasure} ‚Ä¢ ${item.currency} ${item.amount.toLocaleString()}</div>
                  <div style="font-size: 10px; color: var(--primary-600); margin-top: 2px;">
                    <i class="pi pi-user" style="font-size: 10px;"></i> ${item.procurementOfficial || 'Not assigned'}
                  </div>
                </div>
              </div>
            `).join('');
          }
        }
        
        // Show modal
        document.getElementById('add-product-modal').style.display = 'flex';
      }
      
      window.closeAddProductModal = function() {
        document.getElementById('add-product-modal').style.display = 'none';
        currentLotIdForProduct = null;
        selectedReqLinesForProduct = [];
      }
      
      window.switchProductModalTab = function(tabId) {
        document.querySelectorAll('.product-modal-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === tabId);
        });
        document.querySelectorAll('.product-modal-tab-content').forEach(content => {
          content.classList.toggle('active', content.id === 'tab-' + tabId);
          });
        
        // Update button based on tab
        const confirmBtn = document.getElementById('add-product-confirm-btn');
        if (confirmBtn) {
          if (tabId === 'from-requisition') {
            confirmBtn.textContent = 'Add Selected';
            confirmBtn.onclick = addProductsFromRequisition;
          } else {
            confirmBtn.textContent = 'Create Product';
            confirmBtn.onclick = addNewProduct;
          }
        }
      }
      
      // Handle linked requisition selection (link only, no auto-populate)
      window.populateFromLinkedRequisition = function(reqId) {
        // Link only - no auto-populate of form fields
        // The linked requisition ID is stored when the product is created
      }
      
      window.toggleReqLineForProduct = function(unspscCode, element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const isSelected = selectedReqLinesForProduct.includes(unspscCode);
        
        if (isSelected) {
          selectedReqLinesForProduct = selectedReqLinesForProduct.filter(c => c !== unspscCode);
          element.classList.remove('selected');
          checkbox.checked = false;
        } else {
          selectedReqLinesForProduct.push(unspscCode);
          element.classList.add('selected');
          checkbox.checked = true;
        }
      }
      
      window.addProductsFromRequisition = function() {
        if (!currentLotIdForProduct || selectedReqLinesForProduct.length === 0) {
          alert('Please select at least one product.');
          return;
        }
        
        const lot = lots.find(l => l.id === currentLotIdForProduct);
        if (!lot) return;
        
        let addedCount = 0;
        selectedReqLinesForProduct.forEach(unspscCode => {
          // Look in productsAndServices (the right column container)
          const item = productsAndServices.find(p => p.unspscCode === unspscCode);
          if (item && !lot.unspscCodes.some(u => u.code === unspscCode)) {
            lot.unspscCodes.push({ 
              code: item.unspscCode,
              description: item.unspscDescription,
              quantity: item.quantity,
              unitOfMeasure: item.unitOfMeasure,
              estimatedValue: item.amount,
              procurementOfficial: item.procurementOfficial,
              linkedRequisitionId: item.linkedRequisitionId || item.id
            });
            addedCount++;
          }
        });
        
        closeAddProductModal();
        renderCurrentBlock();
        showNotification(`Added ${addedCount} product(s) to lot`, 'success');
      }
      
      window.addNewProduct = function() {
        if (!currentLotIdForProduct) return;
        
        const lot = lots.find(l => l.id === currentLotIdForProduct);
        if (!lot) return;
        
        const unspsc = document.getElementById('new-product-unspsc').value.trim();
        const desc = document.getElementById('new-product-desc').value.trim();
        const qty = parseInt(document.getElementById('new-product-qty').value) || 1;
        const uom = document.getElementById('new-product-uom').value || 'Unit';
        const value = parseFloat(document.getElementById('new-product-value').value) || 0;
        const linkedReqId = document.getElementById('new-product-linked-req').value || null;
        
        if (!unspsc) {
          showNotification('Please enter a UNSPSC code.', 'warning');
          return;
        }
        
        if (lot.unspscCodes.some(u => u.code === unspsc)) {
          showNotification('This UNSPSC code is already in the lot.', 'warning');
          return;
        }
        
        // Get procurement official from linked requisition if selected
        let procurementOfficial = 'Not assigned';
        if (linkedReqId) {
          const linkedLine = availableRequisitionLines.find(l => l.id === linkedReqId);
          if (linkedLine && linkedLine.procurementOfficial) {
            procurementOfficial = linkedLine.procurementOfficial;
          }
        }
        
        lot.unspscCodes.push({ 
          code: unspsc,
          description: desc,
          quantity: qty,
          unitOfMeasure: uom,
          estimatedValue: value,
          procurementOfficial: procurementOfficial,
          linkedRequisitionId: linkedReqId
        });
        
        closeAddProductModal();
        renderCurrentBlock();
        showNotification(`Added "${desc || unspsc}" to lot`, 'success');
      }
      
      // Edit Lot Modal
      window.openEditLotModal = function(lotId) {
        // Close any open menus
        document.querySelectorAll('.lot-actions-dropdown').forEach(menu => {
          menu.classList.remove('show');
        });
        
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        document.getElementById('edit-lot-id').value = lotId;
        document.getElementById('edit-lot-desc-input').value = lot.description || '';
        
        document.getElementById('edit-lot-modal').style.display = 'flex';
      }
      
      window.closeEditLotModal = function() {
        document.getElementById('edit-lot-modal').style.display = 'none';
            }
      
      window.saveEditLot = function() {
        const lotId = document.getElementById('edit-lot-id').value;
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        lot.description = document.getElementById('edit-lot-desc-input').value.trim();
        
        closeEditLotModal();
        renderCurrentBlock();
      }
      
      window.addProductsToLot = function(lotId) {
        openAddProductModal(lotId);
      }
      
      window.removeProductFromLot = function(lotId, index) {
        const lot = lots.find(l => l.id === lotId);
        if (lot && index >= 0 && index < lot.unspscCodes.length) {
          lot.unspscCodes.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      window.editLot = function(lotId) {
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        // In real app, would open a modal for editing
        const newDesc = prompt('Enter new lot description:', lot.description);
        if (newDesc && newDesc !== lot.description) {
          lot.description = newDesc;
          renderCurrentBlock();
        }
      }

      // ===== SECTION PROGRESS INDICATOR =====
      function renderSectionProgress(sectionType, items) {
        let completed = 0;
        let total = items ? items.length : 0;
        
        if (sectionType === 'product-req' && items) {
          items.forEach(item => {
            const req = productRequirements[item.code];
            if (req && req.requirementType && (req.attributes.length > 0 || req.description)) {
              completed++;
            }
          });
        } else if (sectionType === 'req-lines') {
          completed = requisitionLines.length;
          total = requisitionLines.length > 0 ? requisitionLines.length : 1;
        } else if (sectionType === 'lots') {
          completed = lots.filter(l => l.unspscCodes.length > 0).length;
          total = lots.length > 0 ? lots.length : 1;
        } else if (sectionType === 'project-info') {
          total = 4;
          completed = 0;
        } else if (sectionType === 'particulars') {
          total = 10;
          completed = 0;
        } else if (sectionType === 'scope-objectives') {
          total = 1;
          completed = 0;
        } else if (sectionType === 'other-req') {
          total = 2;
          completed = tenderAuthorConfig.serviceDescriptions.length > 0 ? 1 : 0;
          completed += tenderAuthorConfig.specificRequirements.length > 0 ? 1 : 0;
        } else if (sectionType === 'key-dates') {
          total = 3;
          completed = 0;
        } else if (sectionType === 'contract-provisions') {
          total = 7;
          completed = 0;
          if (contractProvisionsValues.generalConditions) completed++;
          if (contractProvisionsValues.specialConditions) completed++;
          if (contractProvisionsValues.sampleContract) completed++;
          if (contractProvisionsValues.contractClausesKPIs) completed++;
          if (contractProvisionsValues.contractClausesDrive) completed++;
          if (contractProvisionsValues.performanceSecurityRequired) completed++;
          if (contractProvisionsValues.advancePaymentRequired) completed++;
        } else if (sectionType === 'competition-type') {
          total = 1;
          completed = competitionValues.competitionType ? 1 : 0;
        } else if (sectionType === 'vendor-notification') {
          total = 3;
          completed = 0;
          if (competitionValues.ungmVendors.length > 0) completed++;
          if (competitionValues.unregisteredEmail) completed++;
          if (competitionValues.unregisteredCompanyName) completed++;
        } else if (sectionType === 'market-research') {
          total = 2;
          completed = 0;
          if (competitionValues.marketResearchDetails) completed++;
          if (competitionValues.effectiveCompetitionDetails) completed++;
        } else if (sectionType === 'limited-justification') {
          total = 1;
          completed = competitionValues.limitedCompetitionJustification ? 1 : 0;
        } else if (sectionType === 'direct-contracting') {
          total = 3;
          completed = 0;
          if (competitionValues.directContractingReason) completed++;
          if (competitionValues.linkedProcess) completed++;
          if (competitionValues.directContractingJustification) completed++;
        } else if (sectionType === 'team-procurement') {
          total = 3;
          completed = 0;
          if (teamMembers.procurementReviewer) completed++;
          if (teamMembers.procurementAuthority) completed++;
          if (teamMembers.technicalExperts && teamMembers.technicalExperts.length > 0) completed++;
        } else if (sectionType === 'team-evaluation') {
          total = 2;
          completed = 0;
          if (teamMembers.bidOpeningPanel.length > 0) completed++;
          if (teamMembers.evaluationTeam.length > 0) completed++;
        }
        
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        const color = percentage === 100 ? 'var(--success-500)' : percentage > 50 ? 'var(--warning-500)' : 'var(--surface-300)';
        
        return `
          <div class="section-progress" style="margin-left: 12px; display: flex; align-items: center; gap: 6px;">
            <div class="progress-bar-mini" style="width: 50px; height: 5px; background: var(--surface-200); border-radius: 3px; overflow: hidden;">
              <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 3px;"></div>
            </div>
            <span style="font-size: 10px; color: var(--text-muted);">${completed}/${total}</span>
          </div>
        `;
      }
      
      // ===== COMPETITION BLOCK =====
      
      // Helper function to render UNGM eligibility status badge
      function renderUNGMEligibilityBadge(status) {
        if (!status) {
          return '<span class="ungm-status-badge ungm-status-clear"><i class="pi pi-check-circle"></i> Clear</span>';
        }
        
        const statusConfig = {
          'Ineligibility_or_Debarment': { 
            class: 'ungm-status-sanction', 
            icon: 'pi-ban', 
            label: 'Sanction',
            title: 'Ineligibility or Debarment - Supplier is ineligible or debarred'
          },
          'Ineligible_for_registration': { 
            class: 'ungm-status-sanction', 
            icon: 'pi-ban', 
            label: 'Sanction',
            title: 'Ineligible for Registration - Supplier cannot be registered'
          },
          'Censure': { 
            class: 'ungm-status-censure', 
            icon: 'pi-exclamation-triangle', 
            label: 'Censure',
            title: 'Censure - Mildest form of sanction, does not affect eligibility but is an aggravating factor for future sanctions'
          },
          'Vendor_Performance_Issues': { 
            class: 'ungm-status-performance', 
            icon: 'pi-chart-line', 
            label: 'Performance',
            title: 'Vendor Performance Issues - Check UNGM Guidelines for supplier performance flag details'
          },
          'Potentially_Ineligible_Vendors': { 
            class: 'ungm-status-potential', 
            icon: 'pi-question-circle', 
            label: 'Potential',
            title: 'Potentially Ineligible - Potential match with an ineligible supplier. Click vendor name to verify.'
          },
          'Other': { 
            class: 'ungm-status-other', 
            icon: 'pi-info-circle', 
            label: 'Other',
            title: 'Other status - Review UNGM for details'
          }
        };
        
        const config = statusConfig[status] || statusConfig['Other'];
        return '<span class="ungm-status-badge ' + config.class + '" title="' + config.title + '"><i class="pi ' + config.icon + '"></i> ' + config.label + '</span>';
      }
      
      // Helper function to render UNGM Status Info Box (now returns empty - replaced by header tooltip)
      function renderUNGMStatusInfoBox() {
        return '';
      }
      
      // Helper function to render UNGM Status column header with tooltip
      function renderUNGMStatusHeader() {
        return '<div class="ungm-status-header">' +
          '<i class="pi pi-shield" style="margin-right: 4px;"></i>UNGM Status' +
          '<i class="pi pi-question-circle ungm-info-trigger"></i>' +
          '<div class="ungm-tooltip">' +
            '<div class="ungm-tooltip-title">UNGM Eligibility Status Guide</div>' +
            '<div class="ungm-tooltip-legend">' +
              '<div class="ungm-tooltip-item"><span class="ungm-status-badge ungm-status-sanction"><i class="pi pi-ban"></i> Sanction</span> Ineligibility/Debarment</div>' +
              '<div class="ungm-tooltip-item"><span class="ungm-status-badge ungm-status-censure"><i class="pi pi-exclamation-triangle"></i> Censure</span> Mild sanction</div>' +
              '<div class="ungm-tooltip-item"><span class="ungm-status-badge ungm-status-potential"><i class="pi pi-question-circle"></i> Potential</span> Potential ineligible match</div>' +
              '<div class="ungm-tooltip-item"><span class="ungm-status-badge ungm-status-performance"><i class="pi pi-chart-line"></i> Performance</span> Performance issues</div>' +
              '<div class="ungm-tooltip-item"><span class="ungm-status-badge ungm-status-clear"><i class="pi pi-check-circle"></i> Clear</span> No issues</div>' +
            '</div>' +
            '<div class="ungm-tooltip-footer"><i class="pi pi-info-circle" style="margin-right: 4px;"></i>Click vendor name for details. Contact UNGM if in doubt.</div>' +
          '</div>' +
        '</div>';
      }
      
      // Helper function to render Vendor Notification Section (always visible)
      function renderVendorNotificationSection() {
        
        // Build vendors table rows using string concatenation to avoid template literal nesting issues
        let vendorRows = '';
        const allVendors = competitionValues.notificationVendors || [];
        const vendors = filterVendorList(allVendors);
        const page = competitionValues.vendorListPage || 1;
        const startIdx = (page - 1) * 10;
        const endIdx = page * 10;
        const pagedVendors = vendors.slice(startIdx, endIdx);
        
        // Count vendors with eligibility issues (from all vendors, not filtered)
        const vendorsWithIssues = allVendors.filter(v => v.eligibilityStatus && v.eligibilityStatus !== 'null').length;
        
        pagedVendors.forEach((vendor, idx) => {
          // Find the original index in allVendors for actions
          const globalIdx = allVendors.findIndex(v => v.email === vendor.email && v.companyName === vendor.companyName);
          const sourceClass = vendor.source === 'UNGM' ? 'badge-primary' : 
            (vendor.source === 'Ad-hoc Shortlist' || vendor.source === 'Sourcing Outcome' || vendor.source === 'Tender Vendors' || vendor.source === 'Shortlist') ? 'badge-info' : 
            vendor.source === 'Manual' ? 'badge-success' : 'badge-warning';
          vendorRows += '<tr style="border-bottom: 1px solid var(--surface-100);">' +
            '<td style="padding: 10px 12px; color: var(--text-primary);">' +
              (vendor.ungmId ? '<a href="#" onclick="event.stopPropagation(); openUNGMVendorDetails(\'' + vendor.ungmId + '\')" style="color: var(--primary-600); text-decoration: none; font-weight: 500;" title="Click to view UNGM details">' + (vendor.companyName || '-') + '</a>' : (vendor.companyName || '-')) +
            '</td>' +
            '<td style="padding: 10px 12px; color: var(--text-secondary);">' + (vendor.email || '-') + '</td>' +
            '<td style="padding: 10px 12px; color: var(--text-secondary);">' + (vendor.ungmId || '-') + '</td>' +
            '<td style="padding: 10px 12px;">' + renderUNGMEligibilityBadge(vendor.eligibilityStatus) + '</td>' +
            '<td style="padding: 10px 12px;"><span class="badge ' + sourceClass + '" style="font-size: 10px;">' + (vendor.source || 'Unknown') + '</span></td>' +
            '<td style="padding: 10px 12px; text-align: center;">' + (vendor.notified ? '<span class="badge badge-success" style="font-size: 10px;">Yes</span>' : '<span class="badge badge-secondary" style="font-size: 10px;">No</span>') + '</td>' +
            '<td style="padding: 10px 12px; text-align: center; white-space: nowrap;">' +
              (vendor.notified ? '' : '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); notifyVendor(' + globalIdx + ')" style="color: var(--primary-500); padding: 4px;" title="Send notification"><i class="pi pi-send"></i></button>') +
              '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); removeNotificationVendor(' + globalIdx + ')" style="color: var(--danger-500); padding: 4px;" title="Remove vendor"><i class="pi pi-times"></i></button>' +
            '</td>' +
          '</tr>';
        });
        
        // Build pagination
        let pagination = '';
        const isFiltered = competitionValues.vendorListFilter && competitionValues.vendorListFilter.length > 0;
        if (vendors.length > 0) {
          const totalPages = Math.max(1, Math.ceil(vendors.length / 10));
          const showing = vendors.length > 0 ? (startIdx + 1) + ' - ' + Math.min(endIdx, vendors.length) : '0';
          const filterInfo = isFiltered ? ' (filtered from ' + allVendors.length + ')' : '';
          pagination = '<div style="background: var(--surface-50); padding: var(--spacing-sm) var(--spacing-md); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--surface-200);">' +
            '<div style="font-size: 12px; color: var(--text-secondary);">Showing ' + showing + ' of ' + vendors.length + ' vendors' + filterInfo + '</div>' +
            '<div style="display: flex; align-items: center; gap: 4px;">' +
              '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); changeVendorListPage(\'prev\')" ' + (page === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '') + '><i class="pi pi-chevron-left"></i></button>' +
              '<span style="font-size: 12px; color: var(--text-secondary); padding: 0 8px;">Page ' + page + ' of ' + totalPages + '</span>' +
              '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); changeVendorListPage(\'next\')" ' + (page >= totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '') + '><i class="pi pi-chevron-right"></i></button>' +
            '</div>' +
          '</div>';
        }
        
        // Build table content
        let tableContent = '';
        if (vendors.length > 0) {
          tableContent = '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">' +
            '<thead style="background: var(--surface-50);"><tr>' +
              '<th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Company Name</th>' +
              '<th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Email</th>' +
              '<th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">UNGM ID</th>' +
              '<th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">' + renderUNGMStatusHeader() + '</th>' +
              '<th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Source</th>' +
              '<th style="padding: 10px 12px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Notified</th>' +
              '<th style="padding: 10px 12px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 60px;">Action</th>' +
            '</tr></thead>' +
            '<tbody id="notification-vendors-tbody">' + vendorRows + '</tbody>' +
          '</table>';
        } else {
          tableContent = '<div style="padding: var(--spacing-xl); text-align: center; color: var(--text-muted);">' +
            '<i class="pi pi-inbox" style="font-size: 36px; color: var(--surface-300); display: block; margin-bottom: var(--spacing-sm);"></i>' +
            '<div style="font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px;">No vendors added yet</div>' +
            '<div style="font-size: 12px;">Use one of the methods above to add vendors</div>' +
          '</div>';
        }
        
        const unnotifiedCount = vendors.filter(v => !v.notified).length;
        const notifyAllBtn = unnotifiedCount > 0 ? '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); notifyAllVendors()" style="font-size: 11px;"><i class="pi pi-send"></i> Notify All (' + unnotifiedCount + ')</button>' : '';
        const clearAllBtn = vendors.length > 0 ? '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); clearAllNotificationVendors()" style="color: var(--danger-500); font-size: 11px;"><i class="pi pi-trash"></i> Clear All</button>' : '';
        
        return '<div class="collapsible-section collapsed" id="vendor-notification-section" style="margin-top: var(--spacing-md);">' +
          '<div class="collapsible-header" onclick="toggleCollapsibleSection(\'vendor-notification-section\')">' +
            '<div class="collapsible-header-left">' +
              '<span class="collapsible-header-title">Vendor Notification</span>' +
              '<span class="badge badge-info" style="margin-left: 8px; font-size: 10px;">' + vendors.length + ' vendors</span>' +
            '</div>' +
            '<div class="collapsible-toggle">‚ñº</div>' +
          '</div>' +
          '<div class="collapsible-body" onclick="event.stopPropagation()">' +
            '<div style="margin-bottom: var(--spacing-md);">' +
              '<h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600; color: var(--text-primary);">Add Vendors to Notify</h4>' +
              '<p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Choose one of the methods below to add vendors to the notification list</p>' +
            '</div>' +
            '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">' +
              '<div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">' +
                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">' +
                  '<div style="width: 32px; height: 32px; background: var(--primary-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;"><i class="pi pi-globe" style="color: var(--primary-600); font-size: 14px;"></i></div>' +
                  '<div><div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Search UNGM</div><div style="font-size: 11px; color: var(--text-secondary);">Find registered vendors</div></div>' +
                '</div>' +
                '<div style="position: relative;">' +
                  '<input type="text" class="form-input" placeholder="Search by vendor name or ID..." style="padding-left: 36px; font-size: 13px;" id="ungm-vendor-search" onclick="event.stopPropagation()" onkeyup="searchUNGMVendors(this.value)" />' +
                  '<i class="pi pi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;"></i>' +
                '</div>' +
                '<div id="ungm-search-results" style="display: none; position: absolute; z-index: 100; background: white; border: 1px solid var(--surface-300); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto; width: calc(100% - 32px); margin-top: 4px;"></div>' +
              '</div>' +
              (competitionValues.competitionType !== 'Direct contracting' ? 
              '<div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">' +
                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">' +
                  '<div style="width: 32px; height: 32px; background: var(--info-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;"><i class="pi pi-list" style="color: var(--info-600); font-size: 14px;"></i></div>' +
                  '<div><div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">From Vendor List</div><div style="font-size: 11px; color: var(--text-secondary);">Add vendors from existing lists</div></div>' +
                '</div>' +
                '<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">' +
                  '<label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; border: 1px solid var(--surface-200); border-radius: 16px; background: white; font-size: 12px; color: var(--text-primary);" onclick="event.stopPropagation(); selectShortlistType(\'adhoc\')">' +
                    '<input type="radio" name="shortlistTypeInline" value="adhoc" style="accent-color: var(--primary-500); margin: 0; width: 14px; height: 14px;" onclick="event.stopPropagation(); selectShortlistType(\'adhoc\')" />' +
                    'Ad-hoc Shortlist' +
                  '</label>' +
                  '<label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; border: 1px solid var(--surface-200); border-radius: 16px; background: white; font-size: 12px; color: var(--text-primary);" onclick="event.stopPropagation(); selectShortlistType(\'sourcing\')">' +
                    '<input type="radio" name="shortlistTypeInline" value="sourcing" style="accent-color: var(--primary-500); margin: 0; width: 14px; height: 14px;" onclick="event.stopPropagation(); selectShortlistType(\'sourcing\')" />' +
                    'Sourcing Exercise Outcome' +
                  '</label>' +
                  '<label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; border: 1px solid var(--surface-200); border-radius: 16px; background: white; font-size: 12px; color: var(--text-primary);" onclick="event.stopPropagation(); selectShortlistType(\'tender\')">' +
                    '<input type="radio" name="shortlistTypeInline" value="tender" style="accent-color: var(--primary-500); margin: 0; width: 14px; height: 14px;" onclick="event.stopPropagation(); selectShortlistType(\'tender\')" />' +
                    'Existing Tender Vendors' +
                  '</label>' +
                '</div>' +
                '<div id="shortlist-search-container-inline" style="display: none;">' +
                  '<div style="position: relative;">' +
                    '<input type="text" class="form-input" id="shortlist-search-input-inline" placeholder="Search list by name..." style="padding-left: 36px; font-size: 13px; margin-bottom: 8px;" onclick="event.stopPropagation()" onkeyup="filterShortlistOptions(this.value)" onfocus="showShortlistDropdown()" />' +
                    '<i class="pi pi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px; margin-top: -4px;"></i>' +
                  '</div>' +
                  '<div id="shortlist-dropdown-inline" style="display: none; position: relative; z-index: 100; background: white; border: 1px solid var(--surface-300); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto;"></div>' +
                '</div>' +
              '</div>' : '') +
              '<div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">' +
                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">' +
                  '<div style="width: 32px; height: 32px; background: var(--success-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;"><i class="pi pi-user-plus" style="color: var(--success-600); font-size: 14px;"></i></div>' +
                  '<div><div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Add Manually</div><div style="font-size: 11px; color: var(--text-secondary);">Unregistered suppliers</div></div>' +
                '</div>' +
                '<div style="display: flex; flex-direction: column; gap: 8px;">' +
                  '<input type="text" class="form-input" placeholder="Company name *" style="font-size: 13px;" id="manual-vendor-company" onclick="event.stopPropagation()" />' +
                  '<input type="email" class="form-input" placeholder="Email address *" style="font-size: 13px;" id="manual-vendor-email" onclick="event.stopPropagation()" />' +
                  '<button class="btn btn-success btn-sm" onclick="event.stopPropagation(); addManualVendor()" style="align-self: flex-start;"><i class="pi pi-plus"></i> Add Vendor</button>' +
                '</div>' +
              '</div>' +
              (competitionValues.competitionType !== 'Direct contracting' ?
              '<div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">' +
                '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">' +
                  '<div style="width: 32px; height: 32px; background: var(--warning-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;"><i class="pi pi-upload" style="color: var(--warning-600); font-size: 14px;"></i></div>' +
                  '<div><div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Bulk Upload</div><div style="font-size: 11px; color: var(--text-secondary);">Import from spreadsheet</div></div>' +
                '</div>' +
                '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
                  '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); downloadVendorNotificationTemplate()" title="Download template"><i class="pi pi-download"></i> Template</button>' +
                  '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); document.getElementById(\'vendor-upload-input\').click()" title="Upload vendor list"><i class="pi pi-upload"></i> Upload File</button>' +
                  '<input type="file" id="vendor-upload-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleVendorListUpload(event)" />' +
                '</div>' +
                '<div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Accepts .xlsx, .xls, .csv</div>' +
              '</div>' : '') +
            '</div>' +
            renderUNGMStatusInfoBox() +
            '<div style="border: 1px solid var(--surface-200); border-radius: var(--radius-lg); overflow: hidden;">' +
              '<div style="background: var(--surface-100); padding: var(--spacing-sm) var(--spacing-md); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--surface-200);">' +
                '<div style="display: flex; align-items: center; gap: 8px;">' +
                  '<i class="pi pi-users" style="color: var(--text-secondary);"></i>' +
                  '<span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Vendors</span>' +
                  '<span class="badge badge-primary" style="font-size: 10px;">' + (isFiltered ? vendors.length + '/' + allVendors.length : allVendors.length) + '</span>' +
                  (isFiltered ? '<span class="badge badge-info" style="font-size: 9px;"><i class="pi pi-filter" style="font-size: 8px;"></i> Filtered</span>' : '') +
                  (vendorsWithIssues > 0 ? '<span class="badge badge-danger" style="font-size: 10px;" title="' + vendorsWithIssues + ' vendor(s) with eligibility issues"><i class="pi pi-exclamation-triangle" style="font-size: 9px;"></i> ' + vendorsWithIssues + ' flagged</span>' : '') +
                '</div>' +
                '<div style="display: flex; align-items: center; gap: 8px;">' +
                  '<div style="display: flex; align-items: center; gap: 4px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: 2px;">' +
                    '<select id="vendor-filter-field" class="form-input" style="font-size: 11px; padding: 4px 8px; border: none; background: transparent; min-width: 90px;" onclick="event.stopPropagation()" onchange="applyVendorFilter()">' +
                      '<option value="all">All Fields</option>' +
                      '<option value="companyName">Company</option>' +
                      '<option value="email">Email</option>' +
                      '<option value="ungmId">UNGM ID</option>' +
                      '<option value="eligibilityStatus">Status</option>' +
                      '<option value="source">Source</option>' +
                      '<option value="notified">Notified</option>' +
                    '</select>' +
                    '<input type="text" id="vendor-filter-value" class="form-input" placeholder="Filter..." style="font-size: 11px; padding: 4px 8px; width: 120px; border: none; border-left: 1px solid var(--surface-200);" onclick="event.stopPropagation()" onkeyup="applyVendorFilter()" />' +
                  '</div>' +
                  (competitionValues.vendorListFilter ? '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); clearVendorFilter()" style="color: var(--text-muted); padding: 4px;" title="Clear filter"><i class="pi pi-times"></i></button>' : '') +
                  notifyAllBtn +
                  clearAllBtn +
                '</div>' +
              '</div>' +
              '<div style="overflow-x: auto;">' + tableContent + '</div>' +
              pagination +
            '</div>' +
          '</div>' +
        '</div>';
      }
      
      function renderCompetitionBlock(block) {
        const isOpenOrLimited = ['Open competition', 'Limited competition'].includes(competitionValues.competitionType);
        const isLimited = competitionValues.competitionType === 'Limited competition';
        const isDirect = competitionValues.competitionType === 'Direct contracting';
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              
              <!-- Competition Type Section - Collapsible -->
              <div class="collapsible-section collapsed" id="competition-type-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('competition-type-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Competition Type</span>
                    ${renderSectionProgress('competition-type', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group">
                      <label class="form-label">Vendor competition type <span class="required">*</span></label>
                      <select class="form-select" onchange="updateCompetitionType(this.value)" onclick="event.stopPropagation()" required>
                        <option value="">Select...</option>
                        <option value="Open competition" ${competitionValues.competitionType === 'Open competition' ? 'selected' : ''}>Open competition</option>
                        <option value="Limited competition" ${competitionValues.competitionType === 'Limited competition' ? 'selected' : ''}>Limited competition</option>
                        <option value="Direct contracting" ${competitionValues.competitionType === 'Direct contracting' ? 'selected' : ''}>Direct contracting</option>
                      </select>
                      <span class="help-text">Select the type of vendor competition for this tender</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Competition Details Section - Collapsible (visible when competition type is selected) -->
              ${competitionValues.competitionType ? `
              <div class="collapsible-section collapsed" id="competition-details-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('competition-details-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Competition Details</span>
                    ${renderSectionProgress('competition-details', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    
                    <!-- Market Research fields (visible for Open and Limited) -->
                    ${isOpenOrLimited ? `
                    <div class="form-group full-width">
                      <label class="form-label">Details on market research and outreach <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Describe the market research conducted and outreach efforts..." style="min-height: 100px;" onchange="updateCompetitionValue('marketResearchDetails', this.value)" onclick="event.stopPropagation()" required>${competitionValues.marketResearchDetails}</textarea>
                      <span class="help-text">Required for Open and Limited competition types</span>
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Details on how you intend to achieve effective competition <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Explain how effective competition will be achieved..." style="min-height: 100px;" onchange="updateCompetitionValue('effectiveCompetitionDetails', this.value)" onclick="event.stopPropagation()" required>${competitionValues.effectiveCompetitionDetails}</textarea>
                      <span class="help-text">Describe strategies to ensure competitive process</span>
                    </div>
                    ` : ''}
                    
                    <!-- Limited Competition Justification field (visible for Limited only) -->
                    ${isLimited ? `
                    <div class="form-group full-width">
                      <label class="form-label">Justification for reason for limited competition <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Provide detailed justification for selecting limited competition..." style="min-height: 120px;" onchange="updateCompetitionValue('limitedCompetitionJustification', this.value)" onclick="event.stopPropagation()" required>${competitionValues.limitedCompetitionJustification}</textarea>
                      <span class="help-text">Explain why limited competition is appropriate for this procurement</span>
                    </div>
                    ` : ''}
                    
                    <!-- Direct Contracting fields (visible for Direct only) -->
                    ${isDirect ? `
                    <div class="form-group full-width">
                      <label class="form-label">Reason for direct contracting under UNOPS Financial Rule 118.05(a) <span class="required">*</span></label>
                      <select class="form-select" onchange="updateCompetitionValue('directContractingReason', this.value)" onclick="event.stopPropagation()" required>
                        <option value="">Select a reason...</option>
                        <option value="ii" ${competitionValues.directContractingReason === 'ii' ? 'selected' : ''}>(ii) There is no competitive marketplace for the requirement, such as where a monopoly exists; where prices are fixed by legislation or government regulation; or where the requirement involves a proprietary product or service</option>
                        <option value="iii" ${competitionValues.directContractingReason === 'iii' ? 'selected' : ''}>(iii) There has been a previous determination with regard to an identical procurement activity, or there is a need to standardize the requirement following recent procurement activity</option>
                        <option value="iv" ${competitionValues.directContractingReason === 'iv' ? 'selected' : ''}>(iv) The proposed procurement contract is the result of cooperation with other organizations of the United Nations system, pursuant to Rule 118.02 (c) or governments and organizations other than those of the United Nations system, pursuant to Rule 118.02 (d)</option>
                        <option value="v" ${competitionValues.directContractingReason === 'v' ? 'selected' : ''}>(v) Offers for identical requirements have been obtained competitively within a reasonable period and the prices and conditions offered by the proposed contractor remain competitive</option>
                        <option value="vi" ${competitionValues.directContractingReason === 'vi' ? 'selected' : ''}>(vi) A formal solicitation has not produced satisfactory results within a reasonable prior period</option>
                        <option value="vii" ${competitionValues.directContractingReason === 'vii' ? 'selected' : ''}>(vii) The proposed procurement contract is for the purchase or lease of real property</option>
                        <option value="viii" ${competitionValues.directContractingReason === 'viii' ? 'selected' : ''}>(viii) There is a genuine exigency for the requirement</option>
                        <option value="ix" ${competitionValues.directContractingReason === 'ix' ? 'selected' : ''}>(ix) The proposed procurement contract relates to obtaining services that cannot be evaluated objectively</option>
                        <option value="x" ${competitionValues.directContractingReason === 'x' ? 'selected' : ''}>(x) The ECPO or authorized personnel otherwise determine that a formal solicitation will not give satisfactory results including, but not limited to, the situations where the proposed contractor is pre-selected by the funding source pursuant to Rule 118.02 (e)</option>
                      </select>
                      <span class="help-text">Select the applicable reason per UNOPS Financial Rules</span>
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Justification for reason for direct contracting selected above <span class="required">*</span></label>
                      <textarea class="form-textarea" placeholder="Provide detailed justification for direct contracting..." style="min-height: 120px;" onchange="updateCompetitionValue('directContractingJustification', this.value)" onclick="event.stopPropagation()" required>${competitionValues.directContractingJustification}</textarea>
                      <span class="help-text">Provide comprehensive justification supporting the selected reason</span>
                    </div>
                    ` : ''}
                    
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Vendor Notification Section - Collapsible (always visible) -->
              <div class="collapsible-section collapsed" id="vendor-notification-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('vendor-notification-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Vendor Notification</span>
                    <span class="badge badge-info" style="margin-left: 8px; font-size: 10px;">${competitionValues.notificationVendors ? competitionValues.notificationVendors.length : 0} vendors</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  
                  <!-- Add Vendors Section Header -->
                  <div style="margin-bottom: var(--spacing-md);">
                    <h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600; color: var(--text-primary);">Add Vendors to Notify</h4>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Choose one of the methods below to add vendors to the notification list</p>
                  </div>
                  
                  <!-- 4 Methods Grid -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    
                    <!-- Method 1: Search UNGM Vendor -->
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">
                        <div style="width: 32px; height: 32px; background: var(--primary-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                          <i class="pi pi-globe" style="color: var(--primary-600); font-size: 14px;"></i>
                        </div>
                        <div>
                          <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Search UNGM</div>
                          <div style="font-size: 11px; color: var(--text-secondary);">Find registered vendors</div>
                        </div>
                      </div>
                      <div style="position: relative;">
                        <input type="text" class="form-input" placeholder="Search by vendor name or ID..." style="padding-left: 36px; font-size: 13px;" id="ungm-vendor-search" onclick="event.stopPropagation()" onkeyup="searchUNGMVendors(this.value)" />
                        <i class="pi pi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;"></i>
                      </div>
                      <!-- UNGM Search Results Dropdown -->
                      <div id="ungm-search-results" style="display: none; position: absolute; z-index: 100; background: white; border: 1px solid var(--surface-300); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto; width: calc(100% - 32px); margin-top: 4px;">
                      </div>
                    </div>
                    
                    <!-- Method 2: Search from Shortlist (hidden for Direct contracting) -->
                    ${!isDirect ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">
                        <div style="width: 32px; height: 32px; background: var(--info-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                          <i class="pi pi-list" style="color: var(--info-600); font-size: 14px;"></i>
                        </div>
                        <div>
                          <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">From Vendor List</div>
                          <div style="font-size: 11px; color: var(--text-secondary);">Add vendors from existing lists</div>
                        </div>
                      </div>
                      
                      <!-- Radio buttons for list type selection -->
                      <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; border: 1px solid var(--surface-200); border-radius: 16px; background: white; font-size: 12px; color: var(--text-primary); transition: all 0.15s ease;" onclick="event.stopPropagation(); selectShortlistType('adhoc')" onmouseover="this.style.borderColor='var(--primary-300)'; this.style.background='var(--primary-50)'" onmouseout="if(!this.querySelector('input').checked){this.style.borderColor='var(--surface-200)'; this.style.background='white'}">
                          <input type="radio" name="shortlistType" value="adhoc" style="accent-color: var(--primary-500); margin: 0; width: 14px; height: 14px;" onclick="event.stopPropagation(); selectShortlistType('adhoc')" />
                          Ad-hoc Shortlist
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; border: 1px solid var(--surface-200); border-radius: 16px; background: white; font-size: 12px; color: var(--text-primary); transition: all 0.15s ease;" onclick="event.stopPropagation(); selectShortlistType('sourcing')" onmouseover="this.style.borderColor='var(--primary-300)'; this.style.background='var(--primary-50)'" onmouseout="if(!this.querySelector('input').checked){this.style.borderColor='var(--surface-200)'; this.style.background='white'}">
                          <input type="radio" name="shortlistType" value="sourcing" style="accent-color: var(--primary-500); margin: 0; width: 14px; height: 14px;" onclick="event.stopPropagation(); selectShortlistType('sourcing')" />
                          Sourcing Exercise Outcome
                        </label>
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 10px; border: 1px solid var(--surface-200); border-radius: 16px; background: white; font-size: 12px; color: var(--text-primary); transition: all 0.15s ease;" onclick="event.stopPropagation(); selectShortlistType('tender')" onmouseover="this.style.borderColor='var(--primary-300)'; this.style.background='var(--primary-50)'" onmouseout="if(!this.querySelector('input').checked){this.style.borderColor='var(--surface-200)'; this.style.background='white'}">
                          <input type="radio" name="shortlistType" value="tender" style="accent-color: var(--primary-500); margin: 0; width: 14px; height: 14px;" onclick="event.stopPropagation(); selectShortlistType('tender')" />
                          Existing Tender Vendors
                        </label>
                      </div>
                      
                      <!-- Searchable dropdown (hidden until radio selected) -->
                      <div id="shortlist-search-container" style="display: none;">
                        <div style="position: relative;">
                          <input type="text" class="form-input" id="shortlist-search-input" placeholder="Search list by name..." style="padding-left: 36px; font-size: 13px; margin-bottom: 8px;" onclick="event.stopPropagation()" onkeyup="filterShortlistOptions(this.value)" onfocus="showShortlistDropdown()" />
                          <i class="pi pi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px; margin-top: -4px;"></i>
                        </div>
                        <div id="shortlist-dropdown" style="display: none; position: relative; z-index: 100; background: white; border: 1px solid var(--surface-300); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); max-height: 200px; overflow-y: auto;">
                        </div>
                      </div>
                    </div>
                    ` : ''}
                    
                    <!-- Method 3: Add Manual Vendor -->
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">
                        <div style="width: 32px; height: 32px; background: var(--success-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                          <i class="pi pi-user-plus" style="color: var(--success-600); font-size: 14px;"></i>
                        </div>
                        <div>
                          <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Add Manually</div>
                          <div style="font-size: 11px; color: var(--text-secondary);">Unregistered suppliers</div>
                        </div>
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 8px;">
                        <input type="text" class="form-input" placeholder="Company name *" style="font-size: 13px;" id="manual-vendor-company" onclick="event.stopPropagation()" />
                        <input type="email" class="form-input" placeholder="Email address *" style="font-size: 13px;" id="manual-vendor-email" onclick="event.stopPropagation()" />
                        <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); addManualVendor()" style="align-self: flex-start;">
                          <i class="pi pi-plus"></i> Add Vendor
                        </button>
                      </div>
                    </div>
                    
                    <!-- Method 4: Bulk Upload (hidden for Direct contracting) -->
                    ${!isDirect ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-md);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--spacing-sm);">
                        <div style="width: 32px; height: 32px; background: var(--warning-100); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                          <i class="pi pi-upload" style="color: var(--warning-600); font-size: 14px;"></i>
                        </div>
                        <div>
                          <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Bulk Upload</div>
                          <div style="font-size: 11px; color: var(--text-secondary);">Import from spreadsheet</div>
                        </div>
                      </div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); downloadVendorNotificationTemplate()" title="Download template">
                          <i class="pi pi-download"></i> Template
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); document.getElementById('vendor-upload-input').click()" title="Upload vendor list">
                          <i class="pi pi-upload"></i> Upload File
                        </button>
                        <input type="file" id="vendor-upload-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleVendorListUpload(event)" />
                      </div>
                      <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                        Accepts .xlsx, .xls, .csv
                      </div>
                    </div>
                    ` : ''}
                    
                  </div>
                  
                  <!-- UNGM Status Info Box -->
                  ${renderUNGMStatusInfoBox()}
                  
                  <!-- Vendors List Section -->
                  <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-lg); overflow: hidden;">
                    <!-- List Header -->
                    <div style="background: var(--surface-100); padding: var(--spacing-sm) var(--spacing-md); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--surface-200);">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="pi pi-users" style="color: var(--text-secondary);"></i>
                        <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">Vendors</span>
                        <span class="badge badge-primary" style="font-size: 10px;">${competitionValues.notificationVendors ? competitionValues.notificationVendors.length : 0}</span>
                        ${competitionValues.notificationVendors && competitionValues.notificationVendors.filter(v => v.eligibilityStatus && v.eligibilityStatus !== 'null').length > 0 ? `<span class="badge badge-danger" style="font-size: 10px;" title="${competitionValues.notificationVendors.filter(v => v.eligibilityStatus && v.eligibilityStatus !== 'null').length} vendor(s) with eligibility issues"><i class="pi pi-exclamation-triangle" style="font-size: 9px;"></i> ${competitionValues.notificationVendors.filter(v => v.eligibilityStatus && v.eligibilityStatus !== 'null').length} flagged</span>` : ''}
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 4px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: 2px;">
                          <select id="vendor-filter-field-dc" class="form-input" style="font-size: 11px; padding: 4px 8px; border: none; background: transparent; min-width: 90px;" onclick="event.stopPropagation()" onchange="applyVendorFilter()">
                            <option value="all">All Fields</option>
                            <option value="companyName">Company</option>
                            <option value="email">Email</option>
                            <option value="ungmId">UNGM ID</option>
                            <option value="eligibilityStatus">Status</option>
                            <option value="source">Source</option>
                            <option value="notified">Notified</option>
                          </select>
                          <input type="text" id="vendor-filter-value-dc" class="form-input" placeholder="Filter..." style="font-size: 11px; padding: 4px 8px; width: 120px; border: none; border-left: 1px solid var(--surface-200);" onclick="event.stopPropagation()" onkeyup="applyVendorFilter()" />
                        </div>
                        ${competitionValues.vendorListFilter ? '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); clearVendorFilter()" style="color: var(--text-muted); padding: 4px;" title="Clear filter"><i class="pi pi-times"></i></button>' : ''}
                        ${competitionValues.notificationVendors && competitionValues.notificationVendors.filter(v => !v.notified).length > 0 ? `
                          <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); notifyAllVendors()" style="font-size: 11px;">
                            <i class="pi pi-send"></i> Notify All (${competitionValues.notificationVendors.filter(v => !v.notified).length})
                          </button>
                        ` : ''}
                        ${competitionValues.notificationVendors && competitionValues.notificationVendors.length > 0 ? `
                          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); clearAllNotificationVendors()" style="color: var(--danger-500); font-size: 11px;">
                            <i class="pi pi-trash"></i> Clear All
                          </button>
                        ` : ''}
                      </div>
                    </div>
                    
                    <!-- Vendors Table -->
                    <div style="overflow-x: auto;">
                      ${competitionValues.notificationVendors && competitionValues.notificationVendors.length > 0 ? `
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                          <thead style="background: var(--surface-50);">
                            <tr>
                              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Company Name</th>
                              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Email</th>
                              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">UNGM ID</th>
                              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">${renderUNGMStatusHeader()}</th>
                              <th style="padding: 10px 12px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Source</th>
                              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200);">Notified</th>
                              <th style="padding: 10px 12px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 60px;">Action</th>
                            </tr>
                          </thead>
                          <tbody id="notification-vendors-tbody">
                            ${(competitionValues.notificationVendors || []).slice(((competitionValues.vendorListPage || 1) - 1) * 10, (competitionValues.vendorListPage || 1) * 10).map((vendor, idx) => {
                              return '<tr style="border-bottom: 1px solid var(--surface-100);">' +
                                '<td style="padding: 10px 12px; color: var(--text-primary);">' + 
                                  (vendor.ungmId ? '<a href="#" onclick="event.stopPropagation(); openUNGMVendorDetails(\'' + vendor.ungmId + '\')" style="color: var(--primary-600); text-decoration: none; font-weight: 500;" title="Click to view UNGM details">' + (vendor.companyName || '-') + '</a>' : (vendor.companyName || '-')) +
                                '</td>' +
                                '<td style="padding: 10px 12px; color: var(--text-secondary);">' + (vendor.email || '-') + '</td>' +
                                '<td style="padding: 10px 12px; color: var(--text-secondary);">' + (vendor.ungmId || '-') + '</td>' +
                                '<td style="padding: 10px 12px;">' + renderUNGMEligibilityBadge(vendor.eligibilityStatus) + '</td>' +
                                '<td style="padding: 10px 12px;">' +
                                  '<span class="badge ' + (vendor.source === 'UNGM' ? 'badge-primary' : (vendor.source === 'Ad-hoc Shortlist' || vendor.source === 'Sourcing Outcome' || vendor.source === 'Tender Vendors' || vendor.source === 'Shortlist') ? 'badge-info' : vendor.source === 'Manual' ? 'badge-success' : 'badge-warning') + '" style="font-size: 10px;">' +
                                    (vendor.source || 'Unknown') +
                                  '</span>' +
                                '</td>' +
                                '<td style="padding: 10px 12px; text-align: center;">' +
                                  (vendor.notified ? 
                                    '<span class="badge badge-success" style="font-size: 10px;">Yes</span>' : 
                                    '<span class="badge badge-secondary" style="font-size: 10px;">No</span>') +
                                '</td>' +
                                '<td style="padding: 10px 12px; text-align: center; white-space: nowrap;">' +
                                  (vendor.notified ? '' : 
                                    '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); notifyVendor(' + (((competitionValues.vendorListPage || 1) - 1) * 10 + idx) + ')" style="color: var(--primary-500); padding: 4px;" title="Send notification">' +
                                      '<i class="pi pi-send"></i>' +
                                    '</button>') +
                                  '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); removeNotificationVendor(' + (((competitionValues.vendorListPage || 1) - 1) * 10 + idx) + ')" style="color: var(--danger-500); padding: 4px;" title="Remove vendor">' +
                                    '<i class="pi pi-times"></i>' +
                                  '</button>' +
                                '</td>' +
                              '</tr>';
                            }).join('')}
                          </tbody>
                        </table>
                      ` : `
                        <div style="padding: var(--spacing-xl); text-align: center; color: var(--text-muted);">
                          <i class="pi pi-inbox" style="font-size: 36px; color: var(--surface-300); display: block; margin-bottom: var(--spacing-sm);"></i>
                          <div style="font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px;">No vendors added yet</div>
                          <div style="font-size: 12px;">Use one of the methods above to add vendors</div>
                        </div>
                      `}
                    </div>
                    
                    <!-- Pagination -->
                    ${competitionValues.notificationVendors && competitionValues.notificationVendors.length > 0 ? 
                      '<div style="background: var(--surface-50); padding: var(--spacing-sm) var(--spacing-md); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--surface-200);">' +
                        '<div style="font-size: 12px; color: var(--text-secondary);">' +
                          'Showing ' + (competitionValues.notificationVendors.length > 0 ? (((competitionValues.vendorListPage || 1) - 1) * 10 + 1) : 0) + ' - ' + Math.min((competitionValues.vendorListPage || 1) * 10, competitionValues.notificationVendors.length) + ' of ' + competitionValues.notificationVendors.length + ' vendors' +
                        '</div>' +
                        '<div style="display: flex; align-items: center; gap: 4px;">' +
                          '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); changeVendorListPage(\'prev\')" ' + ((competitionValues.vendorListPage || 1) === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '') + '>' +
                            '<i class="pi pi-chevron-left"></i>' +
                          '</button>' +
                          '<span style="font-size: 12px; color: var(--text-secondary); padding: 0 8px;">Page ' + (competitionValues.vendorListPage || 1) + ' of ' + Math.max(1, Math.ceil(competitionValues.notificationVendors.length / 10)) + '</span>' +
                          '<button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); changeVendorListPage(\'next\')" ' + ((competitionValues.vendorListPage || 1) >= Math.ceil(competitionValues.notificationVendors.length / 10) ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : '') + '>' +
                            '<i class="pi pi-chevron-right"></i>' +
                          '</button>' +
                        '</div>' +
                      '</div>'
                    : ''}
                  </div>
                  
                </div>
              </div>
              
            </div>
          </div>
        `;
      }
      
      // Competition update functions
      // Track expanded sections for Competition tab
      let competitionExpandedSections = {
        'competition-type-section': false,
        'competition-details-section': false,
        'vendor-notification-section': false
      };
      
      window.updateCompetitionType = function(value) {
        // Save current expanded states before re-render
        saveCompetitionSectionStates();
        
        competitionValues.competitionType = value;
        renderCurrentBlock();
        
        // Restore expanded states after re-render
        restoreCompetitionSectionStates();
      }
      
      function saveCompetitionSectionStates() {
        const sectionIds = ['competition-type-section', 'competition-details-section', 'vendor-notification-section'];
        sectionIds.forEach(id => {
          const section = document.getElementById(id);
          if (section) {
            competitionExpandedSections[id] = !section.classList.contains('collapsed');
          }
        });
      }
      
      function restoreCompetitionSectionStates() {
        Object.keys(competitionExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section && competitionExpandedSections[id]) {
            section.classList.remove('collapsed');
          }
        });
      }
      
      window.updateCompetitionValue = function(field, value) {
        competitionValues[field] = value;
      }
      
      window.removeUngmVendor = function(index) {
        saveCompetitionSectionStates();
        competitionValues.ungmVendors.splice(index, 1);
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // ===== VENDOR NOTIFICATION FUNCTIONS =====
      
      // Search UNGM Vendors (mock implementation)
      window.searchUNGMVendors = function(searchTerm) {
        const resultsContainer = document.getElementById('ungm-search-results');
        if (!resultsContainer) return;
        
        if (!searchTerm || searchTerm.length < 2) {
          resultsContainer.style.display = 'none';
          return;
        }
        
        // Mock UNGM vendors data
        const mockUNGMVendors = [
          { id: 'UNGM-001', companyName: 'Acme Corporation', email: 'contact@acme.com', country: 'United States' },
          { id: 'UNGM-002', companyName: 'Global Tech Solutions', email: 'info@globaltech.com', country: 'Germany' },
          { id: 'UNGM-003', companyName: 'Swift Logistics Ltd', email: 'bids@swiftlogistics.co.uk', country: 'United Kingdom' },
          { id: 'UNGM-004', companyName: 'Green Energy Systems', email: 'procurement@greenenergy.nl', country: 'Netherlands' },
          { id: 'UNGM-005', companyName: 'Medical Supplies International', email: 'tenders@medsupply.ch', country: 'Switzerland' },
          { id: 'UNGM-006', companyName: 'Construction Partners Inc', email: 'projects@constructionpartners.com', country: 'Canada' },
          { id: 'UNGM-007', companyName: 'IT Services Global', email: 'sales@itservicesglobal.com', country: 'India' },
          { id: 'UNGM-008', companyName: 'Food & Agriculture Co', email: 'supply@foodagri.com', country: 'Brazil' },
        ];
        
        const filtered = mockUNGMVendors.filter(v => 
          v.companyName.toLowerCase().includes(searchTerm.toLowerCase()) ||
          v.id.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (filtered.length === 0) {
          resultsContainer.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">No vendors found</div>';
        } else {
          resultsContainer.innerHTML = filtered.map(vendor => `
            <div onclick="event.stopPropagation(); addUNGMVendorToList('${vendor.id}', '${vendor.companyName}', '${vendor.email}')" 
                 style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--surface-100); transition: background 0.15s;"
                 onmouseover="this.style.background='var(--surface-100)'" 
                 onmouseout="this.style.background='white'">
              <div style="font-weight: 500; font-size: 13px; color: var(--text-primary);">${vendor.companyName}</div>
              <div style="font-size: 11px; color: var(--text-secondary);">${vendor.id} ‚Ä¢ ${vendor.email} ‚Ä¢ ${vendor.country}</div>
            </div>
          `).join('');
        }
        
        resultsContainer.style.display = 'block';
      }
      
      // Add UNGM vendor to notification list
      window.addUNGMVendorToList = function(id, companyName, email) {
        // Check Direct contracting limit
        if (!canAddVendor(1)) return;
        
        saveCompetitionSectionStates();
        
        // Check if already exists
        const exists = competitionValues.notificationVendors.some(v => v.email === email);
        if (exists) {
          alert('This vendor is already in the notification list.');
          return;
        }
        
        competitionValues.notificationVendors.push({
          companyName: companyName,
          email: email,
          source: 'UNGM',
          ungmId: id
        });
        
        // Clear search
        const searchInput = document.getElementById('ungm-vendor-search');
        if (searchInput) searchInput.value = '';
        const resultsContainer = document.getElementById('ungm-search-results');
        if (resultsContainer) resultsContainer.style.display = 'none';
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Add all vendors from shortlist
      window.addShortlistVendors = function(shortlistId, listType) {
        if (!shortlistId) return;
        
        // Determine the source label based on list type
        const sourceLabels = {
          'adhoc': 'Ad-hoc Shortlist',
          'sourcing': 'Sourcing Outcome',
          'tender': 'Tender Vendors'
        };
        const sourceLabel = sourceLabels[listType] || 'Shortlist';
        
        // For Direct contracting, only allow adding if no vendors exist
        if (competitionValues.competitionType === 'Direct contracting') {
          if (competitionValues.notificationVendors.length >= 1) {
            alert('Direct contracting allows only 1 vendor. Please remove the existing vendor before adding from a shortlist.');
            return;
          }
          alert('Direct contracting allows only 1 vendor. Only the first vendor from the shortlist will be added.');
        }
        
        saveCompetitionSectionStates();
        
        const mockShortlists = {
          // Ad-hoc Shortlists
          'adhoc-1': [
            { companyName: 'Dell Technologies', email: 'gov@dell.com' },
            { companyName: 'HP Enterprise', email: 'public@hpe.com' },
            { companyName: 'Lenovo Group', email: 'bids@lenovo.com' },
            { companyName: 'Cisco Systems', email: 'procurement@cisco.com' },
          ],
          'adhoc-2': [
            { companyName: 'Staples Inc', email: 'business@staples.com' },
            { companyName: 'Office Depot', email: 'corporate@officedepot.com' },
          ],
          'adhoc-3': [
            { companyName: 'McKinsey & Company', email: 'rfp@mckinsey.com' },
            { companyName: 'Deloitte Consulting', email: 'proposals@deloitte.com' },
            { companyName: 'Boston Consulting Group', email: 'tenders@bcg.com' },
          ],
          'adhoc-4': [
            { companyName: 'Securitas AB', email: 'contracts@securitas.com' },
            { companyName: 'G4S Security', email: 'bids@g4s.com' },
          ],
          'adhoc-5': [
            { companyName: 'DHL Logistics', email: 'government@dhl.com' },
            { companyName: 'Kuehne + Nagel', email: 'tenders@kuehne-nagel.com' },
          ],
          // Sourcing Exercise Outcomes
          'sourcing-1': [
            { companyName: 'IBM Corporation', email: 'govcontracts@ibm.com' },
            { companyName: 'Microsoft Azure', email: 'azure-gov@microsoft.com' },
            { companyName: 'Amazon Web Services', email: 'aws-sector@amazon.com' },
          ],
          'sourcing-2': [
            { companyName: 'Turner Construction', email: 'projects@turnerconstruction.com' },
            { companyName: 'Skanska AB', email: 'tenders@skanska.com' },
            { companyName: 'AECOM', email: 'proposals@aecom.com' },
          ],
          'sourcing-3': [
            { companyName: 'Siemens Healthineers', email: 'procurement@siemens-healthineers.com' },
            { companyName: 'GE Healthcare', email: 'bids@gehealthcare.com' },
          ],
          'sourcing-4': [
            { companyName: 'Maersk Logistics', email: 'contracts@maersk.com' },
            { companyName: 'FedEx Supply Chain', email: 'government@fedex.com' },
          ],
          // Existing Tender Vendor Lists
          'tender-1': [
            { companyName: 'Hensel Phelps', email: 'proposals@henselphelps.com' },
            { companyName: 'Clark Construction', email: 'bids@clarkconstruction.com' },
          ],
          'tender-2': [
            { companyName: 'Accenture', email: 'rfp@accenture.com' },
            { companyName: 'Infosys Ltd', email: 'tenders@infosys.com' },
            { companyName: 'Wipro Technologies', email: 'contracts@wipro.com' },
          ],
          'tender-3': [
            { companyName: 'Toyota Fleet Management', email: 'fleet@toyota.com' },
            { companyName: 'Ford Commercial', email: 'govfleet@ford.com' },
          ],
          'tender-4': [
            { companyName: 'Viking Office Products', email: 'accounts@viking.com' },
            { companyName: 'Lyreco', email: 'tenders@lyreco.com' },
          ],
          'tender-5': [
            { companyName: 'Allied Universal', email: 'contracts@aus.com' },
            { companyName: 'Prosegur', email: 'bids@prosegur.com' },
          ],
        };
        
        const vendors = mockShortlists[shortlistId] || [];
        let addedCount = 0;
        const isDirect = competitionValues.competitionType === 'Direct contracting';
        
        for (const vendor of vendors) {
          // For Direct contracting, stop after adding 1 vendor
          if (isDirect && competitionValues.notificationVendors.length >= 1) break;
          
          const exists = competitionValues.notificationVendors.some(v => v.email === vendor.email);
          if (!exists) {
            competitionValues.notificationVendors.push({
              companyName: vendor.companyName,
              email: vendor.email,
              source: sourceLabel
            });
            addedCount++;
            
            // For Direct contracting, only add 1 vendor
            if (isDirect) break;
          }
        }
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Mock data for different shortlist types
      const shortlistData = {
        adhoc: [
          { id: 'adhoc-1', name: 'IT Equipment Suppliers', vendorCount: 12 },
          { id: 'adhoc-2', name: 'Office Supplies Vendors', vendorCount: 8 },
          { id: 'adhoc-3', name: 'Consulting Firms Pool', vendorCount: 15 },
          { id: 'adhoc-4', name: 'Security Services List', vendorCount: 6 },
          { id: 'adhoc-5', name: 'Transportation Partners', vendorCount: 10 },
        ],
        sourcing: [
          { id: 'sourcing-1', name: 'Shortlist - RFI-2025-001 IT Infrastructure', vendorCount: 18, date: '2025-10-15' },
          { id: 'sourcing-2', name: 'Shortlist - EOI-2025-003 Construction Services', vendorCount: 24, date: '2025-09-20' },
          { id: 'sourcing-3', name: 'Shortlist - RFI-2025-005 Medical Equipment', vendorCount: 9, date: '2025-11-02' },
          { id: 'sourcing-4', name: 'Shortlist - EOI-2024-012 Logistics Partners', vendorCount: 31, date: '2024-12-10' },
        ],
        tender: [
          { id: 'tender-1', name: 'ITB-2025-0042 - Office Renovation', vendorCount: 5, status: 'Awarded' },
          { id: 'tender-2', name: 'RFP-2025-0038 - IT Support Services', vendorCount: 8, status: 'Closed' },
          { id: 'tender-3', name: 'ITB-2024-0156 - Vehicle Fleet', vendorCount: 12, status: 'Awarded' },
          { id: 'tender-4', name: 'RFQ-2025-0089 - Stationery Supply', vendorCount: 6, status: 'Closed' },
          { id: 'tender-5', name: 'RFP-2024-0201 - Security Services', vendorCount: 4, status: 'Awarded' },
        ]
      };
      
      // Current selected shortlist type
      let currentShortlistType = null;
      
      // Select shortlist type (radio button handler)
      window.selectShortlistType = function(type) {
        currentShortlistType = type;
        
        // Show the search container
        const searchContainer = document.getElementById('shortlist-search-container');
        const searchContainerInline = document.getElementById('shortlist-search-container-inline');
        
        if (searchContainer) {
          searchContainer.style.display = 'block';
        }
        if (searchContainerInline) {
          searchContainerInline.style.display = 'block';
        }
        
        // Update placeholder based on type
        const placeholders = {
          adhoc: 'Search ad-hoc shortlists...',
          sourcing: 'Search sourcing exercise outcomes...',
          tender: 'Search existing tender vendors...'
        };
        
        const searchInput = document.getElementById('shortlist-search-input');
        const searchInputInline = document.getElementById('shortlist-search-input-inline');
        
        if (searchInput) {
          searchInput.placeholder = placeholders[type] || 'Search list by name...';
          searchInput.value = '';
        }
        if (searchInputInline) {
          searchInputInline.placeholder = placeholders[type] || 'Search list by name...';
          searchInputInline.value = '';
        }
        
        // Populate dropdown with options for this type
        populateShortlistDropdown(type, '');
        showShortlistDropdown();
      }
      
      // Populate the shortlist dropdown based on type and search term
      function populateShortlistDropdown(type, searchTerm) {
        const dropdown = document.getElementById('shortlist-dropdown');
        const dropdownInline = document.getElementById('shortlist-dropdown-inline');
        
        const lists = shortlistData[type] || [];
        const filtered = lists.filter(list => 
          list.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        let html = '';
        if (filtered.length === 0) {
          html = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">No lists found</div>';
        } else {
          html = filtered.map(list => {
            let subtitle = `${list.vendorCount} vendors`;
            if (list.date) subtitle += ` ‚Ä¢ ${list.date}`;
            if (list.status) subtitle += ` ‚Ä¢ ${list.status}`;
            
            return `
              <div onclick="event.stopPropagation(); selectShortlist('${list.id}', '${list.name}')" 
                   style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--surface-100); transition: background 0.15s;"
                   onmouseover="this.style.background='var(--surface-100)'" 
                   onmouseout="this.style.background='white'">
                <div style="font-weight: 500; font-size: 13px; color: var(--text-primary);">${list.name}</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${subtitle}</div>
              </div>
            `;
          }).join('');
        }
        
        if (dropdown) dropdown.innerHTML = html;
        if (dropdownInline) dropdownInline.innerHTML = html;
      }
      
      // Filter shortlist options as user types
      window.filterShortlistOptions = function(searchTerm) {
        if (!currentShortlistType) return;
        populateShortlistDropdown(currentShortlistType, searchTerm);
        showShortlistDropdown();
      }
      
      // Show the shortlist dropdown
      window.showShortlistDropdown = function() {
        const dropdown = document.getElementById('shortlist-dropdown');
        const dropdownInline = document.getElementById('shortlist-dropdown-inline');
        
        if (dropdown) dropdown.style.display = 'block';
        if (dropdownInline) dropdownInline.style.display = 'block';
      }
      
      // Select a shortlist from the dropdown
      window.selectShortlist = function(listId, listName) {
        // Hide the dropdown
        const dropdown = document.getElementById('shortlist-dropdown');
        const dropdownInline = document.getElementById('shortlist-dropdown-inline');
        if (dropdown) dropdown.style.display = 'none';
        if (dropdownInline) dropdownInline.style.display = 'none';
        
        // Update the search input to show selection
        const searchInput = document.getElementById('shortlist-search-input');
        const searchInputInline = document.getElementById('shortlist-search-input-inline');
        if (searchInput) searchInput.value = listName;
        if (searchInputInline) searchInputInline.value = listName;
        
        // Add vendors from the selected list, passing the current list type
        addShortlistVendors(listId, currentShortlistType);
      }
      
      // Close shortlist dropdown when clicking outside
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('shortlist-dropdown');
        const dropdownInline = document.getElementById('shortlist-dropdown-inline');
        const searchInput = document.getElementById('shortlist-search-input');
        const searchInputInline = document.getElementById('shortlist-search-input-inline');
        
        if (dropdown && !dropdown.contains(e.target) && searchInput && !searchInput.contains(e.target)) {
          dropdown.style.display = 'none';
        }
        if (dropdownInline && !dropdownInline.contains(e.target) && searchInputInline && !searchInputInline.contains(e.target)) {
          dropdownInline.style.display = 'none';
        }
      });
      
      // Helper function to check if adding vendors is allowed (Direct contracting = max 1 vendor)
      function canAddVendor(countToAdd = 1) {
        if (competitionValues.competitionType === 'Direct contracting') {
          const currentCount = competitionValues.notificationVendors.length;
          if (currentCount >= 1) {
            alert('Direct contracting allows only 1 vendor. Please remove the existing vendor before adding a new one.');
            return false;
          }
          if (currentCount + countToAdd > 1) {
            alert('Direct contracting allows only 1 vendor.');
            return false;
          }
        }
        return true;
      }
      
      // Add manual vendor
      window.addManualVendor = function() {
        // Check Direct contracting limit
        if (!canAddVendor(1)) return;
        
        const companyInput = document.getElementById('manual-vendor-company');
        const emailInput = document.getElementById('manual-vendor-email');
        
        const companyName = companyInput ? companyInput.value.trim() : '';
        const email = emailInput ? emailInput.value.trim() : '';
        
        if (!companyName || !email) {
          alert('Please enter both company name and email address.');
          return;
        }
        
        // Basic email validation
        if (!email.includes('@') || !email.includes('.')) {
          alert('Please enter a valid email address.');
          return;
        }
        
        // Check if already exists
        const exists = competitionValues.notificationVendors.some(v => v.email === email);
        if (exists) {
          alert('A vendor with this email is already in the notification list.');
          return;
        }
        
        saveCompetitionSectionStates();
        
        competitionValues.notificationVendors.push({
          companyName: companyName,
          email: email,
          source: 'Manual'
        });
        
        // Clear inputs
        if (companyInput) companyInput.value = '';
        if (emailInput) emailInput.value = '';
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Remove vendor from notification list
      window.removeNotificationVendor = function(index) {
        saveCompetitionSectionStates();
        competitionValues.notificationVendors.splice(index, 1);
        
        // Adjust page if needed
        const totalPages = Math.ceil(competitionValues.notificationVendors.length / 10);
        if (competitionValues.vendorListPage > totalPages && totalPages > 0) {
          competitionValues.vendorListPage = totalPages;
        }
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Clear all vendors
      window.clearAllNotificationVendors = function() {
        if (!confirm('Are you sure you want to remove all vendors from the notification list?')) {
          return;
        }
        
        saveCompetitionSectionStates();
        competitionValues.notificationVendors = [];
        competitionValues.vendorListPage = 1;
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Notify a single vendor
      window.notifyVendor = function(index) {
        if (index < 0 || index >= competitionValues.notificationVendors.length) {
          return;
        }
        
        const vendor = competitionValues.notificationVendors[index];
        if (vendor.notified) {
          return; // Already notified
        }
        
        saveCompetitionSectionStates();
        
        // Mark as notified
        competitionValues.notificationVendors[index].notified = true;
        
        // Show success feedback
        showNotification('Notification sent to ' + vendor.companyName, 'success');
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Notify all unnotified vendors
      window.notifyAllVendors = function() {
        const unnotified = competitionValues.notificationVendors.filter(v => !v.notified);
        
        if (unnotified.length === 0) {
          showNotification('All vendors have already been notified', 'info');
          return;
        }
        
        if (!confirm('Send notifications to ' + unnotified.length + ' vendor(s)?')) {
          return;
        }
        
        saveCompetitionSectionStates();
        
        // Mark all as notified
        competitionValues.notificationVendors.forEach(vendor => {
          vendor.notified = true;
        });
        
        // Show success feedback
        showNotification('Notifications sent to ' + unnotified.length + ' vendor(s)', 'success');
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Filter notification vendors (legacy - kept for compatibility)
      window.filterNotificationVendors = function(filterText) {
        competitionValues.vendorListFilter = filterText.toLowerCase();
        competitionValues.vendorListFilterField = 'all';
        competitionValues.vendorListPage = 1;
        saveCompetitionSectionStates();
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Apply vendor filter with field selection
      window.applyVendorFilter = function() {
        // Get filter values from either the regular or DC (direct contracting) inputs
        const fieldEl = document.getElementById('vendor-filter-field') || document.getElementById('vendor-filter-field-dc');
        const valueEl = document.getElementById('vendor-filter-value') || document.getElementById('vendor-filter-value-dc');
        
        const filterField = fieldEl ? fieldEl.value : 'all';
        const filterValue = valueEl ? valueEl.value.toLowerCase().trim() : '';
        
        competitionValues.vendorListFilterField = filterField;
        competitionValues.vendorListFilter = filterValue;
        competitionValues.vendorListPage = 1;
        
        saveCompetitionSectionStates();
        renderCurrentBlock();
        restoreCompetitionSectionStates();
        
        // Restore filter input values after re-render
        setTimeout(() => {
          const newFieldEl = document.getElementById('vendor-filter-field') || document.getElementById('vendor-filter-field-dc');
          const newValueEl = document.getElementById('vendor-filter-value') || document.getElementById('vendor-filter-value-dc');
          if (newFieldEl) newFieldEl.value = filterField;
          if (newValueEl) newValueEl.value = filterValue;
        }, 50);
      }
      
      // Clear vendor filter
      window.clearVendorFilter = function() {
        competitionValues.vendorListFilter = '';
        competitionValues.vendorListFilterField = 'all';
        competitionValues.vendorListPage = 1;
        
        saveCompetitionSectionStates();
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Helper function to filter vendors based on field and value
      function filterVendorList(vendors) {
        const filterValue = competitionValues.vendorListFilter || '';
        const filterField = competitionValues.vendorListFilterField || 'all';
        
        if (!filterValue) return vendors;
        
        return vendors.filter(vendor => {
          if (filterField === 'all') {
            // Search all text fields
            return (vendor.companyName || '').toLowerCase().includes(filterValue) ||
                   (vendor.email || '').toLowerCase().includes(filterValue) ||
                   (vendor.ungmId || '').toLowerCase().includes(filterValue) ||
                   (vendor.eligibilityStatus || '').toLowerCase().includes(filterValue) ||
                   (vendor.source || '').toLowerCase().includes(filterValue) ||
                   (vendor.notified ? 'yes' : 'no').includes(filterValue);
          } else if (filterField === 'notified') {
            const notifiedStr = vendor.notified ? 'yes' : 'no';
            return notifiedStr.includes(filterValue);
          } else if (filterField === 'eligibilityStatus') {
            // Allow searching for status text or 'clear' for no issues
            const status = vendor.eligibilityStatus || '';
            const statusText = status ? status.toLowerCase().replace(/_/g, ' ') : 'clear';
            return statusText.includes(filterValue) || 
                   (filterValue === 'clear' && !status) ||
                   (filterValue === 'sanction' && (status === 'Ineligibility_or_Debarment' || status === 'Ineligible_for_registration'));
          } else {
            const fieldValue = (vendor[filterField] || '').toString().toLowerCase();
            return fieldValue.includes(filterValue);
          }
        });
      }
      
      // Open UNGM vendor details (simulated - would open UNGM portal in real implementation)
      window.openUNGMVendorDetails = function(ungmId) {
        // In real implementation, this would open the UNGM vendor profile page
        // For demo purposes, we'll show a modal with vendor eligibility details
        const vendor = competitionValues.notificationVendors.find(v => v.ungmId === ungmId);
        
        if (!vendor) {
          showNotification('Vendor not found', 'error');
          return;
        }
        
        const statusInfo = {
          'Ineligibility_or_Debarment': {
            severity: 'Critical',
            description: 'This supplier has been found ineligible or debarred from UNGM registration.',
            action: 'Do NOT proceed with this vendor. Contact procurement authority for guidance.',
            color: '#DC2626'
          },
          'Ineligible_for_registration': {
            severity: 'Critical',
            description: 'This supplier is ineligible for registration on UNGM.',
            action: 'Do NOT proceed with this vendor. Contact procurement authority for guidance.',
            color: '#DC2626'
          },
          'Censure': {
            severity: 'Warning',
            description: 'This supplier has received a censure - the mildest form of sanction. It does not affect current eligibility but is an aggravating factor for future sanction proceedings.',
            action: 'Proceed with caution. Document the decision to include this vendor.',
            color: '#EA580C'
          },
          'Vendor_Performance_Issues': {
            severity: 'Advisory',
            description: 'This supplier has been flagged for performance issues in past contracts.',
            action: 'Review the UNGM Guidelines for supplier performance flag details before proceeding.',
            color: '#7C3AED'
          },
          'Potentially_Ineligible_Vendors': {
            severity: 'Review Required',
            description: 'This supplier is a potential match with an ineligible supplier. Verification is needed.',
            action: 'Verify the supplier identity and eligibility status in UNGM before proceeding.',
            color: '#B45309'
          },
          'Other': {
            severity: 'Information',
            description: 'This supplier has another type of status flag.',
            action: 'Review details in UNGM portal.',
            color: '#6B7280'
          }
        };
        
        const info = vendor.eligibilityStatus ? statusInfo[vendor.eligibilityStatus] || statusInfo['Other'] : null;
        
        const modalHtml = `
          <div class="modal-overlay" id="ungm-vendor-modal" onclick="closeUNGMVendorModal()">
            <div class="modal-dialog" style="max-width: 550px;" onclick="event.stopPropagation()">
              <div class="modal-header" style="background: linear-gradient(135deg, var(--info-50) 0%, var(--surface-50) 100%);">
                <div class="modal-title" style="display: flex; align-items: center; gap: 10px;">
                  <i class="pi pi-globe" style="font-size: 20px; color: var(--info-600);"></i>
                  <span>UNGM Vendor Details</span>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="closeUNGMVendorModal()"><i class="pi pi-times"></i></button>
              </div>
              <div class="modal-body" style="padding: var(--spacing-lg);">
                <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                  <div style="width: 60px; height: 60px; background: var(--surface-100); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                    <i class="pi pi-building" style="font-size: 28px; color: var(--text-secondary);"></i>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${vendor.companyName}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);"><i class="pi pi-id-card" style="margin-right: 6px;"></i>${vendor.ungmId}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);"><i class="pi pi-envelope" style="margin-right: 6px;"></i>${vendor.email}</div>
                  </div>
                </div>
                
                ${info ? `
                <div style="background: ${info.color}10; border: 1px solid ${info.color}30; border-radius: var(--radius-lg); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="pi pi-exclamation-circle" style="font-size: 18px; color: ${info.color};"></i>
                    <span style="font-weight: 600; font-size: 14px; color: ${info.color};">${info.severity}</span>
                    ${renderUNGMEligibilityBadge(vendor.eligibilityStatus)}
                  </div>
                  <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5; margin-bottom: 10px;">
                    ${info.description}
                  </div>
                  <div style="font-size: 12px; color: var(--text-secondary); background: white; padding: 10px; border-radius: var(--radius-md);">
                    <strong><i class="pi pi-info-circle" style="margin-right: 4px;"></i>Recommended Action:</strong><br>
                    ${info.action}
                  </div>
                </div>
                ` : `
                <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-lg); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <i class="pi pi-check-circle" style="font-size: 18px; color: var(--success-600);"></i>
                    <span style="font-weight: 600; font-size: 14px; color: var(--success-600);">Clear Status</span>
                    ${renderUNGMEligibilityBadge(null)}
                  </div>
                  <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">
                    No eligibility issues found for this supplier in UNGM.
                  </div>
                </div>
                `}
                
                <div style="font-size: 11px; color: var(--text-muted); padding: var(--spacing-sm); background: var(--surface-50); border-radius: var(--radius-md);">
                  <i class="pi pi-external-link" style="margin-right: 4px;"></i>
                  For complete details, visit the <a href="#" onclick="event.preventDefault(); showNotification('Opening UNGM portal...', 'info');" style="color: var(--primary-600);">UNGM Portal</a> and check the Ineligibility History tab.
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUNGMVendorModal()">Close</button>
                <button class="btn btn-primary" onclick="showNotification('Opening UNGM portal...', 'info'); closeUNGMVendorModal();">
                  <i class="pi pi-external-link"></i> Open in UNGM
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Remove existing modal if any
        const existing = document.getElementById('ungm-vendor-modal');
        if (existing) existing.remove();
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      // Close UNGM vendor modal
      window.closeUNGMVendorModal = function() {
        const modal = document.getElementById('ungm-vendor-modal');
        if (modal) modal.remove();
      }
      
      // Change vendor list page
      window.changeVendorListPage = function(action) {
        saveCompetitionSectionStates();
        
        const totalPages = Math.ceil(competitionValues.notificationVendors.length / 10);
        
        if (action === 'prev' && competitionValues.vendorListPage > 1) {
          competitionValues.vendorListPage--;
        } else if (action === 'next' && competitionValues.vendorListPage < totalPages) {
          competitionValues.vendorListPage++;
        } else if (typeof action === 'number') {
          competitionValues.vendorListPage = action;
        }
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Handle bulk vendor upload
      window.handleVendorListUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Check Direct contracting limit
        const isDirect = competitionValues.competitionType === 'Direct contracting';
        if (isDirect && competitionValues.notificationVendors.length >= 1) {
          alert('Direct contracting allows only 1 vendor. Please remove the existing vendor before uploading.');
          event.target.value = '';
          return;
        }
        
        saveCompetitionSectionStates();
        
        // Mock: Simulate adding vendors from file
        const mockUploadedVendors = [
          { companyName: 'Uploaded Company A', email: 'companya@example.com' },
          { companyName: 'Uploaded Company B', email: 'companyb@example.com' },
          { companyName: 'Uploaded Company C', email: 'companyc@example.com' },
        ];
        
        let addedCount = 0;
        for (const vendor of mockUploadedVendors) {
          // For Direct contracting, stop after adding 1 vendor
          if (isDirect && competitionValues.notificationVendors.length >= 1) break;
          
          const exists = competitionValues.notificationVendors.some(v => v.email === vendor.email);
          if (!exists) {
            competitionValues.notificationVendors.push({
              companyName: vendor.companyName,
              email: vendor.email,
              source: 'Bulk Upload'
            });
            addedCount++;
            if (isDirect) break;
          }
        }
        
        // Reset file input
        event.target.value = '';
        
        renderCurrentBlock();
        restoreCompetitionSectionStates();
        
        if (isDirect && addedCount === 1) {
          alert('Direct contracting allows only 1 vendor. Only the first vendor was imported.');
        } else {
          alert(`Successfully imported ${addedCount} vendors from ${file.name}`);
        }
      }
      
      // ===== END VENDOR NOTIFICATION FUNCTIONS =====
      
      // Download Vendor Notification Template
      window.downloadVendorNotificationTemplate = function() {
        // Create CSV template content
        const templateHeaders = ['Company Name', 'Email Address', 'Contact Person', 'Phone Number', 'Country', 'UNGM ID (if registered)'];
        const exampleRows = [
          ['Acme Corporation', 'procurement@acme.com', 'John Smith', '+1-555-0100', 'United States', 'UNGM-123456'],
          ['Global Supplies Ltd', 'bids@globalsupplies.co.uk', 'Jane Doe', '+44-20-7946-0958', 'United Kingdom', ''],
          ['Tech Solutions GmbH', 'tender@techsolutions.de', 'Hans Mueller', '+49-30-12345678', 'Germany', 'UNGM-789012'],
        ];
        
        // Build CSV content
        let csvContent = templateHeaders.join(',') + '\n';
        csvContent += '# Instructions: Fill in the vendor details below. Each row represents one vendor to be notified.\n';
        csvContent += '# Required fields: Company Name, Email Address\n';
        csvContent += '# Optional fields: Contact Person, Phone Number, Country, UNGM ID\n';
        csvContent += '# Delete these instruction lines before uploading.\n';
        exampleRows.forEach(row => {
          csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });
        
        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'vendor_notification_template.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Template downloaded! Fill in vendor details and upload to bulk add vendors.', 'success');
      }
      
      // Handle Vendor List Upload
      window.handleVendorListUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Check Direct contracting limit
        const isDirect = competitionValues.competitionType === 'Direct contracting';
        if (isDirect && competitionValues.notificationVendors.length >= 1) {
          alert('Direct contracting allows only 1 vendor. Please remove the existing vendor before uploading.');
          event.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            
            if (lines.length < 2) {
              alert('The file appears to be empty or invalid. Please use the template format.');
              return;
            }
            
            // Skip header row
            const dataLines = lines.slice(1);
            let vendorsAdded = 0;
            
            saveCompetitionSectionStates();
            
            for (const line of dataLines) {
              // For Direct contracting, stop after adding 1 vendor
              if (isDirect && competitionValues.notificationVendors.length >= 1) break;
              
              // Parse CSV line (handle quoted values)
              const values = line.match(/("([^"]*)"|[^,]+)/g);
              if (!values || values.length < 2) continue;
              
              // Clean values (remove quotes)
              const cleanValues = values.map(v => v.replace(/^"|"$/g, '').trim());
              
              const [companyName, email, contactPerson, phone, country, ungmId] = cleanValues;
              
              if (!companyName) continue;
              
              // Check for duplicates in notificationVendors
              const isDuplicate = competitionValues.notificationVendors.some(
                v => v.companyName.toLowerCase() === companyName.toLowerCase() || 
                     (v.email && email && v.email.toLowerCase() === email.toLowerCase())
              );
              
              if (!isDuplicate) {
                competitionValues.notificationVendors.push({
                  companyName: companyName,
                  email: email || '',
                  source: 'Bulk Upload',
                  ungmId: ungmId || ''
                });
                vendorsAdded++;
                
                // For Direct contracting, only add 1 vendor
                if (isDirect) break;
              }
            }
            
            renderCurrentBlock();
            restoreCompetitionSectionStates();
            
            if (isDirect && vendorsAdded === 1) {
              showNotification('Direct contracting allows only 1 vendor. Only the first vendor was imported.', 'warning');
            } else if (vendorsAdded > 0) {
              showNotification(`${vendorsAdded} vendor(s) imported successfully!`, 'success');
            } else {
              showNotification('No new vendors were added (duplicates skipped or empty file).', 'warning');
            }
          } catch (err) {
            console.error('Error parsing vendor file:', err);
            alert('Error parsing the file. Please ensure it follows the template format.');
          }
        };
        
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
      }
      
      // Remove single uploaded vendor
      window.removeUploadedVendor = function(index) {
        saveCompetitionSectionStates();
        competitionValues.uploadedVendors.splice(index, 1);
        renderCurrentBlock();
        restoreCompetitionSectionStates();
      }
      
      // Clear all uploaded vendors
      window.clearUploadedVendors = function() {
        if (!confirm('Are you sure you want to remove all uploaded vendors?')) {
          return;
        }
        saveCompetitionSectionStates();
        competitionValues.uploadedVendors = [];
        renderCurrentBlock();
        restoreCompetitionSectionStates();
        showNotification('All uploaded vendors have been removed.', 'success');
      }
      
      // Contract Provisions update functions
      // Track expanded sections for Project & Tender Details
      let projectDetailsExpandedSections = {
        'project-info-section': false,
        'particulars-section': false,
        'key-dates-section': false,
        'contract-provisions-section': false
      };
      
      function saveProjectDetailsSectionStates() {
        Object.keys(projectDetailsExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section) {
            projectDetailsExpandedSections[id] = !section.classList.contains('collapsed');
          }
        });
      }
      
      function restoreProjectDetailsSectionStates() {
        Object.keys(projectDetailsExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section && projectDetailsExpandedSections[id]) {
            section.classList.remove('collapsed');
          }
        });
      }
      
      // Track expanded sections for Evaluation block
      let evaluationExpandedSections = {
        'evaluation-method-section': false,
        'evaluation-criteria-section': false
      };
      
      function saveEvaluationSectionStates() {
        Object.keys(evaluationExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section) {
            evaluationExpandedSections[id] = !section.classList.contains('collapsed');
          }
        });
      }
      
      function restoreEvaluationSectionStates() {
        Object.keys(evaluationExpandedSections).forEach(id => {
          const section = document.getElementById(id);
          if (section && evaluationExpandedSections[id]) {
            section.classList.remove('collapsed');
          }
        });
      }
      
      window.updateContractProvision = function(field, value) {
        const needsRerender = ['performanceSecurityRequired', 'advancePaymentRequired'].includes(field);
        
        if (needsRerender) {
          saveProjectDetailsSectionStates();
        }
        
        contractProvisionsValues[field] = value;
        
        if (needsRerender) {
          renderCurrentBlock();
          restoreProjectDetailsSectionStates();
        }
      }
      
      window.formatContractText = function(editorId, command) {
        const editorMap = {
          'specialConditions': 'contract-special-conditions-editor',
          'clausesKPIs': 'contract-clauses-kpis-editor',
          'clausesDrive': 'contract-clauses-drive-editor',
          'perfSecurityDetails': 'contract-perf-security-editor',
          'advancePaymentDetails': 'contract-advance-payment-editor'
        };
        
        const editor = document.getElementById(editorMap[editorId]);
        if (editor) {
          editor.focus();
          document.execCommand(command, false, null);
        }
      }
      
      // ===== TEAM BLOCK =====
      function renderTeamBlock(block) {
        try {
        const renderTeamMemberCard = (member, role, canRemove = false, removeFunc = null) => {
          if (!member) return '';
          const hasQualification = member.technicalMatterExpertQualification && role === 'Expert';
          return `
            <div class="team-member-card" style="${hasQualification ? 'flex-wrap: wrap;' : ''}">
              <div class="team-member-avatar" style="background: ${role === 'Author' ? 'var(--primary-500)' : 'var(--info-500)'};">${member.avatar || member.name.split(' ').map(n => n[0]).join('')}</div>
              <div class="team-member-info">
                <div class="team-member-name">${member.name}</div>
                <div class="team-member-email">${member.email || ''}</div>
              </div>
              <div class="team-member-role">${role}</div>
              ${canRemove ? `<button class="team-member-remove" onclick="event.stopPropagation(); ${removeFunc}" title="Remove">√ó</button>` : ''}
              ${hasQualification ? `
                <div style="width: 100%; margin-top: var(--spacing-xs); padding-top: var(--spacing-xs); border-top: 1px dashed var(--surface-200);">
                  <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 2px;">Technical Matter Expert Qualification:</div>
                  <div style="font-size: 12px; color: var(--text-secondary); font-style: italic;">${member.technicalMatterExpertQualification}</div>
                </div>
              ` : ''}
            </div>
          `;
        };
        
        const renderTeamMemberList = (members, role, removeFunc) => {
          if (!members || members.length === 0) return '<div class="team-empty-slot">No members assigned</div>';
          return members.map((m, idx) => renderTeamMemberCard(m, role, true, `${removeFunc}(${idx})`)).join('');
        };
        
        // Get evaluation panel status for aggregated state
        const getEvaluationPanelStatus = () => {
          const total = teamMembers.evaluationTeam.length;
          let signed = 0;
          let approved = 0;
          let hasProcurementOfficial = false;
          let hasChair = false;
          
          teamMembers.evaluationTeam.forEach(m => {
            if (evaluationAffidavits[m.email] && evaluationAffidavits[m.email].signed) signed++;
            if (m.approved) approved++;
            if (m.panelRole === 'Procurement Official') hasProcurementOfficial = true;
            if (m.panelRole === 'Chair') hasChair = true;
          });
          
          return { 
            total, 
            signed, 
            approved,
            panelEstablished: total > 0 && hasProcurementOfficial && hasChair,
            paApproved: total > 0 && approved === total,
            allSigned: total > 0 && signed === total
          };
        };
        
        // Render aggregated evaluation panel status badges for header
        const renderAffidavitStatusBadge = () => {
          const status = getEvaluationPanelStatus();
          if (status.total === 0) return '';
          
          let badges = '';
          
          // Panel Established status
          if (status.panelEstablished) {
            badges += '<span class="eval-status-badge established" title="Evaluation panel has required roles"><i class="pi pi-check-circle"></i> Panel Established</span>';
          } else {
            badges += '<span class="eval-status-badge pending" title="Missing required roles (Procurement Official and/or Chair)"><i class="pi pi-clock"></i> Panel Incomplete</span>';
          }
          
          // PA Approved status
          if (status.paApproved) {
            badges += '<span class="eval-status-badge approved" title="All members approved by PA"><i class="pi pi-check-circle"></i> PA Approved</span>';
          } else {
            badges += '<span class="eval-status-badge pending" title="' + status.approved + '/' + status.total + ' members approved by PA"><i class="pi pi-clock"></i> PA Pending</span>';
          }
          
          // Affidavit Signed status
          if (status.allSigned) {
            badges += '<span class="eval-status-badge signed" title="All members signed affidavit"><i class="pi pi-check-circle"></i> Affidavit Signed</span>';
          } else {
            badges += '<span class="eval-status-badge pending" title="' + status.signed + '/' + status.total + ' affidavits signed"><i class="pi pi-clock"></i> Affidavit Pending</span>';
          }
          
          return '<div style="display: flex; gap: 6px; margin-left: 8px;">' + badges + '</div>';
        };
        
        // Get role badge class based on panel role
        const getRoleBadgeClass = (panelRole) => {
          const roleMap = {
            'Procurement Official': 'procurement-official',
            'Chair': 'chair',
            'Evaluation Team member': 'team-member',
            'Observer': 'observer'
          };
          return roleMap[panelRole] || 'team-member';
        };
        
        // Get role icon based on panel role
        const getRoleIcon = (panelRole) => {
          const iconMap = {
            'Procurement Official': '<i class="pi pi-briefcase"></i>',
            'Chair': '<i class="pi pi-star-fill"></i>',
            'Evaluation Team member': '<i class="pi pi-user"></i>',
            'Observer': '<i class="pi pi-eye"></i>'
          };
          return iconMap[panelRole] || '<i class="pi pi-user"></i>';
        };
        
        // Get avatar background color based on role - using UNOPS palette
        const getAvatarColor = (panelRole) => {
          const colorMap = {
            'Procurement Official': 'var(--primary-600)',
            'Chair': 'var(--primary-700)',
            'Evaluation Team member': 'var(--primary-500)',
            'Observer': 'var(--surface-600)'
          };
          return colorMap[panelRole] || 'var(--surface-600)';
        };
        
        // Render evaluation panel table row
        const renderEvalPanelRow = (member, idx) => {
          const aff = evaluationAffidavits[member.email] || { signed: false };
          const safeEmail = member.email.replace(/'/g, "\\'");
          const safeName = member.name.replace(/'/g, "\\'");
          const panelRole = member.panelRole || 'Evaluation Team member';
          const isApproved = member.approved !== undefined ? member.approved : false;
          
          return `
            <tr>
              <td>
                <span class="eval-panel-role-badge ${getRoleBadgeClass(panelRole)}">
                  ${getRoleIcon(panelRole)} ${panelRole}
                </span>
              </td>
              <td>
                <div class="eval-panel-member-info">
                  <div class="eval-panel-avatar" style="background: ${getAvatarColor(panelRole)};">
                    ${member.avatar || member.name.split(' ').map(n => n[0]).join('')}
                  </div>
                  <div class="eval-panel-member-details">
                    <div class="eval-panel-member-name">${member.name}</div>
                    <div class="eval-panel-member-email">${member.email || ''}</div>
                  </div>
                </div>
              </td>
              <td>
                <span class="eval-panel-approved-badge ${isApproved ? 'approved' : 'pending'}">
                  ${isApproved ? '<i class="pi pi-check"></i> Yes' : '<i class="pi pi-clock"></i> No'}
                </span>
              </td>
              <td>
                <div class="eval-panel-affidavit-cell">
                  ${aff.signed 
                    ? `<span class="eval-panel-affidavit-badge signed" onclick="event.stopPropagation();viewAffidavit('${safeEmail}')" title="View signed affidavit"><i class="pi pi-check-circle"></i> Signed</span>`
                    : `<span class="eval-panel-affidavit-badge pending-sign" onclick="event.stopPropagation();openSignAffidavitModal('${safeEmail}','${safeName}')" title="Click to sign affidavit"><i class="pi pi-clock"></i> Pending</span>`
                  }
                </div>
              </td>
              <td>
                <div class="eval-panel-actions">
                  <button class="eval-panel-action-btn" onclick="event.stopPropagation();removeEvaluationTeamMember(${idx})" title="Remove member">
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        };
        
        // Render evaluation panel table
        const renderEvalPanelTable = () => {
          if (!teamMembers.evaluationTeam || teamMembers.evaluationTeam.length === 0) {
            return `
              <div class="eval-panel-empty">
                <div class="eval-panel-empty-icon"><i class="pi pi-users" style="font-size: 48px;"></i></div>
                <div class="eval-panel-empty-text">No evaluation panel members assigned yet</div>
                <button class="btn btn-primary" onclick="event.stopPropagation(); openAddEvalPanelMemberModal()">
                  <i class="pi pi-plus"></i> Add First Member
                </button>
              </div>
            `;
          }
          
          // Sort by role priority: Procurement Official > Chair > Evaluation Team member > Observer
          const rolePriority = {
            'Procurement Official': 1,
            'Chair': 2,
            'Evaluation Team member': 3,
            'Observer': 4
          };
          
          const sortedMembers = [...teamMembers.evaluationTeam].sort((a, b) => {
            const priorityA = rolePriority[a.panelRole] || 99;
            const priorityB = rolePriority[b.panelRole] || 99;
            return priorityA - priorityB;
          });
          
          // We need to map sorted members back to their original indices for removal
          const memberRows = sortedMembers.map(member => {
            const originalIdx = teamMembers.evaluationTeam.findIndex(m => m.email === member.email);
            return renderEvalPanelRow(member, originalIdx);
          }).join('');
          
          return `
            <table class="eval-panel-table">
              <thead>
                <tr>
                  <th style="width: 180px;">Role</th>
                  <th>Name</th>
                  <th style="width: 100px;">Approved</th>
                  <th style="width: 150px;">Affidavit</th>
                  <th style="width: 60px;"></th>
                </tr>
              </thead>
              <tbody>
                ${memberRows}
              </tbody>
            </table>
          `;
        };
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              
              <!-- Current Author Section -->
              <div class="collapsible-section" id="team-author-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-author-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Procurement Official</span>
                    <span class="badge badge-success" style="margin-left: 8px;">Active</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-section-content">
                    ${renderTeamMemberCard(teamMembers.author, 'Author')}
                    
                    <div class="team-subsection" style="margin-top: var(--spacing-md);">
                      <div class="team-subsection-header">
                        <span class="team-subsection-title">Alternate Procurement Officials</span>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('alternateAuthors')"><i class="pi pi-plus"></i> Add</button>
                      </div>
                      <div class="team-members-list">
                        ${renderTeamMemberList(teamMembers.alternateAuthors, 'Alternate Procurement Official', 'removeAlternateAuthor')}
                      </div>
                      <span class="help-text">Alternate Procurement Officials can edit the tender document</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Procurement Roles Section -->
              <div class="collapsible-section collapsed" id="team-procurement-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-procurement-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Review Roles</span>
                    ${renderSectionProgress('team-procurement', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-roles-grid">
                    
                    <!-- Procurement Reviewer -->
                    <div class="team-role-card">
                      <div class="team-role-header">
                        <div class="team-role-icon"><i class="pi pi-file-edit"></i></div>
                        <div class="team-role-title">Procurement Reviewer</div>
                      </div>
                      <div class="team-role-content">
                        ${teamMembers.procurementReviewer ? 
                          renderTeamMemberCard(teamMembers.procurementReviewer, 'Reviewer', true, 'removeProcurementReviewer()') :
                          `<div class="team-add-placeholder" onclick="event.stopPropagation(); openAddTeamMemberModal('procurementReviewer')">
                            <i class="pi pi-plus"></i>
                            <span>Assign Reviewer</span>
                          </div>`
                        }
                      </div>
                      <span class="help-text">Reviews and approves tender documents</span>
                    </div>
                    
                    <!-- Procurement Authority -->
                    <div class="team-role-card">
                      <div class="team-role-header">
                        <div class="team-role-icon"><i class="pi pi-check-circle"></i></div>
                        <div class="team-role-title">Procurement Authority</div>
                      </div>
                      <div class="team-role-content">
                        ${teamMembers.procurementAuthority ? 
                          renderTeamMemberCard(teamMembers.procurementAuthority, 'Authority', true, 'removeProcurementAuthority()') :
                          `<div class="team-add-placeholder" onclick="event.stopPropagation(); openAddTeamMemberModal('procurementAuthority')">
                            <i class="pi pi-plus"></i>
                            <span>Assign Authority</span>
                          </div>`
                        }
                      </div>
                      <span class="help-text">Final approval authority for procurement</span>
                    </div>
                    
                    <!-- Technical Experts -->
                    <div class="team-role-card">
                      <div class="team-role-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div class="team-role-icon"><i class="pi pi-cog"></i></div>
                          <div class="team-role-title">Technical Matter Expert(s)</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('technicalExperts')" ${teamMembers.tmeBypass !== 'applicable' ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                          <i class="pi pi-plus"></i> Add Expert
                        </button>
                      </div>
                      <div class="team-role-content" style="${teamMembers.tmeBypass !== 'applicable' ? 'opacity: 0.5; pointer-events: none;' : ''}">
                        ${teamMembers.technicalExperts && teamMembers.technicalExperts.length > 0 ? 
                          teamMembers.technicalExperts.map((expert, idx) => renderTeamMemberCard(expert, 'Expert', true, `removeTechnicalExpert(${idx})`)).join('') :
                          `<div class="team-empty-slot">No technical experts assigned</div>`
                        }
                      </div>
                      <span class="help-text">Provides technical guidance and specifications. You can add multiple technical experts.</span>
                      
                      <!-- TME Bypass Options -->
                      <div style="margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px dashed var(--surface-200);">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                          <span style="font-size: 11px; font-weight: 600; color: var(--text-secondary);">TME Sign-off:</span>
                          <select class="form-input" style="font-size: 11px; padding: 4px 8px; border-radius: 4px; min-width: 220px;" onchange="event.stopPropagation(); updateTmeBypass(this.value)" onclick="event.stopPropagation()">
                            <option value="applicable" ${teamMembers.tmeBypass === 'applicable' ? 'selected' : ''}>TME sign-off applicable</option>
                            <option value="bypass_procurement" ${teamMembers.tmeBypass === 'bypass_procurement' ? 'selected' : ''}>Bypass - Procurement requirements</option>
                            <option value="bypass_waiver" ${teamMembers.tmeBypass === 'bypass_waiver' ? 'selected' : ''}>Bypass - Waiver</option>
                          </select>
                          ${teamMembers.tmeBypass !== 'applicable' ? '<span class="badge badge-warning" style="font-size: 9px;"><i class="pi pi-exclamation-triangle" style="font-size: 9px;"></i> Bypassed</span>' : ''}
                        </div>
                      </div>
                    </div>
                    <!-- Bid Opening Panel -->
                    <div class="team-role-card">
                      <div class="team-role-header">
                        <div class="team-role-icon"><i class="pi pi-folder-open"></i></div>
                        <div class="team-role-title">Bid Opening Panel</div>
                      </div>
                      <div class="team-members-list">
                        ${renderTeamMemberList(teamMembers.bidOpeningPanel, 'Panel Member', 'removeBidOpeningPanelMember')}
                      </div>
                      <span class="help-text">Required for public bid openings or offline tenders</span>
                    </div> 
                  </div>
                </div>
              </div>
              
              <!-- Evaluation Team Section -->
              <div class="collapsible-section collapsed" id="team-evaluation-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-evaluation-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Evaluation Panel</span>
                    ${renderSectionProgress('team-evaluation', null)}
                    ${renderAffidavitStatusBadge()}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-section-content">
                    
                    <!-- Evaluation Panel Requirements Info Box -->
                    <div class="eval-panel-info-box" style="background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: 8px; padding: 16px 20px; margin-bottom: var(--spacing-md);">
                      <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <i class="pi pi-info-circle" style="color: var(--primary-600); font-size: 18px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                          <div style="font-weight: 600; color: var(--primary-800); margin-bottom: 10px; font-size: 13px;">Evaluation Panel Requirements</div>
                          <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: var(--primary-700); line-height: 1.8;">
                            <li>The Evaluation Panel must contain at least <strong>one Procurement Official</strong> and <strong>one Chair</strong>. If the same person holds both roles, one additional evaluator must be added.</li>
                            <li>Only <strong>UNOPS personnel</strong> can take the Procurement Official and Chair roles.</li>
                            <li>All evaluation panel members, including observers, must be <strong>approved by the Procurement Authority (PA)</strong> prior to starting the evaluation.</li>
                            <li>All evaluation panel members must <strong>accept the Conflict of Interest affidavit</strong>.</li>
                          </ul>
                      </div>
                      </div>
                    </div>
                    
                    <!-- Add Member Button -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: var(--spacing-sm);">
                      <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openAddEvalPanelMemberModal()">
                        <i class="pi pi-plus"></i> Add Member
                      </button>
                  </div>
                    
                    <!-- Evaluation Panel Table -->
                    <div>
                      ${renderEvalPanelTable()}
                    </div>
                    
                  </div>
                </div>
              </div>
              
              <!-- Collaborators Section -->
              <div class="collapsible-section collapsed" id="team-collaborators-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('team-collaborators-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Collaborators</span>
                    <span class="badge badge-info" style="margin-left: 8px;">${teamMembers.collaborators.length}</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="team-section-content">
                    <div class="team-subsection-header" style="margin-bottom: var(--spacing-sm);">
                      <span class="team-subsection-title">Additional Collaborators</span>
                      <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openAddTeamMemberModal('collaborators')"><i class="pi pi-plus"></i> Add Collaborator</button>
                    </div>
                    <div class="team-members-list">
                      ${renderTeamMemberList(teamMembers.collaborators, 'Collaborator', 'removeCollaborator')}
                    </div>
                    <span class="help-text">Collaborators can view and comment on the tender</span>
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        `;
        } catch (error) {
          console.error('Error in renderTeamBlock:', error);
          return '<div style="padding: 20px; color: red;">Error rendering Team block: ' + error.message + '</div>';
        }
      }
      
      // Team member management functions
      window.openAddTeamMemberModal = function(role) {
        // In real app, this would open a modal to search and select team members
        const mockMembers = [
          { name: 'John Smith', email: 'john.smith@unops.org', avatar: 'JS' },
          { name: 'Sarah Johnson', email: 'sarah.johnson@unops.org', avatar: 'SJ' },
          { name: 'Michael Chen', email: 'michael.chen@unops.org', avatar: 'MC' },
          { name: 'Emma Wilson', email: 'emma.wilson@unops.org', avatar: 'EW' },
        ];
        
        // Special handling for Technical Matter Experts - show modal with qualification field
        if (role === 'technicalExperts') {
          showTechnicalExpertModal(mockMembers);
          return;
        }
        
        // Special handling for Evaluation Team - use the new panel modal
        if (role === 'evaluationTeam') {
          openAddEvalPanelMemberModal();
          return;
        }
        
        const randomMember = mockMembers[Math.floor(Math.random() * mockMembers.length)];
        
        if (['alternateAuthors', 'bidOpeningPanel', 'collaborators'].includes(role)) {
          teamMembers[role].push(randomMember);
        } else {
          teamMembers[role] = randomMember;
        }
        
        renderCurrentBlock();
        showNotification(`${randomMember.name} added as ${role.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'success');
      }
      
      // Add Evaluation Panel Member Modal
      window.openAddEvalPanelMemberModal = function() {
        const mockMembers = [
          { name: 'John Smith', email: 'john.smith@unops.org', avatar: 'JS' },
          { name: 'Sarah Johnson', email: 'sarah.johnson@unops.org', avatar: 'SJ' },
          { name: 'Michael Chen', email: 'michael.chen@unops.org', avatar: 'MC' },
          { name: 'Emma Wilson', email: 'emma.wilson@unops.org', avatar: 'EW' },
          { name: 'David Brown', email: 'david.brown@unops.org', avatar: 'DB' },
          { name: 'Lisa Anderson', email: 'lisa.anderson@unops.org', avatar: 'LA' },
          { name: 'James Taylor', email: 'james.taylor@unops.org', avatar: 'JT' },
          { name: 'Maria Garcia', email: 'maria.garcia@unops.org', avatar: 'MG' },
        ];
        
        const panelRoles = [
          { value: 'Procurement Official', icon: '<i class="pi pi-briefcase"></i>', color: '#0284c7', description: 'Manages the evaluation process' },
          { value: 'Chair', icon: '<i class="pi pi-star-fill"></i>', color: '#0369a1', description: 'Leads panel discussions and decisions' },
          { value: 'Evaluation Team member', icon: '<i class="pi pi-user"></i>', color: '#0092D1', description: 'Evaluates and scores bids' },
          { value: 'Observer', icon: '<i class="pi pi-eye"></i>', color: '#596170', description: 'Monitors without voting rights' }
        ];
        
        var memberOptions = mockMembers.map(function(m, idx) { 
          return '<option value="' + idx + '">' + m.name + ' (' + m.email + ')</option>'; 
        }).join('');
        
        var roleOptions = panelRoles.map(function(role) {
          return '<div class="role-option" data-role="' + role.value + '" onclick="selectEvalPanelRole(this, \'' + role.value + '\')" style="padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: white;" onmouseover="if(!this.classList.contains(\'selected\'))this.style.borderColor=\'#94a3b8\'" onmouseout="if(!this.classList.contains(\'selected\'))this.style.borderColor=\'#e5e7eb\'">' +
            '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">' +
              '<span style="font-size: 18px; color: ' + role.color + ';">' + role.icon + '</span>' +
              '<span style="font-weight: 600; color: #1f2937; font-size: 13px;">' + role.value + '</span>' +
            '</div>' +
            '<div style="font-size: 11px; color: #6b7280; padding-left: 28px;">' + role.description + '</div>' +
          '</div>';
        }).join('');
        
        var modalHtml = '<div class="modal-overlay" id="eval-panel-member-modal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;" onclick="closeEvalPanelMemberModal(event)">' +
          '<div class="modal-container" style="max-width: 550px; width: 90%; background: white; border-radius: 16px; box-shadow: 0 25px 80px rgba(0,0,0,0.3); overflow: hidden;" onclick="event.stopPropagation()">' +
            '<div class="modal-header" style="padding: 24px 28px; border-bottom: 1px solid var(--surface-200); background: var(--surface-50);">' +
              '<div style="display: flex; align-items: center; gap: 12px;">' +
                '<div style="width: 44px; height: 44px; background: var(--primary-500); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white;"><i class="pi pi-user-plus"></i></div>' +
                '<div>' +
                  '<h3 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--primary-800);">Add Evaluation Panel Member</h3>' +
                  '<p style="margin: 4px 0 0; font-size: 13px; color: var(--primary-600);">Assign a team member and their role in the evaluation</p>' +
                '</div>' +
              '</div>' +
              '<button class="modal-close" style="position: absolute; right: 20px; top: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;" onclick="closeEvalPanelMemberModal()">&times;</button>' +
            '</div>' +
            '<div class="modal-body" style="padding: 28px;">' +
              '<div class="form-group" style="margin-bottom: 24px;">' +
                '<label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Select Team Member <span style="color: #ef4444;">*</span></label>' +
                '<select class="form-select" id="eval-member-select" style="width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; background: white; cursor: pointer;">' +
                  '<option value="">Select a team member...</option>' +
                  memberOptions +
                '</select>' +
              '</div>' +
              '<div class="form-group" style="margin-bottom: 24px;">' +
                '<label class="form-label" style="display: block; margin-bottom: 12px; font-weight: 600; color: #374151; font-size: 14px;">Panel Role <span style="color: #ef4444;">*</span></label>' +
                '<div id="role-selection-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">' +
                  roleOptions +
                '</div>' +
                '<input type="hidden" id="eval-member-role" value="">' +
              '</div>' +
            '</div>' +
            '<div class="modal-footer" style="padding: 20px 28px; border-top: 1px solid var(--surface-200); background: var(--surface-50); display: flex; justify-content: flex-end; gap: 12px;">' +
              '<button class="btn btn-ghost" style="padding: 12px 24px; border: 1px solid var(--surface-300); background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-primary);" onclick="closeEvalPanelMemberModal()">Cancel</button>' +
              '<button class="btn btn-primary" style="padding: 12px 24px; border: none; background: var(--primary-500); color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;" onclick="confirmAddEvalPanelMember()">' +
                '<i class="pi pi-plus" style="margin-right: 6px;"></i>Add to Panel' +
              '</button>' +
            '</div>' +
          '</div>' +
        '</div>';
        
        // Store mock members for later use
        window.evalPanelMockMembers = mockMembers;
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      window.selectEvalPanelRole = function(element, role) {
        // Remove selected state from all options
        document.querySelectorAll('#role-selection-grid .role-option').forEach(opt => {
          opt.classList.remove('selected');
          opt.style.borderColor = '#e5e7eb';
          opt.style.background = 'white';
        });
        
        // Add selected state to clicked option
        element.classList.add('selected');
        element.style.borderColor = 'var(--primary-500)';
        element.style.background = 'var(--primary-50)';
        
        // Set hidden input value
        document.getElementById('eval-member-role').value = role;
      }
      
      window.closeEvalPanelMemberModal = function(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('eval-panel-member-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      window.confirmAddEvalPanelMember = function() {
        const selectEl = document.getElementById('eval-member-select');
        const roleEl = document.getElementById('eval-member-role');
        
        if (!selectEl.value) {
          showNotification('Please select a team member', 'error');
          return;
        }
        
        if (!roleEl.value) {
          showNotification('Please select a panel role', 'error');
          return;
        }
        
        const selectedMember = window.evalPanelMockMembers[parseInt(selectEl.value)];
        
        // Check if member already exists
        const exists = teamMembers.evaluationTeam.some(m => m.email === selectedMember.email);
        if (exists) {
          showNotification('This member is already in the evaluation panel', 'warning');
          return;
        }
        
        // Add member with role
        teamMembers.evaluationTeam.push({
          ...selectedMember,
          panelRole: roleEl.value
        });
        
        closeEvalPanelMemberModal();
        renderCurrentBlock();
        showNotification(selectedMember.name + ' added as ' + roleEl.value, 'success');
      }
      
      // Show modal for adding Technical Expert with qualification field
      window.showTechnicalExpertModal = function(mockMembers) {
        const modalHtml = `
          <div class="modal-overlay" id="technical-expert-modal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;" onclick="closeTechnicalExpertModal(event)">
            <div class="modal-container" style="max-width: 500px; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden;" onclick="event.stopPropagation()">
              <div class="modal-header" style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
                <h3 class="modal-title" style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Add Technical Matter Expert</h3>
                <button class="modal-close" style="position: absolute; right: 16px; top: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;" onclick="closeTechnicalExpertModal()">&times;</button>
              </div>
              <div class="modal-body" style="padding: 24px;">
                <div class="form-group">
                  <label class="form-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Select Team Member <span class="required" style="color: #ef4444;">*</span></label>
                  <select class="form-select" id="technical-expert-select" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white;">
                    <option value="">Select a team member...</option>
                    ${mockMembers.map((m, idx) => `<option value="${idx}">${m.name} (${m.email})</option>`).join('')}
                  </select>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                  <label class="form-label" style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151;">Technical Matter Expert Qualification</label>
                  <textarea 
                    class="form-textarea" 
                    id="technical-expert-qualification" 
                    placeholder="Describe the technical qualifications, expertise areas, and relevant experience of the technical expert..."
                    style="width: 100%; min-height: 100px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit;"
                  ></textarea>
                  <span class="help-text" style="display: block; margin-top: 6px; font-size: 12px; color: #6b7280;">Provide details about the expert's technical background and qualifications relevant to this procurement</span>
                </div>
              </div>
              <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn btn-ghost" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer; font-size: 14px;" onclick="closeTechnicalExpertModal()">Cancel</button>
                <button class="btn btn-primary" style="padding: 10px 20px; border: none; background: #2563eb; color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;" onclick="confirmAddTechnicalExpert()">Add Technical Matter Expert</button>
              </div>
            </div>
          </div>
        `;
        
        // Store mock members for later use
        window.technicalExpertMockMembers = mockMembers;
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      window.closeTechnicalExpertModal = function(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('technical-expert-modal');
        if (modal) {
          modal.remove();
        }
      }
      
      window.confirmAddTechnicalExpert = function() {
        const selectEl = document.getElementById('technical-expert-select');
        const qualificationEl = document.getElementById('technical-expert-qualification');
        
        if (!selectEl.value) {
          showNotification('Please select a team member', 'error');
          return;
        }
        
        const memberIndex = parseInt(selectEl.value);
        const selectedMember = { ...window.technicalExpertMockMembers[memberIndex] };
        
        // Add qualification if provided
        if (qualificationEl.value.trim()) {
          selectedMember.technicalMatterExpertQualification = qualificationEl.value.trim();
        }
        
        // Add to array of technical experts
        teamMembers.technicalExperts.push(selectedMember);
        
        closeTechnicalExpertModal();
        renderCurrentBlock();
        showNotification(`${selectedMember.name} added as Technical Expert`, 'success');
      }
      
      window.removeAlternateAuthor = function(index) {
        teamMembers.alternateAuthors.splice(index, 1);
        renderCurrentBlock();
      }
      
      window.removeProcurementReviewer = function() {
        teamMembers.procurementReviewer = null;
        renderCurrentBlock();
      }
      
      window.removeProcurementAuthority = function() {
        teamMembers.procurementAuthority = null;
        renderCurrentBlock();
      }
      
      window.removeTechnicalExpert = function(index) {
        teamMembers.technicalExperts.splice(index, 1);
        renderCurrentBlock();
      }
      
      // Update TME bypass option
      window.updateTmeBypass = function(value) {
        teamMembers.tmeBypass = value;
        // If bypassing, clear any existing technical experts
        if (value !== 'applicable') {
          teamMembers.technicalExperts = [];
        }
        renderCurrentBlock();
      }
      
      window.removeBidOpeningPanelMember = function(index) {
        teamMembers.bidOpeningPanel.splice(index, 1);
        renderCurrentBlock();
      }
      
      window.removeEvaluationTeamMember = function(index) {
        var member = teamMembers.evaluationTeam[index];
        if (member && member.email && evaluationAffidavits[member.email]) {
          delete evaluationAffidavits[member.email];
        }
        teamMembers.evaluationTeam.splice(index, 1);
        renderCurrentBlock();
      }
      
      window.removeCollaborator = function(index) {
        teamMembers.collaborators.splice(index, 1);
        renderCurrentBlock();
      }
      
      // ===== AFFIDAVIT FUNCTIONS =====
      window.openSignAffidavitModal = function(email, name) {
        var html = '<div id="affidavit-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)closeAffidavitModal()">' +
          '<div style="background:white;border-radius:12px;max-width:550px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">' +
          '<div style="padding:20px 24px;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);">' +
          '<h3 style="margin:0;font-size:18px;color:#166534;">üìú Conflict of Interest Affidavit</h3>' +
          '<div style="font-size:12px;color:#15803d;margin-top:4px;">For: ' + name + '</div></div>' +
          '<div style="padding:24px;">' +
          '<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;font-size:13px;line-height:1.6;color:#374151;margin-bottom:16px;">' +
          '<p style="margin:0 0 12px;font-weight:600;">Declaration:</p>' +
          '<p style="margin:0 0 8px;">I, <strong>' + name + '</strong>, hereby declare that:</p>' +
          '<ol style="margin:0;padding-left:20px;"><li style="margin-bottom:6px;">I have no conflict of interest with any bidders.</li>' +
          '<li style="margin-bottom:6px;">I will not accept any gifts or benefits from bidders.</li>' +
          '<li style="margin-bottom:6px;">I will maintain confidentiality of all bid information.</li>' +
          '<li style="margin-bottom:6px;">I will disclose any conflicts that arise during evaluation.</li></ol></div>' +
          '<div style="margin-bottom:16px;"><label style="display:block;margin-bottom:6px;font-weight:500;font-size:13px;">Comments (Optional)</label>' +
          '<textarea id="affidavit-comments" rows="2" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;resize:vertical;box-sizing:border-box;" placeholder="Add any disclosures or comments..."></textarea></div>' +
          '<div style="display:flex;align-items:flex-start;gap:8px;padding:12px;background:#fef3c7;border:1px solid #fcd34d;border-radius:6px;">' +
          '<input type="checkbox" id="affidavit-confirm" style="margin-top:3px;">' +
          '<label for="affidavit-confirm" style="font-size:12px;color:#92400e;cursor:pointer;">I confirm I have read and agree to this declaration.</label></div></div>' +
          '<div style="padding:16px 24px;border-top:1px solid #e5e7eb;background:#f9fafb;display:flex;justify-content:flex-end;gap:12px;">' +
          '<button class="btn btn-secondary" onclick="closeAffidavitModal()">Cancel</button>' +
          '<button class="btn btn-primary" onclick="signAffidavit(\'' + email.replace(/'/g, "\\'") + '\')" style="background:#16a34a;border-color:#16a34a;">Sign Affidavit</button></div></div></div>';
        document.body.insertAdjacentHTML('beforeend', html);
      };
      
      window.signAffidavit = function(email) {
        var cb = document.getElementById('affidavit-confirm');
        if (!cb || !cb.checked) {
          showNotification('Please confirm you have read the declaration', 'error');
          return;
        }
        var comments = document.getElementById('affidavit-comments');
        evaluationAffidavits[email] = {
          signed: true,
          signedDate: new Date().toISOString(),
          comments: comments ? comments.value.trim() : ''
        };
        closeAffidavitModal();
        renderCurrentBlock();
        showNotification('Affidavit signed successfully', 'success');
      };
      
      window.viewAffidavit = function(email) {
        var member = teamMembers.evaluationTeam.find(function(m) { return m.email === email; });
        var aff = evaluationAffidavits[email];
        if (!member || !aff) { showNotification('Affidavit not found', 'error'); return; }
        var d = new Date(aff.signedDate);
        var dateStr = d.toLocaleDateString('en-US', {weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
        var html = '<div id="affidavit-view-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)closeAffidavitViewModal()">' +
          '<div style="background:white;border-radius:12px;max-width:550px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">' +
          '<div style="padding:20px 24px;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#f0fdf4 0%,#bbf7d0 100%);">' +
          '<h3 style="margin:0;font-size:18px;color:#166534;">‚úì Signed Affidavit</h3></div>' +
          '<div style="padding:24px;">' +
          '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:16px;">' +
          '<div style="width:40px;height:40px;background:#3b82f6;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;">' + (member.avatar || member.name.split(' ').map(function(n){return n[0];}).join('')) + '</div>' +
          '<div><div style="font-weight:600;font-size:14px;">' + member.name + '</div><div style="font-size:12px;color:#6b7280;">' + member.email + '</div>' +
          '<div style="font-size:11px;color:#16a34a;margin-top:2px;">‚úì Signed on ' + dateStr + '</div></div></div>' +
          '<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;font-size:13px;line-height:1.6;color:#374151;margin-bottom:16px;">' +
          '<p style="margin:0 0 8px;font-weight:600;">Declaration confirmed:</p>' +
          '<ol style="margin:0;padding-left:20px;font-size:12px;"><li>No conflict of interest with bidders</li><li>No gifts or benefits accepted</li><li>Confidentiality maintained</li><li>Will disclose any conflicts</li></ol></div>' +
          (aff.comments ? '<div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;"><div style="font-weight:600;font-size:12px;color:#1e40af;margin-bottom:4px;">Comments:</div><div style="font-size:13px;color:#1e3a8a;font-style:italic;">' + aff.comments + '</div></div>' : '<div style="text-align:center;color:#9ca3af;font-size:12px;font-style:italic;">No comments provided</div>') +
          '</div><div style="padding:16px 24px;border-top:1px solid #e5e7eb;background:#f9fafb;display:flex;justify-content:flex-end;">' +
          '<button class="btn btn-secondary" onclick="closeAffidavitViewModal()">Close</button></div></div></div>';
        document.body.insertAdjacentHTML('beforeend', html);
      };
      
      window.closeAffidavitModal = function() {
        var m = document.getElementById('affidavit-modal');
        if (m) m.remove();
      };
      
      window.closeAffidavitViewModal = function() {
        var m = document.getElementById('affidavit-view-modal');
        if (m) m.remove();
      };
      
      // ===== SCOPE & REQUIREMENTS BLOCK =====
      function renderScopeRequirementsBlock(block) {
        // Get all UNSPSC codes based on partial quotations selection
        let unspscCodesToShow = [];
        
        if (allowPartialQuotations === 'Yes') {
          // YES: Show products from Lots
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                source: 'lot',
                sourceId: lot.id,
                lotDescription: lot.description,
              });
            });
          });
        } else if (allowPartialQuotations === 'No') {
          // NO: Show products from Products and Services
          unspscCodesToShow = productsAndServices.map(item => ({
            code: item.unspscCode,
            description: item.unspscDescription,
            source: 'product',
            sourceId: item.id,
          }));
        }
        // If not selected yet, show nothing
        
        // Remove duplicates
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });

        return `
          <div class="general-info-container">
            <div class="general-info-body">
              
              
              
              <!-- Product Requirements Section - Collapsible -->
              <div class="collapsible-section ${getCollapsibleClass('product-requirements-section', true)}" id="product-requirements-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('product-requirements-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Product Requirements & Specifications</span>
                    <span class="badge badge-info" style="margin-left: 8px; font-size: 10px;">${uniqueUnspscCodes.length} products</span>
                    ${renderSectionProgress('product-req', uniqueUnspscCodes)}
                  </div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); downloadProductReqTemplate()"><i class="pi pi-download"></i> Template</button>
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); document.getElementById('product-req-upload-input').click()"><i class="pi pi-upload"></i> Upload</button>
                    <input type="file" id="product-req-upload-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleProductReqUpload(event)" />
                    <div class="collapsible-toggle">‚ñº</div>
                  </div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  ${renderProductRequirementsContent(uniqueUnspscCodes)}
                </div>
              </div>
              
              <!-- Other Requirements Section - Collapsible -->
              <div class="collapsible-section ${getCollapsibleClass('other-requirements-section', true)}" id="other-requirements-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('other-requirements-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Other Requirements</span>
                    ${renderSectionProgress('other-req', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  ${renderOtherRequirementsContent()}
                </div>
              </div>
              
            </div>
          </div>
        `;
      }
      
      // Render Product Requirements Content (compact version)
      function renderProductRequirementsContent(uniqueUnspscCodes) {
        if (uniqueUnspscCodes.length === 0) {
          return `
            <div class="empty-state" style="padding: var(--spacing-lg); text-align: center;">
              <div style="font-size: 24px; margin-bottom: var(--spacing-xs);">üìã</div>
              <div style="font-weight: 600; margin-bottom: var(--spacing-xs);">No products available</div>
              <div style="color: var(--text-muted); font-size: 12px;">${lots.length === 0 ? 'Add requisition lines or create lots with products.' : 'Add products to lots to define requirements.'}</div>
            </div>
          `;
        }
        
        // Check if it's a lot-based tender
        const isLotBased = allowPartialQuotations === 'Yes';
        
        if (isLotBased && lots.length > 0) {
          // Group products by lot
          return renderProductRequirementsByLot();
        } else {
          // Flat list for non-lot-based tenders
          return renderProductRequirementsFlatList(uniqueUnspscCodes);
        }
      }
      
      // Render products grouped by lot
      function renderProductRequirementsByLot() {
        return `
          <div class="product-requirements-by-lot" style="display: flex; flex-direction: column; gap: 12px;">
            ${lots.map((lot, lotIdx) => {
              const lotProducts = lot.unspscCodes || [];
              const completedCount = lotProducts.filter(p => {
                const req = productRequirements[p.code];
                return req && req.requirementType && (req.attributes?.length > 0 || req.description);
              }).length;
              
              return `
                <!-- Lot ${lot.id} -->
                <div class="lot-requirements-section" style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); overflow: hidden;">
                  <!-- Lot Header - Simple -->
                  <div class="lot-req-header" onclick="toggleLotRequirementsSection('lot-req-${lot.id}')" style="background: var(--surface-50); padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <span style="background: var(--primary-500); color: white; width: 24px; height: 24px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${lotIdx + 1}</span>
                      <span style="font-size: 13px; color: var(--text-primary);">${lot.description || 'Lot ' + (lotIdx + 1)}</span>
                      <span style="background: var(--surface-200); color: var(--text-secondary); padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 500;">${lotProducts.length} product${lotProducts.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-size: 11px; color: ${completedCount === lotProducts.length && lotProducts.length > 0 ? 'var(--success-600)' : 'var(--text-muted)'};">${completedCount}/${lotProducts.length} defined</span>
                      <i class="pi pi-chevron-down lot-req-toggle" id="toggle-lot-req-${lot.id}" style="font-size: 10px; color: var(--text-muted); transition: transform 0.2s;"></i>
                    </div>
                  </div>
                  
                  <!-- Lot Products -->
                  <div class="lot-req-body" id="body-lot-req-${lot.id}">
                    ${lotProducts.length === 0 ? `
                      <div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 12px;">
                        No products in this lot
                      </div>
                    ` : `
                      <div class="product-requirements-compact" style="padding: 4px 8px;">
                        ${lotProducts.map((unspsc, idx) => {
                          const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                          const hasRequirements = req.requirementType && (req.attributes?.length > 0 || req.description);
                          const statusClass = hasRequirements ? 'status-complete' : 'status-pending';
                          const statusText = hasRequirements ? '‚úì Defined' : '‚óã Pending';
                          
                          return `
                            <div class="product-req-item ${hasRequirements ? 'has-requirements' : ''}" data-unspsc="${unspsc.code}" style="margin-bottom: 2px;">
                              <div class="product-req-header" onclick="toggleProductRequirement('${unspsc.code}')" style="padding: 8px 10px;">
                                <div class="product-req-info">
                                  <span class="product-req-code">${unspsc.code}</span>
                                  <span class="product-req-desc">${unspsc.description}</span>
                                </div>
                                <div class="product-req-status">
                                  <span class="status-badge ${statusClass}">${statusText}</span>
                                  <span class="product-req-toggle">‚ñº</span>
                                </div>
                              </div>
                              <div class="product-req-body" id="product-req-body-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                                ${renderProductRequirementBody(unspsc, req)}
                              </div>
                            </div>
                          `;
                        }).join('')}
                      </div>
                    `}
                  </div>
                </div>
              `;
            }).join('')}
            
            ${lots.length === 0 ? `
              <div style="padding: 24px; text-align: center; color: var(--text-muted);">
                <div style="font-size: 12px;">No lots defined. Create lots in the Products & Services section.</div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Render flat list of products (non-lot-based)
      function renderProductRequirementsFlatList(uniqueUnspscCodes) {
        return `
          <!-- Products List - Compact Accordion Style -->
          <div class="product-requirements-compact">
            ${uniqueUnspscCodes.map((unspsc, idx) => {
              const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
              const hasRequirements = req.requirementType && (req.attributes?.length > 0 || req.description);
              const statusClass = hasRequirements ? 'status-complete' : 'status-pending';
              const statusText = hasRequirements ? '‚úì Defined' : '‚óã Pending';
              
              return `
                <div class="product-req-item ${hasRequirements ? 'has-requirements' : ''}" data-unspsc="${unspsc.code}">
                  <div class="product-req-header" onclick="toggleProductRequirement('${unspsc.code}')">
                    <div class="product-req-info">
                      <span class="product-req-code">${unspsc.code}</span>
                      <span class="product-req-desc">${unspsc.description}</span>
                    </div>
                    <div class="product-req-status">
                      <span class="status-badge ${statusClass}">${statusText}</span>
                      <span class="product-req-toggle">‚ñº</span>
                    </div>
                  </div>
                  <div class="product-req-body" id="product-req-body-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none;">
                    ${renderProductRequirementBody(unspsc, req)}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      // Toggle lot requirements section
      window.toggleLotRequirementsSection = function(sectionId) {
        const body = document.getElementById('body-' + sectionId);
        const toggleIcon = document.getElementById('toggle-' + sectionId);
        if (body && toggleIcon) {
          if (body.style.display === 'none') {
            body.style.display = 'block';
            toggleIcon.style.transform = 'rotate(0deg)';
          } else {
            body.style.display = 'none';
            toggleIcon.style.transform = 'rotate(-90deg)';
          }
        }
      }
      
      // Render individual product requirement body
      function renderProductRequirementBody(unspsc, req) {
        // Show attachment if exists
        const attachmentHtml = req.uploadedFile ? `
          <div style="margin-bottom: var(--spacing-sm); padding: var(--spacing-sm); background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">üìé</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 12px; color: var(--info-700);">${req.uploadedFile.name}</div>
              <div style="font-size: 11px; color: var(--info-600);">${req.uploadedFile.size}</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); removeAttachment('${unspsc.code}')" style="color: var(--danger-600);" title="Remove attachment"><i class="pi pi-times"></i></button>
          </div>
        ` : '';
        
        if (!req.requirementType || (req.attributes.length === 0 && !req.description)) {
          return `
            <div class="req-type-selector">
              ${attachmentHtml}
              <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">Choose requirement type:</p>
              <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addRequirementAttributeInline('${unspsc.code}')">
                  <i class="pi pi-list"></i> Attributes
                </button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addDescriptionFieldInline('${unspsc.code}')">
                  <i class="pi pi-align-left"></i> Description
                </button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}').click()">
                  <i class="pi pi-paperclip"></i> Attach
                </button>
                <input type="file" id="attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;" onchange="handleAttachFile('${unspsc.code}', event)" />
                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openCriteriaLibrary('${unspsc.code}', '${unspsc.description.replace(/'/g, "\\'")}')">
                  <i class="pi pi-book"></i> Browse Library
                </button>
              </div>
            </div>
          `;
        } else if (req.requirementType === 'description') {
          return `
            <div class="req-description-compact">
              ${attachmentHtml}
              <div class="form-group" style="margin: 0;">
                <div class="rich-text-toolbar-full">
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'bold')" title="Bold"><strong>B</strong></button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'italic')" title="Italic"><em>I</em></button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'underline')" title="Underline"><u>U</u></button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'strikeThrough')" title="Strikethrough"><s>S</s></button>
                  </div>
                  <span class="toolbar-sep"></span>
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'formatBlock', 'h3')" title="Heading">H1</button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'formatBlock', 'h4')" title="Subheading">H2</button>
                  </div>
                  <span class="toolbar-sep"></span>
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatTextByCode('${unspsc.code}', 'insertOrderedList')" title="Numbered List">1.</button>
                  </div>
                  <span class="toolbar-sep"></span>
                  <div class="toolbar-group">
                    <button type="button" class="tb-btn" onclick="event.stopPropagation(); insertLinkByCode('${unspsc.code}')" title="Insert Link">üîó</button>
                  </div>
                </div>
                <div 
                  id="rich-text-editor-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}"
                  class="rich-text-editor-full" 
                  contenteditable="true"
                  data-unspsc="${unspsc.code}"
                  placeholder="Enter detailed product/service description. Use formatting tools above to structure your content..."
                  oninput="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                  onclick="event.stopPropagation()"
                >${req.description || ''}</div>
              </div>
              <div class="req-actions-row">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); switchToAttributesInline('${unspsc.code}')"><i class="pi pi-list"></i> Switch to Attributes</button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}').click()"><i class="pi pi-paperclip"></i> Attach</button>
                <input type="file" id="attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;" onchange="handleAttachFile('${unspsc.code}', event)" />
                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openCriteriaLibrary('${unspsc.code}', '${unspsc.description.replace(/'/g, "\\'")}')"><i class="pi pi-book"></i> Browse Library</button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); clearRequirementsInline('${unspsc.code}')" style="color: var(--danger-600);"><i class="pi pi-trash"></i> Clear</button>
              </div>
            </div>
          `;
        } else {
          // Attributes type (default)
          return `
            <div class="req-attributes-compact">
              ${attachmentHtml}
              <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: 6px 10px; margin-bottom: 8px; font-size: 10px; color: var(--text-secondary);">
                <strong>Compliance Requirements:</strong> Lines marked as "Mandatory" require suppliers to confirm compliance.
              </div>
              <div class="attributes-grid">
                ${req.attributes.map((attr, idx) => `
                  <div class="attr-row">
                    <input type="text" class="attr-input attr-name" value="${attr.name}" placeholder="Attribute name" onchange="updateAttributeName('${unspsc.code}', ${idx}, this.value)" onclick="event.stopPropagation()" />
                    <input type="text" class="attr-input attr-value" value="${attr.value}" placeholder="Value" onchange="updateAttributeValue('${unspsc.code}', ${idx}, this.value)" onclick="event.stopPropagation()" />
                    <div class="mandatory-toggle" style="margin: 0 4px;" title="Toggle whether this requirement is mandatory for suppliers to comply" onclick="event.stopPropagation()">
                      <div class="mandatory-toggle-switch ${attr.isMandatory !== false ? 'active' : ''}" onclick="event.stopPropagation(); toggleAttributeMandatoryInline('${unspsc.code}', ${idx})"></div>
                      <span class="mandatory-toggle-label ${attr.isMandatory !== false ? 'mandatory' : 'optional'}">${attr.isMandatory !== false ? 'Mandatory' : 'Optional'}</span>
                    </div>
                    <button class="attr-remove" onclick="event.stopPropagation(); removeAttributeInline('${unspsc.code}', ${idx})">√ó</button>
                  </div>
                `).join('')}
              </div>
              <div class="req-actions-row">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addRequirementAttributeInline('${unspsc.code}')"><i class="pi pi-plus"></i> Add Attribute</button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); document.getElementById('attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}').click()"><i class="pi pi-paperclip"></i> Attach</button>
                <input type="file" id="attach-file-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;" onchange="handleAttachFile('${unspsc.code}', event)" />
                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); openCriteriaLibrary('${unspsc.code}', '${unspsc.description.replace(/'/g, "\\'")}')"><i class="pi pi-book"></i> Browse Library</button>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); clearRequirementsInline('${unspsc.code}')" style="color: var(--danger-600);"><i class="pi pi-trash"></i> Clear</button>
              </div>
            </div>
          `;
        }
      }
      
      // Toggle product requirement expansion
      window.toggleProductRequirement = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const body = document.getElementById('product-req-body-' + sanitizedCode);
        const item = body.closest('.product-req-item');
        
        if (body.style.display === 'none') {
          body.style.display = 'block';
          item.classList.add('expanded');
        } else {
          body.style.display = 'none';
          item.classList.remove('expanded');
        }
      }
      
      // Inline functions that update DOM without re-rendering the whole block
      window.addRequirementAttributeInline = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'attributes', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'attributes';
        productRequirements[unspscCode].attributes.push({ name: '', value: '', isMandatory: true });
        
        // Update just the body content
        updateProductReqBodyContent(unspscCode);
      }
      
      // Toggle mandatory status for product attribute (inline version)
      window.toggleAttributeMandatoryInline = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          const current = productRequirements[unspscCode].attributes[index].isMandatory;
          productRequirements[unspscCode].attributes[index].isMandatory = current === false ? true : !current;
          updateProductReqBodyContent(unspscCode);
        }
      }
      
      window.addDescriptionFieldInline = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'description', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'description';
        productRequirements[unspscCode].description = '';
        productRequirements[unspscCode].attributes = [];
        
        // Update just the body content
        updateProductReqBodyContent(unspscCode);
      }
      
      window.switchToAttributesInline = function(unspscCode) {
        if (confirm('Switching to attributes will clear your description. Continue?')) {
          productRequirements[unspscCode].requirementType = 'attributes';
          productRequirements[unspscCode].description = '';
          productRequirements[unspscCode].attributes = [];
          updateProductReqBodyContent(unspscCode);
        }
      }
      
      window.clearRequirementsInline = function(unspscCode) {
        if (confirm('This will clear all requirements for this product. Continue?')) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '', uploadedFile: null };
          updateProductReqBodyContent(unspscCode);
          updateProductReqStatus(unspscCode);
        }
      }
      
      window.handleAttachFile = function(unspscCode, event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.size > 10 * 1024 * 1024) {
          alert('File size must be less than 10MB');
          return;
        }
        
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '', uploadedFile: null };
        }
        
        productRequirements[unspscCode].uploadedFile = {
          name: file.name,
          size: (file.size / 1024).toFixed(1) + ' KB',
          type: file.type
        };
        
        updateProductReqBodyContent(unspscCode);
        updateProductReqStatus(unspscCode);
        showNotification(`File "${file.name}" attached`, 'success');
      }
      
      window.removeAttachment = function(unspscCode) {
        if (productRequirements[unspscCode]) {
          productRequirements[unspscCode].uploadedFile = null;
          updateProductReqBodyContent(unspscCode);
          updateProductReqStatus(unspscCode);
        }
      }
      
      window.removeAttributeInline = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes.splice(index, 1);
          updateProductReqBodyContent(unspscCode);
          updateProductReqStatus(unspscCode);
        }
      }
      
      // Update just the product requirement body content
      function updateProductReqBodyContent(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const body = document.getElementById('product-req-body-' + sanitizedCode);
        if (!body) return;
        
        const req = productRequirements[unspscCode] || { requirementType: null, attributes: [], description: '' };
        const unspsc = { code: unspscCode, description: '' }; // We don't need full description for the body
        
        body.innerHTML = renderProductRequirementBody(unspsc, req);
        body.style.display = 'block';
        body.closest('.product-req-item').classList.add('expanded');
      }
      
      // Update product requirement status badge
      function updateProductReqStatus(unspscCode) {
        const item = document.querySelector(`.product-req-item[data-unspsc="${unspscCode}"]`);
        if (!item) return;
        
        const req = productRequirements[unspscCode] || { requirementType: null, attributes: [], description: '', uploadedFile: null };
        const hasRequirements = req.requirementType && (req.attributes.length > 0 || req.description);
        
        const statusBadge = item.querySelector('.status-badge');
        if (statusBadge) {
          statusBadge.className = 'status-badge ' + (hasRequirements ? 'status-complete' : 'status-pending');
          statusBadge.textContent = hasRequirements ? '‚úì Defined' : '‚óã Pending';
        }
        
        if (hasRequirements) {
          item.classList.add('has-requirements');
        } else {
          item.classList.remove('has-requirements');
        }
      }
      
      // Download product requirements template
      window.downloadProductReqTemplate = function() {
        const csvContent = `UNSPSC Code,Description,Requirement Type,Attribute Name,Attribute Value,Free Text Description
# Instructions: Fill in requirements for each UNSPSC code
# Requirement Type: Use "attributes" for structured data or "description" for free text
# For attributes: Fill Attribute Name and Attribute Value columns (one row per attribute)
# For description: Fill the Free Text Description column
# Example rows below:
43211503,Laptop computers,attributes,Processor,Intel Core i7,
43211503,Laptop computers,attributes,RAM,16GB DDR4,
43211503,Laptop computers,attributes,Storage,512GB SSD,
72151500,Building cleaning services,description,,,Professional cleaning services including daily office cleaning and monthly deep cleaning. Must use eco-friendly products.`;
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'product_requirements_template.csv';
        link.click();
        
        showNotification('Template downloaded! Fill in requirements and upload.', 'success');
      }
      
      // Handle product requirements upload
      window.handleProductReqUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result;
          const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
          
          // Skip header
          const dataLines = lines.slice(1);
          
          dataLines.forEach(line => {
            const parts = line.split(',').map(p => p.trim());
            if (parts.length >= 3) {
              const [unspscCode, description, reqType, attrName, attrValue, freeText] = parts;
              
              if (!productRequirements[unspscCode]) {
                productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '' };
              }
              
              if (reqType === 'attributes' && attrName) {
                productRequirements[unspscCode].requirementType = 'attributes';
                productRequirements[unspscCode].attributes.push({
                  name: attrName,
                  value: attrValue || ''
                });
              } else if (reqType === 'description' && freeText) {
                productRequirements[unspscCode].requirementType = 'description';
                productRequirements[unspscCode].description = freeText;
              }
            }
          });
          
          // Refresh the product requirements section only
          const section = document.getElementById('product-requirements-section');
          if (section) {
            const body = section.querySelector('.collapsible-body');
            if (body) {
              // Re-render product requirements content based on partial quotations selection
              let unspscCodesToShow = [];
              
              if (allowPartialQuotations === 'Yes') {
                // YES: Show products from Lots
                lots.forEach(lot => {
                  lot.unspscCodes.forEach(unspsc => {
                    unspscCodesToShow.push({
                      code: unspsc.code,
                      description: unspsc.description,
                      source: 'lot',
                      sourceId: lot.id,
                      lotDescription: lot.description,
                    });
                  });
                });
              } else if (allowPartialQuotations === 'No') {
                // NO: Show products from Products and Services
                unspscCodesToShow = productsAndServices.map(item => ({
                  code: item.unspscCode,
                  description: item.unspscDescription,
                  source: 'product',
                  sourceId: item.id,
                }));
              }
              
              const uniqueUnspscCodes = [];
              const seenCodes = new Set();
              unspscCodesToShow.forEach(item => {
                if (!seenCodes.has(item.code)) {
                  seenCodes.add(item.code);
                  uniqueUnspscCodes.push(item);
                }
              });
              
              body.innerHTML = renderProductRequirementsContent(uniqueUnspscCodes);
            }
          }
          
          showNotification('Requirements imported successfully!', 'success');
        };
        
        reader.readAsText(file);
        event.target.value = '';
      }
      
      // Render Other Requirements Content (3-column layout)
      function renderOtherRequirementsContent() {
        return `
          <!-- Priced Items - Compact -->
          <div class="other-req-subsection">
            <div class="subsection-header">
              <span class="subsection-title">Priced Items</span>
              <button class="btn btn-secondary btn-sm" onclick="addServiceLine()"><i class="pi pi-plus"></i> Add</button>
            </div>
            <div class="subsection-body">
              <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: 8px 12px; margin-bottom: var(--spacing-sm); font-size: 11px; color: var(--success-700);">
                <strong>üí∞ Priced:</strong> Each line added here will be part of the financial bid. Suppliers will be required to provide a price.
              </div>
              <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: 8px 12px; margin-bottom: var(--spacing-sm); font-size: 11px; color: var(--text-secondary);">
                <strong>Compliance Requirements:</strong> Lines marked as "Mandatory" require suppliers to confirm compliance.
              </div>
              ${tenderAuthorConfig.serviceDescriptions.length === 0 ? `
                <div style="text-align: center; padding: var(--spacing-md); color: var(--text-muted); font-size: 12px; border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                  No priced items. Click "+ Add" to create one.
                </div>
              ` : `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  ${tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div class="service-line-compact" style="flex-wrap: wrap;">
                      <input type="text" class="form-input" value="${service.name}" placeholder="Item name" onchange="updateServiceLine(${idx}, 'name', this.value)" style="flex: 1; min-width: 120px; font-size: 12px; padding: 6px 10px;" />
                      <input type="text" class="form-input" value="${service.description || ''}" placeholder="Description (optional)" onchange="updateServiceLine(${idx}, 'description', this.value)" style="flex: 2; min-width: 150px; font-size: 12px; padding: 6px 10px;" />
                      <select class="form-select" onchange="updateServiceLineApplyTo(${idx}, this.value)" style="flex: 0 0 auto; width: 140px; font-size: 12px; padding: 6px 10px;">
                        <option value="all" ${service.applyTo === 'all' || !service.applyTo ? 'selected' : ''}>Entire Tender</option>
                        ${lots.map((lot, lotIdx) => `<option value="lot_${lot.id}" ${service.applyTo === 'lot_' + lot.id ? 'selected' : ''}>Lot ${lotIdx + 1}${lot.description ? ' - ' + lot.description.substring(0, 15) + (lot.description.length > 15 ? '...' : '') : ''}</option>`).join('')}
                      </select>
                      <div class="mandatory-toggle" title="Toggle whether this requirement is mandatory for suppliers to comply">
                        <div class="mandatory-toggle-switch ${service.isMandatory !== false ? 'active' : ''}" onclick="toggleServiceLineMandatory(${idx})"></div>
                        <span class="mandatory-toggle-label ${service.isMandatory !== false ? 'mandatory' : 'optional'}">${service.isMandatory !== false ? 'Mandatory' : 'Optional'}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeServiceLine(${idx})" style="font-size: 12px;">√ó</button>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
          
          <!-- Non Priced Items - Grid Layout -->
          <div class="other-req-subsection" style="margin-top: var(--spacing-md);">
            <div class="subsection-header">
              <span class="subsection-title">Non Priced Items</span>
              <button class="btn btn-secondary btn-sm" onclick="addSpecificRequirement()"><i class="pi pi-plus"></i> Add</button>
            </div>
            <div class="subsection-body">
              <div style="background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm); padding: 8px 12px; margin-bottom: var(--spacing-sm); font-size: 11px; color: var(--info-700);">
                <strong>‚ÑπÔ∏è Not Priced:</strong> These are informational conditions and do not require suppliers to provide a separate price.
              </div>
              <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: 8px 12px; margin-bottom: var(--spacing-sm); font-size: 11px; color: var(--text-secondary);">
                <strong>Compliance Requirements:</strong> Lines marked as "Mandatory" require suppliers to confirm compliance.
              </div>
              ${tenderAuthorConfig.specificRequirements.length === 0 ? `
                <div style="text-align: center; padding: var(--spacing-md); color: var(--text-muted); font-size: 12px; border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                  No non-priced items defined. Click "+ Add" to create one.
                </div>
              ` : `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  ${tenderAuthorConfig.specificRequirements.map((req, idx) => `
                    <div class="service-line-compact" style="flex-wrap: wrap;">
                      ${req.isPredefined ? `
                        <input type="text" class="form-input" value="${req.name}" readonly disabled style="flex: 0 0 auto; width: 140px; font-size: 12px; padding: 6px 10px; background: var(--surface-100); color: var(--text-secondary); cursor: not-allowed;" title="Predefined field - cannot be renamed" />
                      ` : `
                        <select class="form-select" onchange="handleRequirementNameChange(${idx}, this.value)" style="flex: 0 0 auto; width: 160px; font-size: 12px; padding: 6px 10px;">
                          <option value="">Select type...</option>
                          ${PREDEFINED_REQUIREMENT_NAMES.map(name => '<option value="' + name + '"' + (req.name === name ? ' selected' : '') + '>' + name + '</option>').join('')}
                          <option value="__custom__" ${req.isCustom || (req.name && !PREDEFINED_REQUIREMENT_NAMES.includes(req.name)) ? 'selected' : ''}>Custom...</option>
                        </select>
                        ${req.isCustom || (req.name && !PREDEFINED_REQUIREMENT_NAMES.includes(req.name)) ? '<input type="text" class="form-input" value="' + req.name + '" placeholder="Custom name" onchange="updateSpecificRequirement(' + idx + ', \'name\', this.value)" style="flex: 1; min-width: 100px; font-size: 12px; padding: 6px 10px;" />' : ''}
                      `}
                      <input type="text" class="form-input" value="${req.description || ''}" placeholder="Description (optional)" onchange="updateSpecificRequirement(${idx}, 'description', this.value)" style="flex: 2; min-width: 150px; font-size: 12px; padding: 6px 10px;" />
                      <select class="form-select" onchange="updateSpecificRequirementApplyTo(${idx}, this.value)" style="flex: 0 0 auto; width: 140px; font-size: 12px; padding: 6px 10px;">
                        <option value="all" ${req.applyTo === 'all' || !req.applyTo ? 'selected' : ''}>Entire Tender</option>
                        ${lots.map((lot, lotIdx) => `<option value="lot_${lot.id}" ${req.applyTo === 'lot_' + lot.id ? 'selected' : ''}>Lot ${lotIdx + 1}${lot.description ? ' - ' + lot.description.substring(0, 15) + (lot.description.length > 15 ? '...' : '') : ''}</option>`).join('')}
                      </select>
                      <div class="mandatory-toggle" title="Toggle whether this requirement is mandatory for suppliers to comply">
                        <div class="mandatory-toggle-switch ${req.isMandatory !== false ? 'active' : ''}" onclick="toggleSpecificRequirementMandatory(${idx})"></div>
                        <span class="mandatory-toggle-label ${req.isMandatory !== false ? 'mandatory' : 'optional'}">${req.isMandatory !== false ? 'Mandatory' : 'Optional'}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeSpecificRequirement(${idx})" style="font-size: 12px;">√ó</button>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      // ===== PRODUCT REQUIREMENTS FUNCTIONS =====
      function renderProductRequirementsSection(block, section, sectionIndex, isFirst) {
        // Get all UNSPSC codes based on partial quotations selection
        let unspscCodesToShow = [];
        
        if (allowPartialQuotations === 'Yes') {
          // YES: Show products from Lots
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                source: 'lot',
                sourceId: lot.id,
                lotDescription: lot.description,
              });
            });
          });
        } else if (allowPartialQuotations === 'No') {
          // NO: Show products from Products and Services
          unspscCodesToShow = productsAndServices.map(item => ({
            code: item.unspscCode,
            description: item.unspscDescription,
            source: 'product',
            sourceId: item.id,
          }));
        }
        // If not selected yet, show nothing
        
        // Remove duplicates (same UNSPSC code)
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Define requirements for each UNSPSC code. Choose either a description field for free-text or structured attributes with specific values.
                </div>
              </div>
              
              <!-- Spreadsheet Import/Export -->
              <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                <button class="btn btn-secondary btn-sm" onclick="exportProductRequirementsToSpreadsheet()">
                  <span>üì•</span> Export to Spreadsheet
                </button>
                <button class="btn btn-secondary btn-sm" onclick="uploadProductRequirementsSpreadsheet()">
                  <span>üì§</span> Upload from Spreadsheet
                </button>
                <span style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; margin-left: auto;">
                  Use spreadsheet templates to bulk manage requirements
                </span>
              </div>
              
              ${uniqueUnspscCodes.length === 0 ? `
                <div class="empty-state">
                  <div class="empty-state-icon">üìã</div>
                  <div class="empty-state-text">No UNSPSC codes available</div>
                  <div class="empty-state-hint">${lots.length === 0 ? 'Add requisition lines or create lots with products to define requirements.' : 'Add products to lots to define requirements.'}</div>
                </div>
              ` : `
                <div class="product-requirements-list">
                  ${uniqueUnspscCodes.map(unspsc => {
                    const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                    return `
                      <div class="product-requirement-card" data-unspsc="${unspsc.code}">
                        <div class="product-requirement-header">
                          <div class="product-requirement-title">
                            <span class="unspsc-code-large">${unspsc.code}</span>
                            <span class="unspsc-description-large">${unspsc.description}</span>
                            ${unspsc.lotDescription ? `<span class="lot-badge">Lot: ${unspsc.lotDescription}</span>` : ''}
                          </div>
                        </div>
                        
                        <div class="product-requirement-body">
                          <!-- Requirements -->
                          <div class="requirement-section">
                            <div class="requirement-section-header">
                              <h4>Requirements</h4>
                              ${req.requirementType === 'description' ? `
                                <button class="btn btn-ghost btn-sm" onclick="switchToAttributes('${unspsc.code}')">Switch to Attributes</button>
                              ` : req.attributes && req.attributes.length > 0 ? `
                                <button class="btn btn-ghost btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">+ Add Attribute</button>
                              ` : ''}
                            </div>
                            
                            ${!req.requirementType || (req.attributes.length === 0 && !req.description) ? `
                              <div class="requirement-empty">
                                <p>Choose how you want to define requirements for this product:</p>
                                <div style="display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-md);">
                                  <button class="btn btn-primary btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">
                                    <span style="font-size: 18px;">üìã</span> Add Attributes
                                  </button>
                                  <span style="display: flex; align-items: center; color: var(--text-muted); font-weight: 600;">OR</span>
                                  <button class="btn btn-primary btn-sm" onclick="addDescriptionField('${unspsc.code}')">
                                    <span style="font-size: 18px;">üìù</span> Add Description Field
                                  </button>
                                </div>
                                <p style="margin-top: var(--spacing-md); font-size: 13px; color: var(--text-muted); text-align: center;">
                                  Use <strong>Attributes</strong> for structured data (e.g., "Printing technology: Laser") or <strong>Description</strong> for free-text service descriptions
                                </p>
                              </div>
                            ` : req.requirementType === 'description' ? `
                              <div class="requirement-description">
                                <div class="form-group">
                                  <label class="form-label">Product/Service Description</label>
                                  <div class="rich-text-editor-container">
                                    <div class="rich-text-toolbar">
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'italic')" title="Italic (Ctrl+I)"><em>I</em></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'strikeThrough')" title="Strikethrough"><s>S</s></button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'h3')" title="Heading">H1</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'h4')" title="Subheading">H2</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'p')" title="Normal Text">¬∂</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertOrderedList')" title="Numbered List">1. List</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'indent')" title="Increase Indent">‚Üí</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'outdent')" title="Decrease Indent">‚Üê</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyLeft')" title="Align Left">‚¨Ö</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyCenter')" title="Align Center">‚¨å</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyRight')" title="Align Right">‚û°</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="insertLinkByCode('${unspsc.code}')" title="Insert Link">üîó Link</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertHorizontalRule')" title="Insert Line">‚Äî</button>
                                        <button type="button" class="toolbar-btn" onclick="clearFormattingByCode('${unspsc.code}')" title="Clear Formatting">‚úñ Clear</button>
                                      </div>
                                    </div>
                                    <div 
                                      id="rich-text-editor-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}"
                                      class="rich-text-editor" 
                                      contenteditable="true"
                                      data-unspsc="${unspsc.code}"
                                      placeholder="Enter a detailed description of what you want to buy for this product/service. You can include specifications, requirements, quality standards, etc."
                                      oninput="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                                      onblur="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                                      onkeydown="handleEditorKeydown(event, '${unspsc.code}')"
                                    >${req.description || ''}</div>
                                    <div class="editor-footer">
                                      <div class="editor-word-count">
                                        <span id="word-count-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}">Words: 0</span>
                                        <span id="char-count-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}">Characters: 0</span>
                                      </div>
                                      <span>üí° Use formatting tools above to structure your content</span>
                                    </div>
                                  </div>
                                  <span class="help-text">Use this field for detailed, formatted descriptions (ideal for services). Supports rich text formatting, lists, links, and more.</span>
                                </div>
                                <div class="requirement-actions">
                                  <button class="btn btn-ghost btn-sm btn-danger" onclick="clearRequirements('${unspsc.code}')">Clear & Start Over</button>
                                </div>
                              </div>
                            ` : `
                              <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: 8px 12px; margin-bottom: var(--spacing-sm); font-size: 11px; color: var(--text-secondary);">
                                <strong>Compliance Requirements:</strong> Lines marked as "Mandatory" require suppliers to confirm compliance.
                              </div>
                              <div class="requirement-attributes-list">
                                ${req.attributes.map((attr, idx) => `
                                  <div class="requirement-attribute-item">
                                    <div class="attribute-row">
                                      <div class="attribute-name">
                                        <input type="text" class="attribute-name-input" value="${attr.name}" placeholder="Attribute name (e.g., Printing technology)" onchange="updateAttributeName('${unspsc.code}', ${idx}, this.value)" />
                                      </div>
                                      <div class="attribute-value">
                                        <input type="text" class="attribute-value-input" value="${attr.value}" placeholder="Value (e.g., Laser (Monochrome))" onchange="updateAttributeValue('${unspsc.code}', ${idx}, this.value)" />
                                      </div>
                                      <div class="mandatory-toggle" title="Toggle whether this requirement is mandatory for suppliers to comply">
                                        <div class="mandatory-toggle-switch ${attr.isMandatory !== false ? 'active' : ''}" onclick="toggleAttributeMandatory('${unspsc.code}', ${idx})"></div>
                                        <span class="mandatory-toggle-label ${attr.isMandatory !== false ? 'mandatory' : 'optional'}">${attr.isMandatory !== false ? 'Mandatory' : 'Optional'}</span>
                                      </div>
                                      <button class="btn-icon-sm" onclick="removeAttribute('${unspsc.code}', ${idx})" title="Remove">‚úñ</button>
                                    </div>
                                  </div>
                                `).join('')}
                              </div>
                              <div class="requirement-actions">
                                <button class="btn btn-ghost btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">+ Add Another Attribute</button>
                                <button class="btn btn-ghost btn-sm btn-danger" onclick="clearRequirements('${unspsc.code}')">Clear & Start Over</button>
                              </div>
                            `}
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      window.addRequirementAttribute = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'attributes', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'attributes';
        productRequirements[unspscCode].attributes.push({
          name: '',
          value: '',
          isMandatory: true, // Default to mandatory
        });
        
        renderCurrentBlock();
      }
      
      window.addDescriptionField = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'description', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'description';
        productRequirements[unspscCode].description = '';
        productRequirements[unspscCode].attributes = []; // Clear attributes
        
        renderCurrentBlock();
        
        // Initialize word count after DOM is updated
        setTimeout(() => {
          initializeEditorWordCount(unspscCode);
        }, 100);
      }
      
      window.updateRequirementDescription = function(unspscCode, newDescription) {
        if (productRequirements[unspscCode]) {
          productRequirements[unspscCode].description = newDescription;
        }
      }
      
      window.updateRequirementDescriptionFromEditor = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        if (editor && productRequirements[unspscCode]) {
          productRequirements[unspscCode].description = editor.innerHTML;
          
          // Update word and character count
          const text = editor.innerText || editor.textContent || '';
          const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
          const chars = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${sanitizedCode}`);
          const charCountEl = document.getElementById(`char-count-${sanitizedCode}`);
          
          if (wordCountEl) wordCountEl.textContent = `Words: ${words}`;
          if (charCountEl) charCountEl.textContent = `Characters: ${chars}`;
        }
      }

      window.initializeEditorWordCount = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        
        if (editor) {
          const text = editor.innerText || editor.textContent || '';
          const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
          const chars = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${sanitizedCode}`);
          const charCountEl = document.getElementById(`char-count-${sanitizedCode}`);
          
          if (wordCountEl) wordCountEl.textContent = `Words: ${words}`;
          if (charCountEl) charCountEl.textContent = `Characters: ${chars}`;
          
          // Focus the editor to make it obvious it's ready
          editor.focus();
        }
      }
      
      window.formatText = function(unspscCode, command, value = null) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        if (!editor) return;
        
        editor.focus();
        document.execCommand(command, false, value);
        updateRequirementDescriptionFromEditor(unspscCode);
      }
      
      window.formatTextByCode = function(unspscCode, command, value = null) {
        formatText(unspscCode, command, value);
      }

      window.insertLinkByCode = function(unspscCode) {
        try {
          const url = prompt('Enter the URL:', 'https://');
          if (url && url.trim() !== '' && url !== 'https://') {
            formatText(unspscCode, 'createLink', url);
          }
        } catch (error) {
          console.error('Error inserting link:', error);
        }
      }

      window.clearFormattingByCode = function(unspscCode) {
        try {
          if (confirm('Remove all formatting from selected text?')) {
            formatText(unspscCode, 'removeFormat');
          }
        } catch (error) {
          console.error('Error clearing formatting:', error);
        }
      }

      window.handleEditorKeydown = function(event, unspscCode) {
        try {
          // Handle keyboard shortcuts
          if (event.ctrlKey || event.metaKey) {
            switch(event.key.toLowerCase()) {
              case 'b':
                event.preventDefault();
                formatText(unspscCode, 'bold');
                break;
              case 'i':
                event.preventDefault();
                formatText(unspscCode, 'italic');
                break;
              case 'u':
                event.preventDefault();
                formatText(unspscCode, 'underline');
                break;
              case 'k':
                event.preventDefault();
                insertLinkByCode(unspscCode);
                break;
            }
          }
          
          // Tab for indent (prevent leaving editor)
          if (event.key === 'Tab') {
            event.preventDefault();
            if (event.shiftKey) {
              formatText(unspscCode, 'outdent');
            } else {
              formatText(unspscCode, 'indent');
            }
          }
        } catch (error) {
          console.error('Error handling keyboard shortcut:', error);
        }
      }
      
      window.switchToAttributes = function(unspscCode) {
        if (confirm('Switching to attributes will clear your description. Continue?')) {
          productRequirements[unspscCode].requirementType = 'attributes';
          productRequirements[unspscCode].description = '';
          productRequirements[unspscCode].attributes = [];
          renderCurrentBlock();
        }
      }
      
      window.clearRequirements = function(unspscCode) {
        if (confirm('This will clear all requirements for this UNSPSC code. Continue?')) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '' };
          renderCurrentBlock();
        }
      }
      
      window.updateAttributeName = function(unspscCode, index, newName) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes[index].name = newName;
        }
      }
      
      window.updateAttributeValue = function(unspscCode, index, newValue) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes[index].value = newValue;
        }
      }
      
      // Toggle mandatory status for product attribute
      window.toggleAttributeMandatory = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          const current = productRequirements[unspscCode].attributes[index].isMandatory;
          productRequirements[unspscCode].attributes[index].isMandatory = current === false ? true : !current;
          renderCurrentBlock();
        }
      }
      
      window.removeAttribute = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      window.exportProductRequirementsToSpreadsheet = function() {
        alert('Export to spreadsheet functionality: This would generate an Excel template with all UNSPSC codes and their requirements.');
      }
      
      window.uploadProductRequirementsSpreadsheet = function() {
        alert('Upload spreadsheet functionality: This would open a file picker to upload an Excel file with requirements data.');
      }
      
      // ===== BID RESPONSE FIELDS MANAGEMENT =====
      window.addBidResponseField = function(section) {
        const fieldName = prompt('Enter field name:');
        if (!fieldName) return;
        
        const fieldType = prompt('Enter field type (e.g., Text input, Currency input, Yes/No radio, Text area, etc.):');
        if (!fieldType) return;
        
        const newField = {
          id: `custom_${fieldIdCounter++}`,
          name: fieldName,
          type: fieldType || 'Text input'
        };
        
        bidResponseFields[section].push(newField);
        renderCurrentBlock();
      }
      
      window.removeBidResponseField = function(section, fieldId) {
        if (confirm('Are you sure you want to remove this field?')) {
          const index = bidResponseFields[section].findIndex(f => f.id === fieldId);
          if (index !== -1) {
            bidResponseFields[section].splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      // ===== SUBMISSION FORMS MANAGEMENT =====
      window.toggleSubmissionForm = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (form) {
          form.added = !form.added;
          renderCurrentBlock();
        }
      }
      
      window.toggleFormPreview = function(formId) {
        // Redirect to the new preview modal
        openFormPreviewModal(formId);
      }
      
      window.handleFormsDragOver = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('submission-forms-drop-zone');
        if (dropZone) {
          dropZone.classList.add('drag-over');
        }
      }
      
      window.handleFormsDragLeave = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('submission-forms-drop-zone');
        if (dropZone) {
          dropZone.classList.remove('drag-over');
        }
      }
      
      window.handleFormsDrop = function(event) {
        event.preventDefault();
        event.stopPropagation();
        
        const dropZone = document.getElementById('submission-forms-drop-zone');
        if (dropZone) {
          dropZone.classList.remove('drag-over');
        }
        
        // Get the form data from the dragged item (from form library)
        const formType = event.dataTransfer.getData('form-type');
        const formName = event.dataTransfer.getData('form-name');
        
        if (formType && formName) {
          // Check if this form already exists by name match
          const existingForm = submissionForms.find(f => 
            f.name.toLowerCase() === formName.toLowerCase() ||
            f.name.toLowerCase().includes(formName.toLowerCase().split(' ')[0])
          );
          
          if (existingForm) {
            // If form exists but not added, add it
            if (!existingForm.added) {
              existingForm.added = true;
              renderCurrentBlock();
            }
          } else {
            // Add new form to the list
            const icons = {
              'instructions': 'üìã',
              'contracts': 'üìù',
              'bank-guarantee': 'üè¶',
              'bid-security': 'üîí',
              'drive-questionnaire': 'üõ°Ô∏è',
              'technical-specs': '‚öôÔ∏è',
              'evaluation': '‚úÖ',
              'price-schedule': 'üí∞'
            };
            
            const newForm = {
              id: `form-custom-${Date.now()}`,
              code: String.fromCharCode(65 + submissionForms.length), // Next letter (I, J, K...)
              name: formName,
              description: `Custom form added from library`,
              icon: icons[formType] || 'üìÑ',
              required: false,
              added: true,
              hasConfig: false,
              attachments: [],
              badge: 'optional'
            };
            submissionForms.push(newForm);
            renderCurrentBlock();
          }
        }
      }
      
      window.handleFormCardDragStart = function(event, formId) {
        event.dataTransfer.setData('text/plain', formId);
        event.dataTransfer.setData('source', 'submission-forms');
        event.dataTransfer.effectAllowed = 'move';
      }
      
      // ===== DOCUMENTS SECTION FUNCTIONS =====
      
      // Handle document drag over
      window.handleDocumentDragOver = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('documents-drop-zone');
        if (dropZone) {
          dropZone.style.borderColor = 'var(--primary-500)';
          dropZone.style.background = 'var(--primary-50)';
        }
      }
      
      // Handle document drag leave
      window.handleDocumentDragLeave = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('documents-drop-zone');
        if (dropZone) {
          dropZone.style.borderColor = 'var(--surface-300)';
          dropZone.style.background = 'var(--surface-50)';
        }
      }
      
      // Handle document drop
      window.handleDocumentDrop = function(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropZone = document.getElementById('documents-drop-zone');
        if (dropZone) {
          dropZone.style.borderColor = 'var(--surface-300)';
          dropZone.style.background = 'var(--surface-50)';
        }
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          addDocumentsFromFiles(files);
        }
      }
      
      // Handle document file select
      window.handleDocumentFileSelect = function(event) {
        const files = event.target.files;
        if (files.length > 0) {
          addDocumentsFromFiles(files);
        }
        event.target.value = ''; // Reset input
      }
      
      // Add documents from files
      function addDocumentsFromFiles(files) {
        const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const extension = file.name.split('.').pop().toLowerCase();
          const sizeKB = Math.round(file.size / 1024);
          const sizeStr = sizeKB > 1024 ? `${(sizeKB / 1024).toFixed(1)} MB` : `${sizeKB} KB`;
          
          tenderDocuments.push({
            id: Date.now() + i,
            name: file.name,
            type: 'attachment',
            fileType: extension,
            size: sizeStr,
            dateAdded: today,
            required: false,
            file: file
          });
        }
        
        // Re-render the documents section
        renderCurrentBlock();
        showNotification(`${files.length} document${files.length > 1 ? 's' : ''} added successfully!`, 'success');
      }
      
      // Remove document
      window.removeDocument = function(index) {
        if (index >= 0 && index < tenderDocuments.length) {
          const docName = tenderDocuments[index].name;
          tenderDocuments.splice(index, 1);
          renderCurrentBlock();
          showNotification(`"${docName}" removed`, 'info');
        }
      }
      
      // Toggle document required status
      window.toggleDocumentRequired = function(index) {
        if (index >= 0 && index < tenderDocuments.length) {
          tenderDocuments[index].required = !tenderDocuments[index].required;
          renderCurrentBlock();
        }
      }
      
      // Preview document
      window.previewDocument = function(index) {
        if (index >= 0 && index < tenderDocuments.length) {
          const doc = tenderDocuments[index];
          if (doc.type === 'form') {
            // For form templates, show form preview modal
            const form = submissionForms.find(f => f.id === doc.formId);
            if (form) {
              openFormPreviewModal(form.id);
            } else {
              showNotification('Form preview not available', 'warning');
            }
          } else if (doc.file) {
            // For uploaded files, create object URL and open in new tab
            const url = URL.createObjectURL(doc.file);
            window.open(url, '_blank');
          } else {
            showNotification('Preview not available', 'warning');
          }
        }
      }
      
      // Open Add Form Document Modal
      window.openAddFormDocumentModal = function() {
        const modal = document.getElementById('add-form-document-modal');
        if (modal) {
          modal.classList.add('show');
          renderFormDocumentList();
        }
      }
      
      // Close Add Form Document Modal
      window.closeAddFormDocumentModal = function() {
        const modal = document.getElementById('add-form-document-modal');
        if (modal) {
          modal.classList.remove('show');
        }
      }
      
      // Render form document list in modal
      function renderFormDocumentList() {
        const listEl = document.getElementById('form-document-list');
        if (!listEl) return;
        
        // Get forms that haven't been added as documents yet
        const addedFormIds = tenderDocuments.filter(d => d.type === 'form').map(d => d.formId);
        const availableForms = submissionForms.filter(f => f.added && !addedFormIds.includes(f.id));
        
        if (availableForms.length === 0) {
          listEl.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <div style="font-size: 2em; margin-bottom: var(--spacing-md);"><i class="pi pi-check-circle"></i></div>
              <div>All available forms have been added to documents</div>
            </div>
          `;
          return;
        }
        
        listEl.innerHTML = availableForms.map(form => `
          <div class="form-document-item" style="display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-md); margin-bottom: var(--spacing-sm);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
              <div style="width: 36px; height: 36px; background: var(--primary-100); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.2em;">
                ${form.icon}
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">${form.name}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${form.description}</div>
              </div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="addFormAsDocument('${form.id}')">
              <i class="pi pi-plus" style="margin-right: 4px;"></i> Add
            </button>
          </div>
        `).join('');
      }
      
      // Add form as document
      window.addFormAsDocument = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (!form) return;
        
        const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        tenderDocuments.push({
          id: Date.now(),
          name: form.name,
          type: 'form',
          formId: form.id,
          dateAdded: today,
          required: form.required
        });
        
        // Re-render the form list in modal
        renderFormDocumentList();
        // Re-render the main documents section
        renderCurrentBlock();
        showNotification(`"${form.name}" added to documents`, 'success');
      }
      
      // ===== FORM PREVIEW, CONFIG, AND ATTACHMENT MODAL FUNCTIONS =====
      let currentFormForModal = null;
      
      // Form Preview Modal
      window.openFormPreviewModal = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (!form) return;
        
        currentFormForModal = form;
        const modal = document.getElementById('form-preview-modal');
        const titleEl = document.getElementById('form-preview-title');
        const bodyEl = document.getElementById('form-preview-body');
        
        // Custom titles for specific forms
        if (formId === 'form-a') {
          titleEl.innerHTML = '<i class="pi pi-user" style="margin-right: 8px;"></i> Bidder\'s Information';
        } else if (formId === 'form-d') {
          titleEl.innerHTML = '<i class="pi pi-cog" style="margin-right: 8px;"></i> Technical Bid';
        } else if (formId === 'form-c') {
          titleEl.innerHTML = '<i class="pi pi-dollar" style="margin-right: 8px;"></i> Financial Bid';
        } else if (formId === 'form-qual') {
          titleEl.innerHTML = '<i class="pi pi-verified" style="margin-right: 8px;"></i> Qualifications & Eligibility';
        } else if (formId === 'form-compliance') {
          titleEl.innerHTML = '<i class="pi pi-check-circle" style="margin-right: 8px;"></i> Compliance & Declarations';
        } else {
        titleEl.textContent = `Form ${form.code}: ${form.name}`;
        }
        bodyEl.innerHTML = generateFormPreviewContent(form);
        
        // Add event listeners for bid type toggle in form-a
        if (formId === 'form-a') {
          setTimeout(() => {
            const singleRadio = bodyEl.querySelector('#single');
            const consortiumRadio = bodyEl.querySelector('#consortium');
            if (singleRadio && consortiumRadio) {
              singleRadio.disabled = false;
              consortiumRadio.disabled = false;
              singleRadio.addEventListener('change', toggleBidTypeSection);
              consortiumRadio.addEventListener('change', toggleBidTypeSection);
            }
          }, 0);
        }
        
        modal.classList.add('show');
      }
      
      // Toggle between Single Company and Consortium sections in form-a preview
      window.toggleBidTypeSection = function() {
        const singleSection = document.getElementById('singleCompanySection');
        const consortiumSection = document.getElementById('consortiumSection');
        const singleRadio = document.getElementById('single');
        
        if (singleSection && consortiumSection && singleRadio) {
          if (singleRadio.checked) {
            singleSection.style.display = 'block';
            consortiumSection.style.display = 'none';
          } else {
            singleSection.style.display = 'none';
            consortiumSection.style.display = 'block';
          }
        }
      }
      
      window.closeFormPreviewModal = function() {
        document.getElementById('form-preview-modal').classList.remove('show');
        currentFormForModal = null;
      }
      
      function generateFormPreviewContent(form) {
        // Generate comprehensive supplier view preview based on form type
        const formPreviews = {
          'form-a': `
            <div class="supplier-form-preview">
              <div class="supplier-form-section">
                <div class="supplier-form-section-header"><i class="pi pi-user" style="margin-right: 8px;"></i> Bidder's Information</div>
                <div class="supplier-form-section-body">
                  
                  <!-- Bidding As Radio Selection -->
                  <div style="background: linear-gradient(135deg, var(--primary-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border: 2px solid var(--primary-200); border-radius: var(--radius-lg); margin: var(--spacing-lg) 0;">
                    <label style="font-weight: 600; color: var(--primary-700); margin-bottom: 12px; display: block; font-size: 1.05em;">
                      <i class="pi pi-briefcase" style="margin-right: 8px;"></i> Bidding as <span style="color: var(--danger-500);">*</span>
                    </label>
                    <div style="display: flex; gap: 24px; margin-top: 12px;">
                      <div style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; background: white; border: 2px solid var(--primary-400); border-radius: var(--radius-md); cursor: pointer; box-shadow: 0 2px 8px rgba(0, 118, 189, 0.15);">
                        <input type="radio" name="bidType" id="single" value="single" checked disabled style="width: 18px; height: 18px; accent-color: var(--primary-500);">
                        <label for="single" style="cursor: pointer; font-weight: 500; color: var(--primary-600);"><i class="pi pi-building" style="margin-right: 6px;"></i> Single Company</label>
                      </div>
                      <div style="display: flex; align-items: center; gap: 10px; padding: 12px 20px; background: white; border: 2px solid var(--surface-300); border-radius: var(--radius-md); cursor: pointer;">
                        <input type="radio" name="bidType" id="consortium" value="consortium" disabled style="width: 18px; height: 18px; accent-color: var(--primary-500);">
                        <label for="consortium" style="cursor: pointer; font-weight: 500; color: var(--text-secondary);"><i class="pi pi-users" style="margin-right: 6px;"></i> Joint Venture / Consortium</label>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Single Company Section -->
                  <div id="singleCompanySection" style="margin-top: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-building" style="margin-right: 8px; color: var(--primary-500);"></i> Company Details</strong>
                  </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                  <div class="supplier-form-field">
                        <label><i class="pi pi-id-card" style="margin-right: 6px; color: var(--primary-500);"></i> Company Legal Name <span style="color: var(--danger-500);">*</span></label>
                        <input type="text" placeholder="Enter full legal name" disabled />
                      </div>

                      <div class="supplier-form-field">
                        <label><i class="pi pi-verified" style="margin-right: 6px; color: var(--primary-500);"></i> UNGM Vendor ID <span style="color: var(--text-muted); font-weight: 400;">(if registered)</span></label>
                        <div style="display: flex; gap: 12px;">
                          <input type="text" placeholder="UNGM-XXXXXX" disabled style="flex: 1;" />
                        </div>
                      </div>
                    </div>

                    <div class="supplier-form-field" style="margin-top: var(--spacing-md);">
                      <label><i class="pi pi-map-marker" style="margin-right: 6px; color: var(--primary-500);"></i> Full Business Address <span style="color: var(--danger-500);">*</span></label>
                      <textarea placeholder="Street address, City, State/Province, Postal Code, Country" rows="2" disabled></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                      <div class="supplier-form-field">
                        <label><i class="pi pi-envelope" style="margin-right: 6px; color: var(--primary-500);"></i> Primary Contact Email <span style="color: var(--danger-500);">*</span></label>
                        <input type="email" placeholder="contact@company.com" disabled />
                      </div>

                      <div class="supplier-form-field">
                        <label><i class="pi pi-phone" style="margin-right: 6px; color: var(--primary-500);"></i> Phone Number <span style="color: var(--danger-500);">*</span></label>
                        <input type="tel" placeholder="+X-XXX-XXX-XXXX" disabled />
                      </div>
                    </div>
                  </div>

                  <!-- Consortium Section (hidden by default in preview, shown when consortium selected) -->
                  <div id="consortiumSection" style="margin-top: var(--spacing-xl); display: none;">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--warning-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-users" style="margin-right: 8px; color: var(--warning-500);"></i> JV / Consortium / Association Information</strong>
                    </div>

                    <div class="supplier-form-field">
                      <label><i class="pi pi-sitemap" style="margin-right: 6px; color: var(--warning-500);"></i> JV / Consortium / Association Name <span style="color: var(--danger-500);">*</span></label>
                      <input type="text" placeholder="Enter the name of the Joint Venture, Consortium, or Association" disabled />
                  </div>
                  
                  <div class="supplier-form-note info" style="margin-top: var(--spacing-lg);">
                      <p><i class="pi pi-info-circle" style="margin-right: 6px;"></i> Add all partners in the Joint Venture/Consortium/Association below. For each partner, provide complete contact information and specify their share of responsibility. One partner must be designated as the <strong>Leading Partner</strong> who will have authority to bind the JV during the bidding process and contract execution.</p>
                  </div>
                  
                  <!-- Partner Card -->
                  <div style="background: white; border: 2px solid var(--primary-400); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-top: var(--spacing-lg); box-shadow: 0 4px 16px rgba(0, 118, 189, 0.15);">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--surface-200); margin-bottom: var(--spacing-md);">
                        <span style="font-size: 1.1em; font-weight: 600; color: var(--primary-500);"><i class="pi pi-user" style="margin-right: 8px;"></i> Partner 1</span>
                        <span style="background: var(--primary-500); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600;"><i class="pi pi-star-fill" style="margin-right: 4px;"></i> LEAD PARTNER</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                      <div class="supplier-form-field">
                          <label><i class="pi pi-id-card" style="margin-right: 6px; color: var(--primary-500);"></i> Name <span style="color: var(--danger-500);">*</span></label>
                        <input type="text" placeholder="Enter partner company name" disabled />
                      </div>
                      <div class="supplier-form-field">
                          <label><i class="pi pi-verified" style="margin-right: 6px; color: var(--primary-500);"></i> UNGM ID (if registered)</label>
                        <input type="text" placeholder="UNGM-XXXXXX" disabled />
                      </div>
                    </div>
                    
                    <div class="supplier-form-field" style="margin-top: var(--spacing-md);">
                        <label><i class="pi pi-map-marker" style="margin-right: 6px; color: var(--primary-500);"></i> Address <span style="color: var(--danger-500);">*</span></label>
                      <textarea placeholder="Complete address: Street, City, State/Province, Postal Code, Country" rows="2" disabled></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                      <div class="supplier-form-field">
                          <label><i class="pi pi-phone" style="margin-right: 6px; color: var(--primary-500);"></i> Telephone Number <span style="color: var(--danger-500);">*</span></label>
                        <input type="tel" placeholder="+X-XXX-XXX-XXXX" disabled />
                      </div>
                      <div class="supplier-form-field">
                          <label><i class="pi pi-print" style="margin-right: 6px; color: var(--text-muted);"></i> Fax Number</label>
                        <input type="tel" placeholder="+X-XXX-XXX-XXXX" disabled />
                      </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                      <div class="supplier-form-field">
                          <label><i class="pi pi-envelope" style="margin-right: 6px; color: var(--primary-500);"></i> E-mail Address <span style="color: var(--danger-500);">*</span></label>
                        <input type="email" placeholder="contact@company.com" disabled />
                      </div>
                      <div class="supplier-form-field">
                          <label><i class="pi pi-percentage" style="margin-right: 6px; color: var(--primary-500);"></i> Proposed Proportion of Responsibilities (%) <span style="color: var(--danger-500);">*</span></label>
                        <input type="number" placeholder="%" value="100" disabled />
                      </div>
                    </div>
                    
                    <div class="supplier-form-field" style="margin-top: var(--spacing-md);">
                        <label><i class="pi pi-box" style="margin-right: 6px; color: var(--primary-500);"></i> Type of Goods/Services to be Delivered by this Partner</label>
                      <textarea placeholder="Indicate the type of goods/services to be delivered by this partner" rows="2" disabled></textarea>
                    </div>
                    
                    <div style="margin-top: var(--spacing-md);">
                      <label style="display: flex; align-items: flex-start; gap: var(--spacing-sm); cursor: pointer;">
                        <input type="checkbox" checked disabled style="margin-top: 3px;" />
                        <span><strong>Leading Partner</strong> (with authority to bind the JV, Consortium, Association during the Bidding process and, in the event a Contract is awarded, during contract execution)</span>
                      </label>
                    </div>
                  </div>
                  
                  <!-- Percentage Summary -->
                  <div style="background: rgba(76, 159, 56, 0.1); border: 1px solid var(--success-500); border-radius: var(--radius-md); padding: var(--spacing-md); margin: var(--spacing-lg) 0; display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-weight: 600; font-size: 1.05em; color: var(--success-500);"><i class="pi pi-check-circle" style="margin-right: 8px;"></i> Total Share: 100%</span>
                    <span style="color: var(--success-500);">‚úì Valid</span>
                  </div>
                  
                    <button class="btn btn-secondary" style="margin-top: var(--spacing-md);" disabled><i class="pi pi-plus" style="margin-right: 6px;"></i> Add Partner</button>
                  
                  <div class="supplier-form-note" style="margin-top: var(--spacing-xl);">
                      <i class="pi pi-exclamation-triangle" style="margin-right: 6px; color: var(--warning-500);"></i> We hereby confirm that if the contract is awarded, all parties of the Joint Venture/Consortium/Association shall be jointly and severally liable to UNOPS for the fulfillment of the provisions of the Contract.
                  </div>
                  
                    <!-- Download/Upload Section (only for Consortium) -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-top: var(--spacing-xl);">
                    <div>
                      <button class="btn btn-primary" style="width: 100%;" disabled>
                          <i class="pi pi-download" style="margin-right: 8px;"></i> Download Form as PDF
                      </button>
                    </div>
                    <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--primary-600); font-size: 2em; margin-bottom: 8px;"><i class="pi pi-upload"></i></div>
                      <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Upload Signed Document</div>
                      <div style="font-size: 12px; color: var(--text-muted);">Click or drag file here</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `,
          'form-compliance': `
            <div class="supplier-form-preview">
              <div class="supplier-form-section">
                <div class="supplier-form-section-header"><i class="pi pi-check-circle" style="margin-right: 8px;"></i> Compliance & Declarations</div>
                <div class="supplier-form-section-body">

                  <!-- Section 1: Bid Submission Declaration -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-file-edit" style="margin-right: 8px; color: var(--primary-500);"></i> Section 1: Bid Submission Declaration</strong>
                  </div>
                  
                  <div class="supplier-form-note info">
                      <p><i class="pi pi-info-circle" style="margin-right: 6px;"></i> Fields highlighted in blue are <strong>pre-populated</strong> from previous steps and tender configuration. Please review for accuracy.</p>
                  </div>
                  
                  <div style="border: 2px solid var(--primary-500); padding: var(--spacing-xl); border-radius: var(--radius-lg); background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); box-shadow: 0 2px 8px rgba(0, 118, 189, 0.08);">
                    <p style="font-weight: 600; margin-bottom: var(--spacing-md);">We, the undersigned, declare that:</p>
                    <ol style="line-height: 1.8; padding-left: var(--spacing-lg); margin: 0;">
                      <li style="margin-bottom: var(--spacing-md);">We have examined and have no reservations to the bidding documents, including amendments: 
                        <div style="display: inline-flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                          <span class="prefilled-field" style="padding: 4px 10px; border-radius: 4px;">No. 01 - Dec 5, 2025</span>
                          <span class="prefilled-field" style="padding: 4px 10px; border-radius: 4px;">No. 02 - Dec 12, 2025</span>
                        </div>
                      </li>
                      <li style="margin-bottom: var(--spacing-md);">We offer to supply in conformity with the bidding documents, including the UNOPS General Conditions of Contract, and in accordance with the delivery schedules specified in the Schedule of Requirements;</li>
                      <li style="margin-bottom: var(--spacing-md);">The total price of our bid, excluding any discounts offered in item (d) below, is: 
                        <span class="prefilled-field" style="padding: 4px 12px; border-radius: 4px; margin: 0 5px;">USD 125,450.00</span>
                      </li>
                      <li style="margin-bottom: var(--spacing-md);">The discounts offered and the methodology for their application are:
                        <div class="prefilled-field" style="margin-top: 8px; padding: var(--spacing-md); border-radius: var(--radius-sm);">
                          <div style="margin-bottom: 6px;">‚Ä¢ <strong>Volume Discount:</strong> 3% discount for total order value exceeding $100,000</div>
                          <div style="margin-bottom: 6px;">‚Ä¢ <strong>Early Payment Discount:</strong> 2% discount if payment is made within 15 days</div>
                        </div>
                      </li>
                      <li style="margin-bottom: var(--spacing-md);">Our bid shall be valid for the period of time of <span class="prefilled-field" style="padding: 2px 8px; border-radius: 4px;">90</span> days from the date fixed for the bid submission deadline;</li>
                      <li style="margin-bottom: var(--spacing-md);">If our bid is accepted, and if so requested, we commit to obtain a performance security in accordance with the General Conditions of Contract;</li>
                      <li style="margin-bottom: var(--spacing-md);">We have no conflict of interest in any activity that would put us in conflict with UNOPS;</li>
                      <li style="margin-bottom: var(--spacing-md);">We have not declared bankruptcy, are not involved in bankruptcy proceedings;</li>
                      <li style="margin-bottom: var(--spacing-md);">Our firm confirms that we have not been associated with the preparation of these tender documents;</li>
                      <li style="margin-bottom: var(--spacing-md);">We embrace the principles of the United Nations Supplier Code of Conduct;</li>
                      <li style="margin-bottom: var(--spacing-md);">Our firm has not been declared ineligible by UNOPS or included in UN suspension lists;</li>
                      <li style="margin-bottom: var(--spacing-md);">We have not offered and will not offer any gifts or favours in exchange for this ITB;</li>
                      <li>We understand that you are not bound to accept the lowest evaluated bid or any other bid that you may receive.</li>
                    </ol>
                  </div>
                  </div>
                  
                  <!-- Section 2: Self Disclosure Form -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--warning-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-exclamation-triangle" style="margin-right: 8px; color: var(--warning-500);"></i> Section 2: Self Disclosure Form</strong>
                  </div>
                  
                  <div class="supplier-form-note info">
                      <p><i class="pi pi-info-circle" style="margin-right: 6px;"></i> <strong>Important:</strong> Answer all questions truthfully. False declarations may result in disqualification and potential sanctions.</p>
                  </div>
                  
                  <table class="supplier-form-table">
                      <thead>
                        <tr>
                          <th style="width: 5%;">Ref.</th>
                          <th style="width: 55%;">Critical area</th>
                          <th style="width: 15%;">Response</th>
                          <th style="width: 25%;">Comments</th>
                        </tr>
                      </thead>
                    <tbody>
                      <tr>
                          <td style="text-align: center; font-weight: 600;">1</td>
                          <td>Has the entity or individual declared bankruptcy, or been involved in bankruptcy or receivership proceedings, or is there any judgment or pending legal action against them, which could impair operations in the foreseeable future?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                        </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                      </tr>
                      <tr>
                          <td style="text-align: center; font-weight: 600;">2</td>
                          <td>Has the entity or individual been found in breach of their obligations relating to the payment of taxes or social security contributions?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                        </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                      </tr>
                      <tr>
                          <td style="text-align: center; font-weight: 600;">3</td>
                          <td>Has the entity or individual been found guilty of misconduct for the violation of applicable laws, regulations or ethical standards?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                        </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                      </tr>
                        <tr>
                          <td style="text-align: center; font-weight: 600;">4</td>
                          <td>Has the entity or individual engaged in any Proscribed Practices (corrupt practice, fraudulent practice, coercive practice, collusive practice, unethical practice, obstruction)?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                        </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                      </tr>
                        <tr>
                          <td style="text-align: center; font-weight: 600;">5</td>
                          <td>Does the entity or individual have a conflict of interest that may prevent them from entering into an agreement with UNOPS?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                        </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                        </tr>
                        <tr>
                          <td style="text-align: center; font-weight: 600;">6</td>
                          <td>Has the entity or individual been found to be involved in: Fraudulent practice, Corrupt practice, Money laundering, Terrorist financing, Child labour, or Human trafficking?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                          </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                        </tr>
                        <tr>
                          <td style="text-align: center; font-weight: 600;">7</td>
                          <td>Has the entity or individual had significant performance issues that led to early termination of a contract or application of penalties?</td>
                          <td>
                            <select disabled>
                              <option>Select</option>
                              <option>Yes</option>
                              <option>No</option>
                            </select>
                          </td>
                          <td><textarea placeholder="If 'Yes', provide explanation" disabled></textarea></td>
                      </tr>
                    </tbody>
                  </table>
                  </div>
                  
                  <!-- Final Declaration -->
                  <div style="border: 2px solid var(--primary-500); padding: var(--spacing-lg); border-radius: var(--radius-md); background: var(--surface-50);">
                    <p style="font-weight: 600;"><i class="pi pi-check-square" style="margin-right: 8px; color: var(--primary-500);"></i> I, the undersigned, hereby declare that the information provided is true and correct. I also understand that any willful dishonesty may result in the refusal of this submission. I understand that engagement in any of the above critical areas may, at the discretion of UNOPS, automatically result in the exclusion from this procurement process.</p>
                  </div>
                </div>
              </div>
            </div>
          `,
          'form-c': `
            <div class="supplier-form-preview">
              <div class="supplier-form-section">
                <div class="supplier-form-section-header"><i class="pi pi-dollar" style="margin-right: 8px;"></i> Financial Bid</div>
                <div class="supplier-form-section-body">

                  ${form.config && form.config.allowSpreadsheetUpload && !form.config.allowOnlineSubmission ? `
                  <!-- Spreadsheet Upload Mode -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-file-excel" style="margin-right: 8px; color: var(--primary-500);"></i> Financial Bid Spreadsheet</strong>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                      <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: white; text-align: center;">
                        <div style="color: var(--primary-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-download"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Download Template</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Financial Bid Spreadsheet Template</div>
                        <button class="btn btn-secondary btn-sm" disabled><i class="pi pi-download" style="margin-right: 6px;"></i> Download</button>
                      </div>
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--primary-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-upload"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Upload Completed Template</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Click or drag file here</div>
                      </div>
                    </div>
                  </div>
                  ` : `
                  <!-- Online Form Mode -->
                  <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                    <strong><i class="pi pi-shopping-cart" style="margin-right: 8px; color: var(--primary-500);"></i> Prices for Goods</strong>
                  </div>
                  
                  <table class="supplier-form-table">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Currency</th>
                        ${form.config && form.config.incoterms && form.config.incoterms.fca ? '<th>Unit price FCA</th>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.cpt ? '<th>Unit price CPT</th>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.dpu ? '<th>Unit price DPU</th>' : ''}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>1.</td>
                        <td class="prefilled-field">Desktop computers (43211500)</td>
                        <td class="prefilled-field" style="text-align: center;">50</td>
                        <td><select disabled><option>USD</option></select></td>
                        ${form.config && form.config.incoterms && form.config.incoterms.fca ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.cpt ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.dpu ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                      </tr>
                      <tr>
                        <td>2.</td>
                        <td class="prefilled-field">Laptop computers (43211503)</td>
                        <td class="prefilled-field" style="text-align: center;">30</td>
                        <td><select disabled><option>USD</option></select></td>
                        ${form.config && form.config.incoterms && form.config.incoterms.fca ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.cpt ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.dpu ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                      </tr>
                      <tr>
                        <td>3.</td>
                        <td class="prefilled-field">Computer monitors (43212104)</td>
                        <td class="prefilled-field" style="text-align: center;">80</td>
                        <td><select disabled><option>USD</option></select></td>
                        ${form.config && form.config.incoterms && form.config.incoterms.fca ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.cpt ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.dpu ? '<td><input type="number" placeholder="0.00" disabled /></td>' : ''}
                      </tr>
                      <tr style="font-weight: 600; background: var(--surface-100);">
                        <td colspan="4" style="text-align: right;">Total Price of Goods ‚Üí</td>
                        ${form.config && form.config.incoterms && form.config.incoterms.fca ? '<td class="prefilled-field"><input type="text" value="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.cpt ? '<td class="prefilled-field"><input type="text" value="0.00" disabled /></td>' : ''}
                        ${form.config && form.config.incoterms && form.config.incoterms.dpu ? '<td class="prefilled-field"><input type="text" value="0.00" disabled /></td>' : ''}
                      </tr>
                    </tbody>
                  </table>
                  
                  ${form.config && form.config.includeRelatedServices ? `
                  <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: var(--spacing-xl) 0 var(--spacing-lg) 0;">
                    <strong><i class="pi pi-wrench" style="margin-right: 8px; color: var(--primary-500);"></i> Prices for Related Services</strong>
                  </div>
                  
                  <table class="supplier-form-table">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Description of services</th>
                        <th>Quantity</th>
                        <th>Unit price</th>
                        <th>Total price</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>1.</td>
                        <td class="prefilled-field">Installation and Configuration</td>
                        <td class="prefilled-field">1 service</td>
                        <td><input type="number" placeholder="0.00" disabled /></td>
                        <td class="prefilled-field">0.00</td>
                      </tr>
                      <tr>
                        <td>2.</td>
                        <td class="prefilled-field">Training (3 days)</td>
                        <td class="prefilled-field">10 persons</td>
                        <td><input type="number" placeholder="0.00" disabled /></td>
                        <td class="prefilled-field">0.00</td>
                      </tr>
                      <tr>
                        <td>3.</td>
                        <td class="prefilled-field">Extended Warranty (2 years)</td>
                        <td class="prefilled-field">All items</td>
                        <td><input type="number" placeholder="0.00" disabled /></td>
                        <td class="prefilled-field">0.00</td>
                      </tr>
                    </tbody>
                  </table>
                  ` : ''}
                  
                  ${form.config && form.config.includeShipmentDelivery ? `
                  <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: var(--spacing-xl) 0 var(--spacing-lg) 0;">
                    <strong><i class="pi pi-truck" style="margin-right: 8px; color: var(--primary-500);"></i> Shipment & Delivery Information</strong>
                  </div>
                  
                  <table class="supplier-form-table">
                    <thead>
                      <tr>
                        <th>Item</th>
                        ${form.config.shipmentColumns && form.config.shipmentColumns.fcaDelivery ? '<th>FCA Point(s) of Delivery</th>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.dimensions ? '<th>Shipment dimensions</th>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.weight ? '<th>Gross weight</th>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.volume ? '<th>Total volume</th>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.containerNum ? '<th>Container Number</th>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.containerSize ? '<th>Container Size</th>' : ''}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="prefilled-field" style="font-weight: 600;">Desktop computers</td>
                        ${form.config.shipmentColumns && form.config.shipmentColumns.fcaDelivery ? '<td><input type="text" placeholder="City, Country" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.dimensions ? '<td><input type="text" placeholder="L√óW√óH cm" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.weight ? '<td><input type="text" placeholder="kg" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.volume ? '<td><input type="text" placeholder="m¬≥" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.containerNum ? '<td><input type="text" placeholder="Enter number" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.containerSize ? '<td><select disabled><option>20ft</option><option>40ft</option></select></td>' : ''}
                      </tr>
                      <tr>
                        <td class="prefilled-field" style="font-weight: 600;">Laptop computers</td>
                        ${form.config.shipmentColumns && form.config.shipmentColumns.fcaDelivery ? '<td><input type="text" placeholder="City, Country" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.dimensions ? '<td><input type="text" placeholder="L√óW√óH cm" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.weight ? '<td><input type="text" placeholder="kg" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.volume ? '<td><input type="text" placeholder="m¬≥" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.containerNum ? '<td><input type="text" placeholder="Enter number" disabled /></td>' : ''}
                        ${form.config.shipmentColumns && form.config.shipmentColumns.containerSize ? '<td><select disabled><option>20ft</option><option>40ft</option></select></td>' : ''}
                      </tr>
                    </tbody>
                  </table>
                  ` : ''}
                  
                  ${form.config && form.config.optionalCostFields && (form.config.optionalCostFields.freightCost || form.config.optionalCostFields.customsClearance) ? `
                  <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--warning-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: var(--spacing-xl) 0 var(--spacing-lg) 0;">
                    <strong><i class="pi pi-dollar" style="margin-right: 8px; color: var(--warning-500);"></i> Additional Cost Information</strong>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
                    ${form.config.optionalCostFields.freightCost ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: var(--spacing-md);">
                      <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="pi pi-truck" style="margin-right: 6px; color: var(--warning-500);"></i> Freight Cost per Container</label>
                      <div style="display: flex; gap: 8px;">
                        <select disabled style="width: 80px;"><option>USD</option></select>
                        <input type="number" placeholder="0.00" disabled style="flex: 1;" />
                      </div>
                    </div>
                    ` : ''}
                    ${form.config.optionalCostFields.customsClearance ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: var(--spacing-md);">
                      <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="pi pi-file" style="margin-right: 6px; color: var(--warning-500);"></i> Customs Clearance Costs</label>
                      <div style="display: flex; gap: 8px;">
                        <select disabled style="width: 80px;"><option>USD</option></select>
                        <input type="number" placeholder="0.00" disabled style="flex: 1;" />
                      </div>
                    </div>
                    ` : ''}
                  </div>
                  ` : ''}
                  `}
                </div>
              </div>
            </div>
          `,
          'form-d': `
            <div class="supplier-form-preview">
              <div class="supplier-form-section">
                <div class="supplier-form-section-header"><i class="pi pi-cog" style="margin-right: 8px;"></i> Technical Bid</div>
                <div class="supplier-form-section-body">

                  ${form.config && form.config.allowSpreadsheetUpload && !form.config.allowOnlineSubmission ? `
                  <!-- Spreadsheet Upload Mode -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-file-excel" style="margin-right: 8px; color: var(--primary-500);"></i> Technical Specifications Spreadsheet</strong>
                  </div>
                  
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                      <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: white; text-align: center;">
                        <div style="color: var(--primary-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-download"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Download Template</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Technical Bid Spreadsheet Template</div>
                        <button class="btn btn-secondary btn-sm" disabled><i class="pi pi-download" style="margin-right: 6px;"></i> Download</button>
                      </div>
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--primary-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-upload"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Upload Completed Template</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Click or drag file here</div>
                      </div>
                    </div>
                  </div>
                  ` : `
                  <!-- Online Form Mode -->
                  <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                    <strong><i class="pi pi-list" style="margin-right: 8px; color: var(--primary-500);"></i> Technical specifications for goods/services</strong>
                  </div>
                  
                  <div style="display: flex; justify-content: space-between; align-items: center; margin: var(--spacing-md) 0;">
                    <div style="font-weight: 600; color: var(--primary-600);"><i class="pi pi-tag" style="margin-right: 6px;"></i> UNSPSC Code: 43211500 - Desktop computers</div>
                    <button class="btn btn-secondary btn-sm" style="display: flex; align-items: center; gap: 6px;" disabled>
                      <i class="pi pi-plus-circle"></i> Add Alternate Offer
                    </button>
                  </div>
                  
                  <!-- Product Level Fields Table -->
                  <table class="supplier-form-table" style="margin-bottom: var(--spacing-md);">
                    <tbody>
                      ${!form.config.productLevelFields || form.config.productLevelFields.model ? `
                      <tr>
                        <td style="font-weight: 600; width: 30%;"><i class="pi pi-box" style="margin-right: 6px; color: var(--primary-500);"></i> Model (full name)</td>
                        <td><input type="text" placeholder="Insert Details" disabled /></td>
                      </tr>
                      ` : ''}
                      ${!form.config.productLevelFields || form.config.productLevelFields.manufacturer ? `
                      <tr>
                        <td style="font-weight: 600;"><i class="pi pi-building" style="margin-right: 6px; color: var(--primary-500);"></i> Manufacturer</td>
                        <td>
                          <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" placeholder="Full legal name" disabled style="flex: 1;" />
                            <input type="text" placeholder="UNGM ID (optional)" disabled style="width: 150px;" />
                          </div>
                        </td>
                      </tr>
                      ` : ''}
                      ${!form.config.productLevelFields || form.config.productLevelFields.manufacturerAddress ? `
                      <tr>
                        <td style="font-weight: 600;"><i class="pi pi-map-marker" style="margin-right: 6px; color: var(--primary-500);"></i> Manufacturer Address</td>
                        <td><textarea placeholder="Full address" rows="2" disabled></textarea></td>
                      </tr>
                      ` : ''}
                      ${!form.config.productLevelFields || form.config.productLevelFields.countryOfOrigin ? `
                      <tr>
                        <td style="font-weight: 600;"><i class="pi pi-globe" style="margin-right: 6px; color: var(--primary-500);"></i> Country of Origin</td>
                        <td><input type="text" placeholder="Insert Details" disabled /></td>
                      </tr>
                      ` : ''}
                      ${form.config.customFields && form.config.customFields.filter(f => f.level === 'product').map(field => `
                      <tr>
                        <td style="font-weight: 600;">
                          <i class="pi ${field.type === 'attachment' ? 'pi-paperclip' : field.type === 'numeric' ? 'pi-calculator' : field.type === 'select' ? 'pi-list' : 'pi-align-left'}" style="margin-right: 6px; color: var(--info-500);"></i> 
                          ${field.name} ${field.required ? '<span style="color: var(--danger-500);">*</span>' : ''}
                        </td>
                        <td>
                          ${field.type === 'attachment' ? `
                            <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: var(--spacing-sm); background: var(--surface-50); text-align: center; display: inline-flex; align-items: center; gap: 8px;">
                              <i class="pi pi-upload" style="color: var(--info-500);"></i>
                              <span style="font-size: 12px; color: var(--text-muted);">Upload file</span>
                            </div>
                          ` : field.type === 'numeric' ? `
                            <input type="number" placeholder="Enter number" disabled />
                          ` : field.type === 'select' ? `
                            <select disabled>
                              <option>Select an option</option>
                              ${field.options ? field.options.map(opt => '<option>' + opt + '</option>').join('') : ''}
                            </select>
                          ` : `
                            <input type="text" placeholder="Enter ${field.name.toLowerCase()}" disabled />
                          `}
                        </td>
                      </tr>
                      `).join('')}
                    </tbody>
                  </table>
                  
                  <!-- Requirement Level Fields Table -->
                  <table class="supplier-form-table">
                    <thead>
                      <tr>
                        <th style="width: 40px;">#</th>
                        <th style="width: 35%;">Item Specification</th>
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.isCompliant ? `<th style="width: 12%;">Is quotation compliant?</th>` : ''}
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.detailsOffered ? `<th>Details of goods offered</th>` : ''}
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'requirement').map(field => `
                          <th style="width: 15%;">${field.name} ${field.required ? '<span style="color: var(--danger-500);">*</span>' : ''}</th>
                        `).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="prefilled-field">1</td>
                        <td class="prefilled-field">PCR cabinet, tabletop</td>
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.isCompliant ? `
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label><input type="checkbox" disabled /> Yes</label>
                            <label><input type="checkbox" disabled /> No</label>
                          </div>
                        </td>
                        ` : ''}
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.detailsOffered ? `
                        <td><textarea placeholder="Insert details of goods offered" disabled></textarea></td>
                        ` : ''}
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'requirement').map(field => `
                          <td>
                            ${field.type === 'attachment' ? `
                              <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: 8px; background: var(--surface-50); text-align: center;">
                                <i class="pi pi-upload" style="color: var(--info-500); font-size: 0.9em;"></i>
                              </div>
                            ` : field.type === 'numeric' ? `
                              <input type="number" placeholder="0" disabled style="width: 100%;" />
                            ` : field.type === 'select' ? `
                              <select disabled style="width: 100%; font-size: 12px;">
                                <option>Select</option>
                              </select>
                            ` : `
                              <textarea placeholder="Enter text" rows="2" disabled style="width: 100%; font-size: 12px;"></textarea>
                            `}
                          </td>
                        `).join('')}
                      </tr>
                      <tr>
                        <td class="prefilled-field">2</td>
                        <td class="prefilled-field">Link to the proposed model on Manufacturer's website</td>
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.isCompliant ? `
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label><input type="checkbox" disabled /> Yes</label>
                            <label><input type="checkbox" disabled /> No</label>
                          </div>
                        </td>
                        ` : ''}
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.detailsOffered ? `
                        <td><textarea placeholder="Insert details of goods offered" disabled></textarea></td>
                        ` : ''}
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'requirement').map(field => `
                          <td>
                            ${field.type === 'attachment' ? `
                              <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: 8px; background: var(--surface-50); text-align: center;">
                                <i class="pi pi-upload" style="color: var(--info-500); font-size: 0.9em;"></i>
                          </div>
                            ` : field.type === 'numeric' ? `
                              <input type="number" placeholder="0" disabled style="width: 100%;" />
                            ` : field.type === 'select' ? `
                              <select disabled style="width: 100%; font-size: 12px;">
                                <option>Select</option>
                              </select>
                            ` : `
                              <textarea placeholder="Enter text" rows="2" disabled style="width: 100%; font-size: 12px;"></textarea>
                            `}
                        </td>
                        `).join('')}
                      </tr>
                      <tr>
                        <td class="prefilled-field">3</td>
                        <td class="prefilled-field">Tabletop PCR cabinet with UV lamp</td>
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.isCompliant ? `
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label><input type="checkbox" disabled /> Yes</label>
                            <label><input type="checkbox" disabled /> No</label>
                          </div>
                        </td>
                        ` : ''}
                        ${!form.config.requirementLevelFields || form.config.requirementLevelFields.detailsOffered ? `
                        <td><textarea placeholder="Insert details of goods offered" disabled></textarea></td>
                        ` : ''}
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'requirement').map(field => `
                          <td>
                            ${field.type === 'attachment' ? `
                              <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: 8px; background: var(--surface-50); text-align: center;">
                                <i class="pi pi-upload" style="color: var(--info-500); font-size: 0.9em;"></i>
                          </div>
                            ` : field.type === 'numeric' ? `
                              <input type="number" placeholder="0" disabled style="width: 100%;" />
                            ` : field.type === 'select' ? `
                              <select disabled style="width: 100%; font-size: 12px;">
                                <option>Select</option>
                              </select>
                            ` : `
                              <textarea placeholder="Enter text" rows="2" disabled style="width: 100%; font-size: 12px;"></textarea>
                            `}
                        </td>
                        `).join('')}
                      </tr>
                    </tbody>
                  </table>
                  
                  ${!form.config.productLevelFields || form.config.productLevelFields.deviations ? `
                  <div style="margin: var(--spacing-lg) 0;">
                    <strong><i class="pi pi-exclamation-circle" style="margin-right: 6px; color: var(--warning-500);"></i> ANY DEVIATION MUST BE LISTED BELOW:</strong>
                    <textarea class="form-input" rows="3" placeholder="List any deviations from requirements" style="width: 100%; margin-top: var(--spacing-sm);" disabled></textarea>
                  </div>
                  ` : ''}
                  
                  <!-- Delivery Requirements Table -->
                  <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin: var(--spacing-xl) 0 var(--spacing-lg) 0;">
                    <strong><i class="pi pi-truck" style="margin-right: 8px; color: var(--primary-500);"></i> Delivery requirements ‚Äì Comparative Data Table</strong>
                  </div>
                  
                  <table class="supplier-form-table">
                    <thead>
                      <tr>
                        <th style="width: 35%;">Delivery Requirement</th>
                        <th style="width: 12%;">Is quotation compliant?</th>
                        <th>Details</th>
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'delivery').map(field => `
                          <th style="width: 15%;">${field.name} ${field.required ? '<span style="color: var(--danger-500);">*</span>' : ''}</th>
                        `).join('')}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="prefilled-field"><strong>Delivery time for the goods</strong><br>Bidder shall make the goods available at FCA within 60 days after receipt of confirmation.</td>
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label><input type="checkbox" disabled /> Yes</label>
                            <label><input type="checkbox" disabled /> No</label>
                          </div>
                        </td>
                        <td><textarea placeholder="Insert details" disabled></textarea></td>
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'delivery').map(field => `
                          <td>
                            ${field.type === 'attachment' ? `
                              <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: 8px; background: var(--surface-50); text-align: center;">
                                <i class="pi pi-upload" style="color: var(--info-500); font-size: 0.9em;"></i>
                              </div>
                            ` : field.type === 'numeric' ? `
                              <input type="number" placeholder="0" disabled style="width: 100%;" />
                            ` : field.type === 'select' ? `
                              <select disabled style="width: 100%; font-size: 12px;">
                                <option>Select</option>
                              </select>
                            ` : `
                              <textarea placeholder="Enter text" rows="2" disabled style="width: 100%; font-size: 12px;"></textarea>
                            `}
                          </td>
                        `).join('')}
                      </tr>
                      <tr>
                        <td class="prefilled-field"><strong>Delivery place and Incoterms rules</strong><br>Bidder's quoted FCA point ‚Äì FCA (Incoterms2020)<br>Tashkent, Uzbekistan ‚Äì DPU (Incoterms2020)</td>
                        <td>
                          <div style="display: flex; flex-direction: column; gap: 4px;">
                            <label><input type="checkbox" disabled /> Yes</label>
                            <label><input type="checkbox" disabled /> No</label>
                          </div>
                        </td>
                        <td><textarea placeholder="Insert details" disabled></textarea></td>
                        ${form.config.customFields && form.config.customFields.filter(f => f.level === 'delivery').map(field => `
                          <td>
                            ${field.type === 'attachment' ? `
                              <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-sm); padding: 8px; background: var(--surface-50); text-align: center;">
                                <i class="pi pi-upload" style="color: var(--info-500); font-size: 0.9em;"></i>
                              </div>
                            ` : field.type === 'numeric' ? `
                              <input type="number" placeholder="0" disabled style="width: 100%;" />
                            ` : field.type === 'select' ? `
                              <select disabled style="width: 100%; font-size: 12px;">
                                <option>Select</option>
                              </select>
                            ` : `
                              <textarea placeholder="Enter text" rows="2" disabled style="width: 100%; font-size: 12px;"></textarea>
                            `}
                          </td>
                        `).join('')}
                      </tr>
                    </tbody>
                  </table>
                  `}
                </div>
              </div>
            </div>
          `,
          'form-qual': `
            <div class="supplier-form-preview">
              <div class="supplier-form-section">
                <div class="supplier-form-section-header"><i class="pi pi-verified" style="margin-right: 8px;"></i> Qualifications & Eligibility</div>
                <div class="supplier-form-section-body">

                  <!-- Section 1: Performance Statement -->
                  ${form.config && form.config.requirePerformanceStatement ? `
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--primary-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-chart-line" style="margin-right: 8px; color: var(--primary-500);"></i> Section 1: Performance Statement</strong>
                      <span style="background: var(--danger-100); color: var(--danger-600); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 12px;">REQUIRED</span>
                  </div>
                  
                    <!-- Performance Reference Card -->
                    <div style="background: white; border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                      <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--surface-200); margin-bottom: var(--spacing-md);">
                        <span style="font-size: 1.05em; font-weight: 600; color: var(--primary-500);"><i class="pi pi-briefcase" style="margin-right: 8px;"></i> Reference 1</span>
                      </div>
                      
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                        <div class="supplier-form-field">
                          <label><i class="pi pi-building" style="margin-right: 6px; color: var(--primary-500);"></i> Client/Organization Name <span style="color: var(--danger-500);">*</span></label>
                          <input type="text" placeholder="Enter client name" disabled />
                      </div>
                        <div class="supplier-form-field">
                          <label><i class="pi pi-file" style="margin-right: 6px; color: var(--primary-500);"></i> Contract Reference Number</label>
                          <input type="text" placeholder="Contract/PO number" disabled />
                      </div>
                    </div>
                      
                      <div class="supplier-form-field" style="margin-top: var(--spacing-md);">
                        <label><i class="pi pi-align-left" style="margin-right: 6px; color: var(--primary-500);"></i> Description of Work/Goods Supplied <span style="color: var(--danger-500);">*</span></label>
                        <textarea placeholder="Describe the goods/services delivered" rows="2" disabled></textarea>
                  </div>
                  
                      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                      <div class="supplier-form-field">
                          <label><i class="pi pi-dollar" style="margin-right: 6px; color: var(--primary-500);"></i> Contract Value <span style="color: var(--danger-500);">*</span></label>
                          <input type="text" placeholder="USD 0.00" disabled />
                      </div>
                      <div class="supplier-form-field">
                          <label><i class="pi pi-calendar" style="margin-right: 6px; color: var(--primary-500);"></i> Contract Period</label>
                          <input type="text" placeholder="Start - End dates" disabled />
                      </div>
                      <div class="supplier-form-field">
                          <label><i class="pi pi-check-circle" style="margin-right: 6px; color: var(--success-500);"></i> Completion Status</label>
                          <select disabled>
                            <option>Completed</option>
                            <option>Ongoing</option>
                          </select>
                      </div>
                  </div>
                  
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                        <div class="supplier-form-field">
                          <label><i class="pi pi-user" style="margin-right: 6px; color: var(--primary-500);"></i> Contact Person</label>
                          <input type="text" placeholder="Reference contact name" disabled />
                </div>
                        <div class="supplier-form-field">
                          <label><i class="pi pi-envelope" style="margin-right: 6px; color: var(--primary-500);"></i> Contact Email/Phone</label>
                          <input type="text" placeholder="Email or phone number" disabled />
              </div>
            </div>
                  </div>
                  
                    <button class="btn btn-secondary" style="margin-top: var(--spacing-md);" disabled><i class="pi pi-plus" style="margin-right: 6px;"></i> Add Another Reference</button>
                  </div>
                  ` : `
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--surface-400); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-chart-line" style="margin-right: 8px; color: var(--surface-500);"></i> Section 1: Performance Statement</strong>
                      <span style="background: var(--surface-200); color: var(--text-muted); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 12px;">NOT REQUIRED</span>
                </div>
              </div>
                  `}

                  <!-- Section 2: Bid Security Form -->
                  ${form.config && form.config.requireBidSecurity ? `
                  <div id="bidSecuritySection" style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--warning-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-shield" style="margin-right: 8px; color: var(--warning-500);"></i> Section 2: Bid Security Form</strong>
                      <span style="background: var(--danger-100); color: var(--danger-600); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 12px;">REQUIRED</span>
                  </div>
                  
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                      <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: white; text-align: center;">
                        <div style="color: var(--warning-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-download"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Download Template</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Bid Security Form Template</div>
                        <button class="btn btn-secondary btn-sm" disabled><i class="pi pi-download" style="margin-right: 6px;"></i> Download</button>
                    </div>
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--warning-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-upload"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Upload Completed Form</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Click or drag file here</div>
                    </div>
                    </div>
                    </div>
                  ` : `
                  <div id="bidSecuritySection" style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--surface-400); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-shield" style="margin-right: 8px; color: var(--surface-500);"></i> Section 2: Bid Security Form</strong>
                      <span style="background: var(--surface-200); color: var(--text-muted); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 12px;">NOT REQUIRED</span>
                    </div>
                    </div>
                  `}

                  <!-- Section 3: Financial Statements -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--info-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-chart-bar" style="margin-right: 8px; color: var(--info-500);"></i> Section 3: Financial Statements</strong>
                      <span style="background: var(--surface-200); color: var(--text-secondary); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 12px;">OPTIONAL</span>
                  </div>
                  
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md);">
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--info-500); font-size: 2em; margin-bottom: 8px;"><i class="pi pi-file-pdf"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 0.9em;">Year 2023</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Upload PDF</div>
                      </div>
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--info-500); font-size: 2em; margin-bottom: 8px;"><i class="pi pi-file-pdf"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 0.9em;">Year 2024</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Upload PDF</div>
                    </div>
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--info-500); font-size: 2em; margin-bottom: 8px;"><i class="pi pi-file-pdf"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 0.9em;">Year 2025</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Upload PDF</div>
                      </div>
                    </div>
                    
                    <div class="supplier-form-field" style="margin-top: var(--spacing-lg);">
                      <label><i class="pi pi-comment" style="margin-right: 6px; color: var(--info-500);"></i> Additional Financial Information</label>
                      <textarea placeholder="Provide any additional notes or explanations regarding your financial statements" rows="3" disabled></textarea>
                    </div>
                  </div>
                  
                  <!-- Section 4: Manufacturer's Authorization -->
                  <div style="margin-bottom: var(--spacing-xl);">
                    <div style="background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%); padding: var(--spacing-lg); border-left: 4px solid var(--success-500); border-radius: 0 var(--radius-md) var(--radius-md) 0; margin-bottom: var(--spacing-lg);">
                      <strong><i class="pi pi-verified" style="margin-right: 8px; color: var(--success-500);"></i> Section 4: Manufacturer's Authorization</strong>
                  </div>
                  
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                      <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: white; text-align: center;">
                        <div style="color: var(--success-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-download"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Download Template</div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">Manufacturer's Authorization Template</div>
                        <button class="btn btn-secondary btn-sm" disabled><i class="pi pi-download" style="margin-right: 6px;"></i> Download</button>
                      </div>
                      <div style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-lg); background: var(--surface-50); text-align: center;">
                        <div style="color: var(--success-500); font-size: 2.5em; margin-bottom: 12px;"><i class="pi pi-upload"></i></div>
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">Upload Completed Form</div>
                        <div style="font-size: 12px; color: var(--text-muted);">Click or drag file here</div>
                    </div>
                      </div>
                    </div>
                  
                  <!-- Declaration -->
                  <div style="border: 2px solid var(--primary-500); padding: var(--spacing-lg); border-radius: var(--radius-md); background: var(--surface-50);">
                    <p style="font-weight: 600;"><i class="pi pi-check-square" style="margin-right: 8px; color: var(--primary-500);"></i> I hereby certify that all information provided in this Qualifications & Eligibility form is true, accurate, and complete. I understand that any false statements or misrepresentations may result in disqualification from this procurement process.</p>
                  </div>
                </div>
              </div>
            </div>
          `,
        };
        
        return formPreviews[form.id] || `
          <div class="supplier-form-preview">
            <div class="supplier-form-section">
              <div class="supplier-form-section-header">${form.name}</div>
              <div class="supplier-form-section-body">
                <p style="color: var(--text-muted); text-align: center; padding: var(--spacing-xl);">
                  ${form.icon} Preview for this form type is not yet available.
                </p>
              </div>
            </div>
          </div>
        `;
      }
      
      // Form Configuration Modal
      window.openFormConfigModal = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (!form || !form.hasConfig) return;
        
        // Redirect to enhanced form builder for Technical Bid (form-d)
        if (formId === 'form-d') {
          window.location.href = 'enhanced-form-builder-mockup.html';
          return;
        }
        
        currentFormForModal = form;
        const modal = document.getElementById('form-config-modal');
        const titleEl = document.getElementById('form-config-title');
        const bodyEl = document.getElementById('form-config-body');
        
        titleEl.textContent = `Configure Form ${form.code}: ${form.name}`;
        bodyEl.innerHTML = generateFormConfigContent(form);
        
        modal.classList.add('show');
      }
      
      window.closeFormConfigModal = function() {
        document.getElementById('form-config-modal').classList.remove('show');
        currentFormForModal = null;
      }
      
      function generateFormConfigContent(form) {
        if (form.id === 'form-c') {
          return `
            <div class="form-config-section">
              <h4><i class="pi pi-send" style="margin-right: 8px;"></i> Submission Options</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Select how suppliers should submit the financial bid.</p>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="radio" name="financial-submission-type" id="config-financial-online" ${form.config.allowOnlineSubmission && !form.config.allowSpreadsheetUpload ? 'checked' : ''} onchange="setFinancialSubmissionType('online')" />
                  <label for="config-financial-online"><strong>Online Form Submission</strong></label>
                </div>
                <div class="form-config-option">
                  <input type="radio" name="financial-submission-type" id="config-financial-spreadsheet" ${form.config.allowSpreadsheetUpload && !form.config.allowOnlineSubmission ? 'checked' : ''} onchange="setFinancialSubmissionType('spreadsheet')" />
                  <label for="config-financial-spreadsheet"><strong>Spreadsheet Upload</strong></label>
                </div>
              </div>
            </div>
            
            <!-- Online Form Configuration Section -->
            <div id="financial-online-config-section" style="${form.config.allowOnlineSubmission && !form.config.allowSpreadsheetUpload ? '' : 'display: none;'}">
              <div class="form-config-section">
                <h4><i class="pi pi-globe" style="margin-right: 8px;"></i> Incoterms Configuration</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Select which Incoterms to include in the Price Schedule tables.</p>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" id="config-incoterm-fca" ${form.config.incoterms.fca ? 'checked' : ''} onchange="updateFormConfig('form-c', 'incoterms.fca', this.checked)" />
                  <label for="config-incoterm-fca">FCA (Free Carrier)</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-incoterm-cpt" ${form.config.incoterms.cpt ? 'checked' : ''} onchange="updateFormConfig('form-c', 'incoterms.cpt', this.checked)" />
                  <label for="config-incoterm-cpt">CPT (Carriage Paid To)</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-incoterm-dpu" ${form.config.incoterms.dpu ? 'checked' : ''} onchange="updateFormConfig('form-c', 'incoterms.dpu', this.checked)" />
                  <label for="config-incoterm-dpu">DPU (Delivered at Place Unloaded)</label>
                </div>
              </div>
            </div>
            
            <div class="form-config-section">
                <h4><i class="pi pi-table" style="margin-right: 8px;"></i> Tables to Include</h4>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" id="config-related-services" ${form.config.includeRelatedServices ? 'checked' : ''} onchange="updateFormConfig('form-c', 'includeRelatedServices', this.checked)" />
                  <label for="config-related-services">Include Related Services Table</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-shipment" ${form.config.includeShipmentDelivery ? 'checked' : ''} onchange="updateFormConfig('form-c', 'includeShipmentDelivery', this.checked)" />
                  <label for="config-shipment">Include Shipment & Delivery Table</label>
                </div>
              </div>
            </div>
            
            <div class="form-config-section" id="shipment-columns-section" style="${form.config.includeShipmentDelivery ? '' : 'display: none;'}">
                <h4><i class="pi pi-truck" style="margin-right: 8px;"></i> Shipment & Delivery Columns</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Select columns to include in the Shipment & Delivery table.</p>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" checked disabled />
                  <label style="color: var(--text-muted);">Item (Required)</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-col-fca" ${form.config.shipmentColumns.fcaDelivery ? 'checked' : ''} onchange="updateFormConfig('form-c', 'shipmentColumns.fcaDelivery', this.checked)" />
                  <label for="config-col-fca">FCA Point(s) of Delivery</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-col-dimensions" ${form.config.shipmentColumns.dimensions ? 'checked' : ''} onchange="updateFormConfig('form-c', 'shipmentColumns.dimensions', this.checked)" />
                  <label for="config-col-dimensions">Shipment Dimensions</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-col-weight" ${form.config.shipmentColumns.weight ? 'checked' : ''} onchange="updateFormConfig('form-c', 'shipmentColumns.weight', this.checked)" />
                  <label for="config-col-weight">Gross Weight</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-col-volume" ${form.config.shipmentColumns.volume ? 'checked' : ''} onchange="updateFormConfig('form-c', 'shipmentColumns.volume', this.checked)" />
                  <label for="config-col-volume">Total Volume</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-col-container-num" ${form.config.shipmentColumns.containerNum ? 'checked' : ''} onchange="updateFormConfig('form-c', 'shipmentColumns.containerNum', this.checked)" />
                  <label for="config-col-container-num">Container Number</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-col-container-size" ${form.config.shipmentColumns.containerSize ? 'checked' : ''} onchange="updateFormConfig('form-c', 'shipmentColumns.containerSize', this.checked)" />
                  <label for="config-col-container-size">Container Size</label>
                </div>
              </div>
            </div>
            
            <div class="form-config-section">
                <h4><i class="pi pi-dollar" style="margin-right: 8px;"></i> Optional Cost Fields</h4>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" id="config-freight" ${form.config.optionalCostFields.freightCost ? 'checked' : ''} onchange="updateFormConfig('form-c', 'optionalCostFields.freightCost', this.checked)" />
                  <label for="config-freight">Freight Cost per Container</label>
                </div>
                <div class="form-config-option">
                  <input type="checkbox" id="config-customs" ${form.config.optionalCostFields.customsClearance ? 'checked' : ''} onchange="updateFormConfig('form-c', 'optionalCostFields.customsClearance', this.checked)" />
                  <label for="config-customs">Customs Clearance Costs</label>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (form.id === 'form-d') {
          return `
            <div class="form-config-section">
              <h4><i class="pi pi-send" style="margin-right: 8px;"></i> Technical Specifications Submission Options</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Select how suppliers should submit technical specifications.</p>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="radio" name="tech-submission-type" id="config-template" ${form.config.allowSpreadsheetUpload && !form.config.allowOnlineSubmission ? 'checked' : ''} onchange="setTechnicalSubmissionType('spreadsheet')" />
                  <label for="config-template">
                    <i class="pi pi-file" style="margin-right: 6px; color: var(--primary-500);"></i>
                    <strong>Technical Bid Template</strong>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; margin-left: 22px;">Use a predefined template to structure the technical submission.</div>
                  </label>
                </div>
                <div class="form-config-option">
                  <input type="radio" name="tech-submission-type" id="config-online" ${form.config.allowOnlineSubmission && !form.config.allowSpreadsheetUpload ? 'checked' : ''} onchange="setTechnicalSubmissionType('online')" />
                  <label for="config-online">
                    <i class="pi pi-pencil" style="margin-right: 6px; color: var(--primary-500);"></i>
                    <strong>Create Custom Online Form</strong>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; margin-left: 22px;">Build your own online form to collect technical specifications.</div>
                  </label>
                </div>
                <div class="form-config-option">
                  <input type="radio" name="tech-submission-type" id="config-offline" ${!form.config.allowOnlineSubmission && !form.config.allowSpreadsheetUpload ? 'checked' : ''} onchange="setTechnicalSubmissionType('offline')" />
                  <label for="config-offline">
                    <i class="pi pi-ban" style="margin-right: 6px; color: var(--text-muted);"></i>
                    <strong>No Technical Submission (Offline Process)</strong>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; margin-left: 22px;">Technical evaluation will be handled outside the system. Suppliers will not submit any technical documents.</div>
                  </label>
                </div>
              </div>
            </div>
            
            <!-- Online Form Fields Configuration Section -->
            <div id="online-form-custom-fields-section" style="${form.config.allowOnlineSubmission && !form.config.allowSpreadsheetUpload ? '' : 'display: none;'}">
            
              <!-- Standard Product Level Fields -->
              <div class="form-config-section">
                <h4><i class="pi pi-box" style="margin-right: 8px;"></i> Product / Service Level Fields</h4>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Select which standard fields to include at the product/service level.</p>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  <div class="form-config-option">
                    <input type="checkbox" id="config-product-model" ${!form.config.productLevelFields || form.config.productLevelFields.model ? 'checked' : ''} onchange="updateFormConfig('form-d', 'productLevelFields.model', this.checked)" />
                    <label for="config-product-model">Model (full name)</label>
                  </div>
                  <div class="form-config-option">
                    <input type="checkbox" id="config-product-manufacturer" ${!form.config.productLevelFields || form.config.productLevelFields.manufacturer ? 'checked' : ''} onchange="updateFormConfig('form-d', 'productLevelFields.manufacturer', this.checked)" />
                    <label for="config-product-manufacturer">Manufacturer</label>
                  </div>
                  <div class="form-config-option">
                    <input type="checkbox" id="config-product-address" ${!form.config.productLevelFields || form.config.productLevelFields.manufacturerAddress ? 'checked' : ''} onchange="updateFormConfig('form-d', 'productLevelFields.manufacturerAddress', this.checked)" />
                    <label for="config-product-address">Manufacturer Address</label>
                  </div>
                  <div class="form-config-option">
                    <input type="checkbox" id="config-product-country" ${!form.config.productLevelFields || form.config.productLevelFields.countryOfOrigin ? 'checked' : ''} onchange="updateFormConfig('form-d', 'productLevelFields.countryOfOrigin', this.checked)" />
                    <label for="config-product-country">Country of Origin</label>
                  </div>
                  <div class="form-config-option">
                    <input type="checkbox" id="config-product-deviations" ${!form.config.productLevelFields || form.config.productLevelFields.deviations ? 'checked' : ''} onchange="updateFormConfig('form-d', 'productLevelFields.deviations', this.checked)" />
                    <label for="config-product-deviations">Deviations</label>
                  </div>
                </div>
              </div>
              
              <!-- Standard Requirement Level Fields -->
              <div class="form-config-section">
                <h4><i class="pi pi-list" style="margin-right: 8px;"></i> Requirement Level Fields</h4>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Select which standard fields to include at the requirement level (per specification row).</p>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                  <div class="form-config-option">
                    <input type="checkbox" id="config-req-compliant" ${!form.config.requirementLevelFields || form.config.requirementLevelFields.isCompliant ? 'checked' : ''} onchange="updateFormConfig('form-d', 'requirementLevelFields.isCompliant', this.checked)" />
                    <label for="config-req-compliant">Is quotation compliant?</label>
                  </div>
                  <div class="form-config-option">
                    <input type="checkbox" id="config-req-details" ${!form.config.requirementLevelFields || form.config.requirementLevelFields.detailsOffered ? 'checked' : ''} onchange="updateFormConfig('form-d', 'requirementLevelFields.detailsOffered', this.checked)" />
                    <label for="config-req-details">Details of goods offered</label>
                  </div>
                </div>
              </div>
              
              <!-- Custom Fields Section -->
              <div class="form-config-section">
                <h4><i class="pi pi-plus-circle" style="margin-right: 8px;"></i> Custom Fields</h4>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Add additional fields for suppliers to complete. These fields will appear in the Technical Bid form.</p>
                
                <!-- Existing Custom Fields List -->
                <div id="custom-fields-list" style="margin-bottom: var(--spacing-md);">
                  ${form.config.customFields && form.config.customFields.length > 0 ? form.config.customFields.map((field, index) => `
                    <div class="custom-field-item" style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-sm); display: flex; justify-content: space-between; align-items: center;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">
                          <i class="pi ${field.type === 'attachment' ? 'pi-paperclip' : field.type === 'numeric' ? 'pi-calculator' : field.type === 'select' ? 'pi-list' : 'pi-align-left'}" style="margin-right: 6px; color: var(--primary-500);"></i>
                          ${field.name}
                          ${field.required ? '<span style="color: var(--danger-500); margin-left: 4px;">*</span>' : ''}
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                          <span style="background: var(--surface-200); padding: 2px 6px; border-radius: 4px; margin-right: 8px;">${field.type}</span>
                          <span style="background: var(--info-100); padding: 2px 6px; border-radius: 4px; margin-right: 8px;">${field.level === 'product' ? 'Product Level' : field.level === 'delivery' ? 'Delivery Level' : 'Requirement Level'}</span>
                          <span style="background: var(--success-100); padding: 2px 6px; border-radius: 4px;">${field.appliesTo === 'all' ? 'All Products' : 'Specific: ' + field.appliesTo}</span>
                        </div>
                      </div>
                      <button class="btn btn-sm" style="background: var(--danger-100); color: var(--danger-600); border: none; padding: 4px 8px;" onclick="removeCustomField(${index})">
                        <i class="pi pi-trash"></i>
                      </button>
                    </div>
                  `).join('') : '<div style="color: var(--text-muted); font-style: italic; padding: var(--spacing-sm);">No custom fields added yet.</div>'}
                </div>
                
                <!-- Add New Field Form -->
                <div style="background: white; border: 1px solid var(--primary-200); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                  <div style="font-weight: 600; color: var(--primary-600); margin-bottom: var(--spacing-md);"><i class="pi pi-plus" style="margin-right: 6px;"></i> Add New Field</div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                    <div>
                      <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Field Name <span style="color: var(--danger-500);">*</span></label>
                      <input type="text" id="new-field-name" placeholder="e.g., Technical Certification" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);" />
                    </div>
                    <div>
                      <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Field Type <span style="color: var(--danger-500);">*</span></label>
                      <select id="new-field-type" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);" onchange="toggleSelectOptionsField()">
                        <option value="text">Free Text</option>
                        <option value="numeric">Numeric</option>
                        <option value="attachment">Attachment</option>
                        <option value="select">Option Select</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Options for Select field type -->
                  <div id="select-options-field" style="display: none; margin-top: var(--spacing-md);">
                    <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Options (one per line)</label>
                    <textarea id="new-field-options" placeholder="Option 1&#10;Option 2&#10;Option 3" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);"></textarea>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <div>
                      <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Field Level</label>
                      <select id="new-field-level" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);">
                        <option value="product">Product / Service Level</option>
                        <option value="requirement">Requirement Level</option>
                        <option value="delivery">Delivery Requirement Level</option>
                      </select>
                    </div>
                    <div>
                      <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Applies To</label>
                      <select id="new-field-applies" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);">
                        <option value="all">All Products/Services</option>
                        <option value="specific">Specific Products/Services</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Specific products selection (shown when "Specific" is selected) -->
                  <div id="specific-products-field" style="display: none; margin-top: var(--spacing-md);">
                    <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Select Products/Services</label>
                    <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--surface-300); border-radius: var(--radius-sm); padding: var(--spacing-sm); background: var(--surface-50);">
                      <label style="display: flex; align-items: center; gap: 8px; padding: 4px 0;"><input type="checkbox" value="PCR Cabinet" class="specific-product-checkbox" /> PCR Cabinet</label>
                      <label style="display: flex; align-items: center; gap: 8px; padding: 4px 0;"><input type="checkbox" value="Desktop Computer" class="specific-product-checkbox" /> Desktop Computer</label>
                      <label style="display: flex; align-items: center; gap: 8px; padding: 4px 0;"><input type="checkbox" value="Laptop" class="specific-product-checkbox" /> Laptop</label>
                    </div>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                      <input type="checkbox" id="new-field-required" />
                      <span style="font-size: 13px;">Required field</span>
                    </label>
                  </div>
                  
                  <div style="margin-top: var(--spacing-md);">
                    <button class="btn btn-primary btn-sm" onclick="addCustomField()">
                      <i class="pi pi-plus" style="margin-right: 6px;"></i> Add Field
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (form.id === 'form-qual') {
          return `
            <div class="form-config-section">
              <h4><i class="pi pi-chart-line" style="margin-right: 8px;"></i> Performance Statement Configuration</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Configure whether bidders must provide performance references.</p>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" id="config-require-performance" ${form.config.requirePerformanceStatement ? 'checked' : ''} onchange="updateFormConfig('form-qual', 'requirePerformanceStatement', this.checked)" />
                  <label for="config-require-performance"><strong>Require Performance Statement (References)</strong></label>
                </div>
              </div>
            </div>
            
            <div class="form-config-section">
              <h4><i class="pi pi-shield" style="margin-right: 8px;"></i> Bid Security Configuration</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Configure whether a bid security (bank guarantee) is required for this tender.</p>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" id="config-require-bid-security" ${form.config.requireBidSecurity ? 'checked' : ''} onchange="updateFormConfig('form-qual', 'requireBidSecurity', this.checked); toggleBidSecurityAmountSection(this.checked)" />
                  <label for="config-require-bid-security"><strong>Require Bid Security</strong></label>
                </div>
              </div>
              <div id="bid-security-amount-section" style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200); ${form.config.requireBidSecurity ? '' : 'display: none;'}">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-md);">
                  <div>
                    <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Bid Security Amount</label>
                    <input type="text" id="config-bid-security-amount" value="${form.config.bidSecurityAmount || ''}" placeholder="e.g., 10,000" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);" onchange="updateFormConfig('form-qual', 'bidSecurityAmount', this.value)" />
                  </div>
                  <div>
                    <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Currency</label>
                    <select id="config-bid-security-currency" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);" onchange="updateFormConfig('form-qual', 'bidSecurityCurrency', this.value)">
                      <option value="USD" ${form.config.bidSecurityCurrency === 'USD' ? 'selected' : ''}>USD</option>
                      <option value="EUR" ${form.config.bidSecurityCurrency === 'EUR' ? 'selected' : ''}>EUR</option>
                      <option value="GBP" ${form.config.bidSecurityCurrency === 'GBP' ? 'selected' : ''}>GBP</option>
                    </select>
                  </div>
                </div>
              </div>
              <div style="margin-top: var(--spacing-sm); padding: var(--spacing-sm); background: var(--warning-50); border-radius: var(--radius-sm); font-size: 12px; color: var(--warning-700);">
                <i class="pi pi-exclamation-triangle"></i> If required, bidders must provide a Bank Guarantee valid for 30 days beyond the bid validity period.
              </div>
            </div>
            
            <div class="form-config-section">
              <h4><i class="pi pi-chart-bar" style="margin-right: 8px;"></i> Financial Statements Configuration</h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Configure requirements for financial statement submissions.</p>
              <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                <div class="form-config-option">
                  <input type="checkbox" id="config-financial-statements" ${form.config.financialStatementsRequired ? 'checked' : ''} onchange="updateFormConfig('form-qual', 'financialStatementsRequired', this.checked); toggleFinancialRequirementsSection(this.checked)" />
                  <label for="config-financial-statements"><strong>Require Financial Statements</strong></label>
                </div>
              </div>
              <div id="financial-requirements-section" style="margin-top: var(--spacing-md); ${form.config.financialStatementsRequired ? '' : 'display: none;'}">
                <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 6px;">Financial Statement Requirements</label>
                <textarea id="config-financial-requirements" placeholder="Specify requirements for financial statements (e.g., audited statements for last 3 years, minimum annual turnover, etc.)" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm); resize: vertical;" onchange="updateFormConfig('form-qual', 'financialStatementsRequirements', this.value)">${form.config.financialStatementsRequirements || ''}</textarea>
              </div>
            </div>
          `;
        }
        
        return `<p style="color: var(--text-muted); text-align: center; padding: var(--spacing-lg);">No configuration options available for this form.</p>`;
      }
      
      window.updateFormConfig = function(formId, path, value) {
        const form = submissionForms.find(f => f.id === formId);
        if (!form || !form.config) return;
        
        // Navigate nested path and set value, creating objects as needed
        const keys = path.split('.');
        let obj = form.config;
        for (let i = 0; i < keys.length - 1; i++) {
          if (!obj[keys[i]]) {
            obj[keys[i]] = {};
          }
          obj = obj[keys[i]];
        }
        obj[keys[keys.length - 1]] = value;
        
        // Handle conditional visibility
        if (path === 'includeShipmentDelivery') {
          const shipmentSection = document.getElementById('shipment-columns-section');
          if (shipmentSection) {
            shipmentSection.style.display = value ? '' : 'none';
          }
        }
      }
      
      // Toggle Bid Security Amount Section in form-qual config
      window.toggleBidSecurityAmountSection = function(show) {
        const section = document.getElementById('bid-security-amount-section');
        if (section) {
          section.style.display = show ? '' : 'none';
        }
      }
      
      // Toggle Financial Requirements Section in form-qual config
      window.toggleFinancialRequirementsSection = function(show) {
        const section = document.getElementById('financial-requirements-section');
        if (section) {
          section.style.display = show ? '' : 'none';
        }
      }
      
      // Technical Bid Submission Type Toggle
      window.setTechnicalSubmissionType = function(type) {
        const form = submissionForms.find(f => f.id === 'form-d');
        if (!form || !form.config) return;
        
        if (type === 'online') {
          form.config.allowOnlineSubmission = true;
          form.config.allowSpreadsheetUpload = false;
        } else if (type === 'spreadsheet') {
          form.config.allowOnlineSubmission = false;
          form.config.allowSpreadsheetUpload = true;
        } else if (type === 'offline') {
          form.config.allowOnlineSubmission = false;
          form.config.allowSpreadsheetUpload = false;
        }
        
        // Toggle custom fields section visibility
        const customFieldsSection = document.getElementById('online-form-custom-fields-section');
        if (customFieldsSection) {
          customFieldsSection.style.display = type === 'online' ? '' : 'none';
        }
      }
      
      // Financial Bid Submission Type Toggle
      window.setFinancialSubmissionType = function(type) {
        const form = submissionForms.find(f => f.id === 'form-c');
        if (!form || !form.config) return;
        
        if (type === 'online') {
          form.config.allowOnlineSubmission = true;
          form.config.allowSpreadsheetUpload = false;
        } else {
          form.config.allowOnlineSubmission = false;
          form.config.allowSpreadsheetUpload = true;
        }
        
        // Toggle online config section visibility
        const onlineConfigSection = document.getElementById('financial-online-config-section');
        if (onlineConfigSection) {
          onlineConfigSection.style.display = type === 'online' ? '' : 'none';
        }
      }
      
      // Toggle select options field visibility
      window.toggleSelectOptionsField = function() {
        const typeSelect = document.getElementById('new-field-type');
        const optionsField = document.getElementById('select-options-field');
        if (typeSelect && optionsField) {
          optionsField.style.display = typeSelect.value === 'select' ? '' : 'none';
        }
      }
      
      // Toggle specific products field visibility
      document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'new-field-applies') {
          const specificField = document.getElementById('specific-products-field');
          if (specificField) {
            specificField.style.display = e.target.value === 'specific' ? '' : 'none';
          }
        }
      });
      
      // Add custom field to form-d
      window.addCustomField = function() {
        const form = submissionForms.find(f => f.id === 'form-d');
        if (!form || !form.config) return;
        
        const nameInput = document.getElementById('new-field-name');
        const typeSelect = document.getElementById('new-field-type');
        const levelSelect = document.getElementById('new-field-level');
        const appliesSelect = document.getElementById('new-field-applies');
        const requiredCheckbox = document.getElementById('new-field-required');
        const optionsTextarea = document.getElementById('new-field-options');
        
        const fieldName = nameInput ? nameInput.value.trim() : '';
        if (!fieldName) {
          showNotification('Please enter a field name', 'error');
          return;
        }
        
        const fieldType = typeSelect ? typeSelect.value : 'text';
        const fieldLevel = levelSelect ? levelSelect.value : 'product';
        const appliesTo = appliesSelect ? appliesSelect.value : 'all';
        const required = requiredCheckbox ? requiredCheckbox.checked : false;
        
        // Get specific products if applicable
        let appliesValue = 'all';
        if (appliesTo === 'specific') {
          const checkedProducts = document.querySelectorAll('.specific-product-checkbox:checked');
          const productNames = Array.from(checkedProducts).map(cb => cb.value);
          appliesValue = productNames.length > 0 ? productNames.join(', ') : 'all';
        }
        
        // Build new field object
        const newField = {
          name: fieldName,
          type: fieldType,
          level: fieldLevel,
          appliesTo: appliesValue,
          required: required
        };
        
        // Add options for select type
        if (fieldType === 'select' && optionsTextarea) {
          const options = optionsTextarea.value.split('\n').map(o => o.trim()).filter(o => o);
          newField.options = options;
        }
        
        // Add to custom fields array
        if (!form.config.customFields) {
          form.config.customFields = [];
        }
        form.config.customFields.push(newField);
        
        // Refresh the config modal content
        refreshFormDConfigModal();
        showNotification('Custom field added successfully', 'success');
      }
      
      // Remove custom field from form-d
      window.removeCustomField = function(index) {
        const form = submissionForms.find(f => f.id === 'form-d');
        if (!form || !form.config || !form.config.customFields) return;
        
        form.config.customFields.splice(index, 1);
        refreshFormDConfigModal();
        showNotification('Custom field removed', 'success');
      }
      
      // Refresh form-d config modal
      window.refreshFormDConfigModal = function() {
        const form = submissionForms.find(f => f.id === 'form-d');
        if (!form) return;
        
        const bodyEl = document.getElementById('form-config-body');
        if (bodyEl) {
          bodyEl.innerHTML = generateFormConfigContent(form);
        }
      }
      
      window.saveFormConfig = function() {
        showNotification('Form configuration saved', 'success');
        closeFormConfigModal();
        renderCurrentBlock();
      }
      
      // Form Attachment Modal
      window.openFormAttachmentModal = function(formId) {
        const form = submissionForms.find(f => f.id === formId);
        if (!form) return;
        
        currentFormForModal = form;
        const modal = document.getElementById('form-attachment-modal');
        const titleEl = document.getElementById('form-attachment-title');
        const formIdInput = document.getElementById('form-attachment-form-id');
        
        titleEl.textContent = `Attachments for Form ${form.code}: ${form.name}`;
        formIdInput.value = formId;
        
        renderAttachmentList();
        modal.classList.add('show');
      }
      
      window.closeFormAttachmentModal = function() {
        document.getElementById('form-attachment-modal').classList.remove('show');
        currentFormForModal = null;
      }
      
      function renderAttachmentList() {
        const listEl = document.getElementById('attachment-list');
        if (!currentFormForModal || !currentFormForModal.attachments) {
          listEl.innerHTML = '';
          return;
        }
        
        if (currentFormForModal.attachments.length === 0) {
          listEl.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: var(--spacing-md);">No attachments yet. Upload files above.</p>';
          return;
        }
        
        listEl.innerHTML = currentFormForModal.attachments.map((att, idx) => {
          const fileIcon = getFileIcon(att.name);
          return `
            <div class="attachment-item">
              <div class="attachment-item-icon">${fileIcon}</div>
              <div class="attachment-item-info">
                <div class="attachment-item-name">${att.name}</div>
                <div class="attachment-item-size">${formatFileSize(att.size)}</div>
              </div>
              <button class="attachment-item-remove" onclick="removeFormAttachment(${idx})" title="Remove">
                <i class="pi pi-times"></i>
              </button>
            </div>
          `;
        }).join('');
      }
      
      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
          'pdf': 'üìï',
          'doc': 'üìò',
          'docx': 'üìò',
          'xls': 'üìó',
          'xlsx': 'üìó',
          'jpg': 'üñºÔ∏è',
          'jpeg': 'üñºÔ∏è',
          'png': 'üñºÔ∏è'
        };
        return icons[ext] || 'üìÑ';
      }
      
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
      
      window.handleAttachmentDragOver = function(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('attachment-drop-zone').classList.add('drag-over');
      }
      
      window.handleAttachmentDragLeave = function(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('attachment-drop-zone').classList.remove('drag-over');
      }
      
      window.handleAttachmentDrop = function(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('attachment-drop-zone').classList.remove('drag-over');
        
        const files = event.dataTransfer.files;
        handleAttachmentFileSelect(files);
      }
      
      window.handleAttachmentFileSelect = function(files) {
        if (!currentFormForModal) return;
        if (!currentFormForModal.attachments) {
          currentFormForModal.attachments = [];
        }
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // Validate file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert(`File "${file.name}" exceeds 10MB limit.`);
            continue;
          }
          
          // Validate file type
          const allowedTypes = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.jpg', '.jpeg', '.png'];
          const ext = '.' + file.name.split('.').pop().toLowerCase();
          if (!allowedTypes.includes(ext)) {
            alert(`File type "${ext}" is not supported.`);
            continue;
          }
          
          // Check for duplicates
          if (currentFormForModal.attachments.some(a => a.name === file.name)) {
            alert(`File "${file.name}" is already attached.`);
            continue;
          }
          
          currentFormForModal.attachments.push({
            name: file.name,
            size: file.size,
            type: file.type,
            addedAt: new Date().toISOString()
          });
        }
        
        renderAttachmentList();
        document.getElementById('attachment-file-input').value = '';
      }
      
      window.removeFormAttachment = function(index) {
        if (!currentFormForModal || !currentFormForModal.attachments) return;
        
        if (confirm('Remove this attachment?')) {
          currentFormForModal.attachments.splice(index, 1);
          renderAttachmentList();
        }
      }
      
      window.saveFormAttachments = function() {
        // If we were editing tender attachments, update the array
        if (currentFormForModal && currentFormForModal.id === 'tender-package') {
          tenderAttachments = currentFormForModal.attachments;
        }
        showNotification('Attachments saved', 'success');
        closeFormAttachmentModal();
        renderCurrentBlock();
      }
      
      // ===== TENDER PACKAGE ATTACHMENT FUNCTIONS =====
      window.openTenderAttachmentModal = function() {
        // Reuse the form attachment modal for tender attachments
        const modal = document.getElementById('form-attachment-modal');
        const titleEl = document.getElementById('form-attachment-title');
        const formIdInput = document.getElementById('form-attachment-form-id');
        
        titleEl.textContent = 'Tender Package Attachments';
        formIdInput.value = 'tender-package';
        
        // Set currentFormForModal to a virtual object for tender attachments
        currentFormForModal = { attachments: tenderAttachments, id: 'tender-package' };
        
        renderAttachmentList();
        modal.classList.add('show');
      }
      
      window.handleTenderAttachmentDragOver = function(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('tender-attachments-drop-zone').classList.add('drag-over');
      }
      
      window.handleTenderAttachmentDragLeave = function(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('tender-attachments-drop-zone').classList.remove('drag-over');
      }
      
      window.handleTenderAttachmentDrop = function(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('tender-attachments-drop-zone').classList.remove('drag-over');
        
        const files = event.dataTransfer.files;
        addTenderAttachmentFiles(files);
      }
      
      function addTenderAttachmentFiles(files) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // Validate file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert(`File "${file.name}" exceeds 10MB limit.`);
            continue;
          }
          
          // Validate file type
          const allowedTypes = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.jpg', '.jpeg', '.png'];
          const ext = '.' + file.name.split('.').pop().toLowerCase();
          if (!allowedTypes.includes(ext)) {
            alert(`File type "${ext}" is not supported.`);
            continue;
          }
          
          // Check for duplicates
          if (tenderAttachments.some(a => a.name === file.name)) {
            alert(`File "${file.name}" is already attached.`);
            continue;
          }
          
          tenderAttachments.push({
            name: file.name,
            size: file.size,
            type: file.type,
            addedAt: new Date().toISOString()
          });
        }
        
        renderCurrentBlock();
        showNotification(`${files.length} file(s) added`, 'success');
      }
      
      window.removeTenderAttachment = function(index) {
        if (confirm('Remove this attachment?')) {
          tenderAttachments.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      // ===== DELIVERY REQUIREMENTS MANAGEMENT =====
      window.addDeliveryRequirement = function() {
        deliveryRequirements.push({
          id: `dr_${Date.now()}`,
          deliveryTime: '',
          deliveryPlace: '',
          consigneeDetails: '',
          applyTo: 'all', // 'all', 'lot', or 'product'
          targetIds: [] // IDs of specific lots or products
        });
        renderCurrentBlock();
      }
      
      window.removeDeliveryRequirement = function(idx) {
        deliveryRequirements.splice(idx, 1);
        renderCurrentBlock();
      }
      
      window.updateDeliveryRequirement = function(idx, field, value) {
        if (deliveryRequirements[idx]) {
          deliveryRequirements[idx][field] = value;
        }
      }
      
      window.updateDeliveryRequirementApplyTo = function(idx, value) {
        if (deliveryRequirements[idx]) {
          deliveryRequirements[idx].applyTo = value;
          deliveryRequirements[idx].targetIds = []; // Reset targets when applyTo changes
          renderCurrentBlock();
        }
      }
      
      window.toggleDeliveryRequirementTarget = function(idx, targetId, checked) {
        if (deliveryRequirements[idx]) {
          if (checked) {
            if (!deliveryRequirements[idx].targetIds.includes(targetId)) {
              deliveryRequirements[idx].targetIds.push(targetId);
            }
          } else {
            deliveryRequirements[idx].targetIds = deliveryRequirements[idx].targetIds.filter(id => id !== targetId);
          }
        }
      }
      
      // Legacy functions for backwards compatibility
      window.addDeliveryRequirementField = function() {
        addDeliveryRequirement();
      }
      
      window.removeDeliveryRequirementField = function(fieldId) {
        // Legacy - not used in new grid structure
      }
      
      window.updateDeliveryFieldValue = function(fieldId, value) {
        // Legacy - not used in new grid structure
      }
      
      // ===== SUPPLIER FORM PREVIEW TOGGLE =====
      window.toggleSupplierFormPreview = function() {
        isSupplierFormPreviewVisible = !isSupplierFormPreviewVisible;
        renderCurrentBlock();
      }
      
      // ===== EVALUATION CRITERIA MANAGEMENT =====
      let editingCriterionId = null; // Track if we're editing an existing criterion
      
      // Open modal for add or edit
      window.openEvaluationCriterionModal = function(criterionId) {
        editingCriterionId = criterionId || null;
        const modal = document.getElementById('evaluation-criterion-modal');
        if (!modal) {
          console.error('Modal not found');
          return;
        }
        
        const titleEl = document.getElementById('eval-criterion-modal-title');
        const saveBtn = document.getElementById('eval-criterion-save-btn');
        const nameInput = document.getElementById('eval-criterion-name');
        const typeSelect = document.getElementById('eval-criterion-type');
        const methodSelect = document.getElementById('eval-criterion-method');
        const descInput = document.getElementById('eval-criterion-description');
        const entireRadio = document.querySelector('input[name="eval-criterion-applies"][value="entire"]');
        const specificRadio = document.querySelector('input[name="eval-criterion-applies"][value="specific"]');
        const specificSection = document.getElementById('eval-criterion-specific-section');
        
        // Reset form
        if (nameInput) nameInput.value = '';
        if (typeSelect) typeSelect.value = 'Qualification criteria';
        if (methodSelect) methodSelect.value = 'Pass/Fail';
        if (descInput) descInput.value = '';
        if (entireRadio) entireRadio.checked = true;
        if (specificSection) specificSection.style.display = 'none';
        
        // Populate lots/products dropdown
        populateEvalCriterionLotsDropdown();
        
        if (criterionId) {
          // Edit mode
          const criterion = evaluationCriteria.find(c => c.id === criterionId);
          if (criterion) {
            if (titleEl) titleEl.innerHTML = '<i class="pi pi-pencil"></i> Edit Evaluation Criterion';
            if (saveBtn) saveBtn.innerHTML = '<i class="pi pi-check"></i> Save Changes';
            
            if (nameInput) nameInput.value = criterion.criteria || '';
            if (typeSelect) typeSelect.value = criterion.type || 'Qualification criteria';
            if (methodSelect) methodSelect.value = criterion.evaluationMethod || 'Pass/Fail';
            if (descInput) descInput.value = criterion.description || '';
            
            if (criterion.appliesTo === 'specific') {
              if (specificRadio) specificRadio.checked = true;
              if (specificSection) specificSection.style.display = 'block';
              
              // Select the lots/products
              const lotsSelect = document.getElementById('eval-criterion-lots');
              if (lotsSelect) {
                Array.from(lotsSelect.options).forEach(opt => {
                  opt.selected = (criterion.lots && criterion.lots.includes(opt.value)) || 
                                 (criterion.unspscCodes && criterion.unspscCodes.includes(opt.value));
                });
              }
            }
          }
        } else {
          // Add mode
          if (titleEl) titleEl.innerHTML = '<i class="pi pi-plus-circle"></i> Add Evaluation Criterion';
          if (saveBtn) saveBtn.innerHTML = '<i class="pi pi-check"></i> Add Criterion';
        }
        
        modal.style.display = 'flex';
      }
      
      window.closeEvaluationCriterionModal = function() {
        const modal = document.getElementById('evaluation-criterion-modal');
        modal.style.display = 'none';
        editingCriterionId = null;
      }
      
      window.toggleEvalCriterionAppliesTo = function(value) {
        const specificSection = document.getElementById('eval-criterion-specific-section');
        specificSection.style.display = value === 'specific' ? 'block' : 'none';
      }
      
      function populateEvalCriterionLotsDropdown() {
        const lotsSelect = document.getElementById('eval-criterion-lots');
        lotsSelect.innerHTML = '';
        
        // Add lots
        if (lots.length > 0) {
          const lotOptGroup = document.createElement('optgroup');
          lotOptGroup.label = 'Lots';
          lots.forEach(lot => {
            const opt = document.createElement('option');
            opt.value = lot.id;
            opt.textContent = `${lot.description || 'Lot'} (${lot.unspscCodes.length} products)`;
            lotOptGroup.appendChild(opt);
          });
          lotsSelect.appendChild(lotOptGroup);
        }
        
        // Add individual products from requisition lines
        const availableUnspscCodes = getAvailableUnspscCodes();
        if (availableUnspscCodes.length > 0) {
          const productOptGroup = document.createElement('optgroup');
          productOptGroup.label = 'Products (UNSPSC)';
          availableUnspscCodes.forEach(unspsc => {
            const opt = document.createElement('option');
            opt.value = unspsc.code;
            opt.textContent = `${unspsc.code} - ${unspsc.description}`;
            productOptGroup.appendChild(opt);
          });
          lotsSelect.appendChild(productOptGroup);
        }
        
        if (lots.length === 0 && availableUnspscCodes.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No lots or products available';
          opt.disabled = true;
          lotsSelect.appendChild(opt);
        }
      }
      
      window.saveEvaluationCriterion = function() {
        const name = document.getElementById('eval-criterion-name').value.trim();
        const type = document.getElementById('eval-criterion-type').value;
        const method = document.getElementById('eval-criterion-method').value;
        const description = document.getElementById('eval-criterion-description').value.trim();
        const appliesTo = document.querySelector('input[name="eval-criterion-applies"]:checked').value;
        
        // Validation
        if (!name) {
          alert('Please enter a criteria name.');
          document.getElementById('eval-criterion-name').focus();
          return;
        }
        if (!description) {
          alert('Please enter a description.');
          document.getElementById('eval-criterion-description').focus();
          return;
        }
        
        // Get selected lots/products if specific
        let selectedLots = [];
        let selectedUnspscCodes = [];
        if (appliesTo === 'specific') {
          const lotsSelect = document.getElementById('eval-criterion-lots');
          Array.from(lotsSelect.selectedOptions).forEach(opt => {
            if (opt.value.startsWith('lot_')) {
              selectedLots.push(opt.value);
            } else if (opt.value) {
              selectedUnspscCodes.push(opt.value);
            }
          });
        }
        
        if (editingCriterionId) {
          // Update existing criterion
          const criterion = evaluationCriteria.find(c => c.id === editingCriterionId);
          if (criterion) {
            criterion.criteria = name;
            criterion.type = type;
            criterion.evaluationMethod = method;
            criterion.description = description;
            criterion.appliesTo = appliesTo;
            criterion.lots = selectedLots;
            criterion.unspscCodes = selectedUnspscCodes;
          }
        } else {
          // Add new criterion
          const newCriterion = {
            id: `ec_${evaluationCriteriaIdCounter++}`,
            criteria: name,
            type: type,
            description: description,
            evaluationMethod: method,
            appliesTo: appliesTo,
            lots: selectedLots,
            unspscCodes: selectedUnspscCodes,
            isPredefined: false
          };
          evaluationCriteria.push(newCriterion);
        }
        
        closeEvaluationCriterionModal();
        renderCurrentBlock();
      }
      
      // Keep legacy function for backward compatibility
      window.addEvaluationCriterion = function() {
        openEvaluationCriterionModal();
      }
      
      // ===== CRITERIA ADD DROPDOWN FUNCTIONS =====
      window.toggleCriterionAddDropdown = function(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const isOpen = dropdown.classList.contains('open');
        
        // Close all dropdowns first
        closeCriterionAddDropdowns();
        
        // Toggle the clicked dropdown
        if (!isOpen) {
          dropdown.classList.add('open');
          // Close dropdown when clicking outside
          setTimeout(() => {
            document.addEventListener('click', closeCriterionAddDropdownsOnClickOutside);
          }, 0);
        }
      }
      
      window.closeCriterionAddDropdowns = function() {
        document.querySelectorAll('.criterion-add-dropdown').forEach(d => d.classList.remove('open'));
        document.removeEventListener('click', closeCriterionAddDropdownsOnClickOutside);
      }
      
      function closeCriterionAddDropdownsOnClickOutside(e) {
        if (!e.target.closest('.criterion-add-dropdown')) {
          closeCriterionAddDropdowns();
        }
      }
      
      // ===== CRITERIA LIBRARY FUNCTIONS =====
      let selectedLibraryCriteria = [];
      let criteriaLibraryFilter = 'all';
      let criteriaLibrarySearchTerm = '';
      
      window.openCriteriaLibraryModal = function() {
        selectedLibraryCriteria = [];
        criteriaLibraryFilter = 'all';
        criteriaLibrarySearchTerm = '';
        
        // Reset search input
        const searchInput = document.getElementById('eval-criteria-library-search');
        if (searchInput) searchInput.value = '';
        
        // Reset filter buttons
        document.querySelectorAll('#eval-criteria-library-modal .criteria-filter-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent === 'All') btn.classList.add('active');
        });
        
        renderCriteriaLibrary();
        updateCriteriaLibrarySelectedInfo();
        
        const modal = document.getElementById('eval-criteria-library-modal');
        if (modal) modal.style.display = 'flex';
      }
      
      window.closeCriteriaLibraryModal = function() {
        const modal = document.getElementById('eval-criteria-library-modal');
        if (modal) modal.style.display = 'none';
        selectedLibraryCriteria = [];
      }
      
      window.filterCriteriaLibrary = function(searchTerm) {
        criteriaLibrarySearchTerm = searchTerm.toLowerCase();
        renderCriteriaLibrary();
      }
      
      window.filterCriteriaByCategory = function(category, btn) {
        criteriaLibraryFilter = category;
        
        // Update active button
        document.querySelectorAll('.criteria-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        renderCriteriaLibrary();
      }
      
      window.clearLibrarySelection = function() {
        selectedLibraryCriteria = [];
        renderCriteriaLibrary();
        updateCriteriaLibrarySelectedInfo();
      }
      
      // Toggle evaluation category sections (grouped criteria view)
      window.toggleEvalCategorySection = function(categoryId) {
        const body = document.getElementById('body-' + categoryId);
        const toggle = document.getElementById('toggle-' + categoryId);
        
        if (body && toggle) {
          const isHidden = body.style.display === 'none';
          body.style.display = isHidden ? 'block' : 'none';
          toggle.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(-90deg)';
        }
      }
      
      // Render grouped evaluation criteria by category
      function renderGroupedEvaluationCriteria(criteriaList, sectionPrefix) {
        const categories = ['Eligibility & Formal', 'Qualification', 'Technical'];
        // Lighter, more harmonious blue/slate tones
        const categoryConfig = {
          'Eligibility & Formal': { color: '#5b7c99', bg: '#f0f4f8', border: '#d9e2ec', icon: 'pi-check-circle' },
          'Qualification': { color: '#627d98', bg: '#f0f4f8', border: '#d9e2ec', icon: 'pi-verified' },
          'Technical': { color: '#486581', bg: '#f0f4f8', border: '#d9e2ec', icon: 'pi-cog' }
        };
        
        let html = '';
        
        // Always render in order: Eligibility & Formal, Qualification, Technical
        categories.forEach((cat, catIndex) => {
          const config = categoryConfig[cat];
          const criteriaInCategory = criteriaList.filter(c => (c.category || c.type || 'Eligibility & Formal') === cat);
          
          if (criteriaInCategory.length === 0) return;
          
          const numericCount = criteriaInCategory.filter(c => c.evaluationMethod === 'Numeric').length;
          const totalMaxPoints = criteriaInCategory.reduce((sum, c) => sum + (c.maxPoints || 0), 0);
          const spCount = criteriaInCategory.filter(c => c.sustainableProcurement && c.sustainableProcurement.length > 0).length;
          const sectionId = sectionPrefix + '-' + cat.replace(/\s+/g, '-').toLowerCase();
          
          html += '<div class="eval-category-section" style="margin-bottom: 12px; border: 1px solid ' + config.border + '; border-radius: var(--radius-md); overflow: hidden;">';
          
          // Category Header - Simplified
          html += '<div class="eval-category-header" onclick="toggleEvalCategorySection(\'' + sectionId + '\')" style="background: ' + config.bg + '; padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid ' + config.border + ';">';
          html += '<div style="display: flex; align-items: center; gap: 10px;">';
          html += '<div style="width: 32px; height: 32px; background: ' + config.color + '; border-radius: 6px; display: flex; align-items: center; justify-content: center;">';
          html += '<i class="pi ' + config.icon + '" style="color: white; font-size: 14px;"></i></div>';
          html += '<div style="font-weight: 700; font-size: 13px; color: ' + config.color + '; display: flex; align-items: center; gap: 8px;">' + cat;
          html += '<span style="background: ' + config.color + '; color: white; padding: 1px 6px; border-radius: 8px; font-size: 10px; font-weight: 600;">' + criteriaInCategory.length + '</span></div>';
          html += '</div>';
          html += '<div style="display: flex; align-items: center; gap: 12px;">';
          html += '<div style="display: flex; gap: 10px; font-size: 10px; color: var(--text-secondary);">';
          if (spCount > 0) {
            html += '<span style="color: var(--success-600);"><i class="pi pi-leaf" style="margin-right: 3px;"></i>' + spCount + ' with SP</span>';
          }
          if (numericCount > 0) {
            html += '<span><i class="pi pi-star" style="margin-right: 3px;"></i>' + totalMaxPoints + ' pts</span>';
          }
          html += '</div>';
          html += '<i class="pi pi-chevron-down eval-category-toggle" id="toggle-' + sectionId + '" style="font-size: 11px; color: ' + config.color + '; transition: transform 0.2s;"></i>';
          html += '</div></div>';
          
          // Category Table
          html += '<div class="eval-category-body" id="body-' + sectionId + '" style="overflow-x: auto;">';
          html += '<table style="width: 100%; min-width: 1000px; border-collapse: collapse; font-size: 11px;">';
          html += '<thead><tr style="background: var(--surface-50);">';
          html += '<th style="padding: 6px 8px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 60px;">ID</th>';
          html += '<th style="padding: 6px 8px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); min-width: 150px;">Criteria Name</th>';
          html += '<th style="padding: 6px 8px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); min-width: 200px;">Description</th>';
          html += '<th style="padding: 6px 8px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 70px;">Method</th>';
          html += '<th style="padding: 6px 8px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 55px;">Max Pts</th>';
          html += '<th style="padding: 6px 8px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 140px;">SP Category</th>';
          html += '<th style="padding: 6px 8px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 80px;">Apply To</th>';
          html += '<th style="padding: 6px 8px; text-align: left; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 100px;">Linked Forms</th>';
          html += '<th style="padding: 6px 8px; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 1px solid var(--surface-200); width: 65px;">Actions</th>';
          html += '</tr></thead><tbody>';
          
          criteriaInCategory.forEach((criterion, idx) => {
            const isPredefined = criterion.isPredefined;
            const linkedForms = criterion.linkedForms || [];
            const hasLinks = linkedForms.length > 0;
            const spCategories = criterion.sustainableProcurement || [];
            const hasSP = spCategories.length > 0;
            const appliesTo = criterion.appliesTo || 'tender';
            const selectedLots = criterion.lots || [];
            const rowBg = idx % 2 === 0 ? 'var(--surface-0)' : 'var(--surface-50)';
            
            html += '<tr style="background: ' + rowBg + '; vertical-align: top; border-left: 3px solid ' + config.color + ';">';
            
            // ID
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100);">';
            html += '<span style="font-weight: 600; color: ' + (isPredefined ? config.color : 'var(--text-primary)') + '; font-size: 10px; font-family: monospace;">' + criterion.id + '</span></td>';
            
            // Criteria Name
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100);">';
            html += '<div style="font-weight: 500; color: var(--text-primary); font-size: 11px; line-height: 1.3;">' + criterion.criteria + '</div></td>';
            
            // Description
            const desc = criterion.description || '';
            const shortDesc = desc.length > 90 ? desc.substring(0, 90) + '...' : desc;
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100);">';
            html += '<div style="font-size: 10px; color: var(--text-muted); line-height: 1.3;" title="' + desc.replace(/"/g, '&quot;') + '">' + shortDesc + '</div></td>';
            
            // Method
            const methodBg = criterion.evaluationMethod === 'Pass/Fail' ? 'var(--surface-100)' : 'var(--warning-50)';
            const methodColor = criterion.evaluationMethod === 'Pass/Fail' ? 'var(--text-secondary)' : 'var(--warning-700)';
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100); text-align: center;">';
            html += '<span style="background: ' + methodBg + '; color: ' + methodColor + '; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 500;">' + criterion.evaluationMethod + '</span></td>';
            
            // Max Points
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100); text-align: center;">';
            if (criterion.evaluationMethod === 'Numeric' && criterion.maxPoints) {
              html += '<span style="font-weight: 700; color: var(--warning-600); font-size: 11px;">' + criterion.maxPoints + '</span>';
            } else {
              html += '<span style="color: var(--text-muted);">‚Äî</span>';
            }
            html += '</td>';
            
            // SP Category
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100);">';
            if (hasSP) {
              html += '<div style="display: flex; flex-wrap: wrap; gap: 2px;">';
              const firstSP = spCategories[0];
              const spShort = firstSP.includes(' - ') ? firstSP.split(' - ')[1].substring(0, 18) : firstSP.substring(0, 18);
              html += '<span style="background: var(--success-50); color: var(--success-700); padding: 1px 4px; border-radius: 2px; font-size: 8px; font-weight: 500;" title="' + firstSP.replace(/"/g, '&quot;') + '">' + spShort + '...</span>';
              if (spCategories.length > 1) {
                html += '<span style="font-size: 8px; color: var(--text-muted);">+' + (spCategories.length - 1) + '</span>';
              }
              html += '</div>';
            } else {
              html += '<span style="color: var(--text-muted); font-size: 9px;">‚Äî</span>';
            }
            html += '</td>';
            
            // Apply To
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100);">';
            if (appliesTo === 'tender') {
              html += '<span style="font-size: 11px; color: var(--text-secondary);">Tender</span>';
            } else {
              html += '<span style="font-size: 11px; color: var(--text-secondary);">Lots (' + (selectedLots.length || 'All') + ')</span>';
            }
            html += '</td>';
            
            // Linked Forms
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100);">';
            if (hasLinks) {
              html += '<span style="background: var(--info-50); color: var(--info-600); padding: 1px 4px; border-radius: 2px; font-size: 8px;">' + linkedForms.length + ' form(s)</span>';
            } else {
              html += '<button onclick="openLinkFormsModal(\'' + criterion.id + '\')" style="font-size: 8px; padding: 2px 4px; color: var(--text-muted); background: none; border: 1px dashed var(--surface-300); border-radius: 2px; cursor: pointer;"><i class="pi pi-link"></i></button>';
            }
            html += '</td>';
            
            // Actions
            html += '<td style="padding: 8px; border-bottom: 1px solid var(--surface-100); text-align: center;">';
            if (isPredefined) {
              html += '<div style="display: flex; gap: 3px; justify-content: center; align-items: center;">';
              html += '<span style="font-size: 8px; color: var(--text-muted); background: var(--surface-100); padding: 2px 5px; border-radius: 3px;">System</span>';
              html += '<button class="btn-icon-xs danger" onclick="removeEvaluationCriterion(\'' + criterion.id + '\')" title="Remove" style="min-width: 20px; height: 20px;"><i class="pi pi-trash" style="font-size: 9px;"></i></button>';
              html += '</div>';
            } else {
              html += '<div style="display: flex; gap: 3px; justify-content: center;">';
              html += '<button class="btn-icon-xs" onclick="openEvaluationCriterionModal(\'' + criterion.id + '\')" title="Edit" style="min-width: 20px; height: 20px;"><i class="pi pi-pencil" style="font-size: 9px;"></i></button>';
              html += '<button class="btn-icon-xs danger" onclick="removeEvaluationCriterion(\'' + criterion.id + '\')" title="Remove" style="min-width: 20px; height: 20px;"><i class="pi pi-trash" style="font-size: 9px;"></i></button>';
              html += '</div>';
            }
            html += '</td></tr>';
          });
          
          html += '</tbody></table></div></div>';
        });
        
        return html;
      }
      
      function renderCriteriaLibrary() {
        const grid = document.getElementById('eval-criteria-library-grid');
        if (!grid) return;
        
        const isCumulativeAnalysis = evaluationBlockValues.evaluationMethod === 'Cumulative analysis';
        
        // Filter criteria
        let filteredCriteria = criteriaLibrary.filter(c => {
          // Category filter - use criteriaCategory for proper filtering
          const criteriaType = c.criteriaCategory || c.type || 'Eligibility & Formal';
          if (criteriaLibraryFilter !== 'all' && criteriaType !== criteriaLibraryFilter) {
            return false;
          }
          
          // Search filter
          if (criteriaLibrarySearchTerm) {
            const searchMatch = 
              c.name.toLowerCase().includes(criteriaLibrarySearchTerm) ||
              c.description.toLowerCase().includes(criteriaLibrarySearchTerm) ||
              (c.category && c.category.toLowerCase().includes(criteriaLibrarySearchTerm)) ||
              (c.criteriaCategory && c.criteriaCategory.toLowerCase().includes(criteriaLibrarySearchTerm)) ||
              (c.sustainableProcurement && c.sustainableProcurement.some(sp => sp.toLowerCase().includes(criteriaLibrarySearchTerm)));
            if (!searchMatch) return false;
          }
          
          return true;
        });
        
        if (filteredCriteria.length === 0) {
          grid.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <i class="pi pi-search" style="font-size: 32px; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
              <p>No criteria found matching your search.</p>
            </div>
          `;
          return;
        }
        
        grid.innerHTML = filteredCriteria.map(c => {
          const isSelected = selectedLibraryCriteria.includes(c.id);
          const criteriaCategory = c.criteriaCategory || c.type || 'Eligibility & Formal';
          // Lighter, harmonious slate-blue tones
          const categoryColor = criteriaCategory === 'Eligibility & Formal' ? '#5b7c99' : 
                                criteriaCategory === 'Qualification' ? '#627d98' : 
                                criteriaCategory === 'Technical' ? '#486581' : '#5b7c99';
          const categoryBg = '#f0f4f8';
          const hasSP = c.sustainableProcurement && c.sustainableProcurement.length > 0;
          const hasLinkedForms = c.linkedFormsSuggestion && c.linkedFormsSuggestion.length > 0;
          const isNumericNotAllowed = c.method === 'Numeric' && !isCumulativeAnalysis;
          
          return `
            <div class="criteria-library-item ${isSelected ? 'selected' : ''}" onclick="toggleLibraryCriterionSelection('${c.id}')" style="padding: 12px; border: 2px solid ${isSelected ? 'var(--primary-500)' : 'var(--surface-200)'}; border-radius: var(--radius-md); background: ${isSelected ? 'var(--primary-50)' : 'var(--surface-0)'}; cursor: pointer; transition: all 0.2s; box-shadow: ${isSelected ? '0 2px 8px rgba(var(--primary-500-rgb), 0.15)' : 'none'};">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <span style="font-size: 10px; color: var(--text-muted); font-family: monospace; background: var(--surface-100); padding: 1px 4px; border-radius: 3px;">${c.id}</span>
                    <span style="background: ${categoryBg}; color: ${categoryColor}; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">
                      ${criteriaCategory}
                    </span>
              </div>
                  <div style="font-weight: 600; color: var(--text-primary); font-size: 13px; line-height: 1.3;">${c.name}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  ${isSelected ? '<i class="pi pi-check-circle" style="color: var(--primary-500); font-size: 18px;"></i>' : '<i class="pi pi-circle" style="color: var(--surface-300); font-size: 18px;"></i>'}
                </div>
              </div>
              <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.4; margin-bottom: 10px;">${c.description.length > 120 ? c.description.substring(0, 120) + '...' : c.description}</div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                <span style="background: ${c.method === 'Pass/Fail' ? 'var(--surface-100)' : 'var(--warning-50)'}; color: ${c.method === 'Pass/Fail' ? 'var(--text-secondary)' : 'var(--warning-700)'}; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;">
                  <i class="pi ${c.method === 'Pass/Fail' ? 'pi-check-square' : 'pi-chart-bar'}" style="font-size: 9px; margin-right: 4px;"></i>${c.method}${c.method === 'Numeric' && c.maxPoints ? ` (${c.maxPoints} pts)` : ''}
                </span>
                ${isNumericNotAllowed ? `
                  <span style="background: var(--danger-50); color: var(--danger-600); padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;" title="Cannot be added - Numeric method requires Cumulative analysis evaluation method">
                    <i class="pi pi-ban" style="font-size: 9px; margin-right: 4px;"></i>Cannot add
                  </span>
                ` : ''}
                ${hasSP ? `
                  <span style="background: var(--success-50); color: var(--success-700); padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;" title="${c.sustainableProcurement.join('&#10;')}">
                    <i class="pi pi-leaf" style="font-size: 9px; margin-right: 4px;"></i>SP (${c.sustainableProcurement.length})
                  </span>
                ` : ''}
                ${hasLinkedForms ? `
                  <span style="background: var(--info-50); color: var(--info-700); padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;" title="Suggested linked forms">
                    <i class="pi pi-link" style="font-size: 9px; margin-right: 4px;"></i>Forms
                  </span>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      }
      
      window.toggleLibraryCriterionSelection = function(criterionId) {
        const index = selectedLibraryCriteria.indexOf(criterionId);
        if (index === -1) {
          selectedLibraryCriteria.push(criterionId);
        } else {
          selectedLibraryCriteria.splice(index, 1);
        }
        
        renderCriteriaLibrary();
        updateCriteriaLibrarySelectedInfo();
      }
      
      function updateCriteriaLibrarySelectedInfo() {
        const infoDiv = document.getElementById('eval-criteria-library-selected-info');
        const countSpan = document.getElementById('eval-criteria-library-selected-count');
        const addBtn = document.getElementById('add-eval-criteria-from-library-btn');
        const addCountSpan = document.getElementById('add-eval-criteria-count');
        
        const count = selectedLibraryCriteria.length;
        
        if (infoDiv) {
          infoDiv.style.display = count > 0 ? 'block' : 'none';
        }
        if (countSpan) {
          countSpan.textContent = count;
        }
        if (addBtn) {
          addBtn.disabled = count === 0;
        }
        if (addCountSpan) {
          addCountSpan.textContent = count;
        }
      }
      
      window.addSelectedCriteriaFromLibrary = function() {
        if (selectedLibraryCriteria.length === 0) return;
        
        const isCumulativeAnalysis = evaluationBlockValues.evaluationMethod === 'Cumulative analysis';
        let addedCount = 0;
        let skippedCount = 0;
        
        selectedLibraryCriteria.forEach(libId => {
          const libCriterion = criteriaLibrary.find(c => c.id === libId);
          if (libCriterion) {
            // Skip Numeric criteria if not using Cumulative analysis
            if (libCriterion.method === 'Numeric' && !isCumulativeAnalysis) {
              skippedCount++;
              return; // Skip this criterion
            }
            
            // Create new criterion from library template with all fields
            const criteriaCategory = libCriterion.criteriaCategory || libCriterion.type || 'Eligibility & Formal';
            
            const newCriterion = {
              id: `LIB-${String(evaluationCriteriaIdCounter++).padStart(3, '0')}`,
              criteria: libCriterion.name,
              category: criteriaCategory,
              type: criteriaCategory, // Keep type for backwards compatibility
              description: libCriterion.description,
              evaluationMethod: libCriterion.method,
              maxPoints: libCriterion.maxPoints || null,
              sustainableProcurement: libCriterion.sustainableProcurement ? [...libCriterion.sustainableProcurement] : [],
              appliesTo: 'tender',
              lots: [],
              unspscCodes: [],
              linkedForms: [],
              isPredefined: false,
              fromLibrary: true,
              libraryId: libCriterion.id
            };
            evaluationCriteria.push(newCriterion);
            addedCount++;
          }
        });
        
        closeCriteriaLibraryModal();
        saveEvaluationSectionStates();
        renderCurrentBlock();
        restoreEvaluationSectionStates();
        
        // Show notification
        if (typeof showNotification === 'function') {
          if (skippedCount > 0 && addedCount > 0) {
            showNotification(`${addedCount} criteria added. ${skippedCount} Numeric criteria skipped (requires Cumulative analysis)`, 'warning');
          } else if (skippedCount > 0 && addedCount === 0) {
            showNotification(`Cannot add Numeric criteria - Evaluation Method must be set to "Cumulative analysis"`, 'error');
          } else {
            showNotification(`${addedCount} criteria added from library`, 'success');
          }
        }
      }
      
      // ===== TEAM COLLABORATION BOARD FUNCTIONS =====
      let collabBoardComments = [
        { id: 1, status: 'open', from: 'Sarah Chen', text: '@TenderAuthor - The payment terms section needs clarification. Should we allow advance payments for this tender?', section: 'Payment Terms & Advance Payments', time: '2 hours ago', replies: [] },
        { id: 2, status: 'closed', from: 'Ahmed Hassan', text: '@Team - Do we need to include a site visit requirement for this tender?', section: 'Clarifications or pre-bid meeting', time: 'Yesterday', replies: [{ from: 'Tender Author', text: 'No site visit needed for this tender. It\'s a standard goods procurement.' }] }
      ];
      let collabBoardCommentIdCounter = 3;
      
      let collabBoardNotes = [
        { id: 1, title: 'üìå Tender Requirements Summary', author: 'Tender Author', text: '‚Ä¢ Type: Goods procurement (IT Equipment)\n‚Ä¢ Budget: $500,000 - $750,000\n‚Ä¢ Timeline: Q1 2025 delivery\n‚Ä¢ Key Requirements: ISO 9001, 3+ years experience', time: 'Updated 30 min ago' },
        { id: 2, title: '‚ö†Ô∏è Items to Review', author: 'Sarah Chen', text: '1. Confirm advance payment policy with finance\n2. Review liquidated damages clause\n3. Verify Incoterms selection (EXW vs DDP)', time: 'Updated 1 hour ago' }
      ];
      let collabBoardNoteIdCounter = 3;
      
      window.toggleCollabBoard = function() {
        const panel = document.getElementById('collabBoardPanel');
        const btn = document.getElementById('collabBoardBtn');
        
        panel.classList.toggle('open');
        
        if (panel.classList.contains('open')) {
          btn.style.right = '400px';
        } else {
          btn.style.right = '0';
        }
      }
      
      window.switchCollabBoardTab = function(tabId) {
        // Update tab buttons
        document.querySelectorAll('.collab-board-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById('collab-tab-' + tabId).classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.collab-board-tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('collab-board-' + tabId).classList.add('active');
      }
      
      window.sendCollabBoardMessage = function() {
        const input = document.getElementById('collabBoardMessageInput');
        const message = input.value.trim();
        if (!message) return;
        
        const messageList = document.getElementById('collabBoardMessageList');
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        const messageHtml = `
          <div class="collab-board-message">
            <div class="collab-board-message-avatar" style="background: var(--success-100); color: var(--success-600);">TA</div>
            <div class="collab-board-message-content">
              <div class="collab-board-message-header">
                <span class="collab-board-message-author">Tender Author (You)</span>
                <span class="collab-board-message-time">${timeStr}</span>
              </div>
              <div class="collab-board-message-text">${message}</div>
            </div>
          </div>
        `;
        messageList.insertAdjacentHTML('beforeend', messageHtml);
        input.value = '';
        
        // Scroll to bottom
        messageList.scrollTop = messageList.scrollHeight;
        
        if (typeof showNotification === 'function') {
          showNotification('üí¨ Message sent to team', 'success');
        }
      }
      
      window.createNewCollabComment = function() {
        const modalHtml = `
          <div id="newCollabCommentModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10002; display: flex; align-items: center; justify-content: center;" onclick="if(event.target===this) this.remove()">
            <div style="background: white; border-radius: var(--radius-lg); width: 450px; max-width: 95%; box-shadow: var(--shadow-lg);">
              <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: var(--spacing-lg); border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h3 style="margin: 0; font-size: 16px;">üí≠ Add New Comment</h3>
              </div>
              <div style="padding: var(--spacing-lg);">
                <div style="margin-bottom: var(--spacing-md);">
                  <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px;">Direct to:</label>
                  <select id="newCollabCommentTo" style="width: 100%; padding: 8px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);">
                    <option>@Everyone (All Team Members)</option>
                    <option>@Sarah Chen</option>
                    <option>@Ahmed Hassan</option>
                  </select>
                </div>
                <div style="margin-bottom: var(--spacing-md);">
                  <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px;">Related Section:</label>
                  <select id="newCollabCommentSection" style="width: 100%; padding: 8px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);">
                    <option>General</option>
                    <option>Project Information</option>
                    <option>Particulars</option>
                    <option>Key Dates</option>
                    <option>Contract Provisions</option>
                    <option>Evaluation Method</option>
                    <option>Evaluation Criteria</option>
                    <option>Payment Terms</option>
                  </select>
                </div>
                <div style="margin-bottom: var(--spacing-md);">
                  <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px;">Your Comment:</label>
                  <textarea id="newCollabCommentText" rows="4" placeholder="Type your comment here..." style="width: 100%; padding: 8px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm); resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                  <button class="btn btn-secondary" onclick="document.getElementById('newCollabCommentModal').remove()">Cancel</button>
                  <button class="btn btn-primary" onclick="submitNewCollabComment()" style="background: #10b981;">Add Comment</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      window.submitNewCollabComment = function() {
        const text = document.getElementById('newCollabCommentText').value.trim();
        const section = document.getElementById('newCollabCommentSection').value;
        
        if (!text) {
          alert('Please enter a comment');
          return;
        }
        
        const newComment = {
          id: collabBoardCommentIdCounter++,
          status: 'open',
          from: 'Tender Author (You)',
          text: text,
          section: section,
          time: 'Just now',
          replies: []
        };
        
        collabBoardComments.unshift(newComment);
        document.getElementById('newCollabCommentModal').remove();
        renderCollabBoardComments();
        updateCollabCommentsBadge();
        
        if (typeof showNotification === 'function') {
          showNotification('üí≠ Comment added', 'success');
        }
      }
      
      window.replyToCollabComment = function(commentId) {
        const reply = prompt('Enter your reply:');
        if (reply && reply.trim()) {
          const comment = collabBoardComments.find(c => c.id === commentId);
          if (comment) {
            comment.replies.push({ from: 'Tender Author (You)', text: reply.trim() });
            renderCollabBoardComments();
            
            if (typeof showNotification === 'function') {
              showNotification('‚úÖ Reply added', 'success');
            }
          }
        }
      }
      
      window.closeCollabComment = function(commentId) {
        const comment = collabBoardComments.find(c => c.id === commentId);
        if (comment) {
          comment.status = 'closed';
          renderCollabBoardComments();
          updateCollabCommentsBadge();
          
          if (typeof showNotification === 'function') {
            showNotification('‚úÖ Comment closed', 'success');
          }
        }
      }
      
      function renderCollabBoardComments() {
        const list = document.getElementById('collabBoardCommentList');
        if (!list) return;
        
        list.innerHTML = collabBoardComments.map(comment => `
          <div class="collab-board-comment-item ${comment.status}" data-comment-id="${comment.id}">
            <div class="collab-board-comment-header">
              <span class="collab-board-comment-badge ${comment.status}">${comment.status === 'open' ? '‚è≥ Open' : '‚úÖ Closed'}</span>
              <span class="collab-board-comment-from">From: ${comment.from}</span>
            </div>
            <div class="collab-board-comment-text">${comment.text}</div>
            ${comment.replies.length > 0 ? comment.replies.map(r => `
              <div class="collab-board-comment-reply">
                <strong>Reply (${r.from}):</strong> ${r.text}
              </div>
            `).join('') : ''}
            <div class="collab-board-comment-meta">
              <span>Re: ${comment.section}</span>
              <span>${comment.time}</span>
            </div>
            ${comment.status === 'open' ? `
              <div class="collab-board-comment-actions">
                <button class="btn btn-sm btn-primary" onclick="replyToCollabComment(${comment.id})">Reply</button>
                <button class="btn btn-sm btn-success" onclick="closeCollabComment(${comment.id})">Close</button>
              </div>
            ` : ''}
          </div>
        `).join('');
      }
      
      function updateCollabCommentsBadge() {
        const openCount = collabBoardComments.filter(c => c.status === 'open').length;
        const badge = document.getElementById('collab-comments-badge');
        const mainBadge = document.getElementById('collabBoardBadge');
        
        if (badge) {
          badge.textContent = openCount;
          badge.style.display = openCount > 0 ? 'inline' : 'none';
        }
        if (mainBadge) {
          mainBadge.textContent = openCount;
          mainBadge.style.display = openCount > 0 ? 'flex' : 'none';
        }
      }
      
      window.addCollabBoardNote = function() {
        const modalHtml = `
          <div id="newCollabNoteModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10002; display: flex; align-items: center; justify-content: center;" onclick="if(event.target===this) this.remove()">
            <div style="background: white; border-radius: var(--radius-lg); width: 450px; max-width: 95%; box-shadow: var(--shadow-lg);">
              <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: var(--spacing-lg); border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h3 style="margin: 0; font-size: 16px;">üìù Add Shared Note</h3>
              </div>
              <div style="padding: var(--spacing-lg);">
                <div style="margin-bottom: var(--spacing-md);">
                  <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px;">Note Title:</label>
                  <input type="text" id="newCollabNoteTitle" placeholder="e.g., Key Requirements, Action Items..." style="width: 100%; padding: 8px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm);" />
                </div>
                <div style="margin-bottom: var(--spacing-md);">
                  <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 4px;">Note Content:</label>
                  <textarea id="newCollabNoteText" rows="5" placeholder="Enter your note content..." style="width: 100%; padding: 8px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm); resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                  <button class="btn btn-secondary" onclick="document.getElementById('newCollabNoteModal').remove()">Cancel</button>
                  <button class="btn btn-primary" onclick="submitNewCollabNote()" style="background: #10b981;">Add Note</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      window.submitNewCollabNote = function() {
        const title = document.getElementById('newCollabNoteTitle').value.trim();
        const text = document.getElementById('newCollabNoteText').value.trim();
        
        if (!title || !text) {
          alert('Please enter both title and content');
          return;
        }
        
        const newNote = {
          id: collabBoardNoteIdCounter++,
          title: title,
          author: 'Tender Author (You)',
          text: text,
          time: 'Just now'
        };
        
        collabBoardNotes.unshift(newNote);
        document.getElementById('newCollabNoteModal').remove();
        renderCollabBoardNotes();
        
        if (typeof showNotification === 'function') {
          showNotification('üìù Note added to shared board', 'success');
        }
      }
      
      function renderCollabBoardNotes() {
        const list = document.getElementById('collabBoardNotesList');
        if (!list) return;
        
        list.innerHTML = collabBoardNotes.map(note => `
          <div class="collab-board-note-item">
            <div class="collab-board-note-header">
              <span style="font-weight: 600;">${note.title}</span>
              <span class="collab-board-note-author">${note.author}</span>
            </div>
            <div class="collab-board-note-text">${note.text.replace(/\n/g, '<br>')}</div>
            <div class="collab-board-note-time">${note.time}</div>
          </div>
        `).join('');
      }
      
      window.removeEvaluationCriterion = function(criterionId) {
        // Prevent removal of predefined criteria
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion && criterion.isPredefined) {
          alert('Predefined criteria cannot be removed.');
          return;
        }
        
        if (confirm('Are you sure you want to remove this evaluation criterion?')) {
          const index = evaluationCriteria.findIndex(c => c.id === criterionId);
          if (index !== -1) {
            evaluationCriteria.splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      // ===== LINK FORMS TO CRITERIA =====
      let currentLinkingCriterionId = null;
      
      window.openLinkFormsModal = function(criterionId) {
        currentLinkingCriterionId = criterionId;
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (!criterion) return;
        
        // Initialize linkedForms if not exists
        if (!criterion.linkedForms) {
          criterion.linkedForms = [];
        }
        
        const modal = document.getElementById('link-forms-modal');
        const titleEl = document.getElementById('link-forms-modal-title');
        const bodyEl = document.getElementById('link-forms-modal-body');
        
        titleEl.textContent = `Link Forms to: ${criterion.criteria}`;
        bodyEl.innerHTML = renderLinkFormsModalContent(criterion);
        
        modal.style.display = 'flex';
      }
      
      window.closeLinkFormsModal = function() {
        const modal = document.getElementById('link-forms-modal');
        modal.style.display = 'none';
        currentLinkingCriterionId = null;
      }
      
      function renderLinkFormsModalContent(criterion) {
        const linkedForms = criterion.linkedForms || [];
        
        // Get all available forms from submissionForms and their library additions
        const availableForms = getAvailableFormsForLinking();
        
        return `
          <div style="margin-bottom: var(--spacing-lg);">
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: var(--spacing-md);">
              Select forms or sections where suppliers should provide information for this criterion.
            </div>
            
            <!-- Currently Linked Forms -->
            ${linkedForms.length > 0 ? `
              <div style="margin-bottom: var(--spacing-lg);">
                <label style="font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); display: block;">
                  Currently Linked
                </label>
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  ${linkedForms.map((link, idx) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--info-50); border: 1px solid var(--info-200); border-radius: 6px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="pi pi-file" style="color: var(--info-600);"></i>
                        <span style="font-size: 13px; font-weight: 500;">${link.formName}</span>
                        ${link.section ? `<span style="color: var(--text-muted);">‚Üí</span><span style="font-size: 12px; color: var(--text-secondary);">${link.section}</span>` : ''}
                      </div>
                      <button class="btn-icon-xs danger" onclick="removeLinkFromCriterion(${idx})" title="Remove link">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            <!-- Available Forms to Link -->
            <div>
              <label style="font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); display: block;">
                Available Forms
              </label>
              <div style="display: flex; flex-direction: column; gap: 4px; max-height: 300px; overflow-y: auto; border: 1px solid var(--surface-200); border-radius: 6px; padding: 8px;">
                ${availableForms.map(form => `
                  <div style="padding: 10px 12px; background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: 6px; cursor: pointer; transition: all 0.15s;" 
                       onmouseover="this.style.borderColor='var(--primary-300)'; this.style.background='var(--primary-50)'"
                       onmouseout="this.style.borderColor='var(--surface-200)'; this.style.background='var(--surface-0)'"
                       onclick="addLinkToCriterion('${form.id}', '${form.name}', '')">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                      <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="pi ${form.icon}" style="font-size: 14px; color: var(--primary-600);"></i>
                        <div>
                          <div style="font-size: 13px; font-weight: 500; color: var(--text-primary);">${form.name}</div>
                          <div style="font-size: 11px; color: var(--text-muted);">${form.type}</div>
                        </div>
                      </div>
                      <i class="pi pi-plus" style="color: var(--primary-500);"></i>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: var(--spacing-sm); padding-top: var(--spacing-md); border-top: 1px solid var(--surface-200);">
            <button class="btn btn-secondary" onclick="closeLinkFormsModal()">Done</button>
          </div>
        `;
      }
      
      function getAvailableFormsForLinking() {
        const forms = [];
        
        // Add forms from submissionForms that have templates enabled
        submissionForms.forEach(form => {
          const templateEnabled = formCategoryTemplateEnabled[form.id] !== false;
          const libraryForms = formCategoryLibraryForms[form.id] || [];
          
          if (templateEnabled && form.templateName) {
            forms.push({
              id: form.id,
              name: form.templateName,
              type: 'Predefined template',
              icon: 'pi-file'
            });
          }
          
          // Add additional templates
          if (form.additionalTemplates) {
            form.additionalTemplates.forEach(tmpl => {
              forms.push({
                id: form.id + '-' + tmpl.replace(/\s+/g, '-').toLowerCase(),
                name: tmpl,
                type: 'Predefined template',
                icon: 'pi-file'
              });
            });
          }
          
          // Add library forms
          libraryForms.forEach(libForm => {
            forms.push({
              id: form.id + '-lib-' + libForm.name.replace(/\s+/g, '-').toLowerCase(),
              name: libForm.name,
              type: 'Library form',
              icon: 'pi-file-edit'
            });
          });
        });
        
        return forms;
      }
      
      window.addLinkToCriterion = function(formId, formName, section) {
        if (!currentLinkingCriterionId) return;
        
        const criterion = evaluationCriteria.find(c => c.id === currentLinkingCriterionId);
        if (!criterion) return;
        
        if (!criterion.linkedForms) {
          criterion.linkedForms = [];
        }
        
        // Check if already linked
        const exists = criterion.linkedForms.some(l => l.formId === formId && l.section === section);
        if (exists) {
          showToast('This form is already linked', 'warning');
          return;
        }
        
        criterion.linkedForms.push({
          formId: formId,
          formName: formName,
          section: section
        });
        
        // Re-render modal content
        const bodyEl = document.getElementById('link-forms-modal-body');
        bodyEl.innerHTML = renderLinkFormsModalContent(criterion);
        
        // Also update the main table
        renderCurrentBlock();
        
        showToast(`Linked "${formName}" to criterion`, 'success');
      }
      
      window.removeLinkFromCriterion = function(linkIndex) {
        if (!currentLinkingCriterionId) return;
        
        const criterion = evaluationCriteria.find(c => c.id === currentLinkingCriterionId);
        if (!criterion || !criterion.linkedForms) return;
        
        criterion.linkedForms.splice(linkIndex, 1);
        
        // Re-render modal content
        const bodyEl = document.getElementById('link-forms-modal-body');
        bodyEl.innerHTML = renderLinkFormsModalContent(criterion);
        
        // Also update the main table
        renderCurrentBlock();
      }
      
      window.updateEvaluationCriterionName = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.criteria = value;
        }
      }
      
      window.updateEvaluationCriterionType = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.type = value;
        }
      }
      
      window.updateEvaluationCriterionDescription = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.description = value;
        }
      }
      
      window.updateEvaluationCriterionMethod = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.evaluationMethod = value;
        }
      }
      
      window.updateEvaluationCriterionAppliesTo = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.appliesTo = value;
          if (value === 'entire') {
            criterion.unspscCodes = [];
          }
          renderCurrentBlock();
        }
      }
      
      window.updateEvaluationCriterionLots = function(criterionId, selectElement) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          const selectedOptions = Array.from(selectElement.selectedOptions);
          criterion.lots = selectedOptions.map(opt => opt.value);
          
          // Auto-populate UNSPSC codes from selected lots
          criterion.unspscCodes = [];
          criterion.lots.forEach(lotId => {
            const lot = lots.find(l => l.id === lotId);
            if (lot) {
              lot.unspscCodes.forEach(unspsc => {
                if (!criterion.unspscCodes.includes(unspsc.code)) {
                  criterion.unspscCodes.push(unspsc.code);
                }
              });
            }
          });
        }
      }

      window.updateEvaluationCriterionUnspscCodes = function(criterionId, selectElement) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          const selectedOptions = Array.from(selectElement.selectedOptions);
          criterion.unspscCodes = selectedOptions.map(opt => opt.value);
        }
      }
      
      window.getAvailableUnspscCodes = function() {
        // Get unique UNSPSC codes from requisition lines and lots
        let unspscCodes = [];
        
        // From requisition lines
        requisitionLines.forEach(line => {
          if (!unspscCodes.some(u => u.code === line.unspscCode)) {
            unspscCodes.push({
              code: line.unspscCode,
              description: line.unspscDescription
            });
          }
        });
        
        // From lots
        lots.forEach(lot => {
          lot.unspscCodes.forEach(unspsc => {
            if (!unspscCodes.some(u => u.code === unspsc.code)) {
              unspscCodes.push({
                code: unspsc.code,
                description: unspsc.description || 'No description'
              });
            }
          });
        });
        
        return unspscCodes;
      }
      
      // ===== GENERAL INFORMATION - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateSourcingOrSolicitation = function(value) {
        generalInfoValues.sourcingOrSolicitation = value;
        renderCurrentBlock();
      }
      
      window.updateModalityOfBidReceipt = function(value) {
        generalInfoValues.modalityOfBidReceipt = value;
        renderCurrentBlock();
      }
      
      window.updateEPP = function(value) {
        generalInfoValues.epp = value;
        renderCurrentBlock();
      }
      
      window.updateMedicineOrMedical = function(value) {
        generalInfoValues.medicineOrMedical = value;
        renderCurrentBlock();
      }
      
      window.updateProcessType = function(checkbox) {
        const value = checkbox.value;
        const isChecked = checkbox.checked;
        
        if (isChecked) {
          if (!generalInfoValues.processType.includes(value)) {
            generalInfoValues.processType.push(value);
          }
        } else {
          generalInfoValues.processType = generalInfoValues.processType.filter(v => v !== value);
        }
        
        generalInfoValues.directContracting = generalInfoValues.processType.includes('Direct contracting / Sole sourcing');
        renderCurrentBlock();
      }
      
      window.updateUNCollaboration = function(value) {
        generalInfoValues.unCollaboration = value;
        renderCurrentBlock();
      }
      
      window.updateIsLease = function(value) {
        generalInfoValues.isLease = value;
        renderCurrentBlock();
      }
      
      window.updateIsProcurementOfInnovation = function(value) {
        generalInfoValues.isProcurementOfInnovation = value;
        renderCurrentBlock();
      }
      
      window.updateEarlyMarketEngagement = function(value) {
        generalInfoValues.earlyMarketEngagement = value;
        renderCurrentBlock();
      }
      
      window.updateVendorTrainingConducted = function(value) {
        generalInfoValues.vendorTrainingConducted = value;
        renderCurrentBlock();
      }
      
      window.updateEventType = function(value) {
        generalInfoValues.eventType = value;
        renderCurrentBlock();
      }
      
      window.updateTypeOfRequirement = function(value) {
        generalInfoValues.typeOfRequirement = value;
        renderCurrentBlock();
      }
      
      window.updateIsRetendering = function(checkbox) {
        generalInfoValues.isRetendering = checkbox.checked;
        renderCurrentBlock();
      }
      
      window.updateProcessTypeSelect = function(value) {
        generalInfoValues.processType = value;
        generalInfoValues.directContracting = value === 'Direct contracting / Sole sourcing';
        renderCurrentBlock();
      }
      
      // ===== PROJECT INFORMATION - AUTO-POPULATION FROM oneUNOPS PROJECT =====
      // Array to hold multiple projects
      let selectedProjects = [
        {
          projectId: '',
          projectName: '',
          implementationEndDate: '',
          donorFundingSourceComment: ''
        }
      ];
      
      // Helper to get empty project template
      function getEmptyProject() {
        return {
          projectId: '',
          projectName: '',
          implementationEndDate: '',
          donorFundingSourceComment: ''
        };
      }
      
      window.addProject = function() {
        selectedProjects.push(getEmptyProject());
        renderCurrentBlock();
        showNotification('Project Added', `Project ${selectedProjects.length} added. Please select a project from oneUNOPS.`);
      }
      
      window.removeProject = function(index) {
        if (selectedProjects.length <= 1) {
          showNotification('Cannot Remove', 'At least one project entry is required.', 'warning');
          return;
        }
        const removedProject = selectedProjects[index];
        selectedProjects.splice(index, 1);
        renderCurrentBlock();
        showNotification('Project Removed', removedProject.projectName ? `Project "${removedProject.projectName}" removed.` : `Project entry ${index + 1} removed.`);
      }
      
      window.updateProjectFromId = function(projectId, projectIndex = 0) {
        // Find the project from availableOneUNOPSProjects
        const project = availableOneUNOPSProjects.find(p => p.id === projectId);
        
        if (project) {
          selectedProjects[projectIndex].projectId = project.id;
          selectedProjects[projectIndex].projectName = project.name;
          selectedProjects[projectIndex].implementationEndDate = project.implementationEndDate;
          
          // Update the Project Name field for this project entry
          const projectNameInput = document.querySelector(`input[data-field-id="projectName-${projectIndex}"]`);
          if (projectNameInput) {
            projectNameInput.value = project.name;
          }
          
          // Update the Implementation End Date field for this project entry
          const implEndDateInput = document.querySelector(`input[data-field-id="implementationEndDate-${projectIndex}"]`);
          if (implEndDateInput) {
            implEndDateInput.value = project.implementationEndDate;
          }
          
          showNotification('Project Loaded', `Project "${project.name}" selected. Implementation End Date: ${project.implementationEndDate}`);
        }
      }
      
      window.updateDonorComment = function(value, projectIndex) {
        if (selectedProjects[projectIndex]) {
          selectedProjects[projectIndex].donorFundingSourceComment = value;
        }
      }
      
      window.searchOneUNOPSProjects = function(searchText, dropdownId, projectIndex = 0) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        const searchLower = searchText.toLowerCase();
        const matchingProjects = availableOneUNOPSProjects.filter(p => 
          p.id.toLowerCase().includes(searchLower) ||
          p.name.toLowerCase().includes(searchLower) ||
          p.country.toLowerCase().includes(searchLower)
        );
        
        if (searchText.length < 1) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matchingProjects.map(project => `
          <div class="project-search-result" onclick="selectOneUNOPSProject('${project.id}', '${dropdownId}', ${projectIndex})" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.15s;">
            <div style="font-weight: 600; color: var(--text-primary); font-size: 13px;">${project.id}</div>
            <div style="color: var(--text-secondary); font-size: 12px; margin-top: 2px;">${project.name}</div>
            <div style="color: var(--text-muted); font-size: 11px; margin-top: 2px;">
              <span><i class="pi pi-map-marker" style="font-size: 10px;"></i> ${project.country}</span>
              <span style="margin-left: 10px;"><i class="pi pi-calendar" style="font-size: 10px;"></i> End: ${project.implementationEndDate}</span>
            </div>
          </div>
        `).join('') || '<div style="padding: 12px; color: var(--text-muted); text-align: center;">No projects found</div>';
        
        dropdown.style.display = 'block';
        
        // Add hover effect
        dropdown.querySelectorAll('.project-search-result').forEach(item => {
          item.addEventListener('mouseenter', () => item.style.background = 'var(--hover-bg)');
          item.addEventListener('mouseleave', () => item.style.background = 'transparent');
        });
      }
      
      window.selectOneUNOPSProject = function(projectId, dropdownId, projectIndex = 0) {
        const project = availableOneUNOPSProjects.find(p => p.id === projectId);
        if (!project) return;
        
        // Update the search input with the project ID
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
          const input = dropdown.previousElementSibling?.querySelector('input') || dropdown.parentElement.querySelector('input');
          if (input) {
            input.value = `${project.id} - ${project.name}`;
          }
          dropdown.style.display = 'none';
        }
        
        // Auto-populate related fields for this specific project entry
        updateProjectFromId(projectId, projectIndex);
      }
      
      window.openLifecycleTrackerSearch = function() {
        // Open lifecycle tracker search modal/dialog
        showNotification('Lifecycle Tracker Search', 'Opening lifecycle tracker to link previous process...');
        // In a real implementation, this would open a modal to search the lifecycle tracker
        // For now, we simulate with a simple prompt
        const processRef = prompt('Enter the reference of the previous process from Lifecycle Tracker:');
        if (processRef) {
          const input = document.querySelector('input[placeholder*="lifecycle tracker"]');
          if (input) {
            input.value = processRef;
          }
          showNotification('Process Linked', `Successfully linked to process: ${processRef}`);
        }
      }
      
      window.shouldShowField = function(field) {
        if (!field.conditionalVisibility) return true;
        
        const condition = field.conditionalVisibility;
        
        // Complex condition for Linked Process
        if (condition.complex && field.id === 'linkedProcess') {
          const hasDirectContracting = generalInfoValues.processType === 'Direct contracting / Sole sourcing';
          const hasSolicitation = generalInfoValues.sourcingOrSolicitation !== '';
          const hasLTABPA = generalInfoValues.processType === 'Solicit offers against LTA/BPA';
          const hasContractAmendment = generalInfoValues.processType === 'Contract Amendment';
          return hasDirectContracting || hasSolicitation || hasLTABPA || hasContractAmendment;
        }
        
        // Single value condition - Check both generalInfoValues and evaluationBlockValues
        if (condition.field && condition.value !== undefined) {
          if (generalInfoValues[condition.field] !== undefined) {
            return generalInfoValues[condition.field] === condition.value;
          }
          if (evaluationBlockValues[condition.field] !== undefined) {
            return evaluationBlockValues[condition.field] === condition.value;
          }
        }
        
        // Multiple values condition
        if (condition.field && condition.values) {
          if (generalInfoValues[condition.field] !== undefined) {
            return condition.values.includes(generalInfoValues[condition.field]);
          }
          if (evaluationBlockValues[condition.field] !== undefined) {
            return condition.values.includes(evaluationBlockValues[condition.field]);
          }
        }
        
        // Contains condition (for processType - now a string value)
        if (condition.field && condition.contains) {
          return generalInfoValues.processType === condition.contains;
        }
        
        return true;
      }
      
      // ===== EVALUATION BLOCK - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateEvaluationMethodInEvaluation = function(value) {
        saveEvaluationSectionStates();
        const previousMethod = evaluationBlockValues.evaluationMethod;
        evaluationBlockValues.evaluationMethod = value;
        
        // If switching away from Cumulative analysis, remove any Numeric criteria
        if (previousMethod === 'Cumulative analysis' && value !== 'Cumulative analysis') {
          const numericCriteria = evaluationCriteria.filter(c => c.evaluationMethod === 'Numeric' && !c.isPredefined);
          if (numericCriteria.length > 0) {
            // Remove numeric criteria
            evaluationCriteria = evaluationCriteria.filter(c => c.evaluationMethod !== 'Numeric' || c.isPredefined);
            showNotification(`${numericCriteria.length} Numeric criteria removed (only allowed with Cumulative analysis)`, 'warning');
          }
        }
        
        // Pre-fill evaluation method details if not already customized
        if (value && (!evaluationBlockValues.evaluationMethodDetails || evaluationBlockValues.evaluationMethodDetails === getDefaultEvaluationMethodDetails())) {
          evaluationBlockValues.evaluationMethodDetails = getDefaultEvaluationMethodDetails();
        }
        
        renderCurrentBlock();
        restoreEvaluationSectionStates();
      }
      
      window.updateEvaluationMethodDetailsInEvaluation = function(value) {
        saveEvaluationSectionStates();
        evaluationBlockValues.evaluationMethodDetails = value;
        renderCurrentBlock();
        restoreEvaluationSectionStates();
      }
      
      window.updateMaxPointsTechnical = function(value) {
        evaluationBlockValues.maxPointsTechnical = value;
      }
      
      // Get default evaluation method details based on solicitation type
      function getDefaultEvaluationMethodDetails() {
        // Try to determine solicitation type from general info or wizard data
        const solicitationType = generalInfoValues.solicitationType || wizardData.method || '';
        const solicitationUpper = solicitationType.toUpperCase();
        
        if (solicitationUpper.includes('RFQ') || solicitationUpper === 'RFQ') {
          return evaluationMethodDetailsTemplates['RFQ'];
        } else if (solicitationUpper.includes('ITB') || solicitationUpper === 'ITB') {
          return evaluationMethodDetailsTemplates['ITB'];
        } else if (solicitationUpper.includes('RFP') || solicitationUpper === 'RFP') {
          return evaluationMethodDetailsTemplates['RFP'];
        } else if (solicitationUpper.includes('EOI') || solicitationUpper === 'EOI') {
          return evaluationMethodDetailsTemplates['EOI'];
        }
        return evaluationMethodDetailsTemplates['default'];
      }
      
      // ===== PARTICULARS - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateClarificationsOrPreBid = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.clarificationsOrPreBid = value;
        // Parse number of meetings from value
        if (value === 'One pre-bid meeting') {
          particularsValues.numberOfMeetings = 1;
        } else if (value === 'Two pre-bid meetings') {
          particularsValues.numberOfMeetings = 2;
        } else {
          particularsValues.numberOfMeetings = 0;
        }
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateSiteVisit = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.siteVisit = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateSiteVisitDateOption = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.dateOption = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateExclusivity = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.exclusivity = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateAlternativeOffers = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.alternativeOffers = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateAdvancePaymentAllowed = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.advancePaymentAllowed = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.handleAdvancePaymentJustification = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.advancePaymentJustification = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.handleAdvancePaymentPercentage = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.advancePaymentPercentage = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateBidderEligibility = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.bidderEligibility = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updatePaymentTerms = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.paymentTerms = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateAdvancePaymentSecurity = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.advancePaymentSecurity = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateLiquidatedDamages = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.liquidatedDamages = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updatePerformanceSecurity = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.performanceSecurity = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateBidSecurity = function(value) {
        saveProjectDetailsSectionStates();
        particularsValues.bidSecurity = value;
        renderCurrentBlock();
        restoreProjectDetailsSectionStates();
      }
      
      window.updateParticularsIncoterms = function(selectElement) {
        const selectedOptions = Array.from(selectElement.selectedOptions).map(opt => opt.value);
        particularsValues.incoterms = selectedOptions;
        // Note: No need to re-render for multiselect since it doesn't trigger conditional visibility
      }

      // ===== TENDER AUTHOR CONFIGURATION SECTION =====
      // Predefined requirement names - these are known database fields
      const PREDEFINED_REQUIREMENT_NAMES = ['Delivery Time', 'Delivery Place', 'Consignee Details'];
      
      let tenderAuthorConfig = {
        serviceDescriptions: [], // [{ name, description, applyTo, targetId, isMandatory }]
        deliveryConfig: {
          deliveryTime: '',
          deliveryPlace: '',
          allowedIncoterms: [],
          consigneeDetails: '',
        },
        specificRequirements: [
          { name: 'Delivery Time', description: '', applyTo: 'all', targetId: '', isPredefined: true, isMandatory: true },
          { name: 'Delivery Place', description: '', applyTo: 'all', targetId: '', isPredefined: true, isMandatory: true },
          { name: 'Consignee Details', description: '', applyTo: 'all', targetId: '', isPredefined: true, isMandatory: true }
        ], // [{ name, description, applyTo: 'all'|'lot'|'product', targetId, isMandatory }]
      };
      
      function renderTenderAuthorConfigSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Configure tender-specific requirements that will be used to structure supplier responses
                </div>
              </div>
              
              <!-- 1. Service Descriptions -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0;">1. Service Descriptions</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addServiceLine()">+ Add Service Line</button>
                </div>
                <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: 12px 16px; margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 18px;">üí∞</span>
                  <div>
                    <strong style="color: var(--success-700); font-size: 13px;">Priced Items</strong>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--success-600);">Each line added here will be part of the financial bid. Suppliers will be required to provide a price for each service.</p>
                  </div>
                </div>
                <div id="service-lines-list" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${tenderAuthorConfig.serviceDescriptions.length === 0 ? `
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted); border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                      No service lines defined. Click "+ Add Service Line" to start.
                    </div>
                  ` : tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); background: var(--surface-50);">
                      <div style="display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: var(--spacing-md); align-items: start;">
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Service Name</label>
                          <input type="text" class="form-input" value="${service.name}" placeholder="e.g., Installation Services" style="font-size: 13px; padding: 8px;" onchange="updateServiceLine(${idx}, 'name', this.value)" />
                        </div>
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Description (Optional)</label>
                          <textarea class="form-textarea" placeholder="Service description" style="font-size: 13px; padding: 8px; min-height: 60px;" onchange="updateServiceLine(${idx}, 'description', this.value)">${service.description || ''}</textarea>
                        </div>
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Apply To</label>
                          <select class="form-select" onchange="updateServiceLineApplyTo(${idx}, this.value)" style="font-size: 13px; padding: 8px;">
                            <option value="all" ${service.applyTo === 'all' || !service.applyTo ? 'selected' : ''}>All Lots</option>
                            <option value="lot" ${service.applyTo === 'lot' ? 'selected' : ''}>Specific Lot</option>
                            <option value="product" ${service.applyTo === 'product' ? 'selected' : ''}>Specific Product</option>
                          </select>
                          ${service.applyTo === 'lot' ? `
                            <select class="form-select" onchange="updateServiceLine(${idx}, 'targetId', this.value)" style="font-size: 13px; padding: 8px; margin-top: 8px;">
                              <option value="">Select Lot...</option>
                              ${lots.map(lot => `<option value="${lot.id}" ${service.targetId === lot.id ? 'selected' : ''}>${lot.id} - ${lot.description || 'No description'}</option>`).join('')}
                            </select>
                          ` : ''}
                          ${service.applyTo === 'product' ? `
                            <select class="form-select" onchange="updateServiceLine(${idx}, 'targetId', this.value)" style="font-size: 13px; padding: 8px; margin-top: 8px;">
                              <option value="">Select Product...</option>
                              ${productsAndServices.map(prod => `<option value="${prod.id}" ${service.targetId === prod.id ? 'selected' : ''}>${prod.unspscCode} - ${prod.description || prod.unspscDescription}</option>`).join('')}
                            </select>
                          ` : ''}
                        </div>
                        <button class="btn-icon-sm" onclick="removeServiceLine(${idx})" style="margin-top: 24px;">‚úñ</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- 2. Delivery and Specific Requirements -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0;">2. Delivery and Specific Requirements</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addSpecificRequirement()">+ Add Requirement</button>
                </div>
                <div style="background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm); padding: 12px 16px; margin-bottom: var(--spacing-lg); display: flex; align-items: center; gap: 10px;">
                  <span style="font-size: 18px;">‚ÑπÔ∏è</span>
                  <div>
                    <strong style="color: var(--info-700); font-size: 13px;">Not Priced</strong>
                    <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--info-600);">Delivery and specific requirements are informational conditions and do not require suppliers to provide a separate price.</p>
                  </div>
                </div>
                ${tenderAuthorConfig.specificRequirements.length === 0 ? `
                  <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted); border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                    No requirements defined. Click "+ Add Requirement" to start.
                  </div>
                ` : `
                  <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                    ${tenderAuthorConfig.specificRequirements.map((req, idx) => `
                      <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); background: var(--surface-50);">
                        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr auto; gap: var(--spacing-md); align-items: start;">
                          <div class="form-group" style="margin: 0;">
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Requirement Name</label>
                            ${req.isPredefined ? `
                              <input type="text" class="form-input" value="${req.name}" readonly disabled style="font-size: 13px; padding: 8px; background: var(--surface-100); color: var(--text-secondary); cursor: not-allowed;" title="Predefined field - cannot be renamed" />
                            ` : `
                              <select class="form-select" onchange="handleRequirementNameChange(${idx}, this.value)" style="font-size: 13px; padding: 8px; margin-bottom: 8px;">
                                <option value="">Select type...</option>
                                ${PREDEFINED_REQUIREMENT_NAMES.map(name => '<option value="' + name + '"' + (req.name === name ? ' selected' : '') + '>' + name + '</option>').join('')}
                                <option value="__custom__" ${req.isCustom || (req.name && !PREDEFINED_REQUIREMENT_NAMES.includes(req.name)) ? 'selected' : ''}>Custom...</option>
                              </select>
                              ${req.isCustom || (req.name && !PREDEFINED_REQUIREMENT_NAMES.includes(req.name)) ? '<input type="text" class="form-input" value="' + req.name + '" placeholder="Enter custom name" onchange="updateSpecificRequirement(' + idx + ', \'name\', this.value)" style="font-size: 13px; padding: 8px;" />' : ''}
                            `}
                          </div>
                          <div class="form-group" style="margin: 0;">
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Description (Optional)</label>
                            <textarea class="form-textarea" placeholder="Requirement description" style="font-size: 13px; padding: 8px; min-height: 60px;" onchange="updateSpecificRequirement(${idx}, 'description', this.value)">${req.description || ''}</textarea>
                          </div>
                          <div class="form-group" style="margin: 0;">
                            <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Apply To</label>
                            <select class="form-select" onchange="updateSpecificRequirementApplyTo(${idx}, this.value)" style="font-size: 13px; padding: 8px;">
                              <option value="all" ${req.applyTo === 'all' || !req.applyTo ? 'selected' : ''}>All Lots</option>
                              <option value="lot" ${req.applyTo === 'lot' ? 'selected' : ''}>Specific Lot</option>
                              <option value="product" ${req.applyTo === 'product' ? 'selected' : ''}>Specific Product</option>
                            </select>
                            ${req.applyTo === 'lot' ? `
                              <select class="form-select" onchange="updateSpecificRequirement(${idx}, 'targetId', this.value)" style="font-size: 13px; padding: 8px; margin-top: 8px;">
                                <option value="">Select Lot...</option>
                                ${lots.map(lot => `<option value="${lot.id}" ${req.targetId === lot.id ? 'selected' : ''}>${lot.id} - ${lot.description || 'No description'}</option>`).join('')}
                              </select>
                            ` : ''}
                            ${req.applyTo === 'product' ? `
                              <select class="form-select" onchange="updateSpecificRequirement(${idx}, 'targetId', this.value)" style="font-size: 13px; padding: 8px; margin-top: 8px;">
                                <option value="">Select Product...</option>
                                ${productsAndServices.map(prod => `<option value="${prod.id}" ${req.targetId === prod.id ? 'selected' : ''}>${prod.unspscCode} - ${prod.description || prod.unspscDescription}</option>`).join('')}
                              </select>
                            ` : ''}
                          </div>
                          <button class="btn-icon-sm" onclick="removeSpecificRequirement(${idx})" style="margin-top: 24px;">‚úñ</button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }
      
      // Helper functions for Tender Author Config
      window.addServiceLine = function() {
        tenderAuthorConfig.serviceDescriptions.push({
          name: '',
          description: '',
          applyTo: 'all', // 'all', 'lot', or 'product'
          targetId: '', // ID of specific lot or product if applyTo is not 'all'
          isMandatory: true, // Default to mandatory
        });
        renderCurrentBlock();
      }
      
      window.updateServiceLine = function(idx, field, value) {
        if (tenderAuthorConfig.serviceDescriptions[idx]) {
          tenderAuthorConfig.serviceDescriptions[idx][field] = value;
        }
      }
      
      window.updateServiceLineApplyTo = function(idx, value) {
        if (tenderAuthorConfig.serviceDescriptions[idx]) {
          tenderAuthorConfig.serviceDescriptions[idx].applyTo = value;
          // No need to re-render as dropdown selection is immediate
        }
      }
      
      window.removeServiceLine = function(idx) {
        tenderAuthorConfig.serviceDescriptions.splice(idx, 1);
        renderCurrentBlock();
      }
      
      // Toggle mandatory status for service line
      window.toggleServiceLineMandatory = function(idx) {
        if (tenderAuthorConfig.serviceDescriptions[idx]) {
          const current = tenderAuthorConfig.serviceDescriptions[idx].isMandatory;
          tenderAuthorConfig.serviceDescriptions[idx].isMandatory = current === false ? true : !current;
          renderCurrentBlock();
        }
      }
      
      // ===== SPECIFIC REQUIREMENTS MANAGEMENT =====
      window.addSpecificRequirement = function() {
        tenderAuthorConfig.specificRequirements.push({
          name: '',
          description: '',
          applyTo: 'all', // 'all', 'lot', or 'product'
          targetId: '',
          isPredefined: false,
          isMandatory: true, // Default to mandatory
        });
        renderCurrentBlock();
      }
      
      // Handle requirement name selection from dropdown
      window.handleRequirementNameChange = function(idx, value) {
        if (tenderAuthorConfig.specificRequirements[idx]) {
          if (value === '__custom__') {
            // User wants to enter a custom name
            tenderAuthorConfig.specificRequirements[idx].name = '';
            tenderAuthorConfig.specificRequirements[idx].isCustom = true;
          } else {
            // User selected a predefined name
            tenderAuthorConfig.specificRequirements[idx].name = value;
            tenderAuthorConfig.specificRequirements[idx].isCustom = false;
          }
          renderCurrentBlock();
        }
      }
      
      window.updateSpecificRequirement = function(idx, field, value) {
        if (tenderAuthorConfig.specificRequirements[idx]) {
          tenderAuthorConfig.specificRequirements[idx][field] = value;
        }
      }
      
      window.updateSpecificRequirementApplyTo = function(idx, value) {
        if (tenderAuthorConfig.specificRequirements[idx]) {
          tenderAuthorConfig.specificRequirements[idx].applyTo = value;
          // No need to re-render as dropdown selection is immediate
        }
      }
      
      window.removeSpecificRequirement = function(idx) {
        tenderAuthorConfig.specificRequirements.splice(idx, 1);
        renderCurrentBlock();
      }
      
      // Toggle mandatory status for specific requirement
      window.toggleSpecificRequirementMandatory = function(idx) {
        if (tenderAuthorConfig.specificRequirements[idx]) {
          const current = tenderAuthorConfig.specificRequirements[idx].isMandatory;
          tenderAuthorConfig.specificRequirements[idx].isMandatory = current === false ? true : !current;
          renderCurrentBlock();
        }
      }
      
      window.updateAllowedIncoterms = function(selectElement) {
        const selectedOptions = Array.from(selectElement.selectedOptions).map(option => option.value);
        tenderAuthorConfig.deliveryConfig.allowedIncoterms = selectedOptions;
      }
      
      // ===== SUPPLIER FORM PREVIEW SECTION =====
      function renderSupplierFormPreviewSection(block, section, sectionIndex, isFirst) {
        // Check if preview should be visible
        if (!isSupplierFormPreviewVisible) {
          return '';
        }
        
        // Get all UNSPSC codes based on partial quotations selection
        let unspscCodesToShow = [];
        
        if (allowPartialQuotations === 'Yes') {
          // YES: Show products from Lots
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                lotDescription: lot.description,
              });
            });
          });
        } else if (allowPartialQuotations === 'No') {
          // NO: Show products from Products and Services
          unspscCodesToShow = productsAndServices.map(item => ({
            code: item.unspscCode,
            description: item.unspscDescription,
          }));
        }
        // If not selected yet, show nothing
        
        // Remove duplicates
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg); background: var(--info-100); border-color: var(--info-400);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è <strong>Preview:</strong> This shows how the supplier form will appear with the configured requirements. Fields below are pre-populated from your tender configuration.
                </div>
              </div>
              
              <!-- A. Per Bid Responses -->
              <div style="background: var(--surface-0); border: 1px solid var(--primary-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--primary-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                  <span style="background: var(--primary-100); color: var(--primary-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">A</span>
                  Per Bid (answered once)
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Bidder's Total Prices [Incoterm]</label>
                    <input type="number" class="form-input" placeholder="Enter total price" disabled />
                    <span class="help-text">Supplier will enter their total price here</span>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Customs clearance costs</label>
                    <input type="number" class="form-input" placeholder="Enter customs costs" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Freight cost</label>
                    <input type="number" class="form-input" placeholder="Enter freight cost" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Price of Goods [Incoterm]</label>
                    <input type="number" class="form-input" placeholder="Calculated automatically" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Price of Related Services</label>
                    <input type="number" class="form-input" placeholder="Enter services price" disabled />
                  </div>
                </div>
              </div>
              
              <!-- B. Per UNSPSC Responses -->
              ${uniqueUnspscCodes.length > 0 ? uniqueUnspscCodes.map((unspsc, idx) => {
                const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                return `
                  <div style="background: var(--surface-0); border: 1px solid var(--info-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--info-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                      <span style="background: var(--info-100); color: var(--info-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">B${idx + 1}</span>
                      Per UNSPSC: ${unspsc.code}
                    </h3>
                    <div style="background: var(--surface-50); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-lg);">
                      <strong style="font-size: 14px;">${unspsc.description}</strong>
                      ${unspsc.lotDescription ? `<span style="font-size: 13px; color: var(--text-muted); display: block; margin-top: 4px;">Lot: ${unspsc.lotDescription}</span>` : ''}
                    </div>
                    
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Unit price Incoterm</label>
                        <input type="number" class="form-input" placeholder="Enter unit price" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Total price Incoterm</label>
                        <input type="number" class="form-input" placeholder="Calculated" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Country of Origin</label>
                        <select class="form-select" disabled>
                          <option>Select country...</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label">Delivery point(s)</label>
                        <input type="text" class="form-input" placeholder="Enter delivery points" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-input" placeholder="Enter model" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-input" placeholder="Enter manufacturer" disabled />
                      </div>
                    </div>
                    
                    <!-- C. Per Attribute (for this UNSPSC) -->
                    ${req.requirementType === 'attributes' && req.attributes.length > 0 ? `
                      <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--success-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                          <span style="background: var(--success-100); color: var(--success-600); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700;">C</span>
                          Product Attributes
                        </h4>
                        ${req.attributes.map(attr => `
                          <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <strong style="font-size: 14px; display: block; margin-bottom: 8px; color: var(--success-700);">${attr.name}: ${attr.value}</strong>
                            <div class="form-grid">
                              <div class="form-group" style="margin: 0;">
                                <label class="form-label">Is quotation compliant?</label>
                                <div style="display: flex; gap: var(--spacing-md);">
                                  <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="compliant-${unspsc.code}-${attr.name}" disabled />
                                    <span style="font-size: 14px;">Yes</span>
                                  </label>
                                  <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="compliant-${unspsc.code}-${attr.name}" disabled />
                                    <span style="font-size: 14px;">No</span>
                                  </label>
                                </div>
                              </div>
                              <div class="form-group" style="margin: 0;">
                                <label class="form-label">Details of goods offered</label>
                                <textarea class="form-textarea" placeholder="Supplier will describe their offering" style="min-height: 60px;" disabled></textarea>
                              </div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    ` : req.requirementType === 'description' && req.description ? `
                      <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--success-600);">Product Requirements (Description)</h4>
                        <div style="background: var(--surface-0); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); white-space: pre-wrap; font-size: 14px; line-height: 1.5;">
                          ${req.description}
                        </div>
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-desc-${unspsc.code}" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-desc-${unspsc.code}" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="form-label">Details of goods offered</label>
                          <textarea class="form-textarea" placeholder="Supplier will describe their offering" style="min-height: 80px;" disabled></textarea>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') : '<div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">No UNSPSC codes defined. Add requisition lines or lots to see UNSPSC-level fields.</div>'}
              
              <!-- D. Per Service Line -->
              ${tenderAuthorConfig.serviceDescriptions.length > 0 ? `
                <div style="background: var(--surface-0); border: 1px solid var(--warning-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                  <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--warning-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="background: var(--warning-100); color: var(--warning-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">D</span>
                    Per Service Line
                  </h3>
                  ${tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0;">${service.name || `Service ${idx + 1}`}</h4>
                      ${service.description ? `<p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">${service.description}</p>` : ''}
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-service-${idx}" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-service-${idx}" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide service details" style="min-height: 80px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <!-- E. Delivery Requirements -->
              ${tenderAuthorConfig.deliveryConfig.deliveryTime || tenderAuthorConfig.deliveryConfig.deliveryPlace || (tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.length > 0) || tenderAuthorConfig.deliveryConfig.consigneeDetails ? `
                <div style="background: var(--surface-0); border: 1px solid var(--danger-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                  <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--danger-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="background: var(--danger-100); color: var(--danger-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">E</span>
                    Delivery Requirements
                  </h3>
                  ${tenderAuthorConfig.deliveryConfig.deliveryTime ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">Delivery Time</h4>
                      <p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Required: ${tenderAuthorConfig.deliveryConfig.deliveryTime}</p>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-time" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-time" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide delivery time details" style="min-height: 60px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                  ${tenderAuthorConfig.deliveryConfig.deliveryPlace ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">Delivery Place</h4>
                      <p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Required: ${tenderAuthorConfig.deliveryConfig.deliveryPlace}</p>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-place" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-place" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide delivery place details" style="min-height: 60px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      // ===== FORM CATEGORY CONTAINER RENDERER (Approach 1) =====
      function renderFormCategoryContainer(form) {
        if (!form) return '';
        
        const templateEnabled = formCategoryTemplateEnabled[form.id] !== false;
        const libraryForms = formCategoryLibraryForms[form.id] || [];
        const hasLibraryForms = libraryForms.length > 0;
        const hasTemplate = form.templateName !== null;
        const hasNoForms = !templateEnabled && !hasLibraryForms && hasTemplate;
        const hasNoFormsAtAll = !hasLibraryForms && !hasTemplate;
        
        // Get PrimeIcon for form type
        const formPiIcon = getFormPiIcon(form.id);
        
        // Get additional templates if any
        const additionalTemplates = form.additionalTemplates || [];
        
        return `
          <div class="form-category-container ${hasNoForms || hasNoFormsAtAll ? 'empty' : ''}" 
               id="form-category-${form.id}"
               ondragover="handleCategoryDragOver(event, '${form.id}')"
               ondragleave="handleCategoryDragLeave(event, '${form.id}')"
               ondrop="handleCategoryDrop(event, '${form.id}')">
            
            <!-- Category Header -->
            <div class="form-category-header">
              <div class="form-category-header-left">
                <div class="form-category-icon"><i class="pi ${formPiIcon}"></i></div>
                <div class="form-category-title-group">
                  <h4 class="form-category-title">${form.name}</h4>
                  <span class="form-category-subtitle">${form.description}</span>
                </div>
              </div>
            </div>
            
            <!-- Category Body -->
            <div class="form-category-body">
              
              ${hasTemplate ? `
                <!-- Predefined Template -->
                <div class="form-category-item predefined ${templateEnabled ? 'enabled' : 'disabled'}">
                  <div class="form-category-item-left">
                    <div class="form-category-item-toggle ${templateEnabled ? 'on' : ''}" 
                         onclick="toggleFormCategoryTemplate('${form.id}')"
                         title="${templateEnabled ? 'Disable' : 'Enable'}">
                    </div>
                    <div class="form-category-item-icon"><i class="pi pi-file"></i></div>
                    <div class="form-category-item-info">
                      <span class="form-category-item-name">${form.templateName}</span>
                      <span class="form-category-item-meta">Predefined template</span>
                    </div>
                  </div>
                  <div class="form-category-item-actions">
                    ${templateEnabled ? `
                      <button class="btn-icon-xs" onclick="event.stopPropagation();" title="Preview">
                        <i class="pi pi-eye"></i>
                      </button>
                      ${form.hasConfig ? `
                        <button class="btn-icon-xs" onclick="${form.id === 'form-c' ? `window.open('financial-bid-form-builder-mockup.html', '_blank')` : `event.stopPropagation();`}" title="Configure">
                          <i class="pi pi-cog"></i>
                        </button>
                      ` : ''}
                    ` : ''}
                  </div>
                </div>
                
                ${additionalTemplates.map(tmplName => `
                  <div class="form-category-item predefined enabled">
                    <div class="form-category-item-left">
                      <div class="form-category-item-toggle on" style="pointer-events: none;" title="Required"></div>
                      <div class="form-category-item-icon"><i class="pi pi-file"></i></div>
                      <div class="form-category-item-info">
                        <span class="form-category-item-name">${tmplName}</span>
                        <span class="form-category-item-meta">Predefined template</span>
                      </div>
                    </div>
                    <div class="form-category-item-actions">
                      <button class="btn-icon-xs" onclick="event.stopPropagation();" title="Preview">
                        <i class="pi pi-eye"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              ` : ''}
              
              <!-- Library Forms -->
              ${libraryForms.map((libForm, index) => `
                <div class="form-category-item library" data-library-form-index="${index}">
                  <div class="form-category-item-left">
                    <div class="form-category-item-icon"><i class="pi pi-file-edit"></i></div>
                    <div class="form-category-item-info">
                      <span class="form-category-item-name">${libForm.name}</span>
                      <span class="form-category-item-meta">From library</span>
                    </div>
                  </div>
                  <div class="form-category-item-actions">
                    <button class="btn-icon-xs" onclick="event.stopPropagation();" title="Preview">
                      <i class="pi pi-eye"></i>
                    </button>
                    <button class="btn-icon-xs danger" onclick="removeLibraryFormFromCategory('${form.id}', ${index})" title="Remove">
                      <i class="pi pi-times"></i>
                    </button>
                  </div>
                </div>
              `).join('')}
              
              <!-- Drop Zone for adding more forms -->
              <div class="form-category-dropzone" 
                   id="dropzone-${form.id}"
                   onclick="openFormLibraryForCategory('${form.id}')">
                <div class="form-category-dropzone-icon">
                  <i class="pi pi-plus"></i>
                </div>
                <div class="form-category-dropzone-text">Add from library</div>
              </div>
              
              <!-- Warning if no forms at all -->
              ${hasNoForms ? `
                <div class="form-category-empty-warning">
                  <i class="pi pi-exclamation-triangle"></i>
                  <span>No forms - enable template or add from library</span>
                </div>
              ` : ''}
              ${hasNoFormsAtAll && !hasLibraryForms ? `
                <div class="form-category-empty-warning">
                  <i class="pi pi-info-circle"></i>
                  <span>No forms added yet</span>
                </div>
              ` : ''}
              
            </div>
          </div>
        `;
      }
      
      // Get PrimeIcon class for form type
      function getFormPiIcon(formId) {
        const iconMap = {
          'form-c': 'pi-dollar',
          'form-d': 'pi-cog',
          'form-a': 'pi-user',
          'form-qual': 'pi-verified',
          'form-compliance': 'pi-check-circle',
          'form-other': 'pi-folder'
        };
        return iconMap[formId] || 'pi-file';
      }
      
      // Toggle template enabled/disabled for a category
      function toggleFormCategoryTemplate(formId) {
        formCategoryTemplateEnabled[formId] = !formCategoryTemplateEnabled[formId];
        renderCurrentBlock();
        showToast(formCategoryTemplateEnabled[formId] ? 'Template enabled' : 'Template disabled', 'info');
      }
      
      // Add a library form to a category
      function addLibraryFormToCategory(formId, libraryForm) {
        if (!formCategoryLibraryForms[formId]) {
          formCategoryLibraryForms[formId] = [];
        }
        
        // Add with metadata
        formCategoryLibraryForms[formId].push({
          ...libraryForm,
          addedDate: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
        });
        
        renderCurrentBlock();
        showToast(`"${libraryForm.name}" added to ${getFormCategoryName(formId)}`, 'success');
      }
      
      // Remove a library form from a category
      function removeLibraryFormFromCategory(formId, index) {
        if (formCategoryLibraryForms[formId] && formCategoryLibraryForms[formId][index]) {
          const removedForm = formCategoryLibraryForms[formId][index];
          formCategoryLibraryForms[formId].splice(index, 1);
          renderCurrentBlock();
          showToast(`"${removedForm.name}" removed`, 'info');
        }
      }
      
      // Get form category name by ID
      function getFormCategoryName(formId) {
        const form = submissionForms.find(f => f.id === formId);
        return form ? form.name : 'Unknown';
      }
      
      // Preview a library form
      function previewLibraryForm(formId, index) {
        const libForm = formCategoryLibraryForms[formId]?.[index];
        if (libForm) {
          showToast(`Previewing: ${libForm.name}`, 'info');
          // In a real app, this would open a preview modal
        }
      }
      
      // Open form library panel focused on a specific category
      function openFormLibraryForCategory(formId) {
        // Store the target category for when a form is dropped/selected
        window.currentTargetFormCategory = formId;
        
        // Open the form library panel
        const panel = document.getElementById('form-library-panel');
        if (panel && !panel.classList.contains('open')) {
          panel.classList.add('open');
          panel.classList.remove('collapsed');
        }
        
        showToast(`Select a form to add to ${getFormCategoryName(formId)}`, 'info');
      }
      
      // Handle drag over for category container
      function handleCategoryDragOver(event, formId) {
        event.preventDefault();
        event.stopPropagation();
        
        const container = document.getElementById(`form-category-${formId}`);
        const dropzone = document.getElementById(`dropzone-${formId}`);
        
        if (container) container.classList.add('drag-over');
        if (dropzone) dropzone.classList.add('drag-over');
      }
      
      // Handle drag leave for category container
      function handleCategoryDragLeave(event, formId) {
        event.preventDefault();
        event.stopPropagation();
        
        // Only remove if we're actually leaving the container
        const container = document.getElementById(`form-category-${formId}`);
        const dropzone = document.getElementById(`dropzone-${formId}`);
        
        // Check if we're leaving to an element outside the container
        const relatedTarget = event.relatedTarget;
        if (container && !container.contains(relatedTarget)) {
          container.classList.remove('drag-over');
        }
        if (dropzone && !dropzone.contains(relatedTarget)) {
          dropzone.classList.remove('drag-over');
        }
      }
      
      // Handle drop for category container
      function handleCategoryDrop(event, formId) {
        event.preventDefault();
        event.stopPropagation();
        
        const container = document.getElementById(`form-category-${formId}`);
        const dropzone = document.getElementById(`dropzone-${formId}`);
        
        if (container) container.classList.remove('drag-over');
        if (dropzone) dropzone.classList.remove('drag-over');
        
        // Get the dragged form data
        const formType = event.dataTransfer.getData('text/form-type');
        const formName = event.dataTransfer.getData('text/form-name');
        
        if (formType && formName) {
          // Add the library form to this category
          addLibraryFormToCategory(formId, {
            type: formType,
            name: formName,
            icon: getFormIconByType(formType)
          });
        }
      }
      
      // Get icon for a form type
      function getFormIconByType(formType) {
        const iconMap = {
          'instructions': 'üìÑ',
          'contracts': 'üìù',
          'bank-guarantee': 'üè¶',
          'bid-security': 'üîí',
          'drive-questionnaire': 'üìä',
          'technical-specs': '‚öôÔ∏è',
          'evaluation': '‚úÖ',
          'price-schedule': 'üí∞'
        };
        return iconMap[formType] || 'üìÑ';
      }

      // ===== BID RESPONSE REQUIREMENTS SECTION =====
      function renderSupplierResponseStructureSection(block, section, sectionIndex, isFirst) {
        const addedFormsCount = submissionForms.filter(f => f.added).length;
        const requiredFormsCount = submissionForms.filter(f => f.required).length;
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              <!-- Required Forms Section - Collapsible -->
              <div class="collapsible-section" id="submission-forms-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('submission-forms-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Forms</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <!-- All Forms as Category Containers -->
                  <div class="form-category-grid">
                    ${submissionForms.map(form => renderFormCategoryContainer(form)).join('')}
                  </div>
                </div>
              </div>
              
              <!-- Documents Section - Collapsible -->
              <div class="collapsible-section collapsed" id="documents-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('documents-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title"><i class="pi pi-folder" style="margin-right: 8px;"></i> Documents</span>
                    <span class="section-progress-badge" style="margin-left: 8px; font-size: 11px; background: var(--info-50); color: var(--info-600); padding: 2px 8px; border-radius: 10px;">${tenderDocuments.length} document${tenderDocuments.length !== 1 ? 's' : ''}</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                    <div class="info-alert-text">
                      <i class="pi pi-info-circle" style="margin-right: 6px;"></i> Upload tender documents, forms, and attachments. Drag and drop files or use the buttons below.
                    </div>
                  </div>
                  
                  <!-- Drag and Drop Zone -->
                  <div 
                    id="documents-drop-zone" 
                    class="documents-drop-zone"
                    ondrop="handleDocumentDrop(event)" 
                    ondragover="handleDocumentDragOver(event)" 
                    ondragleave="handleDocumentDragLeave(event)"
                    onclick="document.getElementById('documents-file-input').click()"
                    style="border: 2px dashed var(--surface-300); border-radius: var(--radius-lg); padding: var(--spacing-xl); background: var(--surface-50); text-align: center; cursor: pointer; transition: all 0.2s ease; margin-bottom: var(--spacing-lg);"
                  >
                    <div style="color: var(--primary-500); font-size: 3em; margin-bottom: var(--spacing-md);"><i class="pi pi-cloud-upload"></i></div>
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px; font-size: 1.1em;">Drag & Drop Documents Here</div>
                    <div style="color: var(--text-muted); font-size: 13px; margin-bottom: var(--spacing-md);">or click to browse files</div>
                    <div style="display: flex; gap: var(--spacing-sm); justify-content: center; flex-wrap: wrap;">
                      <span style="background: var(--surface-200); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: var(--text-secondary);">PDF</span>
                      <span style="background: var(--surface-200); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: var(--text-secondary);">DOC/DOCX</span>
                      <span style="background: var(--surface-200); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: var(--text-secondary);">XLS/XLSX</span>
                      <span style="background: var(--surface-200); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: var(--text-secondary);">Images</span>
                  </div>
                    <input type="file" id="documents-file-input" multiple style="display: none;" onchange="handleDocumentFileSelect(event)" />
                  </div>
                  
                  <!-- Action Buttons -->
                  <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); document.getElementById('documents-file-input').click()">
                      <i class="pi pi-paperclip" style="margin-right: 6px;"></i> Add Attachment
                    </button>
                    <button class="btn btn-secondary" onclick="event.stopPropagation(); openAddFormDocumentModal()">
                      <i class="pi pi-file-edit" style="margin-right: 6px;"></i> Add Form Template
                    </button>
                  </div>
                  
                  <!-- Documents List -->
                  <div id="documents-list">
                    ${tenderDocuments.length > 0 ? `
                      <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                        ${tenderDocuments.map((doc, index) => `
                          <div class="document-item" style="display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md); background: white; border: 1px solid var(--surface-200); border-radius: var(--radius-md); transition: all 0.2s ease;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); flex: 1;">
                              <div style="width: 42px; height: 42px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1.3em; ${doc.type === 'form' ? 'background: var(--primary-100); color: var(--primary-600);' : doc.fileType === 'pdf' ? 'background: var(--danger-100); color: var(--danger-600);' : doc.fileType === 'doc' || doc.fileType === 'docx' ? 'background: var(--info-100); color: var(--info-600);' : doc.fileType === 'xls' || doc.fileType === 'xlsx' ? 'background: var(--success-100); color: var(--success-600);' : 'background: var(--surface-200); color: var(--text-secondary);'}">
                                <i class="pi ${doc.type === 'form' ? 'pi-file-edit' : doc.fileType === 'pdf' ? 'pi-file-pdf' : doc.fileType === 'doc' || doc.fileType === 'docx' ? 'pi-file-word' : doc.fileType === 'xls' || doc.fileType === 'xlsx' ? 'pi-file-excel' : 'pi-file'}"></i>
                    </div>
                              <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">${doc.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: var(--spacing-sm);">
                                  <span>${doc.type === 'form' ? 'Form Template' : doc.fileType ? doc.fileType.toUpperCase() : 'File'}</span>
                                  ${doc.size ? `<span>‚Ä¢</span><span>${doc.size}</span>` : ''}
                                  ${doc.dateAdded ? `<span>‚Ä¢</span><span>Added ${doc.dateAdded}</span>` : ''}
                          </div>
                        </div>
                    </div>
                            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                              ${doc.required ? `<span style="background: var(--danger-100); color: var(--danger-600); padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 500;">Required</span>` : `<span style="background: var(--surface-200); color: var(--text-muted); padding: 3px 8px; border-radius: 10px; font-size: 11px;">Optional</span>`}
                              <button class="btn-icon-xs" onclick="event.stopPropagation(); toggleDocumentRequired(${index})" title="Toggle Required" style="color: var(--text-muted);">
                                <i class="pi pi-star${doc.required ? '-fill' : ''}"></i>
                              </button>
                              <button class="btn-icon-xs" onclick="event.stopPropagation(); previewDocument(${index})" title="Preview" style="color: var(--info-500);">
                                <i class="pi pi-eye"></i>
                              </button>
                              <button class="btn-icon-xs danger" onclick="event.stopPropagation(); removeDocument(${index})" title="Remove">
                                <i class="pi pi-trash"></i>
                              </button>
                  </div>
                        </div>
                      `).join('')}
                    </div>
                    ` : `
                      <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
                        <div style="font-size: 2.5em; margin-bottom: var(--spacing-md);"><i class="pi pi-inbox"></i></div>
                        <div style="font-weight: 600; margin-bottom: 4px;">No documents added yet</div>
                        <div style="font-size: 13px;">Upload files or add form templates to get started</div>
                  </div>
                    `}
                    </div>
                </div>
              </div>
              
            </div>
          </div>
        `;
      }

      // ===== AUTHORING FUNCTIONS =====
      function initAuthoring() {
        // requisitionLines starts empty - user adds items via modal
        renderBlockTabs();
        renderCurrentBlock();
        updateProgressSteps();
        updateNavigationButtons();
        setupFormLibrary();
        // Setup drop zones after a short delay to ensure DOM is ready
        setTimeout(() => {
          setupDropZones();
        }, 100);
      }

      function renderBlockTabs() {
        const nav = document.getElementById('block-nav');
        nav.innerHTML = '';

        templateBlocks.forEach((block, index) => {
          const tab = document.createElement('button');
          tab.className = 'block-tab';
          if (index === currentBlockIndex) {
            tab.classList.add('active');
          }
          
          // Calculate a mock progress for visual demo (in real app, this would be based on actual completion)
          const progress = index < currentBlockIndex ? 100 : (index === currentBlockIndex ? 30 : 0);
          const isCompleted = index < currentBlockIndex;
          
          if (isCompleted) {
            tab.classList.add('completed');
          }
          
          // Generate progress status text
          let progressStatus = '';
          let progressClass = '';
          let statusIcon = '';
          if (progress === 100) {
            progressStatus = 'Complete';
            progressClass = 'status-complete';
            statusIcon = '‚úì';
          } else if (progress > 0) {
            progressStatus = 'In progress';
            progressClass = 'status-in-progress';
            statusIcon = '‚óè';
          } else {
            progressStatus = 'Not started';
            progressClass = 'status-pending';
            statusIcon = '‚óã';
          }
          
          // Show checkmark in number circle if completed
          const numberContent = isCompleted ? '‚úì' : (index + 1);
          
          // Get the PrimeIcon class or fallback to emoji
          const iconClass = block.piIcon || '';
          
          tab.innerHTML = `
            <span class="block-tab-number">${numberContent}</span>
            ${iconClass ? `<i class="block-tab-pi-icon pi ${iconClass}"></i>` : ''}
            <span class="block-tab-icon">${block.icon}</span>
            <span class="block-tab-content">
              <span class="block-tab-name">${block.name}</span>
              <span class="block-tab-status ${progressClass}">${statusIcon} ${progressStatus}</span>
            </span>
            <span class="block-tab-badge">${index + 1}</span>
            <div class="block-tab-progress">
              <div class="block-tab-progress-bar" style="width: ${progress}%"></div>
            </div>
          `;
          tab.addEventListener('click', () => {
            switchToBlock(index);
          });
          nav.appendChild(tab);
        });
      }

      function switchToBlock(index) {
        currentBlockIndex = index;
        renderBlockTabs();
        renderCurrentBlock();
        updateNavigationButtons();
      }

      function renderEvaluationCriteriaSection(block, section, sectionIndex, isFirst) {
        // Get available UNSPSC codes
        const availableUnspscCodes = getAvailableUnspscCodes();
        
        // Separate predefined and custom criteria
        const predefinedCriteria = evaluationCriteria.filter(c => c.isPredefined);
        const customCriteria = evaluationCriteria.filter(c => !c.isPredefined);
        const allCriteria = evaluationCriteria;
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <!-- Header with Add Button -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                  <span style="font-size: 13px; color: var(--text-secondary);">
                    <strong>${allCriteria.length}</strong> criteria total 
                    <span style="color: var(--text-muted);">(${predefinedCriteria.length} predefined, ${customCriteria.length} custom)</span>
                  </span>
                </div>
                <div class="criterion-add-dropdown" id="criterion-add-dropdown-1">
                  <button class="btn btn-primary btn-sm dropdown-toggle" onclick="toggleCriterionAddDropdown('criterion-add-dropdown-1')">
                    <i class="pi pi-plus"></i> Add Criterion <i class="pi pi-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
                  </button>
                  <div class="dropdown-menu">
                    <button class="dropdown-item" onclick="openEvaluationCriterionModal(); closeCriterionAddDropdowns();">
                      <i class="pi pi-plus-circle"></i> Create New
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="openCriteriaLibraryModal(); closeCriterionAddDropdowns();">
                      <i class="pi pi-book"></i> Browse Library
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Evaluation Criteria - Grouped by Category (Section 1) -->
              ${renderGroupedEvaluationCriteria(allCriteria, 'sec1')}
              
              <!-- SP Waiver Section - Shows when too few SP criteria -->
              ${renderSPWaiverSection()}
              
              <div style="font-size: 11px; color: var(--text-muted); margin-top: var(--spacing-sm); display: flex; align-items: center; gap: 6px;">
                <i class="pi pi-info-circle"></i> 
                Click on category headers to expand/collapse. Configure criteria with evaluation methods, SP categories, and link to forms.
            </div>
          </div>
        `;
      }

      function renderEvaluationBlock(block) {
        // Get available UNSPSC codes for criteria section
        const availableUnspscCodes = getAvailableUnspscCodes();
        
        // Find the Evaluation Method section fields
        const methodSection = block.sections.find(s => s.title === 'Evaluation Method');
        const methodFields = methodSection ? methodSection.fields : [];
        
        return `
          <div class="general-info-container">
            <div class="general-info-body">
              <!-- Evaluation Method Section - Collapsible -->
              <div class="collapsible-section collapsed" id="evaluation-method-section">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('evaluation-method-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Evaluation Method</span>
                    ${renderSectionProgress('evaluation-method', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid">
                    ${methodFields.map((field) => {
                      // Check conditional visibility
                      if (!shouldShowField(field)) {
                        return '';
                      }
                      
                      let fieldHtml = '';
                      const onchangeAttr = field.onchange ? `onchange="${field.onchange}(this.value)"` : '';
                      
                      if (field.type === 'textarea') {
                        // Special handling for evaluation method details - pre-fill based on solicitation type
                        let textareaValue = field.value || '';
                        let textareaOnchange = '';
                        if (field.isEvaluationMethodDetails) {
                          textareaValue = evaluationBlockValues.evaluationMethodDetails || getDefaultEvaluationMethodDetails();
                          textareaOnchange = 'oninput="evaluationBlockValues.evaluationMethodDetails = this.value"';
                        }
                        fieldHtml = `
                          <div class="form-group full-width">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <textarea class="form-textarea" ${field.readonly ? 'readonly' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" ${textareaOnchange} style="min-height: 150px;">${textareaValue}</textarea>
                            ${field.isEvaluationMethodDetails ? '<span class="help-text"><i class="pi pi-info-circle" style="margin-right: 4px;"></i>Pre-filled based on solicitation method. You can modify this text as needed.</span>' : ''}
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      } else if (field.type === 'select') {
                        // Get the current value from evaluationBlockValues if available
                        const currentValue = evaluationBlockValues[field.id] || '';
                        const options = field.options.map(opt => {
                          const optValue = opt === 'Select...' ? '' : opt;
                          const isSelected = currentValue === optValue ? 'selected' : '';
                          return '<option value="' + optValue + '" ' + isSelected + '>' + opt + '</option>';
                        }).join('');
                        fieldHtml = `
                          <div class="form-group ${field.multiple ? 'full-width' : ''}">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <select class="form-select" ${field.multiple ? 'multiple size="5"' : ''} ${field.required ? 'required' : ''} ${field.readonly ? 'disabled' : ''} ${onchangeAttr} onclick="event.stopPropagation()">
                              ${options}
                            </select>
                            ${field.multiple ? '<span class="help-text">Hold Ctrl/Cmd to select multiple</span>' : ''}
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      } else if (field.type === 'number') {
                        // Get current value from evaluationBlockValues if applicable
                        let numberValue = field.value || '';
                        let numberOninput = '';
                        if (field.id === 'maxPointsTechnical') {
                          numberValue = evaluationBlockValues.maxPointsTechnical || '';
                          numberOninput = 'oninput="updateMaxPointsTechnical(this.value)"';
                        } else if (field.id === 'minPoints') {
                          numberOninput = ''; // Regular field
                        }
                        fieldHtml = `
                          <div class="form-group">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <input type="number" class="form-input" value="${numberValue}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} ${numberOninput} />
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      } else {
                        fieldHtml = `
                          <div class="form-group">
                            <label class="form-label">
                              ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                            </label>
                            <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                            ${field.help ? '<span class="help-text">' + field.help + '</span>' : ''}
                          </div>
                        `;
                      }
                      return fieldHtml;
                    }).join('')}
                  </div>
                </div>
              </div>
              
              <!-- Evaluation Criteria Section - Collapsible -->
              <div class="collapsible-section collapsed" id="evaluation-criteria-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('evaluation-criteria-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Evaluation Criteria</span>
                    <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">(${evaluationCriteria.length} criteria)</span>
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <!-- Header with summary and Add button -->
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                      <span style="font-size: 13px; color: var(--text-secondary);">
                        <strong>${evaluationCriteria.filter(c => c.isPredefined).length}</strong> predefined, 
                        <strong>${evaluationCriteria.filter(c => !c.isPredefined).length}</strong> custom
                      </span>
                    </div>
                    <div class="criterion-add-dropdown" id="criterion-add-dropdown-2">
                      <button class="btn btn-primary btn-sm dropdown-toggle" onclick="event.stopPropagation(); toggleCriterionAddDropdown('criterion-add-dropdown-2')">
                        <i class="pi pi-plus"></i> Add Criterion <i class="pi pi-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>
                      </button>
                      <div class="dropdown-menu">
                        <button class="dropdown-item" onclick="event.stopPropagation(); openEvaluationCriterionModal(); closeCriterionAddDropdowns();">
                          <i class="pi pi-plus-circle"></i> Create New
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item" onclick="event.stopPropagation(); openCriteriaLibraryModal(); closeCriterionAddDropdowns();">
                          <i class="pi pi-book"></i> Browse Library
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Evaluation Criteria - Grouped by Category -->
                  ${renderGroupedEvaluationCriteria(evaluationCriteria, 'sec2')}
                  
                  <!-- SP Waiver Section - Shows when too few SP criteria -->
                  ${renderSPWaiverSection()}
                  
                  <div style="font-size: 11px; color: var(--text-muted); margin-top: 12px; display: flex; align-items: center; gap: 6px;">
                    <i class="pi pi-info-circle"></i> 
                    Click on category headers to expand/collapse. Configure criteria with evaluation methods, SP categories, and link to forms.
                                  </div>
                                  </div>
                                  </div>
              
                                  </div>
          </div>
        `;
      }
      
      // Render SP Waiver Section
      function renderSPWaiverSection() {
        const spCount = countSPCriteria();
        const needsWaiver = spCount < MIN_SP_CRITERIA_REQUIRED;
        
        if (!needsWaiver) {
          // Show success message when SP criteria are sufficient
          return `
            <div style="margin-top: var(--spacing-md); padding: 12px 16px; background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px;">
              <i class="pi pi-check-circle" style="color: var(--success-600); font-size: 18px;"></i>
              <div>
                <div style="font-weight: 600; color: var(--success-700); font-size: 13px;">Sustainable Procurement Criteria Met</div>
                <div style="font-size: 12px; color: var(--success-600);">${spCount} criteria with SP categories configured</div>
                  </div>
            </div>
          `;
        }
        
        // Show waiver field when SP criteria are insufficient
        return `
          <div style="margin-top: var(--spacing-md); padding: 16px; background: var(--warning-50); border: 1px solid var(--warning-300); border-radius: var(--radius-md); border-left: 4px solid var(--warning-500);">
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
              <i class="pi pi-exclamation-triangle" style="color: var(--warning-600); font-size: 20px; margin-top: 2px;"></i>
              <div>
                <div style="font-weight: 600; color: var(--warning-700); font-size: 14px;">Sustainable Procurement Criteria Required</div>
                <div style="font-size: 12px; color: var(--warning-600); margin-top: 4px;">
                  This tender has <strong>${spCount}</strong> criteria with Sustainable Procurement categories. 
                  At least <strong>${MIN_SP_CRITERIA_REQUIRED}</strong> ${MIN_SP_CRITERIA_REQUIRED === 1 ? 'criterion is' : 'criteria are'} required.
                  </div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                  Either add SP categories to existing criteria or provide a waiver code below.
                </div>
              </div>
            </div>
            <div class="form-group" style="margin: 0;">
              <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--warning-700);">
                <i class="pi pi-key" style="margin-right: 6px;"></i>SP Criteria Waiver Code <span class="required">*</span>
              </label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input 
                  type="text" 
                  class="form-input" 
                  id="sp-waiver-code-input"
                  value="${evaluationBlockValues.spWaiverCode || ''}" 
                  placeholder="Enter SP waiver authorization code..." 
                  oninput="updateSPWaiverCode(this.value)"
                  style="flex: 1; border-color: var(--warning-400);"
                />
                <button class="btn btn-secondary btn-sm" onclick="validateSPWaiverCode()" title="Validate waiver code">
                  <i class="pi pi-check"></i> Validate
                </button>
              </div>
              <span class="help-text" style="font-size: 11px; color: var(--warning-600); margin-top: 6px;">
                <i class="pi pi-info-circle" style="margin-right: 4px;"></i>
                Contact your Procurement Authority to obtain an SP waiver code if sustainable procurement criteria cannot be included.
              </span>
            </div>
          </div>
        `;
      }
      
      // Validate SP Waiver Code (placeholder - in real app would validate against backend)
      window.validateSPWaiverCode = function() {
        const code = evaluationBlockValues.spWaiverCode;
        if (!code || code.trim() === '') {
          showNotification('Please enter a waiver code', 'error');
          return;
        }
        // In real implementation, this would validate against a backend service
        // For now, just show a simulated validation
        if (code.length >= 6) {
          showNotification('Waiver code validated successfully', 'success');
        } else {
          showNotification('Invalid waiver code format. Code must be at least 6 characters.', 'error');
        }
      }

      function renderParticularsSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="collapsible-section collapsed" id="particulars-section" style="margin-top: var(--spacing-md);">
            <div class="collapsible-header" onclick="toggleCollapsibleSection('particulars-section')">
              <div class="collapsible-header-left">
                <span class="collapsible-header-title">Particulars</span>
                ${renderSectionProgress('particulars', null)}
              </div>
              <div class="collapsible-toggle">‚ñº</div>
            </div>
            <div class="collapsible-body" onclick="event.stopPropagation()">
              <div class="form-grid-3col">
                <!-- Scope and objectives -->
                <div class="form-group full-width">
                  <label class="form-label">Scope and objectives of the sourcing or solicitation process</label>
                  <textarea class="form-textarea" placeholder="Describe the scope and objectives..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Specific requirements -->
                <div class="form-group full-width">
                  <label class="form-label">Specific requirements, conditions and additional information</label>
                  <textarea class="form-textarea" placeholder="Enter specific requirements and conditions..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Evaluation of submissions -->
                <div class="form-group full-width">
                  <label class="form-label">Evaluation of submissions</label>
                  <textarea class="form-textarea" placeholder="Describe how submissions will be evaluated..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Instructions -->
                <div class="form-group full-width">
                  <label class="form-label">Instructions</label>
                  <textarea class="form-textarea" placeholder="Provide instructions to suppliers..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Disclaimer (Auto-generated) -->
                <div class="form-group full-width">
                  <label class="form-label">Disclaimer</label>
                  <input type="text" class="form-input" value="This process is a Sourcing process TBD." readonly style="background: var(--surface-100);" />
                  <span class="help-text">Auto-generated disclaimer text</span>
                </div>
                
                <!-- Interpretation (Auto-generated) -->
                <div class="form-group full-width">
                  <label class="form-label">Interpretation of the RFP/ITB</label>
                  <textarea class="form-textarea" readonly style="background: var(--surface-100); min-height: 80px;">Standard interpretation clauses for RFP/ITB documentation will be applied as per UNOPS procurement policy.</textarea>
                  <span class="help-text">Auto-generated interpretation text</span>
                </div>
                
                <!-- Bidder eligibility -->
                <div class="form-group">
                  <label class="form-label">Bidder eligibility</label>
                  <select class="form-select" onchange="updateBidderEligibility(this.value)" onclick="event.stopPropagation()">
                    <option value="">Select...</option>
                    <option value="No bidders' countries are excluded from submitting a bid" ${particularsValues.bidderEligibility === "No bidders' countries are excluded from submitting a bid" ? 'selected' : ''}>No bidders' countries are excluded from submitting a bid</option>
                    <option value="List of countries restricting" ${particularsValues.bidderEligibility === 'List of countries restricting' ? 'selected' : ''}>List of countries restricting</option>
                    <option value="Specific criteria" ${particularsValues.bidderEligibility === 'Specific criteria' ? 'selected' : ''}>Specific criteria</option>
                  </select>
                </div>
                
                ${particularsValues.bidderEligibility === 'Specific criteria' ? `
                <div class="form-group full-width">
                  <label class="form-label">Describe specific eligibility criteria</label>
                  <textarea class="form-textarea" placeholder="Describe the specific bidder eligibility criteria..." style="min-height: 80px;"></textarea>
                </div>
                ` : ''}
                
                <!-- Clarifications or pre-bid meeting -->
                <div class="form-group">
                  <label class="form-label">Clarifications or pre-bid meeting</label>
                  <select class="form-select" onchange="updateClarificationsOrPreBid(this.value)">
                    <option value="">Select...</option>
                    <option value="No pre-bid meeting">No pre-bid meeting</option>
                    <option value="One pre-bid meeting">One pre-bid meeting</option>
                    <option value="Two pre-bid meetings">Two pre-bid meetings</option>
                  </select>
                </div>
                
                <!-- Supplier capacity-building initiatives -->
                <div class="form-group full-width">
                  <label class="form-label">Supplier capacity-building initiatives</label>
                  <textarea class="form-textarea" placeholder="Describe capacity-building initiatives if applicable..." style="min-height: 80px;"></textarea>
                </div>
                
                ${particularsValues.numberOfMeetings > 0 ? `
                  <!-- Pre-bid Meeting Fields -->
                  <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Pre-Bid Meeting Details</h4>
                  </div>
                  
                  ${Array.from({length: particularsValues.numberOfMeetings}, (_, i) => `
                    <div class="form-group full-width" style="background: var(--surface-50); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">
                      <h5 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Meeting ${i + 1}</h5>
                      
                      <div class="form-group">
                        <label class="form-label">Date and time for pre-bid meeting ${i + 1}</label>
                        <input type="datetime-local" class="form-input" />
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">Type of pre-bid meeting</label>
                        <select class="form-select">
                          <option>Select...</option>
                          <option>In-person</option>
                          <option>Virtual (video conference)</option>
                          <option>Hybrid</option>
                        </select>
                      </div>
                      
                      <div class="form-group full-width">
                        <label class="form-label">Pre-bid meeting details</label>
                        <textarea class="form-textarea" placeholder="Provide meeting details (location, dial-in info, etc.)..." style="min-height: 80px;"></textarea>
                      </div>
                    </div>
                  `).join('')}
                ` : ''}
                
                <!-- Site Visit Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Site Visit</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Site visit or inspection</label>
                  <select class="form-select" onchange="updateSiteVisit(this.value)">
                    <option value="">Select...</option>
                    <option value="Not applicable">Not applicable</option>
                    <option value="Applicable">Applicable</option>
                  </select>
                </div>
                
                ${particularsValues.siteVisit === 'Applicable' ? `
                  <div class="form-group">
                    <label class="form-label">Date option for site visit or inspection</label>
                    <select class="form-select" onchange="updateSiteVisitDateOption(this.value)" onclick="event.stopPropagation()">
                      <option value="">Select...</option>
                      <option value="Specific date">Specific date</option>
                      <option value="Date range">Date range</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Date/time for site visit or inspection</label>
                    <input type="datetime-local" class="form-input" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Details for site visit or inspection</label>
                    <textarea class="form-textarea" placeholder="Provide site visit details (location, contact, requirements, etc.)..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Exclusivity Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Exclusivity</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Exclusivity and/or availability statement</label>
                  <select class="form-select" onchange="updateExclusivity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.exclusivity === 'Required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Exclusivity / availability details</label>
                    <textarea class="form-textarea" placeholder="Provide exclusivity or availability requirements..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Commercial Conditions Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Commercial Conditions</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Validity period (days)</label>
                  <input type="number" class="form-input" placeholder="e.g., 90" min="1" />
                </div>
                
                <div class="form-group">
                  <label class="form-label">Quotation/Bid/Proposal currency(ies)</label>
                  <select class="form-select" multiple size="4">
                    <option>USD</option>
                    <option>EUR</option>
                    <option>GBP</option>
                    <option>CHF</option>
                    <option>Other</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Incoterms</label>
                  <select class="form-select" id="particulars-incoterms" multiple size="5" onchange="updateParticularsIncoterms(this)">
                    <option value="EXW">EXW - Ex Works</option>
                    <option value="FCA">FCA - Free Carrier</option>
                    <option value="CPT">CPT - Carriage Paid To</option>
                    <option value="CIP">CIP - Carriage and Insurance Paid To</option>
                    <option value="DAP">DAP - Delivered at Place</option>
                    <option value="DPU">DPU - Delivered at Place Unloaded</option>
                    <option value="DDP">DDP - Delivered Duty Paid</option>
                    <option value="FAS">FAS - Free Alongside Ship</option>
                    <option value="FOB">FOB - Free on Board</option>
                    <option value="CFR">CFR - Cost and Freight</option>
                    <option value="CIF">CIF - Cost, Insurance and Freight</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple Incoterms (2020)</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Duties and taxes</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Excluded</option>
                    <option>Included</option>
                    <option>As specified</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Languages of submissions</label>
                  <select class="form-select">
                    <option>English</option>
                    <option>French</option>
                    <option>Spanish</option>
                    <option>Multiple languages</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Other languages</label>
                  <select class="form-select" multiple size="3">
                    <option>Arabic</option>
                    <option>Chinese</option>
                    <option>Portuguese</option>
                    <option>Russian</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple</span>
                </div>
                
                <!-- Alternative Offers Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Alternative Offers</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Alternative quotations/offers/proposals</label>
                  <select class="form-select" onchange="updateAlternativeOffers(this.value)">
                    <option value="">Select...</option>
                    <option value="Not accepted">Not accepted</option>
                    <option value="Accepted">Accepted</option>
                  </select>
                </div>
                
                ${particularsValues.alternativeOffers === 'Accepted' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Alternative offers details</label>
                    <textarea class="form-textarea" placeholder="Describe requirements for alternative offers..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Contracting Details Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Contracting Details</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Type of contract to be awarded</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Purchase Order</option>
                    <option>Long-term Agreement (LTA)</option>
                    <option>Blanket Purchase Agreement (BPA)</option>
                    <option>Service Contract</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">General Conditions of Contract</label>
                  <select class="form-select">
                    <option>UNOPS General Conditions</option>
                    <option>Custom General Conditions</option>
                  </select>
                  <span class="help-text">Pre-filled with UNOPS standard terms</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Public bid/proposal opening</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Yes - Public opening</option>
                    <option>No - Private opening</option>
                  </select>
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Opening of bid details (location, date, time)</label>
                  <textarea class="form-textarea" placeholder="Provide details of bid opening ceremony..." style="min-height: 60px;"></textarea>
                </div>
                
                <!-- Payment Terms Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Payment Terms & Advance Payments</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Terms</label>
                  <select class="form-select" onchange="updatePaymentTerms(this.value)" onclick="event.stopPropagation()">
                    <option value="">Select...</option>
                    <option value="Net 30 days upon receipt of invoice as well as receipt and acceptance of goods or services" ${particularsValues.paymentTerms === 'Net 30 days upon receipt of invoice as well as receipt and acceptance of goods or services' ? 'selected' : ''}>Net 30 days upon receipt of invoice as well as receipt and acceptance of goods or services</option>
                    <option value="Upon receipt of required shipping documentation, depending on the Incoterm used (see 12.3.3 Incoterms)" ${particularsValues.paymentTerms === 'Upon receipt of required shipping documentation, depending on the Incoterm used (see 12.3.3 Incoterms)' ? 'selected' : ''}>Upon receipt of required shipping documentation, depending on the Incoterm used (see 12.3.3 Incoterms)</option>
                    <option value="Other" ${particularsValues.paymentTerms === 'Other' ? 'selected' : ''}>Other</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment terms details</label>
                  <input type="text" class="form-input" placeholder="e.g., net 30 days from invoice" />
                </div>
                
                ${particularsValues.paymentTerms === 'Other' ? `
                <div class="form-group full-width">
                  <label class="form-label">Payment terms ‚Äì Other</label>
                  <textarea class="form-textarea" placeholder="Provide additional payment terms if applicable..." style="min-height: 60px;"></textarea>
                </div>
                ` : ''}
                
                <div class="form-group full-width">
                  <label class="form-label">Advance payment allowed?</label>
                  <select class="form-select" onchange="updateAdvancePaymentAllowed(this.value)" onclick="event.stopPropagation()">
                    <option value="">Select...</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                  <div style="margin-top: 8px; padding: 12px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-secondary);">
                    ‚ÑπÔ∏è This selection cannot be changed after tender closes. Prior to tender closure, changes to this section will trigger an amendment. Advance payments refer to payments made prior to receipt of goods or performance of any contractual service or works. UNOPS FRRs, in rule 122.20 stipulate that except where normal, commercial practice or the best interests of UNOPS so require, no contract shall be made on behalf of UNOPS that requires payment(s) in advance of the delivery of products or the performance of contractual services. Please refer to Section 11.1.4 of Procurement Manual: Advance payments for more information on Advance Payments.
                  </div>
                </div>
                
                ${particularsValues.advancePaymentAllowed === 'Yes' ? `
                  <div class="form-group full-width">
                    <label class="form-label" onclick="event.stopPropagation()">Justification/background for advance payment</label>
                    <select class="form-select" onchange="handleAdvancePaymentJustification(this.value)" onclick="event.stopPropagation()">
                      <option value="" ${!particularsValues.advancePaymentJustification ? 'selected' : ''}>Select...</option>
                      <option value="mobilisation" ${particularsValues.advancePaymentJustification === 'mobilisation' ? 'selected' : ''}>(i) Mobilisation costs (works), (Please review the BoQ)</option>
                      <option value="operational" ${particularsValues.advancePaymentJustification === 'operational' ? 'selected' : ''}>(ii) Operational set-up costs (services/support)</option>
                      <option value="design" ${particularsValues.advancePaymentJustification === 'design' ? 'selected' : ''}>(iii) Design or production initiation (goods)</option>
                      <option value="lease" ${particularsValues.advancePaymentJustification === 'lease' ? 'selected' : ''}>(iv) Lease or utility prepayment</option>
                      <option value="others" ${particularsValues.advancePaymentJustification === 'others' ? 'selected' : ''}>(v) Others (specify below)</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width" id="otherJustificationContainer" style="display: ${particularsValues.advancePaymentJustification === 'others' ? 'block' : 'none'};">
                    <label class="form-label" onclick="event.stopPropagation()">Please specify other justification</label>
                    <textarea class="form-textarea" placeholder="Specify other justification for advance payment..." style="min-height: 80px;"></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Advance payment additional information/specific rationale</label>
                    <textarea class="form-textarea" placeholder="Provide advance payment additional information/specific rationale..." style="min-height: 60px;"></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Maximum Advance Payment as a percentage of estimated contract value</label>
                    <select class="form-select" onchange="handleAdvancePaymentPercentage(this.value)" onclick="event.stopPropagation()">
                      <option value="" ${!particularsValues.advancePaymentPercentage ? 'selected' : ''}>Select...</option>
                      <option value="1" ${particularsValues.advancePaymentPercentage === '1' ? 'selected' : ''}>Up to 1%</option>
                      <option value="2" ${particularsValues.advancePaymentPercentage === '2' ? 'selected' : ''}>Up to 2%</option>
                      <option value="3" ${particularsValues.advancePaymentPercentage === '3' ? 'selected' : ''}>Up to 3%</option>
                      <option value="4" ${particularsValues.advancePaymentPercentage === '4' ? 'selected' : ''}>Up to 4%</option>
                      <option value="5" ${particularsValues.advancePaymentPercentage === '5' ? 'selected' : ''}>Up to 5%</option>
                      <option value="6" ${particularsValues.advancePaymentPercentage === '6' ? 'selected' : ''}>Up to 6%</option>
                      <option value="7" ${particularsValues.advancePaymentPercentage === '7' ? 'selected' : ''}>Up to 7%</option>
                      <option value="8" ${particularsValues.advancePaymentPercentage === '8' ? 'selected' : ''}>Up to 8%</option>
                      <option value="9" ${particularsValues.advancePaymentPercentage === '9' ? 'selected' : ''}>Up to 9%</option>
                      <option value="10" ${particularsValues.advancePaymentPercentage === '10' ? 'selected' : ''}>Up to 10%</option>
                      <option value="11" ${particularsValues.advancePaymentPercentage === '11' ? 'selected' : ''}>Up to 11%</option>
                      <option value="12" ${particularsValues.advancePaymentPercentage === '12' ? 'selected' : ''}>Up to 12%</option>
                      <option value="13" ${particularsValues.advancePaymentPercentage === '13' ? 'selected' : ''}>Up to 13%</option>
                      <option value="14" ${particularsValues.advancePaymentPercentage === '14' ? 'selected' : ''}>Up to 14%</option>
                      <option value="15" ${particularsValues.advancePaymentPercentage === '15' ? 'selected' : ''}>Up to 15%</option>
                      <option value="16" ${particularsValues.advancePaymentPercentage === '16' ? 'selected' : ''}>Up to 16%</option>
                      <option value="17" ${particularsValues.advancePaymentPercentage === '17' ? 'selected' : ''}>Up to 17%</option>
                      <option value="18" ${particularsValues.advancePaymentPercentage === '18' ? 'selected' : ''}>Up to 18%</option>
                      <option value="19" ${particularsValues.advancePaymentPercentage === '19' ? 'selected' : ''}>Up to 19%</option>
                      <option value="20" ${particularsValues.advancePaymentPercentage === '20' ? 'selected' : ''}>Up to 20%</option>
                      <option value="21" ${particularsValues.advancePaymentPercentage === '21' ? 'selected' : ''}>Up to 21%</option>
                      <option value="22" ${particularsValues.advancePaymentPercentage === '22' ? 'selected' : ''}>Up to 22%</option>
                      <option value="23" ${particularsValues.advancePaymentPercentage === '23' ? 'selected' : ''}>Up to 23%</option>
                      <option value="24" ${particularsValues.advancePaymentPercentage === '24' ? 'selected' : ''}>Up to 24%</option>
                      <option value="25" ${particularsValues.advancePaymentPercentage === '25' ? 'selected' : ''}>Up to 25%</option>
                      <option value="26+" ${particularsValues.advancePaymentPercentage === '26+' ? 'selected' : ''}>26%+ of estimated contract value or above USD 500K</option>
                    </select>
                    <div style="margin-top: 8px; padding: 12px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-secondary);">
                      ‚ÑπÔ∏è Select "Up to %" of estimated contract value for advance payment. If estimated value of prepayment is above USD 500K or 25% of estimated contract value whichever is lower, CFO approval is required, as per FRR 122.20.a.
                    </div>
                  </div>
                  
                  <div class="form-group full-width" id="exceptionJustificationContainer" style="display: ${particularsValues.advancePaymentPercentage === '26+' ? 'block' : 'none'};">
                    <label class="form-label">Exception justification for estimated value of Advance Payment above USD 500K or 26%+ of estimated contract value</label>
                    <div style="display: flex; gap: var(--spacing-md); align-items: center; margin-bottom: var(--spacing-sm);">
                      <input type="file" class="form-input" accept=".pdf,.doc,.docx" style="flex: 1;" />
                      <button class="btn btn-secondary btn-sm" type="button">üìé Upload CFO Approval</button>
                    </div>
                    <input type="text" class="form-input" placeholder="Enter Service Point ticket link with approval" style="margin-top: 8px;" />
                    <div style="margin-top: 8px; padding: 10px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                      ‚ÑπÔ∏è Please kindly complete <a href="https://docs.google.com/document/d/1b-rgJohJhkQF7EwciGzh2PTVcCXclcYhqPBqI48itVo/edit?tab=t.0#heading=h.tmq4lqybq4bw" target="_blank" style="color: var(--primary-600); text-decoration: underline;">this form</a> & submit the request through <a href="https://unops.atlassian.net/servicedesk/customer/portal/76/group/537/create/3370" target="_blank" style="color: var(--primary-600); text-decoration: underline;">Service Point/Finance/ticket type: FRR122.20.a.)</a>. Add link to Service Point ticket with approval.
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Advance payment security required?</label>
                    <select class="form-select" onchange="updateAdvancePaymentSecurity(this.value)">
                      <option value="">Select...</option>
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                    <div style="margin-top: 8px; padding: 10px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                      ‚ÑπÔ∏è An advance payment security is mandatory when the value to be paid exceeds USD 250,000 but is also recommended for smaller amounts.
                    </div>
                  </div>
                  
                  ${particularsValues.advancePaymentSecurity === 'Yes' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Advance Payment Security requirements</label>
                      <textarea class="form-textarea" placeholder="Specify guarantor requirements, estimated deadline for provision of the advance payment security & applicable format." style="min-height: 80px;"></textarea>
                    </div>
                    
                  ` : particularsValues.advancePaymentSecurity === 'No' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Rationale for not requiring AP security</label>
                      <textarea class="form-textarea" placeholder="Provide justification for not requiring advance payment security..." style="min-height: 80px;"></textarea>
                    </div>
                  ` : ''}
                ` : ''}
                
                <!-- Additional Payment-Related Requirements Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Additional Payment-Related Requirements</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Audited Financial Documents</label>
                  <select class="form-select">
                    <option>Required</option>
                    <option>Not required</option>
                    <option>Conditional</option>
                  </select>
                  <span class="help-text">Pre-filled based on procurement value</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Security / Bank Guarantee</label>
                  <select class="form-select">
                    <option>Required</option>
                    <option>Not required</option>
                  </select>
                  <span class="help-text">Pre-filled based on contract type</span>
                </div>
                
                <!-- Damages & Securities Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Damages & Securities</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Liquidated or Delay Damages</label>
                  <select class="form-select" onchange="updateLiquidatedDamages(this.value)">
                    <option value="">Select...</option>
                    <option value="Not applicable">Not applicable</option>
                    <option value="Applicable">Applicable</option>
                  </select>
                </div>
                
                ${particularsValues.liquidatedDamages === 'Applicable' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification</label>
                    <textarea class="form-textarea" placeholder="Provide justification for applying liquidated damages..." style="min-height: 60px;"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Details</label>
                    <select class="form-select">
                      <option>Select...</option>
                      <option>0.5% per day (max 10%)</option>
                      <option>1% per day (max 10%)</option>
                      <option>Custom rate</option>
                      <option>Other</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Other details</label>
                    <textarea class="form-textarea" placeholder="Provide other liquidated damages details..." style="min-height: 60px;"></textarea>
                  </div>
                ` : particularsValues.liquidatedDamages === 'Not applicable' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification for not applying LD</label>
                    <textarea class="form-textarea" placeholder="Provide justification for not applying liquidated damages..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
                <div class="form-group">
                  <label class="form-label">Performance security</label>
                  <select class="form-select" onchange="updatePerformanceSecurity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.performanceSecurity === 'Required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Performance security details</label>
                    <textarea class="form-textarea" placeholder="Specify performance security requirements (percentage, format, validity, etc.)..." style="min-height: 80px;"></textarea>
                  </div>
                ` : particularsValues.performanceSecurity === 'Not required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification</label>
                    <textarea class="form-textarea" placeholder="Provide justification for not requiring performance security..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
                <div class="form-group">
                  <label class="form-label">Bid / proposal security</label>
                  <select class="form-select" onchange="updateBidSecurity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.bidSecurity === 'Required' ? `
                  <div class="form-group">
                    <label class="form-label">Bid/proposal security value (non-lot)</label>
                    <input type="number" class="form-input" placeholder="Enter amount" min="0" />
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Bid/proposal security value (lot-based)</label>
                    <input type="number" class="form-input" placeholder="Enter amount per lot" min="0" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Security details</label>
                    <textarea class="form-textarea" placeholder="Provide security details (format, validity period, etc.)..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
              </div>
            </div>
              </div>
              
              <!-- Key Dates Section - Collapsible -->
              <div class="collapsible-section collapsed" id="key-dates-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('key-dates-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Key Dates</span>
                    ${renderSectionProgress('key-dates', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    <div class="form-group">
                      <label class="form-label">Deadline <span class="required">*</span></label>
                      <input type="datetime-local" class="form-input" required />
                      <span class="help-text">Submission deadline for bids/proposals</span>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Deadline for clarifications</label>
                      <input type="datetime-local" class="form-input" />
                      <span class="help-text">Last date for suppliers to submit questions</span>
                    </div>
                    
                    <div class="form-group">
                      <label class="form-label">Expected Contract award date</label>
                      <input type="date" class="form-input" />
                      <span class="help-text">Estimated date for contract award</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Contract Provisions Section - Collapsible -->
              <div class="collapsible-section collapsed" id="contract-provisions-section" style="margin-top: var(--spacing-md);">
                <div class="collapsible-header" onclick="toggleCollapsibleSection('contract-provisions-section')">
                  <div class="collapsible-header-left">
                    <span class="collapsible-header-title">Contract Provisions</span>
                    ${renderSectionProgress('contract-provisions', null)}
                  </div>
                  <div class="collapsible-toggle">‚ñº</div>
                </div>
                <div class="collapsible-body" onclick="event.stopPropagation()">
                  <div class="form-grid-3col">
                    
                    <!-- UNOPS General Conditions of Contract -->
                    <div class="form-group full-width">
                      <label class="form-label">UNOPS General Conditions of Contract</label>
                      <select class="form-select" onchange="updateContractProvision('generalConditions', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select...</option>
                        <option value="goods" ${contractProvisionsValues.generalConditions === 'goods' ? 'selected' : ''}>General Conditions for Goods</option>
                        <option value="services" ${contractProvisionsValues.generalConditions === 'services' ? 'selected' : ''}>General Conditions for Services</option>
                        <option value="works" ${contractProvisionsValues.generalConditions === 'works' ? 'selected' : ''}>General Conditions for Works</option>
                        <option value="consultancy" ${contractProvisionsValues.generalConditions === 'consultancy' ? 'selected' : ''}>General Conditions for Consultancy</option>
                      </select>
                      <span class="help-text">Select applicable UNOPS General Conditions</span>
                    </div>
                    
                    <!-- UNOPS Special Conditions of Contract -->
                    <div class="form-group full-width">
                      <label class="form-label">UNOPS Special Conditions of Contract</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('specialConditions', 'insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div 
                          id="contract-special-conditions-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('specialConditions', this.innerHTML)"
                          placeholder="Enter special conditions that modify or supplement the General Conditions..."
                        >${contractProvisionsValues.specialConditions}</div>
                      </div>
                      <span class="help-text">Add any special conditions specific to this contract</span>
                    </div>
                    
                    <!-- UNOPS Sample Contract -->
                    <div class="form-group full-width">
                      <label class="form-label">UNOPS Sample Contract</label>
                      <select class="form-select" onchange="updateContractProvision('sampleContract', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select template...</option>
                        <option value="purchase-order" ${contractProvisionsValues.sampleContract === 'purchase-order' ? 'selected' : ''}>Purchase Order (PO)</option>
                        <option value="contract-goods" ${contractProvisionsValues.sampleContract === 'contract-goods' ? 'selected' : ''}>Contract for Goods</option>
                        <option value="contract-services" ${contractProvisionsValues.sampleContract === 'contract-services' ? 'selected' : ''}>Contract for Services</option>
                        <option value="contract-works" ${contractProvisionsValues.sampleContract === 'contract-works' ? 'selected' : ''}>Contract for Works</option>
                        <option value="lta" ${contractProvisionsValues.sampleContract === 'lta' ? 'selected' : ''}>Long-Term Agreement (LTA)</option>
                        <option value="bpa" ${contractProvisionsValues.sampleContract === 'bpa' ? 'selected' : ''}>Blanket Purchase Agreement (BPA)</option>
                      </select>
                      <span class="help-text">Select the applicable contract template</span>
                    </div>
                    
                    <!-- Contract clauses and KPIs (SP criteria) -->
                    <div class="form-group full-width">
                      <label class="form-label">Contract Clauses and KPIs (SP Criteria)</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesKPIs', 'insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div 
                          id="contract-clauses-kpis-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('contractClausesKPIs', this.innerHTML)"
                          placeholder="Define contract clauses and Key Performance Indicators based on Sustainable Procurement criteria..."
                        >${contractProvisionsValues.contractClausesKPIs}</div>
                      </div>
                      <span class="help-text">Define KPIs and clauses aligned with Sustainable Procurement criteria</span>
                    </div>
                    
                    <!-- Contract clauses (DRiVE/Risk app) -->
                    <div class="form-group full-width">
                      <label class="form-label">Contract Clauses (DRiVE/Risk App)</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('clausesDrive', 'insertOrderedList')" title="Numbered List">1.</button>
                        </div>
                        <div 
                          id="contract-clauses-drive-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 120px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('contractClausesDrive', this.innerHTML)"
                          placeholder="Enter contract clauses from DRiVE/Risk application..."
                        >${contractProvisionsValues.contractClausesDrive}</div>
                      </div>
                      <span class="help-text">Import or define clauses from DRiVE/Risk application</span>
                    </div>
                    
                    <!-- Performance Security / Bank Guarantee -->
                    <div class="form-group">
                      <label class="form-label">Performance Security / Bank Guarantee</label>
                      <select class="form-select" onchange="updateContractProvision('performanceSecurityRequired', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select...</option>
                        <option value="not-required" ${contractProvisionsValues.performanceSecurityRequired === 'not-required' ? 'selected' : ''}>Not Required</option>
                        <option value="required" ${contractProvisionsValues.performanceSecurityRequired === 'required' ? 'selected' : ''}>Required</option>
                      </select>
                    </div>
                    
                    ${contractProvisionsValues.performanceSecurityRequired === 'required' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Performance Security Details</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('perfSecurityDetails', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                        </div>
                        <div 
                          id="contract-perf-security-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 100px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('performanceSecurityDetails', this.innerHTML)"
                          placeholder="Specify performance security requirements (amount, percentage, format, validity period, etc.)..."
                        >${contractProvisionsValues.performanceSecurityDetails}</div>
                      </div>
                      <span class="help-text">Define the performance security/bank guarantee requirements</span>
                    </div>
                    ` : ''}
                    
                    <!-- Advance Payment -->
                    <div class="form-group">
                      <label class="form-label">Advance Payment</label>
                      <select class="form-select" onchange="updateContractProvision('advancePaymentRequired', this.value)" onclick="event.stopPropagation()">
                        <option value="">Select...</option>
                        <option value="not-allowed" ${contractProvisionsValues.advancePaymentRequired === 'not-allowed' ? 'selected' : ''}>Not Allowed</option>
                        <option value="allowed" ${contractProvisionsValues.advancePaymentRequired === 'allowed' ? 'selected' : ''}>Allowed</option>
                      </select>
                    </div>
                    
                    ${contractProvisionsValues.advancePaymentRequired === 'allowed' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Advance Payment Details</label>
                      <div class="rich-text-box" style="border: 1px solid var(--surface-300); border-radius: var(--radius-md); overflow: hidden;">
                        <div class="rich-text-toolbar-mini" style="display: flex; gap: 4px; padding: 8px; background: var(--surface-100); border-bottom: 1px solid var(--surface-300);">
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'bold')" title="Bold"><strong>B</strong></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'italic')" title="Italic"><em>I</em></button>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'underline')" title="Underline"><u>U</u></button>
                          <span style="width: 1px; background: var(--surface-300); margin: 0 4px;"></span>
                          <button type="button" class="tb-btn" onclick="event.stopPropagation(); formatContractText('advancePaymentDetails', 'insertUnorderedList')" title="Bullet List">‚Ä¢</button>
                        </div>
                        <div 
                          id="contract-advance-payment-editor"
                          class="rich-text-content" 
                          contenteditable="true"
                          style="min-height: 100px; padding: 12px; font-size: 13px; line-height: 1.5;"
                          onclick="event.stopPropagation()"
                          onblur="updateContractProvision('advancePaymentDetails', this.innerHTML)"
                          placeholder="Specify advance payment terms (percentage, conditions, guarantee requirements, etc.)..."
                        >${contractProvisionsValues.advancePaymentDetails}</div>
                      </div>
                      <span class="help-text">Define the advance payment terms and conditions</span>
                    </div>
                    ` : ''}
                    
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        `;
      }

      function renderCurrentBlock() {
        const wrapper = document.getElementById('content-wrapper');
        const block = templateBlocks[currentBlockIndex];

        let html = '';

        // Special handling for Scope & Requirements block - render all sections in one container
        if (block.id === 'scope') {
          html = renderScopeRequirementsBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }
        
        // Special handling for Competition block
        if (block.id === 'competition') {
          html = renderCompetitionBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }
        
        // Special handling for Team block
        if (block.id === 'team') {
          html = renderTeamBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }
        
        // Special handling for Evaluation block
        if (block.id === 'evaluation') {
          html = renderEvaluationBlock(block);
          wrapper.innerHTML = html;
          attachAuthoringEventListeners();
          updateNavigationButtons();
          return;
        }

        block.sections.forEach((section, sectionIndex) => {
          const isFirst = sectionIndex === 0;
          
          // Special handling for Requisition & Lots section
          if (section.isRequisitionLots) {
            html += renderRequisitionLotsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Product Requirements section
          if (section.isProductRequirements) {
            html += renderProductRequirementsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Other requirements section
          if (section.isTenderAuthorConfig) {
            html += renderTenderAuthorConfigSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Supplier Response Structure section
          if (section.isSupplierResponseStructure) {
            html += renderSupplierResponseStructureSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Supplier Form Preview section
          if (section.isSupplierFormPreview) {
            html += renderSupplierFormPreviewSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Evaluation Criteria section
          if (section.isEvaluationCriteria) {
            html += renderEvaluationCriteriaSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Particulars section
          if (section.isParticulars) {
            html += renderParticularsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special layout for General Information block - no section header, full width
          const isGeneralInfo = block.id === 'general' && sectionIndex === 0;
          
          // Special layout for Project Information section - collapsible, 3-column, no icon
          const isProjectInfo = block.id === 'project' && sectionIndex === 0;
          
          if (isProjectInfo) {
          html += `
              <div class="general-info-container">
                <div class="general-info-body">
                  <div class="collapsible-section collapsed" id="project-info-section">
                    <div class="collapsible-header" onclick="toggleCollapsibleSection('project-info-section')">
                      <div class="collapsible-header-left">
                        <span class="collapsible-header-title">Project Information</span>
                        <span style="margin-left: 8px; font-size: 12px; color: var(--text-muted);">(${selectedProjects.length} project${selectedProjects.length > 1 ? 's' : ''})</span>
                        ${renderSectionProgress('project-info', null)}
                      </div>
                      <div class="collapsible-toggle">‚ñº</div>
                    </div>
                    <div class="collapsible-body" onclick="event.stopPropagation()">
                      ${selectedProjects.map((projectEntry, projectIndex) => {
                        const dropdownId = 'project-search-dropdown-' + projectIndex;
                        return `
                          <div class="project-entry" style="background: var(--surface-ground); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                              <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">
                                <i class="pi pi-briefcase" style="margin-right: 6px; color: var(--primary-color);"></i>
                                Project ${projectIndex + 1}
                                ${projectEntry.projectId ? `<span style="font-weight: 400; color: var(--text-secondary);"> - ${projectEntry.projectId}</span>` : ''}
                              </span>
                              ${selectedProjects.length > 1 ? `
                                <button type="button" onclick="removeProject(${projectIndex})" class="btn-icon-danger" style="padding: 4px 8px; font-size: 12px; background: transparent; border: 1px solid var(--red-400); color: var(--red-500); border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseenter="this.style.background='var(--red-50)'" onmouseleave="this.style.background='transparent'">
                                  <i class="pi pi-trash" style="font-size: 11px;"></i>
                                  Remove
                                </button>
                              ` : ''}
                            </div>
                            <div class="form-grid-3col">
                              <!-- Project ID (Search) -->
                              <div class="form-group">
                                <label class="form-label">
                                  Project ID <span class="required">*</span>
                                </label>
                                <div style="position: relative;">
                                  <input type="text" class="form-input" data-field-id="projectId-${projectIndex}" value="${projectEntry.projectId ? projectEntry.projectId + ' - ' + projectEntry.projectName : ''}" placeholder="Search from oneUNOPS Project" required style="padding-left: 36px;" oninput="searchOneUNOPSProjects(this.value, '${dropdownId}', ${projectIndex})" onfocus="searchOneUNOPSProjects(this.value || '', '${dropdownId}', ${projectIndex})" />
                                  <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;">üîç</span>
                                  <div id="${dropdownId}" class="project-search-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--surface-card); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 1000; margin-top: 4px;"></div>
                                </div>
                                <span class="help-text">Source: oneUNOPS Project</span>
                              </div>
                              
                              <!-- Project Name (auto-populated) -->
                              <div class="form-group">
                                <label class="form-label">
                                  Project Name <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input" data-field-id="projectName-${projectIndex}" value="${projectEntry.projectName || ''}" placeholder="" required readonly />
                                <span class="help-text">Source: oneUNOPS Project (auto-populated)</span>
                              </div>
                              
                              <!-- Implementation End Date (auto-populated) -->
                              <div class="form-group">
                                <label class="form-label">
                                  Implementation End Date
                                </label>
                                <input type="date" class="form-input" data-field-id="implementationEndDate-${projectIndex}" value="${projectEntry.implementationEndDate || ''}" readonly />
                                <span class="help-text">Source: oneUNOPS Project (auto-populated)</span>
                              </div>
                              
                              <!-- Donor / Funding Source Comment -->
                              <div class="form-group full-width">
                                <label class="form-label">
                                  Donor / Funding Source Comment
                                </label>
                                <textarea class="form-textarea" data-field-id="donorFundingSourceComment-${projectIndex}" placeholder="Enter comments about the donor/funding source..." style="min-height: 80px; resize: vertical;" onchange="updateDonorComment(this.value, ${projectIndex})">${projectEntry.donorFundingSourceComment || ''}</textarea>
                              </div>
                            </div>
                          </div>
                        `;
                      }).join('')}
                      
                      <!-- Add Project Button -->
                      <div style="display: flex; justify-content: center; margin-top: 8px;">
                        <button type="button" onclick="addProject()" class="btn-add-project" style="padding: 10px 20px; font-size: 13px; font-weight: 500; background: var(--surface-card); border: 2px dashed var(--primary-color); color: var(--primary-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;" onmouseenter="this.style.background='var(--primary-50)'; this.style.borderStyle='solid'" onmouseleave="this.style.background='var(--surface-card)'; this.style.borderStyle='dashed'">
                          <i class="pi pi-plus-circle" style="font-size: 14px;"></i>
                          Add Another Project
                        </button>
                      </div>
                    </div>
                  </div>
            `;
            return; // Project Info section rendering continues in next iteration for Particulars
          }
          
          html += `
            <div class="${isGeneralInfo ? 'general-info-container' : 'form-section'}">
              ${isGeneralInfo ? `
                <div class="general-info-body">
              ` : `
              <div class="section-header">
                <div class="section-title">
                  <span class="section-icon">${block.icon}</span>
                  <span>${section.title}</span>
                </div>
                ${sectionIndex === 0 ? '<span class="status-indicator status-incomplete">Incomplete</span>' : ''}
              </div>
              <div class="section-body">
              `}
                
                ${(() => {
                  // Display added forms for this section
                  const blockForms = addedForms[block.id] || {};
                  const sectionForms = blockForms[sectionIndex] || [];
                  if (sectionForms.length > 0) {
                    return `
                      <div class="added-forms-section">
                        <div class="form-library-group-label" style="margin-bottom: var(--spacing-md);">Added Forms</div>
                        ${sectionForms.map(form => `
                          <div class="added-form-item" data-form-id="${form.id}">
                            <div class="added-form-info">
                              <div class="added-form-icon">üìÑ</div>
                              <div class="added-form-details">
                                <div class="added-form-name">${form.name}</div>
                                <div class="added-form-type">Form Document</div>
                              </div>
                            </div>
                            <div class="added-form-actions">
                              <button class="form-action-btn" onclick="previewForm('${form.id}')" title="Preview">üëÅ</button>
                              <button class="form-action-btn danger" onclick="removeForm('${form.id}')" title="Remove">‚úñ</button>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    `;
                  }
                  return '';
                })()}
                
                <div class="${isGeneralInfo ? 'form-grid-3col' : 'form-grid'}">
                  ${section.fields.map((field) => {
                    // Check conditional visibility
                    if (!shouldShowField(field)) {
                      return '';
                    }
                    
                    let fieldHtml = '';
                    const onchangeAttr = field.onchange ? `onchange="${field.onchange}(this.value)"` : '';
                    
                    if (field.type === 'textarea') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <textarea class="form-textarea" ${field.readonly ? 'readonly' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}">${field.value || ''}</textarea>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'select') {
                      // Check for pre-populated values
                      let selectedValue = '';
                      if (wizardData) {
                        if (field.label === 'Sourcing or Solicitation' && wizardData.sourcingType) {
                          selectedValue = wizardData.sourcingType.charAt(0).toUpperCase() + wizardData.sourcingType.slice(1);
                        } else if (field.label === 'Type of Requirement' && wizardData.requirementType) {
                          const requirementMap = {
                            goods: 'Goods',
                            services: 'Services',
                            works: 'Works',
                            'goods-services': 'Goods & Services',
                          };
                          selectedValue = requirementMap[wizardData.requirementType] || '';
                        }
                      }

                      const options = field.options.map(opt => {
                        const isSelected = selectedValue && opt === selectedValue ? 'selected' : '';
                        return `<option ${isSelected}>${opt}</option>`;
                      }).join('');
                      fieldHtml = `
                        <div class="form-group ${field.multiple ? 'full-width' : ''}">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <select class="form-select" ${field.multiple ? 'multiple size="5"' : ''} ${field.required ? 'required' : ''} ${field.readonly ? 'disabled' : ''} ${onchangeAttr}>
                            ${options}
                          </select>
                          ${field.multiple ? '<span class="help-text">Hold Ctrl/Cmd to select multiple</span>' : ''}
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'checkbox-group') {
                      const checkboxes = field.options.map((opt, idx) => `
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                          <input 
                            type="checkbox" 
                            value="${opt}" 
                            ${generalInfoValues.processType.includes(opt) ? 'checked' : ''}
                            onchange="${field.onchange}(this)"
                            style="cursor: pointer;"
                          />
                          <span>${opt}</span>
                        </label>
                      `).join('');
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            ${checkboxes}
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'search') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="position: relative;">
                            <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || 'Search...'}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} style="padding-left: 40px;" />
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">üîç</span>
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'country-multiselect') {
                      // Get selected countries from stored values
                      const selectedCountries = generalInfoValues.beneficiaryCountries || [];
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div class="country-multiselect-container" id="country-multiselect-container">
                            <div class="country-multiselect-input" onclick="toggleCountryDropdown()">
                              <div class="country-multiselect-tags" id="country-selected-tags">
                                ${selectedCountries.length > 0 ? 
                                  selectedCountries.map(country => `
                                    <span class="country-tag">
                                      ${country}
                                      <button type="button" onclick="event.stopPropagation(); removeCountry('${country}')" class="country-tag-remove">√ó</button>
                                    </span>
                                  `).join('') : 
                                  '<span class="country-placeholder">Select countries...</span>'
                                }
                              </div>
                              <span class="country-multiselect-arrow">‚ñº</span>
                            </div>
                            <div class="country-dropdown" id="country-dropdown" style="display: none;">
                              <div class="country-dropdown-search">
                                <input type="text" placeholder="Search countries..." id="country-search-input" oninput="filterCountries(this.value)" onclick="event.stopPropagation()" />
                              </div>
                              <div class="country-dropdown-list" id="country-dropdown-list">
                                ${field.options.map(country => `
                                  <label class="country-option ${selectedCountries.includes(country) ? 'selected' : ''}">
                                    <input type="checkbox" value="${country}" ${selectedCountries.includes(country) ? 'checked' : ''} onchange="toggleCountrySelection('${country}', this.checked)" onclick="event.stopPropagation()" />
                                    <span>${country}</span>
                                  </label>
                                `).join('')}
                              </div>
                              <div class="country-dropdown-footer">
                                <button type="button" class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); clearAllCountries()">Clear All</button>
                                <button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation(); toggleCountryDropdown()">Done</button>
                              </div>
                            </div>
                          </div>
                          <span class="help-text">Click to select one or more beneficiary countries</span>
                        </div>
                      `;
                    } else if (field.type === 'checkbox') {
                      const isChecked = generalInfoValues[field.id] === true;
                      fieldHtml = `
                        <div class="form-group">
                          <label class="form-label" style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                            <input 
                              type="checkbox" 
                              ${isChecked ? 'checked' : ''}
                              onchange="${field.onchange}(this)"
                              style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-500);"
                            />
                            <span>${field.label}</span>
                          </label>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'lifecycle-search') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="position: relative;">
                            <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || 'Search lifecycle tracker...'}" ${field.required ? 'required' : ''} style="padding-left: 40px; padding-right: 120px;" />
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">üîó</span>
                            <button type="button" class="btn btn-secondary btn-sm" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%);" onclick="openLifecycleTrackerSearch()">Browse Tracker</button>
                          </div>
                          ${field.help ? `<span class="help-text" style="color: var(--warning-500);">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'file') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                            <input type="file" class="form-input" ${field.required ? 'required' : ''} accept=".pdf,.doc,.docx,.xls,.xlsx" style="flex: 1;" />
                            <button class="btn btn-secondary btn-sm" type="button">üìé Choose File</button>
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'lifecycle-tracker') {
                      const trackerId = `lifecycle-tracker-${field.id}`;
                      // Check for conditional required (when retendering is Yes)
                      const isConditionallyRequired = field.conditionalRequired && 
                        generalInfoValues[field.conditionalRequired.field] === field.conditionalRequired.value;
                      const isRequired = field.required || isConditionallyRequired;
                      const requiredWarning = isConditionallyRequired ? 
                        `<div class="help-text" style="color: var(--warning-600); margin-bottom: var(--spacing-sm);"><strong>‚ö†Ô∏è Required:</strong> At least one related process must be linked when this is a retender.</div>` : '';
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${isRequired ? '<span class="required">*</span>' : ''}
                          </label>
                          ${requiredWarning}
                          ${field.description ? `<div class="help-text" style="margin-bottom: var(--spacing-md);">${field.description}</div>` : ''}
                          <div id="${trackerId}"></div>
                        </div>
                      `;
                      // Render lifecycle tracker after a short delay to ensure DOM is ready
                      setTimeout(() => renderLifecycleTracker(trackerId), 100);
                    } else {
                      const inputType = field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : field.type === 'datetime-local' ? 'datetime-local' : 'text';
                      fieldHtml = `
                        <div class="form-group ${field.type === 'textarea' ? 'full-width' : ''}">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <input type="${inputType}" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    }
                    return fieldHtml;
                  }).join('')}
                </div>
                
                <!-- Drop Zone for Forms -->
                ${!isGeneralInfo ? '<div class="form-drop-zone">Drop forms from library here</div>' : ''}
              ${isGeneralInfo ? '</div>' : '</div>'}
            </div>
          `;
        });

        wrapper.innerHTML = html;
        attachAuthoringEventListeners();
        // Re-setup drop zones after rendering
        setTimeout(() => {
          setupDropZones();
        }, 50);
      }

      window.toggleSection = function(header) {
        console.log('toggleSection called', header);
        const section = header.closest('.form-section');
        if (section) {
          section.classList.toggle('collapsed');
          console.log('Section toggled, collapsed:', section.classList.contains('collapsed'));
        } else {
          console.error('Section not found for header:', header);
        }
      }
      
      // Toggle collapsible section by ID
      window.toggleCollapsibleSection = function(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.toggle('collapsed');
          // Track the state for persistence across re-renders
          collapsibleSectionStates[sectionId] = section.classList.contains('collapsed');
        }
      }
      
      // Get the collapsed class based on saved state (defaults to collapsed if not set)
      window.getCollapsibleClass = function(sectionId, defaultCollapsed = true) {
        if (collapsibleSectionStates.hasOwnProperty(sectionId)) {
          return collapsibleSectionStates[sectionId] ? 'collapsed' : '';
        }
        return defaultCollapsed ? 'collapsed' : '';
      }
      
      // ===== COUNTRY MULTISELECT FUNCTIONS =====
      let countryDropdownOpen = false;
      
      window.toggleCountryDropdown = function() {
        const dropdown = document.getElementById('country-dropdown');
        const arrow = document.querySelector('.country-multiselect-arrow');
        
        if (dropdown) {
          countryDropdownOpen = !countryDropdownOpen;
          dropdown.style.display = countryDropdownOpen ? 'flex' : 'none';
          if (arrow) {
            arrow.style.transform = countryDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)';
          }
          
          // Focus search input when opening
          if (countryDropdownOpen) {
            const searchInput = document.getElementById('country-search-input');
            if (searchInput) {
              setTimeout(() => searchInput.focus(), 50);
            }
          }
        }
      }
      
      window.toggleCountrySelection = function(country, isChecked) {
        if (isChecked) {
          if (!generalInfoValues.beneficiaryCountries.includes(country)) {
            generalInfoValues.beneficiaryCountries.push(country);
          }
        } else {
          generalInfoValues.beneficiaryCountries = generalInfoValues.beneficiaryCountries.filter(c => c !== country);
        }
        updateCountryTags();
        updateCountryOptionStyles();
      }
      
      window.removeCountry = function(country) {
        generalInfoValues.beneficiaryCountries = generalInfoValues.beneficiaryCountries.filter(c => c !== country);
        updateCountryTags();
        updateCountryOptionStyles();
        
        // Uncheck the checkbox in dropdown
        const checkbox = document.querySelector(`.country-option input[value="${country}"]`);
        if (checkbox) {
          checkbox.checked = false;
        }
      }
      
      window.clearAllCountries = function() {
        generalInfoValues.beneficiaryCountries = [];
        updateCountryTags();
        updateCountryOptionStyles();
        
        // Uncheck all checkboxes
        const checkboxes = document.querySelectorAll('.country-option input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
      }
      
      window.filterCountries = function(searchTerm) {
        const options = document.querySelectorAll('.country-option');
        const lowerSearch = searchTerm.toLowerCase();
        
        options.forEach(option => {
          const countryName = option.querySelector('span').textContent.toLowerCase();
          if (countryName.includes(lowerSearch)) {
            option.style.display = 'flex';
          } else {
            option.style.display = 'none';
          }
        });
      }
      
      function updateCountryTags() {
        const tagsContainer = document.getElementById('country-selected-tags');
        if (!tagsContainer) return;
        
        if (generalInfoValues.beneficiaryCountries.length === 0) {
          tagsContainer.innerHTML = '<span class="country-placeholder">Select countries...</span>';
        } else {
          tagsContainer.innerHTML = generalInfoValues.beneficiaryCountries.map(country => `
            <span class="country-tag">
              ${country}
              <button type="button" onclick="event.stopPropagation(); removeCountry('${country}')" class="country-tag-remove">√ó</button>
            </span>
          `).join('');
        }
      }
      
      function updateCountryOptionStyles() {
        const options = document.querySelectorAll('.country-option');
        options.forEach(option => {
          const checkbox = option.querySelector('input[type="checkbox"]');
          if (checkbox) {
            if (generalInfoValues.beneficiaryCountries.includes(checkbox.value)) {
              option.classList.add('selected');
            } else {
              option.classList.remove('selected');
            }
          }
        });
      }
      
      // Close country dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const container = document.getElementById('country-multiselect-container');
        if (container && !container.contains(event.target) && countryDropdownOpen) {
          toggleCountryDropdown();
        }
      });
      
      // ===== REQUISITION LINE & LOT MODAL FUNCTIONS =====
      let selectedReqLines = [];
      let selectedProductsServicesLines = [];
      
      // ===== ADD PRODUCTS AND SERVICES MODAL =====
      let psReqLinesAvailable = []; // Store available lines for filtering
      
      window.openAddProductsServicesModal = function() {
        selectedProductsServicesLines = [];
        
        // Filter out items already in Products and Services (by linked ID)
        const existingLinkedIds = productsAndServices.filter(p => p.linkedRequisitionId).map(p => p.linkedRequisitionId);
        psReqLinesAvailable = requisitionLines.filter(l => !existingLinkedIds.includes(l.id));
        
        // Reset filter input
        const filterInput = document.getElementById('ps-req-filter-input');
        if (filterInput) filterInput.value = '';
        
        // Render the list
        renderPSReqLinesList(psReqLinesAvailable);
        updatePSReqSelectAllCheckbox();
        updatePSReqSelectedCount();
        
        // Clear new product form
        const unspscInput = document.getElementById('new-ps-unspsc');
        const unspscSearchInput = document.getElementById('new-ps-unspsc-search');
        const descInput = document.getElementById('new-ps-desc');
        const productTextInput = document.getElementById('new-ps-product-text');
        const qtyInput = document.getElementById('new-ps-qty');
        const uomSelect = document.getElementById('new-ps-uom');
        const valueInput = document.getElementById('new-ps-value');
        const linkedReqSelect = document.getElementById('new-ps-linked-req');
        const categoryIndicator = document.getElementById('unspsc-category-indicator');
        if (unspscInput) unspscInput.value = '';
        if (unspscSearchInput) unspscSearchInput.value = '';
        if (descInput) {
          descInput.value = '';
          descInput.setAttribute('readonly', 'readonly');
        }
        if (productTextInput) productTextInput.value = '';
        if (categoryIndicator) {
          categoryIndicator.innerHTML = '';
          categoryIndicator.style.display = 'none';
        }
        
        // Initialize the UNSPSC dropdown
        initUnspscDropdown();
        if (qtyInput) qtyInput.value = '1';
        if (uomSelect) uomSelect.value = 'Unit';
        if (valueInput) valueInput.value = '';
        
        // Populate linked requisition dropdown from requisitionLines (left column)
        if (linkedReqSelect) {
          linkedReqSelect.innerHTML = '<option value="">-- None (New Product) --</option>' +
            requisitionLines.map(line => `
              <option value="${line.id}" data-official="${line.procurementOfficial || ''}">
                ${line.id} - ${line.unspscCode} (${line.unspscDescription.substring(0, 30)}${line.unspscDescription.length > 30 ? '...' : ''})
              </option>
            `).join('');
        }
        
        // Reset to first tab
        switchProductsServicesModalTab('from-requisition');
        
        // Show modal
        document.getElementById('add-products-services-modal').style.display = 'flex';
      }
      
      // Render the list of requisition lines in the PS modal
      window.renderPSReqLinesList = function(linesToShow) {
        const reqLinesBody = document.getElementById('add-products-services-req-lines');
        if (!reqLinesBody) return;
        
        if (requisitionLines.length === 0) {
          reqLinesBody.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); font-size: 12px;"><i class="pi pi-info-circle" style="font-size: 20px; display: block; margin-bottom: 8px;"></i>No requisition lines available. Add requisition lines first from the left panel.</div>';
        } else if (linesToShow.length === 0) {
          reqLinesBody.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted); font-size: 12px;"><i class="pi pi-search" style="font-size: 20px; display: block; margin-bottom: 8px;"></i>No matching requisition lines found.</div>';
        } else {
          reqLinesBody.innerHTML = linesToShow.map(line => {
            const isSelected = selectedProductsServicesLines.some(l => l.id === line.id);
            return `
            <div class="req-line-option ${isSelected ? 'selected' : ''}" data-line-id="${line.id}" data-line='${JSON.stringify(line).replace(/'/g, "&#39;")}'>
              <input type="checkbox" id="ps-req-${line.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleProductsServicesLineSelection('${line.id}')" />
              <div class="req-line-details" onclick="toggleProductsServicesLineSelection('${line.id}')">
                <div class="req-line-code">${line.unspscCode}</div>
                <div class="req-line-desc">${line.unspscDescription}</div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                  <strong>${line.id}</strong> ‚Ä¢ ${line.quantity} ${line.unitOfMeasure} ‚Ä¢ ${line.currency} ${line.amount.toLocaleString()}
                </div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">
                  <strong>Work Package:</strong> ${line.workPackageGLA || 'N/A'} ‚Ä¢ <strong>Donor:</strong> ${line.donorFundingSourceGLA || 'N/A'}
                </div>
                <div style="font-size: 10px; color: var(--primary-600); margin-top: 2px;">
                  <i class="pi pi-user" style="font-size: 10px;"></i> ${line.procurementOfficial || 'Not assigned'}
                </div>
              </div>
            </div>
          `}).join('');
        }
      }
      
      // Filter requisition lines in PS modal
      window.filterPSReqLinesModal = function(searchText) {
        const text = searchText.toLowerCase().trim();
        const existingLinkedIds = productsAndServices.filter(p => p.linkedRequisitionId).map(p => p.linkedRequisitionId);
        let filtered = requisitionLines.filter(l => !existingLinkedIds.includes(l.id));
        
        if (text) {
          filtered = filtered.filter(line => 
            line.id.toLowerCase().includes(text) ||
            line.unspscCode.toLowerCase().includes(text) ||
            line.unspscDescription.toLowerCase().includes(text) ||
            (line.description && line.description.toLowerCase().includes(text)) ||
            (line.procurementOfficial && line.procurementOfficial.toLowerCase().includes(text)) ||
            (line.workPackageGLA && line.workPackageGLA.toLowerCase().includes(text)) ||
            (line.donorFundingSourceGLA && line.donorFundingSourceGLA.toLowerCase().includes(text))
          );
        }
        
        psReqLinesAvailable = filtered;
        renderPSReqLinesList(filtered);
        updatePSReqSelectAllCheckbox();
      }
      
      // Select All / Deselect All for PS modal
      window.togglePSReqSelectAll = function(selectAll) {
        if (selectAll) {
          psReqLinesAvailable.forEach(line => {
            if (!selectedProductsServicesLines.some(l => l.id === line.id)) {
              selectedProductsServicesLines.push(line);
            }
          });
        } else {
          psReqLinesAvailable.forEach(line => {
            const idx = selectedProductsServicesLines.findIndex(l => l.id === line.id);
            if (idx >= 0) selectedProductsServicesLines.splice(idx, 1);
          });
        }
        renderPSReqLinesList(psReqLinesAvailable);
        updatePSReqSelectAllCheckbox();
        updatePSReqSelectedCount();
      }
      
      // Update select all checkbox state for PS modal
      window.updatePSReqSelectAllCheckbox = function() {
        const selectAllCheckbox = document.getElementById('ps-req-select-all');
        if (selectAllCheckbox && psReqLinesAvailable.length > 0) {
          const allSelected = psReqLinesAvailable.every(line => selectedProductsServicesLines.some(l => l.id === line.id));
          const someSelected = psReqLinesAvailable.some(line => selectedProductsServicesLines.some(l => l.id === line.id));
          selectAllCheckbox.checked = allSelected;
          selectAllCheckbox.indeterminate = someSelected && !allSelected;
        } else if (selectAllCheckbox) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        }
      }
      
      // Update selected count for PS modal
      window.updatePSReqSelectedCount = function() {
        const countEl = document.getElementById('ps-req-selected-count');
        if (countEl) {
          countEl.textContent = selectedProductsServicesLines.length > 0 ? `${selectedProductsServicesLines.length} selected` : '';
        }
      }
      
      window.closeAddProductsServicesModal = function() {
        document.getElementById('add-products-services-modal').style.display = 'none';
        selectedProductsServicesLines = [];
        psReqLinesAvailable = [];
      }
      
      window.switchProductsServicesModalTab = function(tabId) {
        document.querySelectorAll('#add-products-services-modal .product-modal-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === tabId);
        });
        document.querySelectorAll('#add-products-services-modal .product-modal-tab-content').forEach(content => {
          content.classList.toggle('active', content.id === 'ps-tab-' + tabId);
        });
        
        // Update button based on tab
        const confirmBtn = document.getElementById('add-ps-confirm-btn');
        if (confirmBtn) {
          if (tabId === 'from-requisition') {
            confirmBtn.textContent = 'Add Selected';
            confirmBtn.onclick = addProductsServicesFromRequisition;
          } else {
            confirmBtn.textContent = 'Create Product';
            confirmBtn.onclick = addNewProductService;
          }
        }
      }
      
      // Toggle selection via row or checkbox click for PS modal
      window.toggleProductsServicesLineSelection = function(lineId) {
        const element = document.querySelector(`#add-products-services-req-lines .req-line-option[data-line-id="${lineId}"]`);
        if (!element) return;
        
        const checkbox = document.getElementById(`ps-req-${lineId}`);
        const lineData = JSON.parse(element.dataset.line.replace(/&#39;/g, "'"));
        
        const existingIndex = selectedProductsServicesLines.findIndex(l => l.id === lineId);
        if (existingIndex >= 0) {
          selectedProductsServicesLines.splice(existingIndex, 1);
          element.classList.remove('selected');
          if (checkbox) checkbox.checked = false;
        } else {
          selectedProductsServicesLines.push(lineData);
          element.classList.add('selected');
          if (checkbox) checkbox.checked = true;
        }
        updatePSReqSelectAllCheckbox();
        updatePSReqSelectedCount();
      }
      
      window.addProductsServicesFromRequisition = function() {
        if (selectedProductsServicesLines.length === 0) {
          showNotification('Please select at least one item to add.', 'warning');
          return;
        }
        
        // Add selected items to Products and Services with link to requisition
        selectedProductsServicesLines.forEach(line => {
          productsAndServices.push({
            ...line,
            id: 'ps-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
            linkedRequisitionId: line.id
          });
        });
        
        closeAddProductsServicesModal();
        renderCurrentBlock();
        showNotification(`Added ${selectedProductsServicesLines.length} product(s)/service(s)`, 'success');
      }
      
      // ===== UNSPSC SEARCHABLE DROPDOWN =====
      window.initUnspscDropdown = function() {
        const searchInput = document.getElementById('new-ps-unspsc-search');
        const dropdown = document.getElementById('unspsc-dropdown');
        const hiddenInput = document.getElementById('new-ps-unspsc');
        const descInput = document.getElementById('new-ps-desc');
        
        if (!searchInput || !dropdown) return;
        
        // Render all options initially
        renderUnspscOptions(masterUnspscCodes);
        
        // Search input event
        searchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();
          const filtered = masterUnspscCodes.filter(item => 
            item.code.toLowerCase().includes(query) || 
            item.description.toLowerCase().includes(query)
          );
          renderUnspscOptions(filtered);
          dropdown.classList.add('show');
        });
        
        // Show dropdown on focus
        searchInput.addEventListener('focus', function() {
          const query = this.value.toLowerCase().trim();
          const filtered = query ? masterUnspscCodes.filter(item => 
            item.code.toLowerCase().includes(query) || 
            item.description.toLowerCase().includes(query)
          ) : masterUnspscCodes;
          renderUnspscOptions(filtered);
          dropdown.classList.add('show');
        });
        
        // Hide dropdown on outside click
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.unspsc-search-container')) {
            dropdown.classList.remove('show');
          }
        });
      };
      
      window.renderUnspscOptions = function(items) {
        const dropdown = document.getElementById('unspsc-dropdown');
        if (!dropdown) return;
        
        if (items.length === 0) {
          dropdown.innerHTML = '<div class="unspsc-no-results">No matching UNSPSC codes found</div>';
          return;
        }
        
        dropdown.innerHTML = items.map(item => `
          <div class="unspsc-option" onclick="selectUnspscCode('${item.code}', '${item.description.replace(/'/g, "\\'")}', ${item.category || 'null'})">
            <span class="unspsc-option-code">${item.code}</span>
            <span class="unspsc-option-desc">${item.description}</span>
            ${item.category ? `<span class="unspsc-category-badge category-${item.category}" title="Category ${item.category} - Requires special handling">Cat ${item.category}</span>` : ''}
          </div>
        `).join('');
      };
      
      window.selectUnspscCode = function(code, description, category) {
        const searchInput = document.getElementById('new-ps-unspsc-search');
        const hiddenInput = document.getElementById('new-ps-unspsc');
        const descInput = document.getElementById('new-ps-desc');
        const dropdown = document.getElementById('unspsc-dropdown');
        const categoryIndicator = document.getElementById('unspsc-category-indicator');
        
        if (searchInput) searchInput.value = code + ' - ' + description;
        if (hiddenInput) hiddenInput.value = code;
        if (descInput) {
          descInput.value = description;
          descInput.removeAttribute('readonly'); // Make editable after selection
        }
        if (dropdown) dropdown.classList.remove('show');
        
        // Update category indicator
        if (categoryIndicator) {
          if (category === 2) {
            categoryIndicator.innerHTML = `
              <div class="category-warning category-2">
                <span class="category-icon">‚ö†Ô∏è</span>
                <div class="category-text">
                  <strong>Category 2 Item</strong>
                  <span>This UNSPSC code requires additional review and approval processes.</span>
                </div>
              </div>
            `;
            categoryIndicator.style.display = 'block';
          } else if (category === 3) {
            categoryIndicator.innerHTML = `
              <div class="category-warning category-3">
                <span class="category-icon">üö®</span>
                <div class="category-text">
                  <strong>Category 3 Item</strong>
                  <span>This UNSPSC code is high-risk and requires special handling and enhanced due diligence.</span>
                </div>
              </div>
            `;
            categoryIndicator.style.display = 'block';
          } else {
            categoryIndicator.innerHTML = '';
            categoryIndicator.style.display = 'none';
          }
        }
      };
      
      window.clearUnspscSelection = function() {
        const searchInput = document.getElementById('new-ps-unspsc-search');
        const hiddenInput = document.getElementById('new-ps-unspsc');
        const descInput = document.getElementById('new-ps-desc');
        const categoryIndicator = document.getElementById('unspsc-category-indicator');
        
        if (searchInput) searchInput.value = '';
        if (hiddenInput) hiddenInput.value = '';
        if (descInput) {
          descInput.value = '';
          descInput.setAttribute('readonly', 'readonly'); // Reset to readonly
        }
        if (categoryIndicator) {
          categoryIndicator.innerHTML = '';
          categoryIndicator.style.display = 'none';
        }
      };
      
      window.addNewProductService = function() {
        const unspsc = document.getElementById('new-ps-unspsc').value.trim();
        const desc = document.getElementById('new-ps-desc').value.trim();
        const productText = document.getElementById('new-ps-product-text').value.trim();
        const qty = parseInt(document.getElementById('new-ps-qty').value) || 1;
        const uom = document.getElementById('new-ps-uom').value;
        const value = parseFloat(document.getElementById('new-ps-value').value) || 0;
        const linkedReqSelect = document.getElementById('new-ps-linked-req');
        const linkedReqId = linkedReqSelect ? linkedReqSelect.value : '';
        
        // Get procurement official from linked requisition if selected
        let procurementOfficial = 'Not assigned';
        if (linkedReqId) {
          const linkedLine = requisitionLines.find(l => l.id === linkedReqId);
        if (linkedLine && linkedLine.procurementOfficial) {
          procurementOfficial = linkedLine.procurementOfficial;
          }
        }
        
        if (!unspsc || !desc) {
          showNotification('Please select a UNSPSC code from the dropdown list.', 'warning');
          return;
        }
        
        // Validate that the UNSPSC code is from the master list
        const isValidCode = masterUnspscCodes.some(item => item.code === unspsc);
        if (!isValidCode) {
          showNotification('Please select a valid UNSPSC code from the dropdown list.', 'warning');
          return;
        }
        
        // Generate unique product ID for Products and Services
        const newProdId = 'ps-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
        
        const newItem = {
          id: newProdId,
          unspscCode: unspsc,
          unspscDescription: desc,
          description: productText || '',
          quantity: qty,
          unitOfMeasure: uom,
          amount: value,
          currency: 'USD',
          procurementOfficial: procurementOfficial,
          linkedRequisitionId: linkedReqId || null,
        };
        
        productsAndServices.push(newItem);
        
        closeAddProductsServicesModal();
        renderCurrentBlock();
        showNotification(`Added new product/service: ${desc}`, 'success');
      }
      
      window.openAddReqLineModal = function() {
        const modal = document.getElementById('add-req-line-modal');
        const body = document.getElementById('add-req-line-body');
        selectedReqLines = [];
        
        // Filter out lines already added to Products and Services
        const existingIds = requisitionLines.map(l => l.id);
        const linesToShow = availableRequisitionLines.filter(l => !existingIds.includes(l.id));
        
        if (linesToShow.length === 0) {
          body.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <div style="font-size: 28px; margin-bottom: var(--spacing-sm);">‚úÖ</div>
              <div style="font-size: 13px;">All available requisition lines have been added.</div>
            </div>
          `;
        } else {
          body.innerHTML = linesToShow.map(line => `
            <div class="req-option" data-line-id="${line.id}" onclick="toggleReqLineSelection('${line.id}')">
              <input type="checkbox" class="req-option-checkbox" id="req-cb-${line.id}" />
              <div class="req-option-details">
                <div class="req-option-main">
                  <span style="font-weight: 600;">${line.id}</span>
                  <span style="font-family: monospace; color: var(--primary-600); font-size: 11px;">${line.unspscCode}</span>
                  <span style="color: var(--success-600); font-weight: 600; font-size: 11px;">$${line.amount.toLocaleString()}</span>
                </div>
                <div class="req-option-sub">${line.unspscDescription} - ${line.description}</div>
              </div>
            </div>
          `).join('');
        }
        
        modal.style.display = 'flex';
      }
      
      window.closeAddReqLineModal = function() {
        document.getElementById('add-req-line-modal').style.display = 'none';
        selectedReqLines = [];
      }
      
      window.toggleReqLineSelection = function(lineId) {
        const option = document.querySelector(`.req-option[data-line-id="${lineId}"]`);
        const checkbox = document.getElementById(`req-cb-${lineId}`);
        
        if (selectedReqLines.includes(lineId)) {
          selectedReqLines = selectedReqLines.filter(id => id !== lineId);
          option.classList.remove('selected');
          checkbox.checked = false;
        } else {
          selectedReqLines.push(lineId);
          option.classList.add('selected');
          checkbox.checked = true;
        }
      }
      
      window.addSelectedReqLines = function() {
        if (selectedReqLines.length === 0) {
          alert('Please select at least one requisition line to add.');
          return;
        }
        
        // Get lines from centralized available requisition lines
        const linesToAdd = availableRequisitionLines.filter(l => selectedReqLines.includes(l.id));
        requisitionLines = [...requisitionLines, ...linesToAdd];
        
        closeAddReqLineModal();
        renderCurrentBlock();
        showNotification(`Added ${linesToAdd.length} requisition line(s)`, 'success');
      }
      
      window.openCreateLotModal = function() {
        document.getElementById('create-lot-modal').style.display = 'flex';
        document.getElementById('new-lot-desc-input').value = '';
        setTimeout(() => document.getElementById('new-lot-desc-input').focus(), 100);
      }
      
      window.closeCreateLotModal = function() {
        document.getElementById('create-lot-modal').style.display = 'none';
      }
      
      window.createLotFromModal = function() {
        const lotDesc = document.getElementById('new-lot-desc-input').value.trim();
        if (!lotDesc) {
          alert('Please enter a lot description.');
          return;
        }
        
        const newLot = {
          id: 'lot-' + Date.now(),
          description: lotDesc,
          unspscCodes: [],
        };
        
        lots.push(newLot);
        closeCreateLotModal();
        renderCurrentBlock();
        showNotification('Lot created successfully', 'success');
      }
      
      // ===== EVALUATION CRITERION MODAL FUNCTIONS =====
      // Available forms for linking (mock data - in real app would come from form builder)
      const availableFormsForLinking = [
        { id: 'form-qualification', name: 'Qualification Form', type: 'qualification' },
        { id: 'form-technical', name: 'Technical Proposal Form', type: 'technical' },
        { id: 'form-financial', name: 'Financial Proposal Form', type: 'financial' },
        { id: 'form-experience', name: 'Experience & References Form', type: 'qualification' },
        { id: 'form-compliance', name: 'Compliance Declaration Form', type: 'eligibility' },
        { id: 'form-sustainability', name: 'Sustainability Questionnaire', type: 'technical' }
      ];
      
      window.openEvaluationCriterionModal = function(criterionId = null) {
        const modal = document.getElementById('evaluation-criterion-modal');
        const titleEl = document.getElementById('eval-criterion-modal-title');
        const saveBtn = document.getElementById('eval-criterion-save-btn');
        const idDisplay = document.getElementById('eval-criterion-id-display');
        const idReadonly = document.getElementById('eval-criterion-id-readonly');
        
        // Reset form
        document.getElementById('eval-criterion-id').value = criterionId || '';
        document.getElementById('eval-criterion-name').value = '';
        document.getElementById('eval-criterion-category').value = 'Qualification';
        document.getElementById('eval-criterion-method').value = 'Pass/Fail';
        document.getElementById('eval-criterion-description').value = '';
        document.querySelector('input[name="eval-criterion-applies"][value="tender"]').checked = true;
        document.getElementById('eval-criterion-specific-section').style.display = 'none';
        
        // Reset max points
        document.getElementById('eval-criterion-maxpoints-group').style.display = 'none';
        document.getElementById('eval-criterion-maxpoints').value = '';
        
        // Update method options based on evaluation method (Cumulative analysis = Numeric allowed)
        const isCumulativeAnalysis = updateCriterionMethodOptions();
        
        // Show/hide the method restriction notice
        const methodNotice = document.getElementById('eval-criterion-method-notice');
        if (methodNotice) {
          if (!isCumulativeAnalysis) {
            methodNotice.style.display = 'block';
            methodNotice.innerHTML = '<i class="pi pi-info-circle" style="margin-right: 4px;"></i>Numeric scoring is only available when Evaluation Method is set to "Cumulative analysis"';
          } else {
            methodNotice.style.display = 'none';
          }
        }
        
        // Reset sustainable procurement checkboxes
        document.querySelectorAll('.eval-sp-checkbox').forEach(cb => cb.checked = false);
        
        // Populate lots dropdown
        populateEvalCriterionLotsDropdown();
        
        // Populate linked forms checkboxes
        populateEvalCriterionLinkedForms();
        
        if (criterionId) {
          // Edit mode
          titleEl.innerHTML = '<i class="pi pi-pencil"></i> Edit Evaluation Criterion';
          saveBtn.innerHTML = '<i class="pi pi-check"></i> Save Changes';
          idDisplay.style.display = 'block';
          idReadonly.value = criterionId;
          
          // Find and populate existing criterion
          const criterion = evaluationCriteria.find(c => c.id === criterionId);
          if (criterion) {
            document.getElementById('eval-criterion-name').value = criterion.criteria || '';
            document.getElementById('eval-criterion-category').value = criterion.category || criterion.type || 'Qualification';
            document.getElementById('eval-criterion-method').value = criterion.evaluationMethod || 'Pass/Fail';
            document.getElementById('eval-criterion-description').value = criterion.description || '';
            
            // Max points
            if (criterion.evaluationMethod === 'Numeric') {
              document.getElementById('eval-criterion-maxpoints-group').style.display = 'block';
              document.getElementById('eval-criterion-maxpoints').value = criterion.maxPoints || '';
            }
            
            // Sustainable procurement categories
            if (criterion.sustainableProcurement && criterion.sustainableProcurement.length > 0) {
              criterion.sustainableProcurement.forEach(sp => {
                const checkbox = document.querySelector(`.eval-sp-checkbox[value="${sp}"]`);
                if (checkbox) checkbox.checked = true;
              });
            }
            
            // Apply to
            const appliesTo = criterion.appliesTo || 'tender';
            if (appliesTo === 'lots') {
              document.querySelector('input[name="eval-criterion-applies"][value="lots"]').checked = true;
              document.getElementById('eval-criterion-specific-section').style.display = 'block';
              // Select the lots in the dropdown
              const lotsSelect = document.getElementById('eval-criterion-lots');
              if (criterion.lots && criterion.lots.length > 0) {
                Array.from(lotsSelect.options).forEach(opt => {
                  if (criterion.lots.includes(opt.value)) {
                    opt.selected = true;
                  }
                });
              }
            }
            
            // Linked forms
            if (criterion.linkedForms && criterion.linkedForms.length > 0) {
              criterion.linkedForms.forEach(lf => {
                const checkbox = document.querySelector(`.eval-linked-form-checkbox[value="${lf.formId}"]`);
                if (checkbox) checkbox.checked = true;
              });
            }
          }
        } else {
          // Add mode
          titleEl.innerHTML = '<i class="pi pi-plus-circle"></i> Add Evaluation Criterion';
          saveBtn.innerHTML = '<i class="pi pi-check"></i> Add Criterion';
          idDisplay.style.display = 'none';
        }
        
        modal.style.display = 'flex';
        setTimeout(() => document.getElementById('eval-criterion-name').focus(), 100);
      }
      
      window.closeEvaluationCriterionModal = function() {
        document.getElementById('evaluation-criterion-modal').style.display = 'none';
      }
      
      window.toggleEvalCriterionAppliesTo = function(value) {
        const specificSection = document.getElementById('eval-criterion-specific-section');
        if (value === 'lots') {
          specificSection.style.display = 'block';
        } else {
          specificSection.style.display = 'none';
        }
      }
      
      window.toggleMaxPointsField = function(method) {
        const maxPointsGroup = document.getElementById('eval-criterion-maxpoints-group');
        if (method === 'Numeric') {
          maxPointsGroup.style.display = 'block';
        } else {
          maxPointsGroup.style.display = 'none';
          document.getElementById('eval-criterion-maxpoints').value = '';
        }
      }
      
      // Update the method dropdown options based on evaluation method (Cumulative analysis allows Numeric)
      window.updateCriterionMethodOptions = function() {
        const methodSelect = document.getElementById('eval-criterion-method');
        if (!methodSelect) return;
        
        const isCumulativeAnalysis = evaluationBlockValues.evaluationMethod === 'Cumulative analysis';
        const currentValue = methodSelect.value;
        
        // Clear and rebuild options
        methodSelect.innerHTML = '';
        
        // Pass/Fail is always available
        const passFail = document.createElement('option');
        passFail.value = 'Pass/Fail';
        passFail.textContent = 'Pass/Fail';
        methodSelect.appendChild(passFail);
        
        // Numeric is only available for Cumulative analysis
        if (isCumulativeAnalysis) {
          const numeric = document.createElement('option');
          numeric.value = 'Numeric';
          numeric.textContent = 'Numeric';
          methodSelect.appendChild(numeric);
        }
        
        // Restore selection if still valid, otherwise default to Pass/Fail
        if (currentValue === 'Numeric' && isCumulativeAnalysis) {
          methodSelect.value = 'Numeric';
        } else {
          methodSelect.value = 'Pass/Fail';
          // Hide max points if we forced to Pass/Fail
          toggleMaxPointsField('Pass/Fail');
        }
        
        return isCumulativeAnalysis;
      }
      
      // Check if Numeric method is allowed
      window.isNumericMethodAllowed = function() {
        return evaluationBlockValues.evaluationMethod === 'Cumulative analysis';
      }
      
      // Count criteria with Sustainable Procurement categories
      window.countSPCriteria = function() {
        return evaluationCriteria.filter(c => c.sustainableProcurement && c.sustainableProcurement.length > 0).length;
      }
      
      // Check if SP waiver is needed (too few SP criteria)
      window.isSPWaiverNeeded = function() {
        return countSPCriteria() < MIN_SP_CRITERIA_REQUIRED;
      }
      
      // Update SP waiver code
      window.updateSPWaiverCode = function(value) {
        evaluationBlockValues.spWaiverCode = value;
      }
      
      function populateEvalCriterionLotsDropdown() {
        const lotsSelect = document.getElementById('eval-criterion-lots');
        lotsSelect.innerHTML = '';
        
        // Add lots
        if (lots.length > 0) {
          lots.forEach(lot => {
            const option = document.createElement('option');
            option.value = lot.id;
            option.textContent = `üì¶ Lot ${lot.id}: ${lot.description || 'No description'}`;
            lotsSelect.appendChild(option);
          });
        }
        
        if (lotsSelect.options.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No lots available - create lots first';
          option.disabled = true;
          lotsSelect.appendChild(option);
        }
      }
      
      function populateEvalCriterionLinkedForms() {
        const container = document.getElementById('eval-criterion-linked-forms-container');
        if (!container) return;
        
        if (availableFormsForLinking.length === 0) {
          container.innerHTML = '<div style="font-size: 11px; color: var(--text-muted); padding: 8px;">No forms available for linking</div>';
          return;
        }
        
        container.innerHTML = availableFormsForLinking.map(form => `
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 0; font-size: 12px;">
            <input type="checkbox" class="eval-linked-form-checkbox" value="${form.id}" />
            <span style="flex: 1;">${form.name}</span>
            <span style="font-size: 10px; color: var(--text-muted); background: var(--surface-100); padding: 1px 5px; border-radius: 3px;">${form.type}</span>
          </label>
        `).join('');
      }
      
      window.saveEvaluationCriterion = function() {
        const criterionId = document.getElementById('eval-criterion-id').value;
        const name = document.getElementById('eval-criterion-name').value.trim();
        const category = document.getElementById('eval-criterion-category').value;
        const method = document.getElementById('eval-criterion-method').value;
        const description = document.getElementById('eval-criterion-description').value.trim();
        const appliesTo = document.querySelector('input[name="eval-criterion-applies"]:checked').value;
        const maxPoints = document.getElementById('eval-criterion-maxpoints').value;
        
        // Validation
        if (!name) {
          alert('Please enter a criteria name.');
          document.getElementById('eval-criterion-name').focus();
          return;
        }
        
        if (!description) {
          alert('Please enter a description.');
          document.getElementById('eval-criterion-description').focus();
          return;
        }
        
        // Validate Numeric method is only allowed with Cumulative analysis
        if (method === 'Numeric' && evaluationBlockValues.evaluationMethod !== 'Cumulative analysis') {
          alert('Numeric evaluation method is only allowed when the Evaluation Method is set to "Cumulative analysis". Please change the method to Pass/Fail or update the Evaluation Method first.');
          return;
        }
        
        if (method === 'Numeric' && !maxPoints) {
          alert('Please enter maximum points for numeric evaluation method.');
          document.getElementById('eval-criterion-maxpoints').focus();
          return;
        }
        
        // Get selected sustainable procurement categories
        const selectedSP = [];
        document.querySelectorAll('.eval-sp-checkbox:checked').forEach(cb => {
          selectedSP.push(cb.value);
        });
        
        // Get selected lots if lot level
        let selectedLots = [];
        if (appliesTo === 'lots') {
          const lotsSelect = document.getElementById('eval-criterion-lots');
          Array.from(lotsSelect.selectedOptions).forEach(opt => {
            if (opt.value) selectedLots.push(opt.value);
          });
        }
        
        // Get selected linked forms
        const selectedLinkedForms = [];
        document.querySelectorAll('.eval-linked-form-checkbox:checked').forEach(cb => {
          const form = availableFormsForLinking.find(f => f.id === cb.value);
          if (form) {
            selectedLinkedForms.push({
              formId: form.id,
              formName: form.name,
              formType: form.type
            });
          }
        });
        
        if (criterionId) {
          // Edit existing criterion
          const index = evaluationCriteria.findIndex(c => c.id === criterionId);
          if (index !== -1) {
            evaluationCriteria[index] = {
              ...evaluationCriteria[index],
              criteria: name,
              category: category,
              type: category, // Keep type for backwards compatibility
              evaluationMethod: method,
              maxPoints: method === 'Numeric' ? parseInt(maxPoints) : null,
              description: description,
              sustainableProcurement: selectedSP,
              appliesTo: appliesTo,
              lots: selectedLots,
              linkedForms: selectedLinkedForms
            };
            showNotification('Criterion updated successfully', 'success');
          }
        } else {
          // Add new criterion
          const newCriterion = {
            id: `CUST-${String(evaluationCriteriaIdCounter++).padStart(3, '0')}`,
            category: category,
            type: category, // Keep type for backwards compatibility
            criteria: name,
            description: description,
            evaluationMethod: method,
            maxPoints: method === 'Numeric' ? parseInt(maxPoints) : null,
            sustainableProcurement: selectedSP,
            appliesTo: appliesTo,
            lots: selectedLots,
            linkedForms: selectedLinkedForms,
            isPredefined: false
          };
          evaluationCriteria.push(newCriterion);
          showNotification('Criterion added successfully', 'success');
        }
        
        closeEvaluationCriterionModal();
        renderCurrentBlock();
      }
      
      window.removeEvaluationCriterion = function(criterionId) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (!criterion) return;
        
        if (criterion.isPredefined) {
          alert('Predefined criteria cannot be removed.');
          return;
        }
        
        if (confirm(`Are you sure you want to remove the criterion "${criterion.criteria}"?`)) {
          evaluationCriteria = evaluationCriteria.filter(c => c.id !== criterionId);
          renderCurrentBlock();
          showNotification('Criterion removed', 'info');
        }
      }
      
      // Helper function to get available UNSPSC codes for evaluation criteria
      function getAvailableUnspscCodes() {
        const codes = [];
        
        if (lots.length > 0) {
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              codes.push({
                code: unspsc.code,
                description: unspsc.description,
                lotId: lot.id,
                lotDescription: lot.description
              });
            });
          });
        } else {
          requisitionLines.forEach(line => {
            codes.push({
              code: line.unspscCode,
              description: line.unspscDescription
            });
          });
        }
        
        return codes;
      }

      function updateNavigationButtons() {
        // Footer removed - navigation via block tabs only
      }

      function attachAuthoringEventListeners() {
        document.querySelectorAll('.section-header').forEach((header) => {
          header.addEventListener('click', function() {
            toggleSection(this);
          });
        });

        document.querySelectorAll('.progress-step').forEach((step) => {
          step.addEventListener('click', function() {
            const stepNum = parseInt(this.dataset.step);
            if (stepNum <= currentAuthoringStep) {
              currentAuthoringStep = stepNum;
              updateProgressSteps();
            }
          });
        });
      }

      function updateProgressSteps() {
        document.querySelectorAll('.progress-step').forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.remove('active', 'completed');
          if (stepNum < currentAuthoringStep) {
            step.classList.add('completed');
          } else if (stepNum === currentAuthoringStep) {
            step.classList.add('active');
          }
        });
      }

      // ===== FORM LIBRARY FUNCTIONS =====
      let formLibraryOpen = false;

      function toggleFormLibrary() {
        const panel = document.getElementById('form-library-panel');
        const floatingBtn = document.getElementById('formLibraryFloatingBtn');
        
        formLibraryOpen = !formLibraryOpen;
        
        if (formLibraryOpen) {
          panel.classList.add('open');
          panel.classList.remove('collapsed');
          if (floatingBtn) floatingBtn.style.opacity = '0.3';
        } else {
          panel.classList.remove('open');
          panel.classList.add('collapsed');
          if (floatingBtn) floatingBtn.style.opacity = '1';
        }
      }

      // ===== CRITERIA LIBRARY FUNCTIONS =====
      
      // Mock data for criteria library (in real app, this would come from API)
      const criteriaLibraryData = [
        {
          id: 'CL001',
          tenderRef: 'TND-2024-0892',
          tenderName: 'IT Equipment Procurement - Phase II',
          unspscCode: '43211503',
          unspscDescription: 'Laptop computers',
          type: 'attributes',
          attributes: [
            { name: 'Processor', value: 'Intel Core i7 or AMD Ryzen 7' },
            { name: 'RAM', value: '16GB DDR4 minimum' },
            { name: 'Storage', value: '512GB SSD NVMe' },
            { name: 'Display', value: '15.6" FHD IPS' },
            { name: 'Warranty', value: '3 years on-site' }
          ],
          description: '',
          uploadedFile: null,
          date: '2024-11-15'
        },
        {
          id: 'CL002',
          tenderRef: 'TND-2024-0756',
          tenderName: 'Office Laptops for Regional Offices',
          unspscCode: '43211503',
          unspscDescription: 'Laptop computers',
          type: 'description',
          attributes: [],
          description: 'High-performance laptop computers for office use. Must include:\n- Latest generation Intel or AMD processors\n- Minimum 8GB RAM expandable to 32GB\n- 256GB SSD + 1TB HDD storage\n- Full HD display with anti-glare coating\n- Energy Star certified\n- Windows 11 Pro pre-installed',
          uploadedFile: null,
          date: '2024-10-22'
        },
        {
          id: 'CL003',
          tenderRef: 'TND-2024-0621',
          tenderName: 'Laptop Procurement for Field Operations',
          unspscCode: '43211503',
          unspscDescription: 'Laptop computers',
          type: 'upload',
          attributes: [],
          description: '',
          uploadedFile: { name: 'Laptop_Technical_Specifications_v2.pdf', size: '2.4 MB' },
          date: '2024-09-08'
        },
        {
          id: 'CL004',
          tenderRef: 'TND-2024-1023',
          tenderName: 'Network Equipment Upgrade',
          unspscCode: '43222600',
          unspscDescription: 'Network switches',
          type: 'attributes',
          attributes: [
            { name: 'Ports', value: '48 x Gigabit Ethernet' },
            { name: 'PoE Support', value: 'PoE+ (802.3at)' },
            { name: 'Management', value: 'Layer 2/3 managed' },
            { name: 'Stacking', value: 'Yes, up to 8 units' }
          ],
          description: '',
          uploadedFile: null,
          date: '2024-12-01'
        },
        {
          id: 'CL005',
          tenderRef: 'TND-2024-0445',
          tenderName: 'Server Infrastructure Renewal',
          unspscCode: '43211600',
          unspscDescription: 'Servers',
          type: 'attributes',
          attributes: [
            { name: 'Processor', value: 'Dual Intel Xeon Gold 6348' },
            { name: 'RAM', value: '256GB DDR4 ECC' },
            { name: 'Storage', value: '8 x 2.4TB SAS SSD RAID' },
            { name: 'Redundancy', value: 'Dual PSU, Hot-swap disks' }
          ],
          description: '',
          uploadedFile: null,
          date: '2024-08-17'
        },
        {
          id: 'CL006',
          tenderRef: 'TND-2024-0388',
          tenderName: 'Cleaning Services for Headquarters',
          unspscCode: '76111500',
          unspscDescription: 'Cleaning and janitorial services',
          type: 'description',
          attributes: [],
          description: 'Professional cleaning services for office premises including:\n- Daily general cleaning of all office areas\n- Weekly deep cleaning of kitchens and restrooms\n- Monthly carpet cleaning and window washing\n- Use of eco-friendly, certified cleaning products only\n- Staff must be properly trained and background-checked\n- Service hours: 6:00 PM - 10:00 PM Monday-Friday',
          uploadedFile: null,
          date: '2024-07-25'
        },
        {
          id: 'CL007',
          tenderRef: 'TND-2024-0912',
          tenderName: 'Medical Equipment for Field Clinics',
          unspscCode: '42181500',
          unspscDescription: 'Patient examination equipment',
          type: 'attributes',
          attributes: [
            { name: 'Examination Table', value: 'Hydraulic, height-adjustable' },
            { name: 'Blood Pressure Monitor', value: 'Digital, automatic' },
            { name: 'Stethoscope', value: 'Professional grade, dual-head' },
            { name: 'Otoscope/Ophthalmoscope', value: 'LED illumination' }
          ],
          description: '',
          uploadedFile: null,
          date: '2024-11-28'
        },
        {
          id: 'CL008',
          tenderRef: 'TND-2024-0567',
          tenderName: 'Vehicle Fleet Procurement',
          unspscCode: '25101500',
          unspscDescription: 'Passenger motor vehicles',
          type: 'upload',
          attributes: [],
          description: '',
          uploadedFile: { name: 'Vehicle_Specifications_4WD_SUV.pdf', size: '5.1 MB' },
          date: '2024-09-30'
        }
      ];
      
      let currentCriteriaUnspscCode = '';
      let currentCriteriaDescription = '';
      let selectedCriteriaItem = null;
      
      // Open Criteria Library Modal
      window.openCriteriaLibrary = function(unspscCode, description) {
        currentCriteriaUnspscCode = unspscCode;
        currentCriteriaDescription = description || '';
        selectedCriteriaItem = null;
        
        const modal = document.getElementById('criteria-library-modal');
        const searchInput = document.getElementById('criteria-library-search-input');
        const subtitleEl = document.getElementById('criteria-library-product-info');
        
        // Pre-fill search with UNSPSC code
        if (searchInput) {
          searchInput.value = unspscCode;
        }
        
        // Update subtitle
        if (subtitleEl) {
          subtitleEl.textContent = `${unspscCode} - ${description}`;
        }
        
        // Show modal
        modal.style.display = 'flex';
        
        // Search with pre-filled code
        searchCriteriaLibrary(unspscCode);
        
        // Focus search input
        setTimeout(() => {
          if (searchInput) searchInput.focus();
        }, 100);
      }
      
      // Close Criteria Library Modal
      window.closeCriteriaLibrary = function() {
        const modal = document.getElementById('criteria-library-modal');
        modal.style.display = 'none';
        selectedCriteriaItem = null;
      }
      
      // Search Criteria Library
      window.searchCriteriaLibrary = function(searchTerm) {
        const resultsContainer = document.getElementById('criteria-library-results');
        const footerInfo = document.getElementById('criteria-library-footer-info');
        
        if (!searchTerm || searchTerm.trim() === '') {
          resultsContainer.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <i class="pi pi-search" style="font-size: 32px; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
              <p style="font-weight: 600; margin-bottom: 4px;">Enter a UNSPSC code to search</p>
              <p style="font-size: 12px;">You can search by code or description keywords</p>
            </div>
          `;
          if (footerInfo) footerInfo.style.display = 'none';
          return;
        }
        
        const term = searchTerm.trim().toLowerCase();
        
        // Filter criteria by UNSPSC code or description
        const results = criteriaLibraryData.filter(item => 
          item.unspscCode.toLowerCase().includes(term) ||
          item.unspscDescription.toLowerCase().includes(term) ||
          item.tenderName.toLowerCase().includes(term)
        );
        
        if (results.length === 0) {
          resultsContainer.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <i class="pi pi-inbox" style="font-size: 32px; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
              <p style="font-weight: 600; margin-bottom: 4px;">No specifications found</p>
              <p style="font-size: 12px;">Try a different UNSPSC code or keywords</p>
            </div>
          `;
          if (footerInfo) footerInfo.style.display = 'none';
          return;
        }
        
        // Render results
        resultsContainer.innerHTML = results.map(item => renderCriteriaResultCard(item)).join('');
        if (footerInfo) {
          footerInfo.style.display = 'block';
          footerInfo.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 13px; color: var(--primary-700);">
                <i class="pi pi-list" style="margin-right: 6px;"></i>
                <strong>${results.length}</strong> specification${results.length !== 1 ? 's' : ''} found
              </span>
            </div>
          `;
        }
      }
      
      // Render criteria result card
      function renderCriteriaResultCard(item) {
        const typeLabel = item.type === 'attributes' ? 'Attributes' : 
                          item.type === 'description' ? 'Description' : 'File Upload';
        const typeIcon = item.type === 'attributes' ? 'pi-list' : 
                         item.type === 'description' ? 'pi-align-left' : 'pi-file';
        
        let contentHtml = '';
        if (item.type === 'attributes' && item.attributes.length > 0) {
          contentHtml = `
            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
              ${item.attributes.slice(0, 4).map(attr => `
                <span style="background: var(--surface-100); padding: 2px 8px; border-radius: 4px; font-size: 10px;">
                  <strong>${attr.name}:</strong> ${attr.value}
                </span>
              `).join('')}
              ${item.attributes.length > 4 ? `<span style="background: var(--surface-200); padding: 2px 8px; border-radius: 4px; font-size: 10px;">+${item.attributes.length - 4} more</span>` : ''}
            </div>
          `;
        } else if (item.type === 'description' && item.description) {
          contentHtml = `
            <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.4; margin-top: 8px;">${item.description.substring(0, 150)}${item.description.length > 150 ? '...' : ''}</div>
          `;
        } else if (item.type === 'upload' && item.uploadedFile) {
          contentHtml = `
            <div style="display: flex; align-items: center; gap: 6px; margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
              <i class="pi pi-file" style="color: var(--primary-500);"></i>
              <span>${item.uploadedFile.name} (${item.uploadedFile.size})</span>
            </div>
          `;
        }
        
        return `
          <div class="criteria-library-result-card" onclick="selectCriteriaItem('${item.id}')" data-criteria-id="${item.id}" style="padding: 12px; border: 2px solid var(--surface-200); border-radius: var(--radius-md); background: var(--surface-0); cursor: pointer; transition: all 0.2s; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-primary); font-size: 13px; line-height: 1.3;">${item.tenderName}</div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                  <span style="font-family: monospace; background: var(--surface-100); padding: 1px 4px; border-radius: 3px;">${item.tenderRef}</span>
                  ¬∑ ${item.unspscCode} ¬∑ ${item.date}
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="background: var(--info-50); color: var(--info-700); padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;">
                  <i class="pi ${typeIcon}" style="font-size: 9px; margin-right: 4px;"></i>${typeLabel}
                </span>
              </div>
            </div>
            ${contentHtml}
          </div>
        `;
      }
      
      // Select criteria item
      window.selectCriteriaItem = function(itemId) {
        // Remove previous selection
        document.querySelectorAll('.criteria-library-result-card').forEach(card => {
          card.classList.remove('selected');
          card.style.borderColor = 'var(--surface-200)';
          card.style.background = 'var(--surface-0)';
        });
        
        // Add selection to clicked card
        const card = document.querySelector(`.criteria-library-result-card[data-criteria-id="${itemId}"]`);
        if (card) {
          card.classList.add('selected');
          card.style.borderColor = 'var(--primary-500)';
          card.style.background = 'var(--primary-50)';
        }
        
        // Store selected item
        selectedCriteriaItem = criteriaLibraryData.find(item => item.id === itemId);
      }
      
      // Apply selected criteria
      window.applyCriteriaFromLibrary = function() {
        if (!selectedCriteriaItem) {
          showNotification('Please select a specification to apply.', 'warning');
          return;
        }
        
        const unspscCode = currentCriteriaUnspscCode;
        
        // Initialize product requirements if needed
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '', uploadedFile: null };
        }
        
        // Apply the selected criteria
        if (selectedCriteriaItem.type === 'attributes') {
          productRequirements[unspscCode].requirementType = 'attributes';
          productRequirements[unspscCode].attributes = selectedCriteriaItem.attributes.map(attr => ({
            name: attr.name,
            value: attr.value
          }));
          productRequirements[unspscCode].description = '';
        } else if (selectedCriteriaItem.type === 'description') {
          productRequirements[unspscCode].requirementType = 'description';
          productRequirements[unspscCode].description = selectedCriteriaItem.description;
          productRequirements[unspscCode].attributes = [];
        } else if (selectedCriteriaItem.type === 'upload') {
          productRequirements[unspscCode].uploadedFile = {
            name: selectedCriteriaItem.uploadedFile.name,
            size: selectedCriteriaItem.uploadedFile.size,
            fromLibrary: true
          };
        }
        
        // Update the UI
        updateProductReqBodyContent(unspscCode);
        updateProductReqStatus(unspscCode);
        
        // Close modal
        closeCriteriaLibrary();
        
        // Show success message
        showNotification(`Specifications from "${selectedCriteriaItem.tenderName}" applied successfully!`, 'success');
      }
      
      // Handle Enter key in search
      window.handleCriteriaSearchKeyup = function(event) {
        if (event.key === 'Enter') {
          searchCriteriaLibrary(event.target.value);
        }
      }

      // Initialize - Authoring page auto-starts
      document.addEventListener('DOMContentLoaded', function() {
        // Load data from localStorage (from tender-create.html wizard)
        const hasData = loadTenderInitData();
        
        // Initialize authoring view
        initAuthoring();
        
        // Show success message if data was loaded
        if (hasData && wizardData.title) {
          showSuccessMessage();
        }
        
        // Close project search dropdown when clicking outside
        document.addEventListener('click', function(event) {
          const dropdowns = document.querySelectorAll('.project-search-dropdown');
          dropdowns.forEach(dropdown => {
            const parentGroup = dropdown.closest('.form-group');
            if (parentGroup && !parentGroup.contains(event.target)) {
              dropdown.style.display = 'none';
            }
          });
        });
        
        console.log('Tender authoring page initialized');
      });
    </script>

    <!-- Tender Selection Modal for Cloning -->
    <div class="modal-overlay" id="tender-selection-modal" onclick="if(event.target === this) closeTenderSelectionModal()">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title">Select Tender to Clone</div>
            <div class="modal-subtitle">Choose an existing tender to use as a starting point</div>
          </div>
          <button class="modal-close-btn" onclick="closeTenderSelectionModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="modal-search">
            <input type="search" placeholder="Search by tender title or reference number..." 
                   oninput="filterExistingTenders(this.value)" />
          </div>
          <div class="existing-tenders-list" id="existing-tenders-list">
            <!-- Tender cards will be dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Lifecycle Process Search Modal -->
    <div class="lifecycle-search-modal" id="lifecycle-search-modal" onclick="if(event.target === this) closeLifecycleSearch()">
      <div class="lifecycle-search-content">
        <div class="lifecycle-search-header">
          <div>
            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
              Link Procurement Process
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              Search and select a process to link to this tender
            </div>
          </div>
          <button class="modal-close-btn" onclick="closeLifecycleSearch()">‚úï</button>
        </div>
        <div class="lifecycle-search-body">
          <div class="lifecycle-search-input-wrapper">
            <span class="lifecycle-search-icon">üîç</span>
            <input 
              type="search" 
              class="lifecycle-search-input" 
              placeholder="Search by Process ID, title, or type..." 
              oninput="searchLifecycleProcesses(this.value)"
            />
          </div>
          <div class="lifecycle-search-results" id="lifecycle-search-results">
            <!-- Results will be dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add Requisition Line Modal (for left container) -->
    <div class="req-modal" id="add-req-line-modal" onclick="if(event.target === this) closeAddRequisitionLinesModal()">
      <div class="req-modal-content" style="max-width: 600px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-list" style="margin-right: 6px;"></i>Add Requisition Lines</span>
          <button class="modal-close-btn" onclick="closeAddRequisitionLinesModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: 0;">
          <!-- Info Banner -->
          <div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--info-50); border-bottom: 1px solid var(--info-200); font-size: 11px; color: var(--info-700);">
            <i class="pi pi-info-circle" style="margin-right: 4px;"></i>
            Select requisition lines from ERP to add to your tender. These will appear in the left "Requisition Lines" panel.
          </div>
          <!-- Filter and Select All Row -->
          <div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--surface-50); border-bottom: 1px solid var(--surface-200); display: flex; gap: var(--spacing-md); align-items: center;">
            <div style="flex: 1; position: relative;">
              <i class="pi pi-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px;"></i>
              <input type="text" id="req-lines-filter-input" placeholder="Search by ID, code, description, official..." 
                style="width: 100%; padding: 6px 10px 6px 30px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm); font-size: 12px;"
                oninput="filterReqLinesModal(this.value)" />
            </div>
            <div style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
              <input type="checkbox" id="req-lines-select-all" onchange="toggleReqLinesSelectAll(this.checked)" style="cursor: pointer;" />
              <label for="req-lines-select-all" style="font-size: 11px; color: var(--text-secondary); cursor: pointer;">Select All</label>
            </div>
            <span id="req-lines-selected-count" style="font-size: 10px; color: var(--primary-600); font-weight: 600; min-width: 60px;"></span>
          </div>
          <!-- Requisition Lines List -->
          <div id="add-req-line-body" style="max-height: 350px; overflow-y: auto; padding: var(--spacing-sm) var(--spacing-md);">
          <!-- Options will be populated here -->
        </div>
        </div>
        <div class="req-modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
          <span id="req-lines-total-count" style="font-size: 11px; color: var(--text-muted);"></span>
          <div style="display: flex; gap: var(--spacing-sm);">
            <button class="btn btn-ghost btn-sm" onclick="closeAddRequisitionLinesModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="addSelectedRequisitionLines()"><i class="pi pi-plus" style="margin-right: 4px;"></i>Add Selected</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Products and Services Modal -->
    <div class="req-modal" id="add-products-services-modal" onclick="if(event.target === this) closeAddProductsServicesModal()">
      <div class="req-modal-content" style="max-width: 600px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-shopping-cart" style="margin-right: 6px;"></i>Add Products and Services</span>
          <button class="modal-close-btn" onclick="closeAddProductsServicesModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: 0;">
          <div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--info-50); border-bottom: 1px solid var(--info-200); font-size: 11px; color: var(--info-700);">
            <i class="pi pi-info-circle" style="margin-right: 4px;"></i>
            Items added here will be visible to suppliers. Pick from Requisition Lines or create new products.
          </div>
          <div class="product-modal-tabs">
            <button class="product-modal-tab active" data-tab="from-requisition" onclick="switchProductsServicesModalTab('from-requisition')"><i class="pi pi-list" style="margin-right: 4px;"></i>From Requisition Lines</button>
            <button class="product-modal-tab" data-tab="new-product" onclick="switchProductsServicesModalTab('new-product')"><i class="pi pi-plus" style="margin-right: 4px;"></i>Create New</button>
          </div>
          
          <!-- From Requisition Lines Tab -->
          <div class="product-modal-tab-content active" id="ps-tab-from-requisition" style="padding: 0;">
            <!-- Filter and Select All Row -->
            <div style="padding: var(--spacing-sm) var(--spacing-md); background: var(--surface-50); border-bottom: 1px solid var(--surface-200); display: flex; gap: var(--spacing-md); align-items: center;">
              <div style="flex: 1; position: relative;">
                <i class="pi pi-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 12px;"></i>
                <input type="text" id="ps-req-filter-input" placeholder="Search by ID, code, description..." 
                  style="width: 100%; padding: 6px 10px 6px 30px; border: 1px solid var(--surface-300); border-radius: var(--radius-sm); font-size: 12px;"
                  oninput="filterPSReqLinesModal(this.value)" />
              </div>
              <div style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                <input type="checkbox" id="ps-req-select-all" onchange="togglePSReqSelectAll(this.checked)" style="cursor: pointer;" />
                <label for="ps-req-select-all" style="font-size: 11px; color: var(--text-secondary); cursor: pointer;">Select All</label>
              </div>
              <span id="ps-req-selected-count" style="font-size: 10px; color: var(--primary-600); font-weight: 600; min-width: 60px;"></span>
            </div>
            <div id="add-products-services-req-lines" style="max-height: 350px; overflow-y: auto; padding: var(--spacing-md);">
              <!-- Requisition lines will be populated here -->
            </div>
          </div>
          
          <!-- Create New Product/Service Tab -->
          <div class="product-modal-tab-content" id="ps-tab-new-product" style="padding: var(--spacing-md);">
            <div class="new-product-form">
              <div class="form-group">
                <label class="form-label">UNSPSC Code <span class="required">*</span></label>
                <div class="unspsc-search-container">
                  <input type="text" id="new-ps-unspsc-search" class="unspsc-search-input" placeholder="Search by code or description..." autocomplete="off" />
                  <input type="hidden" id="new-ps-unspsc" />
                  <div class="unspsc-dropdown" id="unspsc-dropdown">
                    <!-- Options populated by JavaScript -->
                  </div>
                </div>
                <!-- Category Indicator - shown when Category 2/3 UNSPSC is selected -->
                <div id="unspsc-category-indicator" style="display: none;"></div>
                <div class="unspsc-info-message">
                  <i class="pi pi-info-circle"></i>
                  <span>  Can't find the UNSPSC code you need? If the code exists in the 
  <a href="https://www.ungm.org/Public/UNSPSC" target="_blank">UNGM UNSPSC list</a>, 
  it can be added to oneUNOPS / ERP upon request. 
  Please contact the <strong>Data and Analytics team</strong> to request the addition.</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description <span class="required">*</span></label>
                <input type="text" id="new-ps-desc" class="form-input" placeholder="Automatically populated from the selected UNSPSC code. Editable if needed." style="font-size: 13px;" readonly />
              </div>
              <div class="form-group">
                <label class="form-label">Product Text</label>
                <textarea id="new-ps-product-text" class="form-textarea" placeholder="Additional details about the product or service (optional)..." style="min-height: 60px; font-size: 13px; resize: vertical;"></textarea>
              </div>
              <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                <div class="form-group">
                  <label class="form-label">Quantity</label>
                  <input type="number" id="new-ps-qty" class="form-input" value="1" min="1" style="font-size: 13px;" />
                </div>
                <div class="form-group">
                  <label class="form-label">Unit of Measure</label>
                  <select id="new-ps-uom" class="form-select" style="font-size: 13px;">
                    <option value="Unit">Unit</option>
                    <option value="Lot">Lot</option>
                    <option value="Service">Service</option>
                    <option value="Pack">Pack</option>
                    <option value="Box">Box</option>
                    <option value="Set">Set</option>
                    <option value="Piece">Piece</option>
                    <option value="Month">Month</option>
                    <option value="Year">Year</option>
                    <option value="Kg">Kg</option>
                    <option value="Liter">Liter</option>
                    <option value="Meter">Meter</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Estimated Value (USD)</label>
                <input type="number" id="new-ps-value" class="form-input" placeholder="0.00" min="0" step="0.01" style="font-size: 13px;" />
              </div>
              <div class="form-group">
                <label class="form-label">Linked Requisition <span class="required">*</span></label>
                <select id="new-ps-linked-req" class="form-select" style="font-size: 13px;" required>
                  <option value="">-- Select requisition line --</option>
                  <!-- Options will be populated dynamically -->
                </select>
                <span class="help-text">Select the requisition line this product is linked to</span>
              </div>
            </div>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeAddProductsServicesModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" id="add-ps-confirm-btn" onclick="addProductsServicesFromRequisition()">Add Selected</button>
        </div>
      </div>
    </div>

    <!-- Create Lot Modal -->
    <div class="req-modal" id="create-lot-modal" onclick="if(event.target === this) closeCreateLotModal()">
      <div class="req-modal-content" style="max-width: 400px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-th-large" style="margin-right: 6px;"></i>Create New Lot</span>
          <button class="modal-close-btn" onclick="closeCreateLotModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-md);">
          <div class="form-group">
            <label class="form-label">Description <span class="required">*</span></label>
            <textarea id="new-lot-desc-input" class="form-textarea" placeholder="Brief description of this lot..." style="min-height: 80px; font-size: 13px;"></textarea>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeCreateLotModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="createLotFromModal()">Create Lot</button>
        </div>
      </div>
    </div>

    <!-- Add Product to Lot Modal -->
    <div class="req-modal" id="add-product-modal" onclick="if(event.target === this) closeAddProductModal()">
      <div class="req-modal-content" style="max-width: 500px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-plus" style="margin-right: 6px;"></i>Add Products to Lot</span>
          <button class="modal-close-btn" onclick="closeAddProductModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-md);">
          <div style="padding: var(--spacing-sm); margin-bottom: var(--spacing-md); background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm); font-size: 11px; color: var(--info-700);">
            <i class="pi pi-info-circle" style="margin-right: 4px;"></i>
            Select products from Products and Services to add to this lot. Only unassigned items are shown.
          </div>
          <div id="add-product-req-lines" style="max-height: 350px; overflow-y: auto;">
            <!-- Products from Products and Services will be populated here -->
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeAddProductModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" id="add-product-confirm-btn" onclick="addProductsFromRequisition()">Add Selected</button>
        </div>
      </div>
    </div>

    <!-- Edit Lot Modal -->
    <div class="req-modal" id="edit-lot-modal" onclick="if(event.target === this) closeEditLotModal()">
      <div class="req-modal-content" style="max-width: 400px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-pencil" style="margin-right: 6px;"></i>Edit Lot</span>
          <button class="modal-close-btn" onclick="closeEditLotModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-md);">
          <input type="hidden" id="edit-lot-id" />
          <div class="form-group">
            <label class="form-label">Description <span class="required">*</span></label>
            <textarea id="edit-lot-desc-input" class="form-textarea" placeholder="Brief description of this lot..." style="min-height: 80px; font-size: 13px;"></textarea>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeEditLotModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="saveEditLot()">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Evaluation Criterion Modal - Enhanced with all fields -->
    <div class="req-modal" id="evaluation-criterion-modal" onclick="if(event.target === this) closeEvaluationCriterionModal()">
      <div class="req-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div class="req-modal-header">
          <span class="req-modal-title" id="eval-criterion-modal-title"><i class="pi pi-plus-circle"></i> Add Evaluation Criterion</span>
          <button class="modal-close-btn" onclick="closeEvaluationCriterionModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-lg);">
          <input type="hidden" id="eval-criterion-id" />
          
          <!-- ID (auto-generated, shown in edit mode) -->
          <div class="form-group" id="eval-criterion-id-display" style="display: none;">
            <label class="form-label">Criterion ID</label>
            <input type="text" id="eval-criterion-id-readonly" class="form-input" readonly style="background: var(--surface-50); color: var(--text-muted);" />
          </div>
          
          <!-- Category & Criteria Name Row -->
          <div style="display: grid; grid-template-columns: 180px 1fr; gap: var(--spacing-md);">
            <div class="form-group">
              <label class="form-label">Category <span class="required-indicator">*</span></label>
              <select id="eval-criterion-category" class="form-select">
                <option value="Eligibility & Formal">Eligibility & Formal</option>
                <option value="Qualification">Qualification</option>
                <option value="Technical">Technical</option>
              </select>
            </div>
          <div class="form-group">
            <label class="form-label">Criteria Name <span class="required-indicator">*</span></label>
            <input type="text" id="eval-criterion-name" class="form-input" placeholder="e.g., ISO Certification, Financial Capacity, etc." />
            </div>
          </div>
          
          <!-- Description -->
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label class="form-label">Criteria Description <span class="required-indicator">*</span></label>
            <textarea id="eval-criterion-description" class="form-textarea" placeholder="Describe how this criterion will be evaluated..." style="min-height: 80px;"></textarea>
            </div>
          
          <!-- Method & Max Points Row -->
          <div style="display: grid; grid-template-columns: 1fr 120px; gap: var(--spacing-md); margin-top: var(--spacing-md);">
            <div class="form-group">
              <label class="form-label">Evaluation Method <span class="required-indicator">*</span></label>
              <select id="eval-criterion-method" class="form-select" onchange="toggleMaxPointsField(this.value)">
                <option value="Pass/Fail">Pass/Fail</option>
                <option value="Numeric">Numeric</option>
              </select>
              <div id="eval-criterion-method-notice" style="display: none; font-size: 11px; color: var(--info-600); background: var(--info-50); padding: 6px 10px; border-radius: var(--radius-sm); margin-top: 6px; border-left: 3px solid var(--info-400);">
                <i class="pi pi-info-circle" style="margin-right: 4px;"></i>Numeric scoring is only available when Evaluation Method is set to "Cumulative analysis"
              </div>
            </div>
            <div class="form-group" id="eval-criterion-maxpoints-group" style="display: none;">
              <label class="form-label">Max Points <span class="required-indicator">*</span></label>
              <input type="number" id="eval-criterion-maxpoints" class="form-input" placeholder="e.g., 100" min="1" max="1000" />
            </div>
          </div>
          
          <!-- Sustainable Procurement Category -->
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label class="form-label">Sustainable Procurement Category</label>
            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Select one or more sustainable procurement categories (optional)</div>
            <div id="eval-criterion-sp-container" style="max-height: 180px; overflow-y: auto; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-sm); background: var(--surface-50);">
              <!-- Gender and Social Inclusion -->
              <div style="margin-bottom: 8px;">
                <div style="font-weight: 600; font-size: 11px; color: var(--success-700); margin-bottom: 4px; padding: 2px 6px; background: var(--success-50); border-radius: 3px; display: inline-block;">
                  <i class="pi pi-users" style="font-size: 10px; margin-right: 4px;"></i>Gender and Social Inclusion
                </div>
                <div style="padding-left: 12px;">
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Gender and Social Inclusion - Equality opportunity, Diversity and inclusion" style="margin-top: 2px;" />
                    <span>Equality opportunity, Diversity and inclusion</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Gender and Social Inclusion - Gender and social inclusion mainstreaming" style="margin-top: 2px;" />
                    <span>Gender and social inclusion mainstreaming</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Gender and Social Inclusion - Labor opportunities for women and/or traditionally disadvantaged groups" style="margin-top: 2px;" />
                    <span>Labor opportunities for women and/or traditionally disadvantaged groups</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Gender and Social Inclusion - Youth inclusion and partnership with youth" style="margin-top: 2px;" />
                    <span>Youth inclusion and partnership with youth</span>
                  </label>
                </div>
              </div>
              <!-- Health and Safety -->
              <div style="margin-bottom: 8px;">
                <div style="font-weight: 600; font-size: 11px; color: var(--warning-700); margin-bottom: 4px; padding: 2px 6px; background: var(--warning-50); border-radius: 3px; display: inline-block;">
                  <i class="pi pi-heart" style="font-size: 10px; margin-right: 4px;"></i>Health and Safety
                </div>
                <div style="padding-left: 12px;">
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Health and Safety - Emergency preparedness" style="margin-top: 2px;" />
                    <span>Emergency preparedness</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Health and Safety - Incidents/accidents tracking system" style="margin-top: 2px;" />
                    <span>Incidents/accidents tracking system</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Health and Safety - Security and safety of workers" style="margin-top: 2px;" />
                    <span>Security and safety of workers</span>
                  </label>
                </div>
              </div>
              <!-- Labor Standards -->
              <div style="margin-bottom: 8px;">
                <div style="font-weight: 600; font-size: 11px; color: var(--danger-700); margin-bottom: 4px; padding: 2px 6px; background: var(--danger-50); border-radius: 3px; display: inline-block;">
                  <i class="pi pi-briefcase" style="font-size: 10px; margin-right: 4px;"></i>Labor Standards
                </div>
                <div style="padding-left: 12px;">
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Labor Standards - Child Labor" style="margin-top: 2px;" />
                    <span>Child Labor</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Labor Standards - Forced labour and human trafficking" style="margin-top: 2px;" />
                    <span>Forced labour and human trafficking</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Labor Standards - Grievance mechanism" style="margin-top: 2px;" />
                    <span>Grievance mechanism</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Labor Standards - Hiring of local labour" style="margin-top: 2px;" />
                    <span>Hiring of local labour</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Labor Standards - Labor risks along the supply chain" style="margin-top: 2px;" />
                    <span>Labor risks along the supply chain</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Labor Standards - Suppliers and Contractors selection and management" style="margin-top: 2px;" />
                    <span>Suppliers and Contractors selection and management</span>
                  </label>
                </div>
              </div>
              <!-- Resource Efficiency -->
              <div>
                <div style="font-weight: 600; font-size: 11px; color: var(--info-700); margin-bottom: 4px; padding: 2px 6px; background: var(--info-50); border-radius: 3px; display: inline-block;">
                  <i class="pi pi-globe" style="font-size: 10px; margin-right: 4px;"></i>Resource Efficiency
                </div>
                <div style="padding-left: 12px;">
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Resource Efficiency - Energy efficiency measures" style="margin-top: 2px;" />
                    <span>Energy efficiency measures</span>
                  </label>
                  <label style="display: flex; align-items: flex-start; gap: 6px; cursor: pointer; padding: 3px 0; font-size: 12px;">
                    <input type="checkbox" class="eval-sp-checkbox" value="Resource Efficiency - Water conservation and management" style="margin-top: 2px;" />
                    <span>Water conservation and management</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Apply To Section -->
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label class="form-label">Apply To <span class="required-indicator">*</span></label>
            <div style="display: flex; gap: var(--spacing-lg); margin-top: 6px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="radio" name="eval-criterion-applies" value="tender" checked onchange="toggleEvalCriterionAppliesTo(this.value)" />
                <span><i class="pi pi-globe" style="font-size: 11px; margin-right: 4px;"></i>Tender Level</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="radio" name="eval-criterion-applies" value="lots" onchange="toggleEvalCriterionAppliesTo(this.value)" />
                <span><i class="pi pi-th-large" style="font-size: 11px; margin-right: 4px;"></i>Lot Level</span>
              </label>
            </div>
          </div>
          
          <!-- Lot Selection (hidden by default) -->
          <div id="eval-criterion-specific-section" style="display: none; margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
            <div class="form-group">
              <label class="form-label" style="font-size: 12px;">Select Lots</label>
              <select id="eval-criterion-lots" class="form-select" multiple size="4" style="width: 100%;">
                <!-- Populated dynamically -->
              </select>
              <span class="help-text" style="font-size: 11px;">Hold Ctrl/Cmd to select multiple lots</span>
            </div>
          </div>
          
          <!-- Linked Forms Section -->
          <div class="form-group" style="margin-top: var(--spacing-md);">
            <label class="form-label">Linked Forms</label>
            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Link this criterion to specific forms where suppliers will provide information (optional)</div>
            <div id="eval-criterion-linked-forms-container" style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-sm); background: var(--surface-50); max-height: 120px; overflow-y: auto;">
              <!-- Populated dynamically with available forms -->
            </div>
          </div>
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeEvaluationCriterionModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="saveEvaluationCriterion()" id="eval-criterion-save-btn">
            <i class="pi pi-check"></i> Add Criterion
          </button>
        </div>
      </div>
    </div>

    <!-- Link Forms to Criterion Modal -->
    <div class="req-modal" id="link-forms-modal" onclick="if(event.target === this) closeLinkFormsModal()">
      <div class="req-modal-content" style="max-width: 500px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-link" style="margin-right: 8px;"></i><span id="link-forms-modal-title">Link Forms</span></span>
          <button class="modal-close-btn" onclick="closeLinkFormsModal()">‚úï</button>
        </div>
        <div class="req-modal-body" id="link-forms-modal-body" style="padding: var(--spacing-lg);">
          <!-- Content will be dynamically generated -->
        </div>
      </div>
    </div>

    <!-- Evaluation Criteria Library Modal -->
    <div class="req-modal" id="eval-criteria-library-modal" onclick="if(event.target === this) closeCriteriaLibraryModal()">
      <div class="req-modal-content" style="max-width: 900px; max-height: 90vh;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-book" style="margin-right: 8px;"></i>Evaluation Criteria Library</span>
          <button class="modal-close-btn" onclick="closeCriteriaLibraryModal()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-lg); overflow-y: auto;">
          <!-- Info Banner -->
          <div style="background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-md); padding: 12px 16px; margin-bottom: var(--spacing-md); display: flex; align-items: flex-start; gap: 10px;">
            <i class="pi pi-info-circle" style="color: var(--info-600); font-size: 16px; margin-top: 2px;"></i>
            <div style="font-size: 12px; color: var(--info-800); line-height: 1.5;">
              Select criteria from the library to add to your tender. You can customize the criteria (description, method, max points, sustainable procurement categories, and linked forms) after adding them.
            </div>
          </div>
          
          <!-- Search and Filter Row -->
          <div style="display: flex; gap: var(--spacing-md); align-items: center; margin-bottom: var(--spacing-md); flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <div style="position: relative;">
                <i class="pi pi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;"></i>
                <input type="text" id="eval-criteria-library-search" class="form-input" placeholder="Search by name, description or SP category..." oninput="filterCriteriaLibrary(this.value)" style="width: 100%; padding-left: 36px;" />
              </div>
            </div>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
              <button class="criteria-filter-btn active" onclick="filterCriteriaByCategory('all', this)" style="font-size: 11px; padding: 6px 12px;">All</button>
              <button class="criteria-filter-btn" onclick="filterCriteriaByCategory('Eligibility & Formal', this)" style="font-size: 11px; padding: 6px 12px; background: #f0f4f8; color: #5b7c99; border: 1px solid #d9e2ec;">Eligibility</button>
              <button class="criteria-filter-btn" onclick="filterCriteriaByCategory('Qualification', this)" style="font-size: 11px; padding: 6px 12px; background: #f0f4f8; color: #627d98; border: 1px solid #d9e2ec;">Qualification</button>
              <button class="criteria-filter-btn" onclick="filterCriteriaByCategory('Technical', this)" style="font-size: 11px; padding: 6px 12px; background: #f0f4f8; color: #486581; border: 1px solid #d9e2ec;">Technical</button>
            </div>
          </div>
          
          <!-- Legend -->
          <div style="display: flex; gap: 16px; margin-bottom: var(--spacing-md); font-size: 11px; color: var(--text-muted); flex-wrap: wrap;">
            <span><i class="pi pi-check-square" style="margin-right: 4px;"></i>Pass/Fail = Go/No-Go criteria</span>
            <span><i class="pi pi-chart-bar" style="margin-right: 4px;"></i>Numeric = Scored criteria</span>
            <span><i class="pi pi-leaf" style="margin-right: 4px; color: var(--success-600);"></i>SP = Sustainable Procurement linked</span>
          </div>
          
          <!-- Criteria Grid -->
          <div class="criteria-library-grid" id="eval-criteria-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 12px; max-height: 450px; overflow-y: auto; padding-right: 4px;">
            <!-- Populated dynamically -->
          </div>
          
          <!-- Selected count -->
          <div id="eval-criteria-library-selected-info" style="margin-top: var(--spacing-md); padding: 12px 16px; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius-md); display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; color: var(--primary-700);">
              <i class="pi pi-check-circle" style="margin-right: 6px;"></i>
              <strong id="eval-criteria-library-selected-count">0</strong> criteria selected
            </span>
              <button class="btn btn-ghost btn-xs" onclick="clearLibrarySelection()" style="font-size: 11px;">Clear Selection</button>
          </div>
        </div>
        </div>
        <div class="req-modal-footer" style="border-top: 1px solid var(--surface-200); padding: 12px 20px;">
          <button class="btn btn-ghost btn-sm" onclick="closeCriteriaLibraryModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="addSelectedCriteriaFromLibrary()" id="add-eval-criteria-from-library-btn" disabled>
            <i class="pi pi-plus"></i> Add Selected (<span id="add-eval-criteria-count">0</span>)
          </button>
        </div>
      </div>
    </div>

    <!-- Lots Upload Preview Modal -->
    <div class="req-modal" id="lots-upload-preview-modal" onclick="if(event.target === this) closeLotsUploadPreviewModal()">
      <div class="req-modal-content" style="max-width: 600px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-upload" style="margin-right: 6px;"></i>Import Lots Preview</span>
          <button class="modal-close-btn" onclick="closeLotsUploadPreviewModal()">‚úï</button>
        </div>
        <div class="req-modal-body" id="lots-upload-preview-body" style="padding: var(--spacing-md);">
          <!-- Preview content will be populated here -->
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeLotsUploadPreviewModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="confirmLotsUpload()">Import All Lots</button>
        </div>
      </div>
    </div>

    <!-- Products and Services Upload Preview Modal -->
    <div class="req-modal" id="products-services-upload-preview-modal" onclick="if(event.target === this) closeProductsServicesUploadPreviewModal()">
      <div class="req-modal-content" style="max-width: 800px;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-upload" style="margin-right: 6px;"></i>Import Products & Services Preview</span>
          <button class="modal-close-btn" onclick="closeProductsServicesUploadPreviewModal()">‚úï</button>
        </div>
        <div class="req-modal-body" id="products-services-upload-preview-body" style="padding: var(--spacing-md);">
          <!-- Preview content will be populated here -->
        </div>
        <div class="req-modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeProductsServicesUploadPreviewModal()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="confirmProductsServicesUpload()">Import All Products & Services</button>
        </div>
      </div>
    </div>

    <!-- Form Preview Modal (Supplier View) -->
    <div class="form-preview-modal" id="form-preview-modal" onclick="if(event.target === this) closeFormPreviewModal()">
      <div class="form-preview-content">
        <div class="form-preview-header">
          <div class="form-preview-header-title">
            <i class="pi pi-eye"></i>
            <h3 id="form-preview-title">Form Preview</h3>
            <span class="preview-badge">Supplier View</span>
          </div>
          <button class="modal-close-btn" onclick="closeFormPreviewModal()" style="color: white; background: rgba(255,255,255,0.2);">‚úï</button>
        </div>
        <div class="form-preview-body" id="form-preview-body">
          <!-- Form preview content will be populated here -->
        </div>
        <div class="form-preview-footer">
          <button class="btn btn-secondary" onclick="closeFormPreviewModal()">Close Preview</button>
        </div>
      </div>
    </div>

    <!-- Add Form Document Modal -->
    <div class="form-preview-modal" id="add-form-document-modal" onclick="if(event.target === this) closeAddFormDocumentModal()">
      <div class="form-preview-content" style="max-width: 600px;">
        <div class="form-preview-header" style="background: linear-gradient(135deg, var(--primary-600), var(--primary-700));">
          <div class="form-preview-header-title">
            <i class="pi pi-file-edit"></i>
            <h3>Add Form Template</h3>
          </div>
          <button class="modal-close-btn" onclick="closeAddFormDocumentModal()" style="color: white; background: rgba(255,255,255,0.2);">‚úï</button>
        </div>
        <div class="form-preview-body" style="padding: var(--spacing-lg); max-height: 60vh; overflow-y: auto;">
          <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
            <div class="info-alert-text">
              <i class="pi pi-info-circle" style="margin-right: 6px;"></i> Select form templates to include as tender documents. These will be available for suppliers to download.
            </div>
          </div>
          <div id="form-document-list">
            <!-- Form list will be populated here -->
          </div>
        </div>
        <div class="form-preview-footer">
          <button class="btn btn-secondary" onclick="closeAddFormDocumentModal()">Done</button>
        </div>
      </div>
    </div>

    <!-- Form Configuration Modal -->
    <div class="form-config-modal" id="form-config-modal" onclick="if(event.target === this) closeFormConfigModal()">
      <div class="form-config-content">
        <div class="form-config-header">
          <h3><i class="pi pi-cog"></i> <span id="form-config-title">Configure Form</span></h3>
          <button class="modal-close-btn" onclick="closeFormConfigModal()" style="color: white; background: rgba(255,255,255,0.2);">‚úï</button>
        </div>
        <div class="form-config-body" id="form-config-body">
          <!-- Form configuration options will be populated here -->
        </div>
        <div class="form-config-footer">
          <button class="btn btn-secondary" onclick="closeFormConfigModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveFormConfig()"><i class="pi pi-check"></i> Save Configuration</button>
        </div>
      </div>
    </div>

    <!-- Form Attachment Modal -->
    <div class="form-attachment-modal" id="form-attachment-modal" onclick="if(event.target === this) closeFormAttachmentModal()">
      <div class="form-attachment-content">
        <div class="form-attachment-header">
          <h3><i class="pi pi-paperclip"></i> <span id="form-attachment-title">Attachments</span></h3>
          <button class="modal-close-btn" onclick="closeFormAttachmentModal()" style="color: white; background: rgba(255,255,255,0.2);">‚úï</button>
        </div>
        <div class="form-attachment-body" id="form-attachment-body">
          <input type="hidden" id="form-attachment-form-id" />
          
          <!-- Drop Zone -->
          <div class="attachment-drop-zone" id="attachment-drop-zone" 
               onclick="document.getElementById('attachment-file-input').click()"
               ondragover="handleAttachmentDragOver(event)"
               ondragleave="handleAttachmentDragLeave(event)"
               ondrop="handleAttachmentDrop(event)">
            <div class="attachment-drop-zone-icon">üìé</div>
            <div class="attachment-drop-zone-text">Drop files here or click to upload</div>
            <div class="attachment-drop-zone-hint">Supported: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (max 10MB each)</div>
            <input type="file" id="attachment-file-input" style="display: none;" 
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                   multiple
                   onchange="handleAttachmentFileSelect(this.files)" />
          </div>
          
          <!-- Attachment List -->
          <div class="attachment-list" id="attachment-list">
            <!-- Attachments will be populated here -->
          </div>
        </div>
        <div class="form-attachment-footer">
          <button class="btn btn-secondary" onclick="closeFormAttachmentModal()">Close</button>
          <button class="btn btn-primary" onclick="saveFormAttachments()"><i class="pi pi-check"></i> Save</button>
        </div>
      </div>
    </div>

    <!-- Criteria Library Modal -->
    <div class="req-modal" id="criteria-library-modal" onclick="if(event.target === this) closeCriteriaLibrary()">
      <div class="req-modal-content" style="max-width: 900px; max-height: 90vh;">
        <div class="req-modal-header">
          <span class="req-modal-title"><i class="pi pi-book" style="margin-right: 8px;"></i>Criteria Library</span>
          <button class="modal-close-btn" onclick="closeCriteriaLibrary()">‚úï</button>
        </div>
        <div class="req-modal-body" style="padding: var(--spacing-lg); overflow-y: auto;">
          <!-- Info Banner -->
          <div style="background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-md); padding: 12px 16px; margin-bottom: var(--spacing-md); display: flex; align-items: flex-start; gap: 10px;">
            <i class="pi pi-info-circle" style="color: var(--info-600); font-size: 16px; margin-top: 2px;"></i>
            <div style="font-size: 12px; color: var(--info-800); line-height: 1.5;">
              Browse specifications from other tenders for: <strong id="criteria-library-product-info">Loading...</strong>
            </div>
          </div>
          
          <!-- Search Section -->
          <div style="display: flex; gap: var(--spacing-md); align-items: flex-end; margin-bottom: var(--spacing-md); flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">UNSPSC Code or Keywords</label>
              <div style="position: relative;">
                <i class="pi pi-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 13px;"></i>
                <input 
                  type="text" 
                  id="criteria-library-search-input" 
                  class="form-input" 
                  placeholder="Enter UNSPSC code or search keywords..."
                  onkeyup="handleCriteriaSearchKeyup(event)"
                  style="width: 100%; padding-left: 36px;"
                />
              </div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="searchCriteriaLibrary(document.getElementById('criteria-library-search-input').value)">
              <i class="pi pi-search"></i> Search
            </button>
          </div>
          
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: var(--spacing-md);">
            üí° Tip: The UNSPSC code is pre-filled. You can modify it or add keywords to refine your search.
          </div>
          
          <!-- Results Section -->
          <div class="criteria-library-results" id="criteria-library-results" style="max-height: 400px; overflow-y: auto; padding-right: 4px;">
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <i class="pi pi-search" style="font-size: 32px; margin-bottom: var(--spacing-md); opacity: 0.5;"></i>
              <p style="font-weight: 600; margin-bottom: 4px;">Search the criteria library</p>
              <p style="font-size: 12px;">Find and reuse specifications from previous tenders</p>
            </div>
          </div>
          
          <!-- Selected Info -->
          <div id="criteria-library-footer-info" style="margin-top: var(--spacing-md); padding: 12px 16px; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius-md); display: none;">
          </div>
        </div>
        <div class="req-modal-footer" style="border-top: 1px solid var(--surface-200); padding: 12px 20px;">
          <button class="btn btn-ghost btn-sm" onclick="closeCriteriaLibrary()">Cancel</button>
          <button class="btn btn-primary btn-sm" onclick="applyCriteriaFromLibrary()">
            <i class="pi pi-check"></i> Apply Selected
          </button>
        </div>
      </div>
    </div>

    <!-- Team Collaboration Board Button -->
    <div id="collabBoardBtn" class="collab-board-btn" onclick="toggleCollabBoard()" title="Team Collaboration Board" aria-label="Open Team Collaboration Board">
      <div class="collab-board-btn-icon">
        <i class="pi pi-users"></i>
      </div>
      <div class="collab-board-btn-badge" id="collabBoardBadge">3</div>
      <div class="collab-board-btn-label">Team<br>Board</div>
    </div>

    <!-- Team Collaboration Board Panel -->
    <div id="collabBoardPanel" class="collab-board-panel">
      <div class="collab-board-header">
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
          <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="pi pi-users" style="color: white; font-size: 16px;"></i>
          </div>
          <div>
            <div style="font-weight: 600; font-size: 14px; color: white;">Team Collaboration</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.8);">Tender Authoring Discussion</div>
          </div>
        </div>
        <button onclick="toggleCollabBoard()" style="background: none; border: none; cursor: pointer; padding: 4px;" aria-label="Close panel">
          <i class="pi pi-times" style="color: rgba(255,255,255,0.8); font-size: 16px;"></i>
        </button>
      </div>
      
      <!-- Online Team Members -->
      <div style="padding: var(--spacing-md); background: var(--surface-50); border-bottom: 1px solid var(--surface-200);">
        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Team Members Online:</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: white; border-radius: 20px; border: 1px solid var(--surface-200);">
            <div style="width: 8px; height: 8px; background: var(--success-500); border-radius: 50%;"></div>
            <span style="font-size: 11px; font-weight: 500;">You (Tender Author)</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: white; border-radius: 20px; border: 1px solid var(--surface-200);">
            <div style="width: 8px; height: 8px; background: var(--success-500); border-radius: 50%;"></div>
            <span style="font-size: 11px;">Sarah Chen</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: white; border-radius: 20px; border: 1px solid var(--surface-200);">
            <div style="width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%;"></div>
            <span style="font-size: 11px; color: var(--text-muted);">Ahmed H.</span>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div style="display: flex; border-bottom: 1px solid var(--surface-200); background: var(--surface-0);">
        <button class="collab-board-tab active" onclick="switchCollabBoardTab('discussion')" id="collab-tab-discussion">
          üí¨ Discussion
        </button>
        <button class="collab-board-tab" onclick="switchCollabBoardTab('comments')" id="collab-tab-comments">
          üí≠ Comments <span class="collab-board-tab-badge" id="collab-comments-badge">2</span>
        </button>
        <button class="collab-board-tab" onclick="switchCollabBoardTab('notes')" id="collab-tab-notes">
          üìù Notes
        </button>
      </div>
      
      <div class="collab-board-content">
        <!-- Discussion Tab -->
        <div id="collab-board-discussion" class="collab-board-tab-content active">
          <div class="collab-board-message-list" id="collabBoardMessageList">
            <div class="collab-board-message">
              <div class="collab-board-message-avatar" style="background: var(--info-100); color: var(--info-600);">SC</div>
              <div class="collab-board-message-content">
                <div class="collab-board-message-header">
                  <span class="collab-board-message-author">Sarah Chen</span>
                  <span class="collab-board-message-time">10:32 AM</span>
                </div>
                <div class="collab-board-message-text">Can we discuss the evaluation criteria for this tender? I think we need to add specific technical requirements.</div>
              </div>
            </div>
            <div class="collab-board-message">
              <div class="collab-board-message-avatar" style="background: var(--success-100); color: var(--success-600);">TA</div>
              <div class="collab-board-message-content">
                <div class="collab-board-message-header">
                  <span class="collab-board-message-author">Tender Author (You)</span>
                  <span class="collab-board-message-time">10:35 AM</span>
                </div>
                <div class="collab-board-message-text">Good point! I'll add ISO certification requirements in the qualification criteria section. üëç</div>
              </div>
            </div>
            <div class="collab-board-message">
              <div class="collab-board-message-avatar" style="background: var(--warning-100); color: var(--warning-600);">SC</div>
              <div class="collab-board-message-content">
                <div class="collab-board-message-header">
                  <span class="collab-board-message-author">Sarah Chen</span>
                  <span class="collab-board-message-time">10:38 AM</span>
                </div>
                <div class="collab-board-message-text">Also, should we include a minimum experience requirement? Maybe 3 years in similar projects?</div>
              </div>
            </div>
            <div class="collab-board-message system-message">
              <i class="pi pi-info-circle"></i>
              <span>Ahmed Hassan joined the collaboration</span>
              <span class="collab-board-message-time">11:00 AM</span>
            </div>
          </div>
        </div>

        <!-- Comments Tab -->
        <div id="collab-board-comments" class="collab-board-tab-content">
          <div class="collab-board-comment-list" id="collabBoardCommentList">
            <div class="collab-board-comment-item open" data-comment-id="1">
              <div class="collab-board-comment-header">
                <span class="collab-board-comment-badge open">‚è≥ Open</span>
                <span class="collab-board-comment-from">From: Sarah Chen</span>
              </div>
              <div class="collab-board-comment-text">
                @TenderAuthor - The payment terms section needs clarification. Should we allow advance payments for this tender?
              </div>
              <div class="collab-board-comment-meta">
                <span>Re: Payment Terms & Advance Payments</span>
                <span>2 hours ago</span>
              </div>
              <div class="collab-board-comment-actions">
                <button class="btn btn-sm btn-primary" onclick="replyToCollabComment(1)">Reply</button>
                <button class="btn btn-sm btn-success" onclick="closeCollabComment(1)">Close</button>
              </div>
            </div>
            <div class="collab-board-comment-item closed" data-comment-id="2">
              <div class="collab-board-comment-header">
                <span class="collab-board-comment-badge closed">‚úÖ Closed</span>
                <span class="collab-board-comment-from">From: Ahmed Hassan</span>
              </div>
              <div class="collab-board-comment-text">
                @Team - Do we need to include a site visit requirement for this tender?
              </div>
              <div class="collab-board-comment-reply">
                <strong>Answer (Tender Author):</strong> No site visit needed for this tender. It's a standard goods procurement.
              </div>
              <div class="collab-board-comment-meta">
                <span>Re: Clarifications or pre-bid meeting</span>
                <span>Yesterday</span>
              </div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="createNewCollabComment()" style="width: 100%; margin-top: var(--spacing-md);">
            <i class="pi pi-plus"></i> Add New Comment
          </button>
        </div>

        <!-- Notes Tab -->
        <div id="collab-board-notes" class="collab-board-tab-content">
          <div class="collab-board-notes-area" id="collabBoardNotesList">
            <div class="collab-board-note-item">
              <div class="collab-board-note-header">
                <span style="font-weight: 600;">üìå Tender Requirements Summary</span>
                <span class="collab-board-note-author">Tender Author</span>
              </div>
              <div class="collab-board-note-text">
                ‚Ä¢ Type: Goods procurement (IT Equipment)<br>
                ‚Ä¢ Budget: $500,000 - $750,000<br>
                ‚Ä¢ Timeline: Q1 2025 delivery<br>
                ‚Ä¢ Key Requirements: ISO 9001, 3+ years experience
              </div>
              <div class="collab-board-note-time">Updated 30 min ago</div>
            </div>
            <div class="collab-board-note-item">
              <div class="collab-board-note-header">
                <span style="font-weight: 600;">‚ö†Ô∏è Items to Review</span>
                <span class="collab-board-note-author">Sarah Chen</span>
              </div>
              <div class="collab-board-note-text">
                1. Confirm advance payment policy with finance<br>
                2. Review liquidated damages clause<br>
                3. Verify Incoterms selection (EXW vs DDP)
              </div>
              <div class="collab-board-note-time">Updated 1 hour ago</div>
            </div>
          </div>
          <button class="btn btn-primary" onclick="addCollabBoardNote()" style="width: 100%; margin-top: var(--spacing-md);">
            <i class="pi pi-plus"></i> Add Note
          </button>
        </div>
      </div>

      <!-- Message Input -->
      <div class="collab-board-footer">
        <div style="display: flex; gap: var(--spacing-sm);">
          <input type="text" id="collabBoardMessageInput" placeholder="Type a message to the team..." style="flex: 1; padding: 10px 12px; border: 1px solid var(--surface-300); border-radius: var(--radius-md); font-size: 13px;" aria-label="Team message" onkeypress="if(event.key==='Enter') sendCollabBoardMessage()">
          <button onclick="sendCollabBoardMessage()" style="background: #10b981; color: white; border: none; padding: 10px 16px; border-radius: var(--radius-md); cursor: pointer;">
            <i class="pi pi-send"></i>
          </button>
        </div>
      </div>
    </div>
  </body>
</html>


