<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNOPS PDJ · Workflow Builder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/primeicons@6.0.1/primeicons.css" />
  <style>
    :root {
      --primary-50: #e6f7ff;
      --primary-500: #0092D1;
      --primary-600: #0284c7;
      --surface-0: #ffffff;
      --surface-50: #f5f8fb;
      --surface-100: #ebf1f8;
      --surface-200: #dde8f2;
      --surface-300: #cfdfec;
      --surface-400: #a3a3a3;
      --surface-600: #95a7ba;
      --surface-800: #596170;
      --surface-900: #3b3e4a;
      --success-50: #d2e7cd;
      --success-500: #4c9f38;
      --warning-50: #f9d6c3;
      --warning-500: #e85c0e;
      --danger-50: #f6cac6;
      --danger-500: #da291c;
      --text-primary: var(--surface-900);
      --text-secondary: var(--surface-800);
      --text-muted: var(--surface-600);
      --spacing-xs: 6px; --spacing-sm: 12px; --spacing-md: 20px; --spacing-lg: 28px; --spacing-xl: 36px;
      --radius-sm: 4px; --radius-md: 6px; --radius-lg: 8px;
      --shadow-card: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Lato', 'Noto Sans', system-ui, sans-serif; background: var(--surface-50); color: var(--text-primary); min-height: 100vh; }
    .header { background: var(--surface-0); border-bottom: 1px solid var(--surface-200); position: sticky; top: 0; z-index: 100; }
    .header-top { display: flex; align-items: center; justify-content: space-between; padding: var(--spacing-md) var(--spacing-xl); }
    .logo { font-weight: 700; font-size: 20px; letter-spacing: 0.12em; color: var(--primary-500); }
    .portal-badge { background: var(--primary-500); color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 4px; text-transform: uppercase; }
    .app-container { display: flex; min-height: calc(100vh - 65px); }
    .sidebar { width: 300px; min-width: 300px; background: #0192D1; color: white; flex-shrink: 0; overflow-y: auto; }
    .menu-section-title { padding: 8px 20px 12px; font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.08em; }
    .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; font-size: 14px; color: white; text-decoration: none; border-left: 3px solid transparent; transition: all 0.2s; }
    .menu-item:hover { background: rgba(255,255,255,0.1); }
    .menu-item.active { background: rgba(255,255,255,0.15); border-left-color: white; font-weight: 600; }
    .menu-icon { font-size: 16px; width: 20px; text-align: center; }
    .main-content { flex: 1; padding: var(--spacing-xl); overflow: hidden; display: flex; flex-direction: column; min-width: 0; }
    .page-title { font-size: 24px; font-weight: 600; margin-bottom: 4px; }
    .page-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: var(--spacing-md); }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-primary { background: var(--primary-500); color: white; }
    .btn-primary:hover { background: var(--primary-600); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .workflow-top-bar { display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap; padding: var(--spacing-md); background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); margin-bottom: var(--spacing-md); box-shadow: var(--shadow-card); }
    .workflow-top-bar label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; display: block; }
    .workflow-top-bar input, .workflow-top-bar select { padding: 8px 12px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 14px; min-width: 160px; }
    .builder-layout { display: flex; flex: 1; gap: var(--spacing-md); min-height: 0; }
    .node-palette { width: 240px; flex-shrink: 0; background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); padding: var(--spacing-sm); box-shadow: var(--shadow-card); overflow-y: auto; }
    .node-palette-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; padding: 8px 4px; border-bottom: 1px solid var(--surface-200); margin-bottom: 8px; }
    .palette-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin-bottom: 6px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); cursor: grab; font-size: 13px; transition: all 0.2s; }
    .palette-item:hover { border-color: var(--primary-500); background: var(--primary-50); color: var(--primary-600); }
    .palette-item:active { cursor: grabbing; }
    .palette-item .node-icon { width: 28px; height: 28px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .palette-item[data-type="start"] .node-icon { background: var(--success-50); color: var(--success-500); }
    .palette-item[data-type="end"] .node-icon { background: var(--surface-300); color: var(--surface-800); }
    .palette-item[data-type="manual"] .node-icon { background: var(--primary-50); color: var(--primary-500); }
    .palette-item[data-type="service"] .node-icon { background: var(--warning-50); color: var(--warning-500); }
    .palette-item[data-type="gateway"] .node-icon { background: var(--surface-200); color: var(--surface-800); }
    .palette-item[data-type="wait"] .node-icon { background: #e3f2fd; color: #1565c0; }
    .palette-item[data-type="fork"] .node-icon, .palette-item[data-type="join"] .node-icon { background: #f3e5f5; color: #7b1fa2; }
    .workflow-canvas-wrap { flex: 1; min-width: 0; background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); box-shadow: var(--shadow-card); overflow: hidden; display: flex; flex-direction: column; }
    .workflow-canvas { flex: 1; min-height: 480px; background-color: var(--surface-50); background-image: linear-gradient(to right, var(--surface-200) 1px, transparent 1px), linear-gradient(to bottom, var(--surface-200) 1px, transparent 1px); background-size: 20px 20px; position: relative; overflow: auto; }
    .workflow-canvas.drag-over { background-color: var(--primary-50); }
    .canvas-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 14px; pointer-events: none; }
    .workflow-canvas.has-nodes .canvas-placeholder { display: none; }
    .canvas-node { position: absolute; min-width: 120px; padding: 10px 14px; border-radius: var(--radius-md); font-size: 12px; font-weight: 500; cursor: pointer; box-shadow: var(--shadow-card); border: 2px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .canvas-node:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .canvas-node.selected { border-color: var(--primary-500); box-shadow: 0 0 0 3px var(--primary-50); }
    .canvas-node .node-icon { width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .canvas-node .node-label { flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* All nodes: same readable shape (rounded rect) with icon + label; type only changes color */
    .canvas-node[data-type="start"] { background: var(--success-50); color: var(--surface-800); }
    .canvas-node[data-type="start"] .node-icon { background: var(--success-500); color: white; }
    .canvas-node[data-type="end"] { background: var(--surface-200); color: var(--surface-800); }
    .canvas-node[data-type="end"] .node-icon { background: var(--surface-600); color: white; }
    .canvas-node[data-type="manual"] { background: var(--primary-50); color: var(--surface-800); }
    .canvas-node[data-type="manual"] .node-icon { background: var(--primary-500); color: white; }
    .canvas-node[data-type="service"] { background: var(--warning-50); color: var(--surface-800); }
    .canvas-node[data-type="service"] .node-icon { background: var(--warning-500); color: white; }
    .canvas-node[data-type="gateway"] { background: white; border: 2px solid var(--surface-400); color: var(--surface-800); }
    .canvas-node[data-type="gateway"] .node-icon { background: var(--surface-600); color: white; }
    .canvas-node[data-type="wait"] { background: #e3f2fd; color: #0d47a1; }
    .canvas-node[data-type="wait"] .node-icon { background: #1565c0; color: white; }
    .canvas-node[data-type="fork"], .canvas-node[data-type="join"] { background: #f3e5f5; color: #4a148c; }
    .canvas-node[data-type="fork"] .node-icon, .canvas-node[data-type="join"] .node-icon { background: #7b1fa2; color: white; }
    .canvas-node .node-delete { margin-left: auto; opacity: 0.5; padding: 2px; border-radius: 4px; }
    .canvas-node:hover .node-delete { opacity: 1; }
    .canvas-node .node-delete:hover { background: var(--danger-50); color: var(--danger-500); }
    .canvas-node .node-connect-handle { position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border-radius: 50%; background: var(--primary-500); cursor: crosshair; opacity: 0.7; border: 2px solid white; box-shadow: 0 0 0 1px var(--surface-300); }
    .canvas-node .node-connect-handle:hover { opacity: 1; }
    .canvas-node { z-index: 2; }
    .canvas-edges { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: visible; z-index: 0; }
    .canvas-edges svg, .canvas-edges path { pointer-events: none; }
    .canvas-edges svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible; }
    .canvas-edges path { fill: none; stroke: var(--surface-600); stroke-width: 2; stroke-linecap: round; }
    .properties-panel { width: 320px; flex-shrink: 0; background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-card); display: flex; flex-direction: column; }
    .properties-panel-header { padding: var(--spacing-md); border-bottom: 1px solid var(--surface-200); font-weight: 600; font-size: 14px; background: var(--surface-50); }
    .properties-panel-body { padding: var(--spacing-md); overflow-y: auto; flex: 1; }
    .prop-row { margin-bottom: var(--spacing-sm); }
    .prop-row label { font-size: 12px; font-weight: 600; color: var(--text-secondary); display: block; margin-bottom: 4px; }
    .prop-row input, .prop-row select, .prop-row textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 13px; }
    .prop-row textarea { min-height: 60px; resize: vertical; }
    .workflow-meta { padding: var(--spacing-sm); border-bottom: 1px solid var(--surface-200); background: var(--surface-50); font-size: 12px; }
    .conn-list { margin-top: 8px; }
    .conn-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background: var(--surface-50); border-radius: var(--radius-sm); font-size: 12px; margin-bottom: 4px; }
    .conn-item button { padding: 2px 6px; font-size: 11px; cursor: pointer; border: none; background: var(--danger-50); color: var(--danger-500); border-radius: 4px; }
    .conn-item button:hover { background: var(--danger-500); color: white; }
    .add-conn-row { display: flex; gap: 8px; margin-top: 8px; }
    .add-conn-row select { flex: 1; }
    .prop-hint { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
    .outcome-checkboxes { display: flex; flex-wrap: wrap; gap: 8px 12px; }
    .checkbox-label { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: normal; cursor: pointer; }
    .checkbox-label input { width: auto; margin: 0; }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <div class="header-top">
      <div class="logo">UNOPS PDJ</div>
      <span class="portal-badge">Internal</span>
    </div>
  </header>
  <div class="app-container">
    <aside class="sidebar">
      <div class="menu-section-title">Processes</div>
      <a href="workflow-builder.html" class="menu-item active"><span class="menu-icon pi pi-sitemap"></span> Workflow Builder</a>
      <div class="menu-section-title">Tendering</div>
      <a href="tender-authoring.html" class="menu-item"><span class="menu-icon pi pi-file-edit"></span> Tender authoring</a>
    </aside>
    <main class="main-content">
      <h1 class="page-title">Workflow Builder</h1>
      <p class="page-subtitle">Configure workflow definitions (versioned blueprint: Draft → Published → Archived). Link to entities and trigger events; drag nodes onto the canvas and connect them. Instances run against a definition version with token-based execution.</p>
      <div class="workflow-top-bar">
        <div class="form-group">
          <label>Workflow name</label>
          <input type="text" value="Tender Publication Approval" />
        </div>
        <div class="form-group">
          <label>Definition status</label>
          <select id="workflow-status" title="Immutable versioned lifecycle: Draft (editable) → Published (immutable) → Archived">
            <option value="Draft" selected>Draft</option>
            <option value="Published">Published</option>
            <option value="Archived">Archived</option>
          </select>
        </div>
        <div class="form-group">
          <label>Version</label>
          <input type="text" id="workflow-version" value="1" readonly title="Definition version; new version created when publishing from Draft" style="min-width: 60px;" />
        </div>
        <div class="form-group">
          <label>Linked to entity</label>
          <select id="workflow-entity">
            <option value="Tender">Tender</option>
            <option value="Amendment">Amendment</option>
          </select>
        </div>
        <div class="form-group">
          <label>Trigger event</label>
          <select id="workflow-trigger">
            <option value="TENDER_CREATED">TENDER_CREATED</option>
            <option value="TENDER_RESUBMITTED">TENDER_RESUBMITTED</option>
            <option value="TENDER_EVALUATION_PANEL_SUBMITTED">TENDER_EVALUATION_PANEL_SUBMITTED</option>
            <option value="TENDER_SENT_FOR_TME_REVIEW">TENDER_SENT_FOR_TME_REVIEW</option>
            <option value="TENDER_CANCELLATION_REQUESTED">TENDER_CANCELLATION_REQUESTED</option>
            <option value="TENDER_PUBLISHED">TENDER_PUBLISHED</option>
            <option value="TENDER_APPROVED">TENDER_APPROVED</option>
          </select>
        </div>
        <button type="button" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-primary">Publish</button>
      </div>
      <div class="builder-layout">
        <div class="node-palette">
          <div class="node-palette-title">Nodes</div>
          <p class="prop-hint" style="padding: 0 4px 8px;">Start, End, ManualTask, ServiceTask, Wait, ExclusiveGateway, ParallelFork, ParallelJoin.</p>
          <div class="palette-item" draggable="true" data-type="start" data-label="Start"><span class="node-icon"><i class="pi pi-play"></i></span><span>Start</span></div>
          <div class="palette-item" draggable="true" data-type="end" data-label="End"><span class="node-icon"><i class="pi pi-stop"></i></span><span>End</span></div>
          <div class="palette-item" draggable="true" data-type="manual" data-label="Manual Task"><span class="node-icon"><i class="pi pi-user"></i></span><span>Manual Task</span></div>
          <div class="palette-item" draggable="true" data-type="service" data-label="Service Task"><span class="node-icon"><i class="pi pi-cog"></i></span><span>Service Task</span></div>
          <div class="palette-item" draggable="true" data-type="gateway" data-label="Exclusive Gateway"><span class="node-icon"><i class="pi pi-sitemap"></i></span><span>Exclusive Gateway</span></div>
          <div class="palette-item" draggable="true" data-type="wait" data-label="Wait"><span class="node-icon"><i class="pi pi-clock"></i></span><span>Wait</span></div>
          <div class="palette-item" draggable="true" data-type="fork" data-label="Parallel Fork"><span class="node-icon"><i class="pi pi-bars"></i></span><span>Parallel Fork</span></div>
          <div class="palette-item" draggable="true" data-type="join" data-label="Parallel Join"><span class="node-icon"><i class="pi pi-align-justify"></i></span><span>Parallel Join</span></div>
        </div>
        <div class="workflow-canvas-wrap">
          <div class="workflow-canvas" id="canvas">
            <div class="canvas-edges" id="canvas-edges"><svg id="edges-svg"><g id="edges-group"></g></svg></div>
            <div class="canvas-placeholder" id="canvas-placeholder">Drag nodes from the left panel and drop here to build your workflow</div>
            <div class="canvas-node selected" data-id="n1" data-type="start" style="left: 40px; top: 80px;" title="Start — Entry point of the workflow; the process begins here." data-label="Start">
              <span class="node-icon"><i class="pi pi-play"></i></span>
              <span class="node-label">Start</span>
              <span class="node-connect-handle" title="Drag to connect" data-source="n1"></span>
              <span class="node-delete" onclick="deleteNode('n1')"><i class="pi pi-trash"></i></span>
            </div>
            <div class="canvas-node" data-id="n2" data-type="manual" style="left: 240px; top: 75px;" title="Admin Review — Manual task: a user performs an action and chooses an outcome (e.g. Approve, Reject)." data-label="Admin Review">
              <span class="node-icon"><i class="pi pi-user"></i></span>
              <span class="node-label">Admin Review</span>
              <span class="node-connect-handle" title="Drag to connect" data-source="n2"></span>
              <span class="node-delete" onclick="deleteNode('n2')"><i class="pi pi-trash"></i></span>
            </div>
            <div class="canvas-node" data-id="n3" data-type="gateway" style="left: 460px; top: 80px;" title="Gateway — Exclusive gateway: decision point; exactly one outgoing path is taken based on conditions." data-label="Gateway">
              <span class="node-icon"><i class="pi pi-sitemap"></i></span>
              <span class="node-label">Gateway</span>
              <span class="node-connect-handle" title="Drag to connect" data-source="n3"></span>
              <span class="node-delete" onclick="deleteNode('n3')"><i class="pi pi-trash"></i></span>
            </div>
            <div class="canvas-node" data-id="n4" data-type="service" style="left: 680px; top: 40px;" title="Publish — Service task: automated step run by the system (e.g. update status, send notification)." data-label="Publish">
              <span class="node-icon"><i class="pi pi-cog"></i></span>
              <span class="node-label">Publish</span>
              <span class="node-connect-handle" title="Drag to connect" data-source="n4"></span>
              <span class="node-delete" onclick="deleteNode('n4')"><i class="pi pi-trash"></i></span>
            </div>
            <div class="canvas-node" data-id="n5" data-type="end" style="left: 880px; top: 75px;" title="End — Exit point; the process or a path finishes here." data-label="End">
              <span class="node-icon"><i class="pi pi-stop"></i></span>
              <span class="node-label">End</span>
              <span class="node-delete" onclick="deleteNode('n5')"><i class="pi pi-trash"></i></span>
            </div>
          </div>
        </div>
        <div class="properties-panel">
          <div class="properties-panel-header">Properties</div>
          <div class="workflow-meta">
            <div class="prop-row"><label>Definition status</label><span id="prop-status">Draft</span></div>
            <div class="prop-row"><label>Version</label><span id="prop-version">1</span></div>
            <div class="prop-row"><label>Linked to entity</label><span class="entity-badge" id="prop-entity">Tender</span></div>
            <div class="prop-row"><label>Trigger event</label><span id="prop-trigger">TENDER_CREATED</span></div>
          </div>
          <div class="properties-panel-body" id="properties-body">
            <div class="prop-row">
              <label>Node type</label>
              <input type="text" id="prop-type" readonly value="Manual Task" />
            </div>
            <div class="prop-row">
              <label>Label</label>
              <input type="text" id="prop-label" value="Admin Review" placeholder="Node label" />
            </div>
            <div class="prop-row" id="prop-instructions-row" style="display:none;">
              <label>Instructions</label>
              <textarea id="prop-instructions" placeholder="Optional instructions shown to the assignee" rows="2"></textarea>
            </div>
            <div class="prop-row" id="prop-role-row">
              <label>Assignee role</label>
              <select id="prop-role">
                <option value="TenderAdmin">Tender Admin</option>
                <option value="ProcurementOfficer">Procurement Officer</option>
                <option value="ProcurementReviewer">Procurement Reviewer</option>
                <option value="TME">TME</option>
                <option value="EvaluationPanelApprover">Evaluation Panel Approver</option>
                <option value="LegalReviewer">Legal Reviewer</option>
                <option value="TechnicalReviewer">Technical Reviewer</option>
              </select>
            </div>
            <div class="prop-row" id="prop-outcomes-row">
              <label>Allowed outcomes</label>
              <p class="prop-hint">Select the outcomes this task can complete with:</p>
              <div class="outcome-checkboxes" id="prop-outcomes-list">
                <label class="checkbox-label"><input type="checkbox" name="outcome" value="APPROVE" /> Approve</label>
                <label class="checkbox-label"><input type="checkbox" name="outcome" value="REJECT" /> Reject</label>
                <label class="checkbox-label"><input type="checkbox" name="outcome" value="RETURN_FOR_REVISION" /> Return for revision</label>
                <label class="checkbox-label"><input type="checkbox" name="outcome" value="REQUEST_INFO" /> Request info</label>
                <label class="checkbox-label"><input type="checkbox" name="outcome" value="REQUEST_CHANGES" /> Request changes</label>
              </div>
              <input type="text" id="prop-outcomes" value="APPROVE, REJECT, RETURN_FOR_REVISION" placeholder="Or edit as comma-separated" style="margin-top:6px;" />
            </div>
            <div class="prop-row" id="prop-condition-row" style="display:none;">
              <label>Edge condition</label>
              <p class="prop-hint">Structured JSONB: operators (equals, in, greaterThan, etc.) and compound logic (all/any). Pure evaluation — no arbitrary code.</p>
              <textarea id="prop-condition" placeholder='{"field":"outcome","operator":"equals","value":"APPROVE"}' rows="2"></textarea>
            </div>
            <div class="prop-row" id="prop-wait-event-row" style="display:none;">
              <label>Wait for event</label>
              <input type="text" id="prop-wait-event" placeholder="e.g. TENDER_RESUBMITTED" />
            </div>
            <div class="prop-row" id="prop-service-type-row" style="display:none;">
              <label>Service type</label>
              <select id="prop-service-type">
                <option value="UPDATE_ENTITY_PROPERTY">UPDATE_ENTITY_PROPERTY</option>
                <option value="SEND_NOTIFICATION">SEND_NOTIFICATION</option>
              </select>
            </div>
            <div class="prop-row" id="prop-entity-type-row" style="display:none;">
              <label>Entity to update</label>
              <select id="prop-entity-type">
                <option value="Tender">Tender</option>
                <option value="Amendment">Amendment</option>
              </select>
            </div>
            <div class="prop-row" id="prop-property-row" style="display:none;">
              <label>Property</label>
              <select id="prop-property">
                <optgroup label="Tender" id="prop-property-tender">
                  <option value="Status">Status</option>
                  <option value="EvaluationUnblocked">EvaluationUnblocked</option>
                  <option value="TmeReviewStatus">TmeReviewStatus</option>
                  <option value="UngmPostingStatus">UngmPostingStatus</option>
                  <option value="PublishedAt">PublishedAt</option>
                </optgroup>
                <optgroup label="Amendment" id="prop-property-amendment">
                  <option value="Status">Status</option>
                </optgroup>
              </select>
            </div>
            <div class="prop-row" id="prop-property-value-row" style="display:none;">
              <label>Value</label>
              <select id="prop-property-value">
                <option value="">— Select or type below —</option>
                <option value="Draft">Draft</option>
                <option value="PendingApproval">Pending approval</option>
                <option value="Published">Published</option>
                <option value="Rejected">Rejected</option>
                <option value="Cancelled">Cancelled</option>
                <option value="true">true</option>
                <option value="false">false</option>
                <option value="$NOW">$NOW (current time)</option>
              </select>
              <input type="text" id="prop-property-value-custom" placeholder="Custom value (e.g. Passed, Pending)" style="margin-top:4px;" />
            </div>
            <div class="prop-row" id="prop-template-row" style="display:none;">
              <label>Notification template</label>
              <select id="prop-template-key">
                <option value="TENDER_REJECTED">TENDER_REJECTED</option>
                <option value="TENDER_APPROVED">TENDER_APPROVED</option>
                <option value="EVAL_PANEL_REJECTED">EVAL_PANEL_REJECTED</option>
                <option value="NOTIFY_REQUEST_CHANGES">NOTIFY_REQUEST_CHANGES</option>
                <option value="TME_REJECTED">TME_REJECTED</option>
              </select>
            </div>
            <div class="prop-row" id="prop-recipient-row" style="display:none;">
              <label>Recipient</label>
              <select id="prop-recipient">
                <option value="$INITIATED_BY">$INITIATED_BY (who started)</option>
                <option value="TenderAuthor">Tender author</option>
                <option value="AssigneeRole">Assignee role (from previous task)</option>
              </select>
            </div>
            <div class="prop-row" id="prop-parameters-row" style="display:none;">
              <label>Parameters (JSON)</label>
              <textarea id="prop-parameters" placeholder='Generated from fields above or edit manually' rows="2"></textarea>
            </div>
            <div class="prop-row" id="prop-connections-row">
              <label>Connections</label>
              <div id="conn-list" class="conn-list"></div>
              <div class="add-conn-row">
                <select id="connect-to-select"><option value="">— Select node —</option></select>
                <button type="button" class="btn btn-primary btn-sm" id="add-connection-btn">Add</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    var canvas = document.getElementById('canvas');
    var placeholder = document.getElementById('canvas-placeholder');
    var edges = [{ fromId: 'n1', toId: 'n2' }, { fromId: 'n2', toId: 'n3' }, { fromId: 'n3', toId: 'n4' }, { fromId: 'n4', toId: 'n5' }];
    var selectedNodeId = 'n2';
    var connectingFromId = null;

    function getNodeLabel(node) {
      var el = node.querySelector('.node-label');
      return el ? el.textContent : (node.dataset.label || '');
    }

    function getNodeTypeDescription(type) {
      var descriptions = {
        start: 'Entry point of the workflow; the process begins here.',
        end: 'Exit point; the process or a path finishes here.',
        manual: 'Manual task: a user performs an action and chooses an outcome (e.g. Approve, Reject).',
        service: 'Service task: automated step run by the system (e.g. update status, send notification).',
        gateway: 'Exclusive gateway: decision point; exactly one outgoing path is taken based on conditions.',
        wait: 'Wait: pauses the process until an event occurs (e.g. resubmission).',
        fork: 'Parallel fork: splits the flow into multiple branches that run in parallel.',
        join: 'Parallel join: merges parallel branches; continues when all have completed.'
      };
      return descriptions[type] || 'Workflow node.';
    }

    function setNodeTooltip(node, label) {
      var type = node.dataset.type;
      var desc = getNodeTypeDescription(type);
      node.title = (label || node.dataset.label || '') + ' — ' + desc;
    }

    function updateCanvasPlaceholder() {
      var nodes = canvas.querySelectorAll('.canvas-node');
      canvas.classList.toggle('has-nodes', nodes.length > 0);
    }

    function getNodeAnchor(node, side) {
      var r = node.getBoundingClientRect();
      var cr = canvas.getBoundingClientRect();
      var left = r.left - cr.left + canvas.scrollLeft;
      var y = r.top - cr.top + canvas.scrollTop + r.height / 2;
      return { x: side === 'right' ? left + r.width : left, y: y };
    }

    function renderEdges() {
      var g = document.getElementById('edges-group');
      g.innerHTML = '';
      var svg = document.getElementById('edges-svg');
      var canvasRect = canvas.getBoundingClientRect();
      var w = Math.max(canvas.scrollWidth, canvasRect.width);
      var h = Math.max(canvas.scrollHeight, canvasRect.height);
      svg.setAttribute('width', w);
      svg.setAttribute('height', h);
      edges.forEach(function(edge) {
        var fromNode = canvas.querySelector('.canvas-node[data-id="' + edge.fromId + '"]');
        var toNode = canvas.querySelector('.canvas-node[data-id="' + edge.toId + '"]');
        if (!fromNode || !toNode) return;
        var from = getNodeAnchor(fromNode, 'right');
        var to = getNodeAnchor(toNode, 'left');
        var mid = (from.x + to.x) / 2;
        var d = 'M' + from.x + ',' + from.y + ' C' + mid + ',' + from.y + ' ' + mid + ',' + to.y + ' ' + to.x + ',' + to.y;
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', d);
        path.setAttribute('stroke-width', '2');
        g.appendChild(path);
      });
    }

    function addConnection(fromId, toId) {
      if (fromId === toId) return;
      if (edges.some(function(e) { return e.fromId === fromId && e.toId === toId; })) return;
      edges.push({ fromId: fromId, toId: toId });
      renderEdges();
      refreshConnectionsUI();
    }

    function removeConnection(fromId, toId) {
      edges = edges.filter(function(e) { return !(e.fromId === fromId && e.toId === toId); });
      renderEdges();
      refreshConnectionsUI();
    }

    function refreshConnectionsUI() {
      if (!selectedNodeId) return;
      var list = document.getElementById('conn-list');
      var outgoing = edges.filter(function(e) { return e.fromId === selectedNodeId; });
      list.innerHTML = outgoing.map(function(e) {
        var toNode = canvas.querySelector('.canvas-node[data-id="' + e.toId + '"]');
        var toLabel = toNode ? getNodeLabel(toNode) : e.toId;
        return '<div class="conn-item"><span>→ ' + toLabel + '</span><button type="button" onclick="removeConnection(\'' + selectedNodeId + '\',\'' + e.toId + '\')">Remove</button></div>';
      }).join('');
      populateConnectToSelect();
    }

    function populateConnectToSelect() {
      var sel = document.getElementById('connect-to-select');
      var nodes = canvas.querySelectorAll('.canvas-node');
      var current = sel.value;
      sel.innerHTML = '<option value="">— Select node —</option>';
      nodes.forEach(function(n) {
        var id = n.dataset.id;
        if (id === selectedNodeId) return;
        var label = getNodeLabel(n);
        if (edges.some(function(e) { return e.fromId === selectedNodeId && e.toId === id; })) return;
        var opt = document.createElement('option');
        opt.value = id;
        opt.textContent = label;
        sel.appendChild(opt);
      });
      if (sel.querySelector('option[value="' + current + '"]')) sel.value = current;
    }

    document.getElementById('add-connection-btn').addEventListener('click', function() {
      var sel = document.getElementById('connect-to-select');
      var toId = sel.value;
      if (!toId || !selectedNodeId) return;
      addConnection(selectedNodeId, toId);
      sel.value = '';
    });

    function getTypeDisplayName(type) {
      var names = { start: 'Start', end: 'End', manual: 'Manual Task', service: 'Service Task', gateway: 'Exclusive Gateway', wait: 'Wait', fork: 'Parallel Fork', join: 'Parallel Join' };
      return names[type] || type;
    }

    function showProperties(type, label, id) {
      selectedNodeId = id;
      document.getElementById('prop-type').value = getTypeDisplayName(type);
      document.getElementById('prop-label').value = label;
      document.getElementById('prop-instructions-row').style.display = type === 'manual' ? '' : 'none';
      document.getElementById('prop-role-row').style.display = (type === 'manual' || type === 'wait') ? '' : 'none';
      document.getElementById('prop-outcomes-row').style.display = type === 'manual' ? '' : 'none';
      document.getElementById('prop-condition-row').style.display = type === 'gateway' ? '' : 'none';
      document.getElementById('prop-wait-event-row').style.display = type === 'wait' ? '' : 'none';
      document.getElementById('prop-service-type-row').style.display = type === 'service' ? '' : 'none';
      var st = document.getElementById('prop-service-type').value;
      toggleServiceSubRows(st);
      document.getElementById('prop-parameters-row').style.display = type === 'service' ? '' : 'none';
      syncOutcomesFromText();
      refreshConnectionsUI();
    }

    function toggleServiceSubRows(serviceType) {
      var isUpdate = serviceType === 'UPDATE_ENTITY_PROPERTY';
      var isNotify = serviceType === 'SEND_NOTIFICATION';
      document.getElementById('prop-entity-type-row').style.display = isUpdate ? '' : 'none';
      document.getElementById('prop-property-row').style.display = isUpdate ? '' : 'none';
      document.getElementById('prop-property-value-row').style.display = isUpdate ? '' : 'none';
      document.getElementById('prop-template-row').style.display = isNotify ? '' : 'none';
      document.getElementById('prop-recipient-row').style.display = isNotify ? '' : 'none';
    }

    function syncOutcomesFromText() {
      var text = (document.getElementById('prop-outcomes').value || '').trim();
      var parts = text.split(',').map(function(s) { return s.trim().toUpperCase(); }).filter(Boolean);
      document.querySelectorAll('#prop-outcomes-list input[name="outcome"]').forEach(function(cb) {
        cb.checked = parts.indexOf(cb.value.toUpperCase()) !== -1;
      });
    }

    function syncOutcomesToText() {
      var checked = [];
      document.querySelectorAll('#prop-outcomes-list input[name="outcome"]:checked').forEach(function(cb) {
        checked.push(cb.value);
      });
      document.getElementById('prop-outcomes').value = checked.join(', ');
    }

    function buildServiceParameters() {
      var st = document.getElementById('prop-service-type').value;
      var params = {};
      if (st === 'UPDATE_ENTITY_PROPERTY') {
        var entityType = document.getElementById('prop-entity-type').value;
        var prop = document.getElementById('prop-property').value;
        var val = document.getElementById('prop-property-value-custom').value.trim() || document.getElementById('prop-property-value').value;
        if (prop && val !== '') {
          params.entityType = entityType;
          params.properties = {};
          params.properties[prop] = val;
        }
      } else if (st === 'SEND_NOTIFICATION') {
        params.templateKey = document.getElementById('prop-template-key').value;
        params.recipientUserId = document.getElementById('prop-recipient').value;
      }
      var json = Object.keys(params).length ? JSON.stringify(params, null, 2) : '';
      document.getElementById('prop-parameters').value = json;
    }

    document.getElementById('prop-label').addEventListener('input', function() {
      if (!selectedNodeId) return;
      var node = canvas.querySelector('.canvas-node[data-id="' + selectedNodeId + '"]');
      if (!node) return;
      var value = this.value.trim() || node.dataset.label || 'Unnamed';
      var labelEl = node.querySelector('.node-label');
      if (labelEl) labelEl.textContent = value;
      node.dataset.label = value;
      setNodeTooltip(node, value);
      refreshConnectionsUI();
    });

    document.getElementById('prop-outcomes').addEventListener('input', syncOutcomesFromText);
    document.getElementById('prop-outcomes-list').addEventListener('change', syncOutcomesToText);

    document.getElementById('prop-service-type').addEventListener('change', function() {
      toggleServiceSubRows(this.value);
      buildServiceParameters();
    });
    document.getElementById('prop-entity-type').addEventListener('change', buildServiceParameters);
    document.getElementById('prop-property').addEventListener('change', buildServiceParameters);
    document.getElementById('prop-property-value').addEventListener('change', buildServiceParameters);
    document.getElementById('prop-property-value-custom').addEventListener('input', buildServiceParameters);
    document.getElementById('prop-template-key').addEventListener('change', buildServiceParameters);
    document.getElementById('prop-recipient').addEventListener('change', buildServiceParameters);

    canvas.addEventListener('mousedown', function(ev) {
      if (ev.target.closest('.node-connect-handle')) connectingFromId = ev.target.closest('.node-connect-handle').dataset.source;
      if (connectingFromId) { ev.preventDefault(); ev.stopPropagation(); }
    });
    canvas.addEventListener('mouseup', function(ev) {
      if (connectingFromId) {
        var node = ev.target.closest('.canvas-node');
        if (node && node.dataset.id && node.dataset.id !== connectingFromId) addConnection(connectingFromId, node.dataset.id);
        connectingFromId = null;
      }
    });
    canvas.addEventListener('mouseleave', function() { connectingFromId = null; });

    updateCanvasPlaceholder();
    renderEdges();
    refreshConnectionsUI();

    document.querySelectorAll('.palette-item').forEach(function(item) {
      item.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('application/json', JSON.stringify({ type: this.dataset.type, label: this.dataset.label }));
        e.dataTransfer.effectAllowed = 'copy';
      });
    });

    canvas.addEventListener('dragover', function(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; canvas.classList.add('drag-over'); });
    canvas.addEventListener('dragleave', function() { canvas.classList.remove('drag-over'); });
    canvas.addEventListener('drop', function(e) {
      e.preventDefault();
      canvas.classList.remove('drag-over');
      var data = e.dataTransfer.getData('application/json');
      if (!data) return;
      var type = JSON.parse(data).type;
      var label = JSON.parse(data).label;
      var rect = canvas.getBoundingClientRect();
      var x = e.clientX - rect.left + canvas.scrollLeft - 60;
      var y = e.clientY - rect.top + canvas.scrollTop - 20;
      var id = 'n' + Date.now();
      var icons = { start: 'pi-play', end: 'pi-stop', manual: 'pi-user', service: 'pi-cog', gateway: 'pi-sitemap', wait: 'pi-clock', fork: 'pi-bars', join: 'pi-align-justify' };
      var node = document.createElement('div');
      node.className = 'canvas-node';
      node.dataset.id = id;
      node.dataset.type = type;
      node.dataset.label = label;
      setNodeTooltip(node, label);
      node.style.left = Math.max(0, x) + 'px';
      node.style.top = Math.max(0, y) + 'px';
      var inner = '<span class="node-icon"><i class="pi ' + icons[type] + '"></i></span><span class="node-label">' + label + '</span>' +
        (type !== 'end' ? '<span class="node-connect-handle" title="Drag to connect" data-source="' + id + '"></span>' : '') +
        '<span class="node-delete" onclick="deleteNode(\'' + id + '\')"><i class="pi pi-trash"></i></span>';
      node.innerHTML = inner;
      canvas.appendChild(node);
      bindNodeClick(node);
      if (placeholder.parentNode) placeholder.remove();
      updateCanvasPlaceholder();
      renderEdges();
    });

    function deleteNode(id) {
      edges = edges.filter(function(e) { return e.fromId !== id && e.toId !== id; });
      var node = canvas.querySelector('.canvas-node[data-id="' + id + '"]');
      if (node) node.remove();
      if (selectedNodeId === id) selectedNodeId = null;
      if (!canvas.querySelector('.canvas-node')) {
        canvas.appendChild(placeholder);
        document.getElementById('prop-type').value = '';
        document.getElementById('prop-label').value = '';
        document.getElementById('conn-list').innerHTML = '';
      } else {
        renderEdges();
        if (selectedNodeId) refreshConnectionsUI();
      }
      updateCanvasPlaceholder();
    }

    document.getElementById('workflow-entity').addEventListener('change', function() {
      document.getElementById('prop-entity').textContent = this.options[this.selectedIndex].text;
    });
    document.getElementById('workflow-trigger').addEventListener('change', function() {
      document.getElementById('prop-trigger').textContent = this.value;
    });
    document.getElementById('workflow-status').addEventListener('change', function() {
      document.getElementById('prop-status').textContent = this.value;
    });
    document.getElementById('workflow-version').addEventListener('input', function() {
      document.getElementById('prop-version').textContent = this.value || '1';
    });
    // Sync workflow definition status and version to properties panel on load
    document.getElementById('prop-status').textContent = document.getElementById('workflow-status').value;
    document.getElementById('prop-version').textContent = document.getElementById('workflow-version').value || '1';

    // Delegation: any click on a node updates the properties panel
    canvas.addEventListener('click', function(ev) {
      var node = ev.target.closest('.canvas-node');
      if (!node) return;
      if (ev.target.closest('.node-delete') || ev.target.closest('.node-connect-handle')) return;
      canvas.querySelectorAll('.canvas-node').forEach(function(n) { n.classList.remove('selected'); });
      node.classList.add('selected');
      showProperties(node.dataset.type, getNodeLabel(node), node.dataset.id);
    });

    // Explicit click on every existing node (ensures pre-existing canvas nodes always work)
    function bindNodeClick(node) {
      node.addEventListener('click', function(ev) {
        if (ev.target.closest('.node-delete') || ev.target.closest('.node-connect-handle')) return;
        canvas.querySelectorAll('.canvas-node').forEach(function(n) { n.classList.remove('selected'); });
        node.classList.add('selected');
        showProperties(node.dataset.type, getNodeLabel(node), node.dataset.id);
      });
    }
    canvas.querySelectorAll('.canvas-node').forEach(bindNodeClick);

    canvas.addEventListener('scroll', renderEdges);
    window.addEventListener('resize', renderEdges);
  </script>
</body>
</html>
