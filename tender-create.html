<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNOPS PDJ ¬∑ Create Tender</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Primary Colors - UNOPS Blue (Enhanced) */
        --primary-50: #e6f4fb;
        --primary-100: #cce9f7;
        --primary-200: #99d3ef;
        --primary-300: #66bce7;
        --primary-400: #33a6df;
        --primary-500: #0091d7;
        --primary-600: #0074ac;
        --primary-700: #005781;
        --primary-800: #003a56;
        --primary-900: #001d2b;

        /* Neutral - Sophisticated Gray */
        --neutral-50: #fafafa;
        --neutral-100: #f5f5f5;
        --neutral-200: #e5e5e5;
        --neutral-300: #d4d4d4;
        --neutral-400: #a3a3a3;
        --neutral-500: #737373;
        --neutral-600: #525252;
        --neutral-700: #404040;
        --neutral-800: #262626;
        --neutral-900: #171717;

        /* Surface Colors (Alias for compatibility) */
        --surface-0: #ffffff;
        --surface-50: var(--neutral-50);
        --surface-100: var(--neutral-100);
        --surface-200: var(--neutral-200);
        --surface-300: var(--neutral-300);
        --surface-600: var(--neutral-600);
        --surface-800: var(--neutral-800);
        --surface-900: var(--neutral-900);

        /* Semantic Colors - Modern Palette */
        --success-50: #f0fdf4;
        --success-100: #dcfce7;
        --success-500: #22c55e;
        --success-600: #16a34a;
        --success-700: #15803d;
        
        --info-50: #eff6ff;
        --info-100: #dbeafe;
        --info-400: #60a5fa;
        --info-500: #3b82f6;
        --info-600: #2563eb;
        
        --warning-50: #fffbeb;
        --warning-100: #fef3c7;
        --warning-500: #f59e0b;
        --warning-600: #d97706;
        
        --danger-50: #fef2f2;
        --danger-100: #fee2e2;
        --danger-500: #ef4444;
        --danger-600: #dc2626;

        /* Text Colors */
        --text-primary: var(--neutral-900);
        --text-secondary: var(--neutral-700);
        --text-muted: var(--neutral-500);

        /* Spacing Scale */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-2xl: 48px;
        --spacing-3xl: 64px;

        /* Border Radius */
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;

        /* Enhanced Shadow System */
        --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        
        /* Legacy aliases for backwards compatibility */
        --shadow-card: var(--shadow-md);

        /* Transitions */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        background: var(--neutral-50);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Top Bar - Modern Header */
      .top-bar {
        background: var(--surface-0);
        border-bottom: 1px solid var(--neutral-200);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md) var(--spacing-xl);
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-xs);
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
      }

      .top-bar__brand {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
      }

      .logo {
        font-weight: 700;
        font-size: 18px;
        letter-spacing: 0.12em;
        color: var(--primary-400);
      }

      .top-bar__breadcrumbs {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 400;
      }

      .top-bar__title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
      }

      .top-bar__actions {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      /* Buttons - Modern Design */
      .btn {
        border-radius: var(--radius-md);
        border: 1px solid transparent;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all var(--transition-base);
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      .btn-ghost {
        background: transparent;
        border: 1.5px solid var(--neutral-200);
        color: var(--text-secondary);
        font-weight: 500;
        transition: all var(--transition-base);
      }

      .btn-ghost:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-600);
        transform: translateY(-1px);
        box-shadow: var(--shadow-xs);
      }

      .btn-ghost:active {
        transform: translateY(0);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
        color: #fff;
        border: none;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 145, 215, 0.2);
        transition: all var(--transition-base);
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        box-shadow: 0 4px 8px rgba(0, 145, 215, 0.3);
        transform: translateY(-1px);
      }

      .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 145, 215, 0.2);
      }

      .btn-primary:disabled {
        background: var(--neutral-300);
        border: none;
        color: var(--neutral-500);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Workspace Layout */
      .workspace {
        display: flex;
        min-height: calc(100vh - 73px);
      }

      /* Left Rail Navigation */
      .rail {
        width: 64px;
        background: var(--primary-600);
        color: #b7cee1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-lg);
        padding: var(--spacing-lg) 0;
        transition: width 0.2s ease;
      }

      .rail:hover {
        width: 250px;
      }

      .rail button {
        width: 44px;
        height: 44px;
        border-radius: var(--radius-sm);
        border: none;
        background: transparent;
        color: inherit;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rail:hover button {
        width: 100%;
        padding: 0 var(--spacing-md);
        justify-content: flex-start;
        gap: var(--spacing-md);
      }

      .rail button .rail-label {
        display: none;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
      }

      .rail:hover button .rail-label {
        display: block;
      }

      .rail button.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .rail button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* View States */
      .view-section {
        display: none;
        flex: 1;
        flex-direction: column;
        overflow: hidden;
      }

      .view-section.active {
        display: flex;
      }

      /* ===== TENDER INITIATION METHOD SELECTION ===== */
      .initiation-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
        padding: var(--spacing-3xl) var(--spacing-xl);
      }

      .initiation-header {
        text-align: center;
        margin-bottom: var(--spacing-3xl);
      }

      .initiation-title {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
      }

      .initiation-subtitle {
        font-size: 16px;
        color: var(--text-muted);
        max-width: 600px;
        margin: 0 auto;
      }

      .initiation-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-2xl);
      }

      .initiation-card {
        background: var(--surface-0);
        border: 2px solid var(--neutral-200);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        cursor: pointer;
        transition: all var(--transition-base);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .initiation-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }

      .initiation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
        opacity: 0;
        transition: opacity var(--transition-base);
      }

      .initiation-card:hover::before {
        opacity: 1;
      }

      .initiation-card-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-lg);
      }

      .initiation-card-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .initiation-card-description {
        font-size: 14px;
        color: var(--text-muted);
        line-height: 1.6;
        margin-bottom: var(--spacing-lg);
      }

      .initiation-card-features {
        list-style: none;
        padding: 0;
        margin: 0 0 var(--spacing-lg) 0;
        text-align: left;
        width: 100%;
      }

      .initiation-card-features li {
        font-size: 13px;
        color: var(--text-secondary);
        padding: var(--spacing-xs) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .initiation-card-features li::before {
        content: '‚úì';
        color: var(--success-600);
        font-weight: 700;
      }

      .initiation-card-badge {
        position: absolute;
        top: var(--spacing-md);
        right: var(--spacing-md);
        background: var(--primary-50);
        color: var(--primary-600);
        font-size: 11px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .initiation-card-action {
        margin-top: auto;
        width: 100%;
      }

      .initiation-card-action .btn {
        width: 100%;
      }

      /* ===== TENDER SELECTION MODAL ===== */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .modal-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 900px;
        width: 90%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .modal-header {
        padding: var(--spacing-xl);
        border-bottom: 1px solid var(--neutral-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .modal-subtitle {
        font-size: 14px;
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
      }

      .modal-close-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: var(--neutral-100);
        border-radius: var(--radius-md);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: var(--text-secondary);
        transition: all var(--transition-base);
      }

      .modal-close-btn:hover {
        background: var(--danger-100);
        color: var(--danger-600);
      }

      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-xl);
      }

      .modal-search {
        margin-bottom: var(--spacing-xl);
      }

      .modal-search input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
        transition: all var(--transition-base);
      }

      .modal-search input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .modal-search::before {
        content: 'üîç';
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
      }

      .modal-search {
        position: relative;
      }

      .existing-tenders-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .existing-tender-card {
        background: var(--surface-0);
        border: 2px solid var(--neutral-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .existing-tender-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-md);
        transform: translateX(4px);
      }

      .existing-tender-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-md);
      }

      .existing-tender-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .existing-tender-reference {
        font-size: 13px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .existing-tender-details {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .existing-tender-meta {
        display: flex;
        gap: var(--spacing-lg);
        font-size: 13px;
        color: var(--text-secondary);
      }

      .existing-tender-template {
        font-size: 12px;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 4px 12px;
        border-radius: 12px;
        display: inline-block;
        width: fit-content;
      }

      .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .badge-success {
        background: var(--success-100);
        color: var(--success-700);
      }

      .badge-warning {
        background: var(--warning-100);
        color: var(--warning-600);
      }

      .badge-info {
        background: var(--info-100);
        color: var(--info-600);
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .loading-content {
        background: var(--surface-0);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        text-align: center;
        box-shadow: var(--shadow-2xl);
      }

      .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--neutral-200);
        border-top-color: var(--primary-500);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto var(--spacing-lg);
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* ===== EVALUATION CRITERIA ENHANCED STYLES ===== */
      .evaluation-criterion-card {
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-base);
      }

      .evaluation-criterion-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-200);
      }

      .criterion-applies-to-section {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .lot-selection-group,
      .product-selection-group {
        margin-bottom: var(--spacing-md);
      }

      .lot-selection-group:last-child,
      .product-selection-group:last-child {
        margin-bottom: 0;
      }

      .selection-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: var(--spacing-sm);
        display: block;
      }

      .criterion-selection-summary {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--info-50);
        border: 1px solid var(--info-200);
        border-radius: var(--radius-sm);
        color: var(--info-700);
      }

      .criterion-selection-summary strong {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
      }

      .criterion-selection-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-xs);
        font-size: 13px;
      }

      .criterion-selection-item::before {
        content: '‚úì';
        color: var(--info-600);
        font-weight: bold;
      }

      /* ===== PROCUREMENT LIFECYCLE TRACKER ===== */
      .lifecycle-tracker-container {
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-top: var(--spacing-md);
      }

      .lifecycle-tracker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .lifecycle-tracker-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .lifecycle-tracker-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .btn-icon {
        padding: 8px 12px;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .lifecycle-chain {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        overflow-x: auto;
        padding: var(--spacing-md) 0;
      }

      .lifecycle-node {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 140px;
        position: relative;
      }

      .lifecycle-node-badge {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: var(--neutral-100);
        border: 3px solid var(--neutral-300);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-base);
        cursor: pointer;
      }

      .lifecycle-node.current .lifecycle-node-badge {
        background: var(--primary-50);
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px var(--primary-100);
      }

      .lifecycle-node.completed .lifecycle-node-badge {
        background: var(--success-50);
        border-color: var(--success-500);
      }

      .lifecycle-node.future .lifecycle-node-badge {
        background: var(--surface-50);
        border-color: var(--neutral-200);
        opacity: 0.6;
      }

      .lifecycle-node-badge:hover {
        transform: scale(1.05);
      }

      .lifecycle-node-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: center;
        margin-bottom: var(--spacing-xs);
      }

      .lifecycle-node-id {
        font-size: 11px;
        color: var(--text-muted);
        font-family: 'Courier New', monospace;
      }

      .lifecycle-arrow {
        font-size: 20px;
        color: var(--neutral-300);
        margin: 0 var(--spacing-xs);
      }

      .lifecycle-arrow.active {
        color: var(--primary-400);
      }

      .linked-processes-list {
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
      }

      .linked-process-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        background: var(--surface-0);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-sm);
        transition: all var(--transition-base);
      }

      .linked-process-item:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-sm);
      }

      .linked-process-item:last-child {
        margin-bottom: 0;
      }

      .linked-process-info {
        flex: 1;
      }

      .linked-process-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .linked-process-meta {
        display: flex;
        gap: var(--spacing-lg);
        font-size: 12px;
        color: var(--text-muted);
      }

      .linked-process-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .btn-link-action {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--neutral-200);
        background: var(--surface-0);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .btn-link-action:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-600);
      }

      .btn-link-action.remove:hover {
        background: var(--danger-50);
        border-color: var(--danger-400);
        color: var(--danger-600);
      }

      .lifecycle-relationship-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .relationship-predecessor {
        background: var(--info-100);
        color: var(--info-600);
      }

      .relationship-successor {
        background: var(--success-100);
        color: var(--success-600);
      }

      .relationship-related {
        background: var(--warning-100);
        color: var(--warning-600);
      }

      .lifecycle-empty-state {
        text-align: center;
        padding: var(--spacing-2xl);
        color: var(--text-muted);
      }

      .lifecycle-empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
      }

      .lifecycle-search-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
      }

      .lifecycle-search-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-2xl);
        max-width: 700px;
        width: 90%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .lifecycle-search-header {
        padding: var(--spacing-xl);
        border-bottom: 1px solid var(--neutral-200);
      }

      .lifecycle-search-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-xl);
      }

      .lifecycle-search-input-wrapper {
        position: relative;
        margin-bottom: var(--spacing-lg);
      }

      .lifecycle-search-input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        font-family: inherit;
      }

      .lifecycle-search-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .lifecycle-search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
      }

      .lifecycle-search-results {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .lifecycle-search-result {
        padding: var(--spacing-md);
        border: 1px solid var(--neutral-200);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-base);
      }

      .lifecycle-search-result:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
      }

      .lifecycle-search-result-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .lifecycle-search-result-meta {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        gap: var(--spacing-md);
      }

      .lifecycle-audit-trail {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--neutral-200);
      }

      .lifecycle-audit-trail-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .lifecycle-audit-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) 0;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .lifecycle-audit-item::before {
        content: '‚Ä¢';
        color: var(--primary-400);
        font-weight: bold;
      }

      .lifecycle-audit-timestamp {
        color: var(--text-muted);
        margin-left: auto;
      }

      /* ===== EVENT SETUP WIZARD STYLES ===== */
      .wizard-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
        padding: var(--spacing-xl);
      }

      .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-2xl);
        position: relative;
      }

      .wizard-steps::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--surface-200);
        z-index: 0;
      }

      .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 1;
        flex: 1;
      }

      .wizard-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        right: -50%;
        height: 2px;
        background: var(--surface-200);
        z-index: -1;
      }

      .wizard-step:first-child::before {
        left: 50%;
      }

      .wizard-step:last-child::before {
        display: none;
      }

      .wizard-step.completed::before {
        background: var(--success-500);
      }

      .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--surface-0);
        border: 2px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: var(--spacing-sm);
        transition: all 0.2s ease;
      }

      .wizard-step.active .step-circle {
        background: var(--primary-400);
        border-color: var(--primary-400);
        color: white;
      }

      .wizard-step.completed .step-circle {
        background: var(--success-500);
        border-color: var(--success-500);
        color: white;
      }

      .wizard-step.completed .step-circle::after {
        content: '‚úì';
      }

      .step-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-align: center;
        font-weight: 500;
      }

      .wizard-step.active .step-label {
        color: var(--primary-400);
        font-weight: 600;
      }

      .wizard-content {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        box-shadow: var(--shadow-card);
        border: 1px solid var(--surface-200);
        min-height: 500px;
      }

      .wizard-step-content {
        display: none;
      }

      .wizard-step-content.active {
        display: block;
      }

      .step-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .step-description {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xl);
      }

      /* ===== TENDER AUTHORING STYLES ===== */
      .progress-container {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        padding: var(--spacing-md) var(--spacing-xl);
      }

      .progress-steps {
        display: flex;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
        gap: var(--spacing-sm);
      }

      .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        cursor: pointer;
      }

      .progress-step::before {
        content: '';
        position: absolute;
        top: 15px;
        left: -50%;
        right: 50%;
        height: 2px;
        background: var(--surface-200);
        z-index: 0;
      }

      .progress-step:first-child::before {
        display: none;
      }

      .progress-step.completed::before {
        background: var(--success-500);
      }

      .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--surface-0);
        border: 2px solid var(--surface-200);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        z-index: 1;
        margin-bottom: var(--spacing-xs);
      }

      .progress-step.completed .step-icon {
        background: var(--success-500);
        color: white;
        border-color: var(--success-500);
      }

      .progress-step.active .step-icon {
        background: var(--primary-400);
        color: white;
        border-color: var(--primary-400);
      }

      .step-label {
        font-size: 11px;
        text-align: center;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .progress-step.active .step-label {
        color: var(--primary-400);
        font-weight: 600;
      }

      .block-nav {
        background: var(--surface-0);
        border-bottom: 1px solid var(--surface-200);
        padding: 0 var(--spacing-xl);
        display: flex;
        gap: var(--spacing-xs);
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .block-tab {
        padding: 12px 20px;
        border: none;
        border-bottom: 3px solid transparent;
        background: transparent;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
        position: relative;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .block-tab:hover {
        color: var(--text-primary);
        background: var(--surface-50);
      }

      .block-tab.active {
        color: var(--primary-400);
        border-bottom-color: var(--primary-400);
        font-weight: 600;
      }

      .block-tab-icon {
        font-size: 18px;
      }

      .block-tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--surface-200);
        color: var(--text-muted);
        font-size: 11px;
        font-weight: 600;
      }

      .block-tab.active .block-tab-badge {
        background: var(--primary-400);
        color: white;
      }

      .content-area {
        flex: 1;
        display: flex;
        gap: var(--spacing-lg);
        overflow: hidden;
        padding: var(--spacing-xl);
      }

      .content-wrapper {
        flex: 1;
        max-width: 1200px;
        margin: 0 auto;
        overflow-y: auto;
      }

      /* Form Library Panel */
      .form-library-panel {
        width: 320px;
        background: var(--surface-0);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: var(--shadow-card);
        transition: width 0.3s ease;
      }

      .form-library-panel.collapsed {
        width: 0;
        border: none;
        padding: 0;
        overflow: hidden;
      }

      .form-library-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--surface-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-50);
      }

      .form-library-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .toggle-library-btn {
        width: 28px;
        height: 28px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .toggle-library-btn:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-400);
      }

      .form-library-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      .form-library-search {
        position: relative;
      }

      .form-library-search input {
        width: 100%;
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
        padding: 8px 12px 8px 36px;
        font-family: inherit;
        font-size: 14px;
        background: var(--surface-0);
        color: var(--text-primary);
        transition: all 0.2s ease;
      }

      .form-library-search input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .form-library-search::before {
        content: 'üîç';
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        pointer-events: none;
      }

      .form-library-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .form-library-group-label {
        font-size: 12px;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: var(--spacing-xs);
        font-weight: 600;
      }

      .form-library-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        max-height: 400px;
        overflow-y: auto;
      }

      .form-library-item {
        border: 1px dashed var(--surface-300);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        cursor: grab;
        transition: all 0.2s ease;
        background: var(--surface-50);
      }

      .form-library-item:hover {
        border-color: var(--primary-400);
        background: var(--primary-50);
        transform: translateY(-1px);
      }

      .form-library-item:active {
        cursor: grabbing;
      }

      .form-library-item strong {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .form-library-item span {
        font-size: 12px;
        color: var(--text-muted);
        line-height: 1.4;
      }

      /* Added Forms Display */
      .added-forms-section {
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--surface-200);
      }

      .added-form-item {
        padding: var(--spacing-md);
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .added-form-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .added-form-icon {
        font-size: 20px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
      }

      .added-form-details {
        flex: 1;
      }

      .added-form-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .added-form-type {
        font-size: 12px;
        color: var(--text-muted);
      }

      .added-form-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .form-action-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: var(--text-secondary);
        transition: all 0.2s ease;
      }

      .form-action-btn:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
        color: var(--primary-400);
      }

      .form-action-btn.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-500);
        color: var(--danger-500);
      }

      /* Drop Zone in Sections */
      .form-drop-zone {
        min-height: 80px;
        border: 2px dashed var(--surface-300);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        margin: var(--spacing-md) 0;
        transition: all 0.2s ease;
        background: var(--surface-50);
        font-size: 13px;
      }

      .form-drop-zone.active {
        border-color: var(--success-500);
        background: var(--success-50);
        color: var(--success-500);
      }

      /* Floating Toggle Button */
      .floating-library-toggle {
        position: fixed;
        right: var(--spacing-xl);
        bottom: var(--spacing-xl);
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary-400);
        color: white;
        border: none;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: var(--shadow-card);
        z-index: 50;
        transition: all 0.2s ease;
      }

      .floating-library-toggle:hover {
        background: var(--primary-500);
        transform: scale(1.1);
      }

      /* Show floating toggle when panel is collapsed */
      .form-library-panel.collapsed ~ .floating-library-toggle {
        display: flex;
      }

      /* Scrollbar for form library */
      .form-library-body::-webkit-scrollbar,
      .form-library-list::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .form-library-body::-webkit-scrollbar-track,
      .form-library-list::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .form-library-body::-webkit-scrollbar-thumb,
      .form-library-list::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .form-library-body::-webkit-scrollbar-thumb:hover,
      .form-library-list::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      /* Common Form Styles */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .required {
        color: var(--danger-500);
      }

      .form-input,
      .form-select,
      .form-textarea {
        padding: 12px 16px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-family: inherit;
        background: var(--surface-0);
        color: var(--text-primary);
        transition: all 0.2s ease;
        width: 100%;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .form-textarea {
        resize: vertical;
        min-height: 120px;
      }

      /* Rich Text Editor */
      .rich-text-editor-container {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        overflow: hidden;
        background: var(--surface-0);
      }

      .rich-text-toolbar {
        display: flex;
        gap: 4px;
        padding: 8px;
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
        flex-wrap: wrap;
      }

      .toolbar-btn {
        padding: 6px 10px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      .toolbar-btn:hover {
        background: var(--surface-100);
        border-color: var(--primary-300);
      }

      .toolbar-btn:active {
        background: var(--primary-100);
      }

      .toolbar-divider {
        width: 1px;
        background: var(--surface-200);
        margin: 0 4px;
      }

      .rich-text-editor {
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
        padding: 16px;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-primary);
        outline: none;
      }

      .rich-text-editor:focus {
        box-shadow: inset 0 0 0 2px var(--primary-50);
      }

      .rich-text-editor[contenteditable]:empty:before {
        content: attr(placeholder);
        color: var(--text-muted);
        pointer-events: none;
        display: block;
      }

      .rich-text-editor h3 {
        font-size: 18px;
        font-weight: 600;
        margin: 16px 0 8px 0;
        color: var(--text-primary);
      }

      .rich-text-editor h4 {
        font-size: 16px;
        font-weight: 600;
        margin: 12px 0 6px 0;
        color: var(--text-primary);
      }

      .rich-text-editor p {
        margin: 8px 0;
      }

      .rich-text-editor ul,
      .rich-text-editor ol {
        margin: 8px 0;
        padding-left: 24px;
      }

      .rich-text-editor li {
        margin: 4px 0;
      }

      .rich-text-editor strong {
        font-weight: 600;
      }

      .rich-text-editor em {
        font-style: italic;
      }

      .rich-text-editor u {
        text-decoration: underline;
      }

      .rich-text-editor s,
      .rich-text-editor strike {
        text-decoration: line-through;
      }

      .rich-text-editor blockquote {
        border-left: 4px solid var(--primary-400);
        padding-left: 16px;
        margin: 12px 0;
        color: var(--text-secondary);
        font-style: italic;
      }

      .rich-text-editor a {
        color: var(--primary-500);
        text-decoration: underline;
      }

      .rich-text-editor a:hover {
        color: var(--primary-600);
      }

      .rich-text-editor hr {
        border: none;
        border-top: 2px solid var(--surface-200);
        margin: 16px 0;
      }

      .toolbar-btn.active {
        background: var(--primary-100);
        border-color: var(--primary-400);
        color: var(--primary-600);
      }

      .toolbar-group {
        display: flex;
        gap: 4px;
        align-items: center;
      }

      .editor-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--surface-50);
        border-top: 1px solid var(--surface-200);
        font-size: 12px;
        color: var(--text-muted);
      }

      .editor-word-count {
        display: flex;
        gap: 16px;
      }

      .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: var(--spacing-xs);
      }

      /* Form Sections - Modern Cards */
      .form-section {
        background: var(--surface-0);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--neutral-200);
        transition: all var(--transition-base);
      }

      .form-section:hover {
        box-shadow: var(--shadow-md);
      }

      /* Collapsible functionality removed - all sections are always visible */
      /* .form-section.collapsed .section-body {
        display: none;
      } */

      .section-header {
        padding: var(--spacing-lg) var(--spacing-xl);
        border-bottom: 1px solid var(--neutral-100);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to bottom, var(--neutral-50) 0%, var(--surface-0) 100%);
      }

      .section-title {
        font-size: 17px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .section-icon {
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-xs);
      }

      /* .collapse-icon {
        font-size: 12px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
        margin-left: var(--spacing-sm);
      } */

      /* .form-section.collapsed .collapse-icon {
        transform: rotate(-90deg);
      } */

      .status-indicator {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid transparent;
        transition: all var(--transition-fast);
      }

      .status-complete {
        background: var(--success-50);
        color: var(--success-600);
        border-color: var(--success-100);
      }

      .status-incomplete {
        background: var(--warning-50);
        color: var(--warning-600);
        border-color: var(--warning-100);
      }

      .section-body {
        padding: var(--spacing-lg);
      }

      /* Template Cards */
      .template-suggestions {
        margin-top: var(--spacing-xl);
      }

      .suggestions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-lg);
      }

      .suggestions-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .suggestions-badge {
        padding: 4px 10px;
        background: var(--info-50);
        color: var(--info-400);
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }

      .template-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
      }

      .template-card {
        border: 2px solid var(--surface-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--surface-0);
      }

      .template-card:hover {
        border-color: var(--primary-400);
        box-shadow: var(--shadow-card);
        transform: translateY(-2px);
      }

      .template-card.selected {
        border-color: var(--primary-400);
        background: var(--primary-50);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .template-card.recommended {
        border-color: var(--success-500);
        position: relative;
      }

      .template-card.recommended::before {
        content: '‚≠ê Recommended';
        position: absolute;
        top: -12px;
        left: var(--spacing-md);
        background: var(--success-500);
        color: white;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }

      .template-card-header {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
      }

      .template-icon {
        font-size: 32px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-50);
        border-radius: var(--radius-sm);
        flex-shrink: 0;
      }

      .template-info {
        flex: 1;
      }

      .template-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .template-type {
        font-size: 12px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .template-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-top: var(--spacing-sm);
      }

      .template-meta {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--surface-200);
        font-size: 12px;
        color: var(--text-muted);
      }

      .template-meta-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .view-all-link {
        text-align: center;
        margin-top: var(--spacing-lg);
      }

      .view-all-link a {
        color: var(--primary-400);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
      }

      .view-all-link a:hover {
        text-decoration: underline;
      }

      /* Alerts */
      .info-alert {
        padding: var(--spacing-md);
        background: var(--info-50);
        border-left: 4px solid var(--info-400);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-lg);
      }

      .info-alert-text {
        font-size: 14px;
        color: var(--info-400);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      /* Action Footer */
      .action-footer {
        background: var(--surface-0);
        border-top: 1px solid var(--surface-200);
        padding: var(--spacing-md) var(--spacing-xl);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .footer-info {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .footer-actions {
        display: flex;
        gap: var(--spacing-md);
      }

      /* Scrollbar Styling */
      .content-area::-webkit-scrollbar,
      .block-nav::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .content-area::-webkit-scrollbar-track,
      .block-nav::-webkit-scrollbar-track {
        background: var(--surface-100);
      }

      .content-area::-webkit-scrollbar-thumb,
      .block-nav::-webkit-scrollbar-thumb {
        background: var(--surface-300);
        border-radius: 4px;
      }

      .content-area::-webkit-scrollbar-thumb:hover,
      .block-nav::-webkit-scrollbar-thumb:hover {
        background: var(--surface-600);
      }

      .hidden {
        display: none;
      }

      /* Requisition & Lots Styles */
      .requisition-section,
      .lots-section,
      .structure-summary {
        margin-bottom: var(--spacing-2xl);
      }

      .section-subheader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .section-subheader h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .badge {
        padding: 4px 12px;
        background: var(--primary-50);
        color: var(--primary-400);
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      /* Requisition Table */
      .requisition-table-container {
        overflow-x: auto;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
      }

      .requisition-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface-0);
      }

      .requisition-table thead {
        background: var(--surface-50);
        border-bottom: 2px solid var(--surface-200);
      }

      .requisition-table th {
        padding: var(--spacing-md);
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .requisition-table td {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--surface-200);
        font-size: 14px;
      }

      .requisition-table tbody tr:hover {
        background: var(--surface-50);
      }

      .unspsc-code {
        font-weight: 600;
        color: var(--primary-400);
        font-family: 'Courier New', monospace;
      }

      .unspsc-desc {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      .status-badge.assigned {
        background: var(--success-50);
        color: var(--success-500);
      }

      .status-badge.unassigned {
        background: var(--warning-50);
        color: var(--warning-500);
      }

      .match-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: var(--success-50);
        color: var(--success-500);
      }

      .match-badge.new {
        background: var(--info-50);
        color: var(--info-400);
      }

      .quantity-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: var(--primary-50);
        color: var(--primary-600);
      }

      /* Lots */
      .lots-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
      }

      .lot-card {
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        background: var(--surface-0);
        overflow: hidden;
      }

      .lot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--surface-50);
        border-bottom: 1px solid var(--surface-200);
      }

      .lot-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1;
      }

      .lot-number {
        padding: 4px 10px;
        background: var(--primary-400);
        color: white;
        border-radius: var(--radius-sm);
        font-size: 12px;
        font-weight: 600;
      }

      .lot-name-input {
        flex: 1;
        padding: 6px 12px;
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 600;
        font-family: inherit;
        background: var(--surface-0);
        color: var(--text-primary);
        min-width: 200px;
      }

      .lot-name-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 2px var(--primary-50);
      }

      .lot-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .btn-icon {
        width: 32px;
        height: 32px;
        border: 1px solid var(--surface-200);
        background: var(--surface-0);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      .btn-icon:hover {
        background: var(--primary-50);
        border-color: var(--primary-400);
      }

      .btn-icon.danger:hover {
        background: var(--danger-50);
        border-color: var(--danger-500);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        height: auto;
      }

      .lot-body {
        padding: var(--spacing-lg);
      }

      .lot-lines-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .lot-lines-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .lot-line-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px solid var(--surface-200);
      }

      .lot-line-code {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: var(--primary-400);
        min-width: 100px;
      }

      .lot-line-desc {
        flex: 1;
        font-size: 14px;
        color: var(--text-primary);
      }

      .lot-line-qty {
        font-size: 13px;
        color: var(--text-secondary);
        min-width: 80px;
      }

      .btn-icon-sm {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-muted);
        transition: all 0.2s ease;
        border-radius: var(--radius-sm);
      }

      .btn-icon-sm:hover {
        background: var(--danger-50);
        color: var(--danger-500);
      }

      .lot-empty {
        padding: var(--spacing-lg);
        text-align: center;
        color: var(--text-muted);
        font-size: 14px;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      /* Empty State */
      .empty-state {
        padding: var(--spacing-2xl);
        text-align: center;
        background: var(--surface-50);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: var(--spacing-md);
      }

      .empty-state-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
      }

      .empty-state-hint {
        font-size: 14px;
        color: var(--text-muted);
        margin-bottom: var(--spacing-lg);
      }

      /* Product Requirements & Specifications Styles */
      .product-requirements-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-2xl);
      }

      .product-requirement-card {
        background: var(--surface-white);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-md);
        overflow: hidden;
      }

      .product-requirement-header {
        background: var(--surface-50);
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--surface-300);
      }

      .product-requirement-title {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex-wrap: wrap;
      }

      .unspsc-code-large {
        font-family: 'Courier New', monospace;
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 4px 12px;
        border-radius: var(--radius-sm);
      }

      .unspsc-description-large {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
      }

      .product-requirement-body {
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-2xl);
      }

      .requirement-section,
      .supplier-section {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .requirement-section {
        border: 2px solid var(--primary-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        background: var(--primary-25);
      }

      .supplier-section {
        border: 2px solid var(--teal-200);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        background: var(--teal-25);
      }

      .requirement-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .requirement-section-header h4 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .requirement-empty {
        text-align: center;
        padding: var(--spacing-xl);
        background: var(--surface-white);
        border-radius: var(--radius-sm);
        border: 1px dashed var(--surface-300);
      }

      .requirement-empty p {
        margin: 0 0 var(--spacing-md) 0;
        color: var(--text-muted);
        font-size: 14px;
      }

      .requirement-empty .or-text {
        display: block;
        margin: var(--spacing-sm) 0;
        color: var(--text-muted);
        font-size: 12px;
      }

      .requirement-attributes-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .requirement-attribute-item {
        background: var(--surface-white);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
      }

      .supplier-field {
        background: var(--teal-50);
        border-color: var(--teal-200);
      }

      .attribute-row {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
      }

      .attribute-name {
        flex: 1;
        min-width: 0;
      }

      .attribute-value {
        flex: 1.5;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .attribute-name-input,
      .attribute-value-input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--surface-300);
        border-radius: var(--radius-sm);
        font-size: 14px;
        color: var(--text-primary);
        background: var(--surface-white);
      }

      .attribute-name-input {
        font-weight: 600;
      }

      .attribute-name-input:focus,
      .attribute-value-input:focus {
        outline: none;
        border-color: var(--primary-400);
        box-shadow: 0 0 0 3px var(--primary-50);
      }

      .field-hint {
        font-size: 11px;
        color: var(--text-muted);
        font-style: italic;
      }

      .btn-icon-sm {
        width: 28px;
        height: 28px;
        padding: 0;
        border: 1px solid var(--surface-300);
        background: var(--surface-white);
        color: var(--text-muted);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .btn-icon-sm:hover {
        background: var(--danger-50);
        border-color: var(--danger-300);
        color: var(--danger-600);
      }

      .requirement-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
      }

      /* Structure Summary */
      .summary-card {
        background: var(--surface-50);
        border: 1px solid var(--surface-200);
        border-radius: var(--radius-sm);
        padding: var(--spacing-lg);
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--surface-200);
      }

      .summary-item:last-child {
        border-bottom: none;
      }

      .summary-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .summary-value {
        font-size: 14px;
        color: var(--text-primary);
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="top-bar__brand">
          <div class="logo">UNOPS</div>
          <div>
            <div class="top-bar__title" id="page-title">Procurement Portal | Create New Tender</div>
            <div class="top-bar__breadcrumbs" id="page-breadcrumbs">Event Setup</div>
          </div>
        </div>
        <div class="top-bar__actions" id="top-actions">
          <button class="btn btn-ghost" onclick="window.location.href='template-library.html'">Cancel</button>
        </div>
      </div>

      <!-- Workspace -->
      <div class="workspace">
        <!-- Left Rail Navigation -->
        <nav class="rail" aria-label="Primary navigation">
          <button class="active" title="Create Tender">
            <span>üöÄ</span>
            <span class="rail-label">Create Tender</span>
          </button>
          <button title="Templates" onclick="window.location.href='template-library.html'">
            <span>üìö</span>
            <span class="rail-label">Templates</span>
          </button>
          <button title="Dashboard">
            <span>üìä</span>
            <span class="rail-label">Dashboard</span>
          </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Tender Initiation Method Selection -->
          <div class="view-section active" id="initiation-view">
            <div class="initiation-container">
              <div class="initiation-header">
                <h1 class="initiation-title">Create New Tender</h1>
                <p class="initiation-subtitle">Choose how you'd like to start creating your tender. Select the method that best suits your needs.</p>
              </div>

              <div class="initiation-options">
                <!-- Option 1: Guided Wizard -->
                <div class="initiation-card" onclick="startWithWizard()">
                  <div class="initiation-card-badge">Recommended</div>
                  <div class="initiation-card-icon">üßô‚Äç‚ôÇÔ∏è</div>
                  <h3 class="initiation-card-title">Guided Wizard</h3>
                  <p class="initiation-card-description">
                    Answer a few questions and we'll help you find the perfect template for your procurement needs.
                  </p>
                  <ul class="initiation-card-features">
                    <li>Smart template recommendations</li>
                    <li>Step-by-step guidance</li>
                    <li>Best for new tenders</li>
                    <li>Personalized suggestions</li>
                  </ul>
                  <div class="initiation-card-action">
                    <button class="btn btn-primary">Start with Wizard</button>
                  </div>
                </div>

                <!-- Option 2: Template Library -->
                <div class="initiation-card" onclick="startWithTemplate()">
                  <div class="initiation-card-icon">üìö</div>
                  <h3 class="initiation-card-title">Pick from Templates</h3>
                  <p class="initiation-card-description">
                    Browse our complete template library and select a pre-configured tender template to start with.
                  </p>
                  <ul class="initiation-card-features">
                    <li>View all available templates</li>
                    <li>Compare template features</li>
                    <li>Best for experienced users</li>
                    <li>Direct template selection</li>
                  </ul>
                  <div class="initiation-card-action">
                    <button class="btn btn-ghost">Browse Templates</button>
                  </div>
                </div>

                <!-- Option 3: Clone Existing Tender -->
                <div class="initiation-card" onclick="startWithClone()">
                  <div class="initiation-card-icon">üìã</div>
                  <h3 class="initiation-card-title">Clone Existing Tender</h3>
                  <p class="initiation-card-description">
                    Start from a previously created tender. All blocks, fields, and configurations will be copied.
                  </p>
                  <ul class="initiation-card-features">
                    <li>Reuse existing setup</li>
                    <li>Maintain consistency</li>
                    <li>Save time on configuration</li>
                    <li>Perfect for similar tenders</li>
                  </ul>
                  <div class="initiation-card-action">
                    <button class="btn btn-ghost">Select Tender to Clone</button>
                  </div>
                </div>
              </div>

              <div class="info-alert" style="max-width: 700px; margin: 0 auto;">
                <div class="info-alert-text">
                  üí° <strong>Not sure which to choose?</strong> We recommend starting with the Guided Wizard if you're creating a new type of tender or need help selecting the right template.
                </div>
              </div>
            </div>
          </div>

          <!-- Event Setup Wizard View -->
          <div class="view-section" id="wizard-view">
            <div class="wizard-container">
              <!-- Wizard Steps Indicator -->
              <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                  <div class="step-circle">1</div>
                  <div class="step-label">Procurement Details</div>
                </div>
                <div class="wizard-step" data-step="2">
                  <div class="step-circle">2</div>
                  <div class="step-label">Template Selection</div>
                </div>
                <div class="wizard-step" data-step="3">
                  <div class="step-circle">3</div>
                  <div class="step-label">Review & Initiate</div>
                </div>
              </div>

              <!-- Wizard Content -->
              <div class="wizard-content">
                <!-- Step 1: Procurement Details -->
                <div class="wizard-step-content active" id="step-1">
                  <h2 class="step-title">What are you procuring?</h2>
                  <p class="step-description">Tell us about your procurement needs to find the best template</p>

                  <div class="form-grid">
                    <div class="form-group">
                      <label class="form-label">Type of Requirement <span class="required">*</span></label>
                      <select class="form-select" id="requirement-type" required>
                        <option value="">Select...</option>
                        <option value="goods">Goods</option>
                        <option value="services">Services</option>
                        <option value="works">Works</option>
                        <option value="goods-services">Goods & Services</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Sourcing or Solicitation? <span class="required">*</span></label>
                      <select class="form-select" id="sourcing-type" required>
                        <option value="">Select...</option>
                        <option value="sourcing">Sourcing</option>
                        <option value="solicitation">Solicitation</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Solicitation Method <span class="required">*</span></label>
                      <select class="form-select" id="method" required>
                        <option value="">Select...</option>
                        <option value="itb">ITB - Invitation to Bid</option>
                        <option value="rfp">RFP - Request for Proposal</option>
                        <option value="rfq">RFQ - Request for Quotation</option>
                        <option value="eoi">EOI - Expression of Interest</option>
                        <option value="direct">Direct Contracting</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Estimated Value (USD) <span class="required">*</span></label>
                      <input type="number" class="form-input" id="estimated-value" placeholder="0.00" required />
                      <span class="help-text">Approximate contract value</span>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Project Type</label>
                      <select class="form-select" id="project-type">
                        <option value="">Select...</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="health">Health</option>
                        <option value="education">Education</option>
                        <option value="emergency">Emergency</option>
                        <option value="other">Other</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label class="form-label">Beneficiary Country(ies)</label>
                      <select class="form-select" id="country" multiple>
                        <option value="afghanistan">Afghanistan</option>
                        <option value="bangladesh">Bangladesh</option>
                        <option value="cambodia">Cambodia</option>
                        <option value="ethiopia">Ethiopia</option>
                        <option value="haiti">Haiti</option>
                      </select>
                      <span class="help-text">Select one or more countries</span>
                    </div>

                    <div class="form-group full-width">
                      <label class="form-label">Brief Description</label>
                      <textarea class="form-textarea" id="description" placeholder="Brief description of the procurement objective..."></textarea>
                      <span class="help-text">This helps us suggest the most relevant template</span>
                    </div>
                  </div>
                </div>

                <!-- Step 2: Template Selection -->
                <div class="wizard-step-content" id="step-2">
                  <h2 class="step-title">Select a Template</h2>
                  <p class="step-description">Based on your answers, we've found the best matching templates</p>

                  <div class="info-alert">
                    <div class="info-alert-text">
                      üí° We recommend the template below based on your procurement type and method
                    </div>
                  </div>

                  <div class="template-suggestions">
                    <div class="suggestions-header">
                      <div class="suggestions-title">
                        Suggested Templates
                        <span class="suggestions-badge" id="suggestion-count">3 matches</span>
                      </div>
                    </div>

                    <div class="template-cards" id="template-cards">
                      <!-- Template cards will be dynamically generated -->
                    </div>

                    <div class="view-all-link">
                      <a href="template-library.html">
                        View All Templates
                        <span>‚Üí</span>
                      </a>
                    </div>
                  </div>
                </div>

                <!-- Step 3: Review & Initiate -->
                <div class="wizard-step-content" id="step-3">
                  <h2 class="step-title">Review & Initiate Tender</h2>
                  <p class="step-description">Review your selections and initiate the tender authoring process</p>

                  <div class="form-grid">
                    <div class="form-group full-width">
                      <label class="form-label">Tender Title <span class="required">*</span></label>
                      <input type="text" class="form-input" id="tender-title" placeholder="Enter tender title" required />
                    </div>

                    <div class="form-group">
                      <label class="form-label">Reference Number</label>
                      <input type="text" class="form-input" id="reference" value="Auto-generated" readonly style="background: var(--surface-50);" />
                    </div>

                    <div class="form-group">
                      <label class="form-label">Selected Template</label>
                      <input type="text" class="form-input" id="selected-template-display" readonly style="background: var(--surface-50);" />
                    </div>

                    <div class="form-group">
                      <label class="form-label">Type of Requirement</label>
                      <input type="text" class="form-input" id="review-requirement-type" readonly style="background: var(--surface-50);" />
                    </div>

                    <div class="form-group">
                      <label class="form-label">Solicitation Method</label>
                      <input type="text" class="form-input" id="review-method" readonly style="background: var(--surface-50);" />
                    </div>

                    <div class="form-group">
                      <label class="form-label">Estimated Value</label>
                      <input type="text" class="form-input" id="review-value" readonly style="background: var(--surface-50);" />
                    </div>
                  </div>

                  <div class="info-alert">
                    <div class="info-alert-text">
                      ‚ÑπÔ∏è Once initiated, you'll proceed to the authoring workspace where you can customize the template and complete all tender details
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Wizard Action Footer -->
            <footer class="action-footer">
              <div></div>
              <div class="footer-actions">
                <button class="btn btn-ghost" id="wizard-prev-btn" style="display: none;">Previous</button>
                <button class="btn btn-primary" id="wizard-next-btn">Next</button>
              </div>
            </footer>
          </div>

          <!-- Tender Authoring View -->
          <div class="view-section" id="authoring-view">
            <!-- Progress Steps -->
            <div class="progress-container">
              <div class="progress-steps">
                <div class="progress-step completed" data-step="1">
                  <div class="step-icon">‚úì</div>
                  <div class="step-label">Event Setup</div>
                </div>
                <div class="progress-step active" data-step="2">
                  <div class="step-icon">2</div>
                  <div class="step-label">Authoring</div>
                </div>
                <div class="progress-step" data-step="3">
                  <div class="step-icon">3</div>
                  <div class="step-label">Review</div>
                </div>
                <div class="progress-step" data-step="4">
                  <div class="step-icon">4</div>
                  <div class="step-label">Publish</div>
                </div>
              </div>
            </div>

            <!-- Block Navigation Tabs -->
            <div class="block-nav" id="block-nav">
              <!-- Block tabs will be dynamically generated -->
            </div>

            <!-- Content Area -->
            <div class="content-area">
              <div class="content-wrapper" id="content-wrapper">
                <!-- Content will be dynamically generated based on selected block -->
              </div>

              <!-- Form Library Panel -->
              <div class="form-library-panel" id="form-library-panel">
                <div class="form-library-header">
                  <div class="form-library-title">Form Library</div>
                  <button class="toggle-library-btn" onclick="toggleFormLibrary()" title="Collapse">‚úï</button>
                </div>
                <div class="form-library-body">
                  <div class="form-library-search">
                    <input type="search" placeholder="Search forms..." id="form-library-search" />
                  </div>
                  <div class="form-library-group">
                    <div class="form-library-group-label">Forms & Documents</div>
                    <div class="form-library-list" id="form-library-list">
                      <div class="form-library-item" draggable="true" data-form-type="instructions" data-form-name="Instructions to Bidders">
                        <strong>Instructions to Bidders</strong>
                        <span>Standard format</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="contracts" data-form-name="Contract Forms">
                        <strong>Contract Forms</strong>
                        <span>Offer & award</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="bank-guarantee" data-form-name="Bank Guarantee Form">
                        <strong>Bank Guarantee Form</strong>
                        <span>Security requirements</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="bid-security" data-form-name="Bid Security Form">
                        <strong>Bid Security Form</strong>
                        <span>Security requirements</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="drive-questionnaire" data-form-name="DRiVE Questionnaire">
                        <strong>DRiVE Questionnaire</strong>
                        <span>Risk assessment questionnaire</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="technical-specs" data-form-name="Technical Specifications">
                        <strong>Technical Specifications</strong>
                        <span>Detailed technical requirements</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="evaluation" data-form-name="Evaluation Form">
                        <strong>Evaluation Form</strong>
                        <span>Scoring and evaluation matrix</span>
                      </div>
                      <div class="form-library-item" draggable="true" data-form-type="price-schedule" data-form-name="Price Schedule">
                        <strong>Price Schedule</strong>
                        <span>Pricing breakdown template</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Floating Toggle Button (shown when panel is collapsed) -->
              <button class="floating-library-toggle" onclick="toggleFormLibrary()" title="Show Form Library">üìö</button>
            </div>

            <!-- Authoring Action Footer -->
            <footer class="action-footer">
              <div class="footer-info">Auto-saved 2 minutes ago</div>
              <div class="footer-actions">
                <button class="btn btn-ghost" id="prev-block-btn" style="display: none;">Previous Block</button>
                <button class="btn btn-primary" id="next-block-btn">Next Block</button>
              </div>
            </footer>
          </div>
        </main>
      </div>
    </div>

    <script>
      // ===== GLOBAL STATE =====
      let currentView = 'initiation'; // 'initiation', 'wizard', or 'authoring'
      let wizardStep = 1;
      const totalWizardSteps = 3;
      let selectedTemplate = null;
      let wizardData = {};

      // Template blocks structure (based on template builder)
      const templateBlocks = [
        {
          id: 'general',
          icon: 'üìã',
          name: 'General Information',
          sections: [
            {
              title: 'Basic Information',
              fields: [
                { id: 'title', label: 'Title', type: 'text', required: true, value: '' },
                { id: 'reference', label: 'Reference', type: 'text', required: true, value: 'Auto-generated', readonly: true },
                { id: 'sourcingOrSolicitation', label: 'Sourcing or Solicitation', type: 'select', required: true, options: ['Select...', 'Sourcing', 'Solicitation'], onchange: 'updateSourcingOrSolicitation' },
                { id: 'sourcingMethod', label: 'Sourcing Method', type: 'select', required: false, options: ['Select...', 'RFI', 'EOI', 'PQ', 'Ad-hoc shortlist'], conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Sourcing' } },
                { id: 'typeOfRequirement', label: 'Type of Requirement', type: 'select', required: true, options: ['Select...', 'Goods', 'Services', 'Works'] },
                { id: 'description', label: 'Description', type: 'textarea', required: true, value: '' },
                { id: 'beneficiaryCountries', label: 'Beneficiary country(ies)', type: 'select', required: false, multiple: true, options: ['Afghanistan', 'Bangladesh', 'Cambodia', 'India', 'Pakistan', 'Somalia', 'South Sudan', 'Sudan', 'Syria', 'Yemen'] },
                { id: 'modalityOfBidReceipt', label: 'Modality of Bid Receipt', type: 'select', required: true, options: ['Select...', 'Online Only', 'Email Submission', 'Physical Submission'], onchange: 'updateModalityOfBidReceipt' },
                { id: 'waiverForBidReceipt', label: 'Waiver for Bid Receipt Modality', type: 'text', required: false, value: '', placeholder: 'Provide waiver link', conditionalVisibility: { field: 'modalityOfBidReceipt', values: ['Email Submission', 'Physical Submission'] } },
                { id: 'epp', label: 'EPP', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateEPP' },
                { id: 'eppAuthorizationLink', label: 'EPP Authorization (Jira Link)', type: 'text', required: false, value: '', placeholder: 'Enter Jira link', conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'eppAuthorizationEndDate', label: 'EPP Authorization End Date', type: 'date', required: false, value: '', conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'scopeOfEPPApproval', label: 'Scope of EPP Approval', type: 'select', required: false, options: ['Select...', 'Project', 'Org Unit', 'Specific procurement process', 'Other'], conditionalVisibility: { field: 'epp', value: 'Yes' } },
                { id: 'medicineOrMedical', label: 'Medicine / Medical Equipment', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateMedicineOrMedical' },
                { id: 'policyExceptionLink', label: 'Policy Exception for Medicine/Medical Equipment Procurement (Annex 2 Jira Link)', type: 'text', required: false, value: '', placeholder: 'Enter Jira link', conditionalVisibility: { field: 'medicineOrMedical', value: 'Yes' } },
                { id: 'processType', label: 'Process Type', type: 'checkbox-group', required: false, options: ['Standard solicitation', 'Solicit offers against LTA/BPA', 'Secondary bidding against LTA/BPA', 'Direct contracting / Sole sourcing'], onchange: 'updateProcessType', conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Solicitation' } },
                { id: 'contractAmendment', label: 'Contract Amendment', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], conditionalVisibility: { field: 'processType', contains: 'Direct contracting / Sole sourcing' } },
                { id: 'solicitationMethod', label: 'Solicitation Method', type: 'select', required: false, options: ['Select...', 'RFQ', 'ITB', 'RFP', 'e-reserve auctions'], conditionalVisibility: { field: 'sourcingOrSolicitation', value: 'Solicitation' } },
                { id: 'procurementLifecycleTracker', label: 'Procurement Lifecycle & Related Processes', type: 'lifecycle-tracker', required: false, description: 'Link this process to related procurement events to maintain a complete audit trail' },
                { id: 'unCollaboration', label: 'UN Collaboration', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateUNCollaboration' },
                { id: 'unCollaborationType', label: 'UN Collaboration Type', type: 'select', required: false, options: ['Select...', 'Joint tendering process with other UN organizations', 'Secondary bidding using other UN agency\'s LTA', 'Re-use of solicitation results of another UN agency'], conditionalVisibility: { field: 'unCollaboration', value: 'Yes' } },
                { id: 'unAgencies', label: 'UN Agencies', type: 'select', required: false, multiple: true, options: ['UNDP', 'UNICEF', 'UNHCR', 'WFP', 'WHO', 'FAO', 'ILO', 'UNESCO', 'UNIDO'], conditionalVisibility: { field: 'unCollaboration', value: 'Yes' } },
                { id: 'organizationalUnit', label: 'Organizational Unit', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS' },
                { id: 'isLease', label: 'Is this a Lease', type: 'select', required: false, options: ['Select...', 'Yes', 'No'], onchange: 'updateIsLease' },
                { id: 'srmComplianceDocument', label: 'SRM Compliance Document', type: 'file', required: false, value: '', conditionalVisibility: { field: 'isLease', value: 'Yes' } },
              ],
            },
          ],
        },
        {
          id: 'project',
          icon: 'üèóÔ∏è',
          name: 'Project & Tender Details',
          sections: [
            {
              title: 'Project Information',
              fields: [
                { id: 'workPackage', label: 'Work Package (GLA)', type: 'search', required: true, value: '', placeholder: 'Search from oneUNOPS (requisition)', source: 'oneUNOPS' },
                { id: 'donorFundingSource', label: 'Donor / Funding Source (GLA)', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS', source: 'oneUNOPS' },
                { id: 'projectName', label: 'Project Name', type: 'text', required: true, value: '', source: 'oneUNOPS project' },
                { id: 'implementationEndDate', label: 'Implementation End Date', type: 'date', required: false, value: '', source: 'oneUNOPS project' },
              ],
            },
            {
              title: 'Particulars',
              isParticulars: true, // Special flag for custom rendering
            },
          ],
        },
        {
          id: 'requisition-lots',
          icon: 'üìã',
          name: 'Requisition & Lots',
          sections: [
            {
              title: 'Requisition & Lots Management',
              fields: [],
              isRequisitionLots: true, // Special flag for this section
            },
          ],
        },
        {
          id: 'scope',
          icon: 'üéØ',
          name: 'Scope & Requirements',
          sections: [
            {
              title: 'Scope and objectives',
              fields: [
                { label: 'Scope and objectives of sourcing or solicitation process', type: 'textarea', required: true, value: '' },
              ],
            },
            {
              title: 'Product Requirements & Specifications',
              fields: [],
              isProductRequirements: true,
            },
            {
              title: 'Other requirements',
              fields: [],
              isTenderAuthorConfig: true,
            },
          ],
        },
        {
          id: 'timeline',
          icon: 'üìÖ',
          name: 'Timeline & Deadlines',
          sections: [
            {
              title: 'Key Dates',
              fields: [
                { label: 'Deadline', type: 'datetime-local', required: true, value: '' },
                { label: 'Deadline for clarifications', type: 'datetime-local', required: false, value: '' },
                { label: 'Expected Contract award date', type: 'date', required: false, value: '' },
              ],
            },
          ],
        },
        {
          id: 'submission',
          icon: 'üìù',
          name: 'Submission Requirements',
          sections: [
            {
              title: 'Submission Details',
              fields: [
                { label: 'Quotation/Bid/Proposal validity period in days', type: 'number', required: true, value: '' },
                { label: 'Quotation/Bid/Proposal currency(ies)', type: 'select', required: true, multiple: true, options: ['USD', 'EUR', 'GBP', 'Local'] },
                { label: 'Languages of quotations/bids/proposals', type: 'select', required: true, multiple: true, options: ['English', 'French', 'Spanish'] },
              ],
            },
            {
              title: 'Bid Response Requirements',
              fields: [],
              isSupplierResponseStructure: true,
            },
            {
              title: 'Supplier Form Preview',
              fields: [],
              isSupplierFormPreview: true,
            },
          ],
        },
        {
          id: 'evaluation',
          icon: 'üìä',
          name: 'Evaluation',
          sections: [
            {
              title: 'Evaluation Method',
              fields: [
                { id: 'evaluationMethod', label: 'Evaluation method', type: 'select', required: true, options: ['Select...', 'Lowest price', 'Cumulative analysis', 'Two-stage'], onchange: 'updateEvaluationMethodInEvaluation' },
                { id: 'weightage', label: 'Weightage of technical and financial proposals', type: 'select', required: false, options: ['Select...', '70% technical / 30% financial', '60% technical / 40% financial', '80% technical / 20% financial'], conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'minPoints', label: 'Minimum Points for Technical compliance', type: 'number', required: false, value: '', placeholder: 'e.g., 70', conditionalVisibility: { field: 'evaluationMethod', value: 'Cumulative analysis' } },
                { id: 'evaluationMethodDetails', label: 'Evaluation method details', type: 'select', required: false, options: ['Select...', 'Standard evaluation', 'Detailed evaluation criteria', 'Other'], onchange: 'updateEvaluationMethodDetailsInEvaluation' },
                { id: 'evaluationMethodDetailsFreeText', label: 'Evaluation method details ‚Äì free text', type: 'textarea', required: false, value: '', placeholder: 'Provide detailed evaluation method description...', conditionalVisibility: { field: 'evaluationMethodDetails', value: 'Other' } },
              ],
            },
            {
              title: 'Evaluation Criteria',
              isEvaluationCriteria: true, // Special flag to render custom section
            },
          ],
        },
        {
          id: 'team',
          icon: 'üë•',
          name: 'Team',
          sections: [
            {
              title: 'Team Members',
              fields: [
                { id: 'alternateAuthors', label: 'Alternate authors (names)', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT', multiple: true },
                { id: 'procurementReviewer', label: 'Additional roles ‚Äì Procurement Reviewer', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT' },
                { id: 'procurementAuthority', label: 'Additional roles ‚Äì Procurement Authority', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT', prefilled: true },
                { id: 'technicalExpert', label: 'Additional roles ‚Äì Technical Matter Expert', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT' },
                { id: 'bidOpeningPanel', label: 'Additional roles ‚Äì Bid opening panel', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT', help: 'Required for public bid openings or offline tenders' },
                { id: 'evaluationTeam', label: 'Additional roles ‚Äì Evaluation team (Procurement Official, Chair, Members, Observers)', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT', multiple: true },
                { id: 'collaborators', label: 'Additional roles ‚Äì Collaborators', type: 'search', required: false, value: '', placeholder: 'Search from oneUNOPS (RDAT)', source: 'RDAT', multiple: true },
              ],
            },
          ],
        },
      ];

      let currentBlockIndex = 0;
      let currentAuthoringStep = 2;
      let addedForms = {}; // Store added forms by block and section: { blockId: { sectionIndex: [forms] } }
      
      // Requisition & Lots Management
      let requisitionLines = []; // From ERP integration (independent, just for reference)
      let lots = []; // Created lots: [{ id, name, unspscCodes: [{ code, description }] }]
      
      // Product Requirements (per UNSPSC code)
      let productRequirements = {}; // { unspscCode: { requirementType: 'attributes'|'description', attributes: [{name, value}], description: '' } }
      
      // Bid Response Requirements - Custom Fields
      let bidResponseFields = {
        perBid: [
          { name: "Bidder's Total Prices [Incoterm]", type: "Currency input", id: 'pb1' },
          { name: "Customs clearance costs", type: "Currency input", id: 'pb2' },
          { name: "Freight cost", type: "Currency input", id: 'pb3' },
          { name: "Total Price of Goods [Incoterm]", type: "Currency input (calculated)", id: 'pb4' },
          { name: "Total Price of Related Services", type: "Currency input", id: 'pb5' }
        ],
        perUNSPSC: [
          { name: "Unit price Incoterm", type: "Currency input", id: 'pu1' },
          { name: "Total price Incoterm", type: "Currency input (calculated)", id: 'pu2' },
          { name: "Country of Origin", type: "Country dropdown", id: 'pu3' },
          { name: "Delivery point(s)", type: "Text input", id: 'pu4' },
          { name: "Model", type: "Text input", id: 'pu5' },
          { name: "Manufacturer", type: "Text input", id: 'pu6' }
        ],
        perAttribute: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pa1' },
          { name: "Details of goods offered", type: "Text area", id: 'pa2' }
        ],
        perServiceLine: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'ps1' },
          { name: "Details", type: "Text area", id: 'ps2' }
        ],
        perDelivery: [
          { name: "Is quotation compliant?", type: "Yes/No radio", id: 'pd1' },
          { name: "Details", type: "Text area", id: 'pd2' }
        ]
      };
      
      let fieldIdCounter = 100;
      
      // Supplier Form Preview Toggle
      let isSupplierFormPreviewVisible = false;
      
      // Delivery Requirements - Configurable Fields
      let deliveryRequirementFields = [
        { id: 'dr1', label: 'Delivery Time', type: 'text', placeholder: 'e.g., Within 30 days', value: '' },
        { id: 'dr2', label: 'Delivery Place', type: 'text', placeholder: 'e.g., Warehouse, Copenhagen', value: '' },
        { id: 'dr3', label: 'Allowed Incoterms', type: 'multi-select', placeholder: '', value: [] },
        { id: 'dr4', label: 'Consignee Details', type: 'textarea', placeholder: 'Enter consignee details', value: '' }
      ];
      
      // Evaluation Criteria
      let evaluationCriteria = [
        // Each criterion: { id, type, description, evaluationMethod, appliesTo: 'entire' | 'specific', lots: [], unspscCodes: [] }
      ];
      let evaluationCriteriaIdCounter = 1;
      
      // General Information - Field Values for Conditional Visibility
      let generalInfoValues = {
        sourcingOrSolicitation: '',
        modalityOfBidReceipt: '',
        epp: '',
        medicineOrMedical: '',
        processType: [],
        directContracting: false,
        unCollaboration: '',
        isLease: ''
      };
      
      // Particulars - Field Values for Conditional Visibility
      let particularsValues = {
        clarificationsOrPreBid: '',
        numberOfMeetings: 0,
        siteVisit: '',
        dateOption: '',
        exclusivity: '',
        alternativeOffers: '',
        advancePaymentAllowed: '',
        advancePaymentSecurity: '',
        liquidatedDamages: '',
        performanceSecurity: '',
        bidSecurity: ''
      };
      
      // Evaluation Block - Field Values for Conditional Visibility
      let evaluationBlockValues = {
        evaluationMethod: '',
        evaluationMethodDetails: ''
      };
      
      // Initialize sample requisition lines (simulating ERP data)
      function initializeRequisitionLines() {
        requisitionLines = [
          {
            id: 'REQ-LINE-001',
            unspscCode: '43000000',
            unspscDescription: 'Information Technology Broadcasting and Telecommunications',
            description: 'IT Equipment and Services',
            quantity: 1,
            unitOfMeasure: 'Lot',
            amount: 50000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-002',
            unspscCode: '43211503',
            unspscDescription: 'Laptop computers',
            description: 'Laptop computers for office use',
            quantity: 50,
            unitOfMeasure: 'Unit',
            amount: 25000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-003',
            unspscCode: '43211602',
            unspscDescription: 'Docking stations',
            description: 'Docking stations for laptops',
            quantity: 50,
            unitOfMeasure: 'Unit',
            amount: 10000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-004',
            unspscCode: '43211708',
            unspscDescription: 'Laptop bags',
            description: 'Laptop carrying bags',
            quantity: 50,
            unitOfMeasure: 'Unit',
            amount: 2500,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-005',
            unspscCode: '43222609',
            unspscDescription: 'Network switches',
            description: 'Network switches for office setup',
            quantity: 10,
            unitOfMeasure: 'Unit',
            amount: 5000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-006',
            unspscCode: '43222619',
            unspscDescription: 'Wireless access points',
            description: 'WiFi access points',
            quantity: 20,
            unitOfMeasure: 'Unit',
            amount: 3000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-007',
            unspscCode: '81111812',
            unspscDescription: 'Network installation & configuration service',
            description: 'Network installation services',
            quantity: 1,
            unitOfMeasure: 'Service',
            amount: 5000,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-008',
            unspscCode: '44101503',
            unspscDescription: 'Laser printers',
            description: 'Laser printers for office',
            quantity: 5,
            unitOfMeasure: 'Unit',
            amount: 2500,
            currency: 'USD',
          },
          {
            id: 'REQ-LINE-009',
            unspscCode: '44103103',
            unspscDescription: 'Toner cartridges',
            description: 'Toner cartridges for printers',
            quantity: 20,
            unitOfMeasure: 'Unit',
            amount: 2000,
            currency: 'USD',
          },
        ];
      }

      // Available templates
      const availableTemplates = [
        {
          id: 'itb-goods-standard',
          name: 'ITB - Goods (Standard)',
          type: 'ITB',
          icon: 'üì¶',
          description: 'Standard Invitation to Bid template for goods procurement. Includes all standard forms and requirements.',
          category: 'Goods',
          method: 'ITB',
          matchScore: 95,
        },
        {
          id: 'itb-services-standard',
          name: 'ITB - Services (Standard)',
          type: 'ITB',
          icon: 'üîß',
          description: 'Standard Invitation to Bid template for services procurement with service-specific requirements.',
          category: 'Services',
          method: 'ITB',
          matchScore: 90,
        },
        {
          id: 'rfp-goods-services',
          name: 'RFP - Goods & Services',
          type: 'RFP',
          icon: 'üìã',
          description: 'Request for Proposal template suitable for complex procurements involving both goods and services.',
          category: 'Goods & Services',
          method: 'RFP',
          matchScore: 85,
        },
        {
          id: 'rfq-goods-standard',
          name: 'RFQ - Goods (Standard)',
          type: 'RFQ',
          icon: 'üí∞',
          description: 'Request for Quotation template for simple goods procurement with streamlined requirements.',
          category: 'Goods',
          method: 'RFQ',
          matchScore: 80,
        },
        {
          id: 'itb-works-standard',
          name: 'ITB - Works (Standard)',
          type: 'ITB',
          icon: 'üèóÔ∏è',
          description: 'Standard Invitation to Bid template for works/construction projects with works-specific clauses.',
          category: 'Works',
          method: 'ITB',
          matchScore: 75,
        },
      ];

      // Mock data for procurement processes (for lifecycle linking)
      const procurementProcesses = [
        {
          id: 'REQ-2024-001',
          type: 'Requisition',
          title: 'Medical Equipment Requisition',
          status: 'Completed',
          value: '$250,000',
          created: '2024-11-15',
          createdBy: 'Sarah Johnson',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'RFI-2024-045',
          type: 'RFI',
          title: 'Request for Information - Medical Equipment Suppliers',
          status: 'Completed',
          value: 'N/A',
          created: '2024-12-01',
          createdBy: 'Michael Chen',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'RFP-2025-001',
          type: 'RFP',
          title: 'Supply of Medical Equipment for Health Facilities',
          status: 'Published',
          value: '$250,000',
          created: '2025-01-15',
          createdBy: 'Sarah Johnson',
          category: 'Goods',
          projectName: 'Health Facilities Upgrade Project'
        },
        {
          id: 'REQ-2024-082',
          type: 'Requisition',
          title: 'Construction Materials Requisition',
          status: 'Completed',
          value: '$1,200,000',
          created: '2024-12-10',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'EOI-2024-028',
          type: 'EOI',
          title: 'Expression of Interest - Construction Companies',
          status: 'Completed',
          value: 'N/A',
          created: '2024-12-20',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'ITB-2025-015',
          type: 'ITB',
          title: 'Construction of School Infrastructure in Rural Areas',
          status: 'Published',
          value: '$1,200,000',
          created: '2025-01-22',
          createdBy: 'Ahmed Hassan',
          category: 'Works',
          projectName: 'School Infrastructure Development'
        },
        {
          id: 'RFQ-2024-156',
          type: 'RFQ',
          title: 'Office Supplies Quotation Request',
          status: 'Closed',
          value: '$45,000',
          created: '2025-01-10',
          createdBy: 'Lisa Anderson',
          category: 'Goods',
          projectName: 'Office Operations 2025'
        },
        {
          id: 'LTA-2023-012',
          type: 'LTA',
          title: 'Long Term Agreement - IT Equipment Supply',
          status: 'Active',
          value: '$500,000',
          created: '2023-06-15',
          createdBy: 'David Kim',
          category: 'Goods',
          projectName: 'IT Infrastructure Modernization'
        },
        {
          id: 'RFP-2024-089',
          type: 'RFP',
          title: 'Consultancy Services - Project Management',
          status: 'Completed',
          value: '$180,000',
          created: '2024-09-05',
          createdBy: 'Maria Garcia',
          category: 'Services',
          projectName: 'Multi-Country Development Initiative'
        },
      ];

      // Global state for lifecycle tracker
      let currentLifecycleLinks = [];
      let currentProcessInfo = {
        id: 'AUTO-GENERATED',
        type: 'RFP',
        title: 'New Tender Process',
        status: 'Draft',
        created: new Date().toISOString().split('T')[0],
        createdBy: 'Current User'
      };

      // Mock data for existing tenders (for cloning feature)
      const existingTenders = [
        {
          id: 'tender-001',
          reference: 'UNOPS-2025-RFP-001',
          title: 'Supply of Medical Equipment for Health Facilities',
          type: 'RFP - Request for Proposal',
          category: 'Goods',
          value: '$250,000',
          status: 'Published',
          created: '15 Jan 2025',
          template: 'RFP - Goods (Standard)',
        },
        {
          id: 'tender-002',
          reference: 'UNOPS-2025-ITB-015',
          title: 'Construction of School Infrastructure in Rural Areas',
          type: 'ITB - Invitation to Bid',
          category: 'Works',
          value: '$1,200,000',
          status: 'Published',
          created: '22 Jan 2025',
          template: 'ITB - Works (Standard)',
        },
        {
          id: 'tender-003',
          reference: 'UNOPS-2025-RFQ-028',
          title: 'Office Supplies and Equipment Procurement',
          type: 'RFQ - Request for Quotation',
          category: 'Goods',
          value: '$45,000',
          status: 'Closed',
          created: '10 Jan 2025',
          template: 'RFQ - Goods & Services',
        },
        {
          id: 'tender-004',
          reference: 'UNOPS-2025-RFP-007',
          title: 'Consultancy Services for Project Management',
          type: 'RFP - Request for Proposal',
          category: 'Services',
          value: '$180,000',
          status: 'Draft',
          created: '5 Feb 2025',
          template: 'RFP - Services (Standard)',
        },
        {
          id: 'tender-005',
          reference: 'UNOPS-2025-ITB-022',
          title: 'Road Rehabilitation Project - Phase 2',
          type: 'ITB - Invitation to Bid',
          category: 'Works',
          value: '$3,500,000',
          status: 'Published',
          created: '28 Jan 2025',
          template: 'ITB - Works (Standard)',
        },
        {
          id: 'tender-006',
          reference: 'UNOPS-2025-RFP-012',
          title: 'IT Equipment and Software Licensing',
          type: 'RFP - Request for Proposal',
          category: 'Goods & Services',
          value: '$320,000',
          status: 'Published',
          created: '18 Jan 2025',
          template: 'RFP - Goods & Services',
        },
      ];

      // ===== TENDER INITIATION FUNCTIONS =====
      function startWithWizard() {
        currentView = 'wizard';
        document.getElementById('initiation-view').classList.remove('active');
        document.getElementById('wizard-view').classList.add('active');
        document.getElementById('page-breadcrumbs').textContent = 'Event Setup ¬∑ Guided Wizard';
        initWizard();
      }

      function startWithTemplate() {
        // Navigate to template library page
        window.location.href = 'template-library.html?action=create-tender';
      }

      function startWithClone() {
        // Show tender selection modal
        showTenderSelectionModal();
      }

      function showTenderSelectionModal() {
        const modal = document.getElementById('tender-selection-modal');
        modal.style.display = 'flex';
        loadExistingTenders();
      }

      function closeTenderSelectionModal() {
        const modal = document.getElementById('tender-selection-modal');
        modal.style.display = 'none';
      }

      function loadExistingTenders() {
        const tenderList = document.getElementById('existing-tenders-list');
        tenderList.innerHTML = '';

        existingTenders.forEach(tender => {
          const tenderCard = document.createElement('div');
          tenderCard.className = 'existing-tender-card';
          tenderCard.onclick = () => selectTenderToClone(tender);
          
          const statusClass = tender.status === 'Published' ? 'success' : 
                              tender.status === 'Draft' ? 'warning' : 'info';
          
          tenderCard.innerHTML = `
            <div class="existing-tender-header">
              <div>
                <div class="existing-tender-title">${tender.title}</div>
                <div class="existing-tender-reference">${tender.reference}</div>
              </div>
              <span class="badge badge-${statusClass}">${tender.status}</span>
            </div>
            <div class="existing-tender-details">
              <div class="existing-tender-meta">
                <span>üìã ${tender.type}</span>
                <span>üí∞ ${tender.value}</span>
                <span>üìÖ ${tender.created}</span>
              </div>
              <div class="existing-tender-template">${tender.template}</div>
            </div>
          `;
          
          tenderList.appendChild(tenderCard);
        });
      }

      function selectTenderToClone(tender) {
        if (confirm(`Clone tender "${tender.title}"?\n\nAll blocks, fields, and configurations will be copied. You can then modify as needed.`)) {
          closeTenderSelectionModal();
          cloneTender(tender);
        }
      }

      function cloneTender(tender) {
        // In real implementation, this would call an API to clone the tender
        console.log('Cloning tender:', tender);
        
        // Show loading
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'loading-overlay';
        loadingMsg.innerHTML = `
          <div class="loading-content">
            <div class="spinner"></div>
            <div>Cloning tender...</div>
          </div>
        `;
        document.body.appendChild(loadingMsg);
        
        // Simulate API call
        setTimeout(() => {
          // Remove loading
          document.body.removeChild(loadingMsg);
          
          // Set wizard data from cloned tender
          wizardData = {
            title: `Copy of ${tender.title}`,
            requirementType: 'goods', // Would come from tender data
            method: tender.type.toLowerCase().split(' ')[0],
            estimatedValue: tender.value.replace(/[^0-9]/g, ''),
            template: tender.template,
          };
          
          selectedTemplate = templates.find(t => t.name === tender.template) || templates[0];
          
          // Proactive linking: Automatically link the cloned tender as predecessor
          const sourceProcess = procurementProcesses.find(p => p.id === tender.reference);
          if (sourceProcess) {
            currentLifecycleLinks.push({
              process: sourceProcess,
              relationshipType: 'predecessor',
              linkedAt: new Date().toISOString(),
              linkedBy: 'System',
              linkType: 'automatic',
              linkReason: 'Cloned from this process'
            });
          }
          
          // Go directly to authoring view
          initiateTender();
        }, 1500);
      }

      function filterExistingTenders(searchTerm) {
        const filteredTenders = existingTenders.filter(tender => {
          const lowerSearch = searchTerm.toLowerCase();
          return tender.title.toLowerCase().includes(lowerSearch) ||
                 tender.reference.toLowerCase().includes(lowerSearch) ||
                 tender.type.toLowerCase().includes(lowerSearch);
        });
        
        const tenderList = document.getElementById('existing-tenders-list');
        tenderList.innerHTML = '';
        
        if (filteredTenders.length === 0) {
          tenderList.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-2xl); color: var(--text-muted);">
              <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üîç</div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-xs);">No tenders found</div>
              <div style="font-size: 14px;">Try adjusting your search terms</div>
            </div>
          `;
          return;
        }
        
        filteredTenders.forEach(tender => {
          const tenderCard = document.createElement('div');
          tenderCard.className = 'existing-tender-card';
          tenderCard.onclick = () => selectTenderToClone(tender);
          
          const statusClass = tender.status === 'Published' ? 'success' : 
                              tender.status === 'Draft' ? 'warning' : 'info';
          
          tenderCard.innerHTML = `
            <div class="existing-tender-header">
              <div>
                <div class="existing-tender-title">${tender.title}</div>
                <div class="existing-tender-reference">${tender.reference}</div>
              </div>
              <span class="badge badge-${statusClass}">${tender.status}</span>
            </div>
            <div class="existing-tender-details">
              <div class="existing-tender-meta">
                <span>üìã ${tender.type}</span>
                <span>üí∞ ${tender.value}</span>
                <span>üìÖ ${tender.created}</span>
              </div>
              <div class="existing-tender-template">${tender.template}</div>
            </div>
          `;
          
          tenderList.appendChild(tenderCard);
        });
      }

      // ===== PROCUREMENT LIFECYCLE TRACKER FUNCTIONS =====
      function renderLifecycleTracker(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = `
          <div class="lifecycle-tracker-container">
            <div class="lifecycle-tracker-header">
              <div class="lifecycle-tracker-title">
                üîó Procurement Lifecycle & Related Processes
              </div>
              <div class="lifecycle-tracker-actions">
                <button class="btn btn-ghost btn-icon" onclick="openLifecycleSearch()">
                  <span>‚ûï</span>
                  <span>Link Process</span>
                </button>
                <button class="btn btn-ghost btn-icon" onclick="refreshLifecycleView()">
                  <span>üîÑ</span>
                  <span>Refresh</span>
                </button>
              </div>
            </div>
            
            <div id="lifecycle-chain-container">
              ${renderLifecycleChain()}
            </div>
            
            <div id="linked-processes-container">
              ${renderLinkedProcesses()}
            </div>
            
            <div class="lifecycle-audit-trail">
              <div class="lifecycle-audit-trail-title">Audit Trail</div>
              <div id="lifecycle-audit-list">
                ${renderAuditTrail()}
              </div>
            </div>
          </div>
        `;
      }

      function renderLifecycleChain() {
        if (currentLifecycleLinks.length === 0) {
          return `
            <div class="lifecycle-empty-state">
              <div class="lifecycle-empty-state-icon">üîó</div>
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">No linked processes yet</div>
              <div style="font-size: 13px;">Click "Link Process" to connect related procurement events</div>
            </div>
          `;
        }

        // Build lifecycle chain
        const allProcesses = [
          ...currentLifecycleLinks.filter(l => l.relationshipType === 'predecessor').map(l => l.process),
          currentProcessInfo,
          ...currentLifecycleLinks.filter(l => l.relationshipType === 'successor').map(l => l.process)
        ];

        const chainHtml = allProcesses.map((process, index) => {
          const isCurrent = process.id === currentProcessInfo.id;
          const isCompleted = process.status === 'Completed' || process.status === 'Closed';
          const nodeClass = isCurrent ? 'current' : (isCompleted ? 'completed' : 'future');
          
          const icon = {
            'Requisition': 'üìã',
            'RFI': '‚ùì',
            'EOI': '‚úâÔ∏è',
            'RFQ': 'üí∞',
            'RFP': 'üìÑ',
            'ITB': 'üèóÔ∏è',
            'LTA': 'üìú',
            'Contract': 'üìù'
          }[process.type] || 'üìå';

          const arrow = index < allProcesses.length - 1 ? 
            `<div class="lifecycle-arrow ${index < allProcesses.indexOf(currentProcessInfo) ? 'active' : ''}">‚Üí</div>` : '';

          return `
            <div class="lifecycle-node ${nodeClass}" onclick="showProcessDetails('${process.id}')">
              <div class="lifecycle-node-badge">${icon}</div>
              <div class="lifecycle-node-label">${process.type}</div>
              <div class="lifecycle-node-id">${process.id}</div>
            </div>
            ${arrow}
          `;
        }).join('');

        return `<div class="lifecycle-chain">${chainHtml}</div>`;
      }

      function renderLinkedProcesses() {
        if (currentLifecycleLinks.length === 0) {
          return '';
        }

        const processesHtml = currentLifecycleLinks.map(link => {
          const relationshipClass = `relationship-${link.relationshipType}`;
          const relationshipLabel = {
            'predecessor': 'Predecessor',
            'successor': 'Successor',
            'related': 'Related'
          }[link.relationshipType] || 'Related';

          return `
            <div class="linked-process-item">
              <div class="linked-process-info">
                <div class="linked-process-title">
                  ${link.process.title}
                  <span class="lifecycle-relationship-type ${relationshipClass}">${relationshipLabel}</span>
                </div>
                <div class="linked-process-meta">
                  <span>üÜî ${link.process.id}</span>
                  <span>üìã ${link.process.type}</span>
                  <span>üìÖ ${link.process.created}</span>
                  <span>üë§ ${link.process.createdBy}</span>
                </div>
              </div>
              <div class="linked-process-actions">
                <button class="btn-link-action" onclick="viewLinkedProcess('${link.process.id}')">View</button>
                <button class="btn-link-action remove" onclick="removeLifecycleLink('${link.process.id}')">Remove</button>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="linked-processes-list">
            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-md); text-transform: uppercase; letter-spacing: 0.08em;">
              Linked Processes (${currentLifecycleLinks.length})
            </div>
            ${processesHtml}
          </div>
        `;
      }

      function renderAuditTrail() {
        const auditEvents = [
          { action: 'Process created', user: 'Current User', timestamp: new Date().toISOString() },
          ...currentLifecycleLinks.map(link => ({
            action: `Linked to ${link.process.type} (${link.process.id}) as ${link.relationshipType}`,
            user: 'Current User',
            timestamp: link.linkedAt || new Date().toISOString()
          }))
        ];

        if (auditEvents.length === 0) {
          return '<div style="font-size: 13px; color: var(--text-muted);">No audit events yet</div>';
        }

        return auditEvents.map(event => {
          const date = new Date(event.timestamp);
          const timeStr = date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          return `
            <div class="lifecycle-audit-item">
              <span>${event.action}</span>
              <span style="color: var(--text-muted); margin-left: auto;">by ${event.user}</span>
              <span class="lifecycle-audit-timestamp">${timeStr}</span>
            </div>
          `;
        }).join('');
      }

      function openLifecycleSearch() {
        const modal = document.getElementById('lifecycle-search-modal');
        modal.style.display = 'flex';
        loadProcurementProcesses();
      }

      function closeLifecycleSearch() {
        const modal = document.getElementById('lifecycle-search-modal');
        modal.style.display = 'none';
      }

      function loadProcurementProcesses(searchTerm = '') {
        const resultsContainer = document.getElementById('lifecycle-search-results');
        
        let filteredProcesses = procurementProcesses;
        if (searchTerm) {
          filteredProcesses = procurementProcesses.filter(process => {
            const search = searchTerm.toLowerCase();
            return process.id.toLowerCase().includes(search) ||
                   process.title.toLowerCase().includes(search) ||
                   process.type.toLowerCase().includes(search);
          });
        }

        // Exclude already linked processes
        const linkedIds = currentLifecycleLinks.map(l => l.process.id);
        filteredProcesses = filteredProcesses.filter(p => !linkedIds.includes(p.id));

        if (filteredProcesses.length === 0) {
          resultsContainer.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">
              <div style="font-size: 40px; margin-bottom: var(--spacing-md);">üîç</div>
              <div>No processes found</div>
            </div>
          `;
          return;
        }

        resultsContainer.innerHTML = filteredProcesses.map(process => {
          const statusClass = process.status === 'Completed' ? 'success' : 
                             process.status === 'Active' ? 'success' :
                             process.status === 'Published' ? 'info' : 'warning';
          
          return `
            <div class="lifecycle-search-result" onclick="selectProcessToLink('${process.id}')">
              <div class="lifecycle-search-result-title">
                ${process.title}
                <span class="badge badge-${statusClass}" style="margin-left: 8px;">${process.status}</span>
              </div>
              <div class="lifecycle-search-result-meta">
                <span>üÜî ${process.id}</span>
                <span>üìã ${process.type}</span>
                <span>üí∞ ${process.value}</span>
                <span>üìÖ ${process.created}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      function searchLifecycleProcesses(searchTerm) {
        loadProcurementProcesses(searchTerm);
      }

      function selectProcessToLink(processId) {
        const process = procurementProcesses.find(p => p.id === processId);
        if (!process) return;

        // Show relationship type selection
        const relationshipType = prompt(
          `Link "${process.title}" as:\n\n1. Predecessor (this process comes after)\n2. Successor (this process comes before)\n3. Related (parallel or associated process)\n\nEnter 1, 2, or 3:`,
          '1'
        );

        let type = 'related';
        if (relationshipType === '1') type = 'predecessor';
        else if (relationshipType === '2') type = 'successor';
        else if (relationshipType === '3') type = 'related';

        // Add to lifecycle links
        currentLifecycleLinks.push({
          process: process,
          relationshipType: type,
          linkedAt: new Date().toISOString(),
          linkedBy: 'Current User',
          linkType: 'manual' // or 'automatic' for proactive linking
        });

        closeLifecycleSearch();
        refreshLifecycleView();

        // Show success message
        showNotification(`Successfully linked ${process.type} (${process.id})`, 'success');
      }

      function removeLifecycleLink(processId) {
        if (!confirm('Remove this linked process?')) return;

        currentLifecycleLinks = currentLifecycleLinks.filter(link => link.process.id !== processId);
        refreshLifecycleView();
        showNotification('Link removed', 'info');
      }

      function refreshLifecycleView() {
        const chainContainer = document.getElementById('lifecycle-chain-container');
        const linkedContainer = document.getElementById('linked-processes-container');
        const auditContainer = document.getElementById('lifecycle-audit-list');

        if (chainContainer) chainContainer.innerHTML = renderLifecycleChain();
        if (linkedContainer) linkedContainer.innerHTML = renderLinkedProcesses();
        if (auditContainer) auditContainer.innerHTML = renderAuditTrail();
      }

      function showProcessDetails(processId) {
        const process = procurementProcesses.find(p => p.id === processId) || 
                       (processId === currentProcessInfo.id ? currentProcessInfo : null);
        
        if (!process) return;

        alert(`Process Details:\n\nID: ${process.id}\nType: ${process.type}\nTitle: ${process.title}\nStatus: ${process.status}\nValue: ${process.value || 'N/A'}\nCreated: ${process.created}\nCreated By: ${process.createdBy}`);
      }

      function viewLinkedProcess(processId) {
        showProcessDetails(processId);
      }

      function showNotification(message, type = 'info') {
        // Simple notification - in real app, use proper toast/notification system
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          padding: 16px 24px;
          background: var(--surface-0);
          border: 1px solid var(--${type === 'success' ? 'success' : 'info'}-400);
          border-left: 4px solid var(--${type === 'success' ? 'success' : 'info'}-500);
          border-radius: 8px;
          box-shadow: var(--shadow-lg);
          z-index: 10000;
          animation: slideIn 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      }

      // Proactive linking when creating from existing process
      function linkFromClonedTender(sourceTender) {
        // When a tender is cloned, automatically link it as a successor
        const sourceProcess = procurementProcesses.find(p => p.reference === sourceTender.reference);
        if (sourceProcess) {
          currentLifecycleLinks.push({
            process: sourceProcess,
            relationshipType: 'predecessor',
            linkedAt: new Date().toISOString(),
            linkedBy: 'System (Auto-linked on clone)',
            linkType: 'automatic'
          });
          refreshLifecycleView();
        }
      }

      // ===== WIZARD FUNCTIONS =====
      function initWizard() {
        updateWizardStepDisplay();
        setupWizardEventListeners();
      }

      function setupWizardEventListeners() {
        document.getElementById('wizard-next-btn').addEventListener('click', () => {
          if (validateWizardStep()) {
            if (wizardStep < totalWizardSteps) {
              goToWizardStep(wizardStep + 1);
            } else {
              initiateTender();
            }
          }
        });

        document.getElementById('wizard-prev-btn').addEventListener('click', () => {
          if (wizardStep > 1) {
            goToWizardStep(wizardStep - 1);
          }
        });

        document.getElementById('requirement-type')?.addEventListener('change', collectWizardData);
        document.getElementById('sourcing-type')?.addEventListener('change', collectWizardData);
        document.getElementById('method')?.addEventListener('change', collectWizardData);
        document.getElementById('estimated-value')?.addEventListener('input', collectWizardData);
      }

      function collectWizardData() {
        wizardData = {
          requirementType: document.getElementById('requirement-type')?.value || '',
          sourcingType: document.getElementById('sourcing-type')?.value || '',
          method: document.getElementById('method')?.value || '',
          estimatedValue: document.getElementById('estimated-value')?.value || '',
          projectType: document.getElementById('project-type')?.value || '',
          country: Array.from(document.getElementById('country')?.selectedOptions || []).map(opt => opt.value),
          description: document.getElementById('description')?.value || '',
        };
      }

      function validateWizardStep() {
        if (wizardStep === 1) {
          const requirementType = document.getElementById('requirement-type')?.value;
          const sourcingType = document.getElementById('sourcing-type')?.value;
          const method = document.getElementById('method')?.value;
          const estimatedValue = document.getElementById('estimated-value')?.value;

          if (!requirementType || !sourcingType || !method || !estimatedValue) {
            alert('Please fill in all required fields');
            return false;
          }
          collectWizardData();
          return true;
        } else if (wizardStep === 2) {
          if (!selectedTemplate) {
            alert('Please select a template to continue');
            return false;
          }
          return true;
        } else if (wizardStep === 3) {
          const title = document.getElementById('tender-title')?.value;
          if (!title) {
            alert('Please enter a tender title');
            return false;
          }
          return true;
        }
        return true;
      }

      function goToWizardStep(step) {
        wizardStep = step;

        if (step === 2) {
          collectWizardData();
          suggestTemplates();
        } else if (step === 3) {
          populateReviewStep();
        }

        updateWizardStepDisplay();
      }

      function suggestTemplates() {
        const cardsContainer = document.getElementById('template-cards');
        cardsContainer.innerHTML = '';

        const suggestedTemplates = availableTemplates
          .map((template) => {
            let score = 0;

            if (wizardData.requirementType === 'goods' && template.category === 'Goods') score += 30;
            if (wizardData.requirementType === 'services' && template.category === 'Services') score += 30;
            if (wizardData.requirementType === 'works' && template.category === 'Works') score += 30;
            if (wizardData.requirementType === 'goods-services' && template.category === 'Goods & Services') score += 30;

            const methodMap = {
              itb: 'ITB',
              rfp: 'RFP',
              rfq: 'RFQ',
            };
            if (methodMap[wizardData.method] === template.method) score += 40;

            const value = parseFloat(wizardData.estimatedValue) || 0;
            if (value > 100000 && template.method === 'RFP') score += 20;
            if (value < 50000 && template.method === 'RFQ') score += 20;

            return { ...template, calculatedScore: score };
          })
          .filter((t) => t.calculatedScore > 0)
          .sort((a, b) => b.calculatedScore - a.calculatedScore)
          .slice(0, 3);

        document.getElementById('suggestion-count').textContent = `${suggestedTemplates.length} matches`;

        suggestedTemplates.forEach((template, index) => {
          const card = document.createElement('div');
          card.className = `template-card ${index === 0 ? 'recommended' : ''}`;
          if (index === 0) {
            selectedTemplate = template;
            card.classList.add('selected');
          }
          card.innerHTML = `
            <div class="template-card-header">
              <div class="template-icon">${template.icon}</div>
              <div class="template-info">
                <div class="template-name">${template.name}</div>
                <div class="template-type">${template.type} ¬∑ ${template.category}</div>
              </div>
            </div>
            <div class="template-description">${template.description}</div>
            <div class="template-meta">
              <div class="template-meta-item">
                <span>üìä</span>
                <span>Match: ${template.calculatedScore}%</span>
              </div>
            </div>
          `;

          card.addEventListener('click', () => {
            document.querySelectorAll('.template-card').forEach((c) => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTemplate = template;
          });

          cardsContainer.appendChild(card);
        });
      }

      function populateReviewStep() {
        const methodMap = {
          itb: 'ITB - Invitation to Bid',
          rfp: 'RFP - Request for Proposal',
          rfq: 'RFQ - Request for Quotation',
          eoi: 'EOI - Expression of Interest',
          direct: 'Direct Contracting',
        };

        const requirementMap = {
          goods: 'Goods',
          services: 'Services',
          works: 'Works',
          'goods-services': 'Goods & Services',
        };

        document.getElementById('selected-template-display').value = selectedTemplate?.name || '';
        document.getElementById('review-requirement-type').value = requirementMap[wizardData.requirementType] || '';
        document.getElementById('review-method').value = methodMap[wizardData.method] || '';
        document.getElementById('review-value').value = wizardData.estimatedValue
          ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}`
          : '';
      }

      function updateWizardStepDisplay() {
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.remove('active', 'completed');
          if (stepNum < wizardStep) {
            step.classList.add('completed');
          } else if (stepNum === wizardStep) {
            step.classList.add('active');
          }
        });

        document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
          const stepNum = index + 1;
          content.classList.remove('active');
          if (stepNum === wizardStep) {
            content.classList.add('active');
          }
        });

        const prevBtn = document.getElementById('wizard-prev-btn');
        const nextBtn = document.getElementById('wizard-next-btn');

        prevBtn.style.display = wizardStep > 1 ? 'inline-flex' : 'none';
        nextBtn.textContent = wizardStep === totalWizardSteps ? 'Initiate Tender' : 'Next';
        nextBtn.disabled = false;
      }

      function initiateTender() {
        const title = document.getElementById('tender-title')?.value;
        if (!title) {
          alert('Please enter a tender title');
          return;
        }

        const nextBtn = document.getElementById('wizard-next-btn');
        nextBtn.disabled = true;
        nextBtn.textContent = 'Initiating...';

        // Add title to wizard data
        wizardData.title = title;
        wizardData.template = selectedTemplate;

        // Update current process info for lifecycle tracker
        const methodMap = {
          itb: 'ITB',
          rfp: 'RFP',
          rfq: 'RFQ',
          eoi: 'EOI',
          direct: 'Direct Contracting',
        };
        currentProcessInfo = {
          id: `${methodMap[wizardData.method] || 'PROC'}-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`,
          type: methodMap[wizardData.method] || 'RFP',
          title: title,
          status: 'Draft',
          value: wizardData.estimatedValue ? `$${parseFloat(wizardData.estimatedValue).toLocaleString()}` : 'TBD',
          created: new Date().toISOString().split('T')[0],
          createdBy: 'Current User',
          category: wizardData.requirementType || 'Goods',
        };

        // Pre-populate template blocks with wizard data
        populateTemplateBlocks();

        // Switch to authoring view
        setTimeout(() => {
          switchToAuthoringView();
        }, 500);
      }

      function populateTemplateBlocks() {
        // Pre-populate General Information
        if (templateBlocks[0] && templateBlocks[0].id === 'general') {
          const generalSection = templateBlocks[0].sections[0];
          if (generalSection) {
            const titleField = generalSection.fields.find(f => f.label === 'Title');
            if (titleField && wizardData.title) {
              titleField.value = wizardData.title;
            }

            const sourcingField = generalSection.fields.find(f => f.label === 'Sourcing or Solicitation?');
            if (sourcingField && wizardData.sourcingType) {
              const sourcingValue = wizardData.sourcingType.charAt(0).toUpperCase() + wizardData.sourcingType.slice(1);
              if (sourcingField.options.includes(sourcingValue)) {
                sourcingField.options = [sourcingValue, ...sourcingField.options.filter(o => o !== sourcingValue && o !== 'Select...')];
              }
            }

            const requirementField = generalSection.fields.find(f => f.label === 'Type of Requirement');
            if (requirementField && wizardData.requirementType) {
              const requirementMap = {
                goods: 'Goods',
                services: 'Services',
                works: 'Works',
                'goods-services': 'Goods & Services',
              };
              const requirementValue = requirementMap[wizardData.requirementType] || 'Goods';
              if (requirementField.options.includes(requirementValue)) {
                requirementField.options = [requirementValue, ...requirementField.options.filter(o => o !== requirementValue && o !== 'Select...')];
              }
            }

            const descriptionField = generalSection.fields.find(f => f.label === 'Description');
            if (descriptionField && wizardData.description) {
              descriptionField.value = wizardData.description;
            }
          }
        }

        // Pre-populate Requisition Details
        if (templateBlocks[2] && templateBlocks[2].id === 'requisition' && wizardData.estimatedValue) {
          const requisitionSection = templateBlocks[2].sections[0];
          if (requisitionSection) {
            const valueField = requisitionSection.fields.find(f => f.label === 'Amount/expected value of contract (USD)');
            if (valueField) {
              valueField.value = wizardData.estimatedValue;
            }
          }
        }
      }

      function switchToAuthoringView() {
        currentView = 'authoring';

        // Update UI
        document.getElementById('wizard-view').classList.remove('active');
        document.getElementById('authoring-view').classList.add('active');

        // Update top bar
        document.getElementById('page-title').textContent = 'Procurement Portal | Tender Authoring';
        const methodMap = {
          itb: 'ITB',
          rfp: 'RFP',
          rfq: 'RFQ',
          eoi: 'EOI',
          direct: 'Direct Contracting',
        };
        const requirementMap = {
          goods: 'Goods',
          services: 'Services',
          works: 'Works',
          'goods-services': 'Goods & Services',
        };
        document.getElementById('page-breadcrumbs').textContent = `${methodMap[wizardData.method] || 'Tender'} ¬∑ ${requirementMap[wizardData.requirementType] || 'Goods'} ¬∑ Draft`;

        // Update top actions
        const topActions = document.getElementById('top-actions');
        topActions.innerHTML = `
          <button class="btn btn-ghost">Preview</button>
          <button class="btn btn-ghost">üíæ Save Draft</button>
          <button class="btn btn-ghost" onclick="downloadTenderPackage()" title="Download all documents as ZIP">üì¶ Download Package</button>
          <button class="btn btn-primary">Submit for Review</button>
        `;
        
        // Ensure form library is visible by default
        const formLibraryPanel = document.getElementById('form-library-panel');
        if (formLibraryPanel) {
          formLibraryPanel.classList.remove('collapsed');
        }

        // Initialize authoring
        initAuthoring();
        showSuccessMessage();
      }

      function showSuccessMessage() {
        const contentWrapper = document.getElementById('content-wrapper');
        const successAlert = document.createElement('div');
        successAlert.className = 'info-alert';
        successAlert.style.marginBottom = 'var(--spacing-lg)';
        successAlert.innerHTML = `
          <div class="info-alert-text">
            ‚úÖ Tender "${wizardData.title}" successfully initiated! You can now complete all the details below.
          </div>
        `;
        contentWrapper.insertBefore(successAlert, contentWrapper.firstChild);

        setTimeout(() => {
          successAlert.style.transition = 'opacity 0.3s ease';
          successAlert.style.opacity = '0';
          setTimeout(() => successAlert.remove(), 300);
        }, 5000);
      }

      // ===== FORM LIBRARY FUNCTIONS =====
      function toggleFormLibrary() {
        const panel = document.getElementById('form-library-panel');
        const toggleBtn = panel.querySelector('.toggle-library-btn');
        panel.classList.toggle('collapsed');
        
        if (panel.classList.contains('collapsed')) {
          toggleBtn.textContent = 'üìö';
          toggleBtn.title = 'Expand';
        } else {
          toggleBtn.textContent = '‚úï';
          toggleBtn.title = 'Collapse';
        }
      }

      // ===== DOWNLOAD TENDER PACKAGE =====
      function downloadTenderPackage() {
        // Show loading state
        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 8px;"><span style="animation: spin 1s linear infinite; display: inline-block;">‚è≥</span> Preparing Package...</span>';
        
        // Simulate package preparation (in real implementation, this would:
        // 1. Collect all tender documents
        // 2. Generate PDFs from form data
        // 3. Include uploaded files
        // 4. Create a manifest/index
        // 5. Zip everything together
        // 6. Trigger download)
        setTimeout(() => {
          // Show success notification
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success-500);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
          `;
          notification.innerHTML = `
            <span style="font-size: 20px;">‚úÖ</span>
            <div>
              <div style="font-weight: 600; margin-bottom: 2px;">Tender Package Ready</div>
              <div style="font-size: 13px; opacity: 0.9;">tender-package-${Date.now()}.zip</div>
            </div>
          `;
          document.body.appendChild(notification);
          
          // In a real implementation, trigger the actual download here:
          // const link = document.createElement('a');
          // link.href = packageBlobUrl;
          // link.download = `tender-package-${wizardData.tenderId || Date.now()}.zip`;
          // link.click();
          
          // Remove notification after 4 seconds
          setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }, 4000);
          
          // Reset button
          btn.disabled = false;
          btn.innerHTML = originalText;
        }, 2000);
      }

      function setupFormLibrary() {
        // Setup drag and drop for form library items
        const formItems = document.querySelectorAll('.form-library-item');
        formItems.forEach((item) => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('form-type', item.dataset.formType);
            e.dataTransfer.setData('form-name', item.dataset.formName);
            item.style.opacity = '0.5';
          });

          item.addEventListener('dragend', (e) => {
            item.style.opacity = '1';
          });
        });

        // Setup search
        const searchInput = document.getElementById('form-library-search');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            formItems.forEach((item) => {
              const text = item.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                item.style.display = 'block';
              } else {
                item.style.display = 'none';
              }
            });
          });
        }
      }

      function setupDropZones() {
        // Setup drop zones in section bodies and explicit drop zones
        document.querySelectorAll('.section-body, .form-drop-zone').forEach((dropZone) => {
          // Remove existing listeners to avoid duplicates
          const newDropZone = dropZone.cloneNode(true);
          dropZone.parentNode.replaceChild(newDropZone, dropZone);
          
          newDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            newDropZone.classList.add('active');
          });

          newDropZone.addEventListener('dragleave', (e) => {
            if (!newDropZone.contains(e.relatedTarget)) {
              newDropZone.classList.remove('active');
            }
          });

          newDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            newDropZone.classList.remove('active');

            const formType = e.dataTransfer.getData('form-type');
            const formName = e.dataTransfer.getData('form-name');

            if (formType && formName) {
              // If dropped on explicit drop zone, use its parent section body
              const sectionBody = newDropZone.classList.contains('form-drop-zone') 
                ? newDropZone.closest('.section-body') || newDropZone.parentElement
                : newDropZone;
              addFormToSection(sectionBody, formType, formName);
            }
          });
        });
      }

      function addFormToSection(sectionBody, formType, formName) {
        const block = templateBlocks[currentBlockIndex];
        // Find the section index more reliably
        const formSection = sectionBody.closest('.form-section');
        if (!formSection) {
          console.error('Could not find form section');
          return;
        }
        // Get all sections for the current block only
        const contentWrapper = document.getElementById('content-wrapper');
        const allSections = Array.from(contentWrapper.querySelectorAll('.form-section'));
        const sectionIndex = allSections.indexOf(formSection);
        
        if (sectionIndex === -1) {
          console.error('Could not determine section index');
          return;
        }

        // Initialize forms array for this block/section if needed
        if (!addedForms[block.id]) {
          addedForms[block.id] = {};
        }
        if (!addedForms[block.id][sectionIndex]) {
          addedForms[block.id][sectionIndex] = [];
        }

        // Check if form already exists
        const existingForm = addedForms[block.id][sectionIndex].find(f => f.type === formType);
        if (existingForm) {
          alert('This form has already been added to this section');
          return;
        }

        // Add form to storage
        const formData = {
          type: formType,
          name: formName,
          id: `form-${Date.now()}`,
        };
        addedForms[block.id][sectionIndex].push(formData);

        // Create form display element
        const formElement = document.createElement('div');
        formElement.className = 'added-form-item';
        formElement.dataset.formId = formData.id;
        formElement.innerHTML = `
          <div class="added-form-info">
            <div class="added-form-icon">üìÑ</div>
            <div class="added-form-details">
              <div class="added-form-name">${formName}</div>
              <div class="added-form-type">Form Document</div>
            </div>
          </div>
          <div class="added-form-actions">
            <button class="form-action-btn" onclick="previewForm('${formData.id}')" title="Preview">üëÅ</button>
            <button class="form-action-btn danger" onclick="removeForm('${formData.id}')" title="Remove">‚úñ</button>
          </div>
        `;

        // Find or create drop zone
        let dropZone = sectionBody.querySelector('.form-drop-zone');
        if (!dropZone) {
          dropZone = document.createElement('div');
          dropZone.className = 'form-drop-zone';
          dropZone.textContent = 'Drop forms here';
          sectionBody.appendChild(dropZone);
        }

        // Insert form before drop zone
        sectionBody.insertBefore(formElement, dropZone);

        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'info-alert';
        successMsg.style.marginTop = 'var(--spacing-md)';
        successMsg.innerHTML = `
          <div class="info-alert-text">
            ‚úÖ ${formName} added successfully
          </div>
        `;
        sectionBody.insertBefore(successMsg, formElement.nextSibling);

        setTimeout(() => {
          successMsg.style.transition = 'opacity 0.3s ease';
          successMsg.style.opacity = '0';
          setTimeout(() => successMsg.remove(), 300);
        }, 2000);
      }

      function previewForm(formId) {
        // Find form data
        let formData = null;
        for (const blockId in addedForms) {
          for (const sectionIndex in addedForms[blockId]) {
            const form = addedForms[blockId][sectionIndex].find(f => f.id === formId);
            if (form) {
              formData = form;
              break;
            }
          }
          if (formData) break;
        }

        if (formData) {
          alert(`Preview: ${formData.name}\n\nThis would open a preview modal or new window showing the form/document template.`);
        }
      }

      function removeForm(formId) {
        if (!confirm('Remove this form from the tender?')) {
          return;
        }

        // Find and remove form from storage
        for (const blockId in addedForms) {
          for (const sectionIndex in addedForms[blockId]) {
            const index = addedForms[blockId][sectionIndex].findIndex(f => f.id === formId);
            if (index !== -1) {
              addedForms[blockId][sectionIndex].splice(index, 1);
              // Remove from DOM
              const formElement = document.querySelector(`[data-form-id="${formId}"]`);
              if (formElement) {
                formElement.remove();
              }
              return;
            }
          }
        }
      }

      // ===== REQUISITION LINES & LOTS FUNCTIONS =====
      function renderRequisitionLotsSection(block, section, sectionIndex, isFirst) {
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get unique UNSPSC codes from requisition lines for reference
        const requisitionUnspscCodes = [...new Set(requisitionLines.map(line => line.unspscCode))];
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
              ${sectionIndex === 0 ? '<span class="status-indicator status-incomplete">Incomplete</span>' : ''}
            </div>
            <div class="section-body">
              <div class="info-alert">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Requisition lines are imported from ERP (reference only). Lots are independent and can contain any UNSPSC codes (same as requisition lines or different).
                </div>
              </div>
              
              <!-- Requisition Lines Table -->
              <div class="requisition-section">
                <div class="section-subheader">
                  <h3>Requisition Lines (from ERP - Reference Only)</h3>
                  <span class="badge">${requisitionLines.length} lines</span>
                </div>
                <div class="requisition-table-container">
                  <table class="requisition-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>UNSPSC Code</th>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${requisitionLines.map(line => `
                        <tr data-line-id="${line.id}">
                          <td><strong>${line.id}</strong></td>
                          <td>
                            <div class="unspsc-code">${line.unspscCode}</div>
                            <div class="unspsc-desc">${line.unspscDescription}</div>
                          </td>
                          <td>${line.description}</td>
                          <td>${line.quantity}</td>
                          <td>${line.unitOfMeasure}</td>
                          <td>${line.currency} ${line.amount.toLocaleString()}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Lots Management -->
              <div class="lots-section">
                <div class="section-subheader">
                  <h3>Lots</h3>
                  <button class="btn btn-primary" onclick="createNewLot()">+ Create Lot</button>
                </div>
                
                ${lots.length === 0 ? `
                  <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-text">No lots created yet</div>
                    <div class="empty-state-hint">Create lots to organize products (UNSPSC codes), or proceed without lots. Each lot can contain 1 or more products.</div>
                    <button class="btn btn-ghost" onclick="createNewLot()">Create First Lot</button>
                  </div>
                ` : `
                  <div class="lots-list">
                    ${lots.map((lot, lotIndex) => `
                      <div class="lot-card" data-lot-id="${lot.id}">
                        <div class="lot-header">
                          <div class="lot-title">
                            <span class="lot-number">Lot ${lotIndex + 1}</span>
                            <input type="text" class="lot-name-input" value="${lot.name}" onchange="updateLotName('${lot.id}', this.value)" placeholder="Enter lot name" />
                          </div>
                          <div class="lot-actions">
                            <button class="btn-icon" onclick="editLot('${lot.id}')" title="Edit">‚úèÔ∏è</button>
                            <button class="btn-icon danger" onclick="deleteLot('${lot.id}')" title="Delete">üóëÔ∏è</button>
                          </div>
                        </div>
                        <div class="lot-body">
                          <div class="lot-products">
                            <div class="lot-lines-header">
                              <span>Products (UNSPSC Codes) in this Lot (${lot.unspscCodes.length})</span>
                              <button class="btn btn-ghost btn-sm" onclick="addProductsToLot('${lot.id}')">+ Add Products</button>
                            </div>
                            ${lot.unspscCodes.length === 0 ? `
                              <div class="lot-empty">No products added. Click "Add Products" to add UNSPSC codes.</div>
                            ` : `
                              <div class="lot-lines-list">
                                ${lot.unspscCodes.map((unspsc, idx) => `
                                  <div class="lot-line-item">
                                    <span class="lot-line-code">${unspsc.code}</span>
                                    <span class="lot-line-desc">${unspsc.description || 'No description'}</span>
                                    ${unspsc.quantity ? `<span class="quantity-badge" title="Quantity">Qty: ${unspsc.quantity}</span>` : ''}
                                    ${requisitionUnspscCodes.includes(unspsc.code) ? '<span class="match-badge" title="Matches requisition line">‚úì From Req</span>' : '<span class="match-badge new" title="New UNSPSC code">New</span>'}
                                    <button class="btn-icon-sm" onclick="removeProductFromLot('${lot.id}', ${idx})" title="Remove">‚úñ</button>
                                  </div>
                                `).join('')}
                              </div>
                            `}
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
              
              <!-- Tender Structure Summary -->
              <div class="structure-summary">
                <div class="section-subheader">
                  <h3>Tender Structure Summary</h3>
                </div>
                <div class="summary-card">
                  ${lots.length === 0 ? `
                    <div class="summary-item">
                      <span class="summary-label">Structure:</span>
                      <span class="summary-value">No Lots (${requisitionLines.length} requisition lines from ERP)</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Total Value:</span>
                      <span class="summary-value">${requisitionLines.reduce((sum, line) => sum + line.amount, 0).toLocaleString()} USD</span>
                    </div>
                  ` : `
                    <div class="summary-item">
                      <span class="summary-label">Structure:</span>
                      <span class="summary-value">${lots.length} Lot(s)</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Requisition Lines (from ERP):</span>
                      <span class="summary-value">${requisitionLines.length}</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Total Products in Lots:</span>
                      <span class="summary-value">${lots.reduce((sum, lot) => sum + lot.unspscCodes.length, 0)}</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Total Value (Requisition Lines):</span>
                      <span class="summary-value">${requisitionLines.reduce((sum, line) => sum + line.amount, 0).toLocaleString()} USD</span>
                    </div>
                  `}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      window.createNewLot = function() {
        const lotName = prompt('Enter lot name:');
        if (!lotName) return;
        
        const newLot = {
          id: 'lot-' + Date.now(),
          name: lotName,
          unspscCodes: [], // Array of { code, description }
        };
        
        lots.push(newLot);
        renderCurrentBlock();
      }
      
      window.updateLotName = function(lotId, newName) {
        const lot = lots.find(l => l.id === lotId);
        if (lot) {
          lot.name = newName;
        }
      }
      
      window.deleteLot = function(lotId) {
        if (!confirm('Are you sure you want to delete this lot?')) {
          return;
        }
        
        lots = lots.filter(l => l.id !== lotId);
        renderCurrentBlock();
      }
      
      window.addProductsToLot = function(lotId) {
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        // Get available UNSPSC codes from requisition lines for quick selection
        const requisitionUnspscCodes = requisitionLines.map(line => ({
          code: line.unspscCode,
          description: line.unspscDescription,
          fromRequisition: true,
        }));
        
        // Build selection message
        let message = `Add products (UNSPSC codes) to "${lot.name}":\n\n`;
        message += `You can:\n`;
        message += `1. Select from requisition line UNSPSC codes (enter numbers)\n`;
        message += `2. Enter new UNSPSC codes manually (format: CODE or CODE|DESCRIPTION)\n\n`;
        
        if (requisitionUnspscCodes.length > 0) {
          message += `Available from Requisition Lines:\n`;
          requisitionUnspscCodes.forEach((item, idx) => {
            message += `${idx + 1}. ${item.code} - ${item.description}\n`;
          });
        }
        
        message += `\nEnter selection (e.g., "1,2,3" for requisition codes, or "43211503|Laptop computers" for new codes):`;
        const input = prompt(message);
        
        if (!input) return;
        
        const parts = input.split(',').map(s => s.trim());
        parts.forEach(part => {
          // Check if it's a number (index for requisition codes)
          const index = parseInt(part) - 1;
          if (index >= 0 && index < requisitionUnspscCodes.length) {
            // Add from requisition
            const item = requisitionUnspscCodes[index];
            if (!lot.unspscCodes.some(u => u.code === item.code)) {
              const quantity = prompt(`Enter quantity for ${item.code} - ${item.description}:`, '1');
              lot.unspscCodes.push({ 
                code: item.code, 
                description: item.description,
                quantity: quantity ? parseInt(quantity) : 1
              });
            }
          } else if (part.includes('|')) {
            // New code with description: CODE|DESCRIPTION
            const [code, description] = part.split('|').map(s => s.trim());
            if (code && !lot.unspscCodes.some(u => u.code === code)) {
              const quantity = prompt(`Enter quantity for ${code} - ${description}:`, '1');
              lot.unspscCodes.push({ 
                code, 
                description: description || '',
                quantity: quantity ? parseInt(quantity) : 1
              });
            }
          } else if (part.length >= 8) {
            // Just UNSPSC code (8 digits)
            if (!lot.unspscCodes.some(u => u.code === part)) {
              const quantity = prompt(`Enter quantity for UNSPSC ${part}:`, '1');
              lot.unspscCodes.push({ 
                code: part, 
                description: '',
                quantity: quantity ? parseInt(quantity) : 1
              });
            }
          }
        });
        
        renderCurrentBlock();
      }
      
      window.removeProductFromLot = function(lotId, index) {
        const lot = lots.find(l => l.id === lotId);
        if (lot && index >= 0 && index < lot.unspscCodes.length) {
          lot.unspscCodes.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      window.editLot = function(lotId) {
        const lot = lots.find(l => l.id === lotId);
        if (!lot) return;
        
        // In real app, would open a modal for editing
        const newName = prompt('Enter new lot name:', lot.name);
        if (newName && newName !== lot.name) {
          lot.name = newName;
          renderCurrentBlock();
        }
      }

      // ===== PRODUCT REQUIREMENTS FUNCTIONS =====
      function renderProductRequirementsSection(block, section, sectionIndex, isFirst) {
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get all UNSPSC codes that need requirements
        let unspscCodesToShow = [];
        
        if (lots.length === 0) {
          // No lots: show requirements per requisition line UNSPSC
          unspscCodesToShow = requisitionLines.map(line => ({
            code: line.unspscCode,
            description: line.unspscDescription,
            source: 'requisition',
            sourceId: line.id,
          }));
        } else {
          // Has lots: show requirements per lot line UNSPSC (UNSPSC inside lots)
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                source: 'lot',
                sourceId: lot.id,
                lotName: lot.name,
              });
            });
          });
        }
        
        // Remove duplicates (same UNSPSC code)
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Define requirements for each UNSPSC code. Choose either a description field for free-text or structured attributes with specific values.
                </div>
              </div>
              
              <!-- Spreadsheet Import/Export -->
              <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                <button class="btn btn-secondary btn-sm" onclick="exportProductRequirementsToSpreadsheet()">
                  <span>üì•</span> Export to Spreadsheet
                </button>
                <button class="btn btn-secondary btn-sm" onclick="uploadProductRequirementsSpreadsheet()">
                  <span>üì§</span> Upload from Spreadsheet
                </button>
                <span style="font-size: 13px; color: var(--text-muted); display: flex; align-items: center; margin-left: auto;">
                  Use spreadsheet templates to bulk manage requirements
                </span>
              </div>
              
              ${uniqueUnspscCodes.length === 0 ? `
                <div class="empty-state">
                  <div class="empty-state-icon">üìã</div>
                  <div class="empty-state-text">No UNSPSC codes available</div>
                  <div class="empty-state-hint">${lots.length === 0 ? 'Add requisition lines or create lots with products to define requirements.' : 'Add products to lots to define requirements.'}</div>
                </div>
              ` : `
                <div class="product-requirements-list">
                  ${uniqueUnspscCodes.map(unspsc => {
                    const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                    return `
                      <div class="product-requirement-card" data-unspsc="${unspsc.code}">
                        <div class="product-requirement-header">
                          <div class="product-requirement-title">
                            <span class="unspsc-code-large">${unspsc.code}</span>
                            <span class="unspsc-description-large">${unspsc.description}</span>
                            ${unspsc.lotName ? `<span class="lot-badge">Lot: ${unspsc.lotName}</span>` : ''}
                          </div>
                        </div>
                        
                        <div class="product-requirement-body">
                          <!-- Requirements -->
                          <div class="requirement-section">
                            <div class="requirement-section-header">
                              <h4>Requirements</h4>
                              ${req.requirementType === 'description' ? `
                                <button class="btn btn-ghost btn-sm" onclick="switchToAttributes('${unspsc.code}')">Switch to Attributes</button>
                              ` : req.attributes && req.attributes.length > 0 ? `
                                <button class="btn btn-ghost btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">+ Add Attribute</button>
                              ` : ''}
                            </div>
                            
                            ${!req.requirementType || (req.attributes.length === 0 && !req.description) ? `
                              <div class="requirement-empty">
                                <p>Choose how you want to define requirements for this product:</p>
                                <div style="display: flex; gap: var(--spacing-md); justify-content: center; margin-top: var(--spacing-md);">
                                  <button class="btn btn-primary btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">
                                    <span style="font-size: 18px;">üìã</span> Add Attributes
                                  </button>
                                  <span style="display: flex; align-items: center; color: var(--text-muted); font-weight: 600;">OR</span>
                                  <button class="btn btn-primary btn-sm" onclick="addDescriptionField('${unspsc.code}')">
                                    <span style="font-size: 18px;">üìù</span> Add Description Field
                                  </button>
                                </div>
                                <p style="margin-top: var(--spacing-md); font-size: 13px; color: var(--text-muted); text-align: center;">
                                  Use <strong>Attributes</strong> for structured data (e.g., "Printing technology: Laser") or <strong>Description</strong> for free-text service descriptions
                                </p>
                              </div>
                            ` : req.requirementType === 'description' ? `
                              <div class="requirement-description">
                                <div class="form-group">
                                  <label class="form-label">Product/Service Description</label>
                                  <div class="rich-text-editor-container">
                                    <div class="rich-text-toolbar">
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'italic')" title="Italic (Ctrl+I)"><em>I</em></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'strikeThrough')" title="Strikethrough"><s>S</s></button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'h3')" title="Heading">H1</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'h4')" title="Subheading">H2</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'formatBlock', 'p')" title="Normal Text">¬∂</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertOrderedList')" title="Numbered List">1. List</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'indent')" title="Increase Indent">‚Üí</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'outdent')" title="Decrease Indent">‚Üê</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyLeft')" title="Align Left">‚¨Ö</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyCenter')" title="Align Center">‚¨å</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'justifyRight')" title="Align Right">‚û°</button>
                                      </div>
                                      <span class="toolbar-divider"></span>
                                      <div class="toolbar-group">
                                        <button type="button" class="toolbar-btn" onclick="insertLinkByCode('${unspsc.code}')" title="Insert Link">üîó Link</button>
                                        <button type="button" class="toolbar-btn" onclick="formatTextByCode('${unspsc.code}', 'insertHorizontalRule')" title="Insert Line">‚Äî</button>
                                        <button type="button" class="toolbar-btn" onclick="clearFormattingByCode('${unspsc.code}')" title="Clear Formatting">‚úñ Clear</button>
                                      </div>
                                    </div>
                                    <div 
                                      id="rich-text-editor-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}"
                                      class="rich-text-editor" 
                                      contenteditable="true"
                                      data-unspsc="${unspsc.code}"
                                      placeholder="Enter a detailed description of what you want to buy for this product/service. You can include specifications, requirements, quality standards, etc."
                                      oninput="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                                      onblur="updateRequirementDescriptionFromEditor('${unspsc.code}')"
                                      onkeydown="handleEditorKeydown(event, '${unspsc.code}')"
                                    >${req.description || ''}</div>
                                    <div class="editor-footer">
                                      <div class="editor-word-count">
                                        <span id="word-count-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}">Words: 0</span>
                                        <span id="char-count-${unspsc.code.replace(/[^a-zA-Z0-9]/g, '_')}">Characters: 0</span>
                                      </div>
                                      <span>üí° Use formatting tools above to structure your content</span>
                                    </div>
                                  </div>
                                  <span class="help-text">Use this field for detailed, formatted descriptions (ideal for services). Supports rich text formatting, lists, links, and more.</span>
                                </div>
                                <div class="requirement-actions">
                                  <button class="btn btn-ghost btn-sm btn-danger" onclick="clearRequirements('${unspsc.code}')">Clear & Start Over</button>
                                </div>
                              </div>
                            ` : `
                              <div class="requirement-attributes-list">
                                ${req.attributes.map((attr, idx) => `
                                  <div class="requirement-attribute-item">
                                    <div class="attribute-row">
                                      <div class="attribute-name">
                                        <input type="text" class="attribute-name-input" value="${attr.name}" placeholder="Attribute name (e.g., Printing technology)" onchange="updateAttributeName('${unspsc.code}', ${idx}, this.value)" />
                                      </div>
                                      <div class="attribute-value">
                                        <input type="text" class="attribute-value-input" value="${attr.value}" placeholder="Value (e.g., Laser (Monochrome))" onchange="updateAttributeValue('${unspsc.code}', ${idx}, this.value)" />
                                      </div>
                                      <button class="btn-icon-sm" onclick="removeAttribute('${unspsc.code}', ${idx})" title="Remove">‚úñ</button>
                                    </div>
                                  </div>
                                `).join('')}
                              </div>
                              <div class="requirement-actions">
                                <button class="btn btn-ghost btn-sm" onclick="addRequirementAttribute('${unspsc.code}')">+ Add Another Attribute</button>
                                <button class="btn btn-ghost btn-sm btn-danger" onclick="clearRequirements('${unspsc.code}')">Clear & Start Over</button>
                              </div>
                            `}
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      window.addRequirementAttribute = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'attributes', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'attributes';
        productRequirements[unspscCode].attributes.push({
          name: '',
          value: '',
        });
        
        renderCurrentBlock();
      }
      
      window.addDescriptionField = function(unspscCode) {
        if (!productRequirements[unspscCode]) {
          productRequirements[unspscCode] = { requirementType: 'description', attributes: [], description: '' };
        }
        
        productRequirements[unspscCode].requirementType = 'description';
        productRequirements[unspscCode].description = '';
        productRequirements[unspscCode].attributes = []; // Clear attributes
        
        renderCurrentBlock();
        
        // Initialize word count after DOM is updated
        setTimeout(() => {
          initializeEditorWordCount(unspscCode);
        }, 100);
      }
      
      window.updateRequirementDescription = function(unspscCode, newDescription) {
        if (productRequirements[unspscCode]) {
          productRequirements[unspscCode].description = newDescription;
        }
      }
      
      window.updateRequirementDescriptionFromEditor = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        if (editor && productRequirements[unspscCode]) {
          productRequirements[unspscCode].description = editor.innerHTML;
          
          // Update word and character count
          const text = editor.innerText || editor.textContent || '';
          const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
          const chars = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${sanitizedCode}`);
          const charCountEl = document.getElementById(`char-count-${sanitizedCode}`);
          
          if (wordCountEl) wordCountEl.textContent = `Words: ${words}`;
          if (charCountEl) charCountEl.textContent = `Characters: ${chars}`;
        }
      }

      window.initializeEditorWordCount = function(unspscCode) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        
        if (editor) {
          const text = editor.innerText || editor.textContent || '';
          const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
          const chars = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${sanitizedCode}`);
          const charCountEl = document.getElementById(`char-count-${sanitizedCode}`);
          
          if (wordCountEl) wordCountEl.textContent = `Words: ${words}`;
          if (charCountEl) charCountEl.textContent = `Characters: ${chars}`;
          
          // Focus the editor to make it obvious it's ready
          editor.focus();
        }
      }
      
      window.formatText = function(unspscCode, command, value = null) {
        const sanitizedCode = unspscCode.replace(/[^a-zA-Z0-9]/g, '_');
        const editor = document.getElementById(`rich-text-editor-${sanitizedCode}`);
        if (!editor) return;
        
        editor.focus();
        document.execCommand(command, false, value);
        updateRequirementDescriptionFromEditor(unspscCode);
      }
      
      window.formatTextByCode = function(unspscCode, command, value = null) {
        formatText(unspscCode, command, value);
      }

      window.insertLinkByCode = function(unspscCode) {
        try {
          const url = prompt('Enter the URL:', 'https://');
          if (url && url.trim() !== '' && url !== 'https://') {
            formatText(unspscCode, 'createLink', url);
          }
        } catch (error) {
          console.error('Error inserting link:', error);
        }
      }

      window.clearFormattingByCode = function(unspscCode) {
        try {
          if (confirm('Remove all formatting from selected text?')) {
            formatText(unspscCode, 'removeFormat');
          }
        } catch (error) {
          console.error('Error clearing formatting:', error);
        }
      }

      window.handleEditorKeydown = function(event, unspscCode) {
        try {
          // Handle keyboard shortcuts
          if (event.ctrlKey || event.metaKey) {
            switch(event.key.toLowerCase()) {
              case 'b':
                event.preventDefault();
                formatText(unspscCode, 'bold');
                break;
              case 'i':
                event.preventDefault();
                formatText(unspscCode, 'italic');
                break;
              case 'u':
                event.preventDefault();
                formatText(unspscCode, 'underline');
                break;
              case 'k':
                event.preventDefault();
                insertLinkByCode(unspscCode);
                break;
            }
          }
          
          // Tab for indent (prevent leaving editor)
          if (event.key === 'Tab') {
            event.preventDefault();
            if (event.shiftKey) {
              formatText(unspscCode, 'outdent');
            } else {
              formatText(unspscCode, 'indent');
            }
          }
        } catch (error) {
          console.error('Error handling keyboard shortcut:', error);
        }
      }
      
      window.switchToAttributes = function(unspscCode) {
        if (confirm('Switching to attributes will clear your description. Continue?')) {
          productRequirements[unspscCode].requirementType = 'attributes';
          productRequirements[unspscCode].description = '';
          productRequirements[unspscCode].attributes = [];
          renderCurrentBlock();
        }
      }
      
      window.clearRequirements = function(unspscCode) {
        if (confirm('This will clear all requirements for this UNSPSC code. Continue?')) {
          productRequirements[unspscCode] = { requirementType: null, attributes: [], description: '' };
          renderCurrentBlock();
        }
      }
      
      window.updateAttributeName = function(unspscCode, index, newName) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes[index].name = newName;
        }
      }
      
      window.updateAttributeValue = function(unspscCode, index, newValue) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes[index].value = newValue;
        }
      }
      
      window.removeAttribute = function(unspscCode, index) {
        if (productRequirements[unspscCode] && productRequirements[unspscCode].attributes[index]) {
          productRequirements[unspscCode].attributes.splice(index, 1);
          renderCurrentBlock();
        }
      }
      
      window.exportProductRequirementsToSpreadsheet = function() {
        alert('Export to spreadsheet functionality: This would generate an Excel template with all UNSPSC codes and their requirements.');
      }
      
      window.uploadProductRequirementsSpreadsheet = function() {
        alert('Upload spreadsheet functionality: This would open a file picker to upload an Excel file with requirements data.');
      }
      
      // ===== BID RESPONSE FIELDS MANAGEMENT =====
      window.addBidResponseField = function(section) {
        const fieldName = prompt('Enter field name:');
        if (!fieldName) return;
        
        const fieldType = prompt('Enter field type (e.g., Text input, Currency input, Yes/No radio, Text area, etc.):');
        if (!fieldType) return;
        
        const newField = {
          id: `custom_${fieldIdCounter++}`,
          name: fieldName,
          type: fieldType || 'Text input'
        };
        
        bidResponseFields[section].push(newField);
        renderCurrentBlock();
      }
      
      window.removeBidResponseField = function(section, fieldId) {
        if (confirm('Are you sure you want to remove this field?')) {
          const index = bidResponseFields[section].findIndex(f => f.id === fieldId);
          if (index !== -1) {
            bidResponseFields[section].splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      // ===== DELIVERY REQUIREMENTS FIELDS MANAGEMENT =====
      window.addDeliveryRequirementField = function() {
        const fieldLabel = prompt('Enter field label:');
        if (!fieldLabel) return;
        
        const fieldType = prompt('Enter field type (text, textarea, select):');
        if (!fieldType) return;
        
        const newField = {
          id: `dr_custom_${fieldIdCounter++}`,
          label: fieldLabel,
          type: fieldType || 'text',
          placeholder: '',
          value: ''
        };
        
        deliveryRequirementFields.push(newField);
        renderCurrentBlock();
      }
      
      window.removeDeliveryRequirementField = function(fieldId) {
        if (confirm('Are you sure you want to remove this field?')) {
          const index = deliveryRequirementFields.findIndex(f => f.id === fieldId);
          if (index !== -1) {
            deliveryRequirementFields.splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      window.updateDeliveryFieldValue = function(fieldId, value) {
        const field = deliveryRequirementFields.find(f => f.id === fieldId);
        if (field) {
          field.value = value;
          // Also update tenderAuthorConfig for backwards compatibility
          if (fieldId === 'dr1') tenderAuthorConfig.deliveryConfig.deliveryTime = value;
          if (fieldId === 'dr2') tenderAuthorConfig.deliveryConfig.deliveryPlace = value;
          if (fieldId === 'dr4') tenderAuthorConfig.deliveryConfig.consigneeDetails = value;
        }
      }
      
      // ===== SUPPLIER FORM PREVIEW TOGGLE =====
      window.toggleSupplierFormPreview = function() {
        isSupplierFormPreviewVisible = !isSupplierFormPreviewVisible;
        renderCurrentBlock();
      }
      
      // ===== EVALUATION CRITERIA MANAGEMENT =====
      window.addEvaluationCriterion = function() {
        const newCriterion = {
          id: `ec_${evaluationCriteriaIdCounter++}`,
          type: 'Eligibility and formal criteria',
          description: '',
          evaluationMethod: 'Pass/Fail',
          appliesTo: 'entire',
          lots: [],
          unspscCodes: []
        };
        evaluationCriteria.push(newCriterion);
        renderCurrentBlock();
      }
      
      window.removeEvaluationCriterion = function(criterionId) {
        if (confirm('Are you sure you want to remove this evaluation criterion?')) {
          const index = evaluationCriteria.findIndex(c => c.id === criterionId);
          if (index !== -1) {
            evaluationCriteria.splice(index, 1);
            renderCurrentBlock();
          }
        }
      }
      
      window.updateEvaluationCriterionType = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.type = value;
        }
      }
      
      window.updateEvaluationCriterionDescription = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.description = value;
        }
      }
      
      window.updateEvaluationCriterionMethod = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.evaluationMethod = value;
        }
      }
      
      window.updateEvaluationCriterionAppliesTo = function(criterionId, value) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          criterion.appliesTo = value;
          if (value === 'entire') {
            criterion.unspscCodes = [];
          }
          renderCurrentBlock();
        }
      }
      
      window.updateEvaluationCriterionLots = function(criterionId, selectElement) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          const selectedOptions = Array.from(selectElement.selectedOptions);
          criterion.lots = selectedOptions.map(opt => opt.value);
          
          // Auto-populate UNSPSC codes from selected lots
          criterion.unspscCodes = [];
          criterion.lots.forEach(lotId => {
            const lot = lots.find(l => l.id === lotId);
            if (lot) {
              lot.unspscCodes.forEach(unspsc => {
                if (!criterion.unspscCodes.includes(unspsc.code)) {
                  criterion.unspscCodes.push(unspsc.code);
                }
              });
            }
          });
        }
      }

      window.updateEvaluationCriterionUnspscCodes = function(criterionId, selectElement) {
        const criterion = evaluationCriteria.find(c => c.id === criterionId);
        if (criterion) {
          const selectedOptions = Array.from(selectElement.selectedOptions);
          criterion.unspscCodes = selectedOptions.map(opt => opt.value);
        }
      }
      
      window.getAvailableUnspscCodes = function() {
        // Get unique UNSPSC codes from requisition lines and lots
        let unspscCodes = [];
        
        // From requisition lines
        requisitionLines.forEach(line => {
          if (!unspscCodes.some(u => u.code === line.unspscCode)) {
            unspscCodes.push({
              code: line.unspscCode,
              description: line.unspscDescription
            });
          }
        });
        
        // From lots
        lots.forEach(lot => {
          lot.unspscCodes.forEach(unspsc => {
            if (!unspscCodes.some(u => u.code === unspsc.code)) {
              unspscCodes.push({
                code: unspsc.code,
                description: unspsc.description || 'No description'
              });
            }
          });
        });
        
        return unspscCodes;
      }
      
      // ===== GENERAL INFORMATION - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateSourcingOrSolicitation = function(value) {
        generalInfoValues.sourcingOrSolicitation = value;
        renderCurrentBlock();
      }
      
      window.updateModalityOfBidReceipt = function(value) {
        generalInfoValues.modalityOfBidReceipt = value;
        renderCurrentBlock();
      }
      
      window.updateEPP = function(value) {
        generalInfoValues.epp = value;
        renderCurrentBlock();
      }
      
      window.updateMedicineOrMedical = function(value) {
        generalInfoValues.medicineOrMedical = value;
        renderCurrentBlock();
      }
      
      window.updateProcessType = function(checkbox) {
        const value = checkbox.value;
        const isChecked = checkbox.checked;
        
        if (isChecked) {
          if (!generalInfoValues.processType.includes(value)) {
            generalInfoValues.processType.push(value);
          }
        } else {
          generalInfoValues.processType = generalInfoValues.processType.filter(v => v !== value);
        }
        
        generalInfoValues.directContracting = generalInfoValues.processType.includes('Direct contracting / Sole sourcing');
        renderCurrentBlock();
      }
      
      window.updateUNCollaboration = function(value) {
        generalInfoValues.unCollaboration = value;
        renderCurrentBlock();
      }
      
      window.updateIsLease = function(value) {
        generalInfoValues.isLease = value;
        renderCurrentBlock();
      }
      
      window.shouldShowField = function(field) {
        if (!field.conditionalVisibility) return true;
        
        const condition = field.conditionalVisibility;
        
        // Complex condition for Linked Process
        if (condition.complex && field.id === 'linkedProcess') {
          const hasDirectContracting = generalInfoValues.processType.includes('Direct contracting / Sole sourcing');
          const hasSolicitation = generalInfoValues.sourcingOrSolicitation !== '';
          const hasLTABPA = generalInfoValues.processType.includes('Solicit offers against LTA/BPA');
          const hasContractAmendment = generalInfoValues.processType.includes('Contract Amendment');
          return hasDirectContracting || hasSolicitation || hasLTABPA || hasContractAmendment;
        }
        
        // Single value condition - Check both generalInfoValues and evaluationBlockValues
        if (condition.field && condition.value) {
          if (generalInfoValues[condition.field] !== undefined) {
            return generalInfoValues[condition.field] === condition.value;
          }
          if (evaluationBlockValues[condition.field] !== undefined) {
            return evaluationBlockValues[condition.field] === condition.value;
          }
        }
        
        // Multiple values condition
        if (condition.field && condition.values) {
          if (generalInfoValues[condition.field] !== undefined) {
            return condition.values.includes(generalInfoValues[condition.field]);
          }
          if (evaluationBlockValues[condition.field] !== undefined) {
            return condition.values.includes(evaluationBlockValues[condition.field]);
          }
        }
        
        // Contains condition (for checkboxes)
        if (condition.field && condition.contains) {
          return generalInfoValues.processType.includes(condition.contains);
        }
        
        return true;
      }
      
      // ===== EVALUATION BLOCK - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateEvaluationMethodInEvaluation = function(value) {
        evaluationBlockValues.evaluationMethod = value;
        renderCurrentBlock();
      }
      
      window.updateEvaluationMethodDetailsInEvaluation = function(value) {
        evaluationBlockValues.evaluationMethodDetails = value;
        renderCurrentBlock();
      }
      
      // ===== PARTICULARS - CONDITIONAL VISIBILITY HANDLERS =====
      window.updateClarificationsOrPreBid = function(value) {
        particularsValues.clarificationsOrPreBid = value;
        // Parse number of meetings from value
        if (value === 'One pre-bid meeting') {
          particularsValues.numberOfMeetings = 1;
        } else if (value === 'Two pre-bid meetings') {
          particularsValues.numberOfMeetings = 2;
        } else {
          particularsValues.numberOfMeetings = 0;
        }
        renderCurrentBlock();
      }
      
      window.updateSiteVisit = function(value) {
        particularsValues.siteVisit = value;
        renderCurrentBlock();
      }
      
      window.updateSiteVisitDateOption = function(value) {
        particularsValues.dateOption = value;
        renderCurrentBlock();
      }
      
      window.updateExclusivity = function(value) {
        particularsValues.exclusivity = value;
        renderCurrentBlock();
      }
      
      window.updateAlternativeOffers = function(value) {
        particularsValues.alternativeOffers = value;
        renderCurrentBlock();
      }
      
      window.updateAdvancePaymentAllowed = function(value) {
        particularsValues.advancePaymentAllowed = value;
        renderCurrentBlock();
      }
      
      window.updateAdvancePaymentSecurity = function(value) {
        particularsValues.advancePaymentSecurity = value;
        renderCurrentBlock();
      }
      
      window.updateLiquidatedDamages = function(value) {
        particularsValues.liquidatedDamages = value;
        renderCurrentBlock();
      }
      
      window.updatePerformanceSecurity = function(value) {
        particularsValues.performanceSecurity = value;
        renderCurrentBlock();
      }
      
      window.updateBidSecurity = function(value) {
        particularsValues.bidSecurity = value;
        renderCurrentBlock();
      }

      // ===== TENDER AUTHOR CONFIGURATION SECTION =====
      let tenderAuthorConfig = {
        serviceDescriptions: [], // [{ name, description }]
        deliveryConfig: {
          deliveryTime: '',
          deliveryPlace: '',
          allowedIncoterms: [],
          consigneeDetails: '',
        },
        specificRequirements: '', // Specific requirements, conditions and additional information
      };
      
      function renderTenderAuthorConfigSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Configure tender-specific requirements that will be used to structure supplier responses
                </div>
              </div>
              
              <!-- 1. Service Descriptions -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0;">1. Service Descriptions</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addServiceLine()">+ Add Service Line</button>
                </div>
                <div id="service-lines-list" style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${tenderAuthorConfig.serviceDescriptions.length === 0 ? `
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted); border: 1px dashed var(--surface-300); border-radius: var(--radius-sm);">
                      No service lines defined. Click "+ Add Service Line" to start.
                    </div>
                  ` : tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div style="border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); background: var(--surface-50);">
                      <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: var(--spacing-md); align-items: start;">
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Service Name</label>
                          <input type="text" class="form-input" value="${service.name}" placeholder="e.g., Installation Services" style="font-size: 13px; padding: 8px;" onchange="updateServiceLine(${idx}, 'name', this.value)" />
                        </div>
                        <div class="form-group" style="margin: 0;">
                          <label style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: block;">Description (Optional)</label>
                          <textarea class="form-textarea" placeholder="Service description" style="font-size: 13px; padding: 8px; min-height: 60px;" onchange="updateServiceLine(${idx}, 'description', this.value)">${service.description || ''}</textarea>
                        </div>
                        <button class="btn-icon-sm" onclick="removeServiceLine(${idx})" style="margin-top: 24px;">‚úñ</button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- 2. Delivery Requirements -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0;">2. Delivery Requirements</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addDeliveryRequirementField()" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div class="form-grid">
                  ${deliveryRequirementFields.map((field, idx) => {
                    if (field.type === 'text') {
                      return `
                        <div class="form-group" style="position: relative;">
                          <label class="form-label">${field.label}</label>
                          <div style="display: flex; gap: 8px; align-items: start;">
                            <input type="text" class="form-input" value="${field.value}" placeholder="${field.placeholder}" onchange="updateDeliveryFieldValue('${field.id}', this.value)" style="flex: 1;" />
                            <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" title="Remove field">‚úñ</button>
                          </div>
                        </div>
                      `;
                    } else if (field.type === 'multi-select' && field.id === 'dr3') {
                      return `
                        <div class="form-group full-width" style="position: relative;">
                          <label class="form-label">${field.label}</label>
                          <div style="display: flex; gap: 8px; align-items: start;">
                            <div style="flex: 1;">
                              <select class="form-select" multiple size="4" onchange="updateAllowedIncoterms(this)">
                                <option value="EXW" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('EXW') ? 'selected' : ''}>EXW - Ex Works</option>
                                <option value="FCA" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('FCA') ? 'selected' : ''}>FCA - Free Carrier</option>
                                <option value="CPT" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('CPT') ? 'selected' : ''}>CPT - Carriage Paid To</option>
                                <option value="CIP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('CIP') ? 'selected' : ''}>CIP - Carriage and Insurance Paid To</option>
                                <option value="DAP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('DAP') ? 'selected' : ''}>DAP - Delivered at Place</option>
                                <option value="DPU" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('DPU') ? 'selected' : ''}>DPU - Delivered at Place Unloaded</option>
                                <option value="DDP" ${tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.includes('DDP') ? 'selected' : ''}>DDP - Delivered Duty Paid</option>
                              </select>
                              <span class="help-text">Hold Ctrl/Cmd to select multiple Incoterms</span>
                            </div>
                            <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" title="Remove field">‚úñ</button>
                          </div>
                        </div>
                      `;
                    } else if (field.type === 'textarea') {
                      return `
                        <div class="form-group full-width" style="position: relative;">
                          <label class="form-label">${field.label}</label>
                          <div style="display: flex; gap: 8px; align-items: start;">
                            <textarea class="form-textarea" placeholder="${field.placeholder}" onchange="updateDeliveryFieldValue('${field.id}', this.value)" style="flex: 1;">${field.value}</textarea>
                            <button class="btn-icon-sm" onclick="removeDeliveryRequirementField('${field.id}')" title="Remove field">‚úñ</button>
                          </div>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              </div>
              
              <!-- 3. Specific Requirements -->
              <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0;">3. Specific Requirements</h4>
                <div class="form-group">
                  <label class="form-label">Specific requirements, conditions and additional information</label>
                  <textarea class="form-textarea" placeholder="Enter specific requirements, conditions and additional information..." style="min-height: 120px;" onchange="tenderAuthorConfig.specificRequirements = this.value">${tenderAuthorConfig.specificRequirements || ''}</textarea>
                  <span class="help-text">Add any specific requirements, conditions, or additional information that suppliers need to know</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Helper functions for Tender Author Config
      window.addServiceLine = function() {
        tenderAuthorConfig.serviceDescriptions.push({
          name: '',
          description: '',
        });
        renderCurrentBlock();
      }
      
      window.updateServiceLine = function(idx, field, value) {
        if (tenderAuthorConfig.serviceDescriptions[idx]) {
          tenderAuthorConfig.serviceDescriptions[idx][field] = value;
        }
      }
      
      window.removeServiceLine = function(idx) {
        tenderAuthorConfig.serviceDescriptions.splice(idx, 1);
        renderCurrentBlock();
      }
      
      window.updateAllowedIncoterms = function(selectElement) {
        const selectedOptions = Array.from(selectElement.selectedOptions).map(option => option.value);
        tenderAuthorConfig.deliveryConfig.allowedIncoterms = selectedOptions;
      }
      
      // ===== SUPPLIER FORM PREVIEW SECTION =====
      function renderSupplierFormPreviewSection(block, section, sectionIndex, isFirst) {
        // Check if preview should be visible
        if (!isSupplierFormPreviewVisible) {
          return '';
        }
        
        // Initialize requisition lines if not already done
        if (requisitionLines.length === 0) {
          initializeRequisitionLines();
        }
        
        // Get all UNSPSC codes
        let unspscCodesToShow = [];
        if (lots.length === 0) {
          unspscCodesToShow = requisitionLines.map(line => ({
            code: line.unspscCode,
            description: line.unspscDescription,
          }));
        } else {
          lots.forEach(lot => {
            lot.unspscCodes.forEach(unspsc => {
              unspscCodesToShow.push({
                code: unspsc.code,
                description: unspsc.description,
                lotName: lot.name,
              });
            });
          });
        }
        
        // Remove duplicates
        const uniqueUnspscCodes = [];
        const seenCodes = new Set();
        unspscCodesToShow.forEach(item => {
          if (!seenCodes.has(item.code)) {
            seenCodes.add(item.code);
            uniqueUnspscCodes.push(item);
          }
        });
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg); background: var(--info-100); border-color: var(--info-400);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è <strong>Preview:</strong> This shows how the supplier form will appear with the configured requirements. Fields below are pre-populated from your tender configuration.
                </div>
              </div>
              
              <!-- A. Per Bid Responses -->
              <div style="background: var(--surface-0); border: 1px solid var(--primary-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--primary-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                  <span style="background: var(--primary-100); color: var(--primary-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">A</span>
                  Per Bid (answered once)
                </h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">Bidder's Total Prices [Incoterm]</label>
                    <input type="number" class="form-input" placeholder="Enter total price" disabled />
                    <span class="help-text">Supplier will enter their total price here</span>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Customs clearance costs</label>
                    <input type="number" class="form-input" placeholder="Enter customs costs" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Freight cost</label>
                    <input type="number" class="form-input" placeholder="Enter freight cost" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Price of Goods [Incoterm]</label>
                    <input type="number" class="form-input" placeholder="Calculated automatically" disabled />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Total Price of Related Services</label>
                    <input type="number" class="form-input" placeholder="Enter services price" disabled />
                  </div>
                </div>
              </div>
              
              <!-- B. Per UNSPSC Responses -->
              ${uniqueUnspscCodes.length > 0 ? uniqueUnspscCodes.map((unspsc, idx) => {
                const req = productRequirements[unspsc.code] || { requirementType: null, attributes: [], description: '' };
                return `
                  <div style="background: var(--surface-0); border: 1px solid var(--info-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                    <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--info-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                      <span style="background: var(--info-100); color: var(--info-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">B${idx + 1}</span>
                      Per UNSPSC: ${unspsc.code}
                    </h3>
                    <div style="background: var(--surface-50); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-lg);">
                      <strong style="font-size: 14px;">${unspsc.description}</strong>
                      ${unspsc.lotName ? `<span style="font-size: 13px; color: var(--text-muted); display: block; margin-top: 4px;">Lot: ${unspsc.lotName}</span>` : ''}
                    </div>
                    
                    <div class="form-grid">
                      <div class="form-group">
                        <label class="form-label">Unit price Incoterm</label>
                        <input type="number" class="form-input" placeholder="Enter unit price" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Total price Incoterm</label>
                        <input type="number" class="form-input" placeholder="Calculated" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Country of Origin</label>
                        <select class="form-select" disabled>
                          <option>Select country...</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label class="form-label">Delivery point(s)</label>
                        <input type="text" class="form-input" placeholder="Enter delivery points" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-input" placeholder="Enter model" disabled />
                      </div>
                      <div class="form-group">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-input" placeholder="Enter manufacturer" disabled />
                      </div>
                    </div>
                    
                    <!-- C. Per Attribute (for this UNSPSC) -->
                    ${req.requirementType === 'attributes' && req.attributes.length > 0 ? `
                      <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--success-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                          <span style="background: var(--success-100); color: var(--success-600); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700;">C</span>
                          Product Attributes
                        </h4>
                        ${req.attributes.map(attr => `
                          <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <strong style="font-size: 14px; display: block; margin-bottom: 8px; color: var(--success-700);">${attr.name}: ${attr.value}</strong>
                            <div class="form-grid">
                              <div class="form-group" style="margin: 0;">
                                <label class="form-label">Is quotation compliant?</label>
                                <div style="display: flex; gap: var(--spacing-md);">
                                  <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="compliant-${unspsc.code}-${attr.name}" disabled />
                                    <span style="font-size: 14px;">Yes</span>
                                  </label>
                                  <label style="display: flex; align-items: center; gap: 4px;">
                                    <input type="radio" name="compliant-${unspsc.code}-${attr.name}" disabled />
                                    <span style="font-size: 14px;">No</span>
                                  </label>
                                </div>
                              </div>
                              <div class="form-group" style="margin: 0;">
                                <label class="form-label">Details of goods offered</label>
                                <textarea class="form-textarea" placeholder="Supplier will describe their offering" style="min-height: 60px;" disabled></textarea>
                              </div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    ` : req.requirementType === 'description' && req.description ? `
                      <div style="background: var(--success-50); border: 1px solid var(--success-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-top: var(--spacing-lg);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0; color: var(--success-600);">Product Requirements (Description)</h4>
                        <div style="background: var(--surface-0); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); white-space: pre-wrap; font-size: 14px; line-height: 1.5;">
                          ${req.description}
                        </div>
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-desc-${unspsc.code}" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-desc-${unspsc.code}" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group">
                          <label class="form-label">Details of goods offered</label>
                          <textarea class="form-textarea" placeholder="Supplier will describe their offering" style="min-height: 80px;" disabled></textarea>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('') : '<div style="text-align: center; padding: var(--spacing-xl); color: var(--text-muted);">No UNSPSC codes defined. Add requisition lines or lots to see UNSPSC-level fields.</div>'}
              
              <!-- D. Per Service Line -->
              ${tenderAuthorConfig.serviceDescriptions.length > 0 ? `
                <div style="background: var(--surface-0); border: 1px solid var(--warning-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                  <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--warning-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="background: var(--warning-100); color: var(--warning-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">D</span>
                    Per Service Line
                  </h3>
                  ${tenderAuthorConfig.serviceDescriptions.map((service, idx) => `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-md) 0;">${service.name || `Service ${idx + 1}`}</h4>
                      ${service.description ? `<p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">${service.description}</p>` : ''}
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-service-${idx}" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-service-${idx}" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide service details" style="min-height: 80px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <!-- E. Delivery Requirements -->
              ${tenderAuthorConfig.deliveryConfig.deliveryTime || tenderAuthorConfig.deliveryConfig.deliveryPlace || (tenderAuthorConfig.deliveryConfig.allowedIncoterms && tenderAuthorConfig.deliveryConfig.allowedIncoterms.length > 0) || tenderAuthorConfig.deliveryConfig.consigneeDetails ? `
                <div style="background: var(--surface-0); border: 1px solid var(--danger-200); border-radius: var(--radius-md); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl);">
                  <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 var(--spacing-lg) 0; color: var(--danger-600); display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span style="background: var(--danger-100); color: var(--danger-600); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">E</span>
                    Delivery Requirements
                  </h3>
                  ${tenderAuthorConfig.deliveryConfig.deliveryTime ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">Delivery Time</h4>
                      <p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Required: ${tenderAuthorConfig.deliveryConfig.deliveryTime}</p>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-time" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-time" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide delivery time details" style="min-height: 60px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                  ${tenderAuthorConfig.deliveryConfig.deliveryPlace ? `
                    <div style="background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                      <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 var(--spacing-sm) 0;">Delivery Place</h4>
                      <p style="font-size: 14px; color: var(--text-muted); margin-bottom: var(--spacing-md);">Required: ${tenderAuthorConfig.deliveryConfig.deliveryPlace}</p>
                      <div class="form-grid">
                        <div class="form-group">
                          <label class="form-label">Is quotation compliant?</label>
                          <div style="display: flex; gap: var(--spacing-md);">
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-place" disabled />
                              <span style="font-size: 14px;">Yes</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                              <input type="radio" name="compliant-delivery-place" disabled />
                              <span style="font-size: 14px;">No</span>
                            </label>
                          </div>
                        </div>
                        <div class="form-group full-width">
                          <label class="form-label">Details</label>
                          <textarea class="form-textarea" placeholder="Supplier will provide delivery place details" style="min-height: 60px;" disabled></textarea>
                        </div>
                      </div>
                    </div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      // ===== BID RESPONSE REQUIREMENTS SECTION =====
      function renderSupplierResponseStructureSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                  <span class="section-icon">${block.icon}</span>
                  <span>Bid Response Requirements</span>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="toggleSupplierFormPreview()" style="font-size: 13px;">
                  üëÅÔ∏è Preview Supplier Form
                </button>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è This shows how supplier questions will be structured and grouped by answer level
                </div>
              </div>
              
              <!-- A. Per Bid -->
              <div style="background: var(--surface-0); border-left: 4px solid var(--primary-400); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border-radius: var(--radius-sm); box-shadow: var(--shadow-card);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--primary-600);">A. Per Bid (answered once for entire bid)</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addBidResponseField('perBid')" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${bidResponseFields.perBid.map((field, idx) => `
                    <div style="padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <strong style="font-size: 14px; display: block; margin-bottom: 4px;">${field.name}</strong>
                        <span style="font-size: 12px; color: var(--text-muted);">Field type: ${field.type}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeBidResponseField('perBid', '${field.id}')" title="Remove field">‚úñ</button>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- B. Per UNSPSC -->
              <div style="background: var(--surface-0); border-left: 4px solid var(--info-400); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border-radius: var(--radius-sm); box-shadow: var(--shadow-card);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--info-400);">B. Per UNSPSC (for each UNSPSC item)</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addBidResponseField('perUNSPSC')" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${bidResponseFields.perUNSPSC.map((field, idx) => `
                    <div style="padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <strong style="font-size: 14px; display: block; margin-bottom: 4px;">${field.name}</strong>
                        <span style="font-size: 12px; color: var(--text-muted);">Field type: ${field.type}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeBidResponseField('perUNSPSC', '${field.id}')" title="Remove field">‚úñ</button>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- C. Per Attribute -->
              <div style="background: var(--surface-0); border-left: 4px solid var(--success-500); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border-radius: var(--radius-sm); box-shadow: var(--shadow-card);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--success-500);">C. Per Attribute (under each UNSPSC attribute)</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addBidResponseField('perAttribute')" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${bidResponseFields.perAttribute.map((field, idx) => `
                    <div style="padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <strong style="font-size: 14px; display: block; margin-bottom: 4px;">${field.name}</strong>
                        <span style="font-size: 12px; color: var(--text-muted);">Field type: ${field.type}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeBidResponseField('perAttribute', '${field.id}')" title="Remove field">‚úñ</button>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- D. Per Service Line -->
              <div style="background: var(--surface-0); border-left: 4px solid var(--warning-500); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border-radius: var(--radius-sm); box-shadow: var(--shadow-card);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--warning-500);">D. Per Service Line</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addBidResponseField('perServiceLine')" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${bidResponseFields.perServiceLine.map((field, idx) => `
                    <div style="padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <strong style="font-size: 14px; display: block; margin-bottom: 4px;">${field.name}</strong>
                        <span style="font-size: 12px; color: var(--text-muted);">Field type: ${field.type}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeBidResponseField('perServiceLine', '${field.id}')" title="Remove field">‚úñ</button>
                    </div>
                  `).join('')}
                </div>
              </div>
              
              <!-- E. Delivery Requirements -->
              <div style="background: var(--surface-0); border-left: 4px solid var(--danger-500); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border-radius: var(--radius-sm); box-shadow: var(--shadow-card);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--danger-500);">E. Delivery Requirements (per requirement)</h4>
                  <button class="btn btn-ghost btn-sm" onclick="addBidResponseField('perDelivery')" style="font-size: 13px;">+ Add Field</button>
                </div>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                  ${bidResponseFields.perDelivery.map((field, idx) => `
                    <div style="padding: var(--spacing-md); background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200); display: flex; justify-content: space-between; align-items: start;">
                      <div>
                        <strong style="font-size: 14px; display: block; margin-bottom: 4px;">${field.name}</strong>
                        <span style="font-size: 12px; color: var(--text-muted);">Field type: ${field.type}</span>
                      </div>
                      <button class="btn-icon-sm" onclick="removeBidResponseField('perDelivery', '${field.id}')" title="Remove field">‚úñ</button>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      // ===== AUTHORING FUNCTIONS =====
      function initAuthoring() {
        initializeRequisitionLines(); // Initialize sample data
        renderBlockTabs();
        renderCurrentBlock();
        updateProgressSteps();
        updateNavigationButtons();
        setupFormLibrary();
        // Setup drop zones after a short delay to ensure DOM is ready
        setTimeout(() => {
          setupDropZones();
        }, 100);
      }

      function renderBlockTabs() {
        const nav = document.getElementById('block-nav');
        nav.innerHTML = '';

        templateBlocks.forEach((block, index) => {
          const tab = document.createElement('button');
          tab.className = 'block-tab';
          if (index === currentBlockIndex) {
            tab.classList.add('active');
          }
          tab.innerHTML = `
            <span class="block-tab-icon">${block.icon}</span>
            <span>${block.name}</span>
            <span class="block-tab-badge">${index + 1}</span>
          `;
          tab.addEventListener('click', () => {
            switchToBlock(index);
          });
          nav.appendChild(tab);
        });
      }

      function switchToBlock(index) {
        currentBlockIndex = index;
        renderBlockTabs();
        renderCurrentBlock();
        updateNavigationButtons();
      }

      function renderEvaluationCriteriaSection(block, section, sectionIndex, isFirst) {
        // Get available UNSPSC codes
        const availableUnspscCodes = getAvailableUnspscCodes();
        
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Define evaluation criteria that will be used to assess supplier submissions
                </div>
              </div>
              
              <div style="display: flex; justify-content: flex-end; margin-bottom: var(--spacing-lg);">
                <button class="btn btn-primary btn-sm" onclick="addEvaluationCriterion()">+ Add Evaluation Criterion</button>
              </div>
              
              ${evaluationCriteria.length === 0 ? `
                <div class="empty-state">
                  <div class="empty-state-icon">üìä</div>
                  <div class="empty-state-text">No evaluation criteria defined</div>
                  <div class="empty-state-hint">Click "+ Add Evaluation Criterion" to define how submissions will be evaluated</div>
                </div>
              ` : `
                <div style="display: flex; flex-direction: column; gap: var(--spacing-lg);">
                  ${evaluationCriteria.map((criterion, idx) => `
                    <div style="background: var(--surface-0); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); padding: var(--spacing-lg); box-shadow: var(--shadow-card);">
                      <div style="display: flex; justify-content: between; align-items: start; margin-bottom: var(--spacing-md);">
                        <h4 style="font-size: 16px; font-weight: 600; margin: 0; flex: 1;">Criterion ${idx + 1}</h4>
                        <button class="btn-icon-sm" onclick="removeEvaluationCriterion('${criterion.id}')" title="Remove criterion">‚úñ</button>
                      </div>
                      
                      <div class="form-grid">
                        <!-- Type -->
                        <div class="form-group">
                          <label class="form-label">Type <span class="required-indicator">*</span></label>
                          <select class="form-select" value="${criterion.type}" onchange="updateEvaluationCriterionType('${criterion.id}', this.value)">
                            <option value="Eligibility and formal criteria" ${criterion.type === 'Eligibility and formal criteria' ? 'selected' : ''}>Eligibility and formal criteria</option>
                            <option value="Qualification criteria" ${criterion.type === 'Qualification criteria' ? 'selected' : ''}>Qualification criteria</option>
                            <option value="Technical criteria" ${criterion.type === 'Technical criteria' ? 'selected' : ''}>Technical criteria</option>
                            <option value="Shortlisting criteria" ${criterion.type === 'Shortlisting criteria' ? 'selected' : ''}>Shortlisting criteria</option>
                          </select>
                        </div>
                        
                        <!-- Evaluation Method -->
                        <div class="form-group">
                          <label class="form-label">Evaluation Method <span class="required-indicator">*</span></label>
                          <select class="form-select" value="${criterion.evaluationMethod}" onchange="updateEvaluationCriterionMethod('${criterion.id}', this.value)">
                            <option value="Pass/Fail" ${criterion.evaluationMethod === 'Pass/Fail' ? 'selected' : ''}>Pass/Fail</option>
                            <option value="Scoring (0-100)" ${criterion.evaluationMethod === 'Scoring (0-100)' ? 'selected' : ''}>Scoring (0-100)</option>
                            <option value="Weighted Scoring" ${criterion.evaluationMethod === 'Weighted Scoring' ? 'selected' : ''}>Weighted Scoring</option>
                            <option value="Ranking" ${criterion.evaluationMethod === 'Ranking' ? 'selected' : ''}>Ranking</option>
                          </select>
                        </div>
                        
                        <!-- Description -->
                        <div class="form-group full-width">
                          <label class="form-label">Description <span class="required-indicator">*</span></label>
                          <textarea 
                            class="form-textarea" 
                            placeholder="Describe the evaluation criterion in detail..." 
                            style="min-height: 100px;"
                            onchange="updateEvaluationCriterionDescription('${criterion.id}', this.value)"
                          >${criterion.description}</textarea>
                          <span class="help-text">Provide a clear description of what will be evaluated and how</span>
                        </div>
                        
                        <!-- Applies To -->
                        <div class="form-group full-width">
                          <label class="form-label">Applies To <span class="required-indicator">*</span></label>
                          <div style="display: flex; gap: var(--spacing-lg); margin-bottom: var(--spacing-sm);">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input 
                                type="radio" 
                                name="appliesTo_${criterion.id}" 
                                value="entire" 
                                ${criterion.appliesTo === 'entire' ? 'checked' : ''}
                                onchange="updateEvaluationCriterionAppliesTo('${criterion.id}', this.value)"
                                style="cursor: pointer;"
                              />
                              <span>Entire Tender</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                              <input 
                                type="radio" 
                                name="appliesTo_${criterion.id}" 
                                value="specific" 
                                ${criterion.appliesTo === 'specific' ? 'checked' : ''}
                                onchange="updateEvaluationCriterionAppliesTo('${criterion.id}', this.value)"
                                style="cursor: pointer;"
                              />
                              <span>Specific Lot(s) or Product(s)</span>
                            </label>
                          </div>
                          
                          ${criterion.appliesTo === 'specific' ? `
                            <div style="margin-top: var(--spacing-md);">
                              ${availableUnspscCodes.length === 0 && lots.length === 0 ? `
                                <div style="padding: var(--spacing-md); background: var(--warning-50); border: 1px solid var(--warning-200); border-radius: var(--radius-sm); color: var(--warning-700);">
                                  ‚ö†Ô∏è No lots or products available. Please add requisition lines or create lots with products first.
                                </div>
                              ` : `
                                ${lots.length > 0 ? `
                                  <div style="margin-bottom: var(--spacing-lg);">
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">
                                      Select by Lot
                                    </label>
                                    <select 
                                      class="form-select" 
                                      multiple 
                                      size="4"
                                      onchange="updateEvaluationCriterionLots('${criterion.id}', this)"
                                      style="width: 100%;"
                                    >
                                      ${lots.map(lot => `
                                        <option 
                                          value="${lot.id}" 
                                          ${criterion.lots.includes(lot.id) ? 'selected' : ''}
                                        >
                                          ${lot.name} (${lot.unspscCodes.length} products)
                                        </option>
                                      `).join('')}
                                    </select>
                                    <span class="help-text">Selecting a lot automatically includes all products in that lot. Hold Ctrl/Cmd to select multiple lots.</span>
                                  </div>
                                ` : ''}
                                
                                ${availableUnspscCodes.length > 0 ? `
                                  <div>
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">
                                      ${lots.length > 0 ? 'Or Select Individual Products (UNSPSC Codes)' : 'Select Products (UNSPSC Codes)'}
                                    </label>
                                    <select 
                                      class="form-select" 
                                      multiple 
                                      size="6"
                                      onchange="updateEvaluationCriterionUnspscCodes('${criterion.id}', this)"
                                      style="width: 100%;"
                                    >
                                      ${availableUnspscCodes.map(unspsc => {
                                        // Find which lot(s) contain this UNSPSC code
                                        const containingLots = lots.filter(lot => 
                                          lot.unspscCodes.some(u => u.code === unspsc.code)
                                        ).map(lot => lot.name);
                                        
                                        const lotInfo = containingLots.length > 0 
                                          ? ` [In: ${containingLots.join(', ')}]` 
                                          : ' [From requisition]';
                                        
                                        return `
                                          <option 
                                            value="${unspsc.code}" 
                                            ${criterion.unspscCodes.includes(unspsc.code) ? 'selected' : ''}
                                          >
                                            ${unspsc.code} - ${unspsc.description}${lotInfo}
                                          </option>
                                        `;
                                      }).join('')}
                                    </select>
                                    <span class="help-text">Hold Ctrl/Cmd to select multiple products. Products selected via lots above are automatically included.</span>
                                  </div>
                                ` : ''}
                                
                                ${criterion.lots.length > 0 || criterion.unspscCodes.length > 0 ? `
                                  <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--info-50); border: 1px solid var(--info-200); border-radius: var(--radius-sm);">
                                    <strong style="color: var(--info-700);">üìä Current Selection:</strong>
                                    <div style="margin-top: var(--spacing-xs); color: var(--info-700);">
                                      ${criterion.lots.length > 0 ? `
                                        <div>‚úì ${criterion.lots.length} lot(s) selected</div>
                                      ` : ''}
                                      <div>‚úì ${criterion.unspscCodes.length} product(s) will be evaluated with this criterion</div>
                                    </div>
                                  </div>
                                ` : ''}
                              `}
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }

      function renderParticularsSection(block, section, sectionIndex, isFirst) {
        return `
          <div class="form-section">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">${block.icon}</span>
                <span>${section.title}</span>
              </div>
            </div>
            <div class="section-body">
              <div class="info-alert" style="margin-bottom: var(--spacing-lg);">
                <div class="info-alert-text">
                  ‚ÑπÔ∏è Define comprehensive tender particulars including scope, requirements, and commercial conditions
                </div>
              </div>
              
              <div class="form-grid">
                <!-- Scope and objectives -->
                <div class="form-group full-width">
                  <label class="form-label">Scope and objectives of the sourcing or solicitation process</label>
                  <textarea class="form-textarea" placeholder="Describe the scope and objectives..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Specific requirements -->
                <div class="form-group full-width">
                  <label class="form-label">Specific requirements, conditions and additional information</label>
                  <textarea class="form-textarea" placeholder="Enter specific requirements and conditions..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Evaluation of submissions -->
                <div class="form-group full-width">
                  <label class="form-label">Evaluation of submissions</label>
                  <textarea class="form-textarea" placeholder="Describe how submissions will be evaluated..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Instructions -->
                <div class="form-group full-width">
                  <label class="form-label">Instructions</label>
                  <textarea class="form-textarea" placeholder="Provide instructions to suppliers..." style="min-height: 100px;"></textarea>
                </div>
                
                <!-- Disclaimer (Auto-generated) -->
                <div class="form-group full-width">
                  <label class="form-label">Disclaimer</label>
                  <input type="text" class="form-input" value="This process is a Sourcing process TBD." readonly style="background: var(--surface-100);" />
                  <span class="help-text">Auto-generated disclaimer text</span>
                </div>
                
                <!-- Interpretation (Auto-generated) -->
                <div class="form-group full-width">
                  <label class="form-label">Interpretation of the RFP/ITB</label>
                  <textarea class="form-textarea" readonly style="background: var(--surface-100); min-height: 80px;">Standard interpretation clauses for RFP/ITB documentation will be applied as per UNOPS procurement policy.</textarea>
                  <span class="help-text">Auto-generated interpretation text</span>
                </div>
                
                <!-- Bidder eligibility -->
                <div class="form-group">
                  <label class="form-label">Bidder eligibility</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>All eligible bidders</option>
                    <option>Pre-qualified bidders only</option>
                    <option>Specific criteria</option>
                  </select>
                </div>
                
                <!-- Clarifications or pre-bid meeting -->
                <div class="form-group">
                  <label class="form-label">Clarifications or pre-bid meeting</label>
                  <select class="form-select" onchange="updateClarificationsOrPreBid(this.value)">
                    <option value="">Select...</option>
                    <option value="No pre-bid meeting">No pre-bid meeting</option>
                    <option value="One pre-bid meeting">One pre-bid meeting</option>
                    <option value="Two pre-bid meetings">Two pre-bid meetings</option>
                  </select>
                </div>
                
                <!-- Supplier capacity-building initiatives -->
                <div class="form-group full-width">
                  <label class="form-label">Supplier capacity-building initiatives</label>
                  <textarea class="form-textarea" placeholder="Describe capacity-building initiatives if applicable..." style="min-height: 80px;"></textarea>
                </div>
                
                ${particularsValues.numberOfMeetings > 0 ? `
                  <!-- Pre-bid Meeting Fields -->
                  <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Pre-Bid Meeting Details</h4>
                  </div>
                  
                  ${Array.from({length: particularsValues.numberOfMeetings}, (_, i) => `
                    <div class="form-group full-width" style="background: var(--surface-50); padding: var(--spacing-md); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md);">
                      <h5 style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-sm);">Meeting ${i + 1}</h5>
                      
                      <div class="form-group">
                        <label class="form-label">Date and time for pre-bid meeting ${i + 1}</label>
                        <input type="datetime-local" class="form-input" />
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label">Type of pre-bid meeting</label>
                        <select class="form-select">
                          <option>Select...</option>
                          <option>In-person</option>
                          <option>Virtual (video conference)</option>
                          <option>Hybrid</option>
                        </select>
                      </div>
                      
                      <div class="form-group full-width">
                        <label class="form-label">Pre-bid meeting details</label>
                        <textarea class="form-textarea" placeholder="Provide meeting details (location, dial-in info, etc.)..." style="min-height: 80px;"></textarea>
                      </div>
                    </div>
                  `).join('')}
                ` : ''}
                
                <!-- Site Visit Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Site Visit</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Site visit or inspection</label>
                  <select class="form-select" onchange="updateSiteVisit(this.value)">
                    <option value="">Select...</option>
                    <option value="Not applicable">Not applicable</option>
                    <option value="Applicable">Applicable</option>
                  </select>
                </div>
                
                ${particularsValues.siteVisit === 'Applicable' ? `
                  <div class="form-group">
                    <label class="form-label">Date option for site visit or inspection</label>
                    <select class="form-select" onchange="updateSiteVisitDateOption(this.value)">
                      <option value="">Select...</option>
                      <option value="Specific date">Specific date</option>
                      <option value="Date range">Date range</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Date/time for site visit or inspection</label>
                    <input type="datetime-local" class="form-input" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Details for site visit or inspection</label>
                    <textarea class="form-textarea" placeholder="Provide site visit details (location, contact, requirements, etc.)..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Exclusivity Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Exclusivity</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Exclusivity and/or availability statement</label>
                  <select class="form-select" onchange="updateExclusivity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.exclusivity === 'Required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Exclusivity / availability details</label>
                    <textarea class="form-textarea" placeholder="Provide exclusivity or availability requirements..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Commercial Conditions Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Commercial Conditions</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Validity period (days)</label>
                  <input type="number" class="form-input" placeholder="e.g., 90" min="1" />
                </div>
                
                <div class="form-group">
                  <label class="form-label">Quotation/Bid/Proposal currency(ies)</label>
                  <select class="form-select" multiple size="4">
                    <option>USD</option>
                    <option>EUR</option>
                    <option>GBP</option>
                    <option>CHF</option>
                    <option>Other</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Duties and taxes</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Excluded</option>
                    <option>Included</option>
                    <option>As specified</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Languages of submissions</label>
                  <select class="form-select">
                    <option>English</option>
                    <option>French</option>
                    <option>Spanish</option>
                    <option>Multiple languages</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Other languages</label>
                  <select class="form-select" multiple size="3">
                    <option>Arabic</option>
                    <option>Chinese</option>
                    <option>Portuguese</option>
                    <option>Russian</option>
                  </select>
                  <span class="help-text">Hold Ctrl/Cmd to select multiple</span>
                </div>
                
                <!-- Alternative Offers Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Alternative Offers</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Alternative quotations/offers/proposals</label>
                  <select class="form-select" onchange="updateAlternativeOffers(this.value)">
                    <option value="">Select...</option>
                    <option value="Not accepted">Not accepted</option>
                    <option value="Accepted">Accepted</option>
                  </select>
                </div>
                
                ${particularsValues.alternativeOffers === 'Accepted' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Alternative offers details</label>
                    <textarea class="form-textarea" placeholder="Describe requirements for alternative offers..." style="min-height: 80px;"></textarea>
                  </div>
                ` : ''}
                
                <!-- Contracting Details Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Contracting Details</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Type of contract to be awarded</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Purchase Order</option>
                    <option>Long-term Agreement (LTA)</option>
                    <option>Blanket Purchase Agreement (BPA)</option>
                    <option>Service Contract</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">General Conditions of Contract</label>
                  <select class="form-select">
                    <option>UNOPS General Conditions</option>
                    <option>Custom General Conditions</option>
                  </select>
                  <span class="help-text">Pre-filled with UNOPS standard terms</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Public bid/proposal opening</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Yes - Public opening</option>
                    <option>No - Private opening</option>
                  </select>
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Opening of bid details (location, date, time)</label>
                  <textarea class="form-textarea" placeholder="Provide details of bid opening ceremony..." style="min-height: 60px;"></textarea>
                </div>
                
                <!-- Payment Terms Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Payment Terms & Advance Payments</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Terms</label>
                  <select class="form-select">
                    <option>Select...</option>
                    <option>Net 30</option>
                    <option>Net 60</option>
                    <option>Upon delivery</option>
                    <option>Milestone-based</option>
                    <option>Other</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment terms details</label>
                  <input type="text" class="form-input" placeholder="e.g., net 30 days from invoice" />
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Payment terms ‚Äì Other</label>
                  <textarea class="form-textarea" placeholder="Provide additional payment terms if applicable..." style="min-height: 60px;"></textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Advance payment allowed?</label>
                  <select class="form-select" onchange="updateAdvancePaymentAllowed(this.value)">
                    <option value="">Select...</option>
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                  <div style="margin-top: 8px; padding: 12px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 13px; color: var(--text-secondary);">
                    ‚ÑπÔ∏è <strong>Advance Payment Policy:</strong> As per UNOPS policy, advance payments may be considered under specific circumstances and require appropriate justification and security.
                  </div>
                </div>
                
                ${particularsValues.advancePaymentAllowed === 'Yes' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification/background for advance payment</label>
                    <textarea class="form-textarea" placeholder="Provide justification for advance payment..." style="min-height: 80px;"></textarea>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Additional rationale / specific information</label>
                    <textarea class="form-textarea" placeholder="Provide additional rationale..." style="min-height: 60px;"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Advance payment percentage requested</label>
                    <select class="form-select">
                      <option>Select...</option>
                      <option>Up to 20%</option>
                      <option>Up to 30%</option>
                      <option>Up to 40%</option>
                      <option>Other (requires exception)</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Exception justification (upload CFO approval + Jira link)</label>
                    <div style="display: flex; gap: var(--spacing-md); align-items: center; margin-bottom: var(--spacing-sm);">
                      <input type="file" class="form-input" accept=".pdf,.doc,.docx" style="flex: 1;" />
                      <button class="btn btn-secondary btn-sm" type="button">üìé Upload CFO Approval</button>
                    </div>
                    <input type="text" class="form-input" placeholder="Enter Jira link" style="margin-top: 8px;" />
                    <div style="margin-top: 8px; padding: 10px; background: var(--warning-50); border-left: 3px solid var(--warning-500); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                      ‚ö†Ô∏è <strong>Advisory:</strong> Advance payments exceeding standard thresholds require CFO approval and documented exception.
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Advance payment security required?</label>
                    <select class="form-select" onchange="updateAdvancePaymentSecurity(this.value)">
                      <option value="">Select...</option>
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                    <div style="margin-top: 8px; padding: 10px; background: var(--info-50); border-left: 3px solid var(--info-400); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                      ‚ÑπÔ∏è Advance payment security (bank guarantee or similar) is typically required to protect UNOPS interests.
                    </div>
                  </div>
                  
                  ${particularsValues.advancePaymentSecurity === 'Yes' ? `
                    <div class="form-group">
                      <label class="form-label">Deadline for provision of security ‚Äì Date</label>
                      <input type="date" class="form-input" />
                    </div>
                    
                    <div class="form-group full-width">
                      <label class="form-label">Applicable format of security/guarantee</label>
                      <textarea class="form-textarea" placeholder="Specify format of security/guarantee required..." style="min-height: 60px;"></textarea>
                    </div>
                  ` : particularsValues.advancePaymentSecurity === 'No' ? `
                    <div class="form-group full-width">
                      <label class="form-label">Rationale for not requiring AP security</label>
                      <textarea class="form-textarea" placeholder="Provide justification for not requiring advance payment security..." style="min-height: 80px;"></textarea>
                    </div>
                  ` : ''}
                ` : ''}
                
                <!-- Additional Payment-Related Requirements Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Additional Payment-Related Requirements</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Audited Financial Documents</label>
                  <select class="form-select">
                    <option>Required</option>
                    <option>Not required</option>
                    <option>Conditional</option>
                  </select>
                  <span class="help-text">Pre-filled based on procurement value</span>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Security / Bank Guarantee</label>
                  <select class="form-select">
                    <option>Required</option>
                    <option>Not required</option>
                  </select>
                  <span class="help-text">Pre-filled based on contract type</span>
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label">Advance Payment details for suppliers</label>
                  <select class="form-select">
                    <option>Standard terms apply</option>
                    <option>Custom terms</option>
                  </select>
                  <div style="margin-top: 8px; padding: 12px; background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary);">
                    <strong>Supplier Requirements:</strong> If advance payment is approved, suppliers must submit required security/guarantee within specified timeframe. Payment will be processed upon receipt and verification of security documentation.
                  </div>
                </div>
                
                <!-- Damages & Securities Section -->
                <div class="form-group full-width" style="border-top: 2px solid var(--surface-200); padding-top: var(--spacing-lg); margin-top: var(--spacing-md);">
                  <h4 style="font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-md);">Damages & Securities</h4>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Liquidated or Delay Damages</label>
                  <select class="form-select" onchange="updateLiquidatedDamages(this.value)">
                    <option value="">Select...</option>
                    <option value="Not applicable">Not applicable</option>
                    <option value="Applicable">Applicable</option>
                  </select>
                </div>
                
                ${particularsValues.liquidatedDamages === 'Applicable' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification</label>
                    <textarea class="form-textarea" placeholder="Provide justification for applying liquidated damages..." style="min-height: 60px;"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Details</label>
                    <select class="form-select">
                      <option>Select...</option>
                      <option>0.5% per day (max 10%)</option>
                      <option>1% per day (max 10%)</option>
                      <option>Custom rate</option>
                      <option>Other</option>
                    </select>
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Other details</label>
                    <textarea class="form-textarea" placeholder="Provide other liquidated damages details..." style="min-height: 60px;"></textarea>
                  </div>
                ` : particularsValues.liquidatedDamages === 'Not applicable' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification for not applying LD</label>
                    <textarea class="form-textarea" placeholder="Provide justification for not applying liquidated damages..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
                <div class="form-group">
                  <label class="form-label">Performance security</label>
                  <select class="form-select" onchange="updatePerformanceSecurity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.performanceSecurity === 'Required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Performance security details</label>
                    <textarea class="form-textarea" placeholder="Specify performance security requirements (percentage, format, validity, etc.)..." style="min-height: 80px;"></textarea>
                  </div>
                ` : particularsValues.performanceSecurity === 'Not required' ? `
                  <div class="form-group full-width">
                    <label class="form-label">Justification</label>
                    <textarea class="form-textarea" placeholder="Provide justification for not requiring performance security..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
                <div class="form-group">
                  <label class="form-label">Bid / proposal security</label>
                  <select class="form-select" onchange="updateBidSecurity(this.value)">
                    <option value="">Select...</option>
                    <option value="Not required">Not required</option>
                    <option value="Required">Required</option>
                  </select>
                </div>
                
                ${particularsValues.bidSecurity === 'Required' ? `
                  <div class="form-group">
                    <label class="form-label">Bid/proposal security value (non-lot)</label>
                    <input type="number" class="form-input" placeholder="Enter amount" min="0" />
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Bid/proposal security value (lot-based)</label>
                    <input type="number" class="form-input" placeholder="Enter amount per lot" min="0" />
                  </div>
                  
                  <div class="form-group full-width">
                    <label class="form-label">Security details</label>
                    <textarea class="form-textarea" placeholder="Provide security details (format, validity period, etc.)..." style="min-height: 60px;"></textarea>
                  </div>
                ` : ''}
                
              </div>
            </div>
          </div>
        `;
      }

      function renderCurrentBlock() {
        const wrapper = document.getElementById('content-wrapper');
        const block = templateBlocks[currentBlockIndex];

        let html = '';

        block.sections.forEach((section, sectionIndex) => {
          const isFirst = sectionIndex === 0;
          
          // Special handling for Requisition & Lots section
          if (section.isRequisitionLots) {
            html += renderRequisitionLotsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Product Requirements section
          if (section.isProductRequirements) {
            html += renderProductRequirementsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Other requirements section
          if (section.isTenderAuthorConfig) {
            html += renderTenderAuthorConfigSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Supplier Response Structure section
          if (section.isSupplierResponseStructure) {
            html += renderSupplierResponseStructureSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Supplier Form Preview section
          if (section.isSupplierFormPreview) {
            html += renderSupplierFormPreviewSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Evaluation Criteria section
          if (section.isEvaluationCriteria) {
            html += renderEvaluationCriteriaSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          // Special handling for Particulars section
          if (section.isParticulars) {
            html += renderParticularsSection(block, section, sectionIndex, isFirst);
            return;
          }
          
          html += `
            <div class="form-section">
              <div class="section-header">
                <div class="section-title">
                  <span class="section-icon">${block.icon}</span>
                  <span>${section.title}</span>
                </div>
                ${sectionIndex === 0 ? '<span class="status-indicator status-incomplete">Incomplete</span>' : ''}
              </div>
              <div class="section-body">
                ${sectionIndex === 0 && block.id === 'general' ? `
                  <div class="info-alert">
                    <div class="info-alert-text">
                      ‚ÑπÔ∏è Information will be automatically populated from the requisition where applicable
                    </div>
                  </div>
                ` : ''}
                
                ${(() => {
                  // Display added forms for this section
                  const blockForms = addedForms[block.id] || {};
                  const sectionForms = blockForms[sectionIndex] || [];
                  if (sectionForms.length > 0) {
                    return `
                      <div class="added-forms-section">
                        <div class="form-library-group-label" style="margin-bottom: var(--spacing-md);">Added Forms</div>
                        ${sectionForms.map(form => `
                          <div class="added-form-item" data-form-id="${form.id}">
                            <div class="added-form-info">
                              <div class="added-form-icon">üìÑ</div>
                              <div class="added-form-details">
                                <div class="added-form-name">${form.name}</div>
                                <div class="added-form-type">Form Document</div>
                              </div>
                            </div>
                            <div class="added-form-actions">
                              <button class="form-action-btn" onclick="previewForm('${form.id}')" title="Preview">üëÅ</button>
                              <button class="form-action-btn danger" onclick="removeForm('${form.id}')" title="Remove">‚úñ</button>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    `;
                  }
                  return '';
                })()}
                
                <div class="form-grid">
                  ${section.fields.map((field) => {
                    // Check conditional visibility
                    if (!shouldShowField(field)) {
                      return '';
                    }
                    
                    let fieldHtml = '';
                    const onchangeAttr = field.onchange ? `onchange="${field.onchange}(this.value)"` : '';
                    
                    if (field.type === 'textarea') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <textarea class="form-textarea" ${field.readonly ? 'readonly' : ''} ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}">${field.value || ''}</textarea>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'select') {
                      // Check for pre-populated values
                      let selectedValue = '';
                      if (wizardData) {
                        if (field.label === 'Sourcing or Solicitation' && wizardData.sourcingType) {
                          selectedValue = wizardData.sourcingType.charAt(0).toUpperCase() + wizardData.sourcingType.slice(1);
                        } else if (field.label === 'Type of Requirement' && wizardData.requirementType) {
                          const requirementMap = {
                            goods: 'Goods',
                            services: 'Services',
                            works: 'Works',
                            'goods-services': 'Goods & Services',
                          };
                          selectedValue = requirementMap[wizardData.requirementType] || '';
                        }
                      }

                      const options = field.options.map(opt => {
                        const isSelected = selectedValue && opt === selectedValue ? 'selected' : '';
                        return `<option ${isSelected}>${opt}</option>`;
                      }).join('');
                      fieldHtml = `
                        <div class="form-group ${field.multiple ? 'full-width' : ''}">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <select class="form-select" ${field.multiple ? 'multiple size="5"' : ''} ${field.required ? 'required' : ''} ${field.readonly ? 'disabled' : ''} ${onchangeAttr}>
                            ${options}
                          </select>
                          ${field.multiple ? '<span class="help-text">Hold Ctrl/Cmd to select multiple</span>' : ''}
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'checkbox-group') {
                      const checkboxes = field.options.map((opt, idx) => `
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; background: var(--surface-50); border-radius: var(--radius-sm); border: 1px solid var(--surface-200);">
                          <input 
                            type="checkbox" 
                            value="${opt}" 
                            ${generalInfoValues.processType.includes(opt) ? 'checked' : ''}
                            onchange="${field.onchange}(this)"
                            style="cursor: pointer;"
                          />
                          <span>${opt}</span>
                        </label>
                      `).join('');
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                            ${checkboxes}
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'search') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="position: relative;">
                            <input type="text" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || 'Search...'}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} style="padding-left: 40px;" />
                            <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">üîç</span>
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'file') {
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                            <input type="file" class="form-input" ${field.required ? 'required' : ''} accept=".pdf,.doc,.docx,.xls,.xlsx" style="flex: 1;" />
                            <button class="btn btn-secondary btn-sm" type="button">üìé Choose File</button>
                          </div>
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    } else if (field.type === 'lifecycle-tracker') {
                      const trackerId = `lifecycle-tracker-${field.id}`;
                      fieldHtml = `
                        <div class="form-group full-width">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          ${field.description ? `<div class="help-text" style="margin-bottom: var(--spacing-md);">${field.description}</div>` : ''}
                          <div id="${trackerId}"></div>
                        </div>
                      `;
                      // Render lifecycle tracker after a short delay to ensure DOM is ready
                      setTimeout(() => renderLifecycleTracker(trackerId), 100);
                    } else {
                      const inputType = field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : field.type === 'datetime-local' ? 'datetime-local' : 'text';
                      fieldHtml = `
                        <div class="form-group ${field.type === 'textarea' ? 'full-width' : ''}">
                          <label class="form-label">
                            ${field.label} ${field.required ? '<span class="required">*</span>' : ''}
                          </label>
                          <input type="${inputType}" class="form-input" value="${field.value || ''}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} ${field.readonly ? 'readonly' : ''} ${onchangeAttr} />
                          ${field.help ? `<span class="help-text">${field.help}</span>` : ''}
                        </div>
                      `;
                    }
                    return fieldHtml;
                  }).join('')}
                </div>
                
                <!-- Drop Zone for Forms -->
                <div class="form-drop-zone">Drop forms from library here</div>
              </div>
            </div>
          `;
        });

        wrapper.innerHTML = html;
        attachAuthoringEventListeners();
        // Re-setup drop zones after rendering
        setTimeout(() => {
          setupDropZones();
        }, 50);
      }

      window.toggleSection = function(header) {
        console.log('toggleSection called', header);
        const section = header.closest('.form-section');
        if (section) {
          section.classList.toggle('collapsed');
          console.log('Section toggled, collapsed:', section.classList.contains('collapsed'));
        } else {
          console.error('Section not found for header:', header);
        }
      }

      function updateNavigationButtons() {
        const prevBtn = document.getElementById('prev-block-btn');
        const nextBtn = document.getElementById('next-block-btn');

        prevBtn.style.display = currentBlockIndex > 0 ? 'inline-flex' : 'none';
        nextBtn.textContent = currentBlockIndex < templateBlocks.length - 1 ? 'Next Block' : 'Complete Authoring';

        if (currentBlockIndex === templateBlocks.length - 1) {
          nextBtn.onclick = () => {
            alert('Ready to proceed to Review step');
          };
        } else {
          nextBtn.onclick = () => switchToBlock(currentBlockIndex + 1);
        }
      }

      function attachAuthoringEventListeners() {
        document.querySelectorAll('.section-header').forEach((header) => {
          header.addEventListener('click', function() {
            toggleSection(this);
          });
        });

        document.querySelectorAll('.progress-step').forEach((step) => {
          step.addEventListener('click', function() {
            const stepNum = parseInt(this.dataset.step);
            if (stepNum <= currentAuthoringStep) {
              currentAuthoringStep = stepNum;
              updateProgressSteps();
            }
          });
        });

        document.getElementById('prev-block-btn').addEventListener('click', () => {
          if (currentBlockIndex > 0) {
            switchToBlock(currentBlockIndex - 1);
          }
        });
      }

      function updateProgressSteps() {
        document.querySelectorAll('.progress-step').forEach((step, index) => {
          const stepNum = index + 1;
          step.classList.remove('active', 'completed');
          if (stepNum < currentAuthoringStep) {
            step.classList.add('completed');
          } else if (stepNum === currentAuthoringStep) {
            step.classList.add('active');
          }
        });
      }

      // Initialize
      // Note: Don't initialize wizard immediately, let user choose initiation method
      // initWizard();
    </script>

    <!-- Tender Selection Modal for Cloning -->
    <div class="modal-overlay" id="tender-selection-modal" onclick="if(event.target === this) closeTenderSelectionModal()">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <div class="modal-title">Select Tender to Clone</div>
            <div class="modal-subtitle">Choose an existing tender to use as a starting point</div>
          </div>
          <button class="modal-close-btn" onclick="closeTenderSelectionModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="modal-search">
            <input type="search" placeholder="Search by tender title or reference number..." 
                   oninput="filterExistingTenders(this.value)" />
          </div>
          <div class="existing-tenders-list" id="existing-tenders-list">
            <!-- Tender cards will be dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <!-- Lifecycle Process Search Modal -->
    <div class="lifecycle-search-modal" id="lifecycle-search-modal" onclick="if(event.target === this) closeLifecycleSearch()">
      <div class="lifecycle-search-content">
        <div class="lifecycle-search-header">
          <div>
            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
              Link Procurement Process
            </div>
            <div style="font-size: 14px; color: var(--text-muted);">
              Search and select a process to link to this tender
            </div>
          </div>
          <button class="modal-close-btn" onclick="closeLifecycleSearch()">‚úï</button>
        </div>
        <div class="lifecycle-search-body">
          <div class="lifecycle-search-input-wrapper">
            <span class="lifecycle-search-icon">üîç</span>
            <input 
              type="search" 
              class="lifecycle-search-input" 
              placeholder="Search by Process ID, title, or type..." 
              oninput="searchLifecycleProcesses(this.value)"
            />
          </div>
          <div class="lifecycle-search-results" id="lifecycle-search-results">
            <!-- Results will be dynamically populated -->
          </div>
        </div>
      </div>
    </div>
  </body>
</html>


